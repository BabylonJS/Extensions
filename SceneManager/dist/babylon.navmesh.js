(function(n){if(typeof exports=="object"&&typeof module!="undefined")module.exports=n();else if(typeof define=="function"&&define.amd)define([],n);else{var t;t=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:this;t.Navigation=n()}})(function(){var n;return function(){function n(t,i,r){function u(f,o){var h,c,s;if(!i[f]){if(!t[f]){if(h=typeof require=="function"&&require,!o&&h)return h(f,!0);if(e)return e(f,!0);c=new Error("Cannot find module '"+f+"'");throw c.code="MODULE_NOT_FOUND",c;}s=i[f]={exports:{}};t[f][0].call(s.exports,function(n){var i=t[f][1][n];return u(i?i:n)},s,s.exports,n,t,i,r)}return i[f].exports}for(var e=typeof require=="function"&&require,f=0;f<r.length;f++)u(r[f]);return u}return n}()({1:[function(n,t){"use strict";var i=n("abitbol"),r=n("babylonjs"),u=n("./BinaryHeap.js"),f=i.$extend({init:function(n){for(var t,i=0;i<n.length;i++)t=n[i],t.f=0,t.g=0,t.h=0,t.cost=1,t.visited=!1,t.closed=!1,t.parent=null},cleanUp:function(n){for(var t,i=0;i<n.length;i++)t=n[i],delete t.f,delete t.g,delete t.h,delete t.cost,delete t.visited,delete t.closed,delete t.parent},heap:function(){return new u(function(n){return n.f})},search:function(n,t,i){var f,u,e,o,h,s,a,r,c,l;for(this.init(n),f=this.heap(),f.push(t);f.size()>0;){if(u=f.pop(),u===i){for(e=u,o=[];e.parent;)o.push(e),e=e.parent;return this.cleanUp(o),o.reverse()}for(u.closed=!0,h=this.neighbours(n,u),s=0,a=h.length;s<a;s++)(r=h[s],r.closed)||(c=u.g+r.cost,l=r.visited,(!l||c<r.g)&&(r.visited=!0,r.parent=u,!r.centroid||!i.centroid,r.h=r.h||this.heuristic(r.centroid,i.centroid),r.g=c,r.f=r.g+r.h,l?f.rescoreElement(r):f.push(r)))}return[]},heuristic:function(n,t){return r.Vector3.DistanceSquared(n,t)},neighbours:function(n,t){for(var r=[],i=0;i<t.neighbours.length;i++)r.push(n[t.neighbours[i]]);return r}});t.exports=f},{"./BinaryHeap.js":2,abitbol:5,babylonjs:7}],2:[function(n,t){"use strict";var i=n("abitbol"),r=i.$extend({__init__:function(n){this.content=[];this.scoreFunction=n||new function(){}},push:function(n){this.content.push(n);this.sinkDown(this.content.length-1)},pop:function(){var n=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),n},remove:function(n){var t=this.content.indexOf(n),i=this.content.pop();t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(n)?this.sinkDown(t):this.bubbleUp(t))},size:function(){return this.content.length},rescoreElement:function(n){this.sinkDown(this.content.indexOf(n))},sinkDown:function(n){for(var r=this.content[n],t,i;n>0;)if(t=(n+1>>1)-1,i=this.content[t],this.scoreFunction(r)<this.scoreFunction(i))this.content[t]=r,this.content[n]=i,n=t;else break},bubbleUp:function(n){for(var f=this.content.length,e=this.content[n],o=this.scoreFunction(e),s,u,h,c;;){var i=n+1<<1,r=i-1,t=null;if(r<f&&(s=this.content[r],u=this.scoreFunction(s),u<o&&(t=r)),i<f&&(h=this.content[i],c=this.scoreFunction(h),c<(t===null?o:u)&&(t=i)),t!==null)this.content[n]=this.content[t],this.content[t]=e,n=t;else break}}});t.exports=r},{abitbol:5}],3:[function(n,t){"use strict";var i=n("abitbol"),r=n("babylonjs"),u=i.$extend({__init__:function(){this.portals=[]},push:function(n,t){t===undefined&&(t=n);this.portals.push({left:n,right:t})},_vequal:function(n,t){return r.Vector3.DistanceSquared(n,t)<1e-5},_triarea2:function(n,t,i){var r=t.x-n.x,u=t.z-n.z,f=i.x-n.x,e=i.z-n.z;return f*u-r*e},stringPull:function(){var t=this.portals,i=[],n,r,u,e=0,o=0,s=0,f,h,c;for(n=t[0].left,r=t[0].left,u=t[0].right,i.push(n),f=1;f<t.length;f++){if(h=t[f].left,c=t[f].right,this._triarea2(n,u,c)>=0)if(this._vequal(n,u)||this._triarea2(n,r,c)<0)u=c,s=f;else{i.push(r);n=r;e=o;r=n;u=n;o=e;s=e;f=e;continue}if(this._triarea2(n,r,h)<=0)if(this._vequal(n,r)||this._triarea2(n,u,h)>0)r=h,o=f;else{i.push(u);n=u;e=s;r=n;u=n;o=e;s=e;f=e;continue}}return i.length!==0&&this._vequal(i[i.length-1],t[t.length-1].left)||i.push(t[t.length-1].left),this.path=i,i}});t.exports=u},{abitbol:5,babylonjs:7}],4:[function(n,t){"use strict";var u=n("abitbol"),i=n("lodash"),f=n("./Astar.js"),e=n("./Channel.js"),r=n("babylonjs"),o=u.$extend({__init__:function(){this.zoneNodes={};this.astar=new f;this.yTolerance=1},buildNodes:function(n){var t=this._buildNavigationMesh(n.geometry);return this._groupNavMesh(t)},setZoneData:function(n,t){this.zoneNodes[n]=t},setHeightTolerance:function(n){this.yTolerance=n},getGroup:function(n,t){if(!this.zoneNodes[n])return null;var u=null,f=Infinity;return i.each(this.zoneNodes[n].groups,function(n,e){i.each(n,function(n){var i=r.Vector3.DistanceSquared(n.centroid,t);i<f&&(u=e,f=i)})}),u},getRandomNode:function(n,t,u,f){if(!this.zoneNodes[n])return new r.Vector3;u=u||null;f=f||0;var e=[],o=this.zoneNodes[n].groups[t];return i.each(o,function(n){u&&f?r.Vector3.DistanceSquared(u,n.centroid)<f*f&&e.push(n.centroid):e.push(n.centroid)}),i.sample(e)||new r.Vector3},projectOnNavmesh:function(n,t,i){for(var s=this.zoneNodes[t].groups[i],l=this.zoneNodes[t].vertices,a=null,h=Infinity,c=null,u=null,f=null,e=0,o=0;o<s.length;o++)f=s[o],u=this._getProjectionOnNode(n,f,l),e=r.Vector3.DistanceSquared(u,n),e<h&&(h=e,c=u,a=f);return c},_projectPointOnPlane:function(n,t){var i=r.Vector3.Dot(n,t.normal)+t.d;return n.subtract(t.normal.scale(i))},_getProjectionOnNode:function(n,t,i){var f=this.getVectorFrom(i,t.vertexIds[0]),e=this.getVectorFrom(i,t.vertexIds[1]),o=this.getVectorFrom(i,t.vertexIds[2]),c=e.subtract(f),l=o.subtract(f),h=r.Vector3.Cross(c,l).normalize(),a={normal:h,d:-r.Vector3.Dot(f,h)},v=this._projectPointOnPlane(n,a),y=function(n,t,i,u){var f={},e=u.subtract(t),o=i.subtract(t),h=n.subtract(t),c=r.Vector3.Dot(e,e),s=r.Vector3.Dot(e,o),l=r.Vector3.Dot(e,h),a=r.Vector3.Dot(o,o),v=r.Vector3.Dot(o,h),y=c*a-s*s;return f.u=(a*l-s*v)/y,f.v=(c*v-s*l)/y,f.w=1-f.u-f.v,f},u=y(v,f,e,o),s;return u.u=Math.min(Math.max(u.u,0),1),u.v=Math.min(Math.max(u.v,0),1),u.u+u.v>=1&&(s=u.u+u.v,u.u/=s,u.v/=s),f.add(e.subtract(f).scale(u.v).add(o.subtract(f).scale(u.u)))},findPath:function(n,t,i,u){for(var c,v,w,h,b,y,p,s,o=this.zoneNodes[i].groups[u],l=this.zoneNodes[i].vertices,a=null,f=0;f<o.length;f++)if(this._isVectorInPolygon(n,o[f],l)){a=o[f];break}for(c=null,f=0;f<o.length;f++)if(this._isVectorInPolygon(t,o[f],l)){c=o[f];break}if(!a||!c)return null;if(a.id!=c.id)v=this.astar.search(o,a,c);else return s=[],s.push(new r.Vector3(t.x,t.y,t.z)),s;for(w=function(n,t){for(var i=0;i<n.neighbours.length;i++)if(n.neighbours[i]===t.id)return n.portals[i]},h=new e,h.push(n),f=0;f<v.length;f++)b=v[f],y=v[f+1],y&&(p=w(b,y),h.push(this.getVectorFrom(l,p[0]),this.getVectorFrom(l,p[1])));return h.push(t),h.stringPull(),s=[],h.path.forEach(function(n){var t=new r.Vector3(n.x,n.y,n.z);s.push(t)}),s.shift(),s},_isPointInPoly:function(n,t){for(var u=!1,i=-1,f=n.length,r=f-1;++i<f;r=i)(n[i].z<=t.z&&t.z<n[r].z||n[r].z<=t.z&&t.z<n[i].z)&&t.x<(n[r].x-n[i].x)*(t.z-n[i].z)/(n[r].z-n[i].z)+n[i].x&&(u=!u);return u},_isVectorInPolygon:function(n,t,r){var u=1e5,f=-1e5,e=[];return(i.each(t.vertexIds,function(n){var t=this.getVectorFrom(r,n);u=Math.min(t.y,u);f=Math.max(t.y,f);e.push(t)}.bind(this)),n.y<f+this.yTolerance&&n.y>u-this.yTolerance&&this._isPointInPoly(e,n))?!0:!1},_computeCentroids:function(n){for(var e=[],u=n.getIndices(),f=n.getVerticesData(r.VertexBuffer.PositionKind),t=new r.Vector3(0,0,0),i=0;i<u.length;i+=3){var o=this.getVectorFrom(f,u[i]),s=this.getVectorFrom(f,u[i+1]),h=this.getVectorFrom(f,u[i+2]);t.copyFromFloats(0,0,0);t.addInPlace(o);t.addInPlace(s);t.addInPlace(h);t.scaleInPlace(1/3);e.push(t.clone())}n.centroids=e},_roundNumber:function(n,t){var i=new Number(n+"").toFixed(parseInt(t));return parseFloat(i)},_mergeVertexIds:function(n,t){var r=[],e,u;if(n.forEach(function(n){i.includes(t,n)&&r.push(n)}),r.length<2)return[];i.includes(r,n[0])&&i.includes(r,n[n.length-1])&&n.push(n.shift());i.includes(r,t[0])&&i.includes(r,t[t.length-1])&&t.push(t.shift());r=[];n.forEach(function(n){i.includes(t,n)&&r.push(n)});for(var o=r[1],s=r[0],f=i.clone(n);f[0]!==o;)f.push(f.shift());for(e=0,u=i.clone(t);u[0]!==s;)if(u.push(u.shift()),e++>10)break;return u.shift(),u.pop(),f.concat(u)},_setPolygonCentroid:function(n,t){var u=new r.Vector3(0,0,0),f=t.vertices;i.each(n.vertexIds,function(n){u.x+=f[n*3];u.y+=f[n*3+1];u.z+=f[n*3+2]});u.scaleInPlace(1/n.vertexIds.length);n.centroid.copyFrom(u)},getVectorFrom:function(n,t,i){return i?(i.copyFromFloats(n[t*3],n[t*3+1],n[t*3+2]),i):new r.Vector3(n[t*3],n[t*3+1],n[t*3+2])},_cleanPolygon:function(n,t){for(var o,u,f,c,l,s,h=[],e=t.vertices,r=0;r<n.vertexIds.length;r++){o=this.getVectorFrom(e,n.vertexIds[r]);r===0?(u=n.vertexIds[1],f=n.vertexIds[n.vertexIds.length-1]):r===n.vertexIds.length-1?(u=n.vertexIds[0],f=n.vertexIds[n.vertexIds.length-2]):(u=n.vertexIds[r+1],f=n.vertexIds[r-1]);c=this.getVectorFrom(e,u);l=this.getVectorFrom(e,f);var v=c.clone().sub(o),y=l.clone().sub(o),a=v.angleTo(y);a>Math.PI-.01&&a<Math.PI+.01?(s=[],n.neighbours.forEach(function(t){i.includes(t.vertexIds,n.vertexIds[r])||s.push(t)}),n.neighbours=s):h.push(n.vertexIds[r])}n.vertexIds=h;this._setPolygonCentroid(n,t)},_isConvex:function(n,t){var u=t.vertices,i,h,o,s,v;if(n.vertexIds.length<3)return!1;var e=!0,y=0,f=[];for(i=0;i<n.vertexIds.length;i++){h=this.getVectorFrom(u,n.vertexIds[i]);i===0?(o=this.getVectorFrom(u,n.vertexIds[1]),s=this.getVectorFrom(u,n.vertexIds[n.vertexIds.length-1])):i===n.vertexIds.length-1?(o=this.getVectorFrom(u,n.vertexIds[0]),s=this.getVectorFrom(u,n.vertexIds[n.vertexIds.length-2])):(o=this.getVectorFrom(u,n.vertexIds[i+1]),s=this.getVectorFrom(u,n.vertexIds[i-1]));var l=o.clone().sub(h),a=s.clone().sub(h),c=l.angleTo(a);if(y+=c,c===Math.PI||c===0)return!1;v=r.Vector3.Cross(l,a).y;f.push(v)}return f.forEach(function(n){n===0&&(e=!1)}),f[0]>0?f.forEach(function(n){n<0&&(e=!1)}):f.forEach(function(n){n>0&&(e=!1)}),e},_buildPolygonGroups:function(n){var u=n.polygons,t=[],f=0,r=function r(n){i.each(n.neighbours,function(t){i.isUndefined(t.group)&&(t.group=n.group,r(t))})};return i.each(u,function(n){i.isUndefined(n.group)&&(n.group=f++,r(n));t[n.group]||(t[n.group]=[]);t[n.group].push(n)}),console.log("Groups built: ",t.length),t},_array_intersect:function(){var n,r,o,t,s,h=[],u={},f,e,i;for(f=arguments.length-1,o=arguments[0].length,r=0,n=0;n<=f;n++)t=arguments[n].length,t<o&&(r=n,o=t);for(n=0;n<=f;n++)for(t=n===r?0:n||r,s=arguments[t].length,e=0;e<s;e++)i=arguments[t][e],u[i]===n-1?n===f?(h.push(i),u[i]=0):u[i]=n:n===0&&(u[i]=0);return h},_buildPolygonNeighbours:function(n,t){var i,u,f;for(n.neighbours=[],i=0,u=t.polygons.length;i<u;i++)n!==t.polygons[i]&&(r.Vector3.DistanceSquared(n.centroid,t.polygons[i].centroid)>1e4||(f=this._array_intersect(n.vertexIds,t.polygons[i].vertexIds),f.length>=2&&n.neighbours.push(t.polygons[i])))},_buildPolygonsFromGeometry:function(n){var e=[],f=n.getVerticesData(r.VertexBuffer.PositionKind),u=n.getIndices(),h=1,t,o;for(console.log("Vertices:",f.length/3,"polygons:",u.length/3),t=0;t<u.length;t+=3){var c=this.getVectorFrom(f,u[t]),s=this.getVectorFrom(f,u[t+1]),l=this.getVectorFrom(f,u[t+2]),a=r.Vector3.Cross(s.subtract(c),s.subtract(l)).normalize();e.push({id:h++,vertexIds:[u[t],u[t+1],u[t+2]],centroid:n.centroids[t/3],normal:a,neighbours:[]})}return o={polygons:e,vertices:f},i.each(e,function(n){this._buildPolygonNeighbours(n,o)}.bind(this)),o},_cleanNavigationMesh:function(n){var f=n.polygons,e=n.vertices,s=new r.Vector3(0,1,0),u,o,t;for(f=i.filter(f,function(n){var t=Math.acos(r.Vector3.Dot(s,n.normal));return t<Math.PI/4}),u=[],i.each(f,function(t){if(!t.toBeDeleted){for(var f=!0;f;)f=!1,i.each(t.neighbours,function(u){if(t!==u&&Math.acos(r.Vector3.Dot(t.normal,u.normal))<.01){var e={vertexIds:this._mergeVertexIds(t.vertexIds,u.vertexIds),neighbours:t.neighbours,normal:t.normal.clone(),centroid:t.centroid.clone()};this._cleanPolygon(e,n);this._isConvex(e,n)&&(u.toBeDeleted=!0,i.each(u.neighbours,function(n){n.neighbours=i.without(n.neighbours,u);n!==t?n.neighbours.push(t):(t.neighbours=t.neighbours.concat(u.neighbours),t.neighbours=i.uniq(t.neighbours),t.neighbours=i.without(t.neighbours,t))}),t.vertexIds=this._mergeVertexIds(t.vertexIds,u.vertexIds),this._cleanPolygon(t,n),f=!0)}}.bind(this));t.toBeDeleted||u.push(t)}}),o=function(n){var t=!1;return i.each(u,function(r){!t&&i.includes(r.vertexIds,n)&&(t=!0)}),t},t=0;t<e.length;t++)o(t)||(i.each(u,function(n){for(var i=0;i<n.vertexIds.length;i++)n.vertexIds[i]>t&&n.vertexIds[i]--}),e.splice(t,1),t--);n.polygons=u;n.vertices=e},_buildNavigationMesh:function(n){this._computeCentroids(n);this._mergeVertices(n);return this._buildPolygonsFromGeometry(n)},_mergeVertices:function(n){for(var c,y,o,p,w,l={},f=[],e=[],s,h,a=Math.pow(10,4),v,i=n.getIndices(),u=n.getVerticesData(r.VertexBuffer.PositionKind),t=0;t<u.length;t+=3)s=new r.Vector3(u[t],u[t+1],u[t+2]),h=Math.round(s.x*a)+"_"+Math.round(s.y*a)+"_"+Math.round(s.z*a),l[h]===undefined?(l[h]=t/3,f.push(s.clone()),e[t/3]=f.length-1):e[t/3]=e[l[h]];for(c=[],t=0;t<i.length;t+=3)for(i[t]=e[i[t]],i[t+1]=e[i[t+1]],i[t+2]=e[i[t+2]],v=[i[t],i[t+1],i[t+2]],y=-1,o=0;o<3;o++)if(v[o]===v[(o+1)%3]){y=o;c.push(t);break}for(t=c.length-1;t>=0;t--)p=c[t],i.splice(p,3);for(w=u.length/3-f.length,u=[],t=0;t<f.length;t++)u.push(f[t].x,f[t].y,f[t].z);return n.setIndices(i),n.setVerticesData(r.VertexBuffer.PositionKind,u),w},_getSharedVerticesInOrder:function(n,t){var u=n.vertexIds,f=t.vertexIds,r=[];return(i.each(u,function(n){i.includes(f,n)&&r.push(n)}),r.length<2)?[]:(i.includes(r,u[0])&&i.includes(r,u[u.length-1])&&u.push(u.shift()),i.includes(r,f[0])&&i.includes(r,f[f.length-1])&&f.push(f.shift()),r=[],i.each(u,function(n){i.includes(f,n)&&r.push(n)}),r)},_groupNavMesh:function(n){var t={},u,r;return i.each(n.vertices,function(n){n=this._roundNumber(n,2)}.bind(this)),t.vertices=n.vertices,u=this._buildPolygonGroups(n),t.groups=[],r=function(n,t){for(var i=0;i<n.length;i++)if(t===n[i])return i},i.each(u,function(n){var u=[];i.each(n,function(t){var e=[],f;i.each(t.neighbours,function(t){e.push(r(n,t))});f=[];i.each(t.neighbours,function(n){f.push(this._getSharedVerticesInOrder(t,n))}.bind(this));t.centroid.x=this._roundNumber(t.centroid.x,2);t.centroid.y=this._roundNumber(t.centroid.y,2);t.centroid.z=this._roundNumber(t.centroid.z,2);u.push({id:r(n,t),neighbours:e,vertexIds:t.vertexIds,centroid:t.centroid,portals:f})}.bind(this));t.groups.push(u)}.bind(this)),t}});t.exports=o},{"./Astar.js":1,"./Channel.js":3,abitbol:5,babylonjs:7,lodash:8}],5:[function(n,t){"use strict";function f(n){r=!0;var t=new n;return r=!1,t}function e(n){return Boolean(n.toString().match(/.*(\$super|\$name|\$computedPropertyName).*/))}var u=n("./annotation.js"),r=!1,i=function(){};Object.defineProperty(i,"$class",{enumerable:!1,value:i});Object.defineProperty(i,"$map",{enumerable:!1,value:{attributes:{},methods:{},computedProperties:{}}});Object.defineProperty(i,"$extend",{enumerable:!1,value:function(n){var y=this,o=JSON.parse(JSON.stringify(y.$map)),h=function(){var n,t;if(!r){Object.defineProperty(this,"$class",{enumerable:!1,value:h});Object.defineProperty(this,"$map",{enumerable:!1,value:o});Object.defineProperty(this,"$data",{enumerable:!1,value:{}});for(n in o.computedProperties)Object.defineProperty(this,n,{enumerable:!0,configurable:!1,get:o.computedProperties[n].get!==undefined?function(n){return function(){return this[n].apply(this,arguments)}}(o.computedProperties[n].get):undefined,set:o.computedProperties[n].set!==undefined?function(n){return function(){return this[n].apply(this,arguments)}}(o.computedProperties[n].set):undefined});for(t in o.methods)this[t]=this[t].bind(this);return this.__init__&&this.__init__.apply(this,arguments),this}},t,s,p,c,a,v,l;if(h.prototype=f(this.$class),n=n||{},n.__include__)for(c=n.__include__.length-1;c>=0;c--){a=n.__include__[c];for(t in a)if(t=="__classvars__")continue;else n[t]===undefined&&(n[t]=a[t]);if(a.__classvars__){n.__classvars__||(n.__classvars__={});for(t in a.__classvars__)n.__classvars__[t]===undefined&&(n.__classvars__[t]=a.__classvars__[t])}}for(t in n||{})if(t!="__include__"&&t!="__classvars__")if(typeof n[t]=="function"){s=undefined;o.methods[t]={annotations:{}};t.indexOf("get")===0?(s=t.slice(3,4).toLowerCase()+t.slice(4,t.length),o.computedProperties[s]||(o.computedProperties[s]={annotations:{}}),o.computedProperties[s].get=t):t.indexOf("set")===0?(s=t.slice(3,4).toLowerCase()+t.slice(4,t.length),o.computedProperties[s]||(o.computedProperties[s]={annotations:{}}),o.computedProperties[s].set=t):t.indexOf("has")===0?(s=t.slice(3,4).toLowerCase()+t.slice(4,t.length),o.computedProperties[s]||(o.computedProperties[s]={annotations:{}}),o.computedProperties[s].get=t):t.indexOf("is")===0&&(s=t.slice(2,3).toLowerCase()+t.slice(3,t.length),o.computedProperties[s]||(o.computedProperties[s]={annotations:{}}),o.computedProperties[s].get=t);p=u(n[t]);for(v in p)o.methods[t].annotations[v]=p[v],s&&(o.computedProperties[s].annotations[v]=p[v]);h.prototype[t]=e(n[t])?function(n,t,i){return function(){var r=this.$super,u=this.$name,f=this.$computedPropertyName;this.$super=y.prototype[t];this.$name=t;this.$computedPropertyName=i;try{return n.apply(this,arguments)}finally{r?this.$super=r:delete this.$super;u?this.$name=u:delete this.$name;f?this.$computedPropertyName=f:delete this.$computedPropertyName}}}(n[t],t,s):n[t]}else o.attributes[t]=!0,h.prototype[t]=n[t];for(l=Object.getOwnPropertyNames(y),l=l.filter(function(n){return["caller","callee","arguments","$class","$extend","$map"].indexOf(n)==-1}),c=0;c<l.length;c++)h[l[c]]===undefined&&(h[l[c]]=y[l[c]]);if(n.__classvars__)for(t in n.__classvars__)h[t]=n.__classvars__[t];return Object.defineProperty(h,"$class",{enumerable:!1,value:h}),Object.defineProperty(h,"$extend",{enumerable:!1,value:i.$extend}),Object.defineProperty(h,"$map",{enumerable:!1,value:o}),h}});t.exports=i},{"./annotation.js":6}],6:[function(n,t){"use strict";function i(n){for(var t,r=0,i=0;i<n.length;i++)if(t=n[i],t=="(")++r;else if(t==")")--r;else if(t=="{"&&r===0){n=n.slice(i+1);break}return n=n.replace(/\/\*(.|\r|\n)*?\*\//g,""),n=n.replace(/\/\/.*?\r?\n/g,"\n"),n.replace(/\s*\r?\n\s*/g,"")}function r(n){for(var o=[],f=!1,i=!1,r,u,t,e=0;e<n.length;e++)if(t=n[e],f)i?(u+=t=="\\"?"\\":t=="n"?"\n":t=="r"?"\r":t=="t"?"\t":t==r?r:"\\"+t,i=!1):t=="\\"?i=!0:t==r?(o.push(u),f=!1):u+=t;else if(t=='"'||t=="'")f=!0,i=!1,r=t,u="";else if([" ","Â ","\n","\r",";"].indexOf(t)>-1)continue;else break;return o}function u(n){return n=="true"?!0:n=="false"?!1:n=="null"?null:n=="undefined"?undefined:n.match(/^([0-9]+\.?|[0-9]*\.[0-9]+)$/)?parseFloat(n):n}function f(n){for(var c=i(n.toString()),o=r(c),s={},t,h,f,e=0;e<o.length;e++)(t=o[e].trim(),t.indexOf("@")===0)&&(h=t.slice(1,t.indexOf(" ")>-1?t.indexOf(" "):t.length),f=!0,t.indexOf(" ")>-1&&(f=t.slice(t.indexOf(" ")+1,t.length),f=f.trim(),f=u(f)),s[h]=f);return s}t.exports=f},{}],7:[function(n,t){var r=this&&this.__decorate||function(n,t,i,r){var f,e=arguments.length,u=e<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r,o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)u=Reflect.decorate(n,t,i,r);else for(o=n.length-1;o>=0;o--)(f=n[o])&&(u=(e<3?f(u):e>3?f(t,i,u):f(t,i))||u);return e>3&&u&&Object.defineProperty(t,i,u),u},u=this&&this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},f,i;!function(n){var i,h,a,u,t,o,p,e,r,v,w,b,l,k,c,s,y,d,g,nt,tt,it,rt,ut,f;n.ToGammaSpace=1/2.2;n.ToLinearSpace=2.2;n.Epsilon=.001;i=function(){function n(){}return n.WithinEpsilon=function(n,t,i){void 0===i&&(i=1401298e-51);var r=n-t;return-i<=r&&r<=i},n.ToHex=function(n){var t=n.toString(16);return n<=15?("0"+t).toUpperCase():t.toUpperCase()},n.Sign=function(n){return n=+n,0===n||isNaN(n)?n:n>0?1:-1},n.Clamp=function(n,t,i){return void 0===t&&(t=0),void 0===i&&(i=1),Math.min(i,Math.max(t,n))},n}();n.MathTools=i;h=function(){function t(n,t,i){void 0===n&&(n=0);void 0===t&&(t=0);void 0===i&&(i=0);this.r=n;this.g=t;this.b=i}return t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},t.prototype.getClassName=function(){return"Color3"},t.prototype.getHashCode=function(){var n=this.r||0;return n=397*n^(this.g||0),n=397*n^(this.b||0)},t.prototype.toArray=function(n,t){return void 0===t&&(t=0),n[t]=this.r,n[t+1]=this.g,n[t+2]=this.b,this},t.prototype.toColor4=function(n){return void 0===n&&(n=1),new a(this.r,this.g,this.b,n)},t.prototype.asArray=function(){var n=[];return this.toArray(n,0),n},t.prototype.toLuminance=function(){return.3*this.r+.59*this.g+.11*this.b},t.prototype.multiply=function(n){return new t(this.r*n.r,this.g*n.g,this.b*n.b)},t.prototype.multiplyToRef=function(n,t){return t.r=this.r*n.r,t.g=this.g*n.g,t.b=this.b*n.b,this},t.prototype.equals=function(n){return n&&this.r===n.r&&this.g===n.g&&this.b===n.b},t.prototype.equalsFloats=function(n,t,i){return this.r===n&&this.g===t&&this.b===i},t.prototype.scale=function(n){return new t(this.r*n,this.g*n,this.b*n)},t.prototype.scaleToRef=function(n,t){return t.r=this.r*n,t.g=this.g*n,t.b=this.b*n,this},t.prototype.add=function(n){return new t(this.r+n.r,this.g+n.g,this.b+n.b)},t.prototype.addToRef=function(n,t){return t.r=this.r+n.r,t.g=this.g+n.g,t.b=this.b+n.b,this},t.prototype.subtract=function(n){return new t(this.r-n.r,this.g-n.g,this.b-n.b)},t.prototype.subtractToRef=function(n,t){return t.r=this.r-n.r,t.g=this.g-n.g,t.b=this.b-n.b,this},t.prototype.clone=function(){return new t(this.r,this.g,this.b)},t.prototype.copyFrom=function(n){return this.r=n.r,this.g=n.g,this.b=n.b,this},t.prototype.copyFromFloats=function(n,t,i){return this.r=n,this.g=t,this.b=i,this},t.prototype.toHexString=function(){var n=255*this.r|0,t=255*this.g|0,r=255*this.b|0;return"#"+i.ToHex(n)+i.ToHex(t)+i.ToHex(r)},t.prototype.toLinearSpace=function(){var n=new t;return this.toLinearSpaceToRef(n),n},t.prototype.toLinearSpaceToRef=function(t){return t.r=Math.pow(this.r,n.ToLinearSpace),t.g=Math.pow(this.g,n.ToLinearSpace),t.b=Math.pow(this.b,n.ToLinearSpace),this},t.prototype.toGammaSpace=function(){var n=new t;return this.toGammaSpaceToRef(n),n},t.prototype.toGammaSpaceToRef=function(t){return t.r=Math.pow(this.r,n.ToGammaSpace),t.g=Math.pow(this.g,n.ToGammaSpace),t.b=Math.pow(this.b,n.ToGammaSpace),this},t.FromHexString=function(n){if("#"!==n.substring(0,1)||7!==n.length)return new t(0,0,0);var i=parseInt(n.substring(1,3),16),r=parseInt(n.substring(3,5),16),u=parseInt(n.substring(5,7),16);return t.FromInts(i,r,u)},t.FromArray=function(n,i){return void 0===i&&(i=0),new t(n[i],n[i+1],n[i+2])},t.FromInts=function(n,i,r){return new t(n/255,i/255,r/255)},t.Lerp=function(n,i,r){var u=n.r+(i.r-n.r)*r,f=n.g+(i.g-n.g)*r,e=n.b+(i.b-n.b)*r;return new t(u,f,e)},t.Red=function(){return new t(1,0,0)},t.Green=function(){return new t(0,1,0)},t.Blue=function(){return new t(0,0,1)},t.Black=function(){return new t(0,0,0)},t.White=function(){return new t(1,1,1)},t.Purple=function(){return new t(.5,0,.5)},t.Magenta=function(){return new t(1,0,1)},t.Yellow=function(){return new t(1,1,0)},t.Gray=function(){return new t(.5,.5,.5)},t}();n.Color3=h;a=function(){function n(n,t,i,r){this.r=n;this.g=t;this.b=i;this.a=r}return n.prototype.addInPlace=function(n){return this.r+=n.r,this.g+=n.g,this.b+=n.b,this.a+=n.a,this},n.prototype.asArray=function(){var n=[];return this.toArray(n,0),n},n.prototype.toArray=function(n,t){return void 0===t&&(t=0),n[t]=this.r,n[t+1]=this.g,n[t+2]=this.b,n[t+3]=this.a,this},n.prototype.add=function(t){return new n(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)},n.prototype.subtract=function(t){return new n(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)},n.prototype.subtractToRef=function(n,t){return t.r=this.r-n.r,t.g=this.g-n.g,t.b=this.b-n.b,t.a=this.a-n.a,this},n.prototype.scale=function(t){return new n(this.r*t,this.g*t,this.b*t,this.a*t)},n.prototype.scaleToRef=function(n,t){return t.r=this.r*n,t.g=this.g*n,t.b=this.b*n,t.a=this.a*n,this},n.prototype.multiply=function(t){return new n(this.r*t.r,this.g*t.g,this.b*t.b,this.a*t.a)},n.prototype.multiplyToRef=function(n,t){return t.r=this.r*n.r,t.g=this.g*n.g,t.b=this.b*n.b,t.a=this.a*n.a,t},n.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},n.prototype.getClassName=function(){return"Color4"},n.prototype.getHashCode=function(){var n=this.r||0;return n=397*n^(this.g||0),n=397*n^(this.b||0),n=397*n^(this.a||0)},n.prototype.clone=function(){return new n(this.r,this.g,this.b,this.a)},n.prototype.copyFrom=function(n){return this.r=n.r,this.g=n.g,this.b=n.b,this.a=n.a,this},n.prototype.toHexString=function(){var n=255*this.r|0,t=255*this.g|0,r=255*this.b|0,u=255*this.a|0;return"#"+i.ToHex(n)+i.ToHex(t)+i.ToHex(r)+i.ToHex(u)},n.FromHexString=function(t){if("#"!==t.substring(0,1)||9!==t.length)return new n(0,0,0,0);var i=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),u=parseInt(t.substring(5,7),16),f=parseInt(t.substring(7,9),16);return n.FromInts(i,r,u,f)},n.Lerp=function(t,i,r){var u=new n(0,0,0,0);return n.LerpToRef(t,i,r,u),u},n.LerpToRef=function(n,t,i,r){r.r=n.r+(t.r-n.r)*i;r.g=n.g+(t.g-n.g)*i;r.b=n.b+(t.b-n.b)*i;r.a=n.a+(t.a-n.a)*i},n.FromArray=function(t,i){return void 0===i&&(i=0),new n(t[i],t[i+1],t[i+2],t[i+3])},n.FromInts=function(t,i,r,u){return new n(t/255,i/255,r/255,u/255)},n.CheckColors4=function(n,t){var r,i,u;if(n.length===3*t){for(r=[],i=0;i<n.length;i+=3)u=i/3*4,r[u]=n[i],r[u+1]=n[i+1],r[u+2]=n[i+2],r[u+3]=1;return r}return n},n}();n.Color4=a;u=function(){function t(n,t){this.x=n;this.y=t}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},t.prototype.getClassName=function(){return"Vector2"},t.prototype.getHashCode=function(){var n=this.x||0;return 397*n^(this.y||0)},t.prototype.toArray=function(n,t){return void 0===t&&(t=0),n[t]=this.x,n[t+1]=this.y,this},t.prototype.asArray=function(){var n=[];return this.toArray(n,0),n},t.prototype.copyFrom=function(n){return this.x=n.x,this.y=n.y,this},t.prototype.copyFromFloats=function(n,t){return this.x=n,this.y=t,this},t.prototype.add=function(n){return new t(this.x+n.x,this.y+n.y)},t.prototype.addToRef=function(n,t){return t.x=this.x+n.x,t.y=this.y+n.y,this},t.prototype.addInPlace=function(n){return this.x+=n.x,this.y+=n.y,this},t.prototype.addVector3=function(n){return new t(this.x+n.x,this.y+n.y)},t.prototype.subtract=function(n){return new t(this.x-n.x,this.y-n.y)},t.prototype.subtractToRef=function(n,t){return t.x=this.x-n.x,t.y=this.y-n.y,this},t.prototype.subtractInPlace=function(n){return this.x-=n.x,this.y-=n.y,this},t.prototype.multiplyInPlace=function(n){return this.x*=n.x,this.y*=n.y,this},t.prototype.multiply=function(n){return new t(this.x*n.x,this.y*n.y)},t.prototype.multiplyToRef=function(n,t){return t.x=this.x*n.x,t.y=this.y*n.y,this},t.prototype.multiplyByFloats=function(n,i){return new t(this.x*n,this.y*i)},t.prototype.divide=function(n){return new t(this.x/n.x,this.y/n.y)},t.prototype.divideToRef=function(n,t){return t.x=this.x/n.x,t.y=this.y/n.y,this},t.prototype.negate=function(){return new t(-this.x,-this.y)},t.prototype.scaleInPlace=function(n){return this.x*=n,this.y*=n,this},t.prototype.scale=function(n){return new t(this.x*n,this.y*n)},t.prototype.equals=function(n){return n&&this.x===n.x&&this.y===n.y},t.prototype.equalsWithEpsilon=function(t,r){return void 0===r&&(r=n.Epsilon),t&&i.WithinEpsilon(this.x,t.x,r)&&i.WithinEpsilon(this.y,t.y,r)},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},t.prototype.normalize=function(){var t=this.length(),n;return 0===t?this:(n=1/t,this.x*=n,this.y*=n,this)},t.prototype.clone=function(){return new t(this.x,this.y)},t.Zero=function(){return new t(0,0)},t.FromArray=function(n,i){return void 0===i&&(i=0),new t(n[i],n[i+1])},t.FromArrayToRef=function(n,t,i){i.x=n[t];i.y=n[t+1]},t.CatmullRom=function(n,i,r,u,f){var e=f*f,o=f*e,s=.5*(2*i.x+(-n.x+r.x)*f+(2*n.x-5*i.x+4*r.x-u.x)*e+(-n.x+3*i.x-3*r.x+u.x)*o),h=.5*(2*i.y+(-n.y+r.y)*f+(2*n.y-5*i.y+4*r.y-u.y)*e+(-n.y+3*i.y-3*r.y+u.y)*o);return new t(s,h)},t.Clamp=function(n,i,r){var f=n.x,u;return f=f>r.x?r.x:f,f=f<i.x?i.x:f,u=n.y,u=u>r.y?r.y:u,u=u<i.y?i.y:u,new t(f,u)},t.Hermite=function(n,i,r,u,f){var e=f*f,o=f*e,s=2*o-3*e+1,h=-2*o+3*e,c=o-2*e+f,l=o-e,a=n.x*s+r.x*h+i.x*c+u.x*l,v=n.y*s+r.y*h+i.y*c+u.y*l;return new t(a,v)},t.Lerp=function(n,i,r){var u=n.x+(i.x-n.x)*r,f=n.y+(i.y-n.y)*r;return new t(u,f)},t.Dot=function(n,t){return n.x*t.x+n.y*t.y},t.Normalize=function(n){var t=n.clone();return t.normalize(),t},t.Minimize=function(n,i){var r=n.x<i.x?n.x:i.x,u=n.y<i.y?n.y:i.y;return new t(r,u)},t.Maximize=function(n,i){var r=n.x>i.x?n.x:i.x,u=n.y>i.y?n.y:i.y;return new t(r,u)},t.Transform=function(n,i){var r=t.Zero();return t.TransformToRef(n,i,r),r},t.TransformToRef=function(n,t,i){var r=n.x*t.m[0]+n.y*t.m[4]+t.m[12],u=n.x*t.m[1]+n.y*t.m[5]+t.m[13];i.x=r;i.y=u},t.PointInTriangle=function(n,t,i,r){var f=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),u=f<0?-1:1,e=(t.y*r.x-t.x*r.y+(r.y-t.y)*n.x+(t.x-r.x)*n.y)*u,o=(t.x*i.y-t.y*i.x+(t.y-i.y)*n.x+(i.x-t.x)*n.y)*u;return e>0&&o>0&&e+o<2*f*u},t.Distance=function(n,i){return Math.sqrt(t.DistanceSquared(n,i))},t.DistanceSquared=function(n,t){var i=n.x-t.x,r=n.y-t.y;return i*i+r*r},t.Center=function(n,t){var i=n.add(t);return i.scaleInPlace(.5),i},t.DistanceOfPointFromSegment=function(n,i,r){var u=t.DistanceSquared(i,r);if(0===u)return t.Distance(n,i);var f=r.subtract(i),e=Math.max(0,Math.min(1,t.Dot(n.subtract(i),f)/u)),o=i.add(f.multiplyByFloats(e,e));return t.Distance(n,o)},t}();n.Vector2=u;t=function(){function t(n,t,i){this.x=n;this.y=t;this.z=i}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},t.prototype.getClassName=function(){return"Vector3"},t.prototype.getHashCode=function(){var n=this.x||0;return n=397*n^(this.y||0),n=397*n^(this.z||0)},t.prototype.asArray=function(){var n=[];return this.toArray(n,0),n},t.prototype.toArray=function(n,t){return void 0===t&&(t=0),n[t]=this.x,n[t+1]=this.y,n[t+2]=this.z,this},t.prototype.toQuaternion=function(){var n=new e(0,0,0,1),r=Math.cos(.5*(this.x+this.z)),u=Math.sin(.5*(this.x+this.z)),f=Math.cos(.5*(this.z-this.x)),o=Math.sin(.5*(this.z-this.x)),t=Math.cos(.5*this.y),i=Math.sin(.5*this.y);return n.x=f*i,n.y=-o*i,n.z=u*t,n.w=r*t,n},t.prototype.addInPlace=function(n){return this.x+=n.x,this.y+=n.y,this.z+=n.z,this},t.prototype.add=function(n){return new t(this.x+n.x,this.y+n.y,this.z+n.z)},t.prototype.addToRef=function(n,t){return t.x=this.x+n.x,t.y=this.y+n.y,t.z=this.z+n.z,this},t.prototype.subtractInPlace=function(n){return this.x-=n.x,this.y-=n.y,this.z-=n.z,this},t.prototype.subtract=function(n){return new t(this.x-n.x,this.y-n.y,this.z-n.z)},t.prototype.subtractToRef=function(n,t){return t.x=this.x-n.x,t.y=this.y-n.y,t.z=this.z-n.z,this},t.prototype.subtractFromFloats=function(n,i,r){return new t(this.x-n,this.y-i,this.z-r)},t.prototype.subtractFromFloatsToRef=function(n,t,i,r){return r.x=this.x-n,r.y=this.y-t,r.z=this.z-i,this},t.prototype.negate=function(){return new t(-this.x,-this.y,-this.z)},t.prototype.scaleInPlace=function(n){return this.x*=n,this.y*=n,this.z*=n,this},t.prototype.scale=function(n){return new t(this.x*n,this.y*n,this.z*n)},t.prototype.scaleToRef=function(n,t){t.x=this.x*n;t.y=this.y*n;t.z=this.z*n},t.prototype.equals=function(n){return n&&this.x===n.x&&this.y===n.y&&this.z===n.z},t.prototype.equalsWithEpsilon=function(t,r){return void 0===r&&(r=n.Epsilon),t&&i.WithinEpsilon(this.x,t.x,r)&&i.WithinEpsilon(this.y,t.y,r)&&i.WithinEpsilon(this.z,t.z,r)},t.prototype.equalsToFloats=function(n,t,i){return this.x===n&&this.y===t&&this.z===i},t.prototype.multiplyInPlace=function(n){return this.x*=n.x,this.y*=n.y,this.z*=n.z,this},t.prototype.multiply=function(n){return new t(this.x*n.x,this.y*n.y,this.z*n.z)},t.prototype.multiplyToRef=function(n,t){return t.x=this.x*n.x,t.y=this.y*n.y,t.z=this.z*n.z,this},t.prototype.multiplyByFloats=function(n,i,r){return new t(this.x*n,this.y*i,this.z*r)},t.prototype.divide=function(n){return new t(this.x/n.x,this.y/n.y,this.z/n.z)},t.prototype.divideToRef=function(n,t){return t.x=this.x/n.x,t.y=this.y/n.y,t.z=this.z/n.z,this},t.prototype.MinimizeInPlace=function(n){return n.x<this.x&&(this.x=n.x),n.y<this.y&&(this.y=n.y),n.z<this.z&&(this.z=n.z),this},t.prototype.MaximizeInPlace=function(n){return n.x>this.x&&(this.x=n.x),n.y>this.y&&(this.y=n.y),n.z>this.z&&(this.z=n.z),this},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.prototype.normalize=function(){var t=this.length(),n;return 0===t||1===t?this:(n=1/t,this.x*=n,this.y*=n,this.z*=n,this)},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t.prototype.copyFrom=function(n){return this.x=n.x,this.y=n.y,this.z=n.z,this},t.prototype.copyFromFloats=function(n,t,i){return this.x=n,this.y=t,this.z=i,this},t.GetClipFactor=function(n,i,r,u){var f=t.Dot(n,r)-u,e=t.Dot(i,r)-u;return f/(f-e)},t.FromArray=function(n,i){return i||(i=0),new t(n[i],n[i+1],n[i+2])},t.FromFloatArray=function(n,i){return i||(i=0),new t(n[i],n[i+1],n[i+2])},t.FromArrayToRef=function(n,t,i){i.x=n[t];i.y=n[t+1];i.z=n[t+2]},t.FromFloatArrayToRef=function(n,t,i){i.x=n[t];i.y=n[t+1];i.z=n[t+2]},t.FromFloatsToRef=function(n,t,i,r){r.x=n;r.y=t;r.z=i},t.Zero=function(){return new t(0,0,0)},t.Up=function(){return new t(0,1,0)},t.Forward=function(){return new t(0,0,1)},t.Right=function(){return new t(1,0,0)},t.Left=function(){return new t(-1,0,0)},t.TransformCoordinates=function(n,i){var r=t.Zero();return t.TransformCoordinatesToRef(n,i,r),r},t.TransformCoordinatesToRef=function(n,t,i){var u=n.x*t.m[0]+n.y*t.m[4]+n.z*t.m[8]+t.m[12],f=n.x*t.m[1]+n.y*t.m[5]+n.z*t.m[9]+t.m[13],e=n.x*t.m[2]+n.y*t.m[6]+n.z*t.m[10]+t.m[14],r=n.x*t.m[3]+n.y*t.m[7]+n.z*t.m[11]+t.m[15];i.x=u/r;i.y=f/r;i.z=e/r},t.TransformCoordinatesFromFloatsToRef=function(n,t,i,r,u){var e=n*r.m[0]+t*r.m[4]+i*r.m[8]+r.m[12],o=n*r.m[1]+t*r.m[5]+i*r.m[9]+r.m[13],s=n*r.m[2]+t*r.m[6]+i*r.m[10]+r.m[14],f=n*r.m[3]+t*r.m[7]+i*r.m[11]+r.m[15];u.x=e/f;u.y=o/f;u.z=s/f},t.TransformNormal=function(n,i){var r=t.Zero();return t.TransformNormalToRef(n,i,r),r},t.TransformNormalToRef=function(n,t,i){var r=n.x*t.m[0]+n.y*t.m[4]+n.z*t.m[8],u=n.x*t.m[1]+n.y*t.m[5]+n.z*t.m[9],f=n.x*t.m[2]+n.y*t.m[6]+n.z*t.m[10];i.x=r;i.y=u;i.z=f},t.TransformNormalFromFloatsToRef=function(n,t,i,r,u){u.x=n*r.m[0]+t*r.m[4]+i*r.m[8];u.y=n*r.m[1]+t*r.m[5]+i*r.m[9];u.z=n*r.m[2]+t*r.m[6]+i*r.m[10]},t.CatmullRom=function(n,i,r,u,f){var e=f*f,o=f*e,s=.5*(2*i.x+(-n.x+r.x)*f+(2*n.x-5*i.x+4*r.x-u.x)*e+(-n.x+3*i.x-3*r.x+u.x)*o),h=.5*(2*i.y+(-n.y+r.y)*f+(2*n.y-5*i.y+4*r.y-u.y)*e+(-n.y+3*i.y-3*r.y+u.y)*o),c=.5*(2*i.z+(-n.z+r.z)*f+(2*n.z-5*i.z+4*r.z-u.z)*e+(-n.z+3*i.z-3*r.z+u.z)*o);return new t(s,h,c)},t.Clamp=function(n,i,r){var e=n.x,u,f;return e=e>r.x?r.x:e,e=e<i.x?i.x:e,u=n.y,u=u>r.y?r.y:u,u=u<i.y?i.y:u,f=n.z,f=f>r.z?r.z:f,f=f<i.z?i.z:f,new t(e,u,f)},t.Hermite=function(n,i,r,u,f){var e=f*f,o=f*e,s=2*o-3*e+1,h=-2*o+3*e,c=o-2*e+f,l=o-e,a=n.x*s+r.x*h+i.x*c+u.x*l,v=n.y*s+r.y*h+i.y*c+u.y*l,y=n.z*s+r.z*h+i.z*c+u.z*l;return new t(a,v,y)},t.Lerp=function(n,i,r){var u=n.x+(i.x-n.x)*r,f=n.y+(i.y-n.y)*r,e=n.z+(i.z-n.z)*r;return new t(u,f,e)},t.Dot=function(n,t){return n.x*t.x+n.y*t.y+n.z*t.z},t.Cross=function(n,i){var r=t.Zero();return t.CrossToRef(n,i,r),r},t.CrossToRef=function(n,t,i){f.Vector3[0].x=n.y*t.z-n.z*t.y;f.Vector3[0].y=n.z*t.x-n.x*t.z;f.Vector3[0].z=n.x*t.y-n.y*t.x;i.copyFrom(f.Vector3[0])},t.Normalize=function(n){var i=t.Zero();return t.NormalizeToRef(n,i),i},t.NormalizeToRef=function(n,t){t.copyFrom(n);t.normalize()},t.Project=function(n,i,u,f){var o=f.width,s=f.height,c=f.x,l=f.y,h=t._viewportMatrixCache?t._viewportMatrixCache:t._viewportMatrixCache=new r,e;return r.FromValuesToRef(o/2,0,0,0,0,-s/2,0,0,0,0,1,0,c+o/2,s/2+l,0,1,h),e=t._matrixCache?t._matrixCache:t._matrixCache=new r,i.multiplyToRef(u,e),e.multiplyToRef(h,e),t.TransformCoordinates(n,e)},t.UnprojectFromTransform=function(n,u,f,e,o){var s=t._matrixCache?t._matrixCache:t._matrixCache=new r,h,c;return e.multiplyToRef(o,s),s.invert(),n.x=n.x/u*2-1,n.y=-(n.y/f*2-1),h=t.TransformCoordinates(n,s),c=n.x*s.m[3]+n.y*s.m[7]+n.z*s.m[11]+s.m[15],i.WithinEpsilon(c,1)&&(h=h.scale(1/c)),h},t.Unproject=function(n,u,f,e,o,s){var h=t._matrixCache?t._matrixCache:t._matrixCache=new r;e.multiplyToRef(o,h);h.multiplyToRef(s,h);h.invert();var c=new t(n.x/u*2-1,-(n.y/f*2-1),n.z),l=t.TransformCoordinates(c,h),a=c.x*h.m[3]+c.y*h.m[7]+c.z*h.m[11]+h.m[15];return i.WithinEpsilon(a,1)&&(l=l.scale(1/a)),l},t.Minimize=function(n,t){var i=n.clone();return i.MinimizeInPlace(t),i},t.Maximize=function(n,t){var i=n.clone();return i.MaximizeInPlace(t),i},t.Distance=function(n,i){return Math.sqrt(t.DistanceSquared(n,i))},t.DistanceSquared=function(n,t){var i=n.x-t.x,r=n.y-t.y,u=n.z-t.z;return i*i+r*r+u*u},t.Center=function(n,t){var i=n.add(t);return i.scaleInPlace(.5),i},t.RotationFromAxis=function(n,i,r){var u=t.Zero();return t.RotationFromAxisToRef(n,i,r,u),u},t.RotationFromAxisToRef=function(r,u,e,o){var ut=r.normalize(),v=e.normalize(),tt=l.X,ft=l.Y,k=0,d=0,g=0,w=0,it=0,b=0,c=0,y=-1,rt=0,a=f.Vector3[0],h=0,s=f.Vector3[1],p,nt;i.WithinEpsilon(v.z,0,n.Epsilon)?b=1:i.WithinEpsilon(v.x,0,n.Epsilon)?w=1:(c=v.z/v.x,w=-c*Math.sqrt(1/(1+c*c)),b=Math.sqrt(1/(1+c*c)));s.x=w;s.y=it;s.z=b;s.normalize();t.CrossToRef(ut,s,a);a.normalize();t.Dot(v,a)<0&&(y=1);h=t.Dot(ut,s);h=Math.min(1,Math.max(-1,h));g=Math.acos(h)*y;t.Dot(s,tt)<0&&(g=Math.PI+g,s=s.scaleInPlace(-1),rt++);p=f.Vector3[2];nt=f.Vector3[3];w=0;it=0;b=0;y=-1;i.WithinEpsilon(v.z,0,n.Epsilon)?w=1:(c=s.z/s.x,w=-c*Math.sqrt(1/(1+c*c)),b=Math.sqrt(1/(1+c*c)));p.x=w;p.y=it;p.z=b;p.normalize();t.CrossToRef(p,s,nt);nt.normalize();t.CrossToRef(v,p,a);a.normalize();t.Dot(s,a)<0&&(y=1);h=t.Dot(v,p);h=Math.min(1,Math.max(-1,h));d=Math.acos(h)*y;t.Dot(nt,ft)<0&&(d=Math.PI+d,rt++);y=-1;t.CrossToRef(tt,s,a);a.normalize();t.Dot(a,ft)<0&&(y=1);h=t.Dot(s,tt);h=Math.min(1,Math.max(-1,h));k=-Math.acos(h)*y;h<0&&rt<2&&(k=Math.PI+k);o.x=d;o.y=k;o.z=g},t}();n.Vector3=t;o=function(){function r(n,t,i,r){this.x=n;this.y=t;this.z=i;this.w=r}return r.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},r.prototype.getClassName=function(){return"Vector4"},r.prototype.getHashCode=function(){var n=this.x||0;return n=397*n^(this.y||0),n=397*n^(this.z||0),n=397*n^(this.w||0)},r.prototype.asArray=function(){var n=[];return this.toArray(n,0),n},r.prototype.toArray=function(n,t){return void 0===t&&(t=0),n[t]=this.x,n[t+1]=this.y,n[t+2]=this.z,n[t+3]=this.w,this},r.prototype.addInPlace=function(n){return this.x+=n.x,this.y+=n.y,this.z+=n.z,this.w+=n.w,this},r.prototype.add=function(n){return new r(this.x+n.x,this.y+n.y,this.z+n.z,this.w+n.w)},r.prototype.addToRef=function(n,t){return t.x=this.x+n.x,t.y=this.y+n.y,t.z=this.z+n.z,t.w=this.w+n.w,this},r.prototype.subtractInPlace=function(n){return this.x-=n.x,this.y-=n.y,this.z-=n.z,this.w-=n.w,this},r.prototype.subtract=function(n){return new r(this.x-n.x,this.y-n.y,this.z-n.z,this.w-n.w)},r.prototype.subtractToRef=function(n,t){return t.x=this.x-n.x,t.y=this.y-n.y,t.z=this.z-n.z,t.w=this.w-n.w,this},r.prototype.subtractFromFloats=function(n,t,i,u){return new r(this.x-n,this.y-t,this.z-i,this.w-u)},r.prototype.subtractFromFloatsToRef=function(n,t,i,r,u){return u.x=this.x-n,u.y=this.y-t,u.z=this.z-i,u.w=this.w-r,this},r.prototype.negate=function(){return new r(-this.x,-this.y,-this.z,-this.w)},r.prototype.scaleInPlace=function(n){return this.x*=n,this.y*=n,this.z*=n,this.w*=n,this},r.prototype.scale=function(n){return new r(this.x*n,this.y*n,this.z*n,this.w*n)},r.prototype.scaleToRef=function(n,t){t.x=this.x*n;t.y=this.y*n;t.z=this.z*n;t.w=this.w*n},r.prototype.equals=function(n){return n&&this.x===n.x&&this.y===n.y&&this.z===n.z&&this.w===n.w},r.prototype.equalsWithEpsilon=function(t,r){return void 0===r&&(r=n.Epsilon),t&&i.WithinEpsilon(this.x,t.x,r)&&i.WithinEpsilon(this.y,t.y,r)&&i.WithinEpsilon(this.z,t.z,r)&&i.WithinEpsilon(this.w,t.w,r)},r.prototype.equalsToFloats=function(n,t,i,r){return this.x===n&&this.y===t&&this.z===i&&this.w===r},r.prototype.multiplyInPlace=function(n){return this.x*=n.x,this.y*=n.y,this.z*=n.z,this.w*=n.w,this},r.prototype.multiply=function(n){return new r(this.x*n.x,this.y*n.y,this.z*n.z,this.w*n.w)},r.prototype.multiplyToRef=function(n,t){return t.x=this.x*n.x,t.y=this.y*n.y,t.z=this.z*n.z,t.w=this.w*n.w,this},r.prototype.multiplyByFloats=function(n,t,i,u){return new r(this.x*n,this.y*t,this.z*i,this.w*u)},r.prototype.divide=function(n){return new r(this.x/n.x,this.y/n.y,this.z/n.z,this.w/n.w)},r.prototype.divideToRef=function(n,t){return t.x=this.x/n.x,t.y=this.y/n.y,t.z=this.z/n.z,t.w=this.w/n.w,this},r.prototype.MinimizeInPlace=function(n){return n.x<this.x&&(this.x=n.x),n.y<this.y&&(this.y=n.y),n.z<this.z&&(this.z=n.z),n.w<this.w&&(this.w=n.w),this},r.prototype.MaximizeInPlace=function(n){return n.x>this.x&&(this.x=n.x),n.y>this.y&&(this.y=n.y),n.z>this.z&&(this.z=n.z),n.w>this.w&&(this.w=n.w),this},r.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},r.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},r.prototype.normalize=function(){var t=this.length(),n;return 0===t?this:(n=1/t,this.x*=n,this.y*=n,this.z*=n,this.w*=n,this)},r.prototype.toVector3=function(){return new t(this.x,this.y,this.z)},r.prototype.clone=function(){return new r(this.x,this.y,this.z,this.w)},r.prototype.copyFrom=function(n){return this.x=n.x,this.y=n.y,this.z=n.z,this.w=n.w,this},r.prototype.copyFromFloats=function(n,t,i,r){return this.x=n,this.y=t,this.z=i,this.w=r,this},r.FromArray=function(n,t){return t||(t=0),new r(n[t],n[t+1],n[t+2],n[t+3])},r.FromArrayToRef=function(n,t,i){i.x=n[t];i.y=n[t+1];i.z=n[t+2];i.w=n[t+3]},r.FromFloatArrayToRef=function(n,t,i){i.x=n[t];i.y=n[t+1];i.z=n[t+2];i.w=n[t+3]},r.FromFloatsToRef=function(n,t,i,r,u){u.x=n;u.y=t;u.z=i;u.w=r},r.Zero=function(){return new r(0,0,0,0)},r.Normalize=function(n){var t=r.Zero();return r.NormalizeToRef(n,t),t},r.NormalizeToRef=function(n,t){t.copyFrom(n);t.normalize()},r.Minimize=function(n,t){var i=n.clone();return i.MinimizeInPlace(t),i},r.Maximize=function(n,t){var i=n.clone();return i.MaximizeInPlace(t),i},r.Distance=function(n,t){return Math.sqrt(r.DistanceSquared(n,t))},r.DistanceSquared=function(n,t){var i=n.x-t.x,r=n.y-t.y,u=n.z-t.z,f=n.w-t.w;return i*i+r*r+u*u+f*f},r.Center=function(n,t){var i=n.add(t);return i.scaleInPlace(.5),i},r}();n.Vector4=o;p=function(){function n(n,t){this.width=n;this.height=t}return n.prototype.toString=function(){return"{W: "+this.width+", H: "+this.height+"}"},n.prototype.getClassName=function(){return"Size"},n.prototype.getHashCode=function(){var n=this.width||0;return 397*n^(this.height||0)},n.prototype.copyFrom=function(n){this.width=n.width;this.height=n.height},n.prototype.copyFromFloats=function(n,t){this.width=n;this.height=t},n.prototype.multiplyByFloats=function(t,i){return new n(this.width*t,this.height*i)},n.prototype.clone=function(){return new n(this.width,this.height)},n.prototype.equals=function(n){return!!n&&this.width===n.width&&this.height===n.height},Object.defineProperty(n.prototype,"surface",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),n.Zero=function(){return new n(0,0)},n.prototype.add=function(t){return new n(this.width+t.width,this.height+t.height)},n.prototype.substract=function(t){return new n(this.width-t.width,this.height-t.height)},n.Lerp=function(t,i,r){var u=t.width+(i.width-t.width)*r,f=t.height+(i.height-t.height)*r;return new n(u,f)},n}();n.Size=p;e=function(){function n(n,t,i,r){void 0===n&&(n=0);void 0===t&&(t=0);void 0===i&&(i=0);void 0===r&&(r=1);this.x=n;this.y=t;this.z=i;this.w=r}return n.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},n.prototype.getClassName=function(){return"Quaternion"},n.prototype.getHashCode=function(){var n=this.x||0;return n=397*n^(this.y||0),n=397*n^(this.z||0),n=397*n^(this.w||0)},n.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},n.prototype.equals=function(n){return n&&this.x===n.x&&this.y===n.y&&this.z===n.z&&this.w===n.w},n.prototype.clone=function(){return new n(this.x,this.y,this.z,this.w)},n.prototype.copyFrom=function(n){return this.x=n.x,this.y=n.y,this.z=n.z,this.w=n.w,this},n.prototype.copyFromFloats=function(n,t,i,r){return this.x=n,this.y=t,this.z=i,this.w=r,this},n.prototype.add=function(t){return new n(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},n.prototype.subtract=function(t){return new n(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},n.prototype.scale=function(t){return new n(this.x*t,this.y*t,this.z*t,this.w*t)},n.prototype.multiply=function(t){var i=new n(0,0,0,1);return this.multiplyToRef(t,i),i},n.prototype.multiplyToRef=function(n,t){var i=this.x*n.w+this.y*n.z-this.z*n.y+this.w*n.x,r=-this.x*n.z+this.y*n.w+this.z*n.x+this.w*n.y,u=this.x*n.y-this.y*n.x+this.z*n.w+this.w*n.z,f=-this.x*n.x-this.y*n.y-this.z*n.z+this.w*n.w;return t.copyFromFloats(i,r,u,f),this},n.prototype.multiplyInPlace=function(n){return this.multiplyToRef(n,this),this},n.prototype.conjugateToRef=function(n){return n.copyFromFloats(-this.x,-this.y,-this.z,this.w),this},n.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},n.prototype.conjugate=function(){return new n(-this.x,-this.y,-this.z,this.w)},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.prototype.normalize=function(){var n=1/this.length();return this.x*=n,this.y*=n,this.z*=n,this.w*=n,this},n.prototype.toEulerAngles=function(n){void 0===n&&(n="YZX");var i=t.Zero();return this.toEulerAnglesToRef(i,n),i},n.prototype.toEulerAnglesToRef=function(n,t){void 0===t&&(t="YZX");var u=this.z,f=this.x,i=this.y,r=this.w,e=r*r,o=u*u,s=f*f,h=i*i,c=i*u-f*r,l=.4999999;return c<-l?(n.y=2*Math.atan2(i,r),n.x=Math.PI/2,n.z=0):c>l?(n.y=2*Math.atan2(i,r),n.x=-Math.PI/2,n.z=0):(n.z=Math.atan2(2*(f*i+u*r),-o-s+h+e),n.x=Math.asin(-2*(u*i-f*r)),n.y=Math.atan2(2*(u*f+i*r),o-s-h+e)),this},n.prototype.toRotationMatrix=function(n){var t=this.x*this.x,i=this.y*this.y,r=this.z*this.z,u=this.x*this.y,f=this.z*this.w,e=this.z*this.x,o=this.y*this.w,s=this.y*this.z,h=this.x*this.w;return n.m[0]=1-2*(i+r),n.m[1]=2*(u+f),n.m[2]=2*(e-o),n.m[3]=0,n.m[4]=2*(u-f),n.m[5]=1-2*(r+t),n.m[6]=2*(s+h),n.m[7]=0,n.m[8]=2*(e+o),n.m[9]=2*(s-h),n.m[10]=1-2*(i+t),n.m[11]=0,n.m[12]=0,n.m[13]=0,n.m[14]=0,n.m[15]=1,this},n.prototype.fromRotationMatrix=function(t){return n.FromRotationMatrixToRef(t,this),this},n.FromRotationMatrix=function(t){var i=new n;return n.FromRotationMatrixToRef(t,i),i},n.FromRotationMatrixToRef=function(n,t){var i,r=n.m,u=r[0],o=r[4],s=r[8],h=r[1],f=r[5],c=r[9],l=r[2],a=r[6],e=r[10],v=u+f+e;v>0?(i=.5/Math.sqrt(v+1),t.w=.25/i,t.x=(a-c)*i,t.y=(s-l)*i,t.z=(h-o)*i):u>f&&u>e?(i=2*Math.sqrt(1+u-f-e),t.w=(a-c)/i,t.x=.25*i,t.y=(o+h)/i,t.z=(s+l)/i):f>e?(i=2*Math.sqrt(1+f-u-e),t.w=(s-l)/i,t.x=(o+h)/i,t.y=.25*i,t.z=(c+a)/i):(i=2*Math.sqrt(1+e-u-f),t.w=(h-o)/i,t.x=(s+l)/i,t.y=(c+a)/i,t.z=.25*i)},n.Inverse=function(t){return new n(-t.x,-t.y,-t.z,t.w)},n.Identity=function(){return new n(0,0,0,1)},n.RotationAxis=function(t,i){return n.RotationAxisToRef(t,i,new n)},n.RotationAxisToRef=function(n,t,i){var r=Math.sin(t/2);return n.normalize(),i.w=Math.cos(t/2),i.x=n.x*r,i.y=n.y*r,i.z=n.z*r,i},n.FromArray=function(t,i){return i||(i=0),new n(t[i],t[i+1],t[i+2],t[i+3])},n.RotationYawPitchRoll=function(t,i,r){var u=new n;return n.RotationYawPitchRollToRef(t,i,r,u),u},n.RotationYawPitchRollToRef=function(n,t,i,r){var c=.5*i,l=.5*t,a=.5*n,u=Math.sin(c),f=Math.cos(c),e=Math.sin(l),o=Math.cos(l),s=Math.sin(a),h=Math.cos(a);r.x=h*e*f+s*o*u;r.y=s*o*f-h*e*u;r.z=h*o*u-s*e*f;r.w=h*o*f+s*e*u},n.RotationAlphaBetaGamma=function(t,i,r){var u=new n;return n.RotationAlphaBetaGammaToRef(t,i,r,u),u},n.RotationAlphaBetaGammaToRef=function(n,t,i,r){var f=.5*(i+n),e=.5*(i-n),u=.5*t;r.x=Math.cos(e)*Math.sin(u);r.y=Math.sin(e)*Math.sin(u);r.z=Math.sin(f)*Math.cos(u);r.w=Math.cos(f)*Math.cos(u)},n.Slerp=function(t,i,r){var u=n.Identity();return n.SlerpToRef(t,i,r,u),u},n.SlerpToRef=function(n,t,i,r){var u,f,e=i,o=n.x*t.x+n.y*t.y+n.z*t.z+n.w*t.w,c=!1,s,h;(o<0&&(c=!0,o=-o),o>.999999)?(f=1-e,u=c?-e:e):(s=Math.acos(o),h=1/Math.sin(s),f=Math.sin((1-e)*s)*h,u=c?-Math.sin(e*s)*h:Math.sin(e*s)*h);r.x=f*n.x+u*t.x;r.y=f*n.y+u*t.y;r.z=f*n.z+u*t.z;r.w=f*n.w+u*t.w},n}();n.Quaternion=e;r=function(){function n(){this.m=new Float32Array(16)}return n.prototype.isIdentity=function(){return 1===this.m[0]&&1===this.m[5]&&1===this.m[10]&&1===this.m[15]&&0===this.m[1]&&0===this.m[2]&&0===this.m[3]&&0===this.m[4]&&0===this.m[6]&&0===this.m[7]&&0===this.m[8]&&0===this.m[9]&&0===this.m[11]&&0===this.m[12]&&0===this.m[13]&&0===this.m[14]},n.prototype.determinant=function(){var n=this.m[10]*this.m[15]-this.m[11]*this.m[14],t=this.m[9]*this.m[15]-this.m[11]*this.m[13],i=this.m[9]*this.m[14]-this.m[10]*this.m[13],r=this.m[8]*this.m[15]-this.m[11]*this.m[12],u=this.m[8]*this.m[14]-this.m[10]*this.m[12],f=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*n-this.m[6]*t+this.m[7]*i)-this.m[1]*(this.m[4]*n-this.m[6]*r+this.m[7]*u)+this.m[2]*(this.m[4]*t-this.m[5]*r+this.m[7]*f)-this.m[3]*(this.m[4]*i-this.m[5]*u+this.m[6]*f)},n.prototype.toArray=function(){return this.m},n.prototype.asArray=function(){return this.toArray()},n.prototype.invert=function(){return this.invertToRef(this),this},n.prototype.reset=function(){for(var n=0;n<16;n++)this.m[n]=0;return this},n.prototype.add=function(t){var i=new n;return this.addToRef(t,i),i},n.prototype.addToRef=function(n,t){for(var i=0;i<16;i++)t.m[i]=this.m[i]+n.m[i];return this},n.prototype.addToSelf=function(n){for(var t=0;t<16;t++)this.m[t]+=n.m[t];return this},n.prototype.invertToRef=function(n){var i=this.m[0],r=this.m[1],u=this.m[2],f=this.m[3],e=this.m[4],o=this.m[5],s=this.m[6],h=this.m[7],c=this.m[8],l=this.m[9],a=this.m[10],v=this.m[11],y=this.m[12],p=this.m[13],w=this.m[14],b=this.m[15],k=a*b-v*w,d=l*b-v*p,g=l*w-a*p,nt=c*b-v*y,tt=c*w-a*y,it=c*p-l*y,rt=o*k-s*d+h*g,ut=-(e*k-s*nt+h*tt),ft=e*d-o*nt+h*it,et=-(e*g-o*tt+s*it),t=1/(i*rt+r*ut+u*ft+f*et),ot=s*b-h*w,st=o*b-h*p,ht=o*w-s*p,ct=e*b-h*y,lt=e*w-s*y,at=e*p-o*y,vt=s*v-h*a,yt=o*v-h*l,pt=o*a-s*l,wt=e*v-h*c,bt=e*a-s*c,kt=e*l-o*c;return n.m[0]=rt*t,n.m[4]=ut*t,n.m[8]=ft*t,n.m[12]=et*t,n.m[1]=-(r*k-u*d+f*g)*t,n.m[5]=(i*k-u*nt+f*tt)*t,n.m[9]=-(i*d-r*nt+f*it)*t,n.m[13]=(i*g-r*tt+u*it)*t,n.m[2]=(r*ot-u*st+f*ht)*t,n.m[6]=-(i*ot-u*ct+f*lt)*t,n.m[10]=(i*st-r*ct+f*at)*t,n.m[14]=-(i*ht-r*lt+u*at)*t,n.m[3]=-(r*vt-u*yt+f*pt)*t,n.m[7]=(i*vt-u*wt+f*bt)*t,n.m[11]=-(i*yt-r*wt+f*kt)*t,n.m[15]=(i*pt-r*bt+u*kt)*t,this},n.prototype.setTranslation=function(n){return this.m[12]=n.x,this.m[13]=n.y,this.m[14]=n.z,this},n.prototype.getTranslation=function(){return new t(this.m[12],this.m[13],this.m[14])},n.prototype.multiply=function(t){var i=new n;return this.multiplyToRef(t,i),i},n.prototype.copyFrom=function(n){for(var t=0;t<16;t++)this.m[t]=n.m[t];return this},n.prototype.copyToArray=function(n,t){void 0===t&&(t=0);for(var i=0;i<16;i++)n[t+i]=this.m[i];return this},n.prototype.multiplyToRef=function(n,t){return this.multiplyToArray(n,t.m,0),this},n.prototype.multiplyToArray=function(n,t,i){var r=this.m[0],u=this.m[1],f=this.m[2],e=this.m[3],o=this.m[4],s=this.m[5],h=this.m[6],c=this.m[7],l=this.m[8],a=this.m[9],v=this.m[10],y=this.m[11],p=this.m[12],w=this.m[13],b=this.m[14],k=this.m[15],d=n.m[0],g=n.m[1],nt=n.m[2],tt=n.m[3],it=n.m[4],rt=n.m[5],ut=n.m[6],ft=n.m[7],et=n.m[8],ot=n.m[9],st=n.m[10],ht=n.m[11],ct=n.m[12],lt=n.m[13],at=n.m[14],vt=n.m[15];return t[i]=r*d+u*it+f*et+e*ct,t[i+1]=r*g+u*rt+f*ot+e*lt,t[i+2]=r*nt+u*ut+f*st+e*at,t[i+3]=r*tt+u*ft+f*ht+e*vt,t[i+4]=o*d+s*it+h*et+c*ct,t[i+5]=o*g+s*rt+h*ot+c*lt,t[i+6]=o*nt+s*ut+h*st+c*at,t[i+7]=o*tt+s*ft+h*ht+c*vt,t[i+8]=l*d+a*it+v*et+y*ct,t[i+9]=l*g+a*rt+v*ot+y*lt,t[i+10]=l*nt+a*ut+v*st+y*at,t[i+11]=l*tt+a*ft+v*ht+y*vt,t[i+12]=p*d+w*it+b*et+k*ct,t[i+13]=p*g+w*rt+b*ot+k*lt,t[i+14]=p*nt+w*ut+b*st+k*at,t[i+15]=p*tt+w*ft+b*ht+k*vt,this},n.prototype.equals=function(n){return n&&this.m[0]===n.m[0]&&this.m[1]===n.m[1]&&this.m[2]===n.m[2]&&this.m[3]===n.m[3]&&this.m[4]===n.m[4]&&this.m[5]===n.m[5]&&this.m[6]===n.m[6]&&this.m[7]===n.m[7]&&this.m[8]===n.m[8]&&this.m[9]===n.m[9]&&this.m[10]===n.m[10]&&this.m[11]===n.m[11]&&this.m[12]===n.m[12]&&this.m[13]===n.m[13]&&this.m[14]===n.m[14]&&this.m[15]===n.m[15]},n.prototype.clone=function(){return n.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},n.prototype.getClassName=function(){return"Matrix"},n.prototype.getHashCode=function(){for(var n=this.m[0]||0,t=1;t<16;t++)n=397*n^(this.m[t]||0);return n},n.prototype.decompose=function(t,r,u){u.x=this.m[12];u.y=this.m[13];u.z=this.m[14];var o=i.Sign(this.m[0]*this.m[1]*this.m[2]*this.m[3])<0?-1:1,s=i.Sign(this.m[4]*this.m[5]*this.m[6]*this.m[7])<0?-1:1,h=i.Sign(this.m[8]*this.m[9]*this.m[10]*this.m[11])<0?-1:1;return t.x=o*Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]),t.y=s*Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]),t.z=h*Math.sqrt(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]),0===t.x||0===t.y||0===t.z?(r.x=0,r.y=0,r.z=0,r.w=1,!1):(n.FromValuesToRef(this.m[0]/t.x,this.m[1]/t.x,this.m[2]/t.x,0,this.m[4]/t.y,this.m[5]/t.y,this.m[6]/t.y,0,this.m[8]/t.z,this.m[9]/t.z,this.m[10]/t.z,0,0,0,0,1,f.Matrix[0]),e.FromRotationMatrixToRef(f.Matrix[0],r),!0)},n.prototype.getRotationMatrix=function(){var t=n.Identity();return this.getRotationMatrixToRef(t),t},n.prototype.getRotationMatrixToRef=function(t){var i=this.m,e=i[0]*i[1]*i[2]*i[3]<0?-1:1,o=i[4]*i[5]*i[6]*i[7]<0?-1:1,s=i[8]*i[9]*i[10]*i[11]<0?-1:1,r=e*Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),u=o*Math.sqrt(i[4]*i[4]+i[5]*i[5]+i[6]*i[6]),f=s*Math.sqrt(i[8]*i[8]+i[9]*i[9]+i[10]*i[10]);n.FromValuesToRef(i[0]/r,i[1]/r,i[2]/r,0,i[4]/u,i[5]/u,i[6]/u,0,i[8]/f,i[9]/f,i[10]/f,0,0,0,0,1,t)},n.FromArray=function(t,i){var r=new n;return i||(i=0),n.FromArrayToRef(t,i,r),r},n.FromArrayToRef=function(n,t,i){for(var r=0;r<16;r++)i.m[r]=n[r+t]},n.FromFloat32ArrayToRefScaled=function(n,t,i,r){for(var u=0;u<16;u++)r.m[u]=n[u+t]*i},n.FromValuesToRef=function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w){w.m[0]=n;w.m[1]=t;w.m[2]=i;w.m[3]=r;w.m[4]=u;w.m[5]=f;w.m[6]=e;w.m[7]=o;w.m[8]=s;w.m[9]=h;w.m[10]=c;w.m[11]=l;w.m[12]=a;w.m[13]=v;w.m[14]=y;w.m[15]=p},n.prototype.getRow=function(n){if(n<0||n>3)return null;var t=4*n;return new o(this.m[t+0],this.m[t+1],this.m[t+2],this.m[t+3])},n.prototype.setRow=function(n,t){if(n<0||n>3)return this;var i=4*n;return this.m[i+0]=t.x,this.m[i+1]=t.y,this.m[i+2]=t.z,this.m[i+3]=t.w,this},n.FromValues=function(t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w){var b=new n;return b.m[0]=t,b.m[1]=i,b.m[2]=r,b.m[3]=u,b.m[4]=f,b.m[5]=e,b.m[6]=o,b.m[7]=s,b.m[8]=h,b.m[9]=c,b.m[10]=l,b.m[11]=a,b.m[12]=v,b.m[13]=y,b.m[14]=p,b.m[15]=w,b},n.Compose=function(t,i,r){var u=n.FromValues(t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1),f=n.Identity();return i.toRotationMatrix(f),u=u.multiply(f),u.setTranslation(r),u},n.Identity=function(){return n.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},n.IdentityToRef=function(t){n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t)},n.Zero=function(){return n.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},n.RotationX=function(t){var i=new n;return n.RotationXToRef(t,i),i},n.Invert=function(t){var i=new n;return t.invertToRef(i),i},n.RotationXToRef=function(n,t){var i=Math.sin(n),r=Math.cos(n);t.m[0]=1;t.m[15]=1;t.m[5]=r;t.m[10]=r;t.m[9]=-i;t.m[6]=i;t.m[1]=0;t.m[2]=0;t.m[3]=0;t.m[4]=0;t.m[7]=0;t.m[8]=0;t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0},n.RotationY=function(t){var i=new n;return n.RotationYToRef(t,i),i},n.RotationYToRef=function(n,t){var i=Math.sin(n),r=Math.cos(n);t.m[5]=1;t.m[15]=1;t.m[0]=r;t.m[2]=-i;t.m[8]=i;t.m[10]=r;t.m[1]=0;t.m[3]=0;t.m[4]=0;t.m[6]=0;t.m[7]=0;t.m[9]=0;t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0},n.RotationZ=function(t){var i=new n;return n.RotationZToRef(t,i),i},n.RotationZToRef=function(n,t){var i=Math.sin(n),r=Math.cos(n);t.m[10]=1;t.m[15]=1;t.m[0]=r;t.m[1]=i;t.m[4]=-i;t.m[5]=r;t.m[2]=0;t.m[3]=0;t.m[6]=0;t.m[7]=0;t.m[8]=0;t.m[9]=0;t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0},n.RotationAxis=function(t,i){var r=n.Zero();return n.RotationAxisToRef(t,i,r),r},n.RotationAxisToRef=function(n,t,i){var u=Math.sin(-t),f=Math.cos(-t),r=1-f;n.normalize();i.m[0]=n.x*n.x*r+f;i.m[1]=n.x*n.y*r-n.z*u;i.m[2]=n.x*n.z*r+n.y*u;i.m[3]=0;i.m[4]=n.y*n.x*r+n.z*u;i.m[5]=n.y*n.y*r+f;i.m[6]=n.y*n.z*r-n.x*u;i.m[7]=0;i.m[8]=n.z*n.x*r-n.y*u;i.m[9]=n.z*n.y*r+n.x*u;i.m[10]=n.z*n.z*r+f;i.m[11]=0;i.m[15]=1},n.RotationYawPitchRoll=function(t,i,r){var u=new n;return n.RotationYawPitchRollToRef(t,i,r,u),u},n.RotationYawPitchRollToRef=function(n,t,i,r){e.RotationYawPitchRollToRef(n,t,i,this._tempQuaternion);this._tempQuaternion.toRotationMatrix(r)},n.Scaling=function(t,i,r){var u=n.Zero();return n.ScalingToRef(t,i,r,u),u},n.ScalingToRef=function(n,t,i,r){r.m[0]=n;r.m[1]=0;r.m[2]=0;r.m[3]=0;r.m[4]=0;r.m[5]=t;r.m[6]=0;r.m[7]=0;r.m[8]=0;r.m[9]=0;r.m[10]=i;r.m[11]=0;r.m[12]=0;r.m[13]=0;r.m[14]=0;r.m[15]=1},n.Translation=function(t,i,r){var u=n.Identity();return n.TranslationToRef(t,i,r,u),u},n.TranslationToRef=function(t,i,r,u){n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,i,r,1,u)},n.Lerp=function(t,i,r){for(var f=n.Zero(),u=0;u<16;u++)f.m[u]=t.m[u]*(1-r)+i.m[u]*r;return f},n.DecomposeLerp=function(i,r,u){var f=new t(0,0,0),o=new e,s=new t(0,0,0);i.decompose(f,o,s);var h=new t(0,0,0),c=new e,l=new t(0,0,0);r.decompose(h,c,l);var a=t.Lerp(f,h,u),v=e.Slerp(o,c,u),y=t.Lerp(s,l,u);return n.Compose(a,v,y)},n.LookAtLH=function(t,i,r){var u=n.Zero();return n.LookAtLHToRef(t,i,r,u),u},n.LookAtLHToRef=function(i,r,u,f){r.subtractToRef(i,this._zAxis);this._zAxis.normalize();t.CrossToRef(u,this._zAxis,this._xAxis);0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize();t.CrossToRef(this._zAxis,this._xAxis,this._yAxis);this._yAxis.normalize();var e=-t.Dot(this._xAxis,i),o=-t.Dot(this._yAxis,i),s=-t.Dot(this._zAxis,i);return n.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,e,o,s,1,f)},n.LookAtRH=function(t,i,r){var u=n.Zero();return n.LookAtRHToRef(t,i,r,u),u},n.LookAtRHToRef=function(i,r,u,f){i.subtractToRef(r,this._zAxis);this._zAxis.normalize();t.CrossToRef(u,this._zAxis,this._xAxis);0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize();t.CrossToRef(this._zAxis,this._xAxis,this._yAxis);this._yAxis.normalize();var e=-t.Dot(this._xAxis,i),o=-t.Dot(this._yAxis,i),s=-t.Dot(this._zAxis,i);return n.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,e,o,s,1,f)},n.OrthoLH=function(t,i,r,u){var f=n.Zero();return n.OrthoLHToRef(t,i,r,u,f),f},n.OrthoLHToRef=function(t,i,r,u,f){var e=2/t,o=2/i,s=1/(u-r),h=r/(r-u);n.FromValuesToRef(e,0,0,0,0,o,0,0,0,0,s,0,0,0,h,1,f)},n.OrthoOffCenterLH=function(t,i,r,u,f,e){var o=n.Zero();return n.OrthoOffCenterLHToRef(t,i,r,u,f,e,o),o},n.OrthoOffCenterLHToRef=function(n,t,i,r,u,f,e){e.m[0]=2/(t-n);e.m[1]=e.m[2]=e.m[3]=0;e.m[5]=2/(r-i);e.m[4]=e.m[6]=e.m[7]=0;e.m[10]=1/(f-u);e.m[8]=e.m[9]=e.m[11]=0;e.m[12]=(n+t)/(n-t);e.m[13]=(r+i)/(i-r);e.m[14]=-u/(f-u);e.m[15]=1},n.OrthoOffCenterRH=function(t,i,r,u,f,e){var o=n.Zero();return n.OrthoOffCenterRHToRef(t,i,r,u,f,e,o),o},n.OrthoOffCenterRHToRef=function(t,i,r,u,f,e,o){n.OrthoOffCenterLHToRef(t,i,r,u,f,e,o);o.m[10]*=-1},n.PerspectiveLH=function(t,i,r,u){var f=n.Zero();return f.m[0]=2*r/t,f.m[1]=f.m[2]=f.m[3]=0,f.m[5]=2*r/i,f.m[4]=f.m[6]=f.m[7]=0,f.m[10]=-u/(r-u),f.m[8]=f.m[9]=0,f.m[11]=1,f.m[12]=f.m[13]=f.m[15]=0,f.m[14]=r*u/(r-u),f},n.PerspectiveFovLH=function(t,i,r,u){var f=n.Zero();return n.PerspectiveFovLHToRef(t,i,r,u,f),f},n.PerspectiveFovLHToRef=function(n,t,i,r,u,f){void 0===f&&(f=!0);var e=1/Math.tan(.5*n);u.m[0]=f?e/t:e;u.m[1]=u.m[2]=u.m[3]=0;u.m[5]=f?e:e*t;u.m[4]=u.m[6]=u.m[7]=0;u.m[8]=u.m[9]=0;u.m[10]=r/(r-i);u.m[11]=1;u.m[12]=u.m[13]=u.m[15]=0;u.m[14]=-(i*r)/(r-i)},n.PerspectiveFovRH=function(t,i,r,u){var f=n.Zero();return n.PerspectiveFovRHToRef(t,i,r,u,f),f},n.PerspectiveFovRHToRef=function(n,t,i,r,u,f){void 0===f&&(f=!0);var e=1/Math.tan(.5*n);u.m[0]=f?e/t:e;u.m[1]=u.m[2]=u.m[3]=0;u.m[5]=f?e:e*t;u.m[4]=u.m[6]=u.m[7]=0;u.m[8]=u.m[9]=0;u.m[10]=r/(i-r);u.m[11]=-1;u.m[12]=u.m[13]=u.m[15]=0;u.m[14]=i*r/(i-r)},n.PerspectiveFovWebVRToRef=function(n,t,i,r,u){void 0===u&&(u=!0);var f=Math.tan(n.upDegrees*Math.PI/180),e=Math.tan(n.downDegrees*Math.PI/180),o=Math.tan(n.leftDegrees*Math.PI/180),s=Math.tan(n.rightDegrees*Math.PI/180),h=2/(o+s),c=2/(f+e);r.m[0]=h;r.m[1]=r.m[2]=r.m[3]=r.m[4]=0;r.m[5]=c;r.m[6]=r.m[7]=0;r.m[8]=(o-s)*h*.5;r.m[9]=-((f-e)*c*.5);r.m[10]=-i/(t-i);r.m[11]=1;r.m[12]=r.m[13]=r.m[15]=0;r.m[14]=t*i/(t-i)},n.GetFinalMatrix=function(t,i,r,u,f,e){var o=t.width,s=t.height,h=t.x,c=t.y,l=n.FromValues(o/2,0,0,0,0,-s/2,0,0,0,0,e-f,0,h+o/2,s/2+c,f,1);return i.multiply(r).multiply(u).multiply(l)},n.GetAsMatrix2x2=function(n){return new Float32Array([n.m[0],n.m[1],n.m[4],n.m[5]])},n.GetAsMatrix3x3=function(n){return new Float32Array([n.m[0],n.m[1],n.m[2],n.m[4],n.m[5],n.m[6],n.m[8],n.m[9],n.m[10]])},n.Transpose=function(t){var i=new n;return i.m[0]=t.m[0],i.m[1]=t.m[4],i.m[2]=t.m[8],i.m[3]=t.m[12],i.m[4]=t.m[1],i.m[5]=t.m[5],i.m[6]=t.m[9],i.m[7]=t.m[13],i.m[8]=t.m[2],i.m[9]=t.m[6],i.m[10]=t.m[10],i.m[11]=t.m[14],i.m[12]=t.m[3],i.m[13]=t.m[7],i.m[14]=t.m[11],i.m[15]=t.m[15],i},n.Reflection=function(t){var i=new n;return n.ReflectionToRef(t,i),i},n.ReflectionToRef=function(n,t){n.normalize();var i=n.normal.x,r=n.normal.y,u=n.normal.z,f=-2*i,e=-2*r,o=-2*u;t.m[0]=f*i+1;t.m[1]=e*i;t.m[2]=o*i;t.m[3]=0;t.m[4]=f*r;t.m[5]=e*r+1;t.m[6]=o*r;t.m[7]=0;t.m[8]=f*u;t.m[9]=e*u;t.m[10]=o*u+1;t.m[11]=0;t.m[12]=f*n.d;t.m[13]=e*n.d;t.m[14]=o*n.d;t.m[15]=1},n.FromXYZAxesToRef=function(n,t,i,r){r.m[0]=n.x;r.m[1]=n.y;r.m[2]=n.z;r.m[3]=0;r.m[4]=t.x;r.m[5]=t.y;r.m[6]=t.z;r.m[7]=0;r.m[8]=i.x;r.m[9]=i.y;r.m[10]=i.z;r.m[11]=0;r.m[12]=0;r.m[13]=0;r.m[14]=0;r.m[15]=1},n.FromQuaternionToRef=function(n,t){var i=n.x*n.x,r=n.y*n.y,u=n.z*n.z,f=n.x*n.y,e=n.z*n.w,o=n.z*n.x,s=n.y*n.w,h=n.y*n.z,c=n.x*n.w;t.m[0]=1-2*(r+u);t.m[1]=2*(f+e);t.m[2]=2*(o-s);t.m[3]=0;t.m[4]=2*(f-e);t.m[5]=1-2*(u+i);t.m[6]=2*(h+c);t.m[7]=0;t.m[8]=2*(o+s);t.m[9]=2*(h-c);t.m[10]=1-2*(r+i);t.m[11]=0;t.m[12]=0;t.m[13]=0;t.m[14]=0;t.m[15]=1},n._tempQuaternion=new e,n._xAxis=t.Zero(),n._yAxis=t.Zero(),n._zAxis=t.Zero(),n}();n.Matrix=r;v=function(){function n(n,i,r,u){this.normal=new t(n,i,r);this.d=u}return n.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},n.prototype.clone=function(){return new n(this.normal.x,this.normal.y,this.normal.z,this.d)},n.prototype.getClassName=function(){return"Plane"},n.prototype.getHashCode=function(){var n=this.normal.getHashCode();return 397*n^(this.d||0)},n.prototype.normalize=function(){var t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),n=0;return 0!==t&&(n=1/t),this.normal.x*=n,this.normal.y*=n,this.normal.z*=n,this.d*=n,this},n.prototype.transform=function(t){var i=r.Transpose(t),u=this.normal.x,f=this.normal.y,e=this.normal.z,o=this.d,s=u*i.m[0]+f*i.m[1]+e*i.m[2]+o*i.m[3],h=u*i.m[4]+f*i.m[5]+e*i.m[6]+o*i.m[7],c=u*i.m[8]+f*i.m[9]+e*i.m[10]+o*i.m[11],l=u*i.m[12]+f*i.m[13]+e*i.m[14]+o*i.m[15];return new n(s,h,c,l)},n.prototype.dotCoordinate=function(n){return this.normal.x*n.x+this.normal.y*n.y+this.normal.z*n.z+this.d},n.prototype.copyFromPoints=function(n,t,i){var r,o=t.x-n.x,s=t.y-n.y,h=t.z-n.z,c=i.x-n.x,l=i.y-n.y,a=i.z-n.z,u=s*a-h*l,f=h*c-o*a,e=o*l-s*c,v=Math.sqrt(u*u+f*f+e*e);return r=0!==v?1/v:0,this.normal.x=u*r,this.normal.y=f*r,this.normal.z=e*r,this.d=-(this.normal.x*n.x+this.normal.y*n.y+this.normal.z*n.z),this},n.prototype.isFrontFacingTo=function(n,i){var r=t.Dot(this.normal,n);return r<=i},n.prototype.signedDistanceTo=function(n){return t.Dot(n,this.normal)+this.d},n.FromArray=function(t){return new n(t[0],t[1],t[2],t[3])},n.FromPoints=function(t,i,r){var u=new n(0,0,0,0);return u.copyFromPoints(t,i,r),u},n.FromPositionAndNormal=function(t,i){var r=new n(0,0,0,0);return i.normalize(),r.normal=i,r.d=-(i.x*t.x+i.y*t.y+i.z*t.z),r},n.SignedDistanceToPlaneFromPositionAndNormal=function(n,i,r){var u=-(i.x*n.x+i.y*n.y+i.z*n.z);return t.Dot(r,i)+u},n}();n.Plane=v;w=function(){function n(n,t,i,r){this.x=n;this.y=t;this.width=i;this.height=r}return n.prototype.toGlobal=function(t,i){return new n(this.x*t,this.y*i,this.width*t,this.height*i)},n}();n.Viewport=w;b=function(){function n(){}return n.GetPlanes=function(t){for(var i=[],r=0;r<6;r++)i.push(new v(0,0,0,0));return n.GetPlanesToRef(t,i),i},n.GetPlanesToRef=function(n,t){t[0].normal.x=n.m[3]+n.m[2];t[0].normal.y=n.m[7]+n.m[6];t[0].normal.z=n.m[11]+n.m[10];t[0].d=n.m[15]+n.m[14];t[0].normalize();t[1].normal.x=n.m[3]-n.m[2];t[1].normal.y=n.m[7]-n.m[6];t[1].normal.z=n.m[11]-n.m[10];t[1].d=n.m[15]-n.m[14];t[1].normalize();t[2].normal.x=n.m[3]+n.m[0];t[2].normal.y=n.m[7]+n.m[4];t[2].normal.z=n.m[11]+n.m[8];t[2].d=n.m[15]+n.m[12];t[2].normalize();t[3].normal.x=n.m[3]-n.m[0];t[3].normal.y=n.m[7]-n.m[4];t[3].normal.z=n.m[11]-n.m[8];t[3].d=n.m[15]-n.m[12];t[3].normalize();t[4].normal.x=n.m[3]-n.m[1];t[4].normal.y=n.m[7]-n.m[5];t[4].normal.z=n.m[11]-n.m[9];t[4].d=n.m[15]-n.m[13];t[4].normalize();t[5].normal.x=n.m[3]+n.m[1];t[5].normal.y=n.m[7]+n.m[5];t[5].normal.z=n.m[11]+n.m[9];t[5].d=n.m[15]+n.m[13];t[5].normalize()},n}();n.Frustum=b,function(n){n[n.LOCAL=0]="LOCAL";n[n.WORLD=1]="WORLD"}(n.Space||(n.Space={}));l=(n.Space,function(){function n(){}return n.X=new t(1,0,0),n.Y=new t(0,1,0),n.Z=new t(0,0,1),n}());n.Axis=l;k=function(){function n(){}return n.interpolate=function(n,t,i,r,u){for(var o=1-3*r+3*t,s=3*r-6*t,h=3*t,f=n,c=0;c<5;c++){var e=f*f,l=e*f,a=o*l+s*e+h*f,v=1/(3*o*e+2*s*f+h);f-=(a-n)*v;f=Math.min(1,Math.max(0,f))}return 3*Math.pow(1-f,2)*f*i+3*(1-f)*Math.pow(f,2)*u+Math.pow(f,3)},n}();n.BezierCurve=k,function(n){n[n.CW=0]="CW";n[n.CCW=1]="CCW"}(n.Orientation||(n.Orientation={}));c=n.Orientation;s=function(){function n(n){var t=this;this.degrees=function(){return 180*t._radians/Math.PI};this.radians=function(){return t._radians};this._radians=n;this._radians<0&&(this._radians+=2*Math.PI)}return n.BetweenTwoPoints=function(t,i){var r=i.subtract(t),u=Math.atan2(r.y,r.x);return new n(u)},n.FromRadians=function(t){return new n(t)},n.FromDegrees=function(t){return new n(t*Math.PI/180)},n}();n.Angle=s;y=function(){function n(n,t,i){this.startPoint=n;this.midPoint=t;this.endPoint=i;var o=Math.pow(t.x,2)+Math.pow(t.y,2),h=(Math.pow(n.x,2)+Math.pow(n.y,2)-o)/2,l=(o-Math.pow(i.x,2)-Math.pow(i.y,2))/2,a=(n.x-t.x)*(t.y-i.y)-(t.x-i.x)*(n.y-t.y);this.centerPoint=new u((h*(t.y-i.y)-l*(n.y-t.y))/a,((n.x-t.x)*l-(t.x-i.x)*h)/a);this.radius=this.centerPoint.subtract(this.startPoint).length();this.startAngle=s.BetweenTwoPoints(this.centerPoint,this.startPoint);var e=this.startAngle.degrees(),r=s.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),f=s.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();r-e>180&&(r-=360);r-e<-180&&(r+=360);f-r>180&&(f-=360);f-r<-180&&(f+=360);this.orientation=r-e<0?c.CW:c.CCW;this.angle=s.FromDegrees(this.orientation===c.CW?e-f:f-e)}return n}();n.Arc2=y;d=function(){function n(n,t){this._points=[];this._length=0;this.closed=!1;this._points.push(new u(n,t))}return n.prototype.addLineTo=function(n,t){if(closed)return this;var i=new u(n,t),r=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(r).length(),this},n.prototype.addArcTo=function(n,t,i,r,f){var o,h,l,a;if(void 0===f&&(f=36),closed)return this;var v=this._points[this._points.length-1],p=new u(n,t),w=new u(i,r),e=new y(v,p,w),s=e.angle.radians()/f;for(e.orientation===c.CW&&(s*=-1),o=e.startAngle.radians()+s,h=0;h<f;h++)l=Math.cos(o)*e.radius+e.centerPoint.x,a=Math.sin(o)*e.radius+e.centerPoint.y,this.addLineTo(l,a),o+=s;return this},n.prototype.close=function(){return this.closed=!0,this},n.prototype.length=function(){var n=this._length,t,i;return this.closed||(t=this._points[this._points.length-1],i=this._points[0],n+=i.subtract(t).length()),n},n.prototype.getPoints=function(){return this._points},n.prototype.getPointAtLengthPosition=function(n){var e,o;if(n<0||n>1)return u.Zero();for(var r=n*this.length(),t=0,i=0;i<this._points.length;i++){var c=(i+1)%this._points.length,f=this._points[i],l=this._points[c],s=l.subtract(f),h=s.length()+t;if(r>=t&&r<=h)return e=s.normalize(),o=r-t,new u(f.x+e.x*o,f.y+e.y*o);t=h}return u.Zero()},n.StartingAt=function(t,i){return new n(t,i)},n}();n.Path2=d;g=function(){function r(n,t,i){this.path=n;this._curve=[];this._distances=[];this._tangents=[];this._normals=[];this._binormals=[];for(var r=0;r<n.length;r++)this._curve[r]=n[r].clone();this._raw=i||!1;this._compute(t)}return r.prototype.getCurve=function(){return this._curve},r.prototype.getTangents=function(){return this._tangents},r.prototype.getNormals=function(){return this._normals},r.prototype.getBinormals=function(){return this._binormals},r.prototype.getDistances=function(){return this._distances},r.prototype.update=function(n,t){for(var i=0;i<n.length;i++)this._curve[i].x=n[i].x,this._curve[i].y=n[i].y,this._curve[i].z=n[i].z;return this._compute(t),this},r.prototype._compute=function(n){var r=this._curve.length,u,o,f,s,e,h,i;for(this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[r-1]=this._curve[r-1].subtract(this._curve[r-2]),this._raw||this._tangents[r-1].normalize(),u=this._tangents[0],o=this._normalVector(this._curve[0],u,n),this._normals[0]=o,this._raw||this._normals[0].normalize(),this._binormals[0]=t.Cross(u,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0,i=1;i<r;i++)f=this._getLastNonNullVector(i),i<r-1&&(s=this._getFirstNonNullVector(i),this._tangents[i]=f.add(s),this._tangents[i].normalize()),this._distances[i]=this._distances[i-1]+f.length(),e=this._tangents[i],h=this._binormals[i-1],this._normals[i]=t.Cross(h,e),this._raw||this._normals[i].normalize(),this._binormals[i]=t.Cross(e,this._normals[i]),this._raw||this._binormals[i].normalize()},r.prototype._getFirstNonNullVector=function(n){for(var t=1,i=this._curve[n+t].subtract(this._curve[n]);0===i.length()&&n+t+1<this._curve.length;)t++,i=this._curve[n+t].subtract(this._curve[n]);return i},r.prototype._getLastNonNullVector=function(n){for(var t=1,i=this._curve[n].subtract(this._curve[n-t]);0===i.length()&&n>t+1;)t++,i=this._curve[n].subtract(this._curve[n-t]);return i},r.prototype._normalVector=function(r,u,f){var e,o=u.length(),s;return(0===o&&(o=1),void 0===f||null===f)?(i.WithinEpsilon(Math.abs(u.y)/o,1,n.Epsilon)?i.WithinEpsilon(Math.abs(u.x)/o,1,n.Epsilon)?i.WithinEpsilon(Math.abs(u.z)/o,1,n.Epsilon)||(s=new t(0,0,1)):s=new t(1,0,0):s=new t(0,-1,0),e=t.Cross(u,s)):(e=t.Cross(u,f),t.CrossToRef(e,u,e)),e.normalize(),e},r}();n.Path3D=g;nt=function(){function n(n){this._length=0;this._points=n;this._length=this._computeLength(n)}return n.CreateQuadraticBezier=function(i,r,u,f){f=f>2?f:3;for(var s=[],o=function(n,t,i,r){return(1-n)*(1-n)*t+2*n*(1-n)*i+n*n*r},e=0;e<=f;e++)s.push(new t(o(e/f,i.x,r.x,u.x),o(e/f,i.y,r.y,u.y),o(e/f,i.z,r.z,u.z)));return new n(s)},n.CreateCubicBezier=function(i,r,u,f,e){e=e>3?e:4;for(var h=[],s=function(n,t,i,r,u){return(1-n)*(1-n)*(1-n)*t+3*n*(1-n)*(1-n)*i+3*n*n*(1-n)*r+n*n*n*u},o=0;o<=e;o++)h.push(new t(s(o/e,i.x,r.x,u.x,f.x),s(o/e,i.y,r.y,u.y,f.y),s(o/e,i.z,r.z,u.z,f.z)));return new n(h)},n.CreateHermiteSpline=function(i,r,u,f,e){for(var s=[],h=1/e,o=0;o<=e;o++)s.push(t.Hermite(i,r,u,f,o*h));return new n(s)},n.prototype.getPoints=function(){return this._points},n.prototype.length=function(){return this._length},n.prototype["continue"]=function(t){for(var f=this._points[this._points.length-1],u=this._points.slice(),i=t.getPoints(),r=1;r<i.length;r++)u.push(i[r].subtract(i[0]).add(f));return new n(u)},n.prototype._computeLength=function(n){for(var i=0,t=1;t<n.length;t++)i+=n[t].subtract(n[t-1]).length();return i},n}();n.Curve3=nt;tt=function(){function n(){this.L00=t.Zero();this.L1_1=t.Zero();this.L10=t.Zero();this.L11=t.Zero();this.L2_2=t.Zero();this.L2_1=t.Zero();this.L20=t.Zero();this.L21=t.Zero();this.L22=t.Zero()}return n.prototype.addLight=function(n,i,r){var f=new t(i.r,i.g,i.b),u=f.scale(r);this.L00=this.L00.add(u.scale(.282095));this.L1_1=this.L1_1.add(u.scale(.488603*n.y));this.L10=this.L10.add(u.scale(.488603*n.z));this.L11=this.L11.add(u.scale(.488603*n.x));this.L2_2=this.L2_2.add(u.scale(1.092548*n.x*n.y));this.L2_1=this.L2_1.add(u.scale(1.092548*n.y*n.z));this.L21=this.L21.add(u.scale(1.092548*n.x*n.z));this.L20=this.L20.add(u.scale(.315392*(3*n.z*n.z-1)));this.L22=this.L22.add(u.scale(.546274*(n.x*n.x-n.y*n.y)))},n.prototype.scale=function(n){this.L00=this.L00.scale(n);this.L1_1=this.L1_1.scale(n);this.L10=this.L10.scale(n);this.L11=this.L11.scale(n);this.L2_2=this.L2_2.scale(n);this.L2_1=this.L2_1.scale(n);this.L20=this.L20.scale(n);this.L21=this.L21.scale(n);this.L22=this.L22.scale(n)},n}();n.SphericalHarmonics=tt;it=function(){function n(){this.x=t.Zero();this.y=t.Zero();this.z=t.Zero();this.xx=t.Zero();this.yy=t.Zero();this.zz=t.Zero();this.xy=t.Zero();this.yz=t.Zero();this.zx=t.Zero()}return n.prototype.addAmbient=function(n){var i=new t(n.r,n.g,n.b);this.xx=this.xx.add(i);this.yy=this.yy.add(i);this.zz=this.zz.add(i)},n.getSphericalPolynomialFromHarmonics=function(t){var i=new n;return i.x=t.L11.scale(1.02333),i.y=t.L1_1.scale(1.02333),i.z=t.L10.scale(1.02333),i.xx=t.L00.scale(.886277).subtract(t.L20.scale(.247708)).add(t.L22.scale(.429043)),i.yy=t.L00.scale(.886277).subtract(t.L20.scale(.247708)).subtract(t.L22.scale(.429043)),i.zz=t.L00.scale(.886277).add(t.L20.scale(.495417)),i.yz=t.L2_1.scale(.858086),i.zx=t.L21.scale(.858086),i.xy=t.L2_2.scale(.858086),i},n}();n.SphericalPolynomial=it;rt=function(){function n(n,i){void 0===n&&(n=t.Zero());void 0===i&&(i=t.Up());this.position=n;this.normal=i}return n.prototype.clone=function(){return new n(this.position.clone(),this.normal.clone())},n}();n.PositionNormalVertex=rt;ut=function(){function n(n,i,r){void 0===n&&(n=t.Zero());void 0===i&&(i=t.Up());void 0===r&&(r=u.Zero());this.position=n;this.normal=i;this.uv=r}return n.prototype.clone=function(){return new n(this.position.clone(),this.normal.clone(),this.uv.clone())},n}();n.PositionNormalTextureVertex=ut;f=function(){function n(){}return n.Color3=[h.Black(),h.Black(),h.Black()],n.Vector2=[u.Zero(),u.Zero(),u.Zero()],n.Vector3=[t.Zero(),t.Zero(),t.Zero(),t.Zero(),t.Zero(),t.Zero(),t.Zero(),t.Zero(),t.Zero()],n.Vector4=[o.Zero(),o.Zero(),o.Zero()],n.Quaternion=[new e(0,0,0,0)],n.Matrix=[r.Zero(),r.Zero(),r.Zero(),r.Zero(),r.Zero(),r.Zero(),r.Zero(),r.Zero()],n}();n.Tmp=f}(i||(i={}));!function(n){function t(n,t){return function(i,r){i.__serializableMembers||(i.__serializableMembers={});i.__serializableMembers[r]||(i.__serializableMembers[r]={type:n,sourceName:t})}}function i(n){return t(0,n)}function r(n){return t(1,n)}function u(n){return t(2,n)}function f(n){return t(3,n)}function e(n){return t(4,n)}function o(n){return t(5,n)}function s(n){return t(6,n)}function h(n){return t(7,n)}n.serialize=i;n.serializeAsTexture=r;n.serializeAsColor3=u;n.serializeAsFresnelParameters=f;n.serializeAsVector2=e;n.serializeAsVector3=o;n.serializeAsMeshReference=s;n.serializeAsColorCurves=h;var c=function(){function t(){}return t.Serialize=function(t,i){var f;i||(i={});i.tags=n.Tags.GetTags(t);for(f in t.__serializableMembers){var e=t.__serializableMembers[f],u=e.sourceName||f,o=e.type,r=t[f];if(void 0!==r&&null!==r)switch(o){case 0:i[u]=r;break;case 1:i[u]=r.serialize();break;case 2:i[u]=r.asArray();break;case 3:i[u]=r.serialize();break;case 4:i[u]=r.asArray();break;case 5:i[u]=r.asArray();break;case 6:i[u]=r.id;break;case 7:i[u]=r.serialize()}}return i},t.Parse=function(t,i,r,u){var f=t(),e;n.Tags.AddTagsTo(f,i.tags);for(e in f.__serializableMembers){var s=f.__serializableMembers[e],o=i[s.sourceName||e],h=s.type;if(void 0!==o&&null!==o)switch(h){case 0:f[e]=o;break;case 1:f[e]=n.Texture.Parse(o,r,u);break;case 2:f[e]=n.Color3.FromArray(o);break;case 3:f[e]=n.FresnelParameters.Parse(o);break;case 4:f[e]=n.Vector2.FromArray(o);break;case 5:f[e]=n.Vector3.FromArray(o);break;case 6:f[e]=r.getLastMeshByID(o);break;case 7:f[e]=n.ColorCurves.Parse(o)}}return f},t.Clone=function(t,i){var r=t(),u;n.Tags.AddTagsTo(r,i.tags);for(u in r.__serializableMembers){var e=r.__serializableMembers[u],f=i[u],o=e.type;if(void 0!==f&&null!==f)switch(o){case 0:case 6:r[u]=f;break;case 1:case 2:case 3:case 4:case 5:case 7:r[u]=f.clone()}}return r},t}();n.SerializationHelper=c}(i||(i={}));!function(n){var i=function(){function n(n,t){void 0===t&&(t=!1);this.initalize(n,t)}return n.prototype.initalize=function(n,t){return void 0===t&&(t=!1),this.mask=n,this.skipNextObservers=t,this},n}(),t,r;n.EventState=i;t=function(){function n(n,t){this.callback=n;this.mask=t}return n}();n.Observer=t;r=function(){function n(){this._observers=[];this._eventState=new i(0)}return n.prototype.add=function(n,i,r){if(void 0===i&&(i=-1),void 0===r&&(r=!1),!n)return null;var u=new t(n,i);return r?this._observers.unshift(u):this._observers.push(u),u},n.prototype.remove=function(n){var t=this._observers.indexOf(n);return t!==-1&&(this._observers.splice(t,1),!0)},n.prototype.removeCallback=function(n){for(var t=0;t<this._observers.length;t++)if(this._observers[t].callback===n)return this._observers.splice(t,1),!0;return!1},n.prototype.notifyObservers=function(n,t){var i,r,u,f;for(void 0===t&&(t=-1),i=this._eventState,i.mask=t,i.skipNextObservers=!1,r=0,u=this._observers;r<u.length;r++)if(f=u[r],f.mask&t&&f.callback(n,i),i.skipNextObservers)return!1;return!0},n.prototype.hasObservers=function(){return this._observers.length>0},n.prototype.clear=function(){this._observers=[]},n.prototype.clone=function(){var t=new n;return t._observers=this._observers.slice(0),t},n}();n.Observable=r}(i||(i={}));!function(n){var t=function(){function t(n,i){this.idbFactory=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;this.callbackManifestChecked=i;this.currentSceneUrl=t.ReturnFullUrlLocation(n);this.db=null;this.enableSceneOffline=!1;this.enableTexturesOffline=!1;this.manifestVersionFound=0;this.mustUpdateRessources=!1;this.hasReachedQuota=!1;t.IDBStorageEnabled?this.checkManifestFile():this.callbackManifestChecked(!0)}return t.prototype.checkManifestFile=function(){function f(){r.enableSceneOffline=!1;r.enableTexturesOffline=!1;r.callbackManifestChecked(!1)}var i=this,r=this,e=!1,u=this.currentSceneUrl+".manifest",t=new XMLHttpRequest;navigator.onLine&&(e=!0,u=u+(null==u.match(/\?/)?"?":"&")+(new Date).getTime());t.open("GET",u,!0);t.addEventListener("load",function(){if(200===t.status||n.Tools.ValidateXHRData(t,1))try{var r=JSON.parse(t.response);i.enableSceneOffline=r.enableSceneOffline;i.enableTexturesOffline=r.enableTexturesOffline;r.version&&!isNaN(parseInt(r.version))&&(i.manifestVersionFound=r.version);i.callbackManifestChecked&&i.callbackManifestChecked(!0)}catch(u){f()}else f()},!1);t.addEventListener("error",function(){if(e){e=!1;var n=i.currentSceneUrl+".manifest";t.open("GET",n,!0);t.send()}else f()},!1);try{t.send()}catch(o){n.Tools.Error("Error on XHR send request.");r.callbackManifestChecked(!1)}},t.prototype.openAsync=function(t,i){function f(){e.isSupported=!1;i&&i()}var u=this,e=this,r;this.idbFactory&&(this.enableSceneOffline||this.enableTexturesOffline)?this.db?t&&t():(this.hasReachedQuota=!1,this.isSupported=!0,r=this.idbFactory.open("babylonjs",1),r.onerror=function(){f()},r.onblocked=function(){n.Tools.Error("IDB request blocked. Please reload the page.");f()},r.onsuccess=function(){u.db=r.result;t()},r.onupgradeneeded=function(t){u.db=t.target.result;try{u.db.createObjectStore("scenes",{keyPath:"sceneUrl"});u.db.createObjectStore("versions",{keyPath:"sceneUrl"});u.db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(i){n.Tools.Error("Error while creating object stores. Exception: "+i.message);f()}}):(this.isSupported=!1,i&&i())},t.prototype.loadImageFromDB=function(n,i){var r=this,u=t.ReturnFullUrlLocation(n),f=function(){r.hasReachedQuota||null===r.db?i.src=n:r._saveImageIntoDBAsync(u,i)};this.mustUpdateRessources?f():this._loadImageFromDBAsync(u,i,f)},t.prototype._loadImageFromDBAsync=function(t,i,r){var f,u,e;this.isSupported&&null!==this.db?(u=this.db.transaction(["textures"]),u.onabort=function(){i.src=t},u.oncomplete=function(){var u,e;f?(e=window.URL||window.webkitURL,u=e.createObjectURL(f.data,{oneTimeOnly:!0}),i.onerror=function(){n.Tools.Error("Error loading image from blob URL: "+u+" switching back to web url: "+t);i.src=t},i.src=u):r()},e=u.objectStore("textures").get(t),e.onsuccess=function(n){f=n.target.result},e.onerror=function(){n.Tools.Error("Error loading texture "+t+" from DB.");i.src=t}):(n.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i.src=t)},t.prototype._saveImageIntoDBAsync=function(i,r){var o=this,e,f,u;this.isSupported?(e=function(){var n,t;if(f){t=window.URL||window.webkitURL;try{n=t.createObjectURL(f,{oneTimeOnly:!0})}catch(i){n=t.createObjectURL(f)}}r.src=n},t.IsUASupportingBlobStorage?(u=new XMLHttpRequest,u.open("GET",i,!0),u.responseType="blob",u.addEventListener("load",function(){var n,h,s;if(200===u.status){f=u.response;n=o.db.transaction(["textures"],"readwrite");n.onabort=function(n){try{n.srcElement.error&&"QuotaExceededError"===n.srcElement.error.name&&(o.hasReachedQuota=!0)}catch(t){}e()};n.oncomplete=function(){e()};h={textureUrl:i,data:f};try{s=n.objectStore("textures").put(h);s.onsuccess=function(){};s.onerror=function(){e()}}catch(c){25===c.code&&(t.IsUASupportingBlobStorage=!1);r.src=i}}else r.src=i},!1),u.addEventListener("error",function(){n.Tools.Error("Error in XHR request in BABYLON.Database.");r.src=i},!1),u.send()):r.src=i):(n.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),r.src=i)},t.prototype._checkVersionFromDB=function(n,t){var i=this,r=function(){i._saveVersionIntoDBAsync(n,t)};this._loadVersionFromDBAsync(n,t,r)},t.prototype._loadVersionFromDBAsync=function(t,i,r){var e=this,u,f,o;if(this.isSupported)try{f=this.db.transaction(["versions"]);f.oncomplete=function(){u?e.manifestVersionFound>u.data?(e.mustUpdateRessources=!0,r()):i(u.data):(e.mustUpdateRessources=!0,r())};f.onabort=function(){i(-1)};o=f.objectStore("versions").get(t);o.onsuccess=function(n){u=n.target.result};o.onerror=function(){n.Tools.Error("Error loading version for scene "+t+" from DB.");i(-1)}}catch(s){n.Tools.Error("Error while accessing 'versions' object store (READ OP). Exception: "+s.message);i(-1)}else n.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i(-1)},t.prototype._saveVersionIntoDBAsync=function(t,i){var f=this,r,e,u;if(this.isSupported&&!this.hasReachedQuota)try{r=this.db.transaction(["versions"],"readwrite");r.onabort=function(n){try{n.srcElement.error&&"QuotaExceededError"===n.srcElement.error.name&&(f.hasReachedQuota=!0)}catch(t){}i(-1)};r.oncomplete=function(){i(f.manifestVersionFound)};e={sceneUrl:t,data:this.manifestVersionFound};u=r.objectStore("versions").put(e);u.onsuccess=function(){};u.onerror=function(){n.Tools.Error("Error in DB add version request in BABYLON.Database.")}}catch(o){n.Tools.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+o.message);i(-1)}else i(-1)},t.prototype.loadFileFromDB=function(n,i,r,u,f){var e=this,o=t.ReturnFullUrlLocation(n),s=function(){e._saveFileIntoDBAsync(o,i,r)};this._checkVersionFromDB(o,function(n){n!==-1?e.mustUpdateRessources?e._saveFileIntoDBAsync(o,i,r,f):e._loadFileFromDBAsync(o,i,s,f):u()})},t.prototype._loadFileFromDBAsync=function(t,i,r){var f,e,u,o;this.isSupported?(f=t.indexOf(".babylon")!==-1?"scenes":"textures",u=this.db.transaction([f]),u.oncomplete=function(){e?i(e.data):r()},u.onabort=function(){r()},o=u.objectStore(f).get(t),o.onsuccess=function(n){e=n.target.result},o.onerror=function(){n.Tools.Error("Error loading file "+t+" from DB.");r()}):(n.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i())},t.prototype._saveFileIntoDBAsync=function(t,i,r,u){var o=this,s,e,f;this.isSupported?(s=t.indexOf(".babylon")!==-1?"scenes":"textures",f=new XMLHttpRequest,f.open("GET",t,!0),u&&(f.responseType="arraybuffer"),f.onprogress=r,f.addEventListener("load",function(){var r,c,h;if(200===f.status||n.Tools.ValidateXHRData(f,u?6:1))if(e=u?f.response:f.responseText,o.hasReachedQuota)i(e);else{r=o.db.transaction([s],"readwrite");r.onabort=function(n){try{n.srcElement.error&&"QuotaExceededError"===n.srcElement.error.name&&(o.hasReachedQuota=!0)}catch(t){}i(e)};r.oncomplete=function(){i(e)};c="scenes"===s?{sceneUrl:t,data:e,version:o.manifestVersionFound}:{textureUrl:t,data:e};try{h=r.objectStore(s).put(c);h.onsuccess=function(){};h.onerror=function(){n.Tools.Error("Error in DB add file request in BABYLON.Database.")}}catch(l){i(e)}}else i()},!1),f.addEventListener("error",function(){n.Tools.Error("error on XHR request.");i()},!1),f.send()):(n.Tools.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i())},t.IsUASupportingBlobStorage=!0,t.IDBStorageEnabled=!0,t.parseURL=function(n){var t=document.createElement("a");t.href=n;var i=n.substring(0,n.lastIndexOf("#")),r=n.substring(i.lastIndexOf("/")+1,n.length);return n.substring(0,n.indexOf(r,0))},t.ReturnFullUrlLocation=function(n){return n.indexOf("http:/")===-1?t.parseURL(window.location.href)+n:n},t}();n.Database=t}(i||(i={}));!function(n){var t;!function(t){var i=function(){function t(){}return t.GetTGAHeader=function(n){var t=0;return{id_length:n[t++],colormap_type:n[t++],image_type:n[t++],colormap_index:n[t++]|n[t++]<<8,colormap_length:n[t++]|n[t++]<<8,colormap_size:n[t++],origin:[n[t++]|n[t++]<<8,n[t++]|n[t++]<<8],width:n[t++]|n[t++]<<8,height:n[t++]|n[t++]<<8,pixel_size:n[t++],flags:n[t++]}},t.UploadContent=function(i,r){var e,u,c,it,o,l,g,s,f,h,nt,a,v,y,p,w,b,rt,ut;if(r.length<19)return void n.Tools.Error("Unable to load TGA file - Not enough data to contain header");if(e=18,u=t.GetTGAHeader(r),u.id_length+e>r.length)return void n.Tools.Error("Unable to load TGA file - Not enough data");e+=u.id_length;var k=!1,d=!1,ft=!1,tt=!1;switch(u.image_type){case t._TYPE_RLE_INDEXED:k=!0;case t._TYPE_INDEXED:d=!0;break;case t._TYPE_RLE_RGB:k=!0;case t._TYPE_RGB:ft=!0;break;case t._TYPE_RLE_GREY:k=!0;case t._TYPE_GREY:tt=!0}if(o=(15&u.flags,u.pixel_size>>3),l=u.width*u.height*o,d&&(it=r.subarray(e,e+=u.colormap_length*(u.colormap_size>>3))),k)for(c=new Uint8Array(l),h=0,nt=new Uint8Array(o);e<l&&h<l;)if(g=r[e++],s=(127&g)+1,128&g){for(f=0;f<o;++f)nt[f]=r[e++];for(f=0;f<s;++f)c.set(nt,h+f*o);h+=o*s}else{for(s*=o,f=0;f<s;++f)c[h+f]=r[e++];h+=s}else c=r.subarray(e,e+=d?u.width*u.height:l);switch((u.flags&t._ORIGIN_MASK)>>t._ORIGIN_SHIFT){default:case t._ORIGIN_UL:a=0;y=1;b=u.width;v=0;p=1;w=u.height;break;case t._ORIGIN_BL:a=0;y=1;b=u.width;v=u.height-1;p=-1;w=-1;break;case t._ORIGIN_UR:a=u.width-1;y=-1;b=-1;v=0;p=1;w=u.height;break;case t._ORIGIN_BR:a=u.width-1;y=-1;b=-1;v=u.height-1;p=-1;w=-1}rt="_getImageData"+(tt?"Grey":"")+u.pixel_size+"bits";ut=t[rt](u,it,c,v,p,w,a,y,b);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,u.width,u.height,0,i.RGBA,i.UNSIGNED_BYTE,ut)},t._getImageData8bits=function(n,t,i,r,u,f,e,o,s){for(var v,h,w=i,y=t,l=n.width,b=n.height,p=0,a=new Uint8Array(l*b*4),c=r;c!==f;c+=u)for(h=e;h!==s;h+=o,p++)v=w[p],a[4*(h+l*c)+3]=255,a[4*(h+l*c)+2]=y[3*v+0],a[4*(h+l*c)+1]=y[3*v+1],a[4*(h+l*c)+0]=y[3*v+2];return a},t._getImageData16bits=function(n,t,i,r,u,f,e,o,s){for(var l,h,p=i,a=n.width,w=n.height,y=0,v=new Uint8Array(a*w*4),c=r;c!==f;c+=u)for(h=e;h!==s;h+=o,y+=2)l=p[y+0]+(p[y+1]<<8),v[4*(h+a*c)+0]=(31744&l)>>7,v[4*(h+a*c)+1]=(992&l)>>2,v[4*(h+a*c)+2]=(31&l)>>3,v[4*(h+a*c)+3]=32768&l?0:255;return v},t._getImageData24bits=function(n,t,i,r,u,f,e,o,s){for(var h,y=i,l=n.width,p=n.height,v=0,a=new Uint8Array(l*p*4),c=r;c!==f;c+=u)for(h=e;h!==s;h+=o,v+=3)a[4*(h+l*c)+3]=255,a[4*(h+l*c)+2]=y[v+0],a[4*(h+l*c)+1]=y[v+1],a[4*(h+l*c)+0]=y[v+2];return a},t._getImageData32bits=function(n,t,i,r,u,f,e,o,s){for(var h,y=i,l=n.width,p=n.height,a=0,v=new Uint8Array(l*p*4),c=r;c!==f;c+=u)for(h=e;h!==s;h+=o,a+=4)v[4*(h+l*c)+2]=y[a+0],v[4*(h+l*c)+1]=y[a+1],v[4*(h+l*c)+0]=y[a+2],v[4*(h+l*c)+3]=y[a+3];return v},t._getImageDataGrey8bits=function(n,t,i,r,u,f,e,o,s){for(var v,h,p=i,l=n.width,w=n.height,y=0,a=new Uint8Array(l*w*4),c=r;c!==f;c+=u)for(h=e;h!==s;h+=o,y++)v=p[y],a[4*(h+l*c)+0]=v,a[4*(h+l*c)+1]=v,a[4*(h+l*c)+2]=v,a[4*(h+l*c)+3]=255;return a},t._getImageDataGrey16bits=function(n,t,i,r,u,f,e,o,s){for(var h,y=i,l=n.width,p=n.height,a=0,v=new Uint8Array(l*p*4),c=r;c!==f;c+=u)for(h=e;h!==s;h+=o,a+=2)v[4*(h+l*c)+0]=y[a+0],v[4*(h+l*c)+1]=y[a+0],v[4*(h+l*c)+2]=y[a+0],v[4*(h+l*c)+3]=y[a+1];return v},t._TYPE_NO_DATA=0,t._TYPE_INDEXED=1,t._TYPE_RGB=2,t._TYPE_GREY=3,t._TYPE_RLE_INDEXED=9,t._TYPE_RLE_RGB=10,t._TYPE_RLE_GREY=11,t._ORIGIN_MASK=48,t._ORIGIN_SHIFT=4,t._ORIGIN_BL=0,t._ORIGIN_BR=1,t._ORIGIN_UL=2,t._ORIGIN_UR=3,t}();t.TGATools=i}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t=function(){function n(t){this.length=0;this._duplicateId=0;this.data=new Array(t);this._id=n._GlobalId++}return n.prototype.push=function(n){this.data[this.length++]=n;this.length>this.data.length&&(this.data.length*=2);n.__smartArrayFlags||(n.__smartArrayFlags={});n.__smartArrayFlags[this._id]=this._duplicateId},n.prototype.pushNoDuplicate=function(n){return(!n.__smartArrayFlags||n.__smartArrayFlags[this._id]!==this._duplicateId)&&(this.push(n),!0)},n.prototype.sort=function(n){this.data.sort(n)},n.prototype.reset=function(){this.length=0;this._duplicateId++},n.prototype.concat=function(n){if(0!==n.length){this.length+n.length>this.data.length&&(this.data.length=2*(this.length+n.length));for(var t=0;t<n.length;t++)this.data[this.length++]=(n.data||n)[t]}},n.prototype.concatWithNoDuplicate=function(n){var t,i;if(0!==n.length)for(this.length+n.length>this.data.length&&(this.data.length=2*(this.length+n.length)),t=0;t<n.length;t++)i=(n.data||n)[t],this.pushNoDuplicate(i)},n.prototype.indexOf=function(n){var t=this.data.indexOf(n);return t>=this.length?-1:t},n._GlobalId=0,n}();n.SmartArray=t}(i||(i={}));!function(n){var t=function(){function n(){this._count=0;this._data={}}return n.prototype.copyFrom=function(n){var t=this;this.clear();n.forEach(function(n,i){return t.add(n,i)})},n.prototype.get=function(n){var t=this._data[n];if(void 0!==t)return t},n.prototype.getOrAddWithFactory=function(n,t){var i=this.get(n);return void 0!==i?i:(i=t(n),i&&this.add(n,i),i)},n.prototype.getOrAdd=function(n,t){var i=this.get(n);return void 0!==i?i:(this.add(n,t),t)},n.prototype.contains=function(n){return void 0!==this._data[n]},n.prototype.add=function(n,t){return void 0===this._data[n]&&(this._data[n]=t,++this._count,!0)},n.prototype.set=function(n,t){return void 0!==this._data[n]&&(this._data[n]=t,!0)},n.prototype.getAndRemove=function(n){var t=this.get(n);return void 0!==t?(delete this._data[n],--this._count,t):null},n.prototype.remove=function(n){return!!this.contains(n)&&(delete this._data[n],--this._count,!0)},n.prototype.clear=function(){this._data={};this._count=0},Object.defineProperty(n.prototype,"count",{get:function(){return this._count},enumerable:!0,configurable:!0}),n.prototype.forEach=function(n){var t,i;for(t in this._data)i=this._data[t],n(t,i)},n.prototype.first=function(n){var t,r,i;for(t in this._data)if(r=this._data[t],i=n(t,r),i)return i;return null},n}();n.StringDictionary=t}(i||(i={}));!function(n){function e(n,t){return function(i){i.__bjsclassName__=n;i.__bjsmoduleName__=null!=t?t:null}}var t,r=function(t,i){return t?t instanceof n.Mesh?null:t instanceof n.SubMesh?t.clone(i):t.clone?t.clone():null:null},i=function(){function i(){}return i.Instantiate=function(n){for(var r=n.split("."),t=window||this,i=0,u=r.length;i<u;i++)t=t[r[i]];return"function"!=typeof t?null:t},i.SetImmediate=function(n){window.setImmediate?window.setImmediate(n):setTimeout(n,1)},i.IsExponentOfTwo=function(n){var t=1;do t*=2;while(t<n);return t===n},i.GetExponentOfTwo=function(n,t){var i=1;do i*=2;while(i<n);return i>t&&(i=t),i},i.GetFilename=function(n){var t=n.lastIndexOf("/");return t<0?n:n.substring(t+1)},i.GetDOMTextContent=function(n){for(var i="",t=n.firstChild;t;)3===t.nodeType&&(i+=t.textContent),t=t.nextSibling;return i},i.ToDegrees=function(n){return 180*n/Math.PI},i.ToRadians=function(n){return n*Math.PI/180},i.EncodeArrayBufferTobase64=function(n){for(var o,r,u,h,c,s,f,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",t=0,i=new Uint8Array(n);t<i.length;)o=i[t++],r=t<i.length?i[t++]:Number.NaN,u=t<i.length?i[t++]:Number.NaN,h=o>>2,c=(3&o)<<4|r>>4,s=(15&r)<<2|u>>6,f=63&u,isNaN(r)?s=f=64:isNaN(u)&&(f=64),l+=e.charAt(h)+e.charAt(c)+e.charAt(s)+e.charAt(f);return"data:image/png;base64,"+l},i.ExtractMinAndMaxIndexed=function(t,i,r,u,f){var h;void 0===f&&(f=null);for(var e=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new n.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),s=r;s<r+u;s++)h=new n.Vector3(t[3*i[s]],t[3*i[s]+1],t[3*i[s]+2]),e=n.Vector3.Minimize(h,e),o=n.Vector3.Maximize(h,o);return f&&(e.x-=e.x*f.x+f.y,e.y-=e.y*f.x+f.y,e.z-=e.z*f.x+f.y,o.x+=o.x*f.x+f.y,o.y+=o.y*f.x+f.y,o.z+=o.z*f.x+f.y),{minimum:e,maximum:o}},i.ExtractMinAndMax=function(t,i,r,u,f){var e,o,s,h;for(void 0===u&&(u=null),e=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new n.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),f||(f=3),s=i;s<i+r;s++)h=new n.Vector3(t[s*f],t[s*f+1],t[s*f+2]),e=n.Vector3.Minimize(h,e),o=n.Vector3.Maximize(h,o);return u&&(e.x-=e.x*u.x+u.y,e.y-=e.y*u.x+u.y,e.z-=e.z*u.x+u.y,o.x+=o.x*u.x+u.y,o.y+=o.y*u.x+u.y,o.z+=o.z*u.x+u.y),{minimum:e,maximum:o}},i.Vector2ArrayFeeder=function(t){return function(i){var u=void 0!==t.BYTES_PER_ELEMENT,e=u?t.length/2:t.length,r,f;return i>=e?null:u?(r=t,new n.Vector2(r[2*i+0],r[2*i+1])):(f=t,f[i])}},i.ExtractMinAndMaxVector2=function(t,i){void 0===i&&(i=null);for(var r=new n.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),u=new n.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),e=0,f=t(e++);f;)r=n.Vector2.Minimize(f,r),u=n.Vector2.Maximize(f,u),f=t(e++);return i&&(r.x-=r.x*i.x+i.y,r.y-=r.y*i.x+i.y,u.x+=u.x*i.x+i.y,u.y+=u.y*i.x+i.y),{minimum:r,maximum:u}},i.MakeArray=function(n,t){if(t===!0||void 0!==n&&null!=n)return Array.isArray(n)?n:[n]},i.GetPointerPrefix=function(){var n="pointer";return window.PointerEvent||navigator.pointerEnabled||(n="mouse"),n},i.QueueNewFrame=function(n,t){void 0===t&&(t=window);t.requestAnimationFrame?t.requestAnimationFrame(n):t.msRequestAnimationFrame?t.msRequestAnimationFrame(n):t.webkitRequestAnimationFrame?t.webkitRequestAnimationFrame(n):t.mozRequestAnimationFrame?t.mozRequestAnimationFrame(n):t.oRequestAnimationFrame?t.oRequestAnimationFrame(n):window.setTimeout(n,16)},i.RequestFullscreen=function(n){var t=n.requestFullscreen||n.msRequestFullscreen||n.webkitRequestFullscreen||n.mozRequestFullScreen;t&&t.call(n)},i.ExitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()},i.SetCorsBehavior=function(n,t){if(i.CorsBehavior)switch(typeof i.CorsBehavior){case"function":var r=i.CorsBehavior(n);if(r)return r;break;case"string":default:t.crossOrigin=i.CorsBehavior}},i.CleanUrl=function(n){return n.replace(/#/gm,"%23")},i.LoadImage=function(t,r,u,f){var e,o,c,s,h;if(t instanceof ArrayBuffer&&(t=i.EncodeArrayBufferTobase64(t)),t=i.CleanUrl(t),e=new Image,"data:"!==t.substr(0,5)&&i.SetCorsBehavior(t,e),e.onload=function(){r(e)},e.onerror=function(){i.Error("Error while trying to load texture: "+t);i.UseFallbackTexture?(e.src="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z",r(e)):u()},o=function(){e.src=t},c=function(){f.loadImageFromDB(t,e)},"data:"!==t.substr(0,5)&&f&&f.enableTexturesOffline&&n.Database.IsUASupportingBlobStorage)f.openAsync(c,o);else if(t.indexOf("file:")===-1)o();else try{h=t.substring(5).toLowerCase();try{s=URL.createObjectURL(n.FilesInput.FilesTextures[h],{oneTimeOnly:!0})}catch(l){s=URL.createObjectURL(n.FilesInput.FilesTextures[h])}e.src=s}catch(a){e.src=null}return e},i.LoadFile=function(t,r,u,f,e,o){var s,h,c;t=i.CleanUrl(t);s=function(){var n=new XMLHttpRequest,f=i.BaseUrl+t;n.open("GET",f,!0);e&&(n.responseType="arraybuffer");n.onprogress=u;n.onreadystatechange=function(){if(4===n.readyState)if(n.onreadystatechange=null,n.status>=200&&n.status<300||navigator.isCocoonJS&&0===n.status)r(e?n.response:n.responseText);else{if(!o)throw new Error("Error status: "+n.status+" - Unable to load "+f);o()}};n.send(null)};h=function(){f.loadFileFromDB(t,r,u,s,e)};t.indexOf("file:")!==-1?(c=t.substring(5).toLowerCase(),i.ReadFile(n.FilesInput.FilesToLoad[c],r,u,e)):f&&f.enableSceneOffline?f.openAsync(h,s):s()},i.ReadFileAsDataURL=function(n,t,i){var r=new FileReader;r.onload=function(n){t(n.target.result)};r.onprogress=i;r.readAsDataURL(n)},i.ReadFile=function(n,t,r,u){var f=new FileReader;f.onerror=function(){i.Log("Error while reading file: "+n.name);t(JSON.stringify({autoClear:!0,clearColor:[1,0,0],ambientColor:[0,0,0],gravity:[0,-9.807,0],meshes:[],cameras:[],lights:[]}))};f.onload=function(n){t(n.target.result)};f.onprogress=r;u?f.readAsArrayBuffer(n):f.readAsText(n)},i.FileAsURL=function(n){var t=new Blob([n]),i=window.URL||window.webkitURL;return i.createObjectURL(t)},i.Format=function(n,t){return void 0===t&&(t=2),n.toFixed(t)},i.CheckExtends=function(n,t,i){n.x<t.x&&(t.x=n.x);n.y<t.y&&(t.y=n.y);n.z<t.z&&(t.z=n.z);n.x>i.x&&(i.x=n.x);n.y>i.y&&(i.y=n.y);n.z>i.z&&(i.z=n.z)},i.DeepCopy=function(n,t,i,u){var f,e,s,o,h;for(f in n)if(("_"!==f[0]||u&&u.indexOf(f)!==-1)&&(!i||i.indexOf(f)===-1)&&(e=n[f],s=typeof e,"function"!==s))if("object"===s)if(e instanceof Array){if(t[f]=[],e.length>0)if("object"==typeof e[0])for(o=0;o<e.length;o++)h=r(e[o],t),t[f].indexOf(h)===-1&&t[f].push(h);else t[f]=e.slice(0)}else t[f]=r(e,t);else t[f]=e},i.IsEmpty=function(n){for(var t in n)return!1;return!0},i.RegisterTopRootEvents=function(n){for(var t,i=0;i<n.length;i++){t=n[i];window.addEventListener(t.name,t.handler,!1);try{window.parent&&window.parent.addEventListener(t.name,t.handler,!1)}catch(r){}}},i.UnregisterTopRootEvents=function(n){for(var t,i=0;i<n.length;i++){t=n[i];window.removeEventListener(t.name,t.handler);try{window.parent&&window.parent.removeEventListener(t.name,t.handler)}catch(r){}}},i.DumpFramebuffer=function(n,r,u,f,e){var s;void 0===e&&(e="image/png");for(var c=4*n,p=r/2,o=u.readPixels(0,0,n,r),h=0;h<p;h++)for(s=0;s<c;s++){var l=s+h*c,w=r-h-1,a=s+w*c,b=o[l];o[l]=o[a];o[a]=b}t||(t=document.createElement("canvas"));t.width=n;t.height=r;var v=t.getContext("2d"),y=v.createImageData(n,r),k=y.data;k.set(o);v.putImageData(y,0,0);i.EncodeScreenshotCanvasData(f,e)},i.EncodeScreenshotCanvasData=function(n,i){var f,r,u,s,e,o;void 0===i&&(i="image/png");f=t.toDataURL(i);n?n(f):"download"in document.createElement("a")?(r=window.document.createElement("a"),r.href=f,u=new Date,s=(u.getFullYear()+"-"+(u.getMonth()+1)).slice(-2)+"-"+u.getDate()+"_"+u.getHours()+"-"+("0"+u.getMinutes()).slice(-2),r.setAttribute("download","screenshot_"+s+".png"),window.document.body.appendChild(r),r.addEventListener("click",function(){r.parentElement.removeChild(r)}),r.click()):(e=window.open(""),o=e.document.createElement("img"),o.src=f,e.document.body.appendChild(o))},i.CreateScreenshot=function(n,r,u,f,e){var o,s,h;if(void 0===e&&(e="image/png"),u.precision)o=Math.round(n.getRenderWidth()*u.precision),s=Math.round(o/n.getAspectRatio(r));else if(u.width&&u.height)o=u.width,s=u.height;else if(u.width&&!u.height)o=u.width,s=Math.round(o/n.getAspectRatio(r));else if(u.height&&!u.width)s=u.height,o=Math.round(s*n.getAspectRatio(r));else{if(isNaN(u))return void i.Error("Invalid 'size' parameter !");s=u;o=u}t||(t=document.createElement("canvas"));t.width=o;t.height=s;h=t.getContext("2d");h.drawImage(n.getRenderingCanvas(),0,0,o,s);i.EncodeScreenshotCanvasData(f,e)},i.CreateScreenshotUsingRenderTarget=function(t,r,u,f,e){var o,s,h,l,c;if(void 0===e&&(e="image/png"),u.precision)o=Math.round(t.getRenderWidth()*u.precision),s=Math.round(o/t.getAspectRatio(r)),u={width:o,height:s};else if(u.width&&u.height)o=u.width,s=u.height;else if(u.width&&!u.height)o=u.width,s=Math.round(o/t.getAspectRatio(r)),u={width:o,height:s};else if(u.height&&!u.width)s=u.height,o=Math.round(s*t.getAspectRatio(r)),u={width:o,height:s};else{if(isNaN(u))return void i.Error("Invalid 'size' parameter !");s=u;o=u}h=r.getScene();l=null;h.activeCamera!==r&&(l=h.activeCamera,h.activeCamera=r);c=new n.RenderTargetTexture("screenShot",u,h,!1,!1);c.renderList=h.meshes;c.onAfterRenderObservable.add(function(){i.DumpFramebuffer(o,s,t,f,e)});h.incrementRenderId();h.resetCachedMaterial();c.render(!0);c.dispose();l&&(h.activeCamera=l);r.getProjectionMatrix(!0)},i.ValidateXHRData=function(t,i){var r,u;void 0===i&&(i=7);try{if(1&i){if(t.responseText&&t.responseText.length>0)return!0;if(1===i)return!1}if(2&i){if(r=n.Internals.TGATools.GetTGAHeader(t.response),r.width&&r.height&&r.width>0&&r.height>0)return!0;if(2===i)return!1}if(4&i)return u=new Uint8Array(t.response,0,3),68===u[0]&&68===u[1]&&83===u[2]}catch(f){}return!1},i.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=16*Math.random()|0,i="x"===n?t:3&t|8;return i.toString(16)})},Object.defineProperty(i,"NoneLogLevel",{get:function(){return i._NoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(i,"MessageLogLevel",{get:function(){return i._MessageLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(i,"WarningLogLevel",{get:function(){return i._WarningLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ErrorLogLevel",{get:function(){return i._ErrorLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(i,"AllLogLevel",{get:function(){return i._MessageLogLevel|i._WarningLogLevel|i._ErrorLogLevel},enumerable:!0,configurable:!0}),i._AddLogEntry=function(n){i._LogCache=n+i._LogCache;i.OnNewCacheEntry&&i.OnNewCacheEntry(n)},i._FormatMessage=function(n){var t=function(n){return n<10?"0"+n:""+n},i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+n},i._LogDisabled=function(){},i._LogEnabled=function(n){var t=i._FormatMessage(n),r;console.log("BJS - "+t);r="<div style='color:white'>"+t+"<\/div><br>";i._AddLogEntry(r)},i._WarnDisabled=function(){},i._WarnEnabled=function(n){var t=i._FormatMessage(n),r;console.warn("BJS - "+t);r="<div style='color:orange'>"+t+"<\/div><br>";i._AddLogEntry(r)},i._ErrorDisabled=function(){},i._ErrorEnabled=function(n){var t,r;i.errorsCount++;t=i._FormatMessage(n);console.error("BJS - "+t);r="<div style='color:red'>"+t+"<\/div><br>";i._AddLogEntry(r)},Object.defineProperty(i,"LogCache",{get:function(){return i._LogCache},enumerable:!0,configurable:!0}),i.ClearLogCache=function(){i._LogCache="";i.errorsCount=0},Object.defineProperty(i,"LogLevels",{set:function(n){i.Log=(n&i.MessageLogLevel)===i.MessageLogLevel?i._LogEnabled:i._LogDisabled;i.Warn=(n&i.WarningLogLevel)===i.WarningLogLevel?i._WarnEnabled:i._WarnDisabled;i.Error=(n&i.ErrorLogLevel)===i.ErrorLogLevel?i._ErrorEnabled:i._ErrorDisabled},enumerable:!0,configurable:!0}),Object.defineProperty(i,"PerformanceNoneLogLevel",{get:function(){return i._PerformanceNoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(i,"PerformanceUserMarkLogLevel",{get:function(){return i._PerformanceUserMarkLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(i,"PerformanceConsoleLogLevel",{get:function(){return i._PerformanceConsoleLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(i,"PerformanceLogLevel",{set:function(n){return(n&i.PerformanceUserMarkLogLevel)===i.PerformanceUserMarkLogLevel?(i.StartPerformanceCounter=i._StartUserMark,void(i.EndPerformanceCounter=i._EndUserMark)):(n&i.PerformanceConsoleLogLevel)===i.PerformanceConsoleLogLevel?(i.StartPerformanceCounter=i._StartPerformanceConsole,void(i.EndPerformanceCounter=i._EndPerformanceConsole)):(i.StartPerformanceCounter=i._StartPerformanceCounterDisabled,void(i.EndPerformanceCounter=i._EndPerformanceCounterDisabled))},enumerable:!0,configurable:!0}),i._StartPerformanceCounterDisabled=function(){},i._EndPerformanceCounterDisabled=function(){},i._StartUserMark=function(n,t){void 0===t&&(t=!0);t&&i._performance.mark&&i._performance.mark(n+"-Begin")},i._EndUserMark=function(n,t){void 0===t&&(t=!0);t&&i._performance.mark&&(i._performance.mark(n+"-End"),i._performance.measure(n,n+"-Begin",n+"-End"))},i._StartPerformanceConsole=function(n,t){void 0===t&&(t=!0);t&&(i._StartUserMark(n,t),console.time&&console.time(n))},i._EndPerformanceConsole=function(n,t){void 0===t&&(t=!0);t&&(i._EndUserMark(n,t),console.time&&console.timeEnd(n))},Object.defineProperty(i,"Now",{get:function(){return window.performance&&window.performance.now?window.performance.now():(new Date).getTime()},enumerable:!0,configurable:!0}),i.getClassName=function(n,t){var i,r;return void 0===t&&(t=!1),i=null,!t&&n.getClassName?i=n.getClassName():(n instanceof Object&&(r=t?n:Object.getPrototypeOf(n),i=r.constructor.__bjsclassName__),i||(i=typeof n)),i},i.first=function(n,t){for(var u,i=0,r=n;i<r.length;i++)if(u=r[i],t(u))return u},i.getFullClassName=function(n,t){var i,r,u;return void 0===t&&(t=!1),i=null,r=null,!t&&n.getClassName?i=n.getClassName():(n instanceof Object&&(u=t?n:Object.getPrototypeOf(n),i=u.constructor.__bjsclassName__,r=u.constructor.__bjsmoduleName__),i||(i=typeof n)),i?(null!=r?r+".":"")+i:null},i.arrayOrStringFeeder=function(n){return function(t){if(t>=n.length)return null;var r=n.charCodeAt?n.charCodeAt(t):n[t];return r&&r.getHashCode&&(r=r.getHashCode()),"string"==typeof r?i.hashCodeFromStream(i.arrayOrStringFeeder(r)):r}},i.hashCodeFromStream=function(n){for(var t=0,r=0,i=n(r++);null!=i;)t=(t<<5)-t+i,t|=0,i=n(r++);return t},i.BaseUrl="",i.CorsBehavior="anonymous",i.UseFallbackTexture=!0,i._NoneLogLevel=0,i._MessageLogLevel=1,i._WarningLogLevel=2,i._ErrorLogLevel=4,i._LogCache="",i.errorsCount=0,i.Log=i._LogEnabled,i.Warn=i._WarnEnabled,i.Error=i._ErrorEnabled,i._PerformanceNoneLogLevel=0,i._PerformanceUserMarkLogLevel=1,i._PerformanceConsoleLogLevel=2,i._performance=window.performance,i.StartPerformanceCounter=i._StartPerformanceCounterDisabled,i.EndPerformanceCounter=i._EndPerformanceCounterDisabled,i}(),u,f;n.Tools=i;u=function(){function n(){this._startMonitoringTime=0;this._min=0;this._max=0;this._average=0;this._lastSecAverage=0;this._current=0;this._totalValueCount=0;this._totalAccumulated=0;this._lastSecAccumulated=0;this._lastSecTime=0;this._lastSecValueCount=0}return Object.defineProperty(n.prototype,"min",{get:function(){return this._min},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"max",{get:function(){return this._max},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"average",{get:function(){return this._average},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:!0,configurable:!0}),n.prototype.fetchNewFrame=function(){this._totalValueCount++;this._current=0;this._lastSecValueCount++},n.prototype.addCount=function(n,t){this._current+=n;t&&this._fetchResult()},n.prototype.beginMonitoring=function(){this._startMonitoringTime=i.Now},n.prototype.endMonitoring=function(n){void 0===n&&(n=!0);n&&this.fetchNewFrame();var t=i.Now;this._current=t-this._startMonitoringTime;n&&this._fetchResult()},n.prototype._fetchResult=function(){this._totalAccumulated+=this._current;this._lastSecAccumulated+=this._current;this._min=Math.min(this._min,this._current);this._max=Math.max(this._max,this._current);this._average=this._totalAccumulated/this._totalValueCount;var n=i.Now;n-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=n,this._lastSecAccumulated=0,this._lastSecValueCount=0)},n}();n.PerfCounter=u;n.className=e;f=function(){function n(n,t,i,r){void 0===r&&(r=0);this.iterations=n;this._fn=t;this._successCallback=i;this.index=r-1;this._done=!1}return n.prototype.executeNext=function(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())},n.prototype.breakLoop=function(){this._done=!0;this._successCallback()},n.Run=function(t,i,r,u){void 0===u&&(u=0);var f=new n(t,i,r,u);return f.executeNext(),f},n.SyncAsyncForLoop=function(t,i,r,u,f,e){void 0===e&&(e=0);n.Run(Math.ceil(t/i),function(n){f&&f()?n.breakLoop():setTimeout(function(){for(var e,u=0;u<i;++u){if(e=n.index*i+u,e>=t)break;if(r(e),f&&f()){n.breakLoop();break}}n.executeNext()},e)},u)},n}();n.AsyncLoop=f}(i||(i={}));!function(n){var t;!function(n){var t=function(){function n(){this._isAlphaBlendDirty=!1;this._isBlendFunctionParametersDirty=!1;this._alphaBlend=!1;this._blendFunctionParameters=new Array(4);this.reset()}return Object.defineProperty(n.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(n){this._alphaBlend!==n&&(this._alphaBlend=n,this._isAlphaBlendDirty=!0)},enumerable:!0,configurable:!0}),n.prototype.setAlphaBlendFunctionParameters=function(n,t,i,r){this._blendFunctionParameters[0]===n&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=n,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)},n.prototype.reset=function(){this._alphaBlend=!1;this._blendFunctionParameters[0]=null;this._blendFunctionParameters[1]=null;this._blendFunctionParameters[2]=null;this._blendFunctionParameters[3]=null;this._isAlphaBlendDirty=!0;this._isBlendFunctionParametersDirty=!1},n.prototype.apply=function(n){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?n.enable(n.BLEND):n.disable(n.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(n.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1))},n}();n._AlphaState=t}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t;!function(n){var t=function(){function n(){this._isDepthTestDirty=!1;this._isDepthMaskDirty=!1;this._isDepthFuncDirty=!1;this._isCullFaceDirty=!1;this._isCullDirty=!1;this._isZOffsetDirty=!1;this.reset()}return Object.defineProperty(n.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"zOffset",{get:function(){return this._zOffset},set:function(n){this._zOffset!==n&&(this._zOffset=n,this._isZOffsetDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cullFace",{get:function(){return this._cullFace},set:function(n){this._cullFace!==n&&(this._cullFace=n,this._isCullFaceDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"cull",{get:function(){return this._cull},set:function(n){this._cull!==n&&(this._cull=n,this._isCullDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(n){this._depthFunc!==n&&(this._depthFunc=n,this._isDepthFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"depthMask",{get:function(){return this._depthMask},set:function(n){this._depthMask!==n&&(this._depthMask=n,this._isDepthMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"depthTest",{get:function(){return this._depthTest},set:function(n){this._depthTest!==n&&(this._depthTest=n,this._isDepthTestDirty=!0)},enumerable:!0,configurable:!0}),n.prototype.reset=function(){this._depthMask=!0;this._depthTest=!0;this._depthFunc=null;this._cullFace=null;this._cull=null;this._zOffset=0;this._isDepthTestDirty=!0;this._isDepthMaskDirty=!0;this._isDepthFuncDirty=!1;this._isCullFaceDirty=!1;this._isCullDirty=!1;this._isZOffsetDirty=!1},n.prototype.apply=function(n){this.isDirty&&(this._isCullDirty&&(this.cull?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(n.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(n.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(n.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset?(n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(this.zOffset,0)):n.disable(n.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1))},n}();n._DepthCullingState=t}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t;!function(t){var i=function(){function t(){this._isStencilTestDirty=!1;this._isStencilMaskDirty=!1;this._isStencilFuncDirty=!1;this._isStencilOpDirty=!1;this.reset()}return Object.defineProperty(t.prototype,"isDirty",{get:function(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(n){this._stencilFunc!==n&&(this._stencilFunc=n,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(n){this._stencilFuncRef!==n&&(this._stencilFuncRef=n,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(n){this._stencilFuncMask!==n&&(this._stencilFuncMask=n,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(n){this._stencilOpStencilFail!==n&&(this._stencilOpStencilFail=n,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(n){this._stencilOpDepthFail!==n&&(this._stencilOpDepthFail=n,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(n){this._stencilOpStencilDepthPass!==n&&(this._stencilOpStencilDepthPass=n,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(n){this._stencilMask!==n&&(this._stencilMask=n,this._isStencilMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(n){this._stencilTest!==n&&(this._stencilTest=n,this._isStencilTestDirty=!0)},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this._stencilTest=!1;this._stencilMask=255;this._stencilFunc=n.Engine.ALWAYS;this._stencilFuncRef=1;this._stencilFuncMask=255;this._stencilOpStencilFail=n.Engine.KEEP;this._stencilOpDepthFail=n.Engine.KEEP;this._stencilOpStencilDepthPass=n.Engine.REPLACE;this._isStencilTestDirty=!0;this._isStencilMaskDirty=!0;this._isStencilFuncDirty=!0;this._isStencilOpDirty=!0},t.prototype.apply=function(n){this.isDirty&&(this._isStencilTestDirty&&(this.stencilTest?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(n.stencilMask(this.stencilMask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(n.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(n.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass),this._isStencilOpDirty=!1))},t}();t._StencilState=i}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var f=function(n,t,i,r){var u=n.createShader("vertex"===i?n.VERTEX_SHADER:n.FRAGMENT_SHADER);if(n.shaderSource(u,(r?r+"\n":"")+t),n.compileShader(u),!n.getShaderParameter(u,n.COMPILE_STATUS))throw new Error(n.getShaderInfoLog(u));return u},e=36193,o=function(n,t){return t===i.TEXTURETYPE_FLOAT?n.FLOAT:t===i.TEXTURETYPE_HALF_FLOAT?e:n.UNSIGNED_BYTE},t=function(t,i,r){var u=r.NEAREST,f=r.NEAREST;return t===n.Texture.BILINEAR_SAMPLINGMODE?(u=r.LINEAR,f=i?r.LINEAR_MIPMAP_NEAREST:r.LINEAR):t===n.Texture.TRILINEAR_SAMPLINGMODE?(u=r.LINEAR,f=i?r.LINEAR_MIPMAP_LINEAR:r.LINEAR):t===n.Texture.NEAREST_SAMPLINGMODE&&(u=r.NEAREST,f=i?r.NEAREST_MIPMAP_LINEAR:r.NEAREST),{min:f,mag:u}},r=function(i,r,u,f,e,o,s,h,c,l){var v;void 0===l&&(l=n.Texture.TRILINEAR_SAMPLINGMODE);var a=u.getEngine(),y=n.Tools.GetExponentOfTwo(f,a.getCaps().maxTextureSize),p=n.Tools.GetExponentOfTwo(e,a.getCaps().maxTextureSize);a._bindTextureDirectly(r.TEXTURE_2D,i);r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,void 0===o?1:o?1:0);i._baseWidth=f;i._baseHeight=e;i._width=y;i._height=p;i.isReady=!0;c(y,p);v=t(l,!s,r);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,v.mag);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,v.min);s||h||r.generateMipmap(r.TEXTURE_2D);a._bindTextureDirectly(r.TEXTURE_2D,null);a.resetTextureCache();u._removePendingData(i);i.onLoadedCallbacks.forEach(function(n){n()});i.onLoadedCallbacks=[]},s=function(t,i,r,u,f,e){void 0===e&&(e=null);var o,s=function(){r[i]=o;r._internalCount++;u._removePendingData(o);6===r._internalCount&&f(r)},h=function(){u._removePendingData(o);e&&e()};o=n.Tools.LoadImage(t,s,h,u.database);u._addPendingData(o)},h=function(n,t,i,r,u){var e,f;for(void 0===u&&(u=null),e=[],e._internalCount=0,f=0;f<6;f++)s(r[f],f,e,t,i,u)},c=function(){function n(){}return n}(),u,i;n.InstancingAttributeInfo=c;u=function(){function n(){}return n}();n.EngineCapabilities=u;i=function(){function i(t,r,f,e){var o=this,h,c,l,s,a,v;if(void 0===e&&(e=!0),this.isFullscreen=!1,this.isPointerLock=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.enableOfflineSupport=!0,this.scenes=[],this._windowIsBackground=!1,this._webGLVersion="1.0",this._badOS=!1,this._drawCalls=new n.PerfCounter,this._renderingQueueLaunched=!1,this._activeRenderLoops=[],this.fpsRange=60,this.previousFramesDuration=[],this.fps=60,this.deltaTime=0,this._depthCullingState=new n.Internals._DepthCullingState,this._stencilState=new n.Internals._StencilState,this._alphaState=new n.Internals._AlphaState,this._alphaMode=i.ALPHA_DISABLE,this._loadedTexturesCache=[],this._maxTextureChannels=16,this._activeTexturesCache=new Array(this._maxTextureChannels),this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=[],this._currentBufferPointers=[],this._currentInstanceLocations=[],this._currentInstanceBuffers=[],this._texturesSupported=[],this._onVRFullScreenTriggered=function(){if(o._vrDisplayEnabled&&o._vrDisplayEnabled.isPresenting){o._oldSize=new n.Size(o.getRenderWidth(),o.getRenderHeight());o._oldHardwareScaleFactor=o.getHardwareScalingLevel();var t=o._vrDisplayEnabled.getEyeParameters("left");o.setHardwareScalingLevel(1);o.setSize(2*t.renderWidth,t.renderHeight)}else o.setHardwareScalingLevel(o._oldHardwareScaleFactor),o.setSize(o._oldSize.width,o._oldSize.height),o._vrDisplayEnabled=void 0},this._renderingCanvas=t,this._externalData=new n.StringDictionary,f=f||{},null!=r&&(f.antialias=r),void 0===f.preserveDrawingBuffer&&(f.preserveDrawingBuffer=!1),h=this._canRenderToFloatTexture(),c=this._canRenderToHalfFloatTexture(),!this._gl){if(!t)throw new Error("The provided canvas is null or undefined.");try{this._gl=t.getContext("webgl",f)||t.getContext("experimental-webgl",f)}catch(y){throw new Error("WebGL not supported");}}if(!this._gl)throw new Error("WebGL not supported");this._onBlur=function(){o._windowIsBackground=!0};this._onFocus=function(){o._windowIsBackground=!1};window.addEventListener("blur",this._onBlur);window.addEventListener("focus",this._onFocus);l=f.limitDeviceRatio||window.devicePixelRatio||1;this._hardwareScalingLevel=e?1/Math.min(l,window.devicePixelRatio||1):1;this.resize();this._isStencilEnable=f.stencil;this._caps=new u;this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS);this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE);this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE);this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE);this._caps.maxVertexAttribs=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS);this._glVersion=this._gl.getParameter(this._gl.VERSION);s=this._gl.getExtension("WEBGL_debug_renderer_info");(null!=s&&(this._glRenderer=this._gl.getParameter(s.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(s.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor="Unknown vendor"),this._glRenderer||(this._glRenderer="Unknown renderer"),this._caps.standardDerivatives=null!==this._gl.getExtension("OES_standard_derivatives"),this._caps.astc=this._gl.getExtension("WEBGL_compressed_texture_astc"),this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc"),this._caps.pvrtc=this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),this._caps.etc1=this._gl.getExtension("WEBGL_compressed_texture_etc1"),this._caps.etc2=this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),this._caps.textureFloat=null!==this._gl.getExtension("OES_texture_float"),this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.instancedArrays=this._gl.getExtension("ANGLE_instanced_arrays"),this._caps.uintIndices=null!==this._gl.getExtension("OES_element_index_uint"),this._caps.fragmentDepthSupported=null!==this._gl.getExtension("EXT_frag_depth"),this._caps.highPrecisionShaderSupported=!0,this._caps.drawBuffersExtension=this._gl.getExtension("WEBGL_draw_buffers"),this._caps.textureFloatLinearFiltering=this._gl.getExtension("OES_texture_float_linear"),this._caps.textureLOD=this._gl.getExtension("EXT_shader_texture_lod"),this._caps.textureFloatRender=h,this._caps.textureHalfFloat=null!==this._gl.getExtension("OES_texture_half_float"),this._caps.textureHalfFloatLinearFiltering=this._gl.getExtension("OES_texture_half_float_linear"),this._caps.textureHalfFloatRender=c,this._caps.astc&&this.texturesSupported.push(".astc"),this._caps.s3tc&&this.texturesSupported.push(".dds"),this._caps.pvrtc&&this.texturesSupported.push(".pvr"),this._caps.etc2&&this.texturesSupported.push(".etc2"),this._caps.etc1&&this.texturesSupported.push(".etc1"),this._gl.getShaderPrecisionFormat)&&(a=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT),this._caps.highPrecisionShaderSupported=0!==a.precision);this.setDepthBuffer(!0);this.setDepthFunctionToLessOrEqual();this.setDepthWrite(!0);this._onFullscreenChange=function(){void 0!==document.fullscreen?o.isFullscreen=document.fullscreen:void 0!==document.mozFullScreen?o.isFullscreen=document.mozFullScreen:void 0!==document.webkitIsFullScreen?o.isFullscreen=document.webkitIsFullScreen:void 0!==document.msIsFullScreen&&(o.isFullscreen=document.msIsFullScreen);o.isFullscreen&&o._pointerLockRequested&&(t.requestPointerLock=t.requestPointerLock||t.msRequestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.requestPointerLock&&t.requestPointerLock())};document.addEventListener("fullscreenchange",this._onFullscreenChange,!1);document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1);document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1);document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1);this._onPointerLockChange=function(){o.isPointerLock=document.mozPointerLockElement===t||document.webkitPointerLockElement===t||document.msPointerLockElement===t||document.pointerLockElement===t};document.addEventListener("pointerlockchange",this._onPointerLockChange,!1);document.addEventListener("mspointerlockchange",this._onPointerLockChange,!1);document.addEventListener("mozpointerlockchange",this._onPointerLockChange,!1);document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1);n.AudioEngine&&!i.audioEngine&&(i.audioEngine=new n.AudioEngine);this._loadingScreen=new n.DefaultLoadingScreen(this._renderingCanvas);f.autoEnableWebVR&&this.initWebVR();v=/AppleWebKit.*10.[\d] Mobile/;this._badOS=v.test(navigator.userAgent);n.Tools.Log("Babylon.js engine (v"+i.Version+") launched")}return Object.defineProperty(i,"NEVER",{get:function(){return i._NEVER},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALWAYS",{get:function(){return i._ALWAYS},enumerable:!0,configurable:!0}),Object.defineProperty(i,"LESS",{get:function(){return i._LESS},enumerable:!0,configurable:!0}),Object.defineProperty(i,"EQUAL",{get:function(){return i._EQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(i,"LEQUAL",{get:function(){return i._LEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(i,"GREATER",{get:function(){return i._GREATER},enumerable:!0,configurable:!0}),Object.defineProperty(i,"GEQUAL",{get:function(){return i._GEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(i,"NOTEQUAL",{get:function(){return i._NOTEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(i,"KEEP",{get:function(){return i._KEEP},enumerable:!0,configurable:!0}),Object.defineProperty(i,"REPLACE",{get:function(){return i._REPLACE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"INCR",{get:function(){return i._INCR},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DECR",{get:function(){return i._DECR},enumerable:!0,configurable:!0}),Object.defineProperty(i,"INVERT",{get:function(){return i._INVERT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"INCR_WRAP",{get:function(){return i._INCR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DECR_WRAP",{get:function(){return i._DECR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALPHA_DISABLE",{get:function(){return i._ALPHA_DISABLE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALPHA_ONEONE",{get:function(){return i._ALPHA_ONEONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALPHA_ADD",{get:function(){return i._ALPHA_ADD},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALPHA_COMBINE",{get:function(){return i._ALPHA_COMBINE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALPHA_SUBTRACT",{get:function(){return i._ALPHA_SUBTRACT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALPHA_MULTIPLY",{get:function(){return i._ALPHA_MULTIPLY},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ALPHA_MAXIMIZED",{get:function(){return i._ALPHA_MAXIMIZED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DELAYLOADSTATE_NONE",{get:function(){return i._DELAYLOADSTATE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DELAYLOADSTATE_LOADED",{get:function(){return i._DELAYLOADSTATE_LOADED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DELAYLOADSTATE_LOADING",{get:function(){return i._DELAYLOADSTATE_LOADING},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DELAYLOADSTATE_NOTLOADED",{get:function(){return i._DELAYLOADSTATE_NOTLOADED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTUREFORMAT_ALPHA",{get:function(){return i._TEXTUREFORMAT_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTUREFORMAT_LUMINANCE",{get:function(){return i._TEXTUREFORMAT_LUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTUREFORMAT_LUMINANCE_ALPHA",{get:function(){return i._TEXTUREFORMAT_LUMINANCE_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTUREFORMAT_RGB",{get:function(){return i._TEXTUREFORMAT_RGB},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTUREFORMAT_RGBA",{get:function(){return i._TEXTUREFORMAT_RGBA},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTURETYPE_UNSIGNED_INT",{get:function(){return i._TEXTURETYPE_UNSIGNED_INT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTURETYPE_FLOAT",{get:function(){return i._TEXTURETYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"TEXTURETYPE_HALF_FLOAT",{get:function(){return i._TEXTURETYPE_HALF_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"Version",{get:function(){return"2.5"},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"texturesSupported",{get:function(){return this._texturesSupported},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!0,configurable:!0}),i.prototype._prepareWorkingCanvas=function(){this._workingCanvas||(this._workingCanvas=document.createElement("canvas"),this._workingContext=this._workingCanvas.getContext("2d"))},i.prototype.resetTextureCache=function(){for(var n=0;n<this._maxTextureChannels;n++)this._activeTexturesCache[n]=null},i.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},i.prototype.getAspectRatio=function(n,t){void 0===t&&(t=!1);var i=n.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)},i.prototype.getRenderWidth=function(n){return void 0===n&&(n=!1),!n&&this._currentRenderTarget?this._currentRenderTarget._width:this._renderingCanvas.width},i.prototype.getRenderHeight=function(n){return void 0===n&&(n=!1),!n&&this._currentRenderTarget?this._currentRenderTarget._height:this._renderingCanvas.height},i.prototype.getRenderingCanvas=function(){return this._renderingCanvas},i.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas.getBoundingClientRect()},i.prototype.setHardwareScalingLevel=function(n){this._hardwareScalingLevel=n;this.resize()},i.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},i.prototype.getLoadedTexturesCache=function(){return this._loadedTexturesCache},i.prototype.getCaps=function(){return this._caps},Object.defineProperty(i.prototype,"drawCalls",{get:function(){return this._drawCalls.current},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"drawCallsPerfCounter",{get:function(){return this._drawCalls},enumerable:!0,configurable:!0}),i.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},i.prototype.setDepthFunction=function(n){this._depthCullingState.depthFunc=n},i.prototype.setDepthFunctionToGreater=function(){this._depthCullingState.depthFunc=this._gl.GREATER},i.prototype.setDepthFunctionToGreaterOrEqual=function(){this._depthCullingState.depthFunc=this._gl.GEQUAL},i.prototype.setDepthFunctionToLess=function(){this._depthCullingState.depthFunc=this._gl.LESS},i.prototype.setDepthFunctionToLessOrEqual=function(){this._depthCullingState.depthFunc=this._gl.LEQUAL},i.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},i.prototype.setStencilBuffer=function(n){this._stencilState.stencilTest=n},i.prototype.getStencilMask=function(){return this._stencilState.stencilMask},i.prototype.setStencilMask=function(n){this._stencilState.stencilMask=n},i.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},i.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},i.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask},i.prototype.setStencilFunction=function(n){this._stencilState.stencilFunc=n},i.prototype.setStencilFunctionReference=function(n){this._stencilState.stencilFuncRef=n},i.prototype.setStencilFunctionMask=function(n){this._stencilState.stencilFuncMask=n},i.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},i.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},i.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},i.prototype.setStencilOperationFail=function(n){this._stencilState.stencilOpStencilFail=n},i.prototype.setStencilOperationDepthFail=function(n){this._stencilState.stencilOpDepthFail=n},i.prototype.setStencilOperationPass=function(n){this._stencilState.stencilOpStencilDepthPass=n},i.prototype.stopRenderLoop=function(n){if(!n)return void(this._activeRenderLoops=[]);var t=this._activeRenderLoops.indexOf(n);t>=0&&this._activeRenderLoops.splice(t,1)},i.prototype._renderLoop=function(){var i=!0,t,r;if(!this.renderEvenInBackground&&this._windowIsBackground&&(i=!1),i){for(this.beginFrame(),t=0;t<this._activeRenderLoops.length;t++)r=this._activeRenderLoops[t],r();this.endFrame()}this._activeRenderLoops.length>0?n.Tools.QueueNewFrame(this._bindedRenderFunction,this._vrDisplayEnabled):this._renderingQueueLaunched=!1},i.prototype.runRenderLoop=function(t){this._activeRenderLoops.indexOf(t)===-1&&(this._activeRenderLoops.push(t),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._bindedRenderFunction=this._renderLoop.bind(this),n.Tools.QueueNewFrame(this._bindedRenderFunction)))},i.prototype.switchFullscreen=function(t){this.isFullscreen?n.Tools.ExitFullscreen():(this._pointerLockRequested=t,n.Tools.RequestFullscreen(this._renderingCanvas))},i.prototype.clear=function(n,t,i,r){void 0===r&&(r=!1);this.applyStates();var u=0;t&&(this._gl.clearColor(n.r,n.g,n.b,void 0!==n.a?n.a:1),u|=this._gl.COLOR_BUFFER_BIT);i&&(this._gl.clearDepth(1),u|=this._gl.DEPTH_BUFFER_BIT);r&&(this._gl.clearStencil(0),u|=this._gl.STENCIL_BUFFER_BIT);this._gl.clear(u)},i.prototype.scissorClear=function(n,t,i,r,u){var f=this._gl,o=f.getParameter(f.SCISSOR_TEST),e=f.getParameter(f.SCISSOR_BOX);f.enable(f.SCISSOR_TEST);f.scissor(n,t,i,r);this.clear(u,!0,!0,!0);f.scissor(e[0],e[1],e[2],e[3]);o===!0?f.enable(f.SCISSOR_TEST):f.disable(f.SCISSOR_TEST)},i.prototype.setViewport=function(n,t,i){var r=t||(navigator.isCocoonJS?window.innerWidth:this._renderingCanvas.width),u=i||(navigator.isCocoonJS?window.innerHeight:this._renderingCanvas.height),f=n.x||0,e=n.y||0;this._cachedViewport=n;this._gl.viewport(f*r,e*u,r*n.width,u*n.height)},i.prototype.setDirectViewport=function(n,t,i,r){var u=this._cachedViewport;return this._cachedViewport=null,this._gl.viewport(n,t,i,r),u},i.prototype.beginFrame=function(){this._measureFps()},i.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer();this._vrDisplayEnabled&&this._vrDisplayEnabled.isPresenting&&this._vrDisplayEnabled.submitFrame()},i.prototype.resize=function(){var r=navigator.isCocoonJS?window.innerWidth:this._renderingCanvas.clientWidth,u=navigator.isCocoonJS?window.innerHeight:this._renderingCanvas.clientHeight,t,i;for(this.setSize(r/this._hardwareScalingLevel,u/this._hardwareScalingLevel),t=0;t<this.scenes.length;t++)i=this.scenes[t],n.DebugLayer&&i.debugLayer.isVisible()&&i.debugLayer._syncPositions()},i.prototype.setSize=function(n,t){var i,u,r,f;for(this._renderingCanvas.width=n,this._renderingCanvas.height=t,i=0;i<this.scenes.length;i++)for(u=this.scenes[i],r=0;r<u.cameras.length;r++)f=u.cameras[r],f._currentRenderId=0},i.prototype.initWebVR=function(){this.vrDisplaysPromise||this._getVRDisplays()},i.prototype.enableVR=function(n){this._vrDisplayEnabled=n;this._vrDisplayEnabled.requestPresent([{source:this.getRenderingCanvas()}]).then(this._onVRFullScreenTriggered)},i.prototype.disableVR=function(){this._vrDisplayEnabled&&this._vrDisplayEnabled.exitPresent().then(this._onVRFullScreenTriggered)},i.prototype._getVRDisplays=function(){var n=this,t=function(t){var i=(t.length,0);return n._vrDisplays=t.filter(function(){return t[i]instanceof VRDisplay}),n._vrDisplays};navigator.getVRDisplays&&(this.vrDisplaysPromise=navigator.getVRDisplays().then(t))},i.prototype.bindFramebuffer=function(n,t,i,r){this._currentRenderTarget=n;this.bindUnboundFramebuffer(n._framebuffer);var u=this._gl;n.isCube&&u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+t,n,0);u.viewport(0,0,i||n._width,r||n._height);this.wipeCaches()},i.prototype.bindUnboundFramebuffer=function(n){this._currentFramebuffer!==n&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,n),this._currentFramebuffer=n)},i.prototype.unBindFramebuffer=function(n,t){if(void 0===t&&(t=!1),this._currentRenderTarget=null,n.generateMipMaps&&!t){var i=this._gl;this._bindTextureDirectly(i.TEXTURE_2D,n);i.generateMipmap(i.TEXTURE_2D);this._bindTextureDirectly(i.TEXTURE_2D,null)}this.bindUnboundFramebuffer(null)},i.prototype.generateMipMapsForCubemap=function(n){if(n.generateMipMaps){var t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,n);t.generateMipmap(t.TEXTURE_CUBE_MAP);this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}},i.prototype.flushFramebuffer=function(){this._gl.flush()},i.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget=null;this.bindUnboundFramebuffer(null);this.setViewport(this._cachedViewport);this.wipeCaches()},i.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null);this._cachedVertexBuffers=null},i.prototype.createVertexBuffer=function(n){var t=this._gl.createBuffer();return this.bindArrayBuffer(t),n instanceof Float32Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,n,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(n),this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),t.references=1,t},i.prototype.createDynamicVertexBuffer=function(n){var t=this._gl.createBuffer();return this.bindArrayBuffer(t),n instanceof Float32Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,n,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(n),this._gl.DYNAMIC_DRAW),this._resetVertexBufferBinding(),t.references=1,t},i.prototype.updateDynamicVertexBuffer=function(n,t,i,r){this.bindArrayBuffer(n);void 0===i&&(i=0);void 0===r?t instanceof Float32Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,t):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,i,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t.subarray(i,i+r)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(i,i+r));this._resetVertexBufferBinding()},i.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null);this._cachedIndexBuffer=null},i.prototype.createIndexBuffer=function(n){var t=this._gl.createBuffer(),u,i,r;if(this.bindIndexBuffer(t),i=!1,this._caps.uintIndices){for(r=0;r<n.length;r++)if(n[r]>65535){i=!0;break}u=i?new Uint32Array(n):new Uint16Array(n)}else u=new Uint16Array(n);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,u,this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),t.references=1,t.is32Bits=i,t},i.prototype.bindArrayBuffer=function(n){this.bindBuffer(n,this._gl.ARRAY_BUFFER)},i.prototype.bindIndexBuffer=function(n){this.bindBuffer(n,this._gl.ELEMENT_ARRAY_BUFFER)},i.prototype.bindBuffer=function(n,t){this._currentBoundBuffer[t]!==n&&(this._gl.bindBuffer(t,n),this._currentBoundBuffer[t]=n)},i.prototype.updateArrayBuffer=function(n){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,n)},i.prototype.vertexAttribPointer=function(n,t,i,r,u,f,e){var o=this._currentBufferPointers[t],s=!1;o?(o.buffer!==n&&(o.buffer=n,s=!0),o.size!==i&&(o.size=i,s=!0),o.type!==r&&(o.type=r,s=!0),o.normalized!==u&&(o.normalized=u,s=!0),o.stride!==f&&(o.stride=f,s=!0),o.offset!==e&&(o.offset=e,s=!0)):(s=!0,this._currentBufferPointers[t]={indx:t,size:i,type:r,normalized:u,stride:f,offset:e,buffer:n});s&&(this.bindArrayBuffer(n),this._gl.vertexAttribPointer(t,i,r,u,f,e))},i.prototype.bindBuffersDirectly=function(n,t,i,r,u){var f;if(this._cachedVertexBuffers!==n||this._cachedEffectForVertexBuffers!==u){this._cachedVertexBuffers=n;this._cachedEffectForVertexBuffers=u;for(var s=u.getAttributesCount(),o=0,e=0;e<s;e++)e<i.length?(f=u.getAttributeLocation(e),f>=0&&(this._vertexAttribArraysEnabled[f]||(this._gl.enableVertexAttribArray(f),this._vertexAttribArraysEnabled[f]=!0),this.vertexAttribPointer(n,f,i[e],this._gl.FLOAT,!1,r,o)),o+=4*i[e]):(f=u.getAttributeLocation(e),this._vertexAttribArraysEnabled[f]&&(this._gl.disableVertexAttribArray(f),this._vertexAttribArraysEnabled[f]=!1))}this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this.bindIndexBuffer(t),this._uintIndicesCurrentlySet=t.is32Bits)},i.prototype.bindBuffers=function(n,t,i){var e,f,r,u,o;if(this._cachedVertexBuffers!==n||this._cachedEffectForVertexBuffers!==i)for(this._cachedVertexBuffers=n,this._cachedEffectForVertexBuffers=i,e=i.getAttributesNames(),f=0;f<e.length;f++)if(r=i.getAttributeLocation(f),r>=0){if(u=n[e[f]],!u){this._vertexAttribArraysEnabled[r]&&(this._gl.disableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!1);continue}this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0);o=u.getBuffer();this.vertexAttribPointer(o,r,u.getSize(),this._gl.FLOAT,!1,4*u.getStrideSize(),4*u.getOffset());u.getIsInstanced()&&(this._caps.instancedArrays.vertexAttribDivisorANGLE(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(o))}null!=t&&this._cachedIndexBuffer!==t&&(this._cachedIndexBuffer=t,this.bindIndexBuffer(t),this._uintIndicesCurrentlySet=t.is32Bits)},i.prototype.unbindInstanceAttributes=function(){for(var i,t,u,n=0,r=this._currentInstanceLocations.length;n<r;n++)t=this._currentInstanceBuffers[n],i!=t&&(i=t,this.bindArrayBuffer(t)),u=this._currentInstanceLocations[n],this._caps.instancedArrays.vertexAttribDivisorANGLE(u,0);this._currentInstanceBuffers.length=0;this._currentInstanceLocations.length=0},i.prototype._releaseBuffer=function(n){return n.references--,0===n.references&&(this._gl.deleteBuffer(n),!0)},i.prototype.createInstancesBuffer=function(n){var t=this._gl.createBuffer();return t.capacity=n,this.bindArrayBuffer(t),this._gl.bufferData(this._gl.ARRAY_BUFFER,n,this._gl.DYNAMIC_DRAW),t},i.prototype.deleteInstancesBuffer=function(n){this._gl.deleteBuffer(n)},i.prototype.updateAndBindInstancesBuffer=function(n,t,i){var o,u,r,e,f;if(this.bindArrayBuffer(n),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==i[0].index){for(o=0,u=0;u<i.length;u++)r=i[u],o+=4*r.attributeSize;for(u=0;u<i.length;u++)r=i[u],this._vertexAttribArraysEnabled[r.index]||(this._gl.enableVertexAttribArray(r.index),this._vertexAttribArraysEnabled[r.index]=!0),this.vertexAttribPointer(n,r.index,r.attributeSize,r.attribyteType||this._gl.FLOAT,r.normalized||!1,o,r.offset),this._caps.instancedArrays.vertexAttribDivisorANGLE(r.index,1),this._currentInstanceLocations.push(r.index),this._currentInstanceBuffers.push(n)}else for(e=0;e<4;e++)f=i[e],this._vertexAttribArraysEnabled[f]||(this._gl.enableVertexAttribArray(f),this._vertexAttribArraysEnabled[f]=!0),this.vertexAttribPointer(n,f,4,this._gl.FLOAT,!1,64,16*e),this._caps.instancedArrays.vertexAttribDivisorANGLE(f,1),this._currentInstanceLocations.push(f),this._currentInstanceBuffers.push(n)},i.prototype.applyStates=function(){this._depthCullingState.apply(this._gl);this._stencilState.apply(this._gl);this._alphaState.apply(this._gl)},i.prototype.draw=function(n,t,i,r){this.applyStates();this._drawCalls.addCount(1,!1);var u=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,f=this._uintIndicesCurrentlySet?4:2;return r?void this._caps.instancedArrays.drawElementsInstancedANGLE(n?this._gl.TRIANGLES:this._gl.LINES,i,u,t*f,r):void this._gl.drawElements(n?this._gl.TRIANGLES:this._gl.LINES,i,u,t*f)},i.prototype.drawPointClouds=function(n,t,i){return this.applyStates(),this._drawCalls.addCount(1,!1),i?void this._caps.instancedArrays.drawArraysInstancedANGLE(this._gl.POINTS,n,t,i):void this._gl.drawArrays(this._gl.POINTS,n,t)},i.prototype.drawUnIndexed=function(n,t,i,r){return this.applyStates(),this._drawCalls.addCount(1,!1),r?void this._caps.instancedArrays.drawArraysInstancedANGLE(n?this._gl.TRIANGLES:this._gl.LINES,t,i,r):void this._gl.drawArrays(n?this._gl.TRIANGLES:this._gl.LINES,t,i)},i.prototype._releaseEffect=function(n){this._compiledEffects[n._key]&&(delete this._compiledEffects[n._key],n.getProgram()&&this._gl.deleteProgram(n.getProgram()))},i.prototype.createEffect=function(t,i,r,u,f,e,o,s,h){var a=t.vertexElement||t.vertex||t,v=t.fragmentElement||t.fragment||t,c=a+"+"+v+"@"+f,l;return this._compiledEffects[c]?this._compiledEffects[c]:(l=new n.Effect(t,i,r,u,this,f,e,o,s,h),l._key=c,this._compiledEffects[c]=l,l)},i.prototype.createEffectForParticles=function(n,t,i,r,u,f,e){return void 0===t&&(t=[]),void 0===i&&(i=[]),void 0===r&&(r=""),this.createEffect({vertex:"particles",fragmentElement:n},["position","color","options"],["view","projection"].concat(t),["diffuseSampler"].concat(i),r,u,f,e)},i.prototype.createShaderProgram=function(n,t,i,r){var h,e;r=r||this._gl;var o=f(r,n,"vertex",i),s=f(r,t,"fragment",i),u=r.createProgram();if(r.attachShader(u,o),r.attachShader(u,s),r.linkProgram(u),h=r.getProgramParameter(u,r.LINK_STATUS),!h&&(e=r.getProgramInfoLog(u),e))throw new Error(e);return r.deleteShader(o),r.deleteShader(s),u},i.prototype.getUniforms=function(n,t){for(var r=[],i=0;i<t.length;i++)r.push(this._gl.getUniformLocation(n,t[i]));return r},i.prototype.getAttributes=function(n,t){for(var i=[],r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(n,t[r]))}catch(u){i.push(-1)}return i},i.prototype.enableEffect=function(n){this.setProgram(n.getProgram());this._currentEffect=n;n.onBind&&n.onBind(n)},i.prototype.setIntArray=function(n,t){n&&this._gl.uniform1iv(n,t)},i.prototype.setIntArray2=function(n,t){n&&t.length%2==0&&this._gl.uniform2iv(n,t)},i.prototype.setIntArray3=function(n,t){n&&t.length%3==0&&this._gl.uniform3iv(n,t)},i.prototype.setIntArray4=function(n,t){n&&t.length%4==0&&this._gl.uniform4iv(n,t)},i.prototype.setFloatArray=function(n,t){n&&this._gl.uniform1fv(n,t)},i.prototype.setFloatArray2=function(n,t){n&&t.length%2==0&&this._gl.uniform2fv(n,t)},i.prototype.setFloatArray3=function(n,t){n&&t.length%3==0&&this._gl.uniform3fv(n,t)},i.prototype.setFloatArray4=function(n,t){n&&t.length%4==0&&this._gl.uniform4fv(n,t)},i.prototype.setArray=function(n,t){n&&this._gl.uniform1fv(n,t)},i.prototype.setArray2=function(n,t){n&&t.length%2==0&&this._gl.uniform2fv(n,t)},i.prototype.setArray3=function(n,t){n&&t.length%3==0&&this._gl.uniform3fv(n,t)},i.prototype.setArray4=function(n,t){n&&t.length%4==0&&this._gl.uniform4fv(n,t)},i.prototype.setMatrices=function(n,t){n&&this._gl.uniformMatrix4fv(n,!1,t)},i.prototype.setMatrix=function(n,t){n&&this._gl.uniformMatrix4fv(n,!1,t.toArray())},i.prototype.setMatrix3x3=function(n,t){n&&this._gl.uniformMatrix3fv(n,!1,t)},i.prototype.setMatrix2x2=function(n,t){n&&this._gl.uniformMatrix2fv(n,!1,t)},i.prototype.setFloat=function(n,t){n&&this._gl.uniform1f(n,t)},i.prototype.setFloat2=function(n,t,i){n&&this._gl.uniform2f(n,t,i)},i.prototype.setFloat3=function(n,t,i,r){n&&this._gl.uniform3f(n,t,i,r)},i.prototype.setBool=function(n,t){n&&this._gl.uniform1i(n,t)},i.prototype.setFloat4=function(n,t,i,r,u){n&&this._gl.uniform4f(n,t,i,r,u)},i.prototype.setColor3=function(n,t){n&&this._gl.uniform3f(n,t.r,t.g,t.b)},i.prototype.setColor4=function(n,t,i){n&&this._gl.uniform4f(n,t.r,t.g,t.b,i)},i.prototype.setState=function(n,t,i,r){void 0===t&&(t=0);void 0===r&&(r=!1);var f=r?this._gl.FRONT:this._gl.BACK,e=r?this._gl.BACK:this._gl.FRONT,u=this.cullBackFaces?f:e;(this._depthCullingState.cull!==n||i||this._depthCullingState.cullFace!==u)&&(n?(this._depthCullingState.cullFace=u,this._depthCullingState.cull=!0):this._depthCullingState.cull=!1);this._depthCullingState.zOffset=t},i.prototype.setDepthBuffer=function(n){this._depthCullingState.depthTest=n},i.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},i.prototype.setDepthWrite=function(n){this._depthCullingState.depthMask=n},i.prototype.setColorWrite=function(n){this._gl.colorMask(n,n,n,n)},i.prototype.setAlphaMode=function(n,t){if(void 0===t&&(t=!1),this._alphaMode!==n){switch(n){case i.ALPHA_DISABLE:this._alphaState.alphaBlend=!1;break;case i.ALPHA_COMBINE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=!0;break;case i.ALPHA_ONEONE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE);this._alphaState.alphaBlend=!0;break;case i.ALPHA_ADD:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE);this._alphaState.alphaBlend=!0;break;case i.ALPHA_SUBTRACT:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=!0;break;case i.ALPHA_MULTIPLY:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=!0;break;case i.ALPHA_MAXIMIZED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE);this._alphaState.alphaBlend=!0}t||this.setDepthWrite(n===i.ALPHA_DISABLE);this._alphaMode=n}},i.prototype.getAlphaMode=function(){return this._alphaMode},i.prototype.setAlphaTesting=function(n){this._alphaTest=n},i.prototype.getAlphaTesting=function(){return this._alphaTest},i.prototype.wipeCaches=function(){this.resetTextureCache();this._currentEffect=null;this._stencilState.reset();this._depthCullingState.reset();this.setDepthFunctionToLessOrEqual();this._alphaState.reset();this._cachedVertexBuffers=null;this._cachedIndexBuffer=null;this._cachedEffectForVertexBuffers=null},i.prototype.setSamplingMode=function(t,i){var r=this._gl,u,f;this._bindTextureDirectly(r.TEXTURE_2D,t);u=r.NEAREST;f=r.NEAREST;i===n.Texture.BILINEAR_SAMPLINGMODE?(u=r.LINEAR,f=r.LINEAR):i===n.Texture.TRILINEAR_SAMPLINGMODE&&(u=r.LINEAR,f=r.LINEAR_MIPMAP_LINEAR);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,u);r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,f);this._bindTextureDirectly(r.TEXTURE_2D,null);t.samplingMode=i},i.prototype.setTextureFormatToUse=function(n){for(var i,u,t=0,r=this.texturesSupported.length;t<r;t++)if(".astc"!==this._texturesSupported[t]&&".pvr"!==this._texturesSupported[t]&&".etc1"!==this._texturesSupported[t]&&".etc2"!==this._texturesSupported[t])for(i=0,u=n.length;i<u;i++)if(this._texturesSupported[t]===n[i].toLowerCase())return this._textureFormatInUse=this._texturesSupported[t];return this._textureFormatInUse=null},i.prototype.createTexture=function(t,i,u,f,e,o,s,h){var c=this,y,l,a,w,b,d,g,v,p,k;return void 0===e&&(e=n.Texture.TRILINEAR_SAMPLINGMODE),void 0===o&&(o=null),void 0===s&&(s=null),void 0===h&&(h=null),l=this._gl.createTexture(),a=!1,("data:"===t.substr(0,5)&&(a=!0),a)?(w=t,a=w.split(":"),t=w,y=a[1].substr(a[1].length-4,4).toLowerCase()):(b=t.lastIndexOf("."),y=t.substring(b).toLowerCase(),!this._textureFormatInUse||a||f.database||(y=this._textureFormatInUse,t=t.substring(0,b)+this._textureFormatInUse)),d=".dds"===y,g=".tga"===y,f._addPendingData(l),l.url=t,l.noMipmap=i,l.references=1,l.samplingMode=e,l.onLoadedCallbacks=[o],this._loadedTexturesCache.push(l),p=function(){f._removePendingData(l);s&&s()},g?(v=function(t){var o=new Uint8Array(t),s=n.Internals.TGATools.GetTGAHeader(o);r(l,c._gl,f,s.width,s.height,u,i,!1,function(){n.Internals.TGATools.UploadContent(c._gl,o)},e)},a instanceof Array?v(h):n.Tools.LoadFile(t,function(n){v(n)},null,f.database,!0,p)):d?(v=function(t){var o=n.Internals.DDSTools.GetDDSInfo(t),s=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&!i&&o.width>>o.mipmapCount-1==1;r(l,c._gl,f,o.width,o.height,u,!s,o.isFourCC,function(){n.Internals.DDSTools.UploadDDSLevels(c._gl,c.getCaps().s3tc,t,o,s,1)},e)},a instanceof Array?v(h):n.Tools.LoadFile(t,function(n){v(n)},null,f.database,!0,p)):(k=function(t){r(l,c._gl,f,t.width,t.height,u,i,!1,function(i,r){var u=t.width===i&&t.height===r;u||(c._prepareWorkingCanvas(),c._workingCanvas.width=i,c._workingCanvas.height=r,e===n.Texture.NEAREST_SAMPLINGMODE&&(c._workingContext.imageSmoothingEnabled=!1,c._workingContext.mozImageSmoothingEnabled=!1,c._workingContext.oImageSmoothingEnabled=!1,c._workingContext.webkitImageSmoothingEnabled=!1,c._workingContext.msImageSmoothingEnabled=!1),c._workingContext.drawImage(t,0,0,t.width,t.height,0,0,i,r),e===n.Texture.NEAREST_SAMPLINGMODE&&(c._workingContext.imageSmoothingEnabled=!0,c._workingContext.mozImageSmoothingEnabled=!0,c._workingContext.oImageSmoothingEnabled=!0,c._workingContext.webkitImageSmoothingEnabled=!0,c._workingContext.msImageSmoothingEnabled=!0));c._gl.texImage2D(c._gl.TEXTURE_2D,0,c._gl.RGBA,c._gl.RGBA,c._gl.UNSIGNED_BYTE,u?t:c._workingCanvas)},e)},a instanceof Array?n.Tools.LoadImage(h,k,p,f.database):n.Tools.LoadImage(t,k,p,f.database)),l},i.prototype._getInternalFormat=function(n){var t=this._gl.RGBA;switch(n){case i.TEXTUREFORMAT_ALPHA:t=this._gl.ALPHA;break;case i.TEXTUREFORMAT_LUMINANCE:t=this._gl.LUMINANCE;break;case i.TEXTUREFORMAT_LUMINANCE_ALPHA:t=this._gl.LUMINANCE_ALPHA;break;case i.TEXTUREFORMAT_RGB:t=this._gl.RGB;break;case i.TEXTUREFORMAT_RGBA:t=this._gl.RGBA}return t},i.prototype.updateRawTexture=function(n,t,i,r,u){void 0===u&&(u=null);var f=this._getInternalFormat(i);this._bindTextureDirectly(this._gl.TEXTURE_2D,n);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,void 0===r?1:r?1:0);n._width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1);u?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[u],n._width,n._height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,f,n._width,n._height,0,f,this._gl.UNSIGNED_BYTE,t);n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D);this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this.resetTextureCache();n.isReady=!0},i.prototype.createRawTexture=function(n,i,r,u,f,e,o,s){var h,c;return void 0===s&&(s=null),h=this._gl.createTexture(),h._baseWidth=i,h._baseHeight=r,h._width=i,h._height=r,h.references=1,this.updateRawTexture(h,n,u,e,s),this._bindTextureDirectly(this._gl.TEXTURE_2D,h),c=t(o,f,this._gl),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,c.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,c.min),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),h.samplingMode=o,this._loadedTexturesCache.push(h),h},i.prototype.createDynamicTexture=function(t,i,r,u){var f=this._gl.createTexture();return f._baseWidth=t,f._baseHeight=i,r&&(t=n.Tools.GetExponentOfTwo(t,this._caps.maxTextureSize),i=n.Tools.GetExponentOfTwo(i,this._caps.maxTextureSize)),this.resetTextureCache(),f._width=t,f._height=i,f.isReady=!1,f.generateMipMaps=r,f.references=1,f.samplingMode=u,this.updateTextureSamplingMode(u,f),this._loadedTexturesCache.push(f),f},i.prototype.updateTextureSamplingMode=function(n,i){var r=t(n,i.generateMipMaps,this._gl);i.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,i),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MAG_FILTER,r.mag),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MIN_FILTER,r.min),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,i),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,r.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,r.min),this._bindTextureDirectly(this._gl.TEXTURE_2D,null))},i.prototype.updateDynamicTexture=function(n,t,i,r){void 0===r&&(r=!1);this._bindTextureDirectly(this._gl.TEXTURE_2D,n);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?1:0);r&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t);n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D);this._bindTextureDirectly(this._gl.TEXTURE_2D,null);r&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0);this.resetTextureCache();n.isReady=!0},i.prototype.updateVideoTexture=function(n,t,i){if(!n._isDisabled){this._bindTextureDirectly(this._gl.TEXTURE_2D,n);this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,i?0:1);try{void 0===this._videoTextureSupported&&(this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),this._videoTextureSupported=0!==this._gl.getError()?!1:!0);this._videoTextureSupported?this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t):(n._workingCanvas||(n._workingCanvas=document.createElement("canvas"),n._workingContext=n._workingCanvas.getContext("2d"),n._workingCanvas.width=n._width,n._workingCanvas.height=n._height),n._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,n._width,n._height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n._workingCanvas));n.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D);this._bindTextureDirectly(this._gl.TEXTURE_2D,null);this.resetTextureCache();n.isReady=!0}catch(r){n._isDisabled=!0}}},i.prototype.createRenderTargetTexture=function(r,u){var y=!1,c=!0,p=!1,s=i.TEXTURETYPE_UNSIGNED_INT,l=n.Texture.TRILINEAR_SAMPLINGMODE,f,e,h,w;void 0!==u&&(y=void 0===u.generateMipMaps?u:u.generateMipMaps,c=void 0===u.generateDepthBuffer||u.generateDepthBuffer,p=c&&u.generateStencilBuffer,s=void 0===u.type?s:u.type,void 0!==u.samplingMode&&(l=u.samplingMode),s!==i.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?s!==i.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(l=n.Texture.NEAREST_SAMPLINGMODE):l=n.Texture.NEAREST_SAMPLINGMODE);f=this._gl;e=f.createTexture();this._bindTextureDirectly(f.TEXTURE_2D,e);var a=r.width||r,v=r.height||r,b=t(l,y,f);return s!==i.TEXTURETYPE_FLOAT||this._caps.textureFloat||(s=i.TEXTURETYPE_UNSIGNED_INT,n.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,b.mag),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,b.min),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,a,v,0,f.RGBA,o(f,s),null),p?(h=f.createRenderbuffer(),f.bindRenderbuffer(f.RENDERBUFFER,h),f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_STENCIL,a,v)):c&&(h=f.createRenderbuffer(),f.bindRenderbuffer(f.RENDERBUFFER,h),f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,a,v)),w=f.createFramebuffer(),this.bindUnboundFramebuffer(w),p?f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,h):c&&f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,h),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,e,0),y&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(f.TEXTURE_2D,null),f.bindRenderbuffer(f.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),e._framebuffer=w,c&&(e._depthBuffer=h),e._baseWidth=a,e._baseHeight=v,e._width=a,e._height=v,e.isReady=!0,e.generateMipMaps=y,e.references=1,e.samplingMode=l,e.type=s,this.resetTextureCache(),this._loadedTexturesCache.push(e),e},i.prototype.createRenderTargetCubeTexture=function(i,r){var u=this._gl,f=u.createTexture(),h=!0,o=!0,c=!1,l=n.Texture.TRILINEAR_SAMPLINGMODE,a,s,e,v;for(void 0!==r&&(h=void 0===r.generateMipMaps?r:r.generateMipMaps,o=void 0===r.generateDepthBuffer||r.generateDepthBuffer,c=o&&r.generateStencilBuffer,void 0!==r.samplingMode&&(l=r.samplingMode)),f.isCube=!0,f.references=1,f.generateMipMaps=h,f.references=1,f.samplingMode=l,a=t(l,h,u),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,f),s=0;s<6;s++)u.texImage2D(u.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,u.RGBA,i,i,0,u.RGBA,u.UNSIGNED_BYTE,null);return u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MAG_FILTER,a.mag),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_MIN_FILTER,a.min),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_CUBE_MAP,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),c?(e=u.createRenderbuffer(),u.bindRenderbuffer(u.RENDERBUFFER,e),u.renderbufferStorage(u.RENDERBUFFER,u.DEPTH_STENCIL,i,i)):o&&(e=u.createRenderbuffer(),u.bindRenderbuffer(u.RENDERBUFFER,e),u.renderbufferStorage(u.RENDERBUFFER,u.DEPTH_COMPONENT16,i,i)),v=u.createFramebuffer(),this.bindUnboundFramebuffer(v),c?u.framebufferRenderbuffer(u.FRAMEBUFFER,u.DEPTH_STENCIL_ATTACHMENT,u.RENDERBUFFER,e):o&&u.framebufferRenderbuffer(u.FRAMEBUFFER,u.DEPTH_ATTACHMENT,u.RENDERBUFFER,e),f.generateMipMaps&&(this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,f),u.generateMipmap(u.TEXTURE_CUBE_MAP)),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null),u.bindRenderbuffer(u.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),f._framebuffer=v,o&&(f._depthBuffer=e),f._width=i,f._height=i,f.isReady=!0,this.resetTextureCache(),this._loadedTexturesCache.push(f),f},i.prototype.createCubeTexture=function(t,i,r,u,f,e){var c=this,o,s,l,a;return void 0===f&&(f=null),void 0===e&&(e=null),o=this._gl,s=o.createTexture(),s.isCube=!0,s.url=t,s.references=1,s.onLoadedCallbacks=[],l=t.substr(t.length-4,4).toLowerCase(),a=this.getCaps().s3tc&&".dds"===l,a?n.Tools.LoadFile(t,function(t){var i=n.Internals.DDSTools.GetDDSInfo(t),r=(i.isRGB||i.isLuminance||i.mipmapCount>1)&&!u;c._bindTextureDirectly(o.TEXTURE_CUBE_MAP,s);o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,1);n.Internals.DDSTools.UploadDDSLevels(c._gl,c.getCaps().s3tc,t,i,r,6);u||i.isFourCC||1!==i.mipmapCount||o.generateMipmap(o.TEXTURE_CUBE_MAP);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,r?o.LINEAR_MIPMAP_LINEAR:o.LINEAR);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);c._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null);c.resetTextureCache();s._width=i.width;s._height=i.height;s.isReady=!0},null,null,!0,e):h(t,i,function(t){var r=n.Tools.GetExponentOfTwo(t[0].width,c._caps.maxCubemapTextureSize),e=r,h,i;for(c._prepareWorkingCanvas(),c._workingCanvas.width=r,c._workingCanvas.height=e,h=[o.TEXTURE_CUBE_MAP_POSITIVE_X,o.TEXTURE_CUBE_MAP_POSITIVE_Y,o.TEXTURE_CUBE_MAP_POSITIVE_Z,o.TEXTURE_CUBE_MAP_NEGATIVE_X,o.TEXTURE_CUBE_MAP_NEGATIVE_Y,o.TEXTURE_CUBE_MAP_NEGATIVE_Z],c._bindTextureDirectly(o.TEXTURE_CUBE_MAP,s),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),i=0;i<h.length;i++)c._workingContext.drawImage(t[i],0,0,t[i].width,t[i].height,0,0,r,e),o.texImage2D(h[i],0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,c._workingCanvas);u||o.generateMipmap(o.TEXTURE_CUBE_MAP);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,u?o.LINEAR:o.LINEAR_MIPMAP_LINEAR);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE);o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);c._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null);c.resetTextureCache();s._width=r;s._height=e;s.isReady=!0;s.onLoadedCallbacks.forEach(function(n){n()});f&&f()},r,e),this._loadedTexturesCache.push(s),s},i.prototype.updateTextureSize=function(n,t,i){n._width=t;n._height=i;n._size=t*i;n._baseWidth=t;n._baseHeight=i},i.prototype.createRawCubeTexture=function(t,r,u,f,o,s,h,c){var b=this,l=this._gl,v=l.createTexture(),a,y,d,g;r._addPendingData(v);v.isCube=!0;v.references=1;v.url=t;a=this._getInternalFormat(f);y=l.UNSIGNED_BYTE;o===i.TEXTURETYPE_FLOAT&&(y=l.FLOAT);var p=u,w=p,k=n.Tools.IsExponentOfTwo(p)&&n.Tools.IsExponentOfTwo(w);return v._width=p,v._height=w,d=function(){r._removePendingData(v)},g=function(t){var d=h(t),f=[l.TEXTURE_CUBE_MAP_POSITIVE_X,l.TEXTURE_CUBE_MAP_POSITIVE_Y,l.TEXTURE_CUBE_MAP_POSITIVE_Z,l.TEXTURE_CUBE_MAP_NEGATIVE_X,l.TEXTURE_CUBE_MAP_NEGATIVE_Y,l.TEXTURE_CUBE_MAP_NEGATIVE_Z],g,nt,i,u,tt,o,rt,et,ut;if(p=v._width,w=v._height,k=n.Tools.IsExponentOfTwo(p)&&n.Tools.IsExponentOfTwo(w),b._bindTextureDirectly(l.TEXTURE_CUBE_MAP,v),l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,0),!s&&k)if(c)for(g=[],g.push(d[0]),g.push(d[3]),g.push(d[1]),g.push(d[4]),g.push(d[2]),g.push(d[5]),nt=c(g),i=0;i<nt.length;i++)u=p>>i,l.texImage2D(f[0],i,a,u,u,0,a,y,nt[i][0]),l.texImage2D(f[1],i,a,u,u,0,a,y,nt[i][2]),l.texImage2D(f[2],i,a,u,u,0,a,y,nt[i][4]),l.texImage2D(f[3],i,a,u,u,0,a,y,nt[i][1]),l.texImage2D(f[4],i,a,u,u,0,a,y,nt[i][3]),l.texImage2D(f[5],i,a,u,u,0,a,y,nt[i][5]);else{for(o=0;o<f.length;o++)tt=d[o],l.texImage2D(f[o],0,a,p,w,0,a,y,tt);if(l.generateMipmap(l.TEXTURE_CUBE_MAP),y===l.FLOAT&&a===l.RGB&&1282===l.getError()){for(n.Tools.Log("RGB32F not renderable on Firefox, trying fallback to RGBA32F."),o=0;o<f.length;o++){for(var tt=d[o],it=new Float32Array(p*w*4),ft=0;ft<p;ft++)for(rt=0;rt<w;rt++)et=3*(rt*p+ft),ut=4*(rt*p+ft),it[ut+0]=tt[et+0],it[ut+1]=tt[et+1],it[ut+2]=tt[et+2],it[ut+3]=1;l.texImage2D(f[o],0,l.RGBA,p,w,0,l.RGBA,y,it)}l.generateMipmap(l.TEXTURE_CUBE_MAP)}}else s=!0;(y!==l.FLOAT||b._caps.textureFloatLinearFiltering)&&(y!==e||b._caps.textureHalfFloatLinearFiltering)?(l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,s?l.LINEAR:l.LINEAR_MIPMAP_LINEAR)):(l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,l.NEAREST));l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE);l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE);b._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null);v.isReady=!0;b.resetTextureCache();r._removePendingData(v)},n.Tools.LoadFile(t,function(n){g(n)},d,r.database,!0),v},i.prototype._releaseTexture=function(n){var t=this._gl,i;n._framebuffer&&t.deleteFramebuffer(n._framebuffer);n._depthBuffer&&t.deleteRenderbuffer(n._depthBuffer);t.deleteTexture(n);this.unbindAllTextures();i=this._loadedTexturesCache.indexOf(n);i!==-1&&this._loadedTexturesCache.splice(i,1)},i.prototype.setProgram=function(n){this._currentProgram!==n&&(this._gl.useProgram(n),this._currentProgram=n)},i.prototype.bindSamplers=function(n){var i,t,r;for(this.setProgram(n.getProgram()),i=n.getSamplers(),t=0;t<i.length;t++)r=n.getUniform(i[t]),this._gl.uniform1i(r,t);this._currentEffect=null},i.prototype.activateTexture=function(n){this._activeTexture!==n&&(this._gl.activeTexture(n),this._activeTexture=n)},i.prototype._bindTextureDirectly=function(n,t){this._activeTexturesCache[this._activeTexture]!==t&&(this._gl.bindTexture(n,t),this._activeTexturesCache[this._activeTexture]=t)},i.prototype._bindTexture=function(n,t){n<0||(this.activateTexture(this._gl["TEXTURE"+n]),this._bindTextureDirectly(this._gl.TEXTURE_2D,t))},i.prototype.setTextureFromPostProcess=function(n,t){this._bindTexture(n,t._textures.data[t._currentRenderTextureInd])},i.prototype.unbindAllTextures=function(){for(var n=0;n<this._caps.maxTexturesImageUnits;n++)this.activateTexture(this._gl["TEXTURE"+n]),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)},i.prototype.setTexture=function(n,t,i){n<0||(this._gl.uniform1i(t,n),this._setTexture(n,i))},i.prototype._setTexture=function(t,r){var f,u,e;if(!r||!r.isReady())return void(null!=this._activeTexturesCache[t]&&(this.activateTexture(this._gl["TEXTURE"+t]),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)));if(f=!1,r instanceof n.VideoTexture)this.activateTexture(this._gl["TEXTURE"+t]),f=!0,r.update();else if(r.delayLoadState===i.DELAYLOADSTATE_NOTLOADED)return void r.delayLoad();if(u=r.getInternalTexture(),this._activeTexturesCache[t]!==u)if(f||this.activateTexture(this._gl["TEXTURE"+t]),u.isCube)(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,u),u._cachedCoordinatesMode!==r.coordinatesMode)&&(u._cachedCoordinatesMode=r.coordinatesMode,e=r.coordinatesMode!==n.Texture.CUBIC_MODE&&r.coordinatesMode!==n.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE,this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,e),this._gl.texParameteri(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,e)),this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,r);else{if(this._bindTextureDirectly(this._gl.TEXTURE_2D,u),u._cachedWrapU!==r.wrapU)switch(u._cachedWrapU=r.wrapU,r.wrapU){case n.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.REPEAT);break;case n.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE);break;case n.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.MIRRORED_REPEAT)}if(u._cachedWrapV!==r.wrapV)switch(u._cachedWrapV=r.wrapV,r.wrapV){case n.Texture.WRAP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.REPEAT);break;case n.Texture.CLAMP_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);break;case n.Texture.MIRROR_ADDRESSMODE:this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.MIRRORED_REPEAT)}this._setAnisotropicLevel(this._gl.TEXTURE_2D,r)}},i.prototype.setTextureArray=function(n,t,i){var r,u;if(!(n<0)){for(this._textureUnits&&this._textureUnits.length===i.length||(this._textureUnits=new Int32Array(i.length)),r=0;r<i.length;r++)this._textureUnits[r]=n+r;for(this._gl.uniform1iv(t,this._textureUnits),u=0;u<i.length;u++)this._setTexture(n+u,i[u])}},i.prototype._setAnisotropicLevel=function(t,i){var u=this._caps.textureAnisotropicFilterExtension,r=i.anisotropicFilteringLevel;i.getInternalTexture().samplingMode===n.Texture.NEAREST_SAMPLINGMODE&&(r=1);u&&i._cachedAnisotropicFilteringLevel!==r&&(this._gl.texParameterf(t,u.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r,this._caps.maxAnisotropy)),i._cachedAnisotropicFilteringLevel=r)},i.prototype.readPixels=function(n,t,i,r){var u=new Uint8Array(r*i*4);return this._gl.readPixels(n,t,i,r,this._gl.RGBA,this._gl.UNSIGNED_BYTE,u),u},i.prototype.addExternalData=function(n,t){return this._externalData.add(n,t)},i.prototype.getExternalData=function(n){return this._externalData.get(n)},i.prototype.getOrAddExternalDataWithFactory=function(n,t){return this._externalData.getOrAddWithFactory(n,t)},i.prototype.removeExternalData=function(n){return this._externalData.remove(n)},i.prototype.releaseInternalTexture=function(n){if(n&&(n.references--,0===n.references)){var t=this.getLoadedTexturesCache(),i=t.indexOf(n);i>-1&&t.splice(i,1);this._releaseTexture(n)}},i.prototype.unbindAllAttributes=function(){for(var n=0,t=this._vertexAttribArraysEnabled.length;n<t;n++)n>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[n]||(this._gl.disableVertexAttribArray(n),this._vertexAttribArraysEnabled[n]=!1)},i.prototype.dispose=function(){for(this.hideLoadingUI(),this.stopRenderLoop();this.scenes.length;)this.scenes[0].dispose();i.audioEngine.dispose();for(var n in this._compiledEffects)this._gl.deleteProgram(this._compiledEffects[n]._program);this.unbindAllAttributes();this._gl=null;this.disableVR();window.removeEventListener("blur",this._onBlur);window.removeEventListener("focus",this._onFocus);document.removeEventListener("fullscreenchange",this._onFullscreenChange);document.removeEventListener("mozfullscreenchange",this._onFullscreenChange);document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange);document.removeEventListener("msfullscreenchange",this._onFullscreenChange);document.removeEventListener("pointerlockchange",this._onPointerLockChange);document.removeEventListener("mspointerlockchange",this._onPointerLockChange);document.removeEventListener("mozpointerlockchange",this._onPointerLockChange);document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange)},i.prototype.displayLoadingUI=function(){this._loadingScreen.displayLoadingUI()},i.prototype.hideLoadingUI=function(){this._loadingScreen.hideLoadingUI()},Object.defineProperty(i.prototype,"loadingScreen",{get:function(){return this._loadingScreen},set:function(n){this._loadingScreen=n},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"loadingUIText",{set:function(n){this._loadingScreen.loadingUIText=n},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"loadingUIBackgroundColor",{set:function(n){this._loadingScreen.loadingUIBackgroundColor=n},enumerable:!0,configurable:!0}),i.prototype.attachContextLostEvent=function(n){this._renderingCanvas.addEventListener("webglcontextlost",n,!1)},i.prototype.attachContextRestoredEvent=function(n){this._renderingCanvas.addEventListener("webglcontextrestored",n,!1)},i.prototype.getVertexShaderSource=function(n){var t=this._gl.getAttachedShaders(n);return this._gl.getShaderSource(t[0])},i.prototype.getFragmentShaderSource=function(n){var t=this._gl.getAttachedShaders(n);return this._gl.getShaderSource(t[1])},i.prototype.getFps=function(){return this.fps},i.prototype.getDeltaTime=function(){return this.deltaTime},i.prototype._measureFps=function(){var t,r,i;if(this.previousFramesDuration.push(n.Tools.Now),t=this.previousFramesDuration.length,t>=2&&(this.deltaTime=this.previousFramesDuration[t-1]-this.previousFramesDuration[t-2]),t>=this.fpsRange){for(t>this.fpsRange&&(this.previousFramesDuration.splice(0,1),t=this.previousFramesDuration.length),r=0,i=0;i<t-1;i++)r+=this.previousFramesDuration[i+1]-this.previousFramesDuration[i];this.fps=1e3/(r/(t-1))}},i.prototype._canRenderToFloatTexture=function(){return this._canRenderToTextureOfType(n.Engine.TEXTURETYPE_FLOAT,"OES_texture_float")},i.prototype._canRenderToHalfFloatTexture=function(){return this._canRenderToTextureOfType(n.Engine.TEXTURETYPE_HALF_FLOAT,"OES_texture_half_float")},i.prototype._canRenderToTextureOfType=function(t,i){var e=document.createElement("canvas"),r,v,h,f,a,c,w,u;if(e.height=16,e.width=16,r=e.getContext("webgl")||e.getContext("experimental-webgl"),v=r.getExtension(i),!v)return!1;var s=this.createShaderProgram("attribute vec4 a_position;\n                void main() {\n                    gl_Position = a_position;\n                }","precision mediump float;\n                uniform vec4 u_color;\n                uniform sampler2D u_texture;\n\n                void main() {\n                    gl_FragColor = texture2D(u_texture, vec2(0.5, 0.5)) * u_color;\n                }",null,r);r.useProgram(s);var l=r.getAttribLocation(s,"a_position"),y=r.getUniformLocation(s,"u_color"),p=r.createBuffer();return(r.bindBuffer(r.ARRAY_BUFFER,p),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),r.STATIC_DRAW),r.enableVertexAttribArray(l),r.vertexAttribPointer(l,2,r.FLOAT,!1,0,0),h=r.createTexture(),r.bindTexture(r.TEXTURE_2D,h),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,r.UNSIGNED_BYTE,new Uint8Array([255,255,255,255])),f=r.createTexture(),r.bindTexture(r.TEXTURE_2D,f),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,1,1,0,r.RGBA,o(r,t),null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),a=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,a),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,f,0),c=function(){r.deleteProgram(s);r.disableVertexAttribArray(l);r.deleteBuffer(p);r.deleteFramebuffer(a);r.deleteTexture(h);r.deleteTexture(f)},w=r.checkFramebufferStatus(r.FRAMEBUFFER),w!==r.FRAMEBUFFER_COMPLETE)?(n.Tools.Log("GL Support: can **NOT** render to "+t+" texture"),c(),!1):(r.bindTexture(r.TEXTURE_2D,h),r.uniform4fv(y,[0,10,20,1]),r.drawArrays(r.TRIANGLES,0,6),r.bindTexture(r.TEXTURE_2D,f),r.bindFramebuffer(r.FRAMEBUFFER,null),r.clearColor(1,0,0,1),r.clear(r.COLOR_BUFFER_BIT),r.uniform4fv(y,[0,.1,.05,1]),r.drawArrays(r.TRIANGLES,0,6),u=new Uint8Array(4),r.readPixels(0,0,1,1,r.RGBA,r.UNSIGNED_BYTE,u),0!==u[0]||u[1]<248||u[2]<248||u[3]<254?(n.Tools.Log("GL Support: Was not able to actually render to "+t+" texture"),c(),!1):(c(),!0))},i.isSupported=function(){try{if(navigator.isCocoonJS)return!0;var n=document.createElement("canvas"),t=n.getContext("webgl")||n.getContext("experimental-webgl");return null!=t&&!!window.WebGLRenderingContext}catch(i){return!1}},i._ALPHA_DISABLE=0,i._ALPHA_ADD=1,i._ALPHA_COMBINE=2,i._ALPHA_SUBTRACT=3,i._ALPHA_MULTIPLY=4,i._ALPHA_MAXIMIZED=5,i._ALPHA_ONEONE=6,i._DELAYLOADSTATE_NONE=0,i._DELAYLOADSTATE_LOADED=1,i._DELAYLOADSTATE_LOADING=2,i._DELAYLOADSTATE_NOTLOADED=4,i._TEXTUREFORMAT_ALPHA=0,i._TEXTUREFORMAT_LUMINANCE=1,i._TEXTUREFORMAT_LUMINANCE_ALPHA=2,i._TEXTUREFORMAT_RGB=4,i._TEXTUREFORMAT_RGBA=5,i._TEXTURETYPE_UNSIGNED_INT=0,i._TEXTURETYPE_FLOAT=1,i._TEXTURETYPE_HALF_FLOAT=2,i._NEVER=512,i._ALWAYS=519,i._LESS=513,i._EQUAL=514,i._LEQUAL=515,i._GREATER=516,i._GEQUAL=518,i._NOTEQUAL=517,i._KEEP=7680,i._REPLACE=7681,i._INCR=7682,i._DECR=7683,i._INVERT=5386,i._INCR_WRAP=34055,i._DECR_WRAP=34056,i.CollisionsEpsilon=.001,i.CodeRepository="src/",i.ShadersRepository="src/Shaders/",i}();n.Engine=i}(i||(i={}));!function(n){var t=function(){function t(t,i){this.state="";this.metadata=null;this.doNotSerialize=!1;this.animations=[];this._ranges={};this._childrenFlag=-1;this._isEnabled=!0;this._isReady=!0;this._currentRenderId=-1;this._parentRenderId=-1;this.onDisposeObservable=new n.Observable;this.name=t;this.id=t;this._scene=i;this._initCache()}return Object.defineProperty(t.prototype,"parent",{get:function(){return this._parentNode},set:function(n){if(this._parentNode!==n){if(this._parentNode){var t=this._parentNode._children.indexOf(this);t!==-1&&this._parentNode._children.splice(t,1)}this._parentNode=n;this._parentNode&&(this._parentNode._children||(this._parentNode._children=[]),this._parentNode._children.push(this))}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getEngine=function(){return this._scene.getEngine()},t.prototype.getWorldMatrix=function(){return n.Matrix.Identity()},t.prototype._initCache=function(){this._cache={};this._cache.parent=void 0},t.prototype.updateCache=function(n){!n&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())},t.prototype._updateCache=function(){},t.prototype._isSynchronized=function(){return!0},t.prototype._markSyncedWithParent=function(){this._parentRenderId=this.parent._currentRenderId},t.prototype.isSynchronizedWithParent=function(){return!this.parent||this._parentRenderId===this.parent._currentRenderId&&this.parent.isSynchronized()},t.prototype.isSynchronized=function(n){var t=this.hasNewParent();return t=t||!this.isSynchronizedWithParent(),t=t||!this._isSynchronized(),n&&this.updateCache(!0),!t},t.prototype.hasNewParent=function(n){return this._cache.parent!==this.parent&&(n&&(this._cache.parent=this.parent),!0)},t.prototype.isReady=function(){return this._isReady},t.prototype.isEnabled=function(){return!!this._isEnabled&&(!this.parent||this.parent.isEnabled())},t.prototype.setEnabled=function(n){this._isEnabled=n},t.prototype.isDescendantOf=function(n){return!!this.parent&&(this.parent===n||this.parent.isDescendantOf(n))},t.prototype._getDescendants=function(n,t,i){var r,u;if(void 0===t&&(t=!1),this._children)for(r=0;r<this._children.length;r++)u=this._children[r],i&&!i(u)||n.push(u),t||u._getDescendants(n,!1,i)},t.prototype.getDescendants=function(n,t){var i=[];return this._getDescendants(i,n,t),i},t.prototype.getChildren=function(n){return this.getDescendants(!0,n)},t.prototype.getChildMeshes=function(t,i){var r=[];return this._getDescendants(r,t,function(t){return(!i||i(t))&&t instanceof n.AbstractMesh}),r},t.prototype._setReady=function(n){if(n!==this._isReady){if(!n)return void(this._isReady=!1);this._isReady=!0;this.onReady&&this.onReady(this)}},t.prototype.getAnimationByName=function(n){for(var i,t=0;t<this.animations.length;t++)if(i=this.animations[t],i.name===n)return i;return null},t.prototype.createAnimationRange=function(t,i,r){if(!this._ranges[t]){this._ranges[t]=new n.AnimationRange(t,i,r);for(var u=0,f=this.animations.length;u<f;u++)this.animations[u]&&this.animations[u].createRange(t,i,r)}},t.prototype.deleteAnimationRange=function(n,t){void 0===t&&(t=!0);for(var i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(n,t);this._ranges[n]=void 0},t.prototype.getAnimationRange=function(n){return this._ranges[n]},t.prototype.beginAnimation=function(n,t,i,r){var u=this.getAnimationRange(n);return u?void this._scene.beginAnimation(this,u.from,u.to,t,i,r):null},t.prototype.serializeAnimationRanges=function(){var i=[],t,n;for(t in this._ranges)n={},n.name=t,n.from=this._ranges[t].from,n.to=this._ranges[t].to,i.push(n);return i},t.prototype.dispose=function(){this.parent=null;this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()},t.ParseAnimationRanges=function(n,t){var i,r;if(t.ranges)for(i=0;i<t.ranges.length;i++)r=t.ranges[i],n.createAnimationRange(r.name,r.from,r.to)},r([n.serialize()],t.prototype,"name",void 0),r([n.serialize()],t.prototype,"id",void 0),r([n.serialize()],t.prototype,"uniqueId",void 0),r([n.serialize()],t.prototype,"state",void 0),r([n.serialize()],t.prototype,"metadata",void 0),t}();n.Node=t}(i||(i={}));!function(n){var t=function(){function t(n,t,i,r,u,f,e,o){this._engine=n;this._canvas=i;this._currentScene=t;this._sceneLoadedCallback=r;this._progressCallback=u;this._additionnalRenderLoopLogicCallback=f;this._textureLoadingCallback=e;this._startingProcessingFilesCallback=o}return t.prototype.monitorElementForDragNDrop=function(n){var t=this;n&&(this._elementToMonitor=n,this._elementToMonitor.addEventListener("dragenter",function(n){t.drag(n)},!1),this._elementToMonitor.addEventListener("dragover",function(n){t.drag(n)},!1),this._elementToMonitor.addEventListener("drop",function(n){t.drop(n)},!1))},t.prototype.renderFunction=function(){if(this._additionnalRenderLoopLogicCallback&&this._additionnalRenderLoopLogicCallback(),this._currentScene){if(this._textureLoadingCallback){var n=this._currentScene.getWaitingItemsCount();n>0&&this._textureLoadingCallback(n)}this._currentScene.render()}},t.prototype.drag=function(n){n.stopPropagation();n.preventDefault()},t.prototype.drop=function(n){n.stopPropagation();n.preventDefault();this.loadFiles(n)},t.prototype.loadFiles=function(n){if(this._startingProcessingFilesCallback&&this._startingProcessingFilesCallback(),n&&n.dataTransfer&&n.dataTransfer.files&&(this._filesToLoad=n.dataTransfer.files),n&&n.target&&n.target.files&&(this._filesToLoad=n.target.files),this._filesToLoad&&this._filesToLoad.length>0){for(var i=0;i<this._filesToLoad.length;i++)switch(this._filesToLoad[i].type){case"image/jpeg":case"image/png":case"image/bmp":t.FilesTextures[this._filesToLoad[i].name.toLowerCase()]=this._filesToLoad[i];break;case"image/targa":case"image/vnd.ms-dds":case"audio/wav":case"audio/x-wav":case"audio/mp3":case"audio/mpeg":case"audio/mpeg3":case"audio/x-mpeg-3":case"audio/ogg":t.FilesToLoad[this._filesToLoad[i].name.toLowerCase()]=this._filesToLoad[i];break;default:this._filesToLoad[i].name.indexOf(".mtl")!==-1?t.FilesToLoad[this._filesToLoad[i].name.toLowerCase()]=this._filesToLoad[i]:this._filesToLoad[i].name.indexOf(".babylon")===-1&&this._filesToLoad[i].name.indexOf(".stl")===-1&&this._filesToLoad[i].name.indexOf(".obj")===-1||this._filesToLoad[i].name.indexOf(".manifest")!==-1||this._filesToLoad[i].name.indexOf(".incremental")!==-1||this._filesToLoad[i].name.indexOf(".babylonmeshdata")!==-1||this._filesToLoad[i].name.indexOf(".babylongeometrydata")!==-1||this._filesToLoad[i].name.indexOf(".babylonbinarymeshdata")!==-1||this._filesToLoad[i].name.indexOf(".binary.babylon")!==-1||(this._sceneFileToLoad=this._filesToLoad[i])}this.reload()}},t.prototype.reload=function(){var i=this,t=this;this._sceneFileToLoad?(this._currentScene&&(n.Tools.errorsCount>0&&(n.Tools.ClearLogCache(),n.Tools.Log("Babylon.js engine (v"+n.Engine.Version+") launched")),this._engine.stopRenderLoop(),this._currentScene.dispose()),n.SceneLoader.Load("file:",this._sceneFileToLoad,this._engine,function(n){t._currentScene=n;t._currentScene.executeWhenReady(function(){t._currentScene.activeCamera&&0!==t._currentScene.lights.length||t._currentScene.createDefaultCameraOrLight();t._currentScene.activeCamera.attachControl(t._canvas);t._sceneLoadedCallback&&t._sceneLoadedCallback(i._sceneFileToLoad,t._currentScene);t._engine.runRenderLoop(function(){t.renderFunction()})})},function(n){i._progressCallback&&i._progressCallback(n)})):n.Tools.Error("Please provide a valid .babylon file.")},t.FilesTextures=[],t.FilesToLoad=[],t}();n.FilesInput=t}(i||(i={}));!function(n){var i=function(){function n(n,t,i){this.bu=n;this.bv=t;this.distance=i;this.faceId=0;this.subMeshId=0}return n}(),t;n.IntersectionInfo=i;t=function(){function t(){this.hit=!1;this.distance=0;this.pickedPoint=null;this.pickedMesh=null;this.bu=0;this.bv=0;this.faceId=-1;this.subMeshId=0;this.pickedSprite=null}return t.prototype.getNormal=function(t,i){var u,r;if(void 0===t&&(t=!1),void 0===i&&(i=!0),!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(n.VertexBuffer.NormalKind))return null;if(r=this.pickedMesh.getIndices(),i){var s=this.pickedMesh.getVerticesData(n.VertexBuffer.NormalKind),f=n.Vector3.FromArray(s,3*r[3*this.faceId]),e=n.Vector3.FromArray(s,3*r[3*this.faceId+1]),o=n.Vector3.FromArray(s,3*r[3*this.faceId+2]);f=f.scale(this.bu);e=e.scale(this.bv);o=o.scale(1-this.bu-this.bv);u=new n.Vector3(f.x+e.x+o.x,f.y+e.y+o.y,f.z+e.z+o.z)}else{var h=this.pickedMesh.getVerticesData(n.VertexBuffer.PositionKind),l=n.Vector3.FromArray(h,3*r[3*this.faceId]),c=n.Vector3.FromArray(h,3*r[3*this.faceId+1]),a=n.Vector3.FromArray(h,3*r[3*this.faceId+2]),v=l.subtract(c),y=a.subtract(c);u=n.Vector3.Cross(v,y)}return t&&(u=n.Vector3.TransformNormal(u,this.pickedMesh.getWorldMatrix())),n.Vector3.Normalize(u)},t.prototype.getTextureCoordinates=function(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(n.VertexBuffer.UVKind))return null;var u=this.pickedMesh.getIndices(),f=this.pickedMesh.getVerticesData(n.VertexBuffer.UVKind),t=n.Vector2.FromArray(f,2*u[3*this.faceId]),i=n.Vector2.FromArray(f,2*u[3*this.faceId+1]),r=n.Vector2.FromArray(f,2*u[3*this.faceId+2]);return t=t.scale(1-this.bu-this.bv),i=i.scale(this.bu),r=r.scale(this.bv),new n.Vector2(t.x+i.x+r.x,t.y+i.y+r.y)},t}();n.PickingInfo=t}(i||(i={}));!function(n){var t=function(){function t(t,i){this.minimum=t;this.maximum=i;this._tempRadiusVector=n.Vector3.Zero();var r=n.Vector3.Distance(t,i);this.center=n.Vector3.Lerp(t,i,.5);this.radius=.5*r;this.centerWorld=n.Vector3.Zero();this._update(n.Matrix.Identity())}return t.prototype._update=function(t){n.Vector3.TransformCoordinatesToRef(this.center,t,this.centerWorld);n.Vector3.TransformNormalFromFloatsToRef(1,1,1,t,this._tempRadiusVector);this.radiusWorld=Math.max(Math.abs(this._tempRadiusVector.x),Math.abs(this._tempRadiusVector.y),Math.abs(this._tempRadiusVector.z))*this.radius},t.prototype.isInFrustum=function(n){for(var t=0;t<6;t++)if(n[t].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return!1;return!0},t.prototype.intersectsPoint=function(t){var i=this.centerWorld.x-t.x,r=this.centerWorld.y-t.y,u=this.centerWorld.z-t.z,f=Math.sqrt(i*i+r*r+u*u);return!(Math.abs(this.radiusWorld-f)<n.Epsilon)},t.Intersects=function(n,t){var i=n.centerWorld.x-t.centerWorld.x,r=n.centerWorld.y-t.centerWorld.y,u=n.centerWorld.z-t.centerWorld.z,f=Math.sqrt(i*i+r*r+u*u);return!(n.radiusWorld+t.radiusWorld<f)},t}();n.BoundingSphere=t}(i||(i={}));!function(n){var t=function(){function t(t,i){this.minimum=t;this.maximum=i;this.vectors=[];this.vectorsWorld=[];this.vectors.push(this.minimum.clone());this.vectors.push(this.maximum.clone());this.vectors.push(this.minimum.clone());this.vectors[2].x=this.maximum.x;this.vectors.push(this.minimum.clone());this.vectors[3].y=this.maximum.y;this.vectors.push(this.minimum.clone());this.vectors[4].z=this.maximum.z;this.vectors.push(this.maximum.clone());this.vectors[5].z=this.minimum.z;this.vectors.push(this.maximum.clone());this.vectors[6].x=this.minimum.x;this.vectors.push(this.maximum.clone());this.vectors[7].y=this.minimum.y;this.center=this.maximum.add(this.minimum).scale(.5);this.extendSize=this.maximum.subtract(this.minimum).scale(.5);this.directions=[n.Vector3.Zero(),n.Vector3.Zero(),n.Vector3.Zero()];for(var r=0;r<this.vectors.length;r++)this.vectorsWorld[r]=n.Vector3.Zero();this.minimumWorld=n.Vector3.Zero();this.maximumWorld=n.Vector3.Zero();this._update(n.Matrix.Identity())}return t.prototype.getWorldMatrix=function(){return this._worldMatrix},t.prototype.setWorldMatrix=function(n){return this._worldMatrix.copyFrom(n),this},t.prototype._update=function(t){var r,i;for(n.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld),n.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld),r=0;r<this.vectors.length;r++)i=this.vectorsWorld[r],n.Vector3.TransformCoordinatesToRef(this.vectors[r],t,i),i.x<this.minimumWorld.x&&(this.minimumWorld.x=i.x),i.y<this.minimumWorld.y&&(this.minimumWorld.y=i.y),i.z<this.minimumWorld.z&&(this.minimumWorld.z=i.z),i.x>this.maximumWorld.x&&(this.maximumWorld.x=i.x),i.y>this.maximumWorld.y&&(this.maximumWorld.y=i.y),i.z>this.maximumWorld.z&&(this.maximumWorld.z=i.z);this.maximumWorld.addToRef(this.minimumWorld,this.center);this.center.scaleInPlace(.5);n.Vector3.FromFloatArrayToRef(t.m,0,this.directions[0]);n.Vector3.FromFloatArrayToRef(t.m,4,this.directions[1]);n.Vector3.FromFloatArrayToRef(t.m,8,this.directions[2]);this._worldMatrix=t},t.prototype.isInFrustum=function(n){return t.IsInFrustum(this.vectorsWorld,n)},t.prototype.isCompletelyInFrustum=function(n){return t.IsCompletelyInFrustum(this.vectorsWorld,n)},t.prototype.intersectsPoint=function(t){var i=-n.Epsilon;return!(this.maximumWorld.x-t.x<i||i>t.x-this.minimumWorld.x)&&!(this.maximumWorld.y-t.y<i||i>t.y-this.minimumWorld.y)&&!(this.maximumWorld.z-t.z<i||i>t.z-this.minimumWorld.z)},t.prototype.intersectsSphere=function(n){return t.IntersectsSphere(this.minimumWorld,this.maximumWorld,n.centerWorld,n.radiusWorld)},t.prototype.intersectsMinMax=function(n,t){return!(this.maximumWorld.x<n.x||this.minimumWorld.x>t.x)&&!(this.maximumWorld.y<n.y||this.minimumWorld.y>t.y)&&!(this.maximumWorld.z<n.z||this.minimumWorld.z>t.z)},t.Intersects=function(n,t){return!(n.maximumWorld.x<t.minimumWorld.x||n.minimumWorld.x>t.maximumWorld.x)&&!(n.maximumWorld.y<t.minimumWorld.y||n.minimumWorld.y>t.maximumWorld.y)&&!(n.maximumWorld.z<t.minimumWorld.z||n.minimumWorld.z>t.maximumWorld.z)},t.IntersectsSphere=function(t,i,r,u){var f=n.Vector3.Clamp(r,t,i),e=n.Vector3.DistanceSquared(r,f);return e<=u*u},t.IsCompletelyInFrustum=function(n,t){for(var r,i=0;i<6;i++)for(r=0;r<8;r++)if(t[i].dotCoordinate(n[r])<0)return!1;return!0},t.IsInFrustum=function(n,t){for(var u,r,i=0;i<6;i++){for(u=8,r=0;r<8&&t[i].dotCoordinate(n[r])<0;r++)--u;if(0===u)return!1}return!0},t}();n.BoundingBox=t}(i||(i={}));!function(n){var i=function(t,i){var r=n.Vector3.Dot(i.center,t),f=Math.abs(n.Vector3.Dot(i.directions[0],t))*i.extendSize.x,e=Math.abs(n.Vector3.Dot(i.directions[1],t))*i.extendSize.y,o=Math.abs(n.Vector3.Dot(i.directions[2],t))*i.extendSize.z,u=f+e+o;return{min:r-u,max:r+u}},r=function(n,t,i,r){return!(n>r||i>t)},t=function(n,t,u){var f=i(n,t),e=i(n,u);return r(f.min,f.max,e.min,e.max)},u=function(){function i(t,i){this.minimum=t;this.maximum=i;this._isLocked=!1;this.boundingBox=new n.BoundingBox(t,i);this.boundingSphere=new n.BoundingSphere(t,i)}return Object.defineProperty(i.prototype,"isLocked",{get:function(){return this._isLocked},set:function(n){this._isLocked=n},enumerable:!0,configurable:!0}),i.prototype.update=function(n){this._isLocked||(this.boundingBox._update(n),this.boundingSphere._update(n))},i.prototype.isInFrustum=function(n){return!!this.boundingSphere.isInFrustum(n)&&this.boundingBox.isInFrustum(n)},i.prototype.isCompletelyInFrustum=function(n){return this.boundingBox.isCompletelyInFrustum(n)},i.prototype._checkCollision=function(n){return n._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},i.prototype.intersectsPoint=function(n){return!!this.boundingSphere.centerWorld&&!!this.boundingSphere.intersectsPoint(n)&&!!this.boundingBox.intersectsPoint(n)},i.prototype.intersects=function(i,r){if(!this.boundingSphere.centerWorld||!i.boundingSphere.centerWorld||!n.BoundingSphere.Intersects(this.boundingSphere,i.boundingSphere)||!n.BoundingBox.Intersects(this.boundingBox,i.boundingBox))return!1;if(!r)return!0;var u=this.boundingBox,f=i.boundingBox;return!!t(u.directions[0],u,f)&&!!t(u.directions[1],u,f)&&!!t(u.directions[2],u,f)&&!!t(f.directions[0],u,f)&&!!t(f.directions[1],u,f)&&!!t(f.directions[2],u,f)&&!!t(n.Vector3.Cross(u.directions[0],f.directions[0]),u,f)&&!!t(n.Vector3.Cross(u.directions[0],f.directions[1]),u,f)&&!!t(n.Vector3.Cross(u.directions[0],f.directions[2]),u,f)&&!!t(n.Vector3.Cross(u.directions[1],f.directions[0]),u,f)&&!!t(n.Vector3.Cross(u.directions[1],f.directions[1]),u,f)&&!!t(n.Vector3.Cross(u.directions[1],f.directions[2]),u,f)&&!!t(n.Vector3.Cross(u.directions[2],f.directions[0]),u,f)&&!!t(n.Vector3.Cross(u.directions[2],f.directions[1]),u,f)&&!!t(n.Vector3.Cross(u.directions[2],f.directions[2]),u,f)},i}();n.BoundingInfo=u}(i||(i={}));!function(n){var t=function(){function t(n,t,i){void 0===i&&(i=Number.MAX_VALUE);this.origin=n;this.direction=t;this.length=i;this._show=!1}return t.prototype.intersectsBoxMinMax=function(n,t){var u,r,i,o,f=0,e=Number.MAX_VALUE;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<n.x||this.origin.x>t.x)return!1}else if(u=1/this.direction.x,r=(n.x-this.origin.x)*u,i=(t.x-this.origin.x)*u,i===-(1/0)&&(i=1/0),r>i&&(o=r,r=i,i=o),f=Math.max(r,f),e=Math.min(i,e),f>e)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<n.y||this.origin.y>t.y)return!1}else if(u=1/this.direction.y,r=(n.y-this.origin.y)*u,i=(t.y-this.origin.y)*u,i===-(1/0)&&(i=1/0),r>i&&(o=r,r=i,i=o),f=Math.max(r,f),e=Math.min(i,e),f>e)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<n.z||this.origin.z>t.z)return!1}else if(u=1/this.direction.z,r=(n.z-this.origin.z)*u,i=(t.z-this.origin.z)*u,i===-(1/0)&&(i=1/0),r>i&&(o=r,r=i,i=o),f=Math.max(r,f),e=Math.min(i,e),f>e)return!1;return!0},t.prototype.intersectsBox=function(n){return this.intersectsBoxMinMax(n.minimum,n.maximum)},t.prototype.intersectsSphere=function(n){var i=n.center.x-this.origin.x,r=n.center.y-this.origin.y,u=n.center.z-this.origin.z,f=i*i+r*r+u*u,e=n.radius*n.radius,t,o;return f<=e?!0:(t=i*this.direction.x+r*this.direction.y+u*this.direction.z,t<0)?!1:(o=f-t*t,o<=e)},t.prototype.intersectsTriangle=function(t,i,r){var o,f,u,e,s;return(this._edge1||(this._edge1=n.Vector3.Zero(),this._edge2=n.Vector3.Zero(),this._pvec=n.Vector3.Zero(),this._tvec=n.Vector3.Zero(),this._qvec=n.Vector3.Zero()),i.subtractToRef(t,this._edge1),r.subtractToRef(t,this._edge2),n.Vector3.CrossToRef(this.direction,this._edge2,this._pvec),o=n.Vector3.Dot(this._edge1,this._pvec),0===o)?null:(f=1/o,this.origin.subtractToRef(t,this._tvec),u=n.Vector3.Dot(this._tvec,this._pvec)*f,u<0||u>1)?null:(n.Vector3.CrossToRef(this._tvec,this._edge1,this._qvec),e=n.Vector3.Dot(this.direction,this._qvec)*f,e<0||u+e>1)?null:(s=n.Vector3.Dot(this._edge2,this._qvec)*f,s>this.length?null:new n.IntersectionInfo(u,e,s))},t.prototype.intersectsPlane=function(t){var i,r=n.Vector3.Dot(t.normal,this.direction),u;return Math.abs(r)<999999997475243e-21?null:(u=n.Vector3.Dot(t.normal,this.origin),i=(-t.d-u)/r,i<0?i<-999999997475243e-21?null:0:i)},t.prototype.intersectsMesh=function(i,r){var u=n.Tmp.Matrix[0];return i.getWorldMatrix().invertToRef(u),this._tmpRay?t.TransformToRef(this,u,this._tmpRay):this._tmpRay=t.Transform(this,u),i.intersects(this._tmpRay,r)},t.prototype.show=function(t,i){this._show||(this._renderFunction=this._render.bind(this),this._show=!0,this._scene=t,this._renderPoints=[this.origin,this.origin.add(this.direction.scale(this.length))],this._renderLine=n.Mesh.CreateLines("ray",this._renderPoints,t,!0),this._scene.registerBeforeRender(this._renderFunction));i&&this._renderLine.color.copyFrom(i)},t.prototype.hide=function(){this._show&&(this._show=!1,this._scene.unregisterBeforeRender(this._renderFunction));this._renderLine&&(this._renderLine.dispose(),this._renderLine=null,this._renderPoints=null)},t.prototype._render=function(){var t=this._renderPoints[1];t.copyFrom(this.direction);t.scaleInPlace(this.length);t.addInPlace(this.origin);n.Mesh.CreateLines("ray",this._renderPoints,this._scene,!0,this._renderLine)},t.prototype.intersectionSegment=function(i,r,u){var b,f,c,e,nt=this.origin.add(this.direction.multiplyByFloats(t.rayl,t.rayl,t.rayl)),v=r.subtract(i),y=nt.subtract(this.origin),k=i.subtract(this.origin),l=n.Vector3.Dot(v,v),o=n.Vector3.Dot(v,y),p=n.Vector3.Dot(y,y),s=n.Vector3.Dot(v,k),w=n.Vector3.Dot(y,k),d=l*p-o*o,h=d,a=d;d<t.smallnum?(f=0,h=1,e=w,a=p):(f=o*w-p*s,e=l*w-o*s,f<0?(f=0,e=w,a=p):f>h&&(f=h,e=w+o,a=p));e<0?(e=0,-s<0?f=0:-s>l?f=h:(f=-s,h=l)):e>a&&(e=a,-s+o<0?f=0:-s+o>l?f=h:(f=-s+o,h=l));b=Math.abs(f)<t.smallnum?0:f/h;c=Math.abs(e)<t.smallnum?0:e/a;var g=y.multiplyByFloats(c,c,c),tt=k.add(v.multiplyByFloats(b,b,b)).subtract(g),it=c>0&&c<=this.length&&tt.lengthSquared()<u*u;return it?g.length():-1},t.CreateNew=function(i,r,u,f,e,o,s){var h=n.Vector3.Unproject(new n.Vector3(i,r,0),u,f,e,o,s),l=n.Vector3.Unproject(new n.Vector3(i,r,1),u,f,e,o,s),c=l.subtract(h);return c.normalize(),new t(h,c)},t.CreateNewFromTo=function(i,r,u){void 0===u&&(u=n.Matrix.Identity());var f=r.subtract(i),e=Math.sqrt(f.x*f.x+f.y*f.y+f.z*f.z);return f.normalize(),t.Transform(new t(i,f,e),u)},t.Transform=function(i,r){var f=n.Vector3.TransformCoordinates(i.origin,r),u=n.Vector3.TransformNormal(i.direction,r);return u.normalize(),new t(f,u,i.length)},t.TransformToRef=function(t,i,r){n.Vector3.TransformCoordinatesToRef(t.origin,i,r.origin);n.Vector3.TransformNormalToRef(t.direction,i,r.direction);t.direction.normalize()},t.smallnum=1e-8,t.rayl=1e9,t}();n.Ray=t}(i||(i={}));!function(n){var t=function(t){function i(r,u){var f=this;t.call(this,r,u);this.onCollideObservable=new n.Observable;this.onCollisionPositionChangeObservable=new n.Observable;this.onAfterWorldMatrixUpdateObservable=new n.Observable;this.definedFacingForward=!0;this.position=new n.Vector3(0,0,0);this._rotation=new n.Vector3(0,0,0);this._scaling=new n.Vector3(1,1,1);this.billboardMode=i.BILLBOARDMODE_NONE;this.visibility=1;this.alphaIndex=Number.MAX_VALUE;this.infiniteDistance=!1;this.isVisible=!0;this.isPickable=!0;this.showBoundingBox=!1;this.showSubMeshesBoundingBox=!1;this.isBlocker=!1;this.renderingGroupId=0;this.receiveShadows=!1;this.renderOutline=!1;this.outlineColor=n.Color3.Red();this.outlineWidth=.02;this.renderOverlay=!1;this.overlayColor=n.Color3.Red();this.overlayAlpha=.5;this.hasVertexAlpha=!1;this.useVertexColors=!0;this.applyFog=!0;this.computeBonesUsingShaders=!0;this.scalingDeterminant=1;this.numBoneInfluencers=4;this.useOctreeForRenderingSelection=!0;this.useOctreeForPicking=!0;this.useOctreeForCollisions=!0;this.layerMask=268435455;this.alwaysSelectAsActiveMesh=!1;this._checkCollisions=!1;this.ellipsoid=new n.Vector3(.5,1,.5);this.ellipsoidOffset=new n.Vector3(0,0,0);this._collider=new n.Collider;this._oldPositionForCollisions=new n.Vector3(0,0,0);this._diffPositionForCollisions=new n.Vector3(0,0,0);this._newPositionForCollisions=new n.Vector3(0,0,0);this.edgesWidth=1;this.edgesColor=new n.Color4(1,0,0,1);this._localWorld=n.Matrix.Zero();this._worldMatrix=n.Matrix.Zero();this._rotateYByPI=n.Matrix.RotationY(Math.PI);this._absolutePosition=n.Vector3.Zero();this._collisionsTransformMatrix=n.Matrix.Zero();this._collisionsScalingMatrix=n.Matrix.Zero();this._isDirty=!1;this._pivotMatrix=n.Matrix.Identity();this._isDisposed=!1;this._renderId=0;this._intersectionsInProgress=[];this._isWorldMatrixFrozen=!1;this._unIndexed=!1;this._onCollisionPositionChange=function(t,i,r){void 0===r&&(r=null);f.getScene().workerCollisions&&i.multiplyInPlace(f._collider.radius);i.subtractToRef(f._oldPositionForCollisions,f._diffPositionForCollisions);f._diffPositionForCollisions.length()>n.Engine.CollisionsEpsilon&&f.position.addInPlace(f._diffPositionForCollisions);r&&f.onCollideObservable.notifyObservers(r);f.onCollisionPositionChangeObservable.notifyObservers(f.position)};u.addMesh(this)}return u(i,t),Object.defineProperty(i,"BILLBOARDMODE_NONE",{get:function(){return i._BILLBOARDMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_X",{get:function(){return i._BILLBOARDMODE_X},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_Y",{get:function(){return i._BILLBOARDMODE_Y},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_Z",{get:function(){return i._BILLBOARDMODE_Z},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BILLBOARDMODE_ALL",{get:function(){return i._BILLBOARDMODE_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onCollide",{set:function(n){this._onCollideObserver&&this.onCollideObservable.remove(this._onCollideObserver);this._onCollideObserver=this.onCollideObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onCollisionPositionChange",{set:function(n){this._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._onCollisionPositionChangeObserver);this._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._skeleton},set:function(n){this._skeleton&&this._skeleton.needInitialSkinMatrix&&this._skeleton._unregisterMeshWithPoseMatrix(this);n&&n.needInitialSkinMatrix&&n._registerMeshWithPoseMatrix(this);this._skeleton=n;this._skeleton||(this._bonesTransformMatrices=null)},enumerable:!0,configurable:!0}),i.prototype.toString=function(t){var i="Name: "+this.name+", isInstance: "+(this instanceof n.InstancedMesh?"YES":"NO");return i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0),this._skeleton&&(i+=", skeleton: "+this._skeleton.name),t&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingFreezeWorldMatrix?"YES":"NO")),i},Object.defineProperty(i.prototype,"rotation",{get:function(){return this._rotation},set:function(n){this._rotation=n},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaling",{get:function(){return this._scaling},set:function(n){this._scaling=n;this.physicsImpostor&&this.physicsImpostor.forceUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(n){this._rotationQuaternion=n;n&&this.rotation.length()&&this.rotation.copyFromFloats(0,0,0)},enumerable:!0,configurable:!0}),i.prototype.updatePoseMatrix=function(n){this._poseMatrix.copyFrom(n)},i.prototype.getPoseMatrix=function(){return this._poseMatrix},i.prototype.disableEdgesRendering=function(){void 0!==this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=void 0)},i.prototype.enableEdgesRendering=function(t,i){void 0===t&&(t=.95);void 0===i&&(i=!1);this.disableEdgesRendering();this._edgesRenderer=new n.EdgesRenderer(this,t,i)},Object.defineProperty(i.prototype,"isBlocked",{get:function(){return!1},enumerable:!0,configurable:!0}),i.prototype.getLOD=function(){return this},i.prototype.getTotalVertices=function(){return 0},i.prototype.getIndices=function(){return null},i.prototype.getVerticesData=function(){return null},i.prototype.isVerticesDataPresent=function(){return!1},i.prototype.getBoundingInfo=function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfo||this._updateBoundingInfo(),this._boundingInfo)},i.prototype.setBoundingInfo=function(n){this._boundingInfo=n},Object.defineProperty(i.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(n.VertexBuffer.MatricesIndicesKind)&&this.isVerticesDataPresent(n.VertexBuffer.MatricesWeightsKind)},enumerable:!0,configurable:!0}),i.prototype._preActivate=function(){},i.prototype._preActivateForIntermediateRendering=function(){},i.prototype._activate=function(n){this._renderId=n},i.prototype.getWorldMatrix=function(){return this._masterMesh?this._masterMesh.getWorldMatrix():(this._currentRenderId!==this.getScene().getRenderId()&&this.computeWorldMatrix(),this._worldMatrix)},Object.defineProperty(i.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"absolutePosition",{get:function(){return this._absolutePosition},enumerable:!0,configurable:!0}),i.prototype.freezeWorldMatrix=function(){this._isWorldMatrixFrozen=!1;this.computeWorldMatrix(!0);this._isWorldMatrixFrozen=!0},i.prototype.unfreezeWorldMatrix=function(){this._isWorldMatrixFrozen=!1;this.computeWorldMatrix(!0)},Object.defineProperty(i.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:!0,configurable:!0}),i.prototype.rotate=function(t,r,u){var f,e;t.normalize();this.rotationQuaternion||(this.rotationQuaternion=n.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation=n.Vector3.Zero());u&&u!==n.Space.LOCAL?(this.parent&&(e=this.parent.getWorldMatrix().clone(),e.invert(),t=n.Vector3.TransformNormal(t,e)),f=n.Quaternion.RotationAxisToRef(t,r,i._rotationAxisCache),f.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)):(f=n.Quaternion.RotationAxisToRef(t,r,i._rotationAxisCache),this.rotationQuaternion.multiplyToRef(f,this.rotationQuaternion))},i.prototype.translate=function(t,i,r){var u=t.scale(i),f;r&&r!==n.Space.LOCAL?this.setAbsolutePosition(this.getAbsolutePosition().add(u)):(f=this.getPositionExpressedInLocalSpace().add(u),this.setPositionWithLocalVector(f))},i.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},i.prototype.setAbsolutePosition=function(t){var i,r,u,f,e;if(t){if(void 0===t.x){if(arguments.length<3)return;i=arguments[0];r=arguments[1];u=arguments[2]}else i=t.x,r=t.y,u=t.z;this.parent?(f=this.parent.getWorldMatrix().clone(),f.invert(),e=new n.Vector3(i,r,u),this.position=n.Vector3.TransformCoordinates(e,f)):(this.position.x=i,this.position.y=r,this.position.z=u)}},i.prototype.movePOV=function(n,t,i){this.position.addInPlace(this.calcMovePOV(n,t,i))},i.prototype.calcMovePOV=function(t,i,r){var e=new n.Matrix,o=this.rotationQuaternion?this.rotationQuaternion:n.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),u,f;return o.toRotationMatrix(e),u=n.Vector3.Zero(),f=this.definedFacingForward?-1:1,n.Vector3.TransformCoordinatesFromFloatsToRef(t*f,i,r*f,e,u),u},i.prototype.rotatePOV=function(n,t,i){this.rotation.addInPlace(this.calcRotatePOV(n,t,i))},i.prototype.calcRotatePOV=function(t,i,r){var u=this.definedFacingForward?1:-1;return new n.Vector3(t*u,i,r*u)},i.prototype.setPivotMatrix=function(n){this._pivotMatrix=n;this._cache.pivotMatrixUpdated=!0},i.prototype.getPivotMatrix=function(){return this._pivotMatrix},i.prototype._isSynchronized=function(){return!this._isDirty&&this.billboardMode===this._cache.billboardMode&&this.billboardMode===i.BILLBOARDMODE_NONE&&!this._cache.pivotMatrixUpdated&&!this.infiniteDistance&&!!this._cache.position.equals(this.position)&&!(this.rotationQuaternion&&!this._cache.rotationQuaternion.equals(this.rotationQuaternion))&&!!this._cache.rotation.equals(this.rotation)&&!!this._cache.scaling.equals(this.scaling)},i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache.localMatrixUpdated=!1;this._cache.position=n.Vector3.Zero();this._cache.scaling=n.Vector3.Zero();this._cache.rotation=n.Vector3.Zero();this._cache.rotationQuaternion=new n.Quaternion(0,0,0,0);this._cache.billboardMode=-1},i.prototype.markAsDirty=function(n){"rotation"===n&&(this.rotationQuaternion=null);this._currentRenderId=Number.MAX_VALUE;this._isDirty=!0},i.prototype._updateBoundingInfo=function(){this._boundingInfo=this._boundingInfo||new n.BoundingInfo(this.absolutePosition,this.absolutePosition);this._boundingInfo.update(this.worldMatrixFromCache);this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)},i.prototype._updateSubMeshesBoundingInfo=function(n){var t,i;if(this.subMeshes)for(t=0;t<this.subMeshes.length;t++)i=this.subMeshes[t],i.IsGlobal||i.updateBoundingInfo(n)},i.prototype.computeWorldMatrix=function(t){var h,o,f,e,r,s,u;return this._isWorldMatrixFrozen?this._worldMatrix:!t&&(this._currentRenderId===this.getScene().getRenderId()||this.isSynchronized(!0))?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):((this._cache.position.copyFrom(this.position),this._cache.scaling.copyFrom(this.scaling),this._cache.pivotMatrixUpdated=!1,this._cache.billboardMode=this.billboardMode,this._currentRenderId=this.getScene().getRenderId(),this._isDirty=!1,n.Matrix.ScalingToRef(this.scaling.x*this.scalingDeterminant,this.scaling.y*this.scalingDeterminant,this.scaling.z*this.scalingDeterminant,n.Tmp.Matrix[1]),this.rotationQuaternion)&&(h=this.rotation.length(),h&&(this.rotationQuaternion.multiplyInPlace(n.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)),this.rotation.copyFromFloats(0,0,0))),(this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(n.Tmp.Matrix[0]),this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)):(n.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,n.Tmp.Matrix[0]),this._cache.rotation.copyFrom(this.rotation)),this.infiniteDistance&&!this.parent)?(o=this.getScene().activeCamera,o&&(f=o.getWorldMatrix(),e=new n.Vector3(f.m[12],f.m[13],f.m[14]),n.Matrix.TranslationToRef(this.position.x+e.x,this.position.y+e.y,this.position.z+e.z,n.Tmp.Matrix[2]))):n.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,n.Tmp.Matrix[2]),(this._pivotMatrix.multiplyToRef(n.Tmp.Matrix[1],n.Tmp.Matrix[4]),n.Tmp.Matrix[4].multiplyToRef(n.Tmp.Matrix[0],n.Tmp.Matrix[5]),this.billboardMode!==i.BILLBOARDMODE_NONE&&this.getScene().activeCamera)&&(n.Tmp.Vector3[0].copyFrom(this.position),r=n.Tmp.Vector3[0],this.parent&&this.parent.getWorldMatrix&&(this._markSyncedWithParent(),this._meshToBoneReferal?(this.parent.getWorldMatrix().multiplyToRef(this._meshToBoneReferal.getWorldMatrix(),n.Tmp.Matrix[6]),s=n.Tmp.Matrix[6]):s=this.parent.getWorldMatrix(),n.Vector3.TransformNormalToRef(r,s,n.Tmp.Vector3[1]),r=n.Tmp.Vector3[1]),u=this.getScene().activeCamera.globalPosition.clone(),this.parent&&this.parent.position&&(r.addInPlace(this.parent.position),n.Matrix.TranslationToRef(r.x,r.y,r.z,n.Tmp.Matrix[2])),(this.billboardMode&i.BILLBOARDMODE_ALL)!==i.BILLBOARDMODE_ALL&&(this.billboardMode&i.BILLBOARDMODE_X&&(u.x=r.x+n.Epsilon),this.billboardMode&i.BILLBOARDMODE_Y&&(u.y=r.y+n.Epsilon),this.billboardMode&i.BILLBOARDMODE_Z&&(u.z=r.z+n.Epsilon)),n.Matrix.LookAtLHToRef(r,u,n.Vector3.Up(),n.Tmp.Matrix[3]),n.Tmp.Matrix[3].m[12]=n.Tmp.Matrix[3].m[13]=n.Tmp.Matrix[3].m[14]=0,n.Tmp.Matrix[3].invert(),n.Tmp.Matrix[5].multiplyToRef(n.Tmp.Matrix[3],this._localWorld),this._rotateYByPI.multiplyToRef(this._localWorld,n.Tmp.Matrix[5])),n.Tmp.Matrix[5].multiplyToRef(n.Tmp.Matrix[2],this._localWorld),this.parent&&this.parent.getWorldMatrix&&this.billboardMode===i.BILLBOARDMODE_NONE?(this._markSyncedWithParent(),this._meshToBoneReferal?(this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),n.Tmp.Matrix[6]),n.Tmp.Matrix[6].multiplyToRef(this._meshToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix)):this._worldMatrix.copyFrom(this._localWorld),this._updateBoundingInfo(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=n.Matrix.Invert(this._worldMatrix)),this._worldMatrix)},i.prototype.registerAfterWorldMatrixUpdate=function(n){this.onAfterWorldMatrixUpdateObservable.add(n)},i.prototype.unregisterAfterWorldMatrixUpdate=function(n){this.onAfterWorldMatrixUpdateObservable.removeCallback(n)},i.prototype.setPositionWithLocalVector=function(t){this.computeWorldMatrix();this.position=n.Vector3.TransformNormal(t,this._localWorld)},i.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var t=this._localWorld.clone();return t.invert(),n.Vector3.TransformNormal(this.position,t)},i.prototype.locallyTranslate=function(t){this.computeWorldMatrix(!0);this.position=n.Vector3.TransformCoordinates(t,this._localWorld)},i.prototype.lookAt=function(t,r,u,f,e){var o,s;void 0===r&&(r=0);void 0===u&&(u=0);void 0===f&&(f=0);void 0===e&&(e=n.Space.LOCAL);o=i._lookAtVectorCache;s=e===n.Space.LOCAL?this.position:this.getAbsolutePosition();t.subtractToRef(s,o);var h=-Math.atan2(o.z,o.x)-Math.PI/2,c=Math.sqrt(o.x*o.x+o.z*o.z),l=Math.atan2(o.y,c);this.rotationQuaternion=this.rotationQuaternion||new n.Quaternion;n.Quaternion.RotationYawPitchRollToRef(h+r,l+u,f,this.rotationQuaternion)},i.prototype.attachToBone=function(n,t){this._meshToBoneReferal=t;this.parent=n;n.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1)},i.prototype.detachFromBone=function(){this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1);this._meshToBoneReferal=null;this.parent=null},i.prototype.isInFrustum=function(n){return this._boundingInfo.isInFrustum(n)},i.prototype.isCompletelyInFrustum=function(n){return this._boundingInfo.isCompletelyInFrustum(n)},i.prototype.intersectsMesh=function(n,t){return!(!this._boundingInfo||!n._boundingInfo)&&this._boundingInfo.intersects(n._boundingInfo,t)},i.prototype.intersectsPoint=function(n){return!!this._boundingInfo&&this._boundingInfo.intersectsPoint(n)},i.prototype.setPhysicsState=function(t,i){return t.impostor&&(i=t,t=t.impostor),this.physicsImpostor=new n.PhysicsImpostor(this,t,i,this.getScene()),this.physicsImpostor.physicsBody},i.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},i.prototype.getPhysicsMass=function(){return this.physicsImpostor.getParam("mass")},i.prototype.getPhysicsFriction=function(){return this.physicsImpostor.getParam("friction")},i.prototype.getPhysicsRestitution=function(){return this.physicsImpostor.getParam("restitution")},i.prototype.getPositionInCameraSpace=function(t){return t||(t=this.getScene().activeCamera),n.Vector3.TransformCoordinates(this.absolutePosition,t.getViewMatrix())},i.prototype.getDistanceToCamera=function(n){return n||(n=this.getScene().activeCamera),this.absolutePosition.subtract(n.position).length()},i.prototype.applyImpulse=function(n,t){this.physicsImpostor&&this.physicsImpostor.applyImpulse(n,t)},i.prototype.setPhysicsLinkWith=function(t,i,r,u){this.physicsImpostor&&t.physicsImpostor&&this.physicsImpostor.createJoint(t.physicsImpostor,n.PhysicsJoint.HingeJoint,{mainPivot:i,connectedPivot:r,nativeParams:u})},i.prototype.updatePhysicsBodyPosition=function(){n.Tools.Warn("updatePhysicsBodyPosition() is deprecated, please use updatePhysicsBody()");this.updatePhysicsBody()},i.prototype.updatePhysicsBody=function(){},Object.defineProperty(i.prototype,"checkCollisions",{get:function(){return this._checkCollisions},set:function(n){this._checkCollisions=n;this.getScene().workerCollisions&&this.getScene().collisionCoordinator.onMeshUpdated(this)},enumerable:!0,configurable:!0}),i.prototype.moveWithCollisions=function(n){var t=this.getAbsolutePosition();t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPositionForCollisions);this._oldPositionForCollisions.addInPlace(this.ellipsoidOffset);this._collider.radius=this.ellipsoid;this.getScene().collisionCoordinator.getNewPosition(this._oldPositionForCollisions,n,this._collider,3,this,this._onCollisionPositionChange,this.uniqueId)},i.prototype.createOrUpdateSubmeshesOctree=function(t,i){void 0===t&&(t=64);void 0===i&&(i=2);this._submeshesOctree||(this._submeshesOctree=new n.Octree(n.Octree.CreationFuncForSubMeshes,t,i));this.computeWorldMatrix(!0);var r=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(r.minimumWorld,r.maximumWorld,this.subMeshes),this._submeshesOctree},i.prototype._collideForSubMesh=function(t,i,r){if(this._generatePointsArray(),!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(i)){t._lastColliderTransformMatrix=i.clone();t._lastColliderWorldVertices=[];t._trianglePlanes=[];for(var f=t.verticesStart,e=t.verticesStart+t.verticesCount,u=f;u<e;u++)t._lastColliderWorldVertices.push(n.Vector3.TransformCoordinates(this._positions[u],i))}r._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial());r.collisionFound&&(r.collidedMesh=this)},i.prototype._processCollisionsForSubMeshes=function(n,t){var i,r,o,f,u,e;for(this._submeshesOctree&&this.useOctreeForCollisions?(o=n.velocityWorldLength+Math.max(n.radius.x,n.radius.y,n.radius.z),f=this._submeshesOctree.intersects(n.basePointWorld,o),r=f.length,i=f.data):(i=this.subMeshes,r=i.length),u=0;u<r;u++)e=i[u],r>1&&!e._checkCollision(n)||this._collideForSubMesh(e,t,n)},i.prototype._checkCollision=function(t){this._boundingInfo._checkCollision(t)&&(n.Matrix.ScalingToRef(1/t.radius.x,1/t.radius.y,1/t.radius.z,this._collisionsScalingMatrix),this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix),this._processCollisionsForSubMeshes(t,this._collisionsTransformMatrix))},i.prototype._generatePointsArray=function(){return!1},i.prototype.intersects=function(t,i){var r=new n.PickingInfo,e,o,u,v,h,f,c,s,w,a;if(!(this.subMeshes&&this._boundingInfo&&t.intersectsSphere(this._boundingInfo.boundingSphere)&&t.intersectsBox(this._boundingInfo.boundingBox))||!this._generatePointsArray())return r;for(u=null,this._submeshesOctree&&this.useOctreeForPicking?(v=n.Ray.Transform(t,this.getWorldMatrix()),h=this._submeshesOctree.intersectsRay(v),o=h.length,e=h.data):(e=this.subMeshes,o=e.length),f=0;f<o;f++)if(c=e[f],(!(o>1)||c.canIntersects(t))&&(s=c.intersects(t,this._positions,this.getIndices(),i),s&&(i||!u||s.distance<u.distance)&&(u=s,u.subMeshId=f,i)))break;if(u){var y=this.getWorldMatrix(),p=n.Vector3.TransformCoordinates(t.origin,y),l=t.direction.clone();return l=l.scale(u.distance),w=n.Vector3.TransformNormal(l,y),a=p.add(w),r.hit=!0,r.distance=n.Vector3.Distance(p,a),r.pickedPoint=a,r.pickedMesh=this,r.bu=u.bu,r.bv=u.bv,r.faceId=u.faceId,r.subMeshId=u.subMeshId,r}return r},i.prototype.clone=function(){return null},i.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[]},i.prototype.dispose=function(n){var i,r=this,u,s,h,f,e,o;for(this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this.skeleton=null,this.getScene().stopAnimation(this),this.physicsImpostor&&this.physicsImpostor.dispose(),i=0;i<this._intersectionsInProgress.length;i++)u=this._intersectionsInProgress[i],s=u._intersectionsInProgress.indexOf(this),u._intersectionsInProgress.splice(s,1);if(this._intersectionsInProgress=[],h=this.getScene().lights,h.forEach(function(n){var t=n.includedOnlyMeshes.indexOf(r),i;t!==-1&&n.includedOnlyMeshes.splice(t,1);t=n.excludedMeshes.indexOf(r);t!==-1&&n.excludedMeshes.splice(t,1);i=n.getShadowGenerator();i&&(t=i.getShadowMap().renderList.indexOf(r),t!==-1&&i.getShadowMap().renderList.splice(t,1))}),this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this.releaseSubMeshes(),this.getScene().getEngine().unbindAllAttributes(),this.getScene().removeMesh(this),n)for(f=this.getChildMeshes(!0),i=0;i<f.length;i++)e=f[i],e.parent=null,e.computeWorldMatrix(!0);else{for(i=0;i<this.getScene().particleSystems.length;i++)this.getScene().particleSystems[i].emitter===this&&(this.getScene().particleSystems[i].dispose(),i--);for(o=this.getDescendants(!0),i=0;i<o.length;i++)o[i].dispose()}this.onAfterWorldMatrixUpdateObservable.clear();this.onCollideObservable.clear();this.onCollisionPositionChangeObservable.clear();this._isDisposed=!0;t.prototype.dispose.call(this)},i.prototype.getDirection=function(t){var i=n.Vector3.Zero();return this.getDirectionToRef(t,i),i},i.prototype.getDirectionToRef=function(t,i){n.Vector3.TransformNormalToRef(t,this.getWorldMatrix(),i)},i.prototype.setPivotPoint=function(t,i){var r,u;void 0===i&&(i=n.Space.LOCAL);0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);r=this.getWorldMatrix();i==n.Space.WORLD&&(u=n.Tmp.Matrix[0],r.invertToRef(u),t=n.Vector3.TransformCoordinates(t,u));n.Vector3.TransformCoordinatesToRef(t,r,this.position);this._pivotMatrix.m[12]=-t.x;this._pivotMatrix.m[13]=-t.y;this._pivotMatrix.m[14]=-t.z;this._cache.pivotMatrixUpdated=!0},i.prototype.getPivotPoint=function(){var t=n.Vector3.Zero();return this.getPivotPointToRef(t),t},i.prototype.getPivotPointToRef=function(n){n.x=-this._pivotMatrix.m[12];n.y=-this._pivotMatrix.m[13];n.z=-this._pivotMatrix.m[14]},i.prototype.getAbsolutePivotPoint=function(){var t=n.Vector3.Zero();return this.getAbsolutePivotPointToRef(t),t},i.prototype.getAbsolutePivotPointToRef=function(t){t.x=this._pivotMatrix.m[12];t.y=this._pivotMatrix.m[13];t.z=this._pivotMatrix.m[14];this.getPivotPointToRef(t);n.Vector3.TransformCoordinatesToRef(t,this.getWorldMatrix(),t)},i._BILLBOARDMODE_NONE=0,i._BILLBOARDMODE_X=1,i._BILLBOARDMODE_Y=2,i._BILLBOARDMODE_Z=4,i._BILLBOARDMODE_ALL=7,i._rotationAxisCache=new n.Quaternion,i._lookAtVectorCache=new n.Vector3(0,0,0),i}(n.Node);n.AbstractMesh=t}(i||(i={}));!function(n){var t=function(t){function i(i,r){t.call(this,i,r);this.diffuse=new n.Color3(1,1,1);this.specular=new n.Color3(1,1,1);this.intensity=1;this.range=Number.MAX_VALUE;this.includeOnlyWithLayerMask=0;this.includedOnlyMeshes=[];this.excludedMeshes=[];this.excludeWithLayerMask=0;this.lightmapMode=0;this.radius=1e-5;this._excludedMeshesIds=[];this._includedOnlyMeshesIds=[];r.addLight(this)}return u(i,t),Object.defineProperty(i,"LIGHTMAP_DEFAULT",{get:function(){return i._LIGHTMAP_DEFAULT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"LIGHTMAP_SPECULAR",{get:function(){return i._LIGHTMAP_SPECULAR},enumerable:!0,configurable:!0}),Object.defineProperty(i,"LIGHTMAP_SHADOWSONLY",{get:function(){return i._LIGHTMAP_SHADOWSONLY},enumerable:!0,configurable:!0}),i.prototype.toString=function(n){var i="Name: "+this.name,t;if(i+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(t=0;t<this.animations.length;t++)i+=", animation[0]: "+this.animations[t].toString(n);return i},i.prototype.getShadowGenerator=function(){return this._shadowGenerator},i.prototype.getAbsolutePosition=function(){return n.Vector3.Zero()},i.prototype.transferToEffect=function(){},i.prototype._getWorldMatrix=function(){return n.Matrix.Identity()},i.prototype.canAffectMesh=function(n){return!n||!(this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(n)===-1)&&!(this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(n)!==-1)&&(0===this.includeOnlyWithLayerMask||0!=(this.includeOnlyWithLayerMask&n.layerMask))&&!(0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&n.layerMask)},i.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId();var t=this._getWorldMatrix();return this.parent&&this.parent.getWorldMatrix?(this._parentedWorldMatrix||(this._parentedWorldMatrix=n.Matrix.Identity()),t.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix),this._markSyncedWithParent(),this._parentedWorldMatrix):t},i.prototype.dispose=function(){this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null);this.getScene().stopAnimation(this);this.getScene().removeLight(this);t.prototype.dispose.call(this)},i.prototype.getTypeID=function(){return 0},i.prototype.clone=function(t){return n.SerializationHelper.Clone(i.GetConstructorFromName(this.getTypeID(),t,this.getScene()),this)},i.prototype.serialize=function(){var t=n.SerializationHelper.Serialize(this);return t.type=this.getTypeID(),this.parent&&(t.parentId=this.parent.id),this.excludedMeshes.length>0&&(t.excludedMeshesIds=[],this.excludedMeshes.forEach(function(n){t.excludedMeshesIds.push(n.id)})),this.includedOnlyMeshes.length>0&&(t.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(function(n){t.includedOnlyMeshesIds.push(n.id)})),n.Animation.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t},i.GetConstructorFromName=function(t,i,r){switch(t){case 0:return function(){return new n.PointLight(i,n.Vector3.Zero(),r)};case 1:return function(){return new n.DirectionalLight(i,n.Vector3.Zero(),r)};case 2:return function(){return new n.SpotLight(i,n.Vector3.Zero(),n.Vector3.Zero(),0,0,r)};case 3:return function(){return new n.HemisphericLight(i,n.Vector3.Zero(),r)}}},i.Parse=function(t,r){var u=n.SerializationHelper.Parse(i.GetConstructorFromName(t.type,t.name,r),t,r),f,e;if(t.excludedMeshesIds&&(u._excludedMeshesIds=t.excludedMeshesIds),t.includedOnlyMeshesIds&&(u._includedOnlyMeshesIds=t.includedOnlyMeshesIds),t.parentId&&(u._waitingParentId=t.parentId),t.animations){for(f=0;f<t.animations.length;f++)e=t.animations[f],u.animations.push(n.Animation.Parse(e));n.Node.ParseAnimationRanges(u,t,r)}return t.autoAnimate&&r.beginAnimation(u,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),u},i._LIGHTMAP_DEFAULT=0,i._LIGHTMAP_SPECULAR=1,i._LIGHTMAP_SHADOWSONLY=2,r([n.serializeAsColor3()],i.prototype,"diffuse",void 0),r([n.serializeAsColor3()],i.prototype,"specular",void 0),r([n.serialize()],i.prototype,"intensity",void 0),r([n.serialize()],i.prototype,"range",void 0),r([n.serialize()],i.prototype,"includeOnlyWithLayerMask",void 0),r([n.serialize()],i.prototype,"excludeWithLayerMask",void 0),r([n.serialize()],i.prototype,"lightmapMode",void 0),r([n.serialize()],i.prototype,"radius",void 0),i}(n.Node);n.Light=t}(i||(i={}));!function(n){var t=function(t){function i(n,i,r){t.call(this,n,r);this.position=i}return u(i,t),i.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},i.prototype.computeTransformedPosition=function(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=n.Vector3.Zero()),n.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),!0)},i.prototype.transferToEffect=function(n,t){return this.parent&&this.parent.getWorldMatrix?(this.computeTransformedPosition(),void n.setFloat4(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0)):void n.setFloat4(t,this.position.x,this.position.y,this.position.z,0)},i.prototype.needCube=function(){return!0},i.prototype.supportsVSM=function(){return!1},i.prototype.needRefreshPerFrame=function(){return!1},i.prototype.getShadowDirection=function(t){switch(t){case 0:return new n.Vector3(1,0,0);case 1:return new n.Vector3(-1,0,0);case 2:return new n.Vector3(0,-1,0);case 3:return new n.Vector3(0,1,0);case 4:return new n.Vector3(0,0,1);case 5:return new n.Vector3(0,0,-1)}return n.Vector3.Zero()},i.prototype.setShadowProjectionMatrix=function(t){var i=this.getScene().activeCamera;n.Matrix.PerspectiveFovLHToRef(Math.PI/2,1,i.minZ,i.maxZ,t)},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=n.Matrix.Identity()),n.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i.prototype.getTypeID=function(){return 0},r([n.serializeAsVector3()],i.prototype,"position",void 0),i}(n.Light);n.PointLight=t}(i||(i={}));!function(n){var t=function(t){function i(n,i,r,u,f,e){t.call(this,n,e);this.position=i;this.direction=r;this.angle=u;this.exponent=f}return u(i,t),i.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},i.prototype.setShadowProjectionMatrix=function(t){var i=this.getScene().activeCamera;n.Matrix.PerspectiveFovLHToRef(this.angle,1,i.minZ,i.maxZ,t)},i.prototype.needCube=function(){return!1},i.prototype.supportsVSM=function(){return!0},i.prototype.needRefreshPerFrame=function(){return!1},i.prototype.getShadowDirection=function(){return this.direction},i.prototype.setDirectionToTarget=function(t){return this.direction=n.Vector3.Normalize(t.subtract(this.position)),this.direction},i.prototype.computeTransformedPosition=function(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=n.Vector3.Zero()),n.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),!0)},i.prototype.transferToEffect=function(t,i,r){var u;this.parent&&this.parent.getWorldMatrix?(this._transformedDirection||(this._transformedDirection=n.Vector3.Zero()),this.computeTransformedPosition(),n.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this._transformedDirection),t.setFloat4(i,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent),u=n.Vector3.Normalize(this._transformedDirection)):(t.setFloat4(i,this.position.x,this.position.y,this.position.z,this.exponent),u=n.Vector3.Normalize(this.direction));t.setFloat4(r,u.x,u.y,u.z,Math.cos(.5*this.angle))},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=n.Matrix.Identity()),n.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i.prototype.getTypeID=function(){return 2},i.prototype.getRotation=function(){this.direction.normalize();var t=n.Vector3.Cross(this.direction,n.Axis.Y),i=n.Vector3.Cross(t,this.direction);return n.Vector3.RotationFromAxis(t,i,this.direction)},r([n.serializeAsVector3()],i.prototype,"position",void 0),r([n.serializeAsVector3()],i.prototype,"direction",void 0),r([n.serialize()],i.prototype,"angle",void 0),r([n.serialize()],i.prototype,"exponent",void 0),i}(n.Light);n.SpotLight=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u){t.call(this,i,u);this.groundColor=new n.Color3(0,0,0);this.direction=r}return u(i,t),i.prototype.setDirectionToTarget=function(t){return this.direction=n.Vector3.Normalize(t.subtract(n.Vector3.Zero())),this.direction},i.prototype.getShadowGenerator=function(){return null},i.prototype.transferToEffect=function(t,i,r){var u=n.Vector3.Normalize(this.direction);t.setFloat4(i,u.x,u.y,u.z,0);t.setColor3(r,this.groundColor.scale(this.intensity))},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=n.Matrix.Identity()),this._worldMatrix},i.prototype.getTypeID=function(){return 3},r([n.serializeAsColor3()],i.prototype,"groundColor",void 0),r([n.serializeAsVector3()],i.prototype,"direction",void 0),i}(n.Light);n.HemisphericLight=t}(i||(i={}));!function(n){var t=function(t){function i(n,i,r){t.call(this,n,r);this.shadowOrthoScale=.5;this.autoUpdateExtends=!0;this._orthoLeft=Number.MAX_VALUE;this._orthoRight=Number.MIN_VALUE;this._orthoTop=Number.MIN_VALUE;this._orthoBottom=Number.MAX_VALUE;this.position=i.scale(-1);this.direction=i}return u(i,t),i.prototype.getAbsolutePosition=function(){return this.transformedPosition?this.transformedPosition:this.position},i.prototype.setDirectionToTarget=function(t){return this.direction=n.Vector3.Normalize(t.subtract(this.position)),this.direction},i.prototype.setShadowProjectionMatrix=function(t,i,r){var a=this.getScene().activeCamera,u,f,o,s,h,e,c,l;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE)for(u=n.Vector3.Zero(),this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,f=0;f<r.length;f++)if(o=r[f],o&&(s=o.getBoundingInfo(),s))for(h=s.boundingBox,e=0;e<h.vectorsWorld.length;e++)n.Vector3.TransformCoordinatesToRef(h.vectorsWorld[e],i,u),u.x<this._orthoLeft&&(this._orthoLeft=u.x),u.y<this._orthoBottom&&(this._orthoBottom=u.y),u.x>this._orthoRight&&(this._orthoRight=u.x),u.y>this._orthoTop&&(this._orthoTop=u.y);c=this._orthoRight-this._orthoLeft;l=this._orthoTop-this._orthoBottom;n.Matrix.OrthoOffCenterLHToRef(this._orthoLeft-c*this.shadowOrthoScale,this._orthoRight+c*this.shadowOrthoScale,this._orthoBottom-l*this.shadowOrthoScale,this._orthoTop+l*this.shadowOrthoScale,-a.maxZ,a.maxZ,t)},i.prototype.supportsVSM=function(){return!0},i.prototype.needRefreshPerFrame=function(){return!0},i.prototype.needCube=function(){return!1},i.prototype.getShadowDirection=function(){return this.direction},i.prototype.computeTransformedPosition=function(){return!(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition||(this.transformedPosition=n.Vector3.Zero()),n.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),!0)},i.prototype.transferToEffect=function(t,i){return this.parent&&this.parent.getWorldMatrix?(this._transformedDirection||(this._transformedDirection=n.Vector3.Zero()),n.Vector3.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this._transformedDirection),void t.setFloat4(i,this._transformedDirection.x,this._transformedDirection.y,this._transformedDirection.z,1)):void t.setFloat4(i,this.direction.x,this.direction.y,this.direction.z,1)},i.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=n.Matrix.Identity()),n.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this._worldMatrix},i.prototype.getTypeID=function(){return 1},r([n.serializeAsVector3()],i.prototype,"position",void 0),r([n.serializeAsVector3()],i.prototype,"direction",void 0),r([n.serialize()],i.prototype,"shadowOrthoScale",void 0),r([n.serialize()],i.prototype,"autoUpdateExtends",void 0),i}(n.Light);n.DirectionalLight=t}(i||(i={}));!function(n){var t=function(){function t(i,r){var u=this,f,e,o;this._filter=t.FILTER_NONE;this.blurScale=2;this._blurBoxOffset=0;this._bias=5e-5;this._lightDirection=n.Vector3.Zero();this.forceBackFacesOnly=!1;this._darkness=0;this._transparencyShadow=!1;this._viewMatrix=n.Matrix.Zero();this._projectionMatrix=n.Matrix.Zero();this._transformMatrix=n.Matrix.Zero();this._worldViewProjection=n.Matrix.Zero();this._currentFaceIndex=0;this._currentFaceIndexCache=0;this._useFullFloat=!0;this._light=r;this._scene=r.getScene();this._mapSize=i;r._shadowGenerator=this;e=this._scene.getEngine().getCaps();e.textureFloat&&e.textureFloatLinearFiltering&&e.textureFloatRender?(this._useFullFloat=!0,f=n.Engine.TEXTURETYPE_FLOAT):(this._useFullFloat=!1,f=n.Engine.TEXTURETYPE_UNSIGNED_INT);this._shadowMap=new n.RenderTargetTexture(r.name+"_shadowMap",i,this._scene,!1,!0,f,r.needCube());this._shadowMap.wrapU=n.Texture.CLAMP_ADDRESSMODE;this._shadowMap.wrapV=n.Texture.CLAMP_ADDRESSMODE;this._shadowMap.anisotropicFilteringLevel=1;this._shadowMap.updateSamplingMode(n.Texture.NEAREST_SAMPLINGMODE);this._shadowMap.renderParticles=!1;this._shadowMap.onBeforeRenderObservable.add(function(n){u._currentFaceIndex=n});this._shadowMap.onAfterUnbindObservable.add(function(){u.useBlurVarianceShadowMap&&(u._shadowMap2||(u._shadowMap2=new n.RenderTargetTexture(r.name+"_shadowMap",i,u._scene,!1,!0,f),u._shadowMap2.wrapU=n.Texture.CLAMP_ADDRESSMODE,u._shadowMap2.wrapV=n.Texture.CLAMP_ADDRESSMODE,u._shadowMap2.updateSamplingMode(n.Texture.TRILINEAR_SAMPLINGMODE),u._downSamplePostprocess=new n.PassPostProcess("downScale",1/u.blurScale,null,n.Texture.BILINEAR_SAMPLINGMODE,u._scene.getEngine()),u._downSamplePostprocess.onApplyObservable.add(function(n){n.setTexture("textureSampler",u._shadowMap)}),u.blurBoxOffset=1),u._scene.postProcessManager.directRender([u._downSamplePostprocess,u._boxBlurPostprocess],u._shadowMap2.getInternalTexture()))});o=function(t){var i=t.getRenderingMesh(),o=u._scene,r=o.getEngine(),f,s,e,h;r.setState(t.getMaterial().backFaceCulling);f=i._getInstancesRenderList(t._id);f.mustReturn||(s=null!==r.getCaps().instancedArrays&&null!==f.visibleInstances[t._id]&&void 0!==f.visibleInstances[t._id],u.isReady(t,s)?(r.enableEffect(u._effect),i._bind(t,u._effect,n.Material.TriangleFillMode),e=t.getMaterial(),(u._effect.setMatrix("viewProjection",u.getTransformMatrix()),u._effect.setVector3("lightPosition",u.getLight().position),u.getLight().needCube()&&u._effect.setFloat2("depthValues",o.activeCamera.minZ,o.activeCamera.maxZ),e&&e.needAlphaTesting())&&(h=e.getAlphaTestTexture(),u._effect.setTexture("diffuseSampler",h),u._effect.setMatrix("diffuseMatrix",h.getTextureMatrix())),i.useBones&&i.computeBonesUsingShaders&&u._effect.setMatrices("mBones",i.skeleton.getTransformMatrices(i)),u.forceBackFacesOnly&&r.setState(!0,0,!1,!0),i._processRendering(t,u._effect,n.Material.TriangleFillMode,f,s,function(n,t){return u._effect.setMatrix("world",t)}),u.forceBackFacesOnly&&r.setState(!0,0,!1,!1)):u._shadowMap.resetRefreshCounter())};this._shadowMap.customRenderFunction=function(n,t,i){for(var r=0;r<n.length;r++)o(n.data[r]);for(r=0;r<t.length;r++)o(t.data[r]);if(u._transparencyShadow)for(r=0;r<i.length;r++)o(i.data[r])};this._shadowMap.onClearObservable.add(function(t){u.useBlurVarianceShadowMap||u.useVarianceShadowMap?t.clear(new n.Color4(0,0,0,0),!0,!0,!0):t.clear(new n.Color4(1,1,1,1),!0,!0,!0)})}return Object.defineProperty(t,"FILTER_NONE",{get:function(){return t._FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FILTER_VARIANCESHADOWMAP",{get:function(){return t._FILTER_VARIANCESHADOWMAP},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FILTER_POISSONSAMPLING",{get:function(){return t._FILTER_POISSONSAMPLING},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FILTER_BLURVARIANCESHADOWMAP",{get:function(){return t._FILTER_BLURVARIANCESHADOWMAP},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bias",{get:function(){return this._bias},set:function(n){this._bias=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"blurBoxOffset",{get:function(){return this._blurBoxOffset},set:function(t){var i=this;this._blurBoxOffset!==t&&(this._blurBoxOffset=t,this._boxBlurPostprocess&&this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=new n.PostProcess("DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1/this.blurScale,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define OFFSET "+t),this._boxBlurPostprocess.onApplyObservable.add(function(n){n.setFloat2("screenSize",i._mapSize/i.blurScale,i._mapSize/i.blurScale)}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"filter",{get:function(){return this._filter},set:function(t){this._filter!==t&&(this._filter=t,this.useVarianceShadowMap||this.useBlurVarianceShadowMap||this.usePoissonSampling?(this._shadowMap.anisotropicFilteringLevel=16,this._shadowMap.updateSamplingMode(n.Texture.BILINEAR_SAMPLINGMODE)):(this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(n.Texture.NEAREST_SAMPLINGMODE)))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useVarianceShadowMap",{get:function(){return this.filter===t.FILTER_VARIANCESHADOWMAP&&this._light.supportsVSM()},set:function(n){this.filter=n?t.FILTER_VARIANCESHADOWMAP:t.FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"usePoissonSampling",{get:function(){return this.filter===t.FILTER_POISSONSAMPLING||!this._light.supportsVSM()&&(this.filter===t.FILTER_VARIANCESHADOWMAP||this.filter===t.FILTER_BLURVARIANCESHADOWMAP)},set:function(n){this.filter=n?t.FILTER_POISSONSAMPLING:t.FILTER_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useBlurVarianceShadowMap",{get:function(){return this.filter===t.FILTER_BLURVARIANCESHADOWMAP&&this._light.supportsVSM()},set:function(n){this.filter=n?t.FILTER_BLURVARIANCESHADOWMAP:t.FILTER_NONE},enumerable:!0,configurable:!0}),t.prototype.isReady=function(t,i){var r=[],s,e;this._useFullFloat&&r.push("#define FULLFLOAT");(this.useVarianceShadowMap||this.useBlurVarianceShadowMap)&&r.push("#define VSM");this.getLight().needCube()&&r.push("#define CUBEMAP");var u=[n.VertexBuffer.PositionKind],f=t.getMesh(),o=t.getMaterial();return o&&o.needAlphaTesting()&&(r.push("#define ALPHATEST"),f.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(u.push(n.VertexBuffer.UVKind),r.push("#define UV1")),f.isVerticesDataPresent(n.VertexBuffer.UV2Kind))&&(s=o.getAlphaTestTexture(),1===s.coordinatesIndex&&(u.push(n.VertexBuffer.UV2Kind),r.push("#define UV2"))),f.useBones&&f.computeBonesUsingShaders?(u.push(n.VertexBuffer.MatricesIndicesKind),u.push(n.VertexBuffer.MatricesWeightsKind),f.numBoneInfluencers>4&&(u.push(n.VertexBuffer.MatricesIndicesExtraKind),u.push(n.VertexBuffer.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+f.numBoneInfluencers),r.push("#define BonesPerMesh "+(f.skeleton.bones.length+1))):r.push("#define NUM_BONE_INFLUENCERS 0"),i&&(r.push("#define INSTANCES"),u.push("world0"),u.push("world1"),u.push("world2"),u.push("world3")),e=r.join("\n"),this._cachedDefines!==e&&(this._cachedDefines=e,this._effect=this._scene.getEngine().createEffect("shadowMap",u,["world","mBones","viewProjection","diffuseMatrix","lightPosition","depthValues"],["diffuseSampler"],e)),this._effect.isReady()},t.prototype.getShadowMap=function(){return this._shadowMap},t.prototype.getShadowMapForRendering=function(){return this._shadowMap2?this._shadowMap2:this._shadowMap},t.prototype.getLight=function(){return this._light},t.prototype.getTransformMatrix=function(){var i=this._scene,t;return this._currentRenderID===i.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex?this._transformMatrix:(this._currentRenderID=i.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex,t=this._light.position,n.Vector3.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(n.Vector3.Dot(this._lightDirection,n.Vector3.Up()))&&(this._lightDirection.z=1e-13),this._light.computeTransformedPosition()&&(t=this._light.transformedPosition),!this._light.needRefreshPerFrame()&&this._cachedPosition&&this._cachedDirection&&t.equals(this._cachedPosition)&&this._lightDirection.equals(this._cachedDirection)||(this._cachedPosition=t.clone(),this._cachedDirection=this._lightDirection.clone(),n.Matrix.LookAtLHToRef(t,t.add(this._lightDirection),n.Vector3.Up(),this._viewMatrix),this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,this.getShadowMap().renderList),this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)),this._transformMatrix)},t.prototype.getDarkness=function(){return this._darkness},t.prototype.setDarkness=function(n){this._darkness=n>=1?1:n<=0?0:n},t.prototype.setTransparencyShadow=function(n){this._transparencyShadow=n},t.prototype._packHalf=function(t){var i=255*t,r=i-Math.floor(i);return new n.Vector2(t-r/255,r)},t.prototype.dispose=function(){this._shadowMap.dispose();this._shadowMap2&&this._shadowMap2.dispose();this._downSamplePostprocess&&this._downSamplePostprocess.dispose();this._boxBlurPostprocess&&this._boxBlurPostprocess.dispose()},t.prototype.serialize=function(){var n={},t,i;for(n.lightId=this._light.id,n.mapSize=this.getShadowMap().getRenderSize(),n.useVarianceShadowMap=this.useVarianceShadowMap,n.usePoissonSampling=this.usePoissonSampling,n.forceBackFacesOnly=this.forceBackFacesOnly,n.renderList=[],t=0;t<this.getShadowMap().renderList.length;t++)i=this.getShadowMap().renderList[t],n.renderList.push(i.id);return n},t.Parse=function(n,i){for(var f,e=i.getLightByID(n.lightId),r=new t(n.mapSize,e),u=0;u<n.renderList.length;u++)f=i.getMeshesByID(n.renderList[u]),f.forEach(function(n){r.getShadowMap().renderList.push(n)});return n.usePoissonSampling?r.usePoissonSampling=!0:n.useVarianceShadowMap?r.useVarianceShadowMap=!0:n.useBlurVarianceShadowMap&&(r.useBlurVarianceShadowMap=!0,n.blurScale&&(r.blurScale=n.blurScale),n.blurBoxOffset&&(r.blurBoxOffset=n.blurBoxOffset)),void 0!==n.bias&&(r.bias=n.bias),r.forceBackFacesOnly=n.forceBackFacesOnly,r},t._FILTER_NONE=0,t._FILTER_VARIANCESHADOWMAP=1,t._FILTER_POISSONSAMPLING=2,t._FILTER_BLURVARIANCESHADOWMAP=3,t}();n.ShadowGenerator=t}(i||(i={}));!function(n){var i=function(n,t,i,r){return!(n.x>i.x+r)&&!(i.x-r>t.x)&&!(n.y>i.y+r)&&!(i.y-r>t.y)&&!(n.z>i.z+r)&&!(i.z-r>t.z)},t=function(){var n={root:0,found:!1};return function(t,i,r,u){var o,h;if(n.root=0,n.found=!1,o=i*i-4*t*r,o<0)return n;var s=Math.sqrt(o),f=(-i-s)/(2*t),e=(-i+s)/(2*t);return f>e&&(h=e,e=f,f=h),f>0&&f<u?(n.root=f,n.found=!0,n):e>0&&e<u?(n.root=e,n.found=!0,n):n}}(),r=function(){function r(){this.radius=new n.Vector3(1,1,1);this.retry=0;this.basePointWorld=n.Vector3.Zero();this.velocityWorld=n.Vector3.Zero();this.normalizedVelocity=n.Vector3.Zero();this._collisionPoint=n.Vector3.Zero();this._planeIntersectionPoint=n.Vector3.Zero();this._tempVector=n.Vector3.Zero();this._tempVector2=n.Vector3.Zero();this._tempVector3=n.Vector3.Zero();this._tempVector4=n.Vector3.Zero();this._edge=n.Vector3.Zero();this._baseToVertex=n.Vector3.Zero();this._destinationPoint=n.Vector3.Zero();this._slidePlaneNormal=n.Vector3.Zero();this._displacementVector=n.Vector3.Zero()}return r.prototype._initialize=function(t,i,r){this.velocity=i;n.Vector3.NormalizeToRef(i,this.normalizedVelocity);this.basePoint=t;t.multiplyToRef(this.radius,this.basePointWorld);i.multiplyToRef(this.radius,this.velocityWorld);this.velocityWorldLength=this.velocityWorld.length();this.epsilon=r;this.collisionFound=!1},r.prototype._checkPointInTriangle=function(t,i,r,u,f){i.subtractToRef(t,this._tempVector);r.subtractToRef(t,this._tempVector2);n.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var e=n.Vector3.Dot(this._tempVector4,f);return!(e<0)&&(u.subtractToRef(t,this._tempVector3),n.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),e=n.Vector3.Dot(this._tempVector4,f),!(e<0)&&(n.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),e=n.Vector3.Dot(this._tempVector4,f),e>=0))},r.prototype._canDoCollision=function(t,r,u,f){var o=n.Vector3.Distance(this.basePointWorld,t),e=Math.max(this.radius.x,this.radius.y,this.radius.z);return!(o>this.velocityWorldLength+e+r)&&!!i(u,f,this.basePointWorld,this.velocityWorldLength+e)},r.prototype._testTriangle=function(i,r,u,f,e,o){var v,ut=!1,d,tt,it,g,ft,b,h,nt,k,y,rt;if(r||(r=[]),r[i]||(r[i]=new n.Plane(0,0,0,0),r[i].copyFromPoints(u,f,e)),d=r[i],o||d.isFrontFacingTo(this.normalizedVelocity,0)){if(tt=d.signedDistanceTo(this.basePoint),it=n.Vector3.Dot(d.normal,this.velocity),0==it){if(Math.abs(tt)>=1)return;ut=!0;v=0}else{if(v=(-1-tt)/it,g=(1-tt)/it,v>g&&(ft=g,g=v,v=ft),v>1||g<0)return;v<0&&(v=0);v>1&&(v=1)}if(this._collisionPoint.copyFromFloats(0,0,0),b=!1,h=1,ut||(this.basePoint.subtractToRef(d.normal,this._planeIntersectionPoint),this.velocity.scaleToRef(v,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,u,f,e,d.normal)&&(b=!0,h=v,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!b){nt=this.velocity.lengthSquared();k=nt;this.basePoint.subtractToRef(u,this._tempVector);var p=2*n.Vector3.Dot(this.velocity,this._tempVector),w=this._tempVector.lengthSquared()-1,s=t(k,p,w,h);s.found&&(h=s.root,b=!0,this._collisionPoint.copyFrom(u));this.basePoint.subtractToRef(f,this._tempVector);p=2*n.Vector3.Dot(this.velocity,this._tempVector);w=this._tempVector.lengthSquared()-1;s=t(k,p,w,h);s.found&&(h=s.root,b=!0,this._collisionPoint.copyFrom(f));this.basePoint.subtractToRef(e,this._tempVector);p=2*n.Vector3.Dot(this.velocity,this._tempVector);w=this._tempVector.lengthSquared()-1;s=t(k,p,w,h);s.found&&(h=s.root,b=!0,this._collisionPoint.copyFrom(e));f.subtractToRef(u,this._edge);u.subtractToRef(this.basePoint,this._baseToVertex);var c=this._edge.lengthSquared(),l=n.Vector3.Dot(this._edge,this.velocity),a=n.Vector3.Dot(this._edge,this._baseToVertex);(k=c*-nt+l*l,p=c*2*n.Vector3.Dot(this.velocity,this._baseToVertex)-2*l*a,w=c*(1-this._baseToVertex.lengthSquared())+a*a,s=t(k,p,w,h),s.found)&&(y=(l*s.root-a)/c,y>=0&&y<=1&&(h=s.root,b=!0,this._edge.scaleInPlace(y),u.addToRef(this._edge,this._collisionPoint)));e.subtractToRef(f,this._edge);f.subtractToRef(this.basePoint,this._baseToVertex);c=this._edge.lengthSquared();l=n.Vector3.Dot(this._edge,this.velocity);a=n.Vector3.Dot(this._edge,this._baseToVertex);k=c*-nt+l*l;p=c*2*n.Vector3.Dot(this.velocity,this._baseToVertex)-2*l*a;w=c*(1-this._baseToVertex.lengthSquared())+a*a;s=t(k,p,w,h);s.found&&(y=(l*s.root-a)/c,y>=0&&y<=1&&(h=s.root,b=!0,this._edge.scaleInPlace(y),f.addToRef(this._edge,this._collisionPoint)));u.subtractToRef(e,this._edge);e.subtractToRef(this.basePoint,this._baseToVertex);c=this._edge.lengthSquared();l=n.Vector3.Dot(this._edge,this.velocity);a=n.Vector3.Dot(this._edge,this._baseToVertex);k=c*-nt+l*l;p=c*2*n.Vector3.Dot(this.velocity,this._baseToVertex)-2*l*a;w=c*(1-this._baseToVertex.lengthSquared())+a*a;s=t(k,p,w,h);s.found&&(y=(l*s.root-a)/c,y>=0&&y<=1&&(h=s.root,b=!0,this._edge.scaleInPlace(y),e.addToRef(this._edge,this._collisionPoint)))}b&&(rt=h*this.velocity.length(),(!this.collisionFound||rt<this.nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this.nearestDistance=rt,this.collisionFound=!0))}},r.prototype._collide=function(n,t,i,r,u,f,e){for(var o=r;o<u;o+=3){var s=t[i[o]-f],h=t[i[o+1]-f],c=t[i[o+2]-f];this._testTriangle(o,n,c,h,s,e)}},r.prototype._getResponse=function(t,i){t.addToRef(i,this._destinationPoint);i.scaleInPlace(this.nearestDistance/i.length());this.basePoint.addToRef(i,t);t.subtractToRef(this.intersectionPoint,this._slidePlaneNormal);this._slidePlaneNormal.normalize();this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector);t.addInPlace(this._displacementVector);this.intersectionPoint.addInPlace(this._displacementVector);this._slidePlaneNormal.scaleInPlace(n.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint));this._destinationPoint.subtractInPlace(this._slidePlaneNormal);this._destinationPoint.subtractToRef(this.intersectionPoint,i)},r}();n.Collider=r}(i||(i={}));!function(n){var t,i,r,u;n.CollisionWorker="",function(n){n[n.INIT=0]="INIT";n[n.UPDATE=1]="UPDATE";n[n.COLLIDE=2]="COLLIDE"}(n.WorkerTaskType||(n.WorkerTaskType={}));t=n.WorkerTaskType;!function(n){n[n.SUCCESS=0]="SUCCESS";n[n.UNKNOWN_ERROR=1]="UNKNOWN_ERROR"}(n.WorkerReplyType||(n.WorkerReplyType={}));i=n.WorkerReplyType;r=function(){function r(){var u=this;this._scaledPosition=n.Vector3.Zero();this._scaledVelocity=n.Vector3.Zero();this.onMeshUpdated=function(n){u._addUpdateMeshesList[n.uniqueId]=r.SerializeMesh(n)};this.onGeometryUpdated=function(n){u._addUpdateGeometriesList[n.id]=r.SerializeGeometry(n)};this._afterRender=function(){var n;if(u._init&&!(0==u._toRemoveGeometryArray.length&&0==u._toRemoveMeshesArray.length&&0==Object.keys(u._addUpdateGeometriesList).length&&0==Object.keys(u._addUpdateMeshesList).length||u._runningUpdated>4)){++u._runningUpdated;var f={updatedMeshes:u._addUpdateMeshesList,updatedGeometries:u._addUpdateGeometriesList,removedGeometries:u._toRemoveGeometryArray,removedMeshes:u._toRemoveMeshesArray},i={payload:f,taskType:t.UPDATE},r=[];for(n in f.updatedGeometries)f.updatedGeometries.hasOwnProperty(n)&&(r.push(i.payload.updatedGeometries[n].indices.buffer),r.push(i.payload.updatedGeometries[n].normals.buffer),r.push(i.payload.updatedGeometries[n].positions.buffer));u._worker.postMessage(i,r);u._addUpdateMeshesList={};u._addUpdateGeometriesList={};u._toRemoveGeometryArray=[];u._toRemoveMeshesArray=[]}};this._onMessageFromWorker=function(r){var e=r.data,f;if(e.error!=i.SUCCESS)return void n.Tools.Warn("error returned from worker!");switch(e.taskType){case t.INIT:u._init=!0;u._scene.meshes.forEach(function(n){u.onMeshAdded(n)});u._scene.getGeometries().forEach(function(n){u.onGeometryAdded(n)});break;case t.UPDATE:u._runningUpdated--;break;case t.COLLIDE:if(u._runningCollisionTask=!1,f=e.payload,!u._collisionsCallbackArray[f.collisionId])return;u._collisionsCallbackArray[f.collisionId](f.collisionId,n.Vector3.FromArray(f.newPosition),u._scene.getMeshByUniqueID(f.collidedMeshUniqueId));u._collisionsCallbackArray[f.collisionId]=void 0}};this._collisionsCallbackArray=[];this._init=!1;this._runningUpdated=0;this._runningCollisionTask=!1;this._addUpdateMeshesList={};this._addUpdateGeometriesList={};this._toRemoveGeometryArray=[];this._toRemoveMeshesArray=[]}return r.prototype.getNewPosition=function(n,i,r,u,f,e,o){if(this._init&&!this._collisionsCallbackArray[o]&&!this._collisionsCallbackArray[o+1e5]){n.divideToRef(r.radius,this._scaledPosition);i.divideToRef(r.radius,this._scaledVelocity);this._collisionsCallbackArray[o]=e;var s={collider:{position:this._scaledPosition.asArray(),velocity:this._scaledVelocity.asArray(),radius:r.radius.asArray()},collisionId:o,excludedMeshUniqueId:f?f.uniqueId:null,maximumRetry:u},h={payload:s,taskType:t.COLLIDE};this._worker.postMessage(h)}},r.prototype.init=function(i){var r,u;this._scene=i;this._scene.registerAfterRender(this._afterRender);r=n.WorkerIncluded?n.Engine.CodeRepository+"Collisions/babylon.collisionWorker.js":URL.createObjectURL(new Blob([n.CollisionWorker],{type:"application/javascript"}));this._worker=new Worker(r);this._worker.onmessage=this._onMessageFromWorker;u={payload:{},taskType:t.INIT};this._worker.postMessage(u)},r.prototype.destroy=function(){this._scene.unregisterAfterRender(this._afterRender);this._worker.terminate()},r.prototype.onMeshAdded=function(n){n.registerAfterWorldMatrixUpdate(this.onMeshUpdated);this.onMeshUpdated(n)},r.prototype.onMeshRemoved=function(n){this._toRemoveMeshesArray.push(n.uniqueId)},r.prototype.onGeometryAdded=function(n){n.onGeometryUpdated=this.onGeometryUpdated;this.onGeometryUpdated(n)},r.prototype.onGeometryDeleted=function(n){this._toRemoveGeometryArray.push(n.id)},r.SerializeMesh=function(t){var r=[],i;return t.subMeshes&&(r=t.subMeshes.map(function(n,t){return{position:t,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount,hasMaterial:!!n.getMaterial(),sphereCenter:n.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:n.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:n.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:n.getBoundingInfo().boundingBox.maximumWorld.asArray()}})),i=null,t instanceof n.Mesh?i=t.geometry?t.geometry.id:null:t instanceof n.InstancedMesh&&(i=t.sourceMesh&&t.sourceMesh.geometry?t.sourceMesh.geometry.id:null),{uniqueId:t.uniqueId,id:t.id,name:t.name,geometryId:i,sphereCenter:t.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:t.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:t.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:t.getBoundingInfo().boundingBox.maximumWorld.asArray(),worldMatrixFromCache:t.worldMatrixFromCache.asArray(),subMeshes:r,checkCollisions:t.checkCollisions}},r.SerializeGeometry=function(t){return{id:t.id,positions:new Float32Array(t.getVerticesData(n.VertexBuffer.PositionKind)||[]),normals:new Float32Array(t.getVerticesData(n.VertexBuffer.NormalKind)||[]),indices:new Int32Array(t.getIndices()||[])}},r}();n.CollisionCoordinatorWorker=r;u=function(){function t(){this._scaledPosition=n.Vector3.Zero();this._scaledVelocity=n.Vector3.Zero();this._finalPosition=n.Vector3.Zero()}return t.prototype.getNewPosition=function(n,t,i,r,u,f,e){n.divideToRef(i.radius,this._scaledPosition);t.divideToRef(i.radius,this._scaledVelocity);i.collidedMesh=null;i.retry=0;i.initialVelocity=this._scaledVelocity;i.initialPosition=this._scaledPosition;this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,u);this._finalPosition.multiplyInPlace(i.radius);f(e,this._finalPosition,i.collidedMesh)},t.prototype.init=function(n){this._scene=n},t.prototype.destroy=function(){},t.prototype.onMeshAdded=function(){},t.prototype.onMeshUpdated=function(){},t.prototype.onMeshRemoved=function(){},t.prototype.onGeometryAdded=function(){},t.prototype.onGeometryUpdated=function(){},t.prototype.onGeometryDeleted=function(){},t.prototype._collideWithWorld=function(t,i,r,u,f,e){var h,s,o;if(void 0===e&&(e=null),h=10*n.Engine.CollisionsEpsilon,r.retry>=u)return void f.copyFrom(t);for(r._initialize(t,i,h),s=0;s<this._scene.meshes.length;s++)o=this._scene.meshes[s],o.isEnabled()&&o.checkCollisions&&o.subMeshes&&o!==e&&o._checkCollision(r);return r.collisionFound?(0===i.x&&0===i.y&&0===i.z||r._getResponse(t,i),i.length()<=h?void f.copyFrom(t):(r.retry++,void this._collideWithWorld(t,i,r,u,f,e))):void t.addToRef(i,f)},t}();n.CollisionCoordinatorLegacy=u}(i||(i={}));!function(n){var t=function(t){function i(r,u,f){t.call(this,r,f);this.upVector=n.Vector3.Up();this.orthoLeft=null;this.orthoRight=null;this.orthoBottom=null;this.orthoTop=null;this.fov=.8;this.minZ=1;this.maxZ=1e4;this.inertia=.9;this.mode=i.PERSPECTIVE_CAMERA;this.isIntermediate=!1;this.viewport=new n.Viewport(0,0,1,1);this.layerMask=268435455;this.fovMode=i.FOVMODE_VERTICAL_FIXED;this.cameraRigMode=i.RIG_MODE_NONE;this._rigCameras=[];this._computedViewMatrix=n.Matrix.Identity();this._projectionMatrix=new n.Matrix;this._doNotComputeProjectionMatrix=!1;this._postProcesses=[];this._transformMatrix=n.Matrix.Zero();this._webvrViewMatrix=n.Matrix.Identity();this._activeMeshes=new n.SmartArray(256);this._globalPosition=n.Vector3.Zero();this._refreshFrustumPlanes=!0;f.addCamera(this);f.activeCamera||(f.activeCamera=this);this.position=u}return u(i,t),Object.defineProperty(i,"PERSPECTIVE_CAMERA",{get:function(){return i._PERSPECTIVE_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ORTHOGRAPHIC_CAMERA",{get:function(){return i._ORTHOGRAPHIC_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FOVMODE_VERTICAL_FIXED",{get:function(){return i._FOVMODE_VERTICAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FOVMODE_HORIZONTAL_FIXED",{get:function(){return i._FOVMODE_HORIZONTAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_NONE",{get:function(){return i._RIG_MODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_ANAGLYPH",{get:function(){return i._RIG_MODE_STEREOSCOPIC_ANAGLYPH},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL",{get:function(){return i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED",{get:function(){return i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_STEREOSCOPIC_OVERUNDER",{get:function(){return i._RIG_MODE_STEREOSCOPIC_OVERUNDER},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_VR",{get:function(){return i._RIG_MODE_VR},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RIG_MODE_WEBVR",{get:function(){return i._RIG_MODE_WEBVR},enumerable:!0,configurable:!0}),i.prototype.toString=function(n){var i="Name: "+this.name,t;if(i+=", type: "+this.getTypeName(),this.animations)for(t=0;t<this.animations.length;t++)i+=", animation[0]: "+this.animations[t].toString(n);return i},Object.defineProperty(i.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:!0,configurable:!0}),i.prototype.getActiveMeshes=function(){return this._activeMeshes},i.prototype.isActiveMesh=function(n){return this._activeMeshes.indexOf(n)!==-1},i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache.position=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.upVector=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.mode=void 0;this._cache.minZ=void 0;this._cache.maxZ=void 0;this._cache.fov=void 0;this._cache.fovMode=void 0;this._cache.aspectRatio=void 0;this._cache.orthoLeft=void 0;this._cache.orthoRight=void 0;this._cache.orthoBottom=void 0;this._cache.orthoTop=void 0;this._cache.renderWidth=void 0;this._cache.renderHeight=void 0},i.prototype._updateCache=function(n){n||t.prototype._updateCache.call(this);var i=this.getEngine();this._cache.position.copyFrom(this.position);this._cache.upVector.copyFrom(this.upVector);this._cache.mode=this.mode;this._cache.minZ=this.minZ;this._cache.maxZ=this.maxZ;this._cache.fov=this.fov;this._cache.fovMode=this.fovMode;this._cache.aspectRatio=i.getAspectRatio(this);this._cache.orthoLeft=this.orthoLeft;this._cache.orthoRight=this.orthoRight;this._cache.orthoBottom=this.orthoBottom;this._cache.orthoTop=this.orthoTop;this._cache.renderWidth=i.getRenderWidth();this._cache.renderHeight=i.getRenderHeight()},i.prototype._updateFromScene=function(){this.updateCache();this.update()},i.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},i.prototype._isSynchronizedViewMatrix=function(){return!!t.prototype._isSynchronized.call(this)&&this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent()},i.prototype._isSynchronizedProjectionMatrix=function(){var t=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ,n;return t?(n=this.getEngine(),this.mode===i.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===n.getAspectRatio(this):this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===n.getRenderWidth()&&this._cache.renderHeight===n.getRenderHeight()):!1},i.prototype.attachControl=function(){},i.prototype.detachControl=function(){},i.prototype.update=function(){this.cameraRigMode!==i.RIG_MODE_NONE&&this._updateRigCameras();this._checkInputs()},i.prototype._checkInputs=function(){},i.prototype._cascadePostProcessesToRigCams=function(){var r,u,t,i,f;for(this._postProcesses.length>0&&this._postProcesses[0].markTextureDirty(),r=0,u=this._rigCameras.length;r<u;r++)t=this._rigCameras[r],i=t._rigPostProcess,i?(f=i instanceof n.PassPostProcess,f&&(t.isIntermediate=0===this._postProcesses.length),t._postProcesses=this._postProcesses.slice(0).concat(i),i.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)},i.prototype.attachPostProcess=function(t,i){return void 0===i&&(i=null),!t.isReusable()&&this._postProcesses.indexOf(t)>-1?(n.Tools.Error("You're trying to reuse a post process not defined as reusable."),0):(null==i||i<0?this._postProcesses.push(t):this._postProcesses.splice(i,0,t),this._cascadePostProcessesToRigCams(),this._postProcesses.indexOf(t))},i.prototype.detachPostProcess=function(n,t){var i,f,r,u;if(void 0===t&&(t=null),r=[],t)for(t=t instanceof Array?t:[t],i=t.length-1;i>=0;i--)this._postProcesses[t[i]]===n?this._postProcesses.splice(f,1):r.push(i);else u=this._postProcesses.indexOf(n),u!==-1&&this._postProcesses.splice(u,1);return this._cascadePostProcessesToRigCams(),r},i.prototype.getWorldMatrix=function(){this._worldMatrix||(this._worldMatrix=n.Matrix.Identity());var t=this.getViewMatrix();return t.invertToRef(this._worldMatrix),this._worldMatrix},i.prototype._getViewMatrix=function(){return n.Matrix.Identity()},i.prototype.getViewMatrix=function(t){return this._computedViewMatrix=this._computeViewMatrix(t),!t&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._refreshFrustumPlanes=!0,this.parent&&this.parent.getWorldMatrix?(this._worldMatrix||(this._worldMatrix=n.Matrix.Identity()),this._computedViewMatrix.invertToRef(this._worldMatrix),this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._computedViewMatrix),this._globalPosition.copyFromFloats(this._computedViewMatrix.m[12],this._computedViewMatrix.m[13],this._computedViewMatrix.m[14]),this._computedViewMatrix.invert(),this._markSyncedWithParent()):this._globalPosition.copyFrom(this.position),this._currentRenderId=this.getScene().getRenderId(),this._computedViewMatrix)},i.prototype._computeViewMatrix=function(n){return!n&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._computedViewMatrix)},i.prototype.freezeProjectionMatrix=function(n){this._doNotComputeProjectionMatrix=!0;void 0!==n&&(this._projectionMatrix=n)},i.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=!1},i.prototype.getProjectionMatrix=function(t){var r,e,u,f;return this._doNotComputeProjectionMatrix||!t&&this._isSynchronizedProjectionMatrix()?this._projectionMatrix:(this._refreshFrustumPlanes=!0,r=this.getEngine(),e=this.getScene(),this.mode===i.PERSPECTIVE_CAMERA)?(this.minZ<=0&&(this.minZ=.1),e.useRightHandedSystem?n.Matrix.PerspectiveFovRHToRef(this.fov,r.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===i.FOVMODE_VERTICAL_FIXED):n.Matrix.PerspectiveFovLHToRef(this.fov,r.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===i.FOVMODE_VERTICAL_FIXED),this._projectionMatrix):(u=r.getRenderWidth()/2,f=r.getRenderHeight()/2,e.useRightHandedSystem?n.Matrix.OrthoOffCenterRHToRef(this.orthoLeft||-u,this.orthoRight||u,this.orthoBottom||-f,this.orthoTop||f,this.minZ,this.maxZ,this._projectionMatrix):n.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-u,this.orthoRight||u,this.orthoBottom||-f,this.orthoTop||f,this.minZ,this.maxZ,this._projectionMatrix),this._projectionMatrix)},i.prototype.getTranformationMatrix=function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix},i.prototype.updateFrustumPlanes=function(){this._refreshFrustumPlanes&&(this.getTranformationMatrix(),this._frustumPlanes?n.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=n.Frustum.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)},i.prototype.isInFrustum=function(n){return this.updateFrustumPlanes(),n.isInFrustum(this._frustumPlanes)},i.prototype.isCompletelyInFrustum=function(n){return this.updateFrustumPlanes(),n.isCompletelyInFrustum(this._frustumPlanes)},i.prototype.dispose=function(){for(this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;)this._rigCameras.pop().dispose();for(var n=0;n<this._postProcesses.length;++n)this._postProcesses[n].dispose(this);t.prototype.dispose.call(this)},i.prototype.setCameraRigMode=function(t,r){for(var f,u;this._rigCameras.length>0;)this._rigCameras.pop().dispose();switch(this.cameraRigMode=t,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=r.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=n.Tools.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==i.RIG_MODE_NONE&&(this._rigCameras.push(this.createRigCamera(this.name+"_L",0)),this._rigCameras.push(this.createRigCamera(this.name+"_R",1))),this.cameraRigMode){case i.RIG_MODE_STEREOSCOPIC_ANAGLYPH:this._rigCameras[0]._rigPostProcess=new n.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]);this._rigCameras[1]._rigPostProcess=new n.AnaglyphPostProcess(this.name+"_anaglyph",1,this._rigCameras);break;case i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case i.RIG_MODE_STEREOSCOPIC_OVERUNDER:f=this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;this._rigCameras[0]._rigPostProcess=new n.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]);this._rigCameras[1]._rigPostProcess=new n.StereoscopicInterlacePostProcess(this.name+"_stereoInterlace",this._rigCameras,f);break;case i.RIG_MODE_VR:u=r.vrCameraMetrics||n.VRCameraMetrics.GetDefault();this._rigCameras[0]._cameraRigParams.vrMetrics=u;this._rigCameras[0].viewport=new n.Viewport(0,0,.5,1);this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new n.Matrix;this._rigCameras[0]._cameraRigParams.vrHMatrix=u.leftHMatrix;this._rigCameras[0]._cameraRigParams.vrPreViewMatrix=u.leftPreViewMatrix;this._rigCameras[0].getProjectionMatrix=this._rigCameras[0]._getVRProjectionMatrix;this._rigCameras[1]._cameraRigParams.vrMetrics=u;this._rigCameras[1].viewport=new n.Viewport(.5,0,.5,1);this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new n.Matrix;this._rigCameras[1]._cameraRigParams.vrHMatrix=u.rightHMatrix;this._rigCameras[1]._cameraRigParams.vrPreViewMatrix=u.rightPreViewMatrix;this._rigCameras[1].getProjectionMatrix=this._rigCameras[1]._getVRProjectionMatrix;u.compensateDistortion&&(this._rigCameras[0]._rigPostProcess=new n.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Left",this._rigCameras[0],!1,u),this._rigCameras[1]._rigPostProcess=new n.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Right",this._rigCameras[1],!0,u));break;case i.RIG_MODE_WEBVR:r.vrDisplay&&(this._rigCameras[0].viewport=new n.Viewport(0,0,.5,1),this._rigCameras[0].setCameraRigParameter("left",!0),this._rigCameras[0].setCameraRigParameter("frameData",r.frameData),this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new n.Matrix,this._rigCameras[0].getProjectionMatrix=this._getWebVRProjectionMatrix,this._rigCameras[1].viewport=new n.Viewport(.5,0,.5,1),this._rigCameras[1].setCameraRigParameter("frameData",r.frameData),this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new n.Matrix,this._rigCameras[1].getProjectionMatrix=this._getWebVRProjectionMatrix)}this._cascadePostProcessesToRigCams();this.update()},i.prototype._getVRProjectionMatrix=function(){return n.Matrix.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix},i.prototype._getWebVRProjectionMatrix=function(){var t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return[8,9,10,11].forEach(function(n){t[n]*=-1}),n.Matrix.FromArrayToRef(t,0,this._projectionMatrix),this._projectionMatrix},i.prototype._getWebVRViewMatrix=function(){var t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return[8,9,10,11].forEach(function(n){t[n]*=-1}),n.Matrix.FromArrayToRef(t,0,this._webvrViewMatrix),this._webvrViewMatrix},i.prototype.setCameraRigParameter=function(t,i){this._cameraRigParams||(this._cameraRigParams={});this._cameraRigParams[t]=i;"interaxialDistance"===t&&(this._cameraRigParams.stereoHalfAngle=n.Tools.ToRadians(i/.0637))},i.prototype.createRigCamera=function(){return null},i.prototype._updateRigCameras=function(){for(var n=0;n<this._rigCameras.length;n++)this._rigCameras[n].minZ=this.minZ,this._rigCameras[n].maxZ=this.maxZ,this._rigCameras[n].fov=this.fov;this.cameraRigMode===i.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)},i.prototype._setupInputs=function(){},i.prototype.serialize=function(){var t=n.SerializationHelper.Serialize(this);return t.type=this.getTypeName(),this.parent&&(t.parentId=this.parent.id),this.inputs&&this.inputs.serialize(t),n.Animation.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t},i.prototype.getTypeName=function(){return"Camera"},i.prototype.clone=function(t){return n.SerializationHelper.Clone(i.GetConstructorFromName(this.getTypeName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this)},i.prototype.getDirection=function(t){var i=n.Vector3.Zero();return this.getDirectionToRef(t,i),i},i.prototype.getDirectionToRef=function(t,i){n.Vector3.TransformNormalToRef(t,this.getWorldMatrix(),i)},i.GetConstructorFromName=function(t,i,r,u,f){switch(void 0===u&&(u=0),void 0===f&&(f=!0),t){case"ArcRotateCamera":return function(){return new n.ArcRotateCamera(i,0,0,1,n.Vector3.Zero(),r)};case"DeviceOrientationCamera":return function(){return new n.DeviceOrientationCamera(i,n.Vector3.Zero(),r)};case"FollowCamera":return function(){return new n.FollowCamera(i,n.Vector3.Zero(),r)};case"ArcFollowCamera":return function(){return new n.ArcFollowCamera(i,0,0,1,null,r)};case"GamepadCamera":return function(){return new n.GamepadCamera(i,n.Vector3.Zero(),r)};case"TouchCamera":return function(){return new n.TouchCamera(i,n.Vector3.Zero(),r)};case"VirtualJoysticksCamera":return function(){return new n.VirtualJoysticksCamera(i,n.Vector3.Zero(),r)};case"WebVRFreeCamera":return function(){return new n.WebVRFreeCamera(i,n.Vector3.Zero(),r)};case"VRDeviceOrientationFreeCamera":return function(){return new n.VRDeviceOrientationFreeCamera(i,n.Vector3.Zero(),r)};case"AnaglyphArcRotateCamera":return function(){return new n.AnaglyphArcRotateCamera(i,0,0,1,n.Vector3.Zero(),u,r)};case"AnaglyphFreeCamera":return function(){return new n.AnaglyphFreeCamera(i,n.Vector3.Zero(),u,r)};case"AnaglyphGamepadCamera":return function(){return new n.AnaglyphGamepadCamera(i,n.Vector3.Zero(),u,r)};case"AnaglyphUniversalCamera":return function(){return new n.AnaglyphUniversalCamera(i,n.Vector3.Zero(),u,r)};case"StereoscopicArcRotateCamera":return function(){return new n.StereoscopicArcRotateCamera(i,0,0,1,n.Vector3.Zero(),u,f,r)};case"StereoscopicFreeCamera":return function(){return new n.StereoscopicFreeCamera(i,n.Vector3.Zero(),u,f,r)};case"StereoscopicGamepadCamera":return function(){return new n.StereoscopicGamepadCamera(i,n.Vector3.Zero(),u,f,r)};case"StereoscopicUniversalCamera":return function(){return new n.StereoscopicUniversalCamera(i,n.Vector3.Zero(),u,f,r)};case"FreeCamera":return function(){return new n.UniversalCamera(i,n.Vector3.Zero(),r)};default:return function(){return new n.UniversalCamera(i,n.Vector3.Zero(),r)}}},i.Parse=function(t,r){var s=t.type,h=i.GetConstructorFromName(s,t.name,r,t.interaxial_distance,t.isStereoscopicSideBySide),u=n.SerializationHelper.Parse(h,t,r),e,f,o;if((t.parentId&&(u._waitingParentId=t.parentId),u.inputs&&(u.inputs.parse(t),u._setupInputs()),t.target&&u.setTarget&&u.setTarget(n.Vector3.FromArray(t.target)),t.cameraRigMode)&&(e=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{},u.setCameraRigMode(t.cameraRigMode,e)),t.animations){for(f=0;f<t.animations.length;f++)o=t.animations[f],u.animations.push(n.Animation.Parse(o));n.Node.ParseAnimationRanges(u,t,r)}return t.autoAnimate&&r.beginAnimation(u,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),u},i._PERSPECTIVE_CAMERA=0,i._ORTHOGRAPHIC_CAMERA=1,i._FOVMODE_VERTICAL_FIXED=0,i._FOVMODE_HORIZONTAL_FIXED=1,i._RIG_MODE_NONE=0,i._RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,i._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,i._RIG_MODE_STEREOSCOPIC_OVERUNDER=13,i._RIG_MODE_VR=20,i._RIG_MODE_WEBVR=21,i.ForceAttachControlToAlwaysPreventDefault=!1,r([n.serializeAsVector3()],i.prototype,"position",void 0),r([n.serializeAsVector3()],i.prototype,"upVector",void 0),r([n.serialize()],i.prototype,"orthoLeft",void 0),r([n.serialize()],i.prototype,"orthoRight",void 0),r([n.serialize()],i.prototype,"orthoBottom",void 0),r([n.serialize()],i.prototype,"orthoTop",void 0),r([n.serialize()],i.prototype,"fov",void 0),r([n.serialize()],i.prototype,"minZ",void 0),r([n.serialize()],i.prototype,"maxZ",void 0),r([n.serialize()],i.prototype,"inertia",void 0),r([n.serialize()],i.prototype,"mode",void 0),r([n.serialize()],i.prototype,"layerMask",void 0),r([n.serialize()],i.prototype,"fovMode",void 0),r([n.serialize()],i.prototype,"cameraRigMode",void 0),r([n.serialize()],i.prototype,"interaxialDistance",void 0),r([n.serialize()],i.prototype,"isStereoscopicSideBySide",void 0),i}(n.Node);n.Camera=t}(i||(i={}));!function(n){n.CameraInputTypes={};var t=function(){function t(n){this.attached={};this.camera=n;this.checkInputs=function(){}}return t.prototype.add=function(t){var i=t.getSimpleName();return this.attached[i]?void n.Tools.Warn("camera input of type "+i+" already exists on camera"):(this.attached[i]=t,t.camera=this.camera,t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t))),void(this.attachedElement&&t.attachControl(this.attachedElement)))},t.prototype.remove=function(n){var t,i;for(t in this.attached)i=this.attached[t],i===n&&(i.detachControl(this.attachedElement),delete this.attached[t],this.rebuildInputCheck())},t.prototype.removeByType=function(n){var t,i;for(t in this.attached)i=this.attached[t],i.getTypeName()===n&&(i.detachControl(this.attachedElement),delete this.attached[t],this.rebuildInputCheck())},t.prototype._addCheckInputs=function(n){var t=this.checkInputs;return function(){t();n()}},t.prototype.attachInput=function(n){n.attachControl(this.attachedElement,this.noPreventDefault)},t.prototype.attachElement=function(t,i){if(!this.attachedElement){i=!n.Camera.ForceAttachControlToAlwaysPreventDefault&&i;this.attachedElement=t;this.noPreventDefault=i;for(var r in this.attached)this.attached[r],this.attached[r].attachControl(t,i)}},t.prototype.detachElement=function(n){if(this.attachedElement===n){for(var t in this.attached)this.attached[t],this.attached[t].detachControl(n);this.attachedElement=null}},t.prototype.rebuildInputCheck=function(){var t,n;this.checkInputs=function(){};for(t in this.attached)n=this.attached[t],n.checkInputs&&(this.checkInputs=this._addCheckInputs(n.checkInputs.bind(n)))},t.prototype.clear=function(){this.attachedElement&&this.detachElement(this.attachedElement);this.attached={};this.attachedElement=null;this.checkInputs=function(){}},t.prototype.serialize=function(t){var r={},u,i,f;for(u in this.attached)i=this.attached[u],f=n.SerializationHelper.Serialize(i),r[i.getTypeName()]=f;t.inputsmgr=r},t.prototype.parse=function(t){var f=t.inputsmgr,e,i,r,u;if(f){this.clear();for(i in f)r=n.CameraInputTypes[i],r&&(e=f[i],u=n.SerializationHelper.Parse(function(){return new r},e,null),this.add(u))}else for(i in this.attached)r=n.CameraInputTypes[this.attached[i].getTypeName()],r&&(u=n.SerializationHelper.Parse(function(){return new r},t,null),this.remove(this.attached[i]),this.add(u))},t}();n.CameraInputsManager=t}(i||(i={}));!function(n){var t=function(){function t(n){void 0===n&&(n=!0);this.touchEnabled=n;this.buttons=[0,1,2];this.angularSensibility=2e3}return t.prototype.attachControl=function(t,i){var r=this,u=this.camera.getEngine();this._pointerInput||(this._pointerInput=function(f){var e=f.event,o,s;if((r.touchEnabled||"touch"!==e.pointerType)&&(f.type===n.PointerEventTypes.POINTERMOVE||r.buttons.indexOf(e.button)!==-1))if(f.type===n.PointerEventTypes.POINTERDOWN){try{e.srcElement.setPointerCapture(e.pointerId)}catch(h){}r.previousPosition={x:e.clientX,y:e.clientY};i||(e.preventDefault(),t.focus())}else if(f.type===n.PointerEventTypes.POINTERUP){try{e.srcElement.releasePointerCapture(e.pointerId)}catch(h){}r.previousPosition=null;i||e.preventDefault()}else if(f.type===n.PointerEventTypes.POINTERMOVE){if(!r.previousPosition||u.isPointerLock)return;o=e.clientX-r.previousPosition.x;s=e.clientY-r.previousPosition.y;r.camera.getScene().useRightHandedSystem?r.camera.cameraRotation.y-=o/r.angularSensibility:r.camera.cameraRotation.y+=o/r.angularSensibility;r.camera.cameraRotation.x+=s/r.angularSensibility;r.previousPosition={x:e.clientX,y:e.clientY};i||e.preventDefault()}});this._onMouseMove=function(n){if(u.isPointerLock){var t=n.movementX||n.mozMovementX||n.webkitMovementX||n.msMovementX||0,f=n.movementY||n.mozMovementY||n.webkitMovementY||n.msMovementY||0;r.camera.getScene().useRightHandedSystem?r.camera.cameraRotation.y-=t/r.angularSensibility:r.camera.cameraRotation.y+=t/r.angularSensibility;r.camera.cameraRotation.x+=f/r.angularSensibility;r.previousPosition=null;i||n.preventDefault()}};this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,n.PointerEventTypes.POINTERDOWN|n.PointerEventTypes.POINTERUP|n.PointerEventTypes.POINTERMOVE);t.addEventListener("mousemove",this._onMouseMove,!1)},t.prototype.detachControl=function(n){this._observer&&n&&(this.camera.getScene().onPointerObservable.remove(this._observer),n.removeEventListener("mousemove",this._onMouseMove),this._observer=null,this._onMouseMove=null,this.previousPosition=null)},t.prototype.getTypeName=function(){return"FreeCameraMouseInput"},t.prototype.getSimpleName=function(){return"mouse"},r([n.serialize()],t.prototype,"buttons",void 0),r([n.serialize()],t.prototype,"angularSensibility",void 0),t}();n.FreeCameraMouseInput=t;n.CameraInputTypes.FreeCameraMouseInput=t}(i||(i={}));!function(n){var t=function(){function t(){this._keys=[];this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39]}return t.prototype.attachControl=function(t,i){var r=this;this._onKeyDown||(t.tabIndex=1,this._onKeyDown=function(n){if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1){var t=r._keys.indexOf(n.keyCode);t===-1&&r._keys.push(n.keyCode);i||n.preventDefault()}},this._onKeyUp=function(n){if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1){var t=r._keys.indexOf(n.keyCode);t>=0&&r._keys.splice(t,1);i||n.preventDefault()}},t.addEventListener("keydown",this._onKeyDown,!1),t.addEventListener("keyup",this._onKeyUp,!1),n.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]))},t.prototype.detachControl=function(t){this._onKeyDown&&(t.removeEventListener("keydown",this._onKeyDown),t.removeEventListener("keyup",this._onKeyUp),n.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]),this._keys=[],this._onKeyDown=null,this._onKeyUp=null)},t.prototype.checkInputs=function(){var t,u,i,r;if(this._onKeyDown)for(t=this.camera,u=0;u<this._keys.length;u++)i=this._keys[u],r=t._computeLocalCameraSpeed(),this.keysLeft.indexOf(i)!==-1?t._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?t._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?t._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1&&t._localDirection.copyFromFloats(0,0,-r),t.getScene().useRightHandedSystem&&(t._localDirection.z*=-1),t.getViewMatrix().invertToRef(t._cameraTransformMatrix),n.Vector3.TransformNormalToRef(t._localDirection,t._cameraTransformMatrix,t._transformedDirection),t.cameraDirection.addInPlace(t._transformedDirection)},t.prototype.getTypeName=function(){return"FreeCameraKeyboardMoveInput"},t.prototype._onLostFocus=function(){this._keys=[]},t.prototype.getSimpleName=function(){return"keyboard"},r([n.serialize()],t.prototype,"keysUp",void 0),r([n.serialize()],t.prototype,"keysDown",void 0),r([n.serialize()],t.prototype,"keysLeft",void 0),r([n.serialize()],t.prototype,"keysRight",void 0),t}();n.FreeCameraKeyboardMoveInput=t;n.CameraInputTypes.FreeCameraKeyboardMoveInput=t}(i||(i={}));!function(n){var t=function(){function t(){this._offsetX=null;this._offsetY=null;this._pointerCount=0;this._pointerPressed=[];this.touchAngularSensibility=2e5;this.touchMoveSensibility=250}return t.prototype.attachControl=function(t,i){var u,r=this;void 0===this._pointerInput&&(this._onLostFocus=function(){r._offsetX=null;r._offsetY=null},this._pointerInput=function(t){var f=t.event,e;if("mouse"!==f.pointerType)if(t.type===n.PointerEventTypes.POINTERDOWN){if(i||f.preventDefault(),r._pointerPressed.push(f.pointerId),1!==r._pointerPressed.length)return;u={x:f.clientX,y:f.clientY}}else if(t.type===n.PointerEventTypes.POINTERUP){if(i||f.preventDefault(),e=r._pointerPressed.indexOf(f.pointerId),e===-1)return;if(r._pointerPressed.splice(e,1),0!=e)return;u=null;r._offsetX=null;r._offsetY=null}else if(t.type===n.PointerEventTypes.POINTERMOVE){if(i||f.preventDefault(),!u)return;if(e=r._pointerPressed.indexOf(f.pointerId),0!=e)return;r._offsetX=f.clientX-u.x;r._offsetY=-(f.clientY-u.y)}});this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,n.PointerEventTypes.POINTERDOWN|n.PointerEventTypes.POINTERUP|n.PointerEventTypes.POINTERMOVE);t.addEventListener("blur",this._onLostFocus)},t.prototype.detachControl=function(n){this._pointerInput&&n&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,n.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null,this._pointerPressed=[],this._offsetX=null,this._offsetY=null,this._pointerCount=0)},t.prototype.checkInputs=function(){var t,i,r;this._offsetX&&(t=this.camera,(t.cameraRotation.y+=this._offsetX/this.touchAngularSensibility,this._pointerPressed.length>1)?t.cameraRotation.x+=-this._offsetY/this.touchAngularSensibility:(i=t._computeLocalCameraSpeed(),r=new n.Vector3(0,0,i*this._offsetY/this.touchMoveSensibility),n.Matrix.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,0,t._cameraRotationMatrix),t.cameraDirection.addInPlace(n.Vector3.TransformCoordinates(r,t._cameraRotationMatrix))))},t.prototype.getTypeName=function(){return"FreeCameraTouchInput"},t.prototype.getSimpleName=function(){return"touch"},r([n.serialize()],t.prototype,"touchAngularSensibility",void 0),r([n.serialize()],t.prototype,"touchMoveSensibility",void 0),t}();n.FreeCameraTouchInput=t;n.CameraInputTypes.FreeCameraTouchInput=t}(i||(i={}));!function(n){var t=function(){function t(){var t=this;this._screenOrientationAngle=0;this._screenQuaternion=new n.Quaternion;this._alpha=0;this._beta=0;this._gamma=0;this._orientationChanged=function(){t._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0;t._screenOrientationAngle=-n.Tools.ToRadians(t._screenOrientationAngle/2);t._screenQuaternion.copyFromFloats(0,Math.sin(t._screenOrientationAngle),0,Math.cos(t._screenOrientationAngle))};this._deviceOrientation=function(n){t._alpha=n.alpha;t._beta=n.beta;t._gamma=n.gamma};this._constantTranform=new n.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));this._orientationChanged()}return Object.defineProperty(t.prototype,"camera",{get:function(){return this._camera},set:function(t){this._camera=t;this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new n.Quaternion)},enumerable:!0,configurable:!0}),t.prototype.attachControl=function(){window.addEventListener("orientationchange",this._orientationChanged);window.addEventListener("deviceorientation",this._deviceOrientation);this._orientationChanged()},t.prototype.detachControl=function(){window.removeEventListener("orientationchange",this._orientationChanged);window.removeEventListener("deviceorientation",this._deviceOrientation)},t.prototype.checkInputs=function(){this._alpha&&(n.Quaternion.RotationYawPitchRollToRef(n.Tools.ToRadians(this._alpha),n.Tools.ToRadians(this._beta),-n.Tools.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)},t.prototype.getTypeName=function(){return"FreeCameraDeviceOrientationInput"},t.prototype.getSimpleName=function(){return"deviceOrientation"},t}();n.FreeCameraDeviceOrientationInput=t;n.CameraInputTypes.FreeCameraDeviceOrientationInput=t}(i||(i={}));!function(n){var t=function(){function t(){this.gamepadAngularSensibility=200;this.gamepadMoveSensibility=40}return t.prototype.attachControl=function(){var t=this;this._gamepads=new n.Gamepads(function(n){t._onNewGameConnected(n)})},t.prototype.detachControl=function(){this._gamepads&&this._gamepads.dispose();this.gamepad=null},t.prototype.checkInputs=function(){if(this.gamepad){var t=this.camera,i=this.gamepad.leftStick,u=i.x/this.gamepadMoveSensibility,f=i.y/this.gamepadMoveSensibility;i.x=Math.abs(u)>.005?0+u:0;i.y=Math.abs(f)>.005?0+f:0;var r=this.gamepad.rightStick,e=r.x/this.gamepadAngularSensibility,o=r.y/this.gamepadAngularSensibility;r.x=Math.abs(e)>.001?0+e:0;r.y=Math.abs(o)>.001?0+o:0;var h=n.Matrix.RotationYawPitchRoll(t.rotation.y,t.rotation.x,0),s=50*t._computeLocalCameraSpeed(),c=n.Vector3.TransformCoordinates(new n.Vector3(i.x*s,0,-i.y*s),h);t.cameraDirection=t.cameraDirection.add(c);t.cameraRotation=t.cameraRotation.add(new n.Vector2(r.y,r.x))}},t.prototype._onNewGameConnected=function(n){0===n.index&&(this.gamepad=n)},t.prototype.getTypeName=function(){return"FreeCameraGamepadInput"},t.prototype.getSimpleName=function(){return"gamepad"},r([n.serialize()],t.prototype,"gamepadAngularSensibility",void 0),r([n.serialize()],t.prototype,"gamepadMoveSensibility",void 0),t}();n.FreeCameraGamepadInput=t;n.CameraInputTypes.FreeCameraGamepadInput=t}(i||(i={}));!function(n){var t=function(){function t(){this._keys=[];this.keysUp=[38];this.keysDown=[40];this.keysLeft=[37];this.keysRight=[39]}return t.prototype.attachControl=function(t,i){var r=this;t.tabIndex=1;this._onKeyDown=function(n){if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1){var t=r._keys.indexOf(n.keyCode);t===-1&&r._keys.push(n.keyCode);n.preventDefault&&(i||n.preventDefault())}};this._onKeyUp=function(n){if(r.keysUp.indexOf(n.keyCode)!==-1||r.keysDown.indexOf(n.keyCode)!==-1||r.keysLeft.indexOf(n.keyCode)!==-1||r.keysRight.indexOf(n.keyCode)!==-1){var t=r._keys.indexOf(n.keyCode);t>=0&&r._keys.splice(t,1);n.preventDefault&&(i||n.preventDefault())}};this._onLostFocus=function(){r._keys=[]};t.addEventListener("keydown",this._onKeyDown,!1);t.addEventListener("keyup",this._onKeyUp,!1);n.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])},t.prototype.detachControl=function(t){t&&(t.removeEventListener("keydown",this._onKeyDown),t.removeEventListener("keyup",this._onKeyUp));n.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}]);this._keys=[];this._onKeyDown=null;this._onKeyUp=null;this._onLostFocus=null},t.prototype.checkInputs=function(){var n,i,t;if(this._onKeyDown)for(n=this.camera,i=0;i<this._keys.length;i++)t=this._keys[i],this.keysLeft.indexOf(t)!==-1?n.inertialAlphaOffset-=.01:this.keysUp.indexOf(t)!==-1?n.inertialBetaOffset-=.01:this.keysRight.indexOf(t)!==-1?n.inertialAlphaOffset+=.01:this.keysDown.indexOf(t)!==-1&&(n.inertialBetaOffset+=.01)},t.prototype.getTypeName=function(){return"ArcRotateCameraKeyboardMoveInput"},t.prototype.getSimpleName=function(){return"keyboard"},r([n.serialize()],t.prototype,"keysUp",void 0),r([n.serialize()],t.prototype,"keysDown",void 0),r([n.serialize()],t.prototype,"keysLeft",void 0),r([n.serialize()],t.prototype,"keysRight",void 0),t}();n.ArcRotateCameraKeyboardMoveInput=t;n.CameraInputTypes.ArcRotateCameraKeyboardMoveInput=t}(i||(i={}));!function(n){var t=function(){function t(){this.wheelPrecision=3}return t.prototype.attachControl=function(t,i){var r=this;this._wheel=function(t){if(t.type===n.PointerEventTypes.POINTERWHEEL){var u=t.event,f=0;u.wheelDelta?f=u.wheelDelta/(40*r.wheelPrecision):u.detail&&(f=-u.detail/r.wheelPrecision);f&&(r.camera.inertialRadiusOffset+=f);u.preventDefault&&(i||u.preventDefault())}};this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,n.PointerEventTypes.POINTERWHEEL)},t.prototype.detachControl=function(n){this._observer&&n&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)},t.prototype.getTypeName=function(){return"ArcRotateCameraMouseWheelInput"},t.prototype.getSimpleName=function(){return"mousewheel"},r([n.serialize()],t.prototype,"wheelPrecision",void 0),t}();n.ArcRotateCameraMouseWheelInput=t;n.CameraInputTypes.ArcRotateCameraMouseWheelInput=t}(i||(i={}));!function(n){var t=(n.Tools.GetPointerPrefix(),function(){function t(){this.buttons=[0,1,2];this.angularSensibilityX=1e3;this.angularSensibilityY=1e3;this.pinchPrecision=6;this.panningSensibility=50;this._isPanClick=!1;this.pinchInwards=!0}return t.prototype.attachControl=function(t,i){var u,f,e,r=this,s=this.camera.getEngine(),o=0;this._pointerInput=function(s){var h=s.event,a,v,l;if(s.type===n.PointerEventTypes.POINTERMOVE||r.buttons.indexOf(h.button)!==-1)if(s.type===n.PointerEventTypes.POINTERDOWN){try{h.srcElement.setPointerCapture(h.pointerId)}catch(b){}r._isPanClick=h.button===r.camera._panningMouseButton;u={x:h.clientX,y:h.clientY,pointerId:h.pointerId,type:h.pointerType};void 0===f?f=u:void 0===e&&(e=u);i||(h.preventDefault(),t.focus())}else if(s.type===n.PointerEventTypes.POINTERUP){try{h.srcElement.releasePointerCapture(h.pointerId)}catch(b){}u=null;o=0;f=e=void 0;i||h.preventDefault()}else if(s.type===n.PointerEventTypes.POINTERMOVE)if(i||h.preventDefault(),f&&void 0===e)0!==r.panningSensibility&&(h.ctrlKey&&r.camera._useCtrlForPanning||!r.camera._useCtrlForPanning&&r._isPanClick)?(r.camera.inertialPanningX+=-(h.clientX-u.x)/r.panningSensibility,r.camera.inertialPanningY+=(h.clientY-u.y)/r.panningSensibility):(a=h.clientX-u.x,v=h.clientY-u.y,r.camera.inertialAlphaOffset-=a/r.angularSensibilityX,r.camera.inertialBetaOffset-=v/r.angularSensibilityY),u.x=h.clientX,u.y=h.clientY;else if(f&&e){l=f.pointerId===h.pointerId?f:e;l.x=h.clientX;l.y=h.clientY;var w=r.pinchInwards?1:-1,y=f.x-e.x,p=f.y-e.y,c=y*y+p*p;if(0===o)return void(o=c);c!==o&&(r.camera.inertialRadiusOffset+=(c-o)/(r.pinchPrecision*((r.angularSensibilityX+r.angularSensibilityY)/2)*w),o=c)}};this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,n.PointerEventTypes.POINTERDOWN|n.PointerEventTypes.POINTERUP|n.PointerEventTypes.POINTERMOVE);this._onContextMenu=function(n){n.preventDefault()};this.camera._useCtrlForPanning||t.addEventListener("contextmenu",this._onContextMenu,!1);this._onLostFocus=function(){f=e=void 0;o=0;u=null};this._onMouseMove=function(n){if(s.isPointerLock){var t=n.movementX||n.mozMovementX||n.webkitMovementX||n.msMovementX||0,u=n.movementY||n.mozMovementY||n.webkitMovementY||n.msMovementY||0;r.camera.inertialAlphaOffset-=t/r.angularSensibilityX;r.camera.inertialBetaOffset-=u/r.angularSensibilityY;i||n.preventDefault()}};this._onGestureStart=function(n){void 0!==window.MSGesture&&(r._MSGestureHandler||(r._MSGestureHandler=new MSGesture,r._MSGestureHandler.target=t),r._MSGestureHandler.addPointer(n.pointerId))};this._onGesture=function(n){r.camera.radius*=n.scale;n.preventDefault&&(i||(n.stopPropagation(),n.preventDefault()))};t.addEventListener("mousemove",this._onMouseMove,!1);t.addEventListener("MSPointerDown",this._onGestureStart,!1);t.addEventListener("MSGestureChange",this._onGesture,!1);t.addEventListener("keydown",this._onKeyDown,!1);t.addEventListener("keyup",this._onKeyUp,!1);n.Tools.RegisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])},t.prototype.detachControl=function(t){t&&this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,t.removeEventListener("contextmenu",this._onContextMenu),t.removeEventListener("mousemove",this._onMouseMove),t.removeEventListener("MSPointerDown",this._onGestureStart),t.removeEventListener("MSGestureChange",this._onGesture),t.removeEventListener("keydown",this._onKeyDown),t.removeEventListener("keyup",this._onKeyUp),this._isPanClick=!1,this.pinchInwards=!0,this._onKeyDown=null,this._onKeyUp=null,this._onMouseMove=null,this._onGestureStart=null,this._onGesture=null,this._MSGestureHandler=null,this._onLostFocus=null,this._onContextMenu=null);n.Tools.UnregisterTopRootEvents([{name:"blur",handler:this._onLostFocus}])},t.prototype.getTypeName=function(){return"ArcRotateCameraPointersInput"},t.prototype.getSimpleName=function(){return"pointers"},r([n.serialize()],t.prototype,"buttons",void 0),r([n.serialize()],t.prototype,"angularSensibilityX",void 0),r([n.serialize()],t.prototype,"angularSensibilityY",void 0),r([n.serialize()],t.prototype,"pinchPrecision",void 0),r([n.serialize()],t.prototype,"panningSensibility",void 0),t}());n.ArcRotateCameraPointersInput=t;n.CameraInputTypes.ArcRotateCameraPointersInput=t}(i||(i={}));!function(n){var t=function(){function t(){this.gamepadRotationSensibility=80;this.gamepadMoveSensibility=40}return t.prototype.attachControl=function(){var t=this;this._gamepads=new n.Gamepads(function(n){t._onNewGameConnected(n)})},t.prototype.detachControl=function(){this._gamepads&&this._gamepads.dispose();this.gamepad=null},t.prototype.checkInputs=function(){var u,n,t,i,f,r;this.gamepad&&(u=this.camera,n=this.gamepad.rightStick,0!=n.x&&(t=n.x/this.gamepadRotationSensibility,0!=t&&Math.abs(t)>.005&&(u.inertialAlphaOffset+=t)),0!=n.y&&(i=n.y/this.gamepadRotationSensibility,0!=i&&Math.abs(i)>.005&&(u.inertialBetaOffset+=i)),f=this.gamepad.leftStick,0!=f.y&&(r=f.y/this.gamepadMoveSensibility,0!=r&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)))},t.prototype._onNewGameConnected=function(n){0===n.index&&(this.gamepad=n)},t.prototype.getTypeName=function(){return"ArcRotateCameraGamepadInput"},t.prototype.getSimpleName=function(){return"gamepad"},r([n.serialize()],t.prototype,"gamepadRotationSensibility",void 0),r([n.serialize()],t.prototype,"gamepadMoveSensibility",void 0),t}();n.ArcRotateCameraGamepadInput=t;n.CameraInputTypes.ArcRotateCameraGamepadInput=t}(i||(i={}));!function(n){var t=function(){function n(){this.alphaCorrection=1;this.betaCorrection=1;this.gammaCorrection=1;this._alpha=0;this._beta=0;this._gamma=0;this._dirty=!1;this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}return n.prototype.attachControl=function(n,t){this.camera.attachControl(n,t);window.addEventListener("deviceorientation",this._deviceOrientationHandler)},n.prototype._onOrientationEvent=function(n){this.camera;this._alpha=0|+n.alpha;this._beta=0|+n.beta;this._gamma=0|+n.gamma;this._dirty=!0},n.prototype.checkInputs=function(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)},n.prototype.detachControl=function(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)},n.prototype.getTypeName=function(){return"ArcRotateCameraVRDeviceOrientationInput"},n.prototype.getSimpleName=function(){return"VRDeviceOrientation"},n}();n.ArcRotateCameraVRDeviceOrientationInput=t;n.CameraInputTypes.ArcRotateCameraVRDeviceOrientationInput=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u){t.call(this,i,r,u);this.cameraDirection=new n.Vector3(0,0,0);this.cameraRotation=new n.Vector2(0,0);this.rotation=new n.Vector3(0,0,0);this.speed=2;this.noRotationConstraint=!1;this.lockedTarget=null;this._currentTarget=n.Vector3.Zero();this._viewMatrix=n.Matrix.Zero();this._camMatrix=n.Matrix.Zero();this._cameraTransformMatrix=n.Matrix.Zero();this._cameraRotationMatrix=n.Matrix.Zero();this._referencePoint=new n.Vector3(0,0,1);this._defaultUpVector=new n.Vector3(0,1,0);this._transformedReferencePoint=n.Vector3.Zero();this._lookAtTemp=n.Matrix.Zero();this._tempMatrix=n.Matrix.Zero()}return u(i,t),i.prototype.getFrontPosition=function(n){var t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(n),this.globalPosition.add(t)},i.prototype._getLockedTargetPosition=function(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null},i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache.lockedTarget=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotation=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.rotationQuaternion=new n.Quaternion(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},i.prototype._updateCache=function(n){n||t.prototype._updateCache.call(this);var i=this._getLockedTargetPosition();i?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(i):this._cache.lockedTarget=i.clone():this._cache.lockedTarget=null;this._cache.rotation.copyFrom(this.rotation);this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)},i.prototype._isSynchronizedViewMatrix=function(){if(!t.prototype._isSynchronizedViewMatrix.call(this))return!1;var n=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(n):!n)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))},i.prototype._computeLocalCameraSpeed=function(){var n=this.getEngine();return this.speed*Math.sqrt(n.getDeltaTime()/(100*n.getFps()))},i.prototype.setTarget=function(t){this.upVector.normalize();n.Matrix.LookAtLHToRef(this.position,t,this._defaultUpVector,this._camMatrix);this._camMatrix.invert();this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var i=t.subtract(this.position);this.rotation.y=i.x>=0?-Math.atan(i.z/i.x)+Math.PI/2:-Math.atan(i.z/i.x)-Math.PI/2;this.rotation.z=0;isNaN(this.rotation.x)&&(this.rotation.x=0);isNaN(this.rotation.y)&&(this.rotation.y=0);isNaN(this.rotation.z)&&(this.rotation.z=0);this.rotationQuaternion&&n.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)},i.prototype.getTarget=function(){return this._currentTarget},i.prototype._decideIfNeedsToMove=function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},i.prototype._updatePosition=function(){this.position.addInPlace(this.cameraDirection)},i.prototype._checkInputs=function(){var r=this._decideIfNeedsToMove(),u=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0,i;(r&&this._updatePosition(),u&&(this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,!this.noRotationConstraint))&&(i=Math.PI/2*.95,this.rotation.x>i&&(this.rotation.x=i),this.rotation.x<-i&&(this.rotation.x=-i));r&&(Math.abs(this.cameraDirection.x)<n.Epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<n.Epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<n.Epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia));u&&(Math.abs(this.cameraRotation.x)<n.Epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<n.Epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia));t.prototype._checkInputs.call(this)},i.prototype._updateCameraRotationMatrix=function(){this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix),n.Vector3.TransformNormalToRef(this._defaultUpVector,this._cameraRotationMatrix,this.upVector)):n.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)},i.prototype._getViewMatrix=function(){return this.lockedTarget?this._currentTarget.copyFrom(this._getLockedTargetPosition()):(this._updateCameraRotationMatrix(),n.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget)),this.getScene().useRightHandedSystem?n.Matrix.LookAtRHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix):n.Matrix.LookAtLHToRef(this.position,this._currentTarget,this.upVector,this._viewMatrix),this._viewMatrix},i.prototype.createRigCamera=function(t){if(this.cameraRigMode!==n.Camera.RIG_MODE_NONE){var r=new i(t,this.position.clone(),this.getScene());return this.cameraRigMode!==n.Camera.RIG_MODE_VR&&this.cameraRigMode!==n.Camera.RIG_MODE_WEBVR||(this.rotationQuaternion||(this.rotationQuaternion=new n.Quaternion),r._cameraRigParams={},r.rotationQuaternion=new n.Quaternion),r}return null},i.prototype._updateRigCameras=function(){var i=this._rigCameras[0],r=this._rigCameras[1],u,f;switch(this.cameraRigMode){case n.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case n.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:u=this.cameraRigMode===n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1;f=this.cameraRigMode===n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*u,i.position);this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*f,r.position);i.setTarget(this.getTarget());r.setTarget(this.getTarget());break;case n.Camera.RIG_MODE_VR:case n.Camera.RIG_MODE_WEBVR:i.rotationQuaternion?(i.rotationQuaternion.copyFrom(this.rotationQuaternion),r.rotationQuaternion.copyFrom(this.rotationQuaternion)):(i.rotation.copyFrom(this.rotation),r.rotation.copyFrom(this.rotation));i.position.copyFrom(this.position);r.position.copyFrom(this.position)}t.prototype._updateRigCameras.call(this)},i.prototype._getRigCamPosition=function(t,i){this._rigCamTransformMatrix||(this._rigCamTransformMatrix=new n.Matrix);var r=this.getTarget();n.Matrix.Translation(-r.x,-r.y,-r.z).multiplyToRef(n.Matrix.RotationY(t),this._rigCamTransformMatrix);this._rigCamTransformMatrix=this._rigCamTransformMatrix.multiply(n.Matrix.Translation(r.x,r.y,r.z));n.Vector3.TransformCoordinatesToRef(this.position,this._rigCamTransformMatrix,i)},i.prototype.getTypeName=function(){return"TargetCamera"},r([n.serializeAsVector3()],i.prototype,"rotation",void 0),r([n.serialize()],i.prototype,"speed",void 0),r([n.serializeAsMeshReference("lockedTargetId")],i.prototype,"lockedTarget",void 0),i}(n.Camera);n.TargetCamera=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u){var f=this;t.call(this,i,r,u);this.ellipsoid=new n.Vector3(.5,1,.5);this.checkCollisions=!1;this.applyGravity=!1;this._collider=new n.Collider;this._needMoveForGravity=!1;this._oldPosition=n.Vector3.Zero();this._diffPosition=n.Vector3.Zero();this._newPosition=n.Vector3.Zero();this._onCollisionPositionChange=function(t,i,r){void 0===r&&(r=null);f.getScene().workerCollisions&&i.multiplyInPlace(f._collider.radius);var u=function(t){f._newPosition.copyFrom(t);f._newPosition.subtractToRef(f._oldPosition,f._diffPosition);f.position.clone();f._diffPosition.length()>n.Engine.CollisionsEpsilon&&(f.position.addInPlace(f._diffPosition),f.onCollide&&r&&f.onCollide(r))};u(i)};this.inputs=new n.FreeCameraInputsManager(this);this.inputs.addKeyboard().addMouse()}return u(i,t),Object.defineProperty(i.prototype,"angularSensibility",{get:function(){var n=this.inputs.attached.mouse;if(n)return n.angularSensibility},set:function(n){var t=this.inputs.attached.mouse;t&&(t.angularSensibility=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysUp",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysUp},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysUp=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysDown",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysDown},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysDown=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysLeft",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysLeft},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysLeft=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysRight",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysRight},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysRight=n)},enumerable:!0,configurable:!0}),i.prototype.attachControl=function(n,t){this.inputs.attachElement(n,t)},i.prototype.detachControl=function(t){this.inputs.detachElement(t);this.cameraDirection=new n.Vector3(0,0,0);this.cameraRotation=new n.Vector2(0,0)},i.prototype._collideWithWorld=function(t){var r,i;r=this.parent?n.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position;r.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition);this._collider.radius=this.ellipsoid;i=t;this.applyGravity&&(i=t.add(this.getScene().gravity));this.getScene().collisionCoordinator.getNewPosition(this._oldPosition,i,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},i.prototype._checkInputs=function(){this._localDirection||(this._localDirection=n.Vector3.Zero(),this._transformedDirection=n.Vector3.Zero());this.inputs.checkInputs();t.prototype._checkInputs.call(this)},i.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},i.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):this.position.addInPlace(this.cameraDirection)},i.prototype.dispose=function(){this.inputs.clear();t.prototype.dispose.call(this)},i.prototype.getTypeName=function(){return"FreeCamera"},r([n.serializeAsVector3()],i.prototype,"ellipsoid",void 0),r([n.serialize()],i.prototype,"checkCollisions",void 0),r([n.serialize()],i.prototype,"applyGravity",void 0),i}(n.TargetCamera);n.FreeCamera=t}(i||(i={}));!function(n){var t=function(t){function i(n){t.call(this,n)}return u(i,t),i.prototype.addKeyboard=function(){return this.add(new n.FreeCameraKeyboardMoveInput),this},i.prototype.addMouse=function(t){return void 0===t&&(t=!0),this.add(new n.FreeCameraMouseInput(t)),this},i.prototype.addGamepad=function(){return this.add(new n.FreeCameraGamepadInput),this},i.prototype.addDeviceOrientation=function(){return this.add(new n.FreeCameraDeviceOrientationInput),this},i.prototype.addTouch=function(){return this.add(new n.FreeCameraTouchInput),this},i.prototype.addVirtualJoystick=function(){return this.add(new n.FreeCameraVirtualJoystickInput),this},i}(n.CameraInputsManager);n.FreeCameraInputsManager=t}(i||(i={}));!function(n){var i=function(t){function i(n,i,r,u){t.call(this,n,i,r);this.radius=12;this.rotationOffset=0;this.heightOffset=4;this.cameraAcceleration=.05;this.maxCameraSpeed=20;this.lockedTarget=u}return u(i,t),i.prototype.getRadians=function(n){return n*Math.PI/180},i.prototype.follow=function(t){var e,f;if(t){t.rotationQuaternion?(f=new n.Matrix,t.rotationQuaternion.toRotationMatrix(f),e=Math.atan2(f.m[8],f.m[10])):e=t.rotation.y;var o=this.getRadians(this.rotationOffset)+e,s=t.position.x+Math.sin(o)*this.radius,h=t.position.z+Math.cos(o)*this.radius,c=s-this.position.x,l=t.position.y+this.heightOffset-this.position.y,a=h-this.position.z,i=c*this.cameraAcceleration*2,r=l*this.cameraAcceleration,u=a*this.cameraAcceleration*2;(i>this.maxCameraSpeed||i<-this.maxCameraSpeed)&&(i=i<1?-this.maxCameraSpeed:this.maxCameraSpeed);(r>this.maxCameraSpeed||r<-this.maxCameraSpeed)&&(r=r<1?-this.maxCameraSpeed:this.maxCameraSpeed);(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed);this.position=new n.Vector3(this.position.x+i,this.position.y+r,this.position.z+u);this.setTarget(t.position)}},i.prototype._checkInputs=function(){t.prototype._checkInputs.call(this);this.follow(this.lockedTarget)},i.prototype.getTypeName=function(){return"FollowCamera"},r([n.serialize()],i.prototype,"radius",void 0),r([n.serialize()],i.prototype,"rotationOffset",void 0),r([n.serialize()],i.prototype,"heightOffset",void 0),r([n.serialize()],i.prototype,"cameraAcceleration",void 0),r([n.serialize()],i.prototype,"maxCameraSpeed",void 0),r([n.serializeAsMeshReference("lockedTargetId")],i.prototype,"lockedTarget",void 0),i}(n.TargetCamera),t;n.FollowCamera=i;t=function(t){function i(i,r,u,f,e,o){t.call(this,i,n.Vector3.Zero(),o);this.alpha=r;this.beta=u;this.radius=f;this.target=e;this._cartesianCoordinates=n.Vector3.Zero();this.follow()}return u(i,t),i.prototype.follow=function(){this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta);this._cartesianCoordinates.y=this.radius*Math.sin(this.beta);this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);this.position=this.target.position.add(this._cartesianCoordinates);this.setTarget(this.target.position)},i.prototype._checkInputs=function(){t.prototype._checkInputs.call(this);this.follow()},i.prototype.getTypeName=function(){return"ArcFollowCamera"},i}(n.TargetCamera);n.ArcFollowCamera=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r){n.call(this,t,i,r);this.inputs.addTouch();this._setupInputs()}return u(t,n),Object.defineProperty(t.prototype,"touchAngularSensibility",{get:function(){var n=this.inputs.attached.touch;if(n)return n.touchAngularSensibility},set:function(n){var t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"touchMoveSensibility",{get:function(){var n=this.inputs.attached.touch;if(n)return n.touchMoveSensibility},set:function(n){var t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=n)},enumerable:!0,configurable:!0}),t.prototype.getTypeName=function(){return"TouchCamera"},t.prototype._setupInputs=function(){var n=this.inputs.attached.mouse;n&&(n.touchEnabled=!1)},t}(n.FreeCamera);n.TouchCamera=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o){var s=this;t.call(this,i,n.Vector3.Zero(),o);this.inertialAlphaOffset=0;this.inertialBetaOffset=0;this.inertialRadiusOffset=0;this.lowerAlphaLimit=null;this.upperAlphaLimit=null;this.lowerBetaLimit=.01;this.upperBetaLimit=Math.PI;this.lowerRadiusLimit=null;this.upperRadiusLimit=null;this.inertialPanningX=0;this.inertialPanningY=0;this.zoomOnFactor=1;this.targetScreenOffset=n.Vector2.Zero();this.allowUpsideDown=!0;this._viewMatrix=new n.Matrix;this.panningAxis=new n.Vector3(1,1,0);this.checkCollisions=!1;this.collisionRadius=new n.Vector3(.5,.5,.5);this._collider=new n.Collider;this._previousPosition=n.Vector3.Zero();this._collisionVelocity=n.Vector3.Zero();this._newPosition=n.Vector3.Zero();this._onCollisionPositionChange=function(t,i,r){var e,u;void 0===r&&(r=null);s.getScene().workerCollisions&&s.checkCollisions&&i.multiplyInPlace(s._collider.radius);r?(s.setPosition(i),s.onCollide&&s.onCollide(r)):s._previousPosition.copyFrom(s.position);var o=Math.cos(s.alpha),h=Math.sin(s.alpha),c=Math.cos(s.beta),f=Math.sin(s.beta);0===f&&(f=.0001);e=s._getTargetPosition();e.addToRef(new n.Vector3(s.radius*o*f,s.radius*c,s.radius*h*f),s._newPosition);s.position.copyFrom(s._newPosition);u=s.upVector;s.allowUpsideDown&&s.beta<0&&(u=u.clone(),u=u.negate());n.Matrix.LookAtLHToRef(s.position,e,u,s._viewMatrix);s._viewMatrix.m[12]+=s.targetScreenOffset.x;s._viewMatrix.m[13]+=s.targetScreenOffset.y;s._collisionTriggered=!1};this.target=e?e:n.Vector3.Zero();this.alpha=r;this.beta=u;this.radius=f;this.getViewMatrix();this.inputs=new n.ArcRotateCameraInputsManager(this);this.inputs.addKeyboard().addMouseWheel().addPointers().addGamepad()}return u(i,t),Object.defineProperty(i.prototype,"angularSensibilityX",{get:function(){var n=this.inputs.attached.pointers;if(n)return n.angularSensibilityX},set:function(n){var t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"angularSensibilityY",{get:function(){var n=this.inputs.attached.pointers;if(n)return n.angularSensibilityY},set:function(n){var t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"pinchPrecision",{get:function(){var n=this.inputs.attached.pointers;if(n)return n.pinchPrecision},set:function(n){var t=this.inputs.attached.pointers;t&&(t.pinchPrecision=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"panningSensibility",{get:function(){var n=this.inputs.attached.pointers;if(n)return n.panningSensibility},set:function(n){var t=this.inputs.attached.pointers;t&&(t.panningSensibility=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysUp",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysUp},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysUp=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysDown",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysDown},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysDown=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysLeft",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysLeft},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysLeft=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"keysRight",{get:function(){var n=this.inputs.attached.keyboard;if(n)return n.keysRight},set:function(n){var t=this.inputs.attached.keyboard;t&&(t.keysRight=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"wheelPrecision",{get:function(){var n=this.inputs.attached.mousewheel;if(n)return n.wheelPrecision},set:function(n){var t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=n)},enumerable:!0,configurable:!0}),i.prototype._initCache=function(){t.prototype._initCache.call(this);this._cache.target=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this._cache.alpha=void 0;this._cache.beta=void 0;this._cache.radius=void 0;this._cache.targetScreenOffset=n.Vector2.Zero()},i.prototype._updateCache=function(n){n||t.prototype._updateCache.call(this);this._cache.target.copyFrom(this._getTargetPosition());this._cache.alpha=this.alpha;this._cache.beta=this.beta;this._cache.radius=this.radius;this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)},i.prototype._getTargetPosition=function(){if(this.target.getAbsolutePosition){var n=this.target.getAbsolutePosition();return this._targetBoundingCenter?n.add(this._targetBoundingCenter):n}return this.target},i.prototype._isSynchronizedViewMatrix=function(){return!!t.prototype._isSynchronizedViewMatrix.call(this)&&this._cache.target.equals(this.target)&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)},i.prototype.attachControl=function(n,t,i,r){var u=this;void 0===i&&(i=!0);void 0===r&&(r=2);this._useCtrlForPanning=i;this._panningMouseButton=r;this.inputs.attachElement(n,t);this._reset=function(){u.inertialAlphaOffset=0;u.inertialBetaOffset=0;u.inertialRadiusOffset=0}},i.prototype.detachControl=function(n){this.inputs.detachElement(n);this._reset&&this._reset()},i.prototype._checkInputs=function(){this._collisionTriggered||(this.inputs.checkInputs(),0===this.inertialAlphaOffset&&0===this.inertialBetaOffset&&0===this.inertialRadiusOffset||(this.getScene().useRightHandedSystem?this.alpha-=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset:this.alpha+=this.beta<=0?-this.inertialAlphaOffset:this.inertialAlphaOffset,this.beta+=this.inertialBetaOffset,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<n.Epsilon&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<n.Epsilon&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<n.Epsilon&&(this.inertialRadiusOffset=0)),0===this.inertialPanningX&&0===this.inertialPanningY||(this._localDirection||(this._localDirection=n.Vector3.Zero(),this._transformedDirection=n.Vector3.Zero()),this.inertialPanningX*=this.inertia,this.inertialPanningY*=this.inertia,Math.abs(this.inertialPanningX)<n.Epsilon&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<n.Epsilon&&(this.inertialPanningY=0),this._localDirection.copyFromFloats(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY),this._localDirection.multiplyInPlace(this.panningAxis),this._viewMatrix.invertToRef(this._cameraTransformMatrix),n.Vector3.TransformNormalToRef(this._localDirection,this._cameraTransformMatrix,this._transformedDirection),this.panningAxis.y||(this._transformedDirection.y=0),this.target.getAbsolutePosition||this.target.addInPlace(this._transformedDirection)),this._checkLimits(),t.prototype._checkInputs.call(this))},i.prototype._checkLimits=function(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit);null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit);this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit);this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit);this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit);this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit)},i.prototype.rebuildAnglesAndRadius=function(){var n=this.position.subtract(this._getTargetPosition());this.radius=n.length();this.alpha=Math.acos(n.x/Math.sqrt(Math.pow(n.x,2)+Math.pow(n.z,2)));n.z<0&&(this.alpha=2*Math.PI-this.alpha);this.beta=Math.acos(n.y/this.radius);this._checkLimits()},i.prototype.setPosition=function(n){this.position.equals(n)||(this.position.copyFrom(n),this.rebuildAnglesAndRadius())},i.prototype.setTarget=function(n,t){void 0===t&&(t=!1);this._getTargetPosition().equals(n)||(this._targetBoundingCenter=t&&n.getBoundingInfo?n.getBoundingInfo().boundingBox.center.clone():null,this.target=n,this.rebuildAnglesAndRadius())},i.prototype._getViewMatrix=function(){var u=Math.cos(this.alpha),f=Math.sin(this.alpha),e=Math.cos(this.beta),r=Math.sin(this.beta),i,t;return 0===r&&(r=.0001),i=this._getTargetPosition(),(i.addToRef(new n.Vector3(this.radius*u*r,this.radius*e,this.radius*f*r),this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions)?(this._collider.radius=this.collisionRadius,this._newPosition.subtractToRef(this.position,this._collisionVelocity),this._collisionTriggered=!0,this.getScene().collisionCoordinator.getNewPosition(this.position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)):(this.position.copyFrom(this._newPosition),t=this.upVector,this.allowUpsideDown&&this.beta<0&&(t=t.clone(),t=t.negate()),this.getScene().useRightHandedSystem?n.Matrix.LookAtRHToRef(this.position,i,t,this._viewMatrix):n.Matrix.LookAtLHToRef(this.position,i,t,this._viewMatrix),this._viewMatrix.m[12]+=this.targetScreenOffset.x,this._viewMatrix.m[13]+=this.targetScreenOffset.y),this._currentTarget=i,this._viewMatrix},i.prototype.zoomOn=function(t,i){void 0===i&&(i=!1);t=t||this.getScene().meshes;var r=n.Mesh.MinMax(t),u=n.Vector3.Distance(r.min,r.max);this.radius=u*this.zoomOnFactor;this.focusOn({min:r.min,max:r.max,distance:u},i)},i.prototype.focusOn=function(t,i){void 0===i&&(i=!1);var r,u;void 0===t.min?(r=t||this.getScene().meshes,r=n.Mesh.MinMax(r),u=n.Vector3.Distance(r.min,r.max)):(r=t,u=t.distance);this.target=n.Mesh.Center(r);i||(this.maxZ=2*u)},i.prototype.createRigCamera=function(t,r){var u,f;switch(this.cameraRigMode){case n.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case n.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case n.Camera.RIG_MODE_VR:u=this._cameraRigParams.stereoHalfAngle*(0===r?1:-1);break;case n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:u=this._cameraRigParams.stereoHalfAngle*(0===r?-1:1)}return f=new i(t,this.alpha+u,this.beta,this.radius,this.target,this.getScene()),f._cameraRigParams={},f},i.prototype._updateRigCameras=function(){var i=this._rigCameras[0],r=this._rigCameras[1];switch(i.beta=r.beta=this.beta,i.radius=r.radius=this.radius,this.cameraRigMode){case n.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case n.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:case n.Camera.RIG_MODE_VR:i.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;r.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;r.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}t.prototype._updateRigCameras.call(this)},i.prototype.dispose=function(){this.inputs.clear();t.prototype.dispose.call(this)},i.prototype.getTypeName=function(){return"ArcRotateCamera"},r([n.serialize()],i.prototype,"alpha",void 0),r([n.serialize()],i.prototype,"beta",void 0),r([n.serialize()],i.prototype,"radius",void 0),r([n.serializeAsVector3()],i.prototype,"target",void 0),r([n.serialize()],i.prototype,"inertialAlphaOffset",void 0),r([n.serialize()],i.prototype,"inertialBetaOffset",void 0),r([n.serialize()],i.prototype,"inertialRadiusOffset",void 0),r([n.serialize()],i.prototype,"lowerAlphaLimit",void 0),r([n.serialize()],i.prototype,"upperAlphaLimit",void 0),r([n.serialize()],i.prototype,"lowerBetaLimit",void 0),r([n.serialize()],i.prototype,"upperBetaLimit",void 0),r([n.serialize()],i.prototype,"lowerRadiusLimit",void 0),r([n.serialize()],i.prototype,"upperRadiusLimit",void 0),r([n.serialize()],i.prototype,"inertialPanningX",void 0),r([n.serialize()],i.prototype,"inertialPanningY",void 0),r([n.serialize()],i.prototype,"zoomOnFactor",void 0),r([n.serialize()],i.prototype,"allowUpsideDown",void 0),i}(n.TargetCamera);n.ArcRotateCamera=t}(i||(i={}));!function(n){var t=function(t){function i(n){t.call(this,n)}return u(i,t),i.prototype.addMouseWheel=function(){return this.add(new n.ArcRotateCameraMouseWheelInput),this},i.prototype.addPointers=function(){return this.add(new n.ArcRotateCameraPointersInput),this},i.prototype.addKeyboard=function(){return this.add(new n.ArcRotateCameraKeyboardMoveInput),this},i.prototype.addGamepad=function(){return this.add(new n.ArcRotateCameraGamepadInput),this},i.prototype.addVRDeviceOrientation=function(){return this.add(new n.ArcRotateCameraVRDeviceOrientationInput),this},i}(n.CameraInputsManager);n.ArcRotateCameraInputsManager=t}(i||(i={}));!function(n){var t=function(){function t(n){this._renderingGroups=[];this._autoClearDepthStencil={};this._customOpaqueSortCompareFn={};this._customAlphaTestSortCompareFn={};this._customTransparentSortCompareFn={};this._renderinGroupInfo=null;this._scene=n;for(var i=t.MIN_RENDERINGGROUPS;i<t.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]=!0}return t.prototype._renderParticles=function(n,t){var u,r,i;if(0!==this._scene._activeParticleSystems.length){for(u=this._scene.activeCamera,this._scene._particlesDuration.beginMonitoring(),r=0;r<this._scene._activeParticleSystems.length;r++)i=this._scene._activeParticleSystems.data[r],i.renderingGroupId===n&&0!=(u.layerMask&i.layerMask)&&(this._clearDepthStencilBuffer(),i.emitter.position&&t&&t.indexOf(i.emitter)===-1||this._scene._activeParticles.addCount(i.render(),!1));this._scene._particlesDuration.endMonitoring(!1)}},t.prototype._renderSprites=function(n){var r,t,i;if(this._scene.spritesEnabled&&0!==this._scene.spriteManagers.length){for(r=this._scene.activeCamera,this._scene._spritesDuration.beginMonitoring(),t=0;t<this._scene.spriteManagers.length;t++)i=this._scene.spriteManagers[t],i.renderingGroupId===n&&0!=(r.layerMask&i.layerMask)&&(this._clearDepthStencilBuffer(),i.render());this._scene._spritesDuration.endMonitoring(!1)}},t.prototype._clearDepthStencilBuffer=function(){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(0,!1,!0,!0),this._depthStencilBufferAlreadyCleaned=!0)},t.prototype._renderSpritesAndParticles=function(){this._currentRenderSprites&&this._renderSprites(this._currentIndex);this._currentRenderParticles&&this._renderParticles(this._currentIndex,this._currentActiveMeshes)},t.prototype.render=function(i,r,u,f){var s=this._scene.onRenderingGroupObservable.hasObservers()?this._scene.onRenderingGroupObservable:null,e=null,o,c,l,h;for(s&&(this._renderinGroupInfo||(this._renderinGroupInfo=new n.RenderingGroupInfo),e=this._renderinGroupInfo,e.scene=this._scene,e.camera=this._scene.activeCamera),this._currentActiveMeshes=r,this._currentRenderParticles=u,this._currentRenderSprites=f,o=t.MIN_RENDERINGGROUPS;o<t.MAX_RENDERINGGROUPS;o++)this._depthStencilBufferAlreadyCleaned=o===t.MIN_RENDERINGGROUPS,c=this._renderingGroups[o],l=!1,(this._currentIndex=o,c)?(h=0,s&&(h=Math.pow(2,o),e.renderStage=n.RenderingGroupInfo.STAGE_PRECLEAR,e.renderingGroupId=o,s.notifyObservers(e,h)),this._autoClearDepthStencil[o]&&this._clearDepthStencilBuffer(),s&&(e.renderStage=n.RenderingGroupInfo.STAGE_PREOPAQUE,s.notifyObservers(e,h)),c.onBeforeTransparentRendering||(c.onBeforeTransparentRendering=this._renderSpritesAndParticles.bind(this)),s&&(e.renderStage=n.RenderingGroupInfo.STAGE_PRETRANSPARENT,s.notifyObservers(e,h)),c.render(i)||(this._renderingGroups.splice(o,1),l=!0,this._renderSpritesAndParticles()),s&&(e.renderStage=n.RenderingGroupInfo.STAGE_POSTTRANSPARENT,s.notifyObservers(e,h))):(this._renderSpritesAndParticles(),s)&&(h=Math.pow(2,o),e.renderStage=n.RenderingGroupInfo.STAGE_PRECLEAR,e.renderingGroupId=o,s.notifyObservers(e,h),e.renderStage=n.RenderingGroupInfo.STAGE_POSTTRANSPARENT,s.notifyObservers(e,h)),l&&o--},t.prototype.reset=function(){for(var i,n=t.MIN_RENDERINGGROUPS;n<t.MAX_RENDERINGGROUPS;n++)i=this._renderingGroups[n],i&&i.prepare()},t.prototype.dispatch=function(t){var r=t.getMesh(),i=r.renderingGroupId||0;this._renderingGroups[i]||(this._renderingGroups[i]=new n.RenderingGroup(i,this._scene,this._customOpaqueSortCompareFn[i],this._customAlphaTestSortCompareFn[i],this._customTransparentSortCompareFn[i]));this._renderingGroups[i].dispatch(t)},t.prototype.setRenderingOrder=function(n,t,i,r){if(void 0===t&&(t=null),void 0===i&&(i=null),void 0===r&&(r=null),this._customOpaqueSortCompareFn[n]=t,this._customAlphaTestSortCompareFn[n]=i,this._customTransparentSortCompareFn[n]=r,this._renderingGroups[n]){var u=this._renderingGroups[n];u.opaqueSortCompareFn=this._customOpaqueSortCompareFn[n];u.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[n];u.transparentSortCompareFn=this._customTransparentSortCompareFn[n]}},t.prototype.setRenderingAutoClearDepthStencil=function(n,t){this._autoClearDepthStencil[n]=t},t.MAX_RENDERINGGROUPS=4,t.MIN_RENDERINGGROUPS=0,t}();n.RenderingManager=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f){void 0===r&&(r=null);void 0===u&&(u=null);void 0===f&&(f=null);this.index=t;this._opaqueSubMeshes=new n.SmartArray(256);this._transparentSubMeshes=new n.SmartArray(256);this._alphaTestSubMeshes=new n.SmartArray(256);this._scene=i;this.opaqueSortCompareFn=r;this.alphaTestSortCompareFn=u;this.transparentSortCompareFn=f}return Object.defineProperty(t.prototype,"opaqueSortCompareFn",{set:function(n){this._opaqueSortCompareFn=n;this._renderOpaque=n?this.renderOpaqueSorted:t.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alphaTestSortCompareFn",{set:function(n){this._alphaTestSortCompareFn=n;this._renderAlphaTest=n?this.renderAlphaTestSorted:t.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transparentSortCompareFn",{set:function(n){this._transparentSortCompareFn=n?n:t.defaultTransparentSortCompare;this._renderTransparent=this.renderTransparentSorted},enumerable:!0,configurable:!0}),t.prototype.render=function(t){if(t)return t(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes),!0;if(0===this._opaqueSubMeshes.length&&0===this._alphaTestSubMeshes.length&&0===this._transparentSubMeshes.length)return this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),!1;var i=this._scene.getEngine();return this._renderOpaque(this._opaqueSubMeshes),i.setAlphaTesting(!0),this._renderAlphaTest(this._alphaTestSubMeshes),i.setAlphaTesting(!1),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._renderTransparent(this._transparentSubMeshes),i.setAlphaMode(n.Engine.ALPHA_DISABLE),!0},t.prototype.renderOpaqueSorted=function(n){return t.renderSorted(n,this._opaqueSortCompareFn,this._scene.activeCamera.globalPosition,!1)},t.prototype.renderAlphaTestSorted=function(n){return t.renderSorted(n,this._alphaTestSortCompareFn,this._scene.activeCamera.globalPosition,!1)},t.prototype.renderTransparentSorted=function(n){return t.renderSorted(n,this._transparentSortCompareFn,this._scene.activeCamera.globalPosition,!0)},t.renderSorted=function(n,t,i,r){for(var f,e,u=0;u<n.length;u++)f=n.data[u],f._alphaIndex=f.getMesh().alphaIndex,f._distanceToCamera=f.getBoundingInfo().boundingSphere.centerWorld.subtract(i).length();for(e=n.data.slice(0,n.length),e.sort(t),u=0;u<e.length;u++)f=e[u],f.render(r)},t.renderUnsorted=function(n){for(var i,t=0;t<n.length;t++)i=n.data[t],i.render(!1)},t.defaultTransparentSortCompare=function(n,i){return n._alphaIndex>i._alphaIndex?1:n._alphaIndex<i._alphaIndex?-1:t.backToFrontSortCompare(n,i)},t.backToFrontSortCompare=function(n,t){return n._distanceToCamera<t._distanceToCamera?1:n._distanceToCamera>t._distanceToCamera?-1:0},t.frontToBackSortCompare=function(n,t){return n._distanceToCamera<t._distanceToCamera?-1:n._distanceToCamera>t._distanceToCamera?1:0},t.prototype.prepare=function(){this._opaqueSubMeshes.reset();this._transparentSubMeshes.reset();this._alphaTestSubMeshes.reset()},t.prototype.dispatch=function(n){var t=n.getMaterial(),i=n.getMesh();t.needAlphaBlending()||i.visibility<1||i.hasVertexAlpha?this._transparentSubMeshes.push(n):t.needAlphaTesting()?this._alphaTestSubMeshes.push(n):this._opaqueSubMeshes.push(n)},t}();n.RenderingGroup=t}(i||(i={}));!function(n){var t=function(){function n(){}return Object.defineProperty(n,"POINTERDOWN",{get:function(){return n._POINTERDOWN},enumerable:!0,configurable:!0}),Object.defineProperty(n,"POINTERUP",{get:function(){return n._POINTERUP},enumerable:!0,configurable:!0}),Object.defineProperty(n,"POINTERMOVE",{get:function(){return n._POINTERMOVE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"POINTERWHEEL",{get:function(){return n._POINTERWHEEL},enumerable:!0,configurable:!0}),Object.defineProperty(n,"POINTERPICK",{get:function(){return n._POINTERPICK},enumerable:!0,configurable:!0}),n._POINTERDOWN=1,n._POINTERUP=2,n._POINTERMOVE=4,n._POINTERWHEEL=8,n._POINTERPICK=16,n}(),f,r,i,e,o;n.PointerEventTypes=t;f=function(){function n(n,t){this.type=n;this.event=t}return n}();n.PointerInfoBase=f;r=function(t){function i(i,r,u,f){t.call(this,i,r);this.skipOnPointerObservable=!1;this.localPosition=new n.Vector2(u,f)}return u(i,t),i}(f);n.PointerInfoPre=r;i=function(n){function t(t,i,r){n.call(this,t,i);this.pickInfo=r}return u(t,n),t}(f);n.PointerInfo=i;e=function(){function n(){}return n.STAGE_PRECLEAR=1,n.STAGE_PREOPAQUE=2,n.STAGE_PRETRANSPARENT=3,n.STAGE_POSTTRANSPARENT=4,n}();n.RenderingGroupInfo=e;o=function(){function u(t){this.autoClear=!0;this.clearColor=new n.Color3(.2,.2,.3);this.ambientColor=new n.Color3(0,0,0);this.forceWireframe=!1;this.forcePointsCloud=!1;this.forceShowBoundingBoxes=!1;this.animationsEnabled=!0;this.constantlyUpdateMeshUnderPointer=!1;this.useRightHandedSystem=!1;this.hoverCursor="pointer";this.metadata=null;this.onDisposeObservable=new n.Observable;this.onBeforeRenderObservable=new n.Observable;this.onAfterRenderObservable=new n.Observable;this.onReadyObservable=new n.Observable;this.onBeforeCameraRenderObservable=new n.Observable;this.onAfterCameraRenderObservable=new n.Observable;this.onNewCameraAddedObservable=new n.Observable;this.onCameraRemovedObservable=new n.Observable;this.onNewLightAddedObservable=new n.Observable;this.onLightRemovedObservable=new n.Observable;this.onNewGeometryAddedObservable=new n.Observable;this.onGeometryRemovedObservable=new n.Observable;this.onNewMeshAddedObservable=new n.Observable;this.onMeshRemovedObservable=new n.Observable;this.onRenderingGroupObservable=new n.Observable;this.animations=[];this.onPrePointerObservable=new n.Observable;this.onPointerObservable=new n.Observable;this.cameraToUseForPointers=null;this._startingPointerPosition=new n.Vector2(0,0);this._startingPointerTime=0;this.fogEnabled=!0;this.fogMode=u.FOGMODE_NONE;this.fogColor=new n.Color3(.2,.2,.3);this.fogDensity=.1;this.fogStart=0;this.fogEnd=1e3;this.shadowsEnabled=!0;this.lightsEnabled=!0;this.lights=[];this.cameras=[];this.activeCameras=[];this.meshes=[];this._geometries=[];this.materials=[];this.multiMaterials=[];this.texturesEnabled=!0;this.textures=[];this.particlesEnabled=!0;this.particleSystems=[];this.spritesEnabled=!0;this.spriteManagers=[];this.layers=[];this.highlightLayers=[];this.skeletonsEnabled=!0;this.skeletons=[];this.lensFlaresEnabled=!0;this.lensFlareSystems=[];this.collisionsEnabled=!0;this.gravity=new n.Vector3(0,-9.807,0);this.postProcessesEnabled=!0;this.renderTargetsEnabled=!0;this.dumpNextRenderTargets=!1;this.customRenderTargets=[];this.importedMeshesFiles=[];this.probesEnabled=!0;this.reflectionProbes=[];this._actionManagers=[];this._meshesForIntersections=new n.SmartArray(256);this.proceduralTexturesEnabled=!0;this._proceduralTextures=[];this.soundTracks=[];this._audioEnabled=!0;this._headphone=!1;this._totalMeshesCounter=new n.PerfCounter;this._totalLightsCounter=new n.PerfCounter;this._totalMaterialsCounter=new n.PerfCounter;this._totalTexturesCounter=new n.PerfCounter;this._totalVertices=new n.PerfCounter;this._activeIndices=new n.PerfCounter;this._activeParticles=new n.PerfCounter;this._lastFrameDuration=new n.PerfCounter;this._evaluateActiveMeshesDuration=new n.PerfCounter;this._renderTargetsDuration=new n.PerfCounter;this._particlesDuration=new n.PerfCounter;this._renderDuration=new n.PerfCounter;this._spritesDuration=new n.PerfCounter;this._activeBones=new n.PerfCounter;this._renderId=0;this._executeWhenReadyTimeoutId=-1;this._intermediateRendering=!1;this._toBeDisposed=new n.SmartArray(256);this._pendingData=[];this._activeMeshes=new n.SmartArray(256);this._processedMaterials=new n.SmartArray(256);this._renderTargets=new n.SmartArray(256);this._activeParticleSystems=new n.SmartArray(256);this._activeSkeletons=new n.SmartArray(32);this._softwareSkinnedMeshes=new n.SmartArray(32);this._activeAnimatables=[];this._transformMatrix=n.Matrix.Zero();this._edgesRenderers=new n.SmartArray(16);this._uniqueIdCounter=0;this._engine=t;t.scenes.push(this);this._externalData=new n.StringDictionary;this._uid=null;this._renderingManager=new n.RenderingManager(this);this.postProcessManager=new n.PostProcessManager(this);this.postProcessRenderPipelineManager=new n.PostProcessRenderPipelineManager;this._boundingBoxRenderer=new n.BoundingBoxRenderer(this);n.OutlineRenderer&&(this._outlineRenderer=new n.OutlineRenderer(this));this.attachControl();n.SoundTrack&&(this.mainSoundTrack=new n.SoundTrack(this,{mainTrack:!0}));n.SimplificationQueue&&(this.simplificationQueue=new n.SimplificationQueue);this.workerCollisions=!1}return Object.defineProperty(u,"FOGMODE_NONE",{get:function(){return u._FOGMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(u,"FOGMODE_EXP",{get:function(){return u._FOGMODE_EXP},enumerable:!0,configurable:!0}),Object.defineProperty(u,"FOGMODE_EXP2",{get:function(){return u._FOGMODE_EXP2},enumerable:!0,configurable:!0}),Object.defineProperty(u,"FOGMODE_LINEAR",{get:function(){return u._FOGMODE_LINEAR},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"beforeRender",{set:function(n){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver);this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"afterRender",{set:function(n){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver);this._onAfterRenderObserver=this.onAfterRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"beforeCameraRender",{set:function(n){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver);this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"afterCameraRender",{set:function(n){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver);this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"unTranslatedPointer",{get:function(){return new n.Vector2(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"defaultMaterial",{get:function(){return this._defaultMaterial||(this._defaultMaterial=new n.StandardMaterial("default material",this)),this._defaultMaterial},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new n.DebugLayer(this)),this._debugLayer},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"workerCollisions",{get:function(){return this._workerCollisions},set:function(t){t=t&&!!Worker;this._workerCollisions=t;this.collisionCoordinator&&this.collisionCoordinator.destroy();this.collisionCoordinator=t?new n.CollisionCoordinatorWorker:new n.CollisionCoordinatorLegacy;this.collisionCoordinator.init(this)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"SelectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"pointerX",{get:function(){return this._pointerX},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"pointerY",{get:function(){return this._pointerY},enumerable:!0,configurable:!0}),u.prototype.getCachedMaterial=function(){return this._cachedMaterial},u.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer},u.prototype.getOutlineRenderer=function(){return this._outlineRenderer},u.prototype.getEngine=function(){return this._engine},u.prototype.getTotalVertices=function(){return this._totalVertices.current},Object.defineProperty(u.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:!0,configurable:!0}),u.prototype.getActiveIndices=function(){return this._activeIndices.current},Object.defineProperty(u.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:!0,configurable:!0}),u.prototype.getActiveParticles=function(){return this._activeParticles.current},Object.defineProperty(u.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:!0,configurable:!0}),u.prototype.getActiveBones=function(){return this._activeBones.current},Object.defineProperty(u.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:!0,configurable:!0}),u.prototype.getLastFrameDuration=function(){return this._lastFrameDuration.current},Object.defineProperty(u.prototype,"lastFramePerfCounter",{get:function(){return this._lastFrameDuration},enumerable:!0,configurable:!0}),u.prototype.getEvaluateActiveMeshesDuration=function(){return this._evaluateActiveMeshesDuration.current},Object.defineProperty(u.prototype,"evaluateActiveMeshesDurationPerfCounter",{get:function(){return this._evaluateActiveMeshesDuration},enumerable:!0,configurable:!0}),u.prototype.getActiveMeshes=function(){return this._activeMeshes},u.prototype.getRenderTargetsDuration=function(){return this._renderTargetsDuration.current},u.prototype.getRenderDuration=function(){return this._renderDuration.current},Object.defineProperty(u.prototype,"renderDurationPerfCounter",{get:function(){return this._renderDuration},enumerable:!0,configurable:!0}),u.prototype.getParticlesDuration=function(){return this._particlesDuration.current},Object.defineProperty(u.prototype,"particlesDurationPerfCounter",{get:function(){return this._particlesDuration},enumerable:!0,configurable:!0}),u.prototype.getSpritesDuration=function(){return this._spritesDuration.current},Object.defineProperty(u.prototype,"spriteDuractionPerfCounter",{get:function(){return this._spritesDuration},enumerable:!0,configurable:!0}),u.prototype.getAnimationRatio=function(){return this._animationRatio},u.prototype.getRenderId=function(){return this._renderId},u.prototype.incrementRenderId=function(){this._renderId++},u.prototype._updatePointerPosition=function(n){var t=this._engine.getRenderingCanvasClientRect();this._pointerX=n.clientX-t.left;this._pointerY=n.clientY-t.top;this._unTranslatedPointerX=this._pointerX;this._unTranslatedPointerY=this._pointerY;this.cameraToUseForPointers&&(this._pointerX=this._pointerX-this.cameraToUseForPointers.viewport.x*this._engine.getRenderWidth(),this._pointerY=this._pointerY-this.cameraToUseForPointers.viewport.y*this._engine.getRenderHeight())},u.prototype.attachControl=function(u,f,e){var o=this,h,c,s;void 0===u&&(u=!0);void 0===f&&(f=!0);void 0===e&&(e=!0);h=function(n){return n.isPickable&&n.actionManager&&n.actionManager.hasPointerTriggers};this._onPointerMove=function(n){var s,u,f,e;(o._updatePointerPosition(n),o.onPrePointerObservable.hasObservers())&&(f="mousewheel"===n.type||"DOMMouseScroll"===n.type?t.POINTERWHEEL:t.POINTERMOVE,e=new r(f,n,o._unTranslatedPointerX,o._unTranslatedPointerY),o.onPrePointerObservable.notifyObservers(e,f),e.skipOnPointerObservable)||(o.cameraToUseForPointers||o.activeCamera)&&(s=o._engine.getRenderingCanvas(),o.pointerMovePredicate||(o.pointerMovePredicate=function(n){return n.isPickable&&n.isVisible&&n.isReady()&&(o.constantlyUpdateMeshUnderPointer||null!==n.actionManager&&void 0!==n.actionManager)}),u=o.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,o.pointerMovePredicate,!1,o.cameraToUseForPointers),(u.hit&&u.pickedMesh?(o.setPointerOverSprite(null),o.setPointerOverMesh(u.pickedMesh),s.style.cursor=o._pointerOverMesh.actionManager&&o._pointerOverMesh.actionManager.hasPointerTriggers?o._pointerOverMesh.actionManager.hoverCursor?o._pointerOverMesh.actionManager.hoverCursor:o.hoverCursor:""):(o.setPointerOverMesh(null),u=o.pickSprite(o._unTranslatedPointerX,o._unTranslatedPointerY,h,!1,o.cameraToUseForPointers),u.hit&&u.pickedSprite?(o.setPointerOverSprite(u.pickedSprite),s.style.cursor=o._pointerOverSprite.actionManager&&o._pointerOverSprite.actionManager.hoverCursor?o._pointerOverSprite.actionManager.hoverCursor:o.hoverCursor):(o.setPointerOverSprite(null),s.style.cursor="")),o.onPointerMove&&o.onPointerMove(n,u),o.onPointerObservable.hasObservers())&&(f="mousewheel"===n.type||"DOMMouseScroll"===n.type?t.POINTERWHEEL:t.POINTERMOVE,e=new i(f,n,u),o.onPointerObservable.notifyObservers(e,f)))};this._onPointerDown=function(u){var f,e,s,c;if(((o._updatePointerPosition(u),!o.onPrePointerObservable.hasObservers())||(s=t.POINTERDOWN,c=new r(s,u,o._unTranslatedPointerX,o._unTranslatedPointerY),o.onPrePointerObservable.notifyObservers(c,s),!c.skipOnPointerObservable))&&(o.cameraToUseForPointers||o.activeCamera)){if(o._startingPointerPosition.x=o._pointerX,o._startingPointerPosition.y=o._pointerY,o._startingPointerTime=(new Date).getTime(),o.pointerDownPredicate||(o.pointerDownPredicate=function(n){return n.isPickable&&n.isVisible&&n.isReady()}),o._pickedDownMesh=null,f=o.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,o.pointerDownPredicate,!1,o.cameraToUseForPointers),f.hit&&f.pickedMesh&&f.pickedMesh.actionManager){if(o._pickedDownMesh=f.pickedMesh,f.pickedMesh.actionManager.hasPickTriggers){switch(u.button){case 0:f.pickedMesh.actionManager.processTrigger(n.ActionManager.OnLeftPickTrigger,n.ActionEvent.CreateNew(f.pickedMesh,u));break;case 1:f.pickedMesh.actionManager.processTrigger(n.ActionManager.OnCenterPickTrigger,n.ActionEvent.CreateNew(f.pickedMesh,u));break;case 2:f.pickedMesh.actionManager.processTrigger(n.ActionManager.OnRightPickTrigger,n.ActionEvent.CreateNew(f.pickedMesh,u))}f.pickedMesh.actionManager&&f.pickedMesh.actionManager.processTrigger(n.ActionManager.OnPickDownTrigger,n.ActionEvent.CreateNew(f.pickedMesh,u))}f.pickedMesh.actionManager&&f.pickedMesh.actionManager.hasSpecificTrigger(n.ActionManager.OnLongPressTrigger)&&(e=o,window.setTimeout(function(){var t=e.pick(e._unTranslatedPointerX,e._unTranslatedPointerY,function(t){return t.isPickable&&t.isVisible&&t.isReady()&&t.actionManager&&t.actionManager.hasSpecificTrigger(n.ActionManager.OnLongPressTrigger)},!1,e.cameraToUseForPointers);t.hit&&t.pickedMesh&&t.pickedMesh.actionManager&&0!==e._startingPointerTime&&(new Date).getTime()-e._startingPointerTime>n.ActionManager.LongPressDelay&&Math.abs(e._startingPointerPosition.x-e._pointerX)<n.ActionManager.DragMovementThreshold&&Math.abs(e._startingPointerPosition.y-e._pointerY)<n.ActionManager.DragMovementThreshold&&(e._startingPointerTime=0,t.pickedMesh.actionManager.processTrigger(n.ActionManager.OnLongPressTrigger,n.ActionEvent.CreateNew(t.pickedMesh,u)))},n.ActionManager.LongPressDelay))}if((o.onPointerDown&&o.onPointerDown(u,f),o.onPointerObservable.hasObservers())&&(s=t.POINTERDOWN,c=new i(s,u,f),o.onPointerObservable.notifyObservers(c,s)),o._pickedDownSprite=null,o.spriteManagers.length>0&&(f=o.pickSprite(o._unTranslatedPointerX,o._unTranslatedPointerY,h,!1,o.cameraToUseForPointers),f.hit&&f.pickedSprite&&f.pickedSprite.actionManager)){switch(o._pickedDownSprite=f.pickedSprite,u.button){case 0:f.pickedSprite.actionManager.processTrigger(n.ActionManager.OnLeftPickTrigger,n.ActionEvent.CreateNewFromSprite(f.pickedSprite,o,u));break;case 1:f.pickedSprite.actionManager.processTrigger(n.ActionManager.OnCenterPickTrigger,n.ActionEvent.CreateNewFromSprite(f.pickedSprite,o,u));break;case 2:f.pickedSprite.actionManager.processTrigger(n.ActionManager.OnRightPickTrigger,n.ActionEvent.CreateNewFromSprite(f.pickedSprite,o,u))}f.pickedSprite.actionManager&&f.pickedSprite.actionManager.processTrigger(n.ActionManager.OnPickDownTrigger,n.ActionEvent.CreateNewFromSprite(f.pickedSprite,o,u))}}};this._onPointerUp=function(u){var f,e,s;(o._updatePointerPosition(u),o.onPrePointerObservable.hasObservers())&&(e=t.POINTERUP,s=new r(e,u,o._unTranslatedPointerX,o._unTranslatedPointerY),o.onPrePointerObservable.notifyObservers(s,e),s.skipOnPointerObservable)||(o.cameraToUseForPointers||o.activeCamera)&&(o.pointerUpPredicate||(o.pointerUpPredicate=function(n){return n.isPickable&&n.isVisible&&n.isReady()}),f=o.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,o.pointerUpPredicate,!1,o.cameraToUseForPointers),f.hit&&f.pickedMesh&&(null!=o._pickedDownMesh&&f.pickedMesh==o._pickedDownMesh&&(o.onPointerPick&&o.onPointerPick(u,f),o.onPointerObservable.hasObservers())&&(e=t.POINTERPICK,s=new i(e,u,f),o.onPointerObservable.notifyObservers(s,e)),f.pickedMesh.actionManager&&(f.pickedMesh.actionManager.processTrigger(n.ActionManager.OnPickUpTrigger,n.ActionEvent.CreateNew(f.pickedMesh,u)),f.pickedMesh.actionManager&&Math.abs(o._startingPointerPosition.x-o._pointerX)<n.ActionManager.DragMovementThreshold&&Math.abs(o._startingPointerPosition.y-o._pointerY)<n.ActionManager.DragMovementThreshold&&f.pickedMesh.actionManager.processTrigger(n.ActionManager.OnPickTrigger,n.ActionEvent.CreateNew(f.pickedMesh,u)))),(o._pickedDownMesh&&o._pickedDownMesh.actionManager&&o._pickedDownMesh!==f.pickedMesh&&o._pickedDownMesh.actionManager.processTrigger(n.ActionManager.OnPickOutTrigger,n.ActionEvent.CreateNew(o._pickedDownMesh,u)),o.onPointerUp&&o.onPointerUp(u,f),o.onPointerObservable.hasObservers())&&(e=t.POINTERUP,s=new i(e,u,f),o.onPointerObservable.notifyObservers(s,e)),o._startingPointerTime=0,o.spriteManagers.length>0&&(f=o.pickSprite(o._unTranslatedPointerX,o._unTranslatedPointerY,h,!1,o.cameraToUseForPointers),f.hit&&f.pickedSprite&&f.pickedSprite.actionManager&&(f.pickedSprite.actionManager.processTrigger(n.ActionManager.OnPickUpTrigger,n.ActionEvent.CreateNewFromSprite(f.pickedSprite,o,u)),f.pickedSprite.actionManager&&Math.abs(o._startingPointerPosition.x-o._pointerX)<n.ActionManager.DragMovementThreshold&&Math.abs(o._startingPointerPosition.y-o._pointerY)<n.ActionManager.DragMovementThreshold&&f.pickedSprite.actionManager.processTrigger(n.ActionManager.OnPickTrigger,n.ActionEvent.CreateNewFromSprite(f.pickedSprite,o,u))),o._pickedDownSprite&&o._pickedDownSprite.actionManager&&o._pickedDownSprite!==f.pickedSprite&&o._pickedDownSprite.actionManager.processTrigger(n.ActionManager.OnPickOutTrigger,n.ActionEvent.CreateNewFromSprite(o._pickedDownSprite,o,u))))};this._onKeyDown=function(t){o.actionManager&&o.actionManager.processTrigger(n.ActionManager.OnKeyDownTrigger,n.ActionEvent.CreateNewFromScene(o,t))};this._onKeyUp=function(t){o.actionManager&&o.actionManager.processTrigger(n.ActionManager.OnKeyUpTrigger,n.ActionEvent.CreateNewFromScene(o,t))};c=n.Tools.GetPointerPrefix();s=this._engine.getRenderingCanvas();e&&(s.addEventListener(c+"move",this._onPointerMove,!1),s.addEventListener("mousewheel",this._onPointerMove,!1),s.addEventListener("DOMMouseScroll",this._onPointerMove,!1));f&&s.addEventListener(c+"down",this._onPointerDown,!1);u&&s.addEventListener(c+"up",this._onPointerUp,!1);s.tabIndex=1;s.addEventListener("keydown",this._onKeyDown,!1);s.addEventListener("keyup",this._onKeyUp,!1)},u.prototype.detachControl=function(){var i=n.Tools.GetPointerPrefix(),t=this._engine.getRenderingCanvas();t.removeEventListener(i+"move",this._onPointerMove);t.removeEventListener(i+"down",this._onPointerDown);t.removeEventListener(i+"up",this._onPointerUp);t.removeEventListener("mousewheel",this._onPointerMove);t.removeEventListener("DOMMouseScroll",this._onPointerMove);t.removeEventListener("keydown",this._onKeyDown);t.removeEventListener("keyup",this._onKeyUp)},u.prototype.isReady=function(){var t,u,i,r;if(this._pendingData.length>0)return!1;for(t=0;t<this._geometries.length;t++)if(u=this._geometries[t],u.delayLoadState===n.Engine.DELAYLOADSTATE_LOADING)return!1;for(t=0;t<this.meshes.length;t++)if((i=this.meshes[t],!i.isReady())||(r=i.material,r&&!r.isReady(i)))return!1;return!0},u.prototype.resetCachedMaterial=function(){this._cachedMaterial=null},u.prototype.registerBeforeRender=function(n){this.onBeforeRenderObservable.add(n)},u.prototype.unregisterBeforeRender=function(n){this.onBeforeRenderObservable.removeCallback(n)},u.prototype.registerAfterRender=function(n){this.onAfterRenderObservable.add(n)},u.prototype.unregisterAfterRender=function(n){this.onAfterRenderObservable.removeCallback(n)},u.prototype._addPendingData=function(n){this._pendingData.push(n)},u.prototype._removePendingData=function(n){var t=this._pendingData.indexOf(n);t!==-1&&this._pendingData.splice(t,1)},u.prototype.getWaitingItemsCount=function(){return this._pendingData.length},u.prototype.executeWhenReady=function(n){var t=this;this.onReadyObservable.add(n);this._executeWhenReadyTimeoutId===-1&&(this._executeWhenReadyTimeoutId=setTimeout(function(){t._checkIsReady()},150))},u.prototype._checkIsReady=function(){var n=this;return this.isReady()?(this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=-1)):void(this._executeWhenReadyTimeoutId=setTimeout(function(){n._checkIsReady()},150))},u.prototype.beginAnimation=function(t,i,r,u,f,e,o){if(void 0===f&&(f=1),this.stopAnimation(t),o||(o=new n.Animatable(this,t,i,r,u,f,e)),t.animations&&o.appendAnimations(t,t.animations),t.getAnimatables)for(var h=t.getAnimatables(),s=0;s<h.length;s++)this.beginAnimation(h[s],i,r,u,f,e,o);return o.reset(),o},u.prototype.beginDirectAnimation=function(t,i,r,u,f,e,o){void 0===e&&(e=1);return new n.Animatable(this,t,r,u,f,e,o,i)},u.prototype.getAnimatableByTarget=function(n){for(var t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===n)return this._activeAnimatables[t];return null},Object.defineProperty(u.prototype,"Animatables",{get:function(){return this._activeAnimatables},enumerable:!0,configurable:!0}),u.prototype.stopAnimation=function(n,t){var i=this.getAnimatableByTarget(n);i&&i.stop(t)},u.prototype._animate=function(){if(this.animationsEnabled&&0!==this._activeAnimatables.length){if(!this._animationStartDate){if(this._pendingData.length>0)return;this._animationStartDate=n.Tools.Now}for(var i=n.Tools.Now,r=i-this._animationStartDate,t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t]._animate(r)}},u.prototype.getViewMatrix=function(){return this._viewMatrix},u.prototype.getProjectionMatrix=function(){return this._projectionMatrix},u.prototype.getTransformMatrix=function(){return this._transformMatrix},u.prototype.setTransformMatrix=function(t,i){this._viewMatrix=t;this._projectionMatrix=i;this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix);this._frustumPlanes?n.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=n.Frustum.GetPlanes(this._transformMatrix)},u.prototype.addMesh=function(n){n.uniqueId=this._uniqueIdCounter++;this.meshes.push(n);this.collisionCoordinator.onMeshAdded(n);this.onNewMeshAddedObservable.notifyObservers(n)},u.prototype.removeMesh=function(n){var t=this.meshes.indexOf(n);return t!==-1&&this.meshes.splice(t,1),this.collisionCoordinator.onMeshRemoved(n),this.onMeshRemovedObservable.notifyObservers(n),t},u.prototype.removeSkeleton=function(n){var t=this.skeletons.indexOf(n);return t!==-1&&this.skeletons.splice(t,1),t},u.prototype.removeLight=function(n){var t=this.lights.indexOf(n);return t!==-1&&this.lights.splice(t,1),this.onLightRemovedObservable.notifyObservers(n),t},u.prototype.removeCamera=function(n){var t=this.cameras.indexOf(n),i;return t!==-1&&this.cameras.splice(t,1),i=this.activeCameras.indexOf(n),i!==-1&&this.activeCameras.splice(i,1),this.activeCamera===n&&(this.activeCamera=this.cameras.length>0?this.cameras[0]:null),this.onCameraRemovedObservable.notifyObservers(n),t},u.prototype.addLight=function(n){n.uniqueId=this._uniqueIdCounter++;this.lights.push(n);this.onNewLightAddedObservable.notifyObservers(n)},u.prototype.addCamera=function(n){n.uniqueId=this._uniqueIdCounter++;this.cameras.push(n);this.onNewCameraAddedObservable.notifyObservers(n)},u.prototype.switchActiveCamera=function(n,t){void 0===t&&(t=!0);var i=this._engine.getRenderingCanvas();this.activeCamera.detachControl(i);this.activeCamera=n;t&&n.attachControl(i)},u.prototype.setActiveCameraByID=function(n){var t=this.getCameraByID(n);return t?(this.activeCamera=t,t):null},u.prototype.setActiveCameraByName=function(n){var t=this.getCameraByName(n);return t?(this.activeCamera=t,t):null},u.prototype.getMaterialByID=function(n){for(var t=0;t<this.materials.length;t++)if(this.materials[t].id===n)return this.materials[t];return null},u.prototype.getMaterialByName=function(n){for(var t=0;t<this.materials.length;t++)if(this.materials[t].name===n)return this.materials[t];return null},u.prototype.getLensFlareSystemByName=function(n){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===n)return this.lensFlareSystems[t];return null},u.prototype.getLensFlareSystemByID=function(n){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===n)return this.lensFlareSystems[t];return null},u.prototype.getCameraByID=function(n){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].id===n)return this.cameras[t];return null},u.prototype.getCameraByUniqueID=function(n){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===n)return this.cameras[t];return null},u.prototype.getCameraByName=function(n){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].name===n)return this.cameras[t];return null},u.prototype.getBoneByID=function(n){for(var r,t,i=0;i<this.skeletons.length;i++)for(r=this.skeletons[i],t=0;t<r.bones.length;t++)if(r.bones[t].id===n)return r.bones[t];return null},u.prototype.getBoneByName=function(n){for(var r,t,i=0;i<this.skeletons.length;i++)for(r=this.skeletons[i],t=0;t<r.bones.length;t++)if(r.bones[t].name===n)return r.bones[t];return null},u.prototype.getLightByName=function(n){for(var t=0;t<this.lights.length;t++)if(this.lights[t].name===n)return this.lights[t];return null},u.prototype.getLightByID=function(n){for(var t=0;t<this.lights.length;t++)if(this.lights[t].id===n)return this.lights[t];return null},u.prototype.getLightByUniqueID=function(n){for(var t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===n)return this.lights[t];return null},u.prototype.getParticleSystemByID=function(n){for(var t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===n)return this.particleSystems[t];return null},u.prototype.getGeometryByID=function(n){for(var t=0;t<this._geometries.length;t++)if(this._geometries[t].id===n)return this._geometries[t];return null},u.prototype.pushGeometry=function(n,t){return!(!t&&this.getGeometryByID(n.id))&&(this._geometries.push(n),this.collisionCoordinator.onGeometryAdded(n),this.onNewGeometryAddedObservable.notifyObservers(n),!0)},u.prototype.removeGeometry=function(n){var t=this._geometries.indexOf(n);return t>-1&&(this._geometries.splice(t,1),this.collisionCoordinator.onGeometryDeleted(n),this.onGeometryRemovedObservable.notifyObservers(n),!0)},u.prototype.getGeometries=function(){return this._geometries},u.prototype.getMeshByID=function(n){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].id===n)return this.meshes[t];return null},u.prototype.getMeshesByID=function(n){return this.meshes.filter(function(t){return t.id===n})},u.prototype.getMeshByUniqueID=function(n){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===n)return this.meshes[t];return null},u.prototype.getLastMeshByID=function(n){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===n)return this.meshes[t];return null},u.prototype.getLastEntryByID=function(n){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===n)return this.meshes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===n)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===n)return this.lights[t];return null},u.prototype.getNodeByID=function(n){var r=this.getMeshByID(n),t,i;return r?r:(t=this.getLightByID(n),t)?t:(i=this.getCameraByID(n),i)?i:this.getBoneByID(n)},u.prototype.getNodeByName=function(n){var r=this.getMeshByName(n),t,i;return r?r:(t=this.getLightByName(n),t)?t:(i=this.getCameraByName(n),i)?i:this.getBoneByName(n)},u.prototype.getMeshByName=function(n){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].name===n)return this.meshes[t];return null},u.prototype.getSoundByName=function(t){var i,r;if(n.AudioEngine){for(i=0;i<this.mainSoundTrack.soundCollection.length;i++)if(this.mainSoundTrack.soundCollection[i].name===t)return this.mainSoundTrack.soundCollection[i];for(r=0;r<this.soundTracks.length;r++)for(i=0;i<this.soundTracks[r].soundCollection.length;i++)if(this.soundTracks[r].soundCollection[i].name===t)return this.soundTracks[r].soundCollection[i]}return null},u.prototype.getLastSkeletonByID=function(n){for(var t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===n)return this.skeletons[t];return null},u.prototype.getSkeletonById=function(n){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===n)return this.skeletons[t];return null},u.prototype.getSkeletonByName=function(n){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===n)return this.skeletons[t];return null},u.prototype.isActiveMesh=function(n){return this._activeMeshes.indexOf(n)!==-1},Object.defineProperty(u.prototype,"uid",{get:function(){return this._uid||(this._uid=n.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),u.prototype.addExternalData=function(n,t){return this._externalData.add(n,t)},u.prototype.getExternalData=function(n){return this._externalData.get(n)},u.prototype.getOrAddExternalDataWithFactory=function(n,t){return this._externalData.getOrAddWithFactory(n,t)},u.prototype.removeExternalData=function(n){return this._externalData.remove(n)},u.prototype._evaluateSubMesh=function(n,t){if(t.alwaysSelectAsActiveMesh||1===t.subMeshes.length||n.isInFrustum(this._frustumPlanes)){var i=n.getMaterial();t.showSubMeshesBoundingBox&&this._boundingBoxRenderer.renderList.push(n.getBoundingInfo().boundingBox);i&&(i.getRenderTargetTextures&&this._processedMaterials.indexOf(i)===-1&&(this._processedMaterials.push(i),this._renderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._activeIndices.addCount(n.indexCount,!1),this._renderingManager.dispatch(n))}},u.prototype._isInIntermediateRendering=function(){return this._intermediateRendering},u.prototype._evaluateActiveMeshes=function(){var f,e,o,r,t,s,u,i;for(this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._boundingBoxRenderer.reset(),this._edgesRenderers.reset(),this._selectionOctree?(o=this._selectionOctree.select(this._frustumPlanes),f=o.data,e=o.length):(e=this.meshes.length,f=this.meshes),r=0;r<e;r++)t=f[r],!t.isBlocked&&(this._totalVertices.addCount(t.getTotalVertices(),!1),t.isReady()&&t.isEnabled())&&(t.computeWorldMatrix(),t.actionManager&&t.actionManager.hasSpecificTriggers([n.ActionManager.OnIntersectionEnterTrigger,n.ActionManager.OnIntersectionExitTrigger])&&this._meshesForIntersections.pushNoDuplicate(t),s=t.getLOD(this.activeCamera),s&&(t._preActivate(),(t.alwaysSelectAsActiveMesh||t.isVisible&&t.visibility>0&&0!=(t.layerMask&this.activeCamera.layerMask)&&t.isInFrustum(this._frustumPlanes))&&(this._activeMeshes.push(t),this.activeCamera._activeMeshes.push(t),t._activate(this._renderId),this._activeMesh(t,s))));if(this._particlesDuration.beginMonitoring(),n.Tools.Now,this.particlesEnabled){for(n.Tools.StartPerformanceCounter("Particles",this.particleSystems.length>0),u=0;u<this.particleSystems.length;u++)i=this.particleSystems[u],i.isStarted()&&(!i.emitter.position||i.emitter&&i.emitter.isEnabled())&&(this._activeParticleSystems.push(i),i.animate());n.Tools.EndPerformanceCounter("Particles",this.particleSystems.length>0)}this._particlesDuration.endMonitoring(!1)},u.prototype._activeMesh=function(n,t){var u,i,f,r,e;if(t.skeleton&&this.skeletonsEnabled&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&t.skeleton.prepare(),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t)),(n.showBoundingBox||this.forceShowBoundingBoxes)&&this._boundingBoxRenderer.renderList.push(n.getBoundingInfo().boundingBox),n._edgesRenderer&&this._edgesRenderers.push(n._edgesRenderer),t&&t.subMeshes)for(t._submeshesOctree&&t.useOctreeForRenderingSelection?(f=t._submeshesOctree.select(this._frustumPlanes),u=f.length,i=f.data):(i=t.subMeshes,u=i.length),r=0;r<u;r++)e=i[r],this._evaluateSubMesh(e,t)},u.prototype.updateTransformMatrix=function(n){this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(n))},u.prototype._renderForCamera=function(t){var r=this._engine,h,y,c,l,w,b,s,f,u,e,o,a,v,p,i;if(n.Tools.Now,this.activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");for(n.Tools.StartPerformanceCounter("Rendering camera "+this.activeCamera.name),r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshesDuration.beginMonitoring(),n.Tools.StartPerformanceCounter("Active meshes evaluation"),this._evaluateActiveMeshes(),this._evaluateActiveMeshesDuration.endMonitoring(!1),n.Tools.EndPerformanceCounter("Active meshes evaluation"),h=0;h<this._softwareSkinnedMeshes.length;h++)y=this._softwareSkinnedMeshes.data[h],y.applySkeleton(y.skeleton);if(this._renderTargetsDuration.beginMonitoring(),c=!1,n.Tools.Now,this.renderTargetsEnabled&&this._renderTargets.length>0){for(this._intermediateRendering=!0,n.Tools.StartPerformanceCounter("Render targets",this._renderTargets.length>0),l=0;l<this._renderTargets.length;l++)u=this._renderTargets.data[l],u._shouldRender()&&(this._renderId++,w=u.activeCamera&&u.activeCamera!==this.activeCamera,u.render(w,this.dumpNextRenderTargets));n.Tools.EndPerformanceCounter("Render targets",this._renderTargets.length>0);this._intermediateRendering=!1;this._renderId++;c=!0}if(b=this._engine.getStencilBuffer(),s=!1,this.renderTargetsEnabled&&this.highlightLayers&&this.highlightLayers.length>0){for(this._intermediateRendering=!0,i=0;i<this.highlightLayers.length;i++)f=this.highlightLayers[i],f.shouldRender()&&(!f.camera||f.camera.cameraRigMode===n.Camera.RIG_MODE_NONE&&t===f.camera||f.camera.cameraRigMode!==n.Camera.RIG_MODE_NONE&&f.camera._rigCameras.indexOf(t)>-1)&&(s=!0,u=f._mainTexture,u._shouldRender()&&(this._renderId++,u.render(!1,!1),c=!0));this._intermediateRendering=!1;this._renderId++}if(c&&r.restoreDefaultFramebuffer(),this._renderTargetsDuration.endMonitoring(!1),this.postProcessManager._prepareFrame(),this._renderDuration.beginMonitoring(),this.layers.length){for(r.setDepthBuffer(!1),e=0;e<this.layers.length;e++)o=this.layers[e],o.isBackground&&o.render();r.setDepthBuffer(!0)}for(n.Tools.StartPerformanceCounter("Main render"),s&&this._engine.setStencilBuffer(!0),this._renderingManager.render(null,null,!0,!0),s&&this._engine.setStencilBuffer(b),n.Tools.EndPerformanceCounter("Main render"),this._boundingBoxRenderer.render(),a=0;a<this._edgesRenderers.length;a++)this._edgesRenderers.data[a].render();if(this.lensFlaresEnabled){for(n.Tools.StartPerformanceCounter("Lens flares",this.lensFlareSystems.length>0),v=0;v<this.lensFlareSystems.length;v++)p=this.lensFlareSystems[v],0!=(t.layerMask&p.layerMask)&&p.render();n.Tools.EndPerformanceCounter("Lens flares",this.lensFlareSystems.length>0)}if(this.layers.length){for(r.setDepthBuffer(!1),e=0;e<this.layers.length;e++)o=this.layers[e],o.isBackground||o.render();r.setDepthBuffer(!0)}if(s){for(r.setDepthBuffer(!1),i=0;i<this.highlightLayers.length;i++)this.highlightLayers[i].shouldRender()&&this.highlightLayers[i].render();r.setDepthBuffer(!0)}this._renderDuration.endMonitoring(!1);this.postProcessManager._finalizeFrame(t.isIntermediate);this.activeCamera._updateFromScene();this._renderTargets.reset();this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera);n.Tools.EndPerformanceCounter("Rendering camera "+this.activeCamera.name)},u.prototype._processSubCameras=function(t){if(t.cameraRigMode===n.Camera.RIG_MODE_NONE)return void this._renderForCamera(t);for(var i=0;i<t._rigCameras.length;i++)this._renderForCamera(t._rigCameras[i]);this.activeCamera=t;this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix());this.activeCamera._updateFromScene()},u.prototype._checkIntersections=function(){for(var t,f,i,u=0;u<this._meshesForIntersections.length;u++)for(t=this._meshesForIntersections.data[u],f=0;f<t.actionManager.actions.length;f++)if(i=t.actionManager.actions[f],i.trigger===n.ActionManager.OnIntersectionEnterTrigger||i.trigger===n.ActionManager.OnIntersectionExitTrigger){var e=i.getTriggerParameter(),r=e instanceof n.AbstractMesh?e:e.mesh,s=r.intersectsMesh(t,e.usePreciseIntersection),o=t._intersectionsInProgress.indexOf(r);s&&o===-1?i.trigger===n.ActionManager.OnIntersectionEnterTrigger?(i._executeCurrent(n.ActionEvent.CreateNew(t,null,r)),t._intersectionsInProgress.push(r)):i.trigger===n.ActionManager.OnIntersectionExitTrigger&&t._intersectionsInProgress.push(r):!s&&o>-1&&(i.trigger===n.ActionManager.OnIntersectionExitTrigger&&i._executeCurrent(n.ActionEvent.CreateNew(t,null,r)),t.actionManager.hasSpecificTrigger(n.ActionManager.OnIntersectionExitTrigger)&&i.trigger!==n.ActionManager.OnIntersectionExitTrigger||t._intersectionsInProgress.splice(o,1))}},u.prototype.render=function(){var h,c,l,f,e,o,a,s,v,t,i,r;if(this._lastFrameDuration.beginMonitoring(),this._particlesDuration.fetchNewFrame(),this._spritesDuration.fetchNewFrame(),this._activeParticles.fetchNewFrame(),this._renderDuration.fetchNewFrame(),this._renderTargetsDuration.fetchNewFrame(),this._evaluateActiveMeshesDuration.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this.getEngine().drawCallsPerfCounter.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),n.Tools.StartPerformanceCounter("Scene rendering"),this.actionManager&&this.actionManager.processTrigger(n.ActionManager.OnEveryFrameTrigger,null),this.simplificationQueue&&!this.simplificationQueue.running&&this.simplificationQueue.executeNext(),h=Math.max(u.MinDeltaTime,Math.min(this._engine.getDeltaTime(),u.MaxDeltaTime)),this._animationRatio=.06*h,this._animate(),this._physicsEngine&&(n.Tools.StartPerformanceCounter("Physics"),this._physicsEngine._step(h/1e3),n.Tools.EndPerformanceCounter("Physics")),this.onBeforeRenderObservable.notifyObservers(this),this._renderTargetsDuration.beginMonitoring(),c=(n.Tools.Now,this.getEngine()),l=this.activeCamera,this.renderTargetsEnabled){for(n.Tools.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),f=0;f<this.customRenderTargets.length;f++)if(e=this.customRenderTargets[f],e._shouldRender()){if(this._renderId++,this.activeCamera=e.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");c.setViewport(this.activeCamera.viewport);this.updateTransformMatrix();e.render(l!==this.activeCamera,this.dumpNextRenderTargets)}n.Tools.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);this._renderId++}if(this.customRenderTargets.length>0&&c.restoreDefaultFramebuffer(),this._renderTargetsDuration.endMonitoring(),this.activeCamera=l,this.proceduralTexturesEnabled){for(n.Tools.StartPerformanceCounter("Procedural textures",this._proceduralTextures.length>0),o=0;o<this._proceduralTextures.length;o++)a=this._proceduralTextures[o],a._shouldRender()&&a.render();n.Tools.EndPerformanceCounter("Procedural textures",this._proceduralTextures.length>0)}if(this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,!0,!0),this.shadowsEnabled)for(s=0;s<this.lights.length;s++)v=this.lights[s],t=v.getShadowGenerator(),v.isEnabled()&&t&&t.getShadowMap().getScene().textures.indexOf(t.getShadowMap())!==-1&&this._renderTargets.push(t.getShadowMap());if(this._depthRenderer&&this._renderTargets.push(this._depthRenderer.getDepthMap()),this.postProcessRenderPipelineManager.update(),this.activeCameras.length>0)for(i=0;i<this.activeCameras.length;i++)i>0&&this._engine.clear(0,!1,!0,!0),this._processSubCameras(this.activeCameras[i]);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera)}for(this._checkIntersections(),n.AudioEngine&&this._updateAudioParameters(),this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),r=0;r<this._toBeDisposed.length;r++)this._toBeDisposed.data[r].dispose(),this._toBeDisposed[r]=null;this._toBeDisposed.reset();this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1);n.Tools.EndPerformanceCounter("Scene rendering");this._lastFrameDuration.endMonitoring();this._totalMeshesCounter.addCount(this.meshes.length,!0);this._totalLightsCounter.addCount(this.lights.length,!0);this._totalMaterialsCounter.addCount(this.materials.length,!0);this._totalTexturesCounter.addCount(this.textures.length,!0);this._activeBones.addCount(0,!0);this._activeIndices.addCount(0,!0);this._activeParticles.addCount(0,!0)},u.prototype._updateAudioParameters=function(){var i,f,o,u,t,r,e;if(this.audioEnabled&&(0!==this.mainSoundTrack.soundCollection.length||1!==this.soundTracks.length)&&(f=n.Engine.audioEngine,i=this.activeCameras.length>0?this.activeCameras[0]:this.activeCamera,i&&f.canUseWebAudio)){for(f.audioContext.listener.setPosition(i.position.x,i.position.y,i.position.z),o=n.Matrix.Invert(i.getViewMatrix()),u=n.Vector3.TransformNormal(new n.Vector3(0,0,-1),o),u.normalize(),f.audioContext.listener.setOrientation(u.x,u.y,u.z,0,1,0),t=0;t<this.mainSoundTrack.soundCollection.length;t++)r=this.mainSoundTrack.soundCollection[t],r.useCustomAttenuation&&r.updateDistanceFromListener();for(t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)r=this.soundTracks[t].soundCollection[e],r.useCustomAttenuation&&r.updateDistanceFromListener()}},Object.defineProperty(u.prototype,"audioEnabled",{get:function(){return this._audioEnabled},set:function(t){this._audioEnabled=t;n.AudioEngine&&(this._audioEnabled?this._enableAudio():this._disableAudio())},enumerable:!0,configurable:!0}),u.prototype._disableAudio=function(){for(var t,n=0;n<this.mainSoundTrack.soundCollection.length;n++)this.mainSoundTrack.soundCollection[n].pause();for(n=0;n<this.soundTracks.length;n++)for(t=0;t<this.soundTracks[n].soundCollection.length;t++)this.soundTracks[n].soundCollection[t].pause()},u.prototype._enableAudio=function(){for(var t,n=0;n<this.mainSoundTrack.soundCollection.length;n++)this.mainSoundTrack.soundCollection[n].isPaused&&this.mainSoundTrack.soundCollection[n].play();for(n=0;n<this.soundTracks.length;n++)for(t=0;t<this.soundTracks[n].soundCollection.length;t++)this.soundTracks[n].soundCollection[t].isPaused&&this.soundTracks[n].soundCollection[t].play()},Object.defineProperty(u.prototype,"headphone",{get:function(){return this._headphone},set:function(t){this._headphone=t;n.AudioEngine&&(this._headphone?this._switchAudioModeForHeadphones():this._switchAudioModeForNormalSpeakers())},enumerable:!0,configurable:!0}),u.prototype._switchAudioModeForHeadphones=function(){this.mainSoundTrack.switchPanningModelToHRTF();for(var n=0;n<this.soundTracks.length;n++)this.soundTracks[n].switchPanningModelToHRTF()},u.prototype._switchAudioModeForNormalSpeakers=function(){this.mainSoundTrack.switchPanningModelToEqualPower();for(var n=0;n<this.soundTracks.length;n++)this.soundTracks[n].switchPanningModelToEqualPower()},u.prototype.enableDepthRenderer=function(){return this._depthRenderer?this._depthRenderer:(this._depthRenderer=new n.DepthRenderer(this),this._depthRenderer)},u.prototype.disableDepthRenderer=function(){this._depthRenderer&&(this._depthRenderer.dispose(),this._depthRenderer=null)},u.prototype.freezeMaterials=function(){for(var n=0;n<this.materials.length;n++)this.materials[n].freeze()},u.prototype.unfreezeMaterials=function(){for(var n=0;n<this.materials.length;n++)this.materials[n].unfreeze()},u.prototype.dispose=function(){this.beforeRender=null;this.afterRender=null;this.skeletons=[];this._boundingBoxRenderer.dispose();this._depthRenderer&&this._depthRenderer.dispose();this._debugLayer&&this._debugLayer.hide();this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBeforeRenderObservable.clear();this.onAfterRenderObservable.clear();this.detachControl();n.AudioEngine&&this.disposeSounds();for(var i=this._engine.getRenderingCanvas(),t=0;t<this.cameras.length;t++)this.cameras[t].detachControl(i);for(;this.lights.length;)this.lights[0].dispose();for(;this.meshes.length;)this.meshes[0].dispose(!0);for(;this.cameras.length;)this.cameras[0].dispose();for(;this.materials.length;)this.materials[0].dispose();for(;this.particleSystems.length;)this.particleSystems[0].dispose();for(;this.spriteManagers.length;)this.spriteManagers[0].dispose();for(;this.layers.length;)this.layers[0].dispose();for(;this.highlightLayers.length;)this.highlightLayers[0].dispose();for(;this.textures.length;)this.textures[0].dispose();this.postProcessManager.dispose();this._physicsEngine&&this.disablePhysicsEngine();t=this._engine.scenes.indexOf(this);t>-1&&this._engine.scenes.splice(t,1);this._engine.wipeCaches()},u.prototype.disposeSounds=function(){this.mainSoundTrack.dispose();for(var n=0;n<this.soundTracks.length;n++)this.soundTracks[n].dispose()},u.prototype.getWorldExtends=function(){for(var t,f,e,i=new n.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new n.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),u=0;u<this.meshes.length;u++)t=this.meshes[u],t.computeWorldMatrix(!0),f=t.getBoundingInfo().boundingBox.minimumWorld,e=t.getBoundingInfo().boundingBox.maximumWorld,n.Tools.CheckExtends(f,i,r),n.Tools.CheckExtends(e,i,r);return{min:i,max:r}},u.prototype.createOrUpdateSelectionOctree=function(t,i){void 0===t&&(t=64);void 0===i&&(i=2);this._selectionOctree||(this._selectionOctree=new n.Octree(n.Octree.CreationFuncForMeshes,t,i));var r=this.getWorldExtends();return this._selectionOctree.update(r.min,r.max,this.meshes),this._selectionOctree},u.prototype.createPickingRay=function(t,i,r,u,f){var o,s,e;if(void 0===f&&(f=!1),o=this._engine,!u){if(!this.activeCamera)throw new Error("Active camera not set");u=this.activeCamera}return s=u.viewport,e=s.toGlobal(o.getRenderWidth(),o.getRenderHeight()),t=t/this._engine.getHardwareScalingLevel()-e.x,i=i/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-e.y-e.height),n.Ray.CreateNew(t,i,e.width,e.height,r?r:n.Matrix.Identity(),f?n.Matrix.Identity():u.getViewMatrix(),u.getProjectionMatrix())},u.prototype.createPickingRayInCameraSpace=function(t,i,r){var f=this._engine;if(!r){if(!this.activeCamera)throw new Error("Active camera not set");r=this.activeCamera}var o=r.viewport,u=o.toGlobal(f.getRenderWidth(),f.getRenderHeight()),e=n.Matrix.Identity();return t=t/this._engine.getHardwareScalingLevel()-u.x,i=i/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-u.y-u.height),n.Ray.CreateNew(t,i,u.width,u.height,e,e,r.getProjectionMatrix())},u.prototype._internalPick=function(t,i,r){for(var u,f=null,e=0;e<this.meshes.length;e++){if(u=this.meshes[e],i){if(!i(u))continue}else if(!u.isEnabled()||!u.isVisible||!u.isPickable)continue;var s=u.getWorldMatrix(),h=t(s),o=u.intersects(h,r);if(o&&o.hit&&(r||null==f||!(o.distance>=f.distance))&&(f=o,r))break}return f||new n.PickingInfo},u.prototype._internalMultiPick=function(n,t){for(var i,u=[],r=0;r<this.meshes.length;r++){if(i=this.meshes[r],t){if(!t(i))continue}else if(!i.isEnabled()||!i.isVisible||!i.isPickable)continue;var e=i.getWorldMatrix(),o=n(e),f=i.intersects(o,!1);f&&f.hit&&u.push(f)}return u},u.prototype._internalPickSprites=function(t,i,r,u){var e=null,o,s,f;if(u=u||this.activeCamera,this.spriteManagers.length>0)for(o=0;o<this.spriteManagers.length;o++)if(s=this.spriteManagers[o],s.isPickable&&(f=s.intersects(t,u,i,r),f&&f.hit&&(r||null==e||!(f.distance>=e.distance))&&(e=f,r)))break;return e||new n.PickingInfo},u.prototype.pick=function(n,t,i,r,u){var f=this;return this._internalPick(function(i){return f.createPickingRay(n,t,i,u)},i,r)},u.prototype.pickSprite=function(n,t,i,r,u){return this._internalPickSprites(this.createPickingRayInCameraSpace(n,t,u),i,r,u)},u.prototype.pickWithRay=function(t,i,r){var u=this;return this._internalPick(function(i){return u._pickWithRayInverseMatrix||(u._pickWithRayInverseMatrix=n.Matrix.Identity()),i.invertToRef(u._pickWithRayInverseMatrix),n.Ray.Transform(t,u._pickWithRayInverseMatrix)},i,r)},u.prototype.multiPick=function(n,t,i,r){var u=this;return this._internalMultiPick(function(i){return u.createPickingRay(n,t,i,r)},i)},u.prototype.multiPickWithRay=function(t,i){var r=this;return this._internalMultiPick(function(i){return r._pickWithRayInverseMatrix||(r._pickWithRayInverseMatrix=n.Matrix.Identity()),i.invertToRef(r._pickWithRayInverseMatrix),n.Ray.Transform(t,r._pickWithRayInverseMatrix)},i)},u.prototype.setPointerOverMesh=function(t){this._pointerOverMesh!==t&&(this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(n.ActionManager.OnPointerOutTrigger,n.ActionEvent.CreateNew(this._pointerOverMesh)),this._pointerOverMesh=t,this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(n.ActionManager.OnPointerOverTrigger,n.ActionEvent.CreateNew(this._pointerOverMesh)))},u.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},u.prototype.setPointerOverSprite=function(t){this._pointerOverSprite!==t&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(n.ActionManager.OnPointerOutTrigger,n.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=t,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(n.ActionManager.OnPointerOverTrigger,n.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)))},u.prototype.getPointerOverSprite=function(){return this._pointerOverSprite},u.prototype.getPhysicsEngine=function(){return this._physicsEngine},u.prototype.enablePhysics=function(t,i){if(this._physicsEngine)return!0;try{return this._physicsEngine=new n.PhysicsEngine(t,i),!0}catch(r){return n.Tools.Error(r.message),!1}},u.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=void 0)},u.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},u.prototype.setGravity=function(t){n.Tools.Warn("Deprecated, please use 'scene.getPhysicsEngine().setGravity()'");this._physicsEngine&&this._physicsEngine.setGravity(t)},u.prototype.createCompoundImpostor=function(t,i){var r,f,u;for(n.Tools.Warn("Scene.createCompoundImpostor is deprecated. Please use PhysicsImpostor parent/child"),t.parts&&(i=t,t=t.parts),r=t[0].mesh,r.physicsImpostor=new n.PhysicsImpostor(r,t[0].impostor,i,this),f=1;f<t.length;f++)u=t[f].mesh,u.parent!==r&&(u.position=u.position.subtract(r.position),u.parent=r),u.physicsImpostor=new n.PhysicsImpostor(u,t[f].impostor,i,this);r.physicsImpostor.forceUpdate()},u.prototype.deleteCompoundImpostor=function(n){var t=n.parts[0].mesh;t.physicsImpostor.dispose();t.physicsImpostor=null},u.prototype.createDefaultCameraOrLight=function(){if(0===this.lights.length&&new n.HemisphericLight("default light",n.Vector3.Up(),this),!this.activeCamera){var i=new n.FreeCamera("default camera",n.Vector3.Zero(),this),t=this.getWorldExtends(),r=t.min.add(t.max.subtract(t.min).scale(.5));i.position=new n.Vector3(r.x,r.y,t.min.z-(t.max.z-t.min.z));i.setTarget(r);this.activeCamera=i}},u.prototype._getByTags=function(t,i,r){var f,e,u;if(void 0===i)return t;f=[];r=r||function(){};for(e in t)u=t[e],n.Tags.MatchesQuery(u,i)&&(f.push(u),r(u));return f},u.prototype.getMeshesByTags=function(n,t){return this._getByTags(this.meshes,n,t)},u.prototype.getCamerasByTags=function(n,t){return this._getByTags(this.cameras,n,t)},u.prototype.getLightsByTags=function(n,t){return this._getByTags(this.lights,n,t)},u.prototype.getMaterialByTags=function(n,t){return this._getByTags(this.materials,n,t).concat(this._getByTags(this.multiMaterials,n,t))},u.prototype.setRenderingOrder=function(n,t,i,r){void 0===t&&(t=null);void 0===i&&(i=null);void 0===r&&(r=null);this._renderingManager.setRenderingOrder(n,t,i,r)},u.prototype.setRenderingAutoClearDepthStencil=function(n,t){this._renderingManager.setRenderingAutoClearDepthStencil(n,t)},u._FOGMODE_NONE=0,u._FOGMODE_EXP=1,u._FOGMODE_EXP2=2,u._FOGMODE_LINEAR=3,u.MinDeltaTime=1,u.MaxDeltaTime=1e3,u}();n.Scene=o}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f,e){this._engine=t instanceof n.Mesh?t.getScene().getEngine():t;this._updatable=r;this._data=i;this._strideSize=u;f||this.create();this._instanced=e}return t.prototype.createVertexBuffer=function(t,i,r,u){return new n.VertexBuffer(this._engine,this,t,this._updatable,!0,u?u:this._strideSize,this._instanced,i,r)},t.prototype.isUpdatable=function(){return this._updatable},t.prototype.getData=function(){return this._data},t.prototype.getBuffer=function(){return this._buffer},t.prototype.getStrideSize=function(){return this._strideSize},t.prototype.getIsInstanced=function(){return this._instanced},t.prototype.create=function(n){!n&&this._buffer||(n=n||this._data,this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,n),this._data=n):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(n),this._data=n):this._buffer=this._engine.createVertexBuffer(n))},t.prototype.update=function(n){this.create(n)},t.prototype.updateDirectly=function(n,t,i){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,n,t,i?i*this.getStrideSize():void 0),this._data=null)},t.prototype.dispose=function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)},t}();n.Buffer=t}(i||(i={}));!function(n){var t=function(){function t(i,r,u,f,e,o,s,h,c){if(!o)switch(u){case t.PositionKind:o=3;break;case t.NormalKind:o=3;break;case t.UVKind:case t.UV2Kind:case t.UV3Kind:case t.UV4Kind:case t.UV5Kind:case t.UV6Kind:o=2;break;case t.ColorKind:o=4;break;case t.MatricesIndicesKind:case t.MatricesIndicesExtraKind:o=4;break;case t.MatricesWeightsKind:case t.MatricesWeightsExtraKind:o=4}r instanceof n.Buffer?(o||(o=r.getStrideSize()),this._buffer=r,this._ownsBuffer=!1):(this._buffer=new n.Buffer(i,r,f,o,e,s),this._ownsBuffer=!0);this._stride=o;this._offset=h?h:0;this._size=c?c:o;this._kind=u}return t.prototype.getKind=function(){return this._kind},t.prototype.isUpdatable=function(){return this._buffer.isUpdatable()},t.prototype.getData=function(){return this._buffer.getData()},t.prototype.getBuffer=function(){return this._buffer.getBuffer()},t.prototype.getStrideSize=function(){return this._stride},t.prototype.getOffset=function(){return this._offset},t.prototype.getSize=function(){return this._size},t.prototype.getIsInstanced=function(){return this._buffer.getIsInstanced()},t.prototype.create=function(n){return this._buffer.create(n)},t.prototype.update=function(n){return this._buffer.update(n)},t.prototype.updateDirectly=function(n,t){return this._buffer.updateDirectly(n,t)},t.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose()},Object.defineProperty(t,"PositionKind",{get:function(){return t._PositionKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"NormalKind",{get:function(){return t._NormalKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UVKind",{get:function(){return t._UVKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV2Kind",{get:function(){return t._UV2Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV3Kind",{get:function(){return t._UV3Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV4Kind",{get:function(){return t._UV4Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV5Kind",{get:function(){return t._UV5Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV6Kind",{get:function(){return t._UV6Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ColorKind",{get:function(){return t._ColorKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesIndicesKind",{get:function(){return t._MatricesIndicesKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesWeightsKind",{get:function(){return t._MatricesWeightsKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesIndicesExtraKind",{get:function(){return t._MatricesIndicesExtraKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesWeightsExtraKind",{get:function(){return t._MatricesWeightsExtraKind},enumerable:!0,configurable:!0}),t._PositionKind="position",t._NormalKind="normal",t._UVKind="uv",t._UV2Kind="uv2",t._UV3Kind="uv3",t._UV4Kind="uv4",t._UV5Kind="uv5",t._UV6Kind="uv6",t._ColorKind="color",t._MatricesIndicesKind="matricesIndices",t._MatricesWeightsKind="matricesWeights",t._MatricesIndicesExtraKind="matricesIndicesExtra",t._MatricesWeightsExtraKind="matricesWeightsExtra",t}();n.VertexBuffer=t}(i||(i={}));!function(n){var t=function(t){function i(n,i){t.call(this,n,i.getScene());i.instances.push(this);this._sourceMesh=i;this.position.copyFrom(i.position);this.rotation.copyFrom(i.rotation);this.scaling.copyFrom(i.scaling);i.rotationQuaternion&&(this.rotationQuaternion=i.rotationQuaternion.clone());this.infiniteDistance=i.infiniteDistance;this.setPivotMatrix(i.getPivotMatrix());this.refreshBoundingInfo();this._syncSubMeshes()}return u(i,t),Object.defineProperty(i.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},enumerable:!0,configurable:!0}),i.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()},Object.defineProperty(i.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!0,configurable:!0}),i.prototype.getVerticesData=function(n,t){return this._sourceMesh.getVerticesData(n,t)},i.prototype.isVerticesDataPresent=function(n){return this._sourceMesh.isVerticesDataPresent(n)},i.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(i.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!0,configurable:!0}),i.prototype.refreshBoundingInfo=function(){var t=this._sourceMesh.getBoundingInfo();this._boundingInfo=new n.BoundingInfo(t.minimum.clone(),t.maximum.clone());this._updateBoundingInfo()},i.prototype._preActivate=function(){this._currentLOD&&this._currentLOD._preActivate()},i.prototype._activate=function(n){this._currentLOD&&this._currentLOD._registerInstanceForRenderId(this,n)},i.prototype.getLOD=function(){return this._currentLOD=this.sourceMesh.getLOD(this.getScene().activeCamera,this.getBoundingInfo().boundingSphere),this._currentLOD===this.sourceMesh?this:this._currentLOD},i.prototype._syncSubMeshes=function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var n=0;n<this._sourceMesh.subMeshes.length;n++)this._sourceMesh.subMeshes[n].clone(this,this._sourceMesh)},i.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},i.prototype.clone=function(t,i,r){var u=this._sourceMesh.createInstance(t),f,e;if(n.Tools.DeepCopy(this,u,["name","subMeshes"],[]),this.refreshBoundingInfo(),i&&(u.parent=i),!r)for(f=0;f<this.getScene().meshes.length;f++)e=this.getScene().meshes[f],e.parent===this&&e.clone(e.name,u);return u.computeWorldMatrix(!0),u},i.prototype.dispose=function(n){var i=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(i,1);t.prototype.dispose.call(this,n)},i}(n.AbstractMesh);n.InstancedMesh=t}(i||(i={}));!function(n){var t=function(){function n(){this.mustReturn=!1;this.visibleInstances=[];this.renderSelf=[]}return n}(),i;n._InstancesBatch=t;i=function(i){function r(u,f,e,o,s,h){var c,l,v,y,a;if(void 0===e&&(e=null),void 0===h&&(h=!0),i.call(this,u,f),this.onBeforeRenderObservable=new n.Observable,this.onAfterRenderObservable=new n.Observable,this.onBeforeDrawObservable=new n.Observable,this.delayLoadState=n.Engine.DELAYLOADSTATE_NONE,this.instances=[],this._LODLevels=[],this._visibleInstances={},this._renderIdForInstances=[],this._batchCache=new t,this._instancesBufferSize=2048,this._sideOrientation=r._DEFAULTSIDE,this._areNormalsFrozen=!1,o){if(o._geometry&&o._geometry.applyToMesh(this),n.Tools.DeepCopy(o,this,["name","material","skeleton","instances","parent"],["_poseMatrix"]),this.parent=o.parent,this.setPivotMatrix(o.getPivotMatrix()),this.id=u+"."+o.id,this.material=o.material,!s)for(c=0;c<f.meshes.length;c++)l=f.meshes[c],l.parent===o&&l.clone(u+"."+l.name,this,s);for(v=this.getScene().getPhysicsEngine(),h&&v&&(y=v.getImpostorForPhysicsObject(o),y&&(this.physicsImpostor=y.clone(this))),c=0;c<f.particleSystems.length;c++)a=f.particleSystems[c],a.emitter===o&&a.clone(a.name,this);this.computeWorldMatrix(!0)}null!==e&&(this.parent=e)}return u(r,i),Object.defineProperty(r,"FRONTSIDE",{get:function(){return r._FRONTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"BACKSIDE",{get:function(){return r._BACKSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"DOUBLESIDE",{get:function(){return r._DOUBLESIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"DEFAULTSIDE",{get:function(){return r._DEFAULTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"NO_CAP",{get:function(){return r._NO_CAP},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CAP_START",{get:function(){return r._CAP_START},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CAP_END",{get:function(){return r._CAP_END},enumerable:!0,configurable:!0}),Object.defineProperty(r,"CAP_ALL",{get:function(){return r._CAP_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"onBeforeDraw",{set:function(n){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver);this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(n)},enumerable:!0,configurable:!0}),r.prototype.toString=function(t){var r=i.prototype.toString.call(this,t),u;if(r+=", n vertices: "+this.getTotalVertices(),r+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(u=0;u<this.animations.length;u++)r+=", animation[0]: "+this.animations[u].toString(t);return t&&(r+=", flat shading: "+(this._geometry?this.getVerticesData(n.VertexBuffer.PositionKind).length/3===this.getIndices().length?"YES":"NO":"UNKNOWN")),r},Object.defineProperty(r.prototype,"hasLODLevels",{get:function(){return this._LODLevels.length>0},enumerable:!0,configurable:!0}),r.prototype._sortLODLevels=function(){this._LODLevels.sort(function(n,t){return n.distance<t.distance?1:n.distance>t.distance?-1:0})},r.prototype.addLODLevel=function(t,i){if(i&&i._masterMesh)return n.Tools.Warn("You cannot use a mesh as LOD level twice"),this;var r=new n.Internals.MeshLODLevel(t,i);return this._LODLevels.push(r),i&&(i._masterMesh=this),this._sortLODLevels(),this},r.prototype.getLODLevelAtDistance=function(n){for(var i,t=0;t<this._LODLevels.length;t++)if(i=this._LODLevels[t],i.distance===n)return i.mesh;return null},r.prototype.removeLODLevel=function(n){for(var t=0;t<this._LODLevels.length;t++)this._LODLevels[t].mesh===n&&(this._LODLevels.splice(t,1),n&&(n._masterMesh=null));return this._sortLODLevels(),this},r.prototype.getLOD=function(n,t){var r,u,i;if(!this._LODLevels||0===this._LODLevels.length)return this;if(r=(t?t:this.getBoundingInfo().boundingSphere).centerWorld.subtract(n.globalPosition).length(),this._LODLevels[this._LODLevels.length-1].distance>r)return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this._LODLevels[this._LODLevels.length-1].mesh),this;for(u=0;u<this._LODLevels.length;u++)if(i=this._LODLevels[u],i.distance<r)return i.mesh&&(i.mesh._preActivate(),i.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)),this.onLODLevelSelection&&this.onLODLevelSelection(r,this,i.mesh),i.mesh;return this.onLODLevelSelection&&this.onLODLevelSelection(r,this,this),this},Object.defineProperty(r.prototype,"geometry",{get:function(){return this._geometry},enumerable:!0,configurable:!0}),r.prototype.getTotalVertices=function(){return this._geometry?this._geometry.getTotalVertices():0},r.prototype.getVerticesData=function(n,t){return this._geometry?this._geometry.getVerticesData(n,t):null},r.prototype.getVertexBuffer=function(n){if(this._geometry)return this._geometry.getVertexBuffer(n)},r.prototype.isVerticesDataPresent=function(n){return this._geometry?this._geometry.isVerticesDataPresent(n):!!this._delayInfo&&this._delayInfo.indexOf(n)!==-1},r.prototype.getVerticesDataKinds=function(){if(!this._geometry){var n=[];return this._delayInfo&&this._delayInfo.forEach(function(t){n.push(t)}),n}return this._geometry.getVerticesDataKinds()},r.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},r.prototype.getIndices=function(n){return this._geometry?this._geometry.getIndices(n):[]},Object.defineProperty(r.prototype,"isBlocked",{get:function(){return null!==this._masterMesh&&void 0!==this._masterMesh},enumerable:!0,configurable:!0}),r.prototype.isReady=function(){return this.delayLoadState!==n.Engine.DELAYLOADSTATE_LOADING&&i.prototype.isReady.call(this)},r.prototype.isDisposed=function(){return this._isDisposed},Object.defineProperty(r.prototype,"sideOrientation",{get:function(){return this._sideOrientation},set:function(n){this._sideOrientation=n},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"areNormalsFrozen",{get:function(){return this._areNormalsFrozen},enumerable:!0,configurable:!0}),r.prototype.freezeNormals=function(){this._areNormalsFrozen=!0},r.prototype.unfreezeNormals=function(){this._areNormalsFrozen=!1},Object.defineProperty(r.prototype,"overridenInstanceCount",{set:function(n){this._overridenInstanceCount=n},enumerable:!0,configurable:!0}),r.prototype._preActivate=function(){var n=this.getScene().getRenderId();this._preActivateId!==n&&(this._preActivateId=n,this._visibleInstances=null)},r.prototype._preActivateForIntermediateRendering=function(n){this._visibleInstances&&(this._visibleInstances.intermediateDefaultRenderId=n)},r.prototype._registerInstanceForRenderId=function(n,t){this._visibleInstances||(this._visibleInstances={},this._visibleInstances.defaultRenderId=t,this._visibleInstances.selfDefaultRenderId=this._renderId);this._visibleInstances[t]||(this._visibleInstances[t]=[]);this._visibleInstances[t].push(n)},r.prototype.refreshBoundingInfo=function(){var i,r,t;if(!this._boundingInfo.isLocked){if(i=this.getVerticesData(n.VertexBuffer.PositionKind),i&&(r=n.Tools.ExtractMinAndMax(i,0,this.getTotalVertices()),this._boundingInfo=new n.BoundingInfo(r.minimum,r.maximum)),this.subMeshes)for(t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo();this._updateBoundingInfo()}},r.prototype._createGlobalSubMesh=function(){var t=this.getTotalVertices();return t&&this.getIndices()?(this.releaseSubMeshes(),new n.SubMesh(0,0,t,0,this.getTotalIndices(),this)):null},r.prototype.subdivide=function(t){var f;if(!(t<1)){for(var u=this.getTotalIndices(),i=u/t|0,r=0;i%3!=0;)i++;for(this.releaseSubMeshes(),f=0;f<t&&!(r>=u);f++)n.SubMesh.CreateFromIndices(0,r,Math.min(i,u-r),this),r+=i;this.synchronizeInstances()}},r.prototype.setVerticesData=function(t,i,r,u){var f,e;this._geometry?this._geometry.setVerticesData(t,i,r,u):(f=new n.VertexData,f.set(i,t),e=this.getScene(),new n.Geometry(n.Geometry.RandomId(),e,f,r,this))},r.prototype.setVerticesBuffer=function(t){if(!this._geometry){var i=this.getScene();new n.Geometry(n.Geometry.RandomId(),i).applyToMesh(this)}this._geometry.setVerticesBuffer(t)},r.prototype.updateVerticesData=function(n,t,i,r){this._geometry&&(r?(this.makeGeometryUnique(),this.updateVerticesData(n,t,i,!1)):this._geometry.updateVerticesData(n,t,i))},r.prototype.updateVerticesDataDirectly=function(t,i,r,u){n.Tools.Warn("Mesh.updateVerticesDataDirectly deprecated since 2.3.");this._geometry&&(u?(this.makeGeometryUnique(),this.updateVerticesDataDirectly(t,i,r,!1)):this._geometry.updateVerticesDataDirectly(t,i,r))},r.prototype.updateMeshPositions=function(t,i){var r,f,u;void 0===i&&(i=!0);r=this.getVerticesData(n.VertexBuffer.PositionKind);(t(r),this.updateVerticesData(n.VertexBuffer.PositionKind,r,!1,!1),i)&&(f=this.getIndices(),u=this.getVerticesData(n.VertexBuffer.NormalKind),n.VertexData.ComputeNormals(r,f,u),this.updateVerticesData(n.VertexBuffer.NormalKind,u,!1,!1))},r.prototype.makeGeometryUnique=function(){if(this._geometry){var t=this._geometry,i=this._geometry.copy(n.Geometry.RandomId());t.releaseForMesh(this,!0);i.applyToMesh(this)}},r.prototype.setIndices=function(t,i){var r,u;this._geometry?this._geometry.setIndices(t,i):(r=new n.VertexData,r.indices=t,u=this.getScene(),new n.Geometry(n.Geometry.RandomId(),u,r,!1,this))},r.prototype.toLeftHanded=function(){this._geometry&&this._geometry.toLeftHanded()},r.prototype._bind=function(t,i,r){var u,f=this.getScene().getEngine();if(this._unIndexed)u=null;else switch(r){case n.Material.PointFillMode:u=null;break;case n.Material.WireFrameFillMode:u=t.getLinesIndexBuffer(this.getIndices(),f);break;default:case n.Material.TriangleFillMode:u=this._unIndexed?null:this._geometry.getIndexBuffer()}f.bindBuffers(this._geometry.getVertexBuffers(),u,i)},r.prototype._draw=function(t,i,r){if(this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){this.onBeforeDrawObservable.notifyObservers(this);var u=this.getScene().getEngine();switch(i){case n.Material.PointFillMode:u.drawPointClouds(t.verticesStart,t.verticesCount,r);break;case n.Material.WireFrameFillMode:this._unIndexed?u.drawUnIndexed(!1,t.verticesStart,t.verticesCount,r):u.draw(!1,0,r>0?t.linesIndexCount/2:t.linesIndexCount,r);break;default:this._unIndexed?u.drawUnIndexed(!0,t.verticesStart,t.verticesCount,r):u.draw(!0,t.indexStart,t.indexCount,r)}}},r.prototype.registerBeforeRender=function(n){this.onBeforeRenderObservable.add(n)},r.prototype.unregisterBeforeRender=function(n){this.onBeforeRenderObservable.removeCallback(n)},r.prototype.registerAfterRender=function(n){this.onAfterRenderObservable.add(n)},r.prototype.unregisterAfterRender=function(n){this.onAfterRenderObservable.removeCallback(n)},r.prototype._getInstancesRenderList=function(n){var u=this.getScene(),t,i,r;if(this._batchCache.mustReturn=!1,this._batchCache.renderSelf[n]=this.isEnabled()&&this.isVisible,this._batchCache.visibleInstances[n]=null,this._visibleInstances){if(t=u.getRenderId(),i=u._isInIntermediateRendering()?this._visibleInstances.intermediateDefaultRenderId:this._visibleInstances.defaultRenderId,this._batchCache.visibleInstances[n]=this._visibleInstances[t],r=this._renderId,!this._batchCache.visibleInstances[n]&&i&&(this._batchCache.visibleInstances[n]=this._visibleInstances[i],t=Math.max(i,t),r=Math.max(this._visibleInstances.selfDefaultRenderId,t)),this._batchCache.visibleInstances[n]&&this._batchCache.visibleInstances[n].length){if(this._renderIdForInstances[n]===t)return this._batchCache.mustReturn=!0,this._batchCache;t!==r&&(this._batchCache.renderSelf[n]=!1)}this._renderIdForInstances[n]=t}return this._batchCache},r.prototype._renderWithInstances=function(t,i,r,u,f){for(var c,a,o=r.visibleInstances[t._id],v=o.length+1,y=64*v,l=this._instancesBufferSize,e=this._instancesBuffer;this._instancesBufferSize<y;)this._instancesBufferSize*=2;this._instancesData&&l==this._instancesBufferSize||(this._instancesData=new Float32Array(this._instancesBufferSize/4));var s=0,h=0,p=this.getWorldMatrix();if(r.renderSelf[t._id]&&(p.copyToArray(this._instancesData,s),s+=16,h++),o)for(c=0;c<o.length;c++)a=o[c],a.getWorldMatrix().copyToArray(this._instancesData,s),s+=16,h++;e&&l==this._instancesBufferSize?e.updateDirectly(this._instancesData,0,h):(e&&e.dispose(),e=new n.Buffer(f,this._instancesData,!0,16,!1,!0),this._instancesBuffer=e,this.setVerticesBuffer(e.createVertexBuffer("world0",0,4)),this.setVerticesBuffer(e.createVertexBuffer("world1",4,4)),this.setVerticesBuffer(e.createVertexBuffer("world2",8,4)),this.setVerticesBuffer(e.createVertexBuffer("world3",12,4)));f.bindBuffers(this.geometry.getVertexBuffers(),this.geometry.getIndexBuffer(),u);this._draw(t,i,h);f.unbindInstanceAttributes()},r.prototype._processRendering=function(n,t,i,r,u,f,e){var c=this.getScene(),l=c.getEngine(),o,s,h;if(u)this._renderWithInstances(n,i,r,t,l);else if(r.renderSelf[n._id]&&(f&&f(!1,this.getWorldMatrix(),e),this._draw(n,i,this._overridenInstanceCount)),r.visibleInstances[n._id])for(o=0;o<r.visibleInstances[n._id].length;o++)s=r.visibleInstances[n._id][o],h=s.getWorldMatrix(),f&&f(!0,h,e),this._draw(n,i)},r.prototype.render=function(t,i){var e=this.getScene(),f=this._getInstancesRenderList(t._id),o,s,h,l,a;if(!f.mustReturn&&this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){this.onBeforeRenderObservable.notifyObservers(this);var r=e.getEngine(),c=null!==r.getCaps().instancedArrays&&null!==f.visibleInstances[t._id]&&void 0!==f.visibleInstances[t._id],u=t.getMaterial();u&&u.isReady(this,c)&&(o=r.getDepthWrite(),this.renderOutline&&(r.setDepthWrite(!1),e.getOutlineRenderer().render(t,f),r.setDepthWrite(o)),u._preBind(),s=u.getEffect(),h=e.forcePointsCloud?n.Material.PointFillMode:e.forceWireframe?n.Material.WireFrameFillMode:u.fillMode,this._bind(t,s,h),l=this.getWorldMatrix(),(u.bind(l,this),i&&r.setAlphaMode(u.alphaMode),this._processRendering(t,s,h,f,c,this._onBeforeDraw,u),u.unbind(),this.renderOutline&&o&&(r.setDepthWrite(!0),r.setColorWrite(!1),e.getOutlineRenderer().render(t,f),r.setColorWrite(!0)),this.renderOverlay)&&(a=r.getAlphaMode(),r.setAlphaMode(n.Engine.ALPHA_COMBINE),e.getOutlineRenderer().render(t,f,!0),r.setAlphaMode(a)),this.onAfterRenderObservable.notifyObservers(this))}},r.prototype._onBeforeDraw=function(n,t,i){n&&i.bindOnlyWorldMatrix(t)},r.prototype.getEmittedParticleSystems=function(){for(var i,t=[],n=0;n<this.getScene().particleSystems.length;n++)i=this.getScene().particleSystems[n],i.emitter===this&&t.push(i);return t},r.prototype.getHierarchyEmittedParticleSystems=function(){var i=[],r=this.getDescendants(),n,t;for(r.push(this),n=0;n<this.getScene().particleSystems.length;n++)t=this.getScene().particleSystems[n],r.indexOf(t.emitter)!==-1&&i.push(t);return i},r.prototype._checkDelayState=function(){var t=this.getScene();this._geometry?this._geometry.load(t):this.delayLoadState===n.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=n.Engine.DELAYLOADSTATE_LOADING,this._queueLoad(this,t))},r.prototype._queueLoad=function(t,i){var r=this,u;i._addPendingData(t);u=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;n.Tools.LoadFile(this.delayLoadingFile,function(t){t instanceof ArrayBuffer?r._delayLoadingFunction(t,r):r._delayLoadingFunction(JSON.parse(t),r);r.delayLoadState=n.Engine.DELAYLOADSTATE_LOADED;i._removePendingData(r)},function(){},i.database,u)},r.prototype.isInFrustum=function(t){return this.delayLoadState!==n.Engine.DELAYLOADSTATE_LOADING&&!!i.prototype.isInFrustum.call(this,t)&&(this._checkDelayState(),!0)},r.prototype.setMaterialByID=function(n){for(var r=this.getScene().materials,i,t=0;t<r.length;t++)if(r[t].id===n)return void(this.material=r[t]);for(i=this.getScene().multiMaterials,t=0;t<i.length;t++)if(i[t].id===n)return void(this.material=i[t])},r.prototype.getAnimatables=function(){var n=[];return this.material&&n.push(this.material),this.skeleton&&n.push(this.skeleton),n},r.prototype.bakeTransformIntoVertices=function(t){var f,i,r,u;if(this.isVerticesDataPresent(n.VertexBuffer.PositionKind)){for(f=this.subMeshes.splice(0),this._resetPointsArrayCache(),r=this.getVerticesData(n.VertexBuffer.PositionKind),u=[],i=0;i<r.length;i+=3)n.Vector3.TransformCoordinates(n.Vector3.FromArray(r,i),t).toArray(u,i);if(this.setVerticesData(n.VertexBuffer.PositionKind,u,this.getVertexBuffer(n.VertexBuffer.PositionKind).isUpdatable()),this.isVerticesDataPresent(n.VertexBuffer.NormalKind)){for(r=this.getVerticesData(n.VertexBuffer.NormalKind),u=[],i=0;i<r.length;i+=3)n.Vector3.TransformNormal(n.Vector3.FromArray(r,i),t).normalize().toArray(u,i);this.setVerticesData(n.VertexBuffer.NormalKind,u,this.getVertexBuffer(n.VertexBuffer.NormalKind).isUpdatable());t.m[0]*t.m[5]*t.m[10]<0&&this.flipFaces();this.releaseSubMeshes();this.subMeshes=f}}},r.prototype.bakeCurrentTransformIntoVertices=function(){this.bakeTransformIntoVertices(this.computeWorldMatrix(!0));this.scaling.copyFromFloats(1,1,1);this.position.copyFromFloats(0,0,0);this.rotation.copyFromFloats(0,0,0);this.rotationQuaternion&&(this.rotationQuaternion=n.Quaternion.Identity());this._worldMatrix=n.Matrix.Identity()},r.prototype._resetPointsArrayCache=function(){this._positions=null},r.prototype._generatePointsArray=function(){var t,i;if(this._positions)return!0;if(this._positions=[],t=this.getVerticesData(n.VertexBuffer.PositionKind),!t)return!1;for(i=0;i<t.length;i+=3)this._positions.push(n.Vector3.FromArray(t,i));return!0},r.prototype.clone=function(n,t,i,u){return void 0===u&&(u=!0),new r(n,this.getScene(),t,this,i,u)},r.prototype.dispose=function(n){var u,t,r;for(this._geometry&&this._geometry.releaseForMesh(this,!0),this._instancesBuffer&&(this._instancesBuffer.dispose(),this._instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(u=this.getScene().highlightLayers,t=0;t<u.length;t++)r=u[t],r&&(r.removeMesh(this),r.removeExcludedMesh(this));i.prototype.dispose.call(this,n)},r.prototype.applyDisplacementMap=function(t,i,r,u){var f=this,e=this.getScene(),o=function(n){var t=document.createElement("canvas"),s=t.getContext("2d"),e=n.width,o=n.height,h;t.width=e;t.height=o;s.drawImage(n,0,0);h=s.getImageData(0,0,e,o).data;f.applyDisplacementMapFromBuffer(h,e,o,i,r);u&&u(f)};n.Tools.LoadImage(t,o,function(){},e.database)},r.prototype.applyDisplacementMapFromBuffer=function(t,i,r,u,f){if(!this.isVerticesDataPresent(n.VertexBuffer.PositionKind)||!this.isVerticesDataPresent(n.VertexBuffer.NormalKind)||!this.isVerticesDataPresent(n.VertexBuffer.UVKind))return void n.Tools.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing");for(var o=this.getVerticesData(n.VertexBuffer.PositionKind),c=this.getVerticesData(n.VertexBuffer.NormalKind),v=this.getVerticesData(n.VertexBuffer.UVKind),s=n.Vector3.Zero(),h=n.Vector3.Zero(),l=n.Vector2.Zero(),e=0;e<o.length;e+=3){n.Vector3.FromArrayToRef(o,e,s);n.Vector3.FromArrayToRef(c,e,h);n.Vector2.FromArrayToRef(v,e/3*2,l);var y=Math.abs(l.x)*i%i|0,p=Math.abs(l.y)*r%r|0,a=4*(y+p*i),w=t[a]/255,b=t[a+1]/255,k=t[a+2]/255,d=.3*w+.59*b+.11*k;h.normalize();h.scaleInPlace(u+(f-u)*d);s=s.add(h);s.toArray(o,e)}n.VertexData.ComputeNormals(o,this.getIndices(),c);this.updateVerticesData(n.VertexBuffer.PositionKind,o);this.updateVerticesData(n.VertexBuffer.NormalKind,c)},r.prototype.convertToFlatShadedMesh=function(){for(var i,u=this.getVerticesDataKinds(),s=[],w=[],h=[],b=!1,v,g,y,c,o,l,a,f,r=0;r<u.length;r++)i=u[r],v=this.getVertexBuffer(i),i!==n.VertexBuffer.NormalKind?(s[i]=v,w[i]=s[i].getData(),h[i]=[]):(b=v.isUpdatable(),u.splice(r,1),r--);for(var k=this.subMeshes.slice(0),e=this.getIndices(),d=this.getTotalIndices(),t=0;t<d;t++)for(g=e[t],r=0;r<u.length;r++)for(i=u[r],y=s[i].getStrideSize(),c=0;c<y;c++)h[i].push(w[i][g*y+c]);for(o=[],l=h[n.VertexBuffer.PositionKind],t=0;t<d;t+=3){e[t]=t;e[t+1]=t+1;e[t+2]=t+2;for(var it=n.Vector3.FromArray(l,3*t),nt=n.Vector3.FromArray(l,3*(t+1)),rt=n.Vector3.FromArray(l,3*(t+2)),ut=it.subtract(nt),ft=rt.subtract(nt),p=n.Vector3.Normalize(n.Vector3.Cross(ut,ft)),tt=0;tt<3;tt++)o.push(p.x),o.push(p.y),o.push(p.z)}for(this.setIndices(e),this.setVerticesData(n.VertexBuffer.NormalKind,o,b),r=0;r<u.length;r++)i=u[r],this.setVerticesData(i,h[i],s[i].isUpdatable());for(this.releaseSubMeshes(),a=0;a<k.length;a++)f=k[a],new n.SubMesh(f.materialIndex,f.indexStart,f.indexCount,f.indexStart,f.indexCount,this);this.synchronizeInstances()},r.prototype.convertToUnIndexedMesh=function(){for(var t,u=this.getVerticesDataKinds(),o=[],a=[],c=[],v,w,l,s,h,f,r=0;r<u.length;r++)t=u[r],v=this.getVertexBuffer(t),o[t]=v,a[t]=o[t].getData(),c[t]=[];for(var y=this.subMeshes.slice(0),e=this.getIndices(),p=this.getTotalIndices(),i=0;i<p;i++)for(w=e[i],r=0;r<u.length;r++)for(t=u[r],l=o[t].getStrideSize(),s=0;s<l;s++)c[t].push(a[t][w*l+s]);for(i=0;i<p;i+=3)e[i]=i,e[i+1]=i+1,e[i+2]=i+2;for(this.setIndices(e),r=0;r<u.length;r++)t=u[r],this.setVerticesData(t,c[t],o[t].isUpdatable());for(this.releaseSubMeshes(),h=0;h<y.length;h++)f=y[h],new n.SubMesh(f.materialIndex,f.indexStart,f.indexCount,f.indexStart,f.indexCount,this);this._unIndexed=!0;this.synchronizeInstances()},r.prototype.flipFaces=function(t){var i,r,u;if(void 0===t&&(t=!1),r=n.VertexData.ExtractFromMesh(this),t&&this.isVerticesDataPresent(n.VertexBuffer.NormalKind))for(i=0;i<r.normals.length;i++)r.normals[i]*=-1;for(i=0;i<r.indices.length;i+=3)u=r.indices[i+1],r.indices[i+1]=r.indices[i+2],r.indices[i+2]=u;r.applyToMesh(this)},r.prototype.createInstance=function(t){return new n.InstancedMesh(t,this)},r.prototype.synchronizeInstances=function(){for(var t,n=0;n<this.instances.length;n++)t=this.instances[n],t._syncSubMeshes()},r.prototype.simplify=function(t,i,r,u){void 0===i&&(i=!0);void 0===r&&(r=n.SimplificationType.QUADRATIC);this.getScene().simplificationQueue.addTask({settings:t,parallelProcessing:i,mesh:this,simplificationType:r,successCallback:u})},r.prototype.optimizeIndices=function(t){for(var e,u=this,i=this.getIndices(),o=this.getVerticesData(n.VertexBuffer.PositionKind),r=[],f=0;f<o.length;f+=3)r.push(n.Vector3.FromArray(o,f));e=[];n.AsyncLoop.SyncAsyncForLoop(r.length,40,function(n){for(var u,i=r.length-1-n,f=r[i],t=0;t<i;++t)if(u=r[t],f.equals(u)){e[i]=t;break}},function(){for(var r,n=0;n<i.length;++n)i[n]=e[i[n]]||i[n];r=u.subMeshes.slice(0);u.setIndices(i);u.subMeshes=r;t&&t(u)})},r.Parse=function(t,i,u){var f=new r(t.name,i),s,h,c,e,o;if(f.id=t.id,n.Tags.AddTagsTo(f,t.tags),f.position=n.Vector3.FromArray(t.position),void 0!==t.metadata&&(f.metadata=t.metadata),t.rotationQuaternion?f.rotationQuaternion=n.Quaternion.FromArray(t.rotationQuaternion):t.rotation&&(f.rotation=n.Vector3.FromArray(t.rotation)),f.scaling=n.Vector3.FromArray(t.scaling),t.localMatrix?f.setPivotMatrix(n.Matrix.FromArray(t.localMatrix)):t.pivotMatrix&&f.setPivotMatrix(n.Matrix.FromArray(t.pivotMatrix)),f.setEnabled(t.isEnabled),f.isVisible=t.isVisible,f.infiniteDistance=t.infiniteDistance,f.showBoundingBox=t.showBoundingBox,f.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox,void 0!==t.applyFog&&(f.applyFog=t.applyFog),void 0!==t.pickable&&(f.isPickable=t.pickable),void 0!==t.alphaIndex&&(f.alphaIndex=t.alphaIndex),f.receiveShadows=t.receiveShadows,f.billboardMode=t.billboardMode,void 0!==t.visibility&&(f.visibility=t.visibility),f.checkCollisions=t.checkCollisions,void 0!==t.isBlocker&&(f.isBlocker=t.isBlocker),f._shouldGenerateFlatShading=t.useFlatShading,t.freezeWorldMatrix&&(f._waitingFreezeWorldMatrix=t.freezeWorldMatrix),t.parentId&&(f._waitingParentId=t.parentId),void 0!==t.actions&&(f._waitingActions=t.actions),void 0!==t.overlayAlpha&&(f.overlayAlpha=t.overlayAlpha),void 0!==t.overlayColor&&(f.overlayColor=n.Color3.FromArray(t.overlayColor)),void 0!==t.renderOverlay&&(f.renderOverlay=t.renderOverlay),f.hasVertexAlpha=t.hasVertexAlpha,t.delayLoadingFile?(f.delayLoadState=n.Engine.DELAYLOADSTATE_NOTLOADED,f.delayLoadingFile=u+t.delayLoadingFile,f._boundingInfo=new n.BoundingInfo(n.Vector3.FromArray(t.boundingBoxMinimum),n.Vector3.FromArray(t.boundingBoxMaximum)),t._binaryInfo&&(f._binaryInfo=t._binaryInfo),f._delayInfo=[],t.hasUVs&&f._delayInfo.push(n.VertexBuffer.UVKind),t.hasUVs2&&f._delayInfo.push(n.VertexBuffer.UV2Kind),t.hasUVs3&&f._delayInfo.push(n.VertexBuffer.UV3Kind),t.hasUVs4&&f._delayInfo.push(n.VertexBuffer.UV4Kind),t.hasUVs5&&f._delayInfo.push(n.VertexBuffer.UV5Kind),t.hasUVs6&&f._delayInfo.push(n.VertexBuffer.UV6Kind),t.hasColors&&f._delayInfo.push(n.VertexBuffer.ColorKind),t.hasMatricesIndices&&f._delayInfo.push(n.VertexBuffer.MatricesIndicesKind),t.hasMatricesWeights&&f._delayInfo.push(n.VertexBuffer.MatricesWeightsKind),f._delayLoadingFunction=n.Geometry.ImportGeometry,n.SceneLoader.ForceFullSceneLoadingForIncremental&&f._checkDelayState()):n.Geometry.ImportGeometry(t,f),t.materialId?f.setMaterialByID(t.materialId):f.material=null,t.skeletonId>-1&&(f.skeleton=i.getLastSkeletonByID(t.skeletonId),t.numBoneInfluencers&&(f.numBoneInfluencers=t.numBoneInfluencers)),t.animations){for(s=0;s<t.animations.length;s++)h=t.animations[s],f.animations.push(n.Animation.Parse(h));n.Node.ParseAnimationRanges(f,t,i)}if(t.autoAnimate&&i.beginAnimation(f,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),f.layerMask=t.layerMask&&!isNaN(t.layerMask)?Math.abs(parseInt(t.layerMask)):268435455,t.physicsImpostor&&(f.physicsImpostor=new n.PhysicsImpostor(f,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},i)),t.instances)for(c=0;c<t.instances.length;c++)if(e=t.instances[c],o=f.createInstance(e.name),n.Tags.AddTagsTo(o,e.tags),o.position=n.Vector3.FromArray(e.position),e.parentId&&(o._waitingParentId=e.parentId),e.rotationQuaternion?o.rotationQuaternion=n.Quaternion.FromArray(e.rotationQuaternion):e.rotation&&(o.rotation=n.Vector3.FromArray(e.rotation)),o.scaling=n.Vector3.FromArray(e.scaling),o.checkCollisions=f.checkCollisions,t.animations){for(s=0;s<t.animations.length;s++)h=t.animations[s],o.animations.push(n.Animation.Parse(h));n.Node.ParseAnimationRanges(o,t,i)}return f},r.CreateRibbon=function(t,i,r,u,f,e,o,s,h){return n.MeshBuilder.CreateRibbon(t,{pathArray:i,closeArray:r,closePath:u,offset:f,updatable:o,sideOrientation:s,instance:h},e)},r.CreateDisc=function(t,i,r,u,f,e){var o={radius:i,tessellation:r,sideOrientation:e,updatable:f};return n.MeshBuilder.CreateDisc(t,o,u)},r.CreateBox=function(t,i,r,u,f){var e={size:i,sideOrientation:f,updatable:u};return n.MeshBuilder.CreateBox(t,e,r)},r.CreateSphere=function(t,i,r,u,f,e){var o={segments:i,diameterX:r,diameterY:r,diameterZ:r,sideOrientation:e,updatable:f};return n.MeshBuilder.CreateSphere(t,o,u)},r.CreateCylinder=function(t,i,u,f,e,o,s,h,c){void 0!==s&&s instanceof n.Scene||(void 0!==s&&(c=h||r.DEFAULTSIDE,h=s),s=o,o=1);var l={height:i,diameterTop:u,diameterBottom:f,tessellation:e,subdivisions:o,sideOrientation:c,updatable:h};return n.MeshBuilder.CreateCylinder(t,l,s)},r.CreateTorus=function(t,i,r,u,f,e,o){var s={diameter:i,thickness:r,tessellation:u,sideOrientation:o,updatable:e};return n.MeshBuilder.CreateTorus(t,s,f)},r.CreateTorusKnot=function(t,i,r,u,f,e,o,s,h,c){var l={radius:i,tube:r,radialSegments:u,tubularSegments:f,p:e,q:o,sideOrientation:c,updatable:h};return n.MeshBuilder.CreateTorusKnot(t,l,s)},r.CreateLines=function(t,i,r,u,f){var e={points:i,updatable:u,instance:f};return n.MeshBuilder.CreateLines(t,e,r)},r.CreateDashedLines=function(t,i,r,u,f,e,o,s){var h={points:i,dashSize:r,gapSize:u,dashNb:f,updatable:o,instance:s};return n.MeshBuilder.CreateDashedLines(t,h,e)},r.ExtrudeShape=function(t,i,u,f,e,o,s,h,c,l){var a={shape:i,path:u,scale:f,rotation:e,cap:0===o?0:o||r.NO_CAP,sideOrientation:c,instance:l,updatable:h};return n.MeshBuilder.ExtrudeShape(t,a,s)},r.ExtrudeShapeCustom=function(t,i,u,f,e,o,s,h,c,l,a,v){var y={shape:i,path:u,scaleFunction:f,rotationFunction:e,ribbonCloseArray:o,ribbonClosePath:s,cap:0===h?0:h||r.NO_CAP,sideOrientation:a,instance:v,updatable:l};return n.MeshBuilder.ExtrudeShapeCustom(t,y,c)},r.CreateLathe=function(t,i,r,u,f,e,o){var s={shape:i,radius:r,tessellation:u,sideOrientation:o,updatable:e};return n.MeshBuilder.CreateLathe(t,s,f)},r.CreatePlane=function(t,i,r,u,f){var e={size:i,width:i,height:i,sideOrientation:f,updatable:u};return n.MeshBuilder.CreatePlane(t,e,r)},r.CreateGround=function(t,i,r,u,f,e){var o={width:i,height:r,subdivisions:u,updatable:e};return n.MeshBuilder.CreateGround(t,o,f)},r.CreateTiledGround=function(t,i,r,u,f,e,o,s,h){var c={xmin:i,zmin:r,xmax:u,zmax:f,subdivisions:e,precision:o,updatable:h};return n.MeshBuilder.CreateTiledGround(t,c,s)},r.CreateGroundFromHeightMap=function(t,i,r,u,f,e,o,s,h,c){var l={width:r,height:u,subdivisions:f,minHeight:e,maxHeight:o,updatable:h,onReady:c};return n.MeshBuilder.CreateGroundFromHeightMap(t,i,l,s)},r.CreateTube=function(t,i,r,u,f,e,o,s,h,c){var l={path:i,radius:r,tessellation:u,radiusFunction:f,arc:1,cap:e,updatable:s,sideOrientation:h,instance:c};return n.MeshBuilder.CreateTube(t,l,o)},r.CreatePolyhedron=function(t,i,r){return n.MeshBuilder.CreatePolyhedron(t,i,r)},r.CreateIcoSphere=function(t,i,r){return n.MeshBuilder.CreateIcoSphere(t,i,r)},r.CreateDecal=function(t,i,r,u,f,e){var o={position:r,normal:u,size:f,angle:e};return n.MeshBuilder.CreateDecal(t,i,o)},r.prototype.setPositionsForCPUSkinning=function(){var t;return this._sourcePositions||(t=this.getVerticesData(n.VertexBuffer.PositionKind),this._sourcePositions=new Float32Array(t),this.getVertexBuffer(n.VertexBuffer.PositionKind).isUpdatable()||this.setVerticesData(n.VertexBuffer.PositionKind,t,!0)),this._sourcePositions},r.prototype.setNormalsForCPUSkinning=function(){var t;return this._sourceNormals||(t=this.getVerticesData(n.VertexBuffer.NormalKind),this._sourceNormals=new Float32Array(t),this.getVertexBuffer(n.VertexBuffer.NormalKind).isUpdatable()||this.setVerticesData(n.VertexBuffer.NormalKind,t,!0)),this._sourceNormals},r.prototype.applySkeleton=function(t){var a,u,f,e;if(this.geometry&&this.geometry._softwareSkinningRenderId!=this.getScene().getRenderId()){if((this.geometry._softwareSkinningRenderId=this.getScene().getRenderId(),!this.isVerticesDataPresent(n.VertexBuffer.PositionKind))||!this.isVerticesDataPresent(n.VertexBuffer.NormalKind)||!this.isVerticesDataPresent(n.VertexBuffer.MatricesIndicesKind)||!this.isVerticesDataPresent(n.VertexBuffer.MatricesWeightsKind))return this;this._sourcePositions||(a=this.subMeshes.slice(),this.setPositionsForCPUSkinning(),this.subMeshes=a);this._sourceNormals||this.setNormalsForCPUSkinning();u=this.getVerticesData(n.VertexBuffer.PositionKind);u instanceof Float32Array||(u=new Float32Array(u));f=this.getVerticesData(n.VertexBuffer.NormalKind);f instanceof Float32Array||(f=new Float32Array(f));for(var i,y=this.getVerticesData(n.VertexBuffer.MatricesIndicesKind),p=this.getVerticesData(n.VertexBuffer.MatricesWeightsKind),l=this.numBoneInfluencers>4,w=l?this.getVerticesData(n.VertexBuffer.MatricesIndicesExtraKind):null,b=l?this.getVerticesData(n.VertexBuffer.MatricesWeightsExtraKind):null,v=t.getTransformMatrices(this),h=n.Vector3.Zero(),o=new n.Matrix,c=new n.Matrix,s=0,r=0;r<u.length;r+=3,s+=4){for(i=0;i<4&&(e=p[s+i],e>0);i++)n.Matrix.FromFloat32ArrayToRefScaled(v,16*y[s+i],e,c),o.addToSelf(c);if(l)for(i=0;i<4&&(e=b[s+i],e>0);i++)n.Matrix.FromFloat32ArrayToRefScaled(v,16*w[s+i],e,c),o.addToSelf(c);n.Vector3.TransformCoordinatesFromFloatsToRef(this._sourcePositions[r],this._sourcePositions[r+1],this._sourcePositions[r+2],o,h);h.toArray(u,r);n.Vector3.TransformNormalFromFloatsToRef(this._sourceNormals[r],this._sourceNormals[r+1],this._sourceNormals[r+2],o,h);h.toArray(f,r);o.reset()}return this.updateVerticesData(n.VertexBuffer.PositionKind,u),this.updateVerticesData(n.VertexBuffer.NormalKind,f),this}},r.MinMax=function(n){var t=null,i=null;return n.forEach(function(n){var r=n.getBoundingInfo().boundingBox;t?(t.MinimizeInPlace(r.minimumWorld),i.MaximizeInPlace(r.maximumWorld)):(t=r.minimumWorld,i=r.maximumWorld)}),{min:t,max:i}},r.Center=function(t){var i=t instanceof Array?n.Mesh.MinMax(t):t;return n.Vector3.Center(i.min,i.max)},r.MergeMeshes=function(t,i,u,f){var e,c,s,h,o;if(void 0===i&&(i=!0),!u)for(c=0,e=0;e<t.length;e++)if(t[e]&&(c+=t[e].getTotalVertices(),c>65536))return n.Tools.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null;for(e=0;e<t.length;e++)t[e]&&(t[e].computeWorldMatrix(!0),h=n.VertexData.ExtractFromMesh(t[e],!0),h.transform(t[e].getWorldMatrix()),s?s.merge(h):(s=h,o=t[e]));if(f||(f=new r(o.name+"_merged",o.getScene())),s.applyToMesh(f),f.material=o.material,f.checkCollisions=o.checkCollisions,i)for(e=0;e<t.length;e++)t[e]&&t[e].dispose();return f},r._FRONTSIDE=0,r._BACKSIDE=1,r._DOUBLESIDE=2,r._DEFAULTSIDE=0,r._NO_CAP=0,r._CAP_START=1,r._CAP_END=2,r._CAP_ALL=3,r}(n.AbstractMesh);n.Mesh=i}(i||(i={}));!function(n){var t=function(){function t(n,t,i,r,u,f,e,o){void 0===o&&(o=!0);this.materialIndex=n;this.verticesStart=t;this.verticesCount=i;this.indexStart=r;this.indexCount=u;this._renderId=0;this._mesh=f;this._renderingMesh=e||f;f.subMeshes.push(this);this._trianglePlanes=[];this._id=f.subMeshes.length-1;o&&(this.refreshBoundingInfo(),f.computeWorldMatrix(!0))}return Object.defineProperty(t.prototype,"IsGlobal",{get:function(){return 0===this.verticesStart&&this.verticesCount==this._mesh.getTotalVertices()},enumerable:!0,configurable:!0}),t.prototype.getBoundingInfo=function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo},t.prototype.getMesh=function(){return this._mesh},t.prototype.getRenderingMesh=function(){return this._renderingMesh},t.prototype.getMaterial=function(){var t=this._renderingMesh.material,i;return t&&t instanceof n.MultiMaterial?(i=t,i.getSubMaterial(this.materialIndex)):t?t:this._mesh.getScene().defaultMaterial},t.prototype.refreshBoundingInfo=function(){var t,i,r;if(this._lastColliderWorldVertices=null,!this.IsGlobal){if(t=this._renderingMesh.getVerticesData(n.VertexBuffer.PositionKind),!t)return void(this._boundingInfo=this._mesh._boundingInfo);r=this._renderingMesh.getIndices();i=0===this.indexStart&&this.indexCount===r.length?{minimum:this._renderingMesh.getBoundingInfo().minimum.clone(),maximum:this._renderingMesh.getBoundingInfo().maximum.clone()}:n.Tools.ExtractMinAndMaxIndexed(t,r,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);this._boundingInfo=new n.BoundingInfo(i.minimum,i.maximum)}},t.prototype._checkCollision=function(n){return this.getBoundingInfo()._checkCollision(n)},t.prototype.updateBoundingInfo=function(n){this.getBoundingInfo()||this.refreshBoundingInfo();this.getBoundingInfo().update(n)},t.prototype.isInFrustum=function(n){return this.getBoundingInfo().isInFrustum(n)},t.prototype.isCompletelyInFrustum=function(n){return this.getBoundingInfo().isCompletelyInFrustum(n)},t.prototype.render=function(n){this._renderingMesh.render(this,n)},t.prototype.getLinesIndexBuffer=function(n,t){if(!this._linesIndexBuffer){for(var r=[],i=this.indexStart;i<this.indexStart+this.indexCount;i+=3)r.push(n[i],n[i+1],n[i+1],n[i+2],n[i+2],n[i]);this._linesIndexBuffer=t.createIndexBuffer(r);this.linesIndexCount=r.length}return this._linesIndexBuffer},t.prototype.canIntersects=function(n){return n.intersectsBox(this.getBoundingInfo().boundingBox)},t.prototype.intersects=function(t,i,r,u){var e=null,h,f;if(this._mesh instanceof n.LinesMesh)for(h=this._mesh,f=this.indexStart;f<this.indexStart+this.indexCount;f+=2){var c=i[r[f]],l=i[r[f+1]],s=t.intersectionSegment(c,l,h.intersectionThreshold);if(!(s<0)&&(u||!e||s<e.distance)&&(e=new n.IntersectionInfo(null,null,s),u))break}else for(f=this.indexStart;f<this.indexStart+this.indexCount;f+=3){var c=i[r[f]],l=i[r[f+1]],a=i[r[f+2]],o=t.intersectsTriangle(c,l,a);if(o){if(o.distance<0)continue;if((u||!e||o.distance<e.distance)&&(e=o,e.faceId=f/3,u))break}}return e},t.prototype.clone=function(i,r){var u=new t(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,i,r,!1);return this.IsGlobal||(u._boundingInfo=new n.BoundingInfo(this.getBoundingInfo().minimum,this.getBoundingInfo().maximum)),u},t.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var n=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(n,1)},t.CreateFromIndices=function(n,i,r,u,f){var o=Number.MAX_VALUE,h=-Number.MAX_VALUE,c,s,e;for(f=f||u,c=f.getIndices(),s=i;s<i+r;s++)e=c[s],e<o&&(o=e),e>h&&(h=e);return new t(n,o,h-o+1,i,r,u,f)},t}();n.SubMesh=t}(i||(i={}));!function(n){var t=function(){function t(){}return t.updateSideOrientation=function(t){return t==n.Mesh.DOUBLESIDE?n.Mesh.DOUBLESIDE:void 0===t||null===t?n.Mesh.FRONTSIDE:t},t.CreateBox=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreateBox(i),f.applyToMesh(u,i.updatable),u},t.CreateSphere=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreateSphere(i),f.applyToMesh(u,i.updatable),u},t.CreateDisc=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreateDisc(i),f.applyToMesh(u,i.updatable),u},t.CreateIcoSphere=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreateIcoSphere(i),f.applyToMesh(u,i.updatable),u},t.CreateRibbon=function(t,i,r){var h=i.pathArray,w=i.closeArray,v=i.closePath,b=(i.offset,this.updateSideOrientation(i.sideOrientation,r)),f=i.instance,k=i.updatable,y,l,p,u,s,a;if(f){if(n.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,n.Tmp.Vector3[0]),n.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,n.Tmp.Vector3[1]),y=function(t){for(var o,i,s,r,e=h[0].length,u=0,l=f.sideOrientation===n.Mesh.DOUBLESIDE?2:1,c=1;c<=l;c++)for(o=0;o<h.length;o++){for(i=h[o],s=i.length,e=e<s?e:s,r=0;r<e;)t[u]=i[r].x,t[u+1]=i[r].y,t[u+2]=i[r].z,i[r].x<n.Tmp.Vector3[0].x&&(n.Tmp.Vector3[0].x=i[r].x),i[r].x>n.Tmp.Vector3[1].x&&(n.Tmp.Vector3[1].x=i[r].x),i[r].y<n.Tmp.Vector3[0].y&&(n.Tmp.Vector3[0].y=i[r].y),i[r].y>n.Tmp.Vector3[1].y&&(n.Tmp.Vector3[1].y=i[r].y),i[r].z<n.Tmp.Vector3[0].z&&(n.Tmp.Vector3[0].z=i[r].z),i[r].z>n.Tmp.Vector3[1].z&&(n.Tmp.Vector3[1].z=i[r].z),r++,u+=3;f._closePath&&(t[u]=i[0].x,t[u+1]=i[0].y,t[u+2]=i[0].z,u+=3)}},l=f.getVerticesData(n.VertexBuffer.PositionKind),y(l),f._boundingInfo=new n.BoundingInfo(n.Tmp.Vector3[0],n.Tmp.Vector3[1]),f._boundingInfo.update(f._worldMatrix),f.updateVerticesData(n.VertexBuffer.PositionKind,l,!1,!1),!f.areNormalsFrozen){if(p=f.getIndices(),u=f.getVerticesData(n.VertexBuffer.NormalKind),n.VertexData.ComputeNormals(l,p,u),f._closePath)for(var e=0,o=0,c=0;c<h.length;c++)e=3*f._idx[c],o=c+1<h.length?3*(f._idx[c+1]-1):u.length-3,u[e]=.5*(u[e]+u[o]),u[e+1]=.5*(u[e+1]+u[o+1]),u[e+2]=.5*(u[e+2]+u[o+2]),u[o]=u[e],u[o+1]=u[e+1],u[o+2]=u[e+2];f.updateVerticesData(n.VertexBuffer.NormalKind,u,!1,!1)}return f}return s=new n.Mesh(t,r),s.sideOrientation=b,a=n.VertexData.CreateRibbon(i),v&&(s._idx=a._idx),s._closePath=v,s._closeArray=w,a.applyToMesh(s,k),s},t.CreateCylinder=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreateCylinder(i),f.applyToMesh(u,i.updatable),u},t.CreateTorus=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreateTorus(i),f.applyToMesh(u,i.updatable),u},t.CreateTorusKnot=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreateTorusKnot(i),f.applyToMesh(u,i.updatable),u},t.CreateLineSystem=function(t,i,r){var u=i.instance,e=i.lines,o,f,s;return u?(o=function(n){for(var r,t,i=0,u=0;u<e.length;u++)for(r=e[u],t=0;t<r.length;t++)n[i]=r[t].x,n[i+1]=r[t].y,n[i+2]=r[t].z,i+=3},u.updateMeshPositions(o,!1),u):(f=new n.LinesMesh(t,r),s=n.VertexData.CreateLineSystem(i),s.applyToMesh(f,i.updatable),f)},t.CreateLines=function(n,i,r){return t.CreateLineSystem(n,{lines:[i.points],updatable:i.updatable,instance:i.instance},r)},t.CreateDashedLines=function(t,i,r){var u=i.points,f=i.instance,h=i.gapSize,c=(i.dashNb,i.dashSize),o,e,s;return f?(o=function(t){for(var e=n.Vector3.Zero(),v=t.length/6,l=0,a=0,s=0,h=0,o=0,r=0,i=0,c=0,i=0;i<u.length-1;i++)u[i+1].subtractToRef(u[i],e),l+=e.length();for(s=l/v,h=f.dashSize*s/(f.dashSize+f.gapSize),i=0;i<u.length-1;i++)for(u[i+1].subtractToRef(u[i],e),a=Math.floor(e.length()/s),e.normalize(),c=0;c<a&&r<t.length;)o=s*c,t[r]=u[i].x+o*e.x,t[r+1]=u[i].y+o*e.y,t[r+2]=u[i].z+o*e.z,t[r+3]=u[i].x+(o+h)*e.x,t[r+4]=u[i].y+(o+h)*e.y,t[r+5]=u[i].z+(o+h)*e.z,r+=6,c++;for(;r<t.length;)t[r]=u[i].x,t[r+1]=u[i].y,t[r+2]=u[i].z,r+=3},f.updateMeshPositions(o,!1),f):(e=new n.LinesMesh(t,r),s=n.VertexData.CreateDashedLines(i),s.applyToMesh(e,i.updatable),e.dashSize=c,e.gapSize=h,e)},t.ExtrudeShape=function(i,r,u){var f=r.path,e=r.shape,o=r.scale||1,s=r.rotation||0,h=0===r.cap?0:r.cap||n.Mesh.NO_CAP,c=r.updatable,l=this.updateSideOrientation(r.sideOrientation,u),a=r.instance,v=r.invertUV||!1;return t._ExtrudeShapeGeneric(i,e,f,o,s,null,null,!1,!1,h,!1,u,c,l,a,v)},t.ExtrudeShapeCustom=function(i,r,u){var f=r.path,e=r.shape,o=r.scaleFunction||function(){return 1},s=r.rotationFunction||function(){return 0},h=r.ribbonCloseArray||!1,c=r.ribbonClosePath||!1,l=0===r.cap?0:r.cap||n.Mesh.NO_CAP,a=r.updatable,v=this.updateSideOrientation(r.sideOrientation,u),y=r.instance,p=r.invertUV||!1;return t._ExtrudeShapeGeneric(i,e,f,null,null,o,s,h,c,l,!0,u,a,v,y,p)},t.CreateLathe=function(i,r,u){for(var a,p=r.arc<=0||r.arc>1?1:r.arc||1,w=void 0===r.closed||r.closed,f=r.shape,s=r.radius||1,v=r.tessellation||64,b=r.updatable,k=this.updateSideOrientation(r.sideOrientation,u),l=r.cap||n.Mesh.NO_CAP,d=2*Math.PI,y=[],g=r.invertUV||!1,e=0,h=0,c=d/v*p,o=[],e=0;e<=v;e++){for(o=[],l!=n.Mesh.CAP_START&&l!=n.Mesh.CAP_ALL||(o.push(new n.Vector3(0,f[0].y,0)),o.push(new n.Vector3(Math.cos(e*c)*f[0].x*s,f[0].y,Math.sin(e*c)*f[0].x*s))),h=0;h<f.length;h++)a=new n.Vector3(Math.cos(e*c)*f[h].x*s,f[h].y,Math.sin(e*c)*f[h].x*s),o.push(a);l!=n.Mesh.CAP_END&&l!=n.Mesh.CAP_ALL||(o.push(new n.Vector3(Math.cos(e*c)*f[f.length-1].x*s,f[f.length-1].y,Math.sin(e*c)*f[f.length-1].x*s)),o.push(new n.Vector3(0,f[f.length-1].y,0)));y.push(o)}return t.CreateRibbon(i,{pathArray:y,closeArray:w,sideOrientation:k,updatable:b,invertUV:g},u)},t.CreatePlane=function(t,i,r){var u=new n.Mesh(t,r),f,e,o;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreatePlane(i),(f.applyToMesh(u,i.updatable),i.sourcePlane)&&(u.translate(i.sourcePlane.normal,i.sourcePlane.d),e=Math.acos(n.Vector3.Dot(i.sourcePlane.normal,n.Axis.Z)),o=n.Vector3.Cross(n.Axis.Z,i.sourcePlane.normal),u.rotate(o,e)),u},t.CreateGround=function(t,i,r){var u=new n.GroundMesh(t,r),f;return u._setReady(!1),u._subdivisionsX=i.subdivisionsX||i.subdivisions||1,u._subdivisionsY=i.subdivisionsY||i.subdivisions||1,u._width=i.width||1,u._height=i.height||1,u._maxX=u._width/2,u._maxZ=u._height/2,u._minX=-u._maxX,u._minZ=-u._maxZ,f=n.VertexData.CreateGround(i),f.applyToMesh(u,i.updatable),u._setReady(!0),u},t.CreateTiledGround=function(t,i,r){var u=new n.Mesh(t,r),f=n.VertexData.CreateTiledGround(i);return f.applyToMesh(u,i.updatable),u},t.CreateGroundFromHeightMap=function(t,i,r,u){var o=r.width||10,s=r.height||10,e=r.subdivisions||1,l=r.minHeight||0,a=r.maxHeight||10,v=r.updatable,h=r.onReady,f=new n.GroundMesh(t,u),c;return f._subdivisionsX=e,f._subdivisionsY=e,f._width=o,f._height=s,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1),c=function(t){var i=document.createElement("canvas"),c=i.getContext("2d"),r=t.width,u=t.height,y,p;i.width=r;i.height=u;c.drawImage(t,0,0);y=c.getImageData(0,0,r,u).data;p=n.VertexData.CreateGroundFromHeightMap({width:o,height:s,subdivisions:e,minHeight:l,maxHeight:a,buffer:y,bufferWidth:r,bufferHeight:u});p.applyToMesh(f,v);f._setReady(!0);h&&h(f)},n.Tools.LoadImage(i,c,function(){},u.database),f},t.CreateTube=function(i,r,u){var c=r.path,v=r.radius||1,y=r.tessellation||64,p=r.radiusFunction,o=r.cap||n.Mesh.NO_CAP,b=r.invertUV||!1,k=r.updatable,d=this.updateSideOrientation(r.sideOrientation,u),f=r.instance,s,h,l,a,w,e;return(r.arc=r.arc<=0||r.arc>1?1:r.arc||1,l=function(t,i,r,u,f,e,o,s){for(var l,v,a,p,w,y,k=i.getTangents(),d=i.getNormals(),g=i.getDistances(),nt=2*Math.PI,tt=nt/f*s,it=function(){return u},rt=e||it,b=n.Tmp.Matrix[0],h=o===n.Mesh._NO_CAP||o===n.Mesh.CAP_END?0:2,c=0;c<t.length;c++){for(p=rt(c,g[c]),a=Array(),w=d[c],l=0;l<f;l++)n.Matrix.RotationAxisToRef(k[c],tt*l,b),y=a[l]?a[l]:n.Vector3.Zero(),n.Vector3.TransformCoordinatesToRef(w,b,y),y.scaleInPlace(p).addInPlace(t[c]),a[l]=y;r[h]=a;h++}v=function(n,i){for(var r=Array(),u=0;u<n;u++)r.push(t[i]);return r};switch(o){case n.Mesh.CAP_START:r[0]=v(f,0);r[1]=r[2].slice(0);break;case n.Mesh.CAP_END:r[h]=r[h-1].slice(0);r[h+1]=v(f,t.length-1);break;case n.Mesh.CAP_ALL:r[0]=v(f,0);r[1]=r[2].slice(0);r[h]=r[h-1].slice(0);r[h+1]=v(f,t.length-1)}return r},f)?(a=r.arc||f.arc,s=f.path3D.update(c),h=l(c,s,f.pathArray,v,f.tessellation,p,f.cap,a),f=t.CreateRibbon(null,{pathArray:h,instance:f}),f.path3D=s,f.pathArray=h,f.arc=a,f):(s=new n.Path3D(c),w=[],o=o<0||o>3?0:o,h=l(c,s,w,v,y,p,o,r.arc),e=t.CreateRibbon(i,{pathArray:h,closePath:!0,closeArray:!1,updatable:k,sideOrientation:d,invertUV:b},u),e.pathArray=h,e.path3D=s,e.tessellation=y,e.cap=o,e.arc=r.arc,e)},t.CreatePolyhedron=function(t,i,r){var u=new n.Mesh(t,r),f;return i.sideOrientation=this.updateSideOrientation(i.sideOrientation,r),f=n.VertexData.CreatePolyhedron(i),f.applyToMesh(u,i.updatable),u},t.CreateDecal=function(t,i,r){var k=i.getIndices(),y=i.getVerticesData(n.VertexBuffer.PositionKind),p=i.getVerticesData(n.VertexBuffer.NormalKind),l=r.position||n.Vector3.Zero(),e=r.normal||n.Vector3.Up(),w=r.size||new n.Vector3(1,1,1),d=r.angle||0,u,v,h,c;if(!e){var it=new n.Vector3(0,0,1),g=i.getScene().activeCamera,rt=n.Vector3.TransformCoordinates(it,g.getWorldMatrix());e=g.globalPosition.subtract(rt)}var nt=-Math.atan2(e.z,e.x)-Math.PI/2,ut=Math.sqrt(e.x*e.x+e.z*e.z),tt=Math.atan2(e.y,ut),ft=n.Matrix.RotationYawPitchRoll(nt,tt,d).multiply(n.Matrix.Translation(l.x,l.y,l.z)),et=n.Matrix.Invert(ft),ot=i.getWorldMatrix(),st=ot.multiply(et),f=new n.VertexData;f.indices=[];f.positions=[];f.normals=[];f.uvs=[];for(var a=0,b=function(t){var i=k[t],r=new n.PositionNormalVertex;return r.position=new n.Vector3(y[3*i],y[3*i+1],y[3*i+2]),r.position=n.Vector3.TransformCoordinates(r.position,st),r.normal=new n.Vector3(p[3*i],p[3*i+1],p[3*i+2]),r},o=function(t,i){if(0===t.length)return t;for(var c=.5*Math.abs(n.Vector3.Dot(w,i)),s=function(t,r){var u=n.Vector3.GetClipFactor(t.position,r.position,i,c);return new n.PositionNormalVertex(n.Vector3.Lerp(t.position,r.position,u),n.Vector3.Lerp(t.normal,r.normal,u))},u=[],r=0;r<t.length;r+=3){var l,a,v,f,e,o,h,y=0,p=n.Vector3.Dot(t[r].position,i)-c,b=n.Vector3.Dot(t[r+1].position,i)-c,k=n.Vector3.Dot(t[r+2].position,i)-c;switch(l=p>0,a=b>0,v=k>0,y=(l?1:0)+(a?1:0)+(v?1:0)){case 0:u.push(t[r]);u.push(t[r+1]);u.push(t[r+2]);break;case 1:if(l&&(f=t[r+1],e=t[r+2],o=s(t[r],f),h=s(t[r],e)),a){f=t[r];e=t[r+2];o=s(t[r+1],f);h=s(t[r+1],e);u.push(o);u.push(e.clone());u.push(f.clone());u.push(e.clone());u.push(o.clone());u.push(h);break}v&&(f=t[r],e=t[r+1],o=s(t[r+2],f),h=s(t[r+2],e));u.push(f.clone());u.push(e.clone());u.push(o);u.push(h);u.push(o.clone());u.push(e.clone());break;case 2:l||(f=t[r].clone(),e=s(f,t[r+1]),o=s(f,t[r+2]),u.push(f),u.push(e),u.push(o));a||(f=t[r+1].clone(),e=s(f,t[r+2]),o=s(f,t[r]),u.push(f),u.push(e),u.push(o));v||(f=t[r+2].clone(),e=s(f,t[r]),o=s(f,t[r+1]),u.push(f),u.push(e),u.push(o))}}return u},s=0;s<k.length;s+=3)if(u=[],u.push(b(s)),u.push(b(s+1)),u.push(b(s+2)),u=o(u,new n.Vector3(1,0,0)),u=o(u,new n.Vector3(-1,0,0)),u=o(u,new n.Vector3(0,1,0)),u=o(u,new n.Vector3(0,-1,0)),u=o(u,new n.Vector3(0,0,1)),u=o(u,new n.Vector3(0,0,-1)),0!==u.length)for(v=0;v<u.length;v++)h=u[v],f.indices.push(a),h.position.toArray(f.positions,3*a),h.normal.toArray(f.normals,3*a),f.uvs.push(.5+h.position.x/w.x),f.uvs.push(.5+h.position.y/w.y),a++;return c=new n.Mesh(t,i.getScene()),f.applyToMesh(c),c.position=l.clone(),c.rotation=new n.Vector3(tt,nt,d),c},t._ExtrudeShapeGeneric=function(i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b){var g,k,nt=function(t,i,r,u,f,e,o,s,h,c){for(var nt,w,y,b=r.getTangents(),tt=r.getNormals(),it=r.getBinormals(),k=r.getDistances(),d=0,rt=function(){return f},ut=function(){return e},ft=c?s:ut,et=c?o:rt,a=h===n.Mesh.NO_CAP||h===n.Mesh.CAP_END?0:2,g=n.Tmp.Matrix[0],l=0;l<i.length;l++){for(var p=[],ot=ft(l,k[l]),st=et(l,k[l]),v=0;v<t.length;v++)n.Matrix.RotationAxisToRef(b[l],d,g),nt=b[l].scale(t[v].z).add(tt[l].scale(t[v].x)).add(it[l].scale(t[v].y)),w=p[v]?p[v]:n.Vector3.Zero(),n.Vector3.TransformCoordinatesToRef(nt,g,w),w.scaleInPlace(st).addInPlace(i[l]),p[v]=w;u[a]=p;d+=ot;a++}y=function(t){for(var u=Array(),r=n.Vector3.Zero(),i=0;i<t.length;i++)r.addInPlace(t[i]);for(r.scaleInPlace(1/t.length),i=0;i<t.length;i++)u.push(r);return u};switch(h){case n.Mesh.CAP_START:u[0]=y(u[2]);u[1]=u[2].slice(0);break;case n.Mesh.CAP_END:u[a]=u[a-1];u[a+1]=y(u[a-1]);break;case n.Mesh.CAP_ALL:u[0]=y(u[2]);u[1]=u[2].slice(0);u[a]=u[a-1];u[a+1]=y(u[a-1])}return u},tt,d;return w?(g=w.path3D.update(u),k=nt(r,u,w.path3D,w.pathArray,f,e,o,s,w.cap,a),w=n.Mesh.CreateRibbon(null,k,null,null,null,v,null,null,w)):(g=new n.Path3D(u),tt=[],l=l<0||l>3?0:l,k=nt(r,u,g,tt,f,e,o,s,l,a),d=t.CreateRibbon(i,{pathArray:k,closeArray:h,closePath:c,updatable:y,sideOrientation:p,invertUV:b},v),d.pathArray=k,d.path3D=g,d.cap=l,d)},t}();n.MeshBuilder=t}(i||(i={}));!function(n){var t=function(){function t(t){this.hasAlpha=!1;this.getAlphaFromRGB=!1;this.level=1;this.coordinatesIndex=0;this.coordinatesMode=n.Texture.EXPLICIT_MODE;this.wrapU=n.Texture.WRAP_ADDRESSMODE;this.wrapV=n.Texture.WRAP_ADDRESSMODE;this.anisotropicFilteringLevel=4;this.isCube=!1;this.isRenderTarget=!1;this.animations=[];this.onDisposeObservable=new n.Observable;this.delayLoadState=n.Engine.DELAYLOADSTATE_NONE;this._scene=t;this._scene.textures.push(this);this._uid=null}return Object.defineProperty(t.prototype,"uid",{get:function(){return this._uid||(this._uid=n.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),t.prototype.toString=function(){return this.name},Object.defineProperty(t.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getTextureMatrix=function(){return null},t.prototype.getReflectionTextureMatrix=function(){return null},t.prototype.getInternalTexture=function(){return this._texture},t.prototype.isReady=function(){return this.delayLoadState===n.Engine.DELAYLOADSTATE_NOTLOADED||!!this._texture&&this._texture.isReady},t.prototype.getSize=function(){return this._texture._width?new n.Size(this._texture._width,this._texture._height):this._texture._size?new n.Size(this._texture._size,this._texture._size):n.Size.Zero()},t.prototype.getBaseSize=function(){return this.isReady()&&this._texture?this._texture._size?new n.Size(this._texture._size,this._texture._size):new n.Size(this._texture._baseWidth,this._texture._baseHeight):n.Size.Zero()},t.prototype.scale=function(){},Object.defineProperty(t.prototype,"canRescale",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype._removeFromCache=function(n,t){for(var u,r=this._scene.getEngine().getLoadedTexturesCache(),i=0;i<r.length;i++)if(u=r[i],u.url===n&&u.noMipmap===t)return void r.splice(i,1)},t.prototype._getFromCache=function(n,t,i){for(var r,f=this._scene.getEngine().getLoadedTexturesCache(),u=0;u<f.length;u++)if(r=f[u],r.url===n&&r.noMipmap===t&&(!i||i===r.samplingMode))return r.references++,r;return null},t.prototype.delayLoad=function(){},t.prototype.clone=function(){return null},t.prototype.releaseInternalTexture=function(){this._texture&&(this._scene.getEngine().releaseInternalTexture(this._texture),delete this._texture)},t.prototype.dispose=function(){this.getScene().stopAnimation(this);var n=this._scene.textures.indexOf(this);n>=0&&this._scene.textures.splice(n,1);void 0!==this._texture&&(this.releaseInternalTexture(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear())},t.prototype.serialize=function(){if(!this.name)return null;var t=n.SerializationHelper.Serialize(this);return n.Animation.AppendSerializedAnimations(this,t),t},r([n.serialize()],t.prototype,"name",void 0),r([n.serialize()],t.prototype,"hasAlpha",void 0),r([n.serialize()],t.prototype,"getAlphaFromRGB",void 0),r([n.serialize()],t.prototype,"level",void 0),r([n.serialize()],t.prototype,"coordinatesIndex",void 0),r([n.serialize()],t.prototype,"coordinatesMode",void 0),r([n.serialize()],t.prototype,"wrapU",void 0),r([n.serialize()],t.prototype,"wrapV",void 0),r([n.serialize()],t.prototype,"anisotropicFilteringLevel",void 0),r([n.serialize()],t.prototype,"isCube",void 0),r([n.serialize()],t.prototype,"isRenderTarget",void 0),t}();n.BaseTexture=t}(i||(i={}));!function(n){var t=function(t){function i(r,u,f,e,o,s,h,c,l){var v=this,a;(void 0===f&&(f=!1),void 0===e&&(e=!0),void 0===o&&(o=i.TRILINEAR_SAMPLINGMODE),void 0===s&&(s=null),void 0===h&&(h=null),void 0===c&&(c=null),void 0===l&&(l=!1),t.call(this,u),this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.name=r,this.url=r,this._noMipmap=f,this._invertY=e,this._samplingMode=o,this._buffer=c,this._deleteBuffer=l,r)&&(this._texture=this._getFromCache(r,f,o),a=function(){v._onLoadObservarble&&v._onLoadObservarble.hasObservers()&&v.onLoadObservable.notifyObservers(!0);s&&s()},this._texture?this._texture.isReady?n.Tools.SetImmediate(function(){return a()}):this._texture.onLoadedCallbacks.push(a):u.useDelayedTextureLoading?(this.delayLoadState=n.Engine.DELAYLOADSTATE_NOTLOADED,this._delayedOnLoad=a,this._delayedOnError=h):(this._texture=u.getEngine().createTexture(r,f,e,u,this._samplingMode,a,h,this._buffer),l&&delete this._buffer))}return u(i,t),Object.defineProperty(i.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!0,configurable:!0}),i.prototype.delayLoad=function(){this.delayLoadState===n.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=n.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap,this._samplingMode),this._texture||(this._texture=this.getScene().getEngine().createTexture(this.url,this._noMipmap,this._invertY,this.getScene(),this._samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer),this._deleteBuffer&&delete this._buffer))},i.prototype.updateSamplingMode=function(n){this._texture&&(this._samplingMode=n,this.getScene().getEngine().updateTextureSamplingMode(n,this._texture))},i.prototype._prepareRowForTextureGeneration=function(t,i,r,u){t*=this.uScale;i*=this.vScale;t-=.5*this.uScale;i-=.5*this.vScale;r-=.5;n.Vector3.TransformCoordinatesFromFloatsToRef(t,i,r,this._rowGenerationMatrix,u);u.x+=.5*this.uScale+this.uOffset;u.y+=.5*this.vScale+this.vOffset;u.z+=.5},i.prototype.getTextureMatrix=function(){return this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng?this._cachedTextureMatrix:(this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedTextureMatrix||(this._cachedTextureMatrix=n.Matrix.Zero(),this._rowGenerationMatrix=new n.Matrix,this._t0=n.Vector3.Zero(),this._t1=n.Vector3.Zero(),this._t2=n.Vector3.Zero()),n.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),n.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix.m[0]=this._t1.x,this._cachedTextureMatrix.m[1]=this._t1.y,this._cachedTextureMatrix.m[2]=this._t1.z,this._cachedTextureMatrix.m[4]=this._t2.x,this._cachedTextureMatrix.m[5]=this._t2.y,this._cachedTextureMatrix.m[6]=this._t2.z,this._cachedTextureMatrix.m[8]=this._t0.x,this._cachedTextureMatrix.m[9]=this._t0.y,this._cachedTextureMatrix.m[10]=this._t0.z,this._cachedTextureMatrix)},i.prototype.getReflectionTextureMatrix=function(){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode)return this._cachedTextureMatrix;switch(this._cachedTextureMatrix||(this._cachedTextureMatrix=n.Matrix.Zero(),this._projectionModeMatrix=n.Matrix.Zero()),this._cachedCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case i.PLANAR_MODE:n.Matrix.IdentityToRef(this._cachedTextureMatrix);this._cachedTextureMatrix[0]=this.uScale;this._cachedTextureMatrix[5]=this.vScale;this._cachedTextureMatrix[12]=this.uOffset;this._cachedTextureMatrix[13]=this.vOffset;break;case i.PROJECTION_MODE:n.Matrix.IdentityToRef(this._projectionModeMatrix);this._projectionModeMatrix.m[0]=.5;this._projectionModeMatrix.m[5]=-.5;this._projectionModeMatrix.m[10]=0;this._projectionModeMatrix.m[12]=.5;this._projectionModeMatrix.m[13]=.5;this._projectionModeMatrix.m[14]=1;this._projectionModeMatrix.m[15]=1;this.getScene().getProjectionMatrix().multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:n.Matrix.IdentityToRef(this._cachedTextureMatrix)}return this._cachedTextureMatrix},i.prototype.clone=function(){var t=this;return n.SerializationHelper.Clone(function(){return new i(t._texture.url,t.getScene(),t._noMipmap,t._invertY,t._samplingMode)},this)},Object.defineProperty(i.prototype,"onLoadObservable",{get:function(){return this._onLoadObservarble||(this._onLoadObservarble=new n.Observable),this._onLoadObservarble},enumerable:!0,configurable:!0}),i.CreateFromBase64String=function(n,t,r,u,f,e,o,s){return void 0===e&&(e=i.TRILINEAR_SAMPLINGMODE),void 0===o&&(o=null),void 0===s&&(s=null),new i("data:"+t,r,u,f,e,o,s,n)},i.Parse=function(t,r,u){var o,e,f,s;if(t.customType)return o=n.Tools.Instantiate(t.customType),o.Parse(t,r,u);if(t.isCube)return n.CubeTexture.Parse(t,r,u);if(!t.name&&!t.isRenderTarget)return null;if(e=n.SerializationHelper.Parse(function(){var f,e;return t.mirrorPlane?(f=new n.MirrorTexture(t.name,t.renderTargetSize,r),f._waitingRenderList=t.renderList,f.mirrorPlane=n.Plane.FromArray(t.mirrorPlane),f):t.isRenderTarget?(e=new n.RenderTargetTexture(t.name,t.renderTargetSize,r),e._waitingRenderList=t.renderList,e):t.base64String?i.CreateFromBase64String(t.base64String,t.name,r):new i(u+t.name,r)},t,r),t.animations)for(f=0;f<t.animations.length;f++)s=t.animations[f],e.animations.push(n.Animation.Parse(s));return e},i.LoadFromDataString=function(n,t,r,u,f,e,o,s,h){return void 0===u&&(u=!1),void 0===f&&(f=!1),void 0===e&&(e=!0),void 0===o&&(o=i.TRILINEAR_SAMPLINGMODE),void 0===s&&(s=null),void 0===h&&(h=null),"data:"!==n.substr(0,5)&&(n="data:"+n),new i(n,r,f,e,o,s,h,t,u)},i.NEAREST_SAMPLINGMODE=1,i.BILINEAR_SAMPLINGMODE=2,i.TRILINEAR_SAMPLINGMODE=3,i.EXPLICIT_MODE=0,i.SPHERICAL_MODE=1,i.PLANAR_MODE=2,i.CUBIC_MODE=3,i.PROJECTION_MODE=4,i.SKYBOX_MODE=5,i.INVCUBIC_MODE=6,i.EQUIRECTANGULAR_MODE=7,i.FIXED_EQUIRECTANGULAR_MODE=8,i.CLAMP_ADDRESSMODE=0,i.WRAP_ADDRESSMODE=1,i.MIRROR_ADDRESSMODE=2,r([n.serialize()],i.prototype,"url",void 0),r([n.serialize()],i.prototype,"uOffset",void 0),r([n.serialize()],i.prototype,"vOffset",void 0),r([n.serialize()],i.prototype,"uScale",void 0),r([n.serialize()],i.prototype,"vScale",void 0),r([n.serialize()],i.prototype,"uAng",void 0),r([n.serialize()],i.prototype,"vAng",void 0),r([n.serialize()],i.prototype,"wAng",void 0),i}(n.BaseTexture);n.Texture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s){if(void 0===o&&(o=null),void 0===s&&(s=null),t.call(this,r),this.coordinatesMode=n.Texture.CUBIC_MODE,this.name=i,this.url=i,this._noMipmap=f,this.hasAlpha=!1,i||e){if(this._texture=this._getFromCache(i,f),!e){u||(u=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]);e=[];for(var h=0;h<u.length;h++)e.push(i+u[h]);this._extensions=u}this._files=e;this._texture?o&&(this._texture.isReady?n.Tools.SetImmediate(function(){return o()}):this._texture.onLoadedCallbacks.push(o)):r.useDelayedTextureLoading?this.delayLoadState=n.Engine.DELAYLOADSTATE_NOTLOADED:this._texture=r.getEngine().createCubeTexture(i,r,e,f,o,s);this.isCube=!0;this._textureMatrix=n.Matrix.Identity()}}return u(i,t),i.CreateFromImages=function(n,t,r){return new i("",t,null,r,n)},i.prototype.delayLoad=function(){this.delayLoadState===n.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=n.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||(this._texture=this.getScene().getEngine().createCubeTexture(this.url,this.getScene(),this._files,this._noMipmap)))},i.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},i.Parse=function(t,i,r){var f=n.SerializationHelper.Parse(function(){return new n.CubeTexture(r+t.name,i,t.extensions)},t,i),u,e;if(t.animations)for(u=0;u<t.animations.length;u++)e=t.animations[u],f.animations.push(n.Animation.Parse(e));return f},i.prototype.clone=function(){var t=this;return n.SerializationHelper.Clone(function(){return new i(t.url,t.getScene(),t._extensions,t._noMipmap,t._files)},this)},i}(n.BaseTexture);n.CubeTexture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s,h,c,l){void 0===e&&(e=!0);void 0===o&&(o=n.Engine.TEXTURETYPE_UNSIGNED_INT);void 0===s&&(s=!1);void 0===h&&(h=n.Texture.TRILINEAR_SAMPLINGMODE);void 0===c&&(c=!0);void 0===l&&(l=!1);t.call(this,null,u,!f);this.isCube=s;this.renderList=[];this.renderParticles=!0;this.renderSprites=!1;this.coordinatesMode=n.Texture.PROJECTION_MODE;this.onAfterUnbindObservable=new n.Observable;this.onBeforeRenderObservable=new n.Observable;this.onAfterRenderObservable=new n.Observable;this.onClearObservable=new n.Observable;this._currentRefreshId=-1;this._refreshRate=1;this.name=i;this.isRenderTarget=!0;this._size=r;this._generateMipMaps=f;this._doNotChangeAspectRatio=e;h===n.Texture.NEAREST_SAMPLINGMODE&&(this.wrapU=n.Texture.CLAMP_ADDRESSMODE,this.wrapV=n.Texture.CLAMP_ADDRESSMODE);s?(this._texture=u.getEngine().createRenderTargetCubeTexture(r,{generateMipMaps:f,samplingMode:h,generateDepthBuffer:c,generateStencilBuffer:l}),this.coordinatesMode=n.Texture.INVCUBIC_MODE,this._textureMatrix=n.Matrix.Identity()):this._texture=u.getEngine().createRenderTargetTexture(r,{generateMipMaps:f,type:o,samplingMode:h,generateDepthBuffer:c,generateStencilBuffer:l});this._renderingManager=new n.RenderingManager(u)}return u(i,t),Object.defineProperty(i,"REFRESHRATE_RENDER_ONCE",{get:function(){return i._REFRESHRATE_RENDER_ONCE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"REFRESHRATE_RENDER_ONEVERYFRAME",{get:function(){return i._REFRESHRATE_RENDER_ONEVERYFRAME},enumerable:!0,configurable:!0}),Object.defineProperty(i,"REFRESHRATE_RENDER_ONEVERYTWOFRAMES",{get:function(){return i._REFRESHRATE_RENDER_ONEVERYTWOFRAMES},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onAfterUnbind",{set:function(n){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver);this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onBeforeRender",{set:function(n){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver);this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onAfterRender",{set:function(n){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver);this._onAfterRenderObserver=this.onAfterRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onClear",{set:function(n){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver);this._onClearObserver=this.onClearObservable.add(n)},enumerable:!0,configurable:!0}),i.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(n){this._refreshRate=n;this.resetRefreshCounter()},enumerable:!0,configurable:!0}),i.prototype._shouldRender=function(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)},i.prototype.isReady=function(){return!!this.getScene().renderTargetsEnabled&&t.prototype.isReady.call(this)},i.prototype.getRenderSize=function(){return this._size},Object.defineProperty(i.prototype,"canRescale",{get:function(){return!0},enumerable:!0,configurable:!0}),i.prototype.scale=function(n){var t=this._size*n;this.resize(t,this._generateMipMaps)},i.prototype.getReflectionTextureMatrix=function(){return this.isCube?this._textureMatrix:t.prototype.getReflectionTextureMatrix.call(this)},i.prototype.resize=function(n,t){this.releaseInternalTexture();this._texture=this.isCube?this.getScene().getEngine().createRenderTargetCubeTexture(n):this.getScene().getEngine().createRenderTargetTexture(n,t)},i.prototype.render=function(n,t){var i=this.getScene(),a,o,u,r,f,l,e;if(void 0!==this.useCameraPostProcesses&&(n=this.useCameraPostProcesses),this.activeCamera&&this.activeCamera!==i.activeCamera&&i.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(!0)),this._waitingRenderList){for(this.renderList=[],u=0;u<this._waitingRenderList.length;u++)a=this._waitingRenderList[u],this.renderList.push(i.getMeshByID(a));delete this._waitingRenderList}if(this.renderListPredicate)for(this.renderList.splice(0),o=this.getScene().meshes,u=0;u<o.length;u++)r=o[u],this.renderListPredicate(r)&&this.renderList.push(r);if(!this.renderList||0!==this.renderList.length){this._renderingManager.reset();for(var s=this.renderList?this.renderList:i.getActiveMeshes().data,h=this.renderList?this.renderList.length:i.getActiveMeshes().length,v=i.getRenderId(),c=0;c<h;c++)if(r=s[c],r){if(!r.isReady()){this.resetRefreshCounter();continue}if(r._preActivateForIntermediateRendering(v),r.isEnabled()&&r.isVisible&&r.subMeshes&&0!=(r.layerMask&i.activeCamera.layerMask))for(r._activate(v),f=0;f<r.subMeshes.length;f++)l=r.subMeshes[f],i._activeIndices.addCount(l.indexCount,!1),this._renderingManager.dispatch(l)}if(this.isCube)for(e=0;e<6;e++)this.renderToTarget(e,s,h,n,t),i.incrementRenderId(),i.resetCachedMaterial();else this.renderToTarget(0,s,h,n,t);this.onAfterUnbindObservable.notifyObservers(this);this.activeCamera&&this.activeCamera!==i.activeCamera&&i.setTransformMatrix(i.activeCamera.getViewMatrix(),i.activeCamera.getProjectionMatrix(!0));i.resetCachedMaterial()}},i.prototype.renderToTarget=function(t,i,r,u,f){var o=this.getScene(),e=o.getEngine();u&&o.postProcessManager._prepareFrame(this._texture)||(this.isCube?e.bindFramebuffer(this._texture,t):e.bindFramebuffer(this._texture));this.onBeforeRenderObservable.notifyObservers(t);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(e):e.clear(o.clearColor,!0,!0,!0);this._doNotChangeAspectRatio||o.updateTransformMatrix(!0);this._renderingManager.render(this.customRenderFunction,i,this.renderParticles,this.renderSprites);u&&o.postProcessManager._finalizeFrame(!1,this._texture,t);this._doNotChangeAspectRatio||o.updateTransformMatrix(!0);this.onAfterRenderObservable.notifyObservers(t);f&&n.Tools.DumpFramebuffer(this._size,this._size,e);this.isCube&&5!==t||(this.isCube&&5===t&&e.generateMipMapsForCubemap(this._texture),e.unBindFramebuffer(this._texture,this.isCube))},i.prototype.setRenderingOrder=function(n,t,i,r){void 0===t&&(t=null);void 0===i&&(i=null);void 0===r&&(r=null);this._renderingManager.setRenderingOrder(n,t,i,r)},i.prototype.setRenderingAutoClearDepthStencil=function(n,t){this._renderingManager.setRenderingAutoClearDepthStencil(n,t)},i.prototype.clone=function(){var t=this.getSize(),n=new i(this.name,t.width,this.getScene(),this._generateMipMaps);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.coordinatesMode=this.coordinatesMode,n.renderList=this.renderList.slice(0),n},i.prototype.serialize=function(){var n,i;if(!this.name)return null;for(n=t.prototype.serialize.call(this),n.renderTargetSize=this.getRenderSize(),n.renderList=[],i=0;i<this.renderList.length;i++)n.renderList.push(this.renderList[i].id);return n},i._REFRESHRATE_RENDER_ONCE=0,i._REFRESHRATE_RENDER_ONEVERYFRAME=1,i._REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,i}(n.Texture);n.RenderTargetTexture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s){var l,c,h;void 0===o&&(o=!0);void 0===s&&(s=!1);t.call(this,null,f,!o);this.isCube=s;this.isEnabled=!0;this._currentRefreshId=-1;this._refreshRate=1;this._vertexBuffers={};this._uniforms=[];this._samplers=[];this._textures=[];this._floats=[];this._floatsArrays={};this._colors3=[];this._colors4=[];this._vectors2=[];this._vectors3=[];this._matrices=[];this._fallbackTextureUsed=!1;f._proceduralTextures.push(this);this.name=i;this.isRenderTarget=!0;this._size=r;this._generateMipMaps=o;this.setFragment(u);this._fallbackTexture=e;l=f.getEngine();s?(this._texture=l.createRenderTargetCubeTexture(r,{generateMipMaps:o}),this.setFloat("face",0)):this._texture=l.createRenderTargetTexture(r,o);c=[];c.push(1,1);c.push(-1,1);c.push(-1,-1);c.push(1,-1);this._vertexBuffers[n.VertexBuffer.PositionKind]=new n.VertexBuffer(l,c,n.VertexBuffer.PositionKind,!1,!1,2);h=[];h.push(0);h.push(1);h.push(2);h.push(0);h.push(2);h.push(3);this._indexBuffer=l.createIndexBuffer(h)}return u(i,t),i.prototype.reset=function(){if(void 0!==this._effect){var n=this.getScene().getEngine();n._releaseEffect(this._effect)}},i.prototype.isReady=function(){var i,t=this,r=this.getScene().getEngine();return!!this._fragment&&(!!this._fallbackTextureUsed||(i=void 0!==this._fragment.fragmentElement?{vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:{vertex:"procedural",fragment:this._fragment},this._effect=r.createEffect(i,[n.VertexBuffer.PositionKind],this._uniforms,this._samplers,"",null,null,function(){t.releaseInternalTexture();t._fallbackTexture&&(t._texture=t._fallbackTexture._texture,t._texture.references++);t._fallbackTextureUsed=!0}),this._effect.isReady()))},i.prototype.resetRefreshCounter=function(){this._currentRefreshId=-1},i.prototype.setFragment=function(n){this._fragment=n},Object.defineProperty(i.prototype,"refreshRate",{get:function(){return this._refreshRate},set:function(n){this._refreshRate=n;this.resetRefreshCounter()},enumerable:!0,configurable:!0}),i.prototype._shouldRender=function(){return!!(this.isEnabled&&this.isReady()&&this._texture)&&!this._fallbackTextureUsed&&(this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1))},i.prototype.getRenderSize=function(){return this._size},i.prototype.resize=function(n,t){this._fallbackTextureUsed||(this.releaseInternalTexture(),this._texture=this.getScene().getEngine().createRenderTargetTexture(n,t))},i.prototype._checkUniform=function(n){this._uniforms.indexOf(n)===-1&&this._uniforms.push(n)},i.prototype.setTexture=function(n,t){return this._samplers.indexOf(n)===-1&&this._samplers.push(n),this._textures[n]=t,this},i.prototype.setFloat=function(n,t){return this._checkUniform(n),this._floats[n]=t,this},i.prototype.setFloats=function(n,t){return this._checkUniform(n),this._floatsArrays[n]=t,this},i.prototype.setColor3=function(n,t){return this._checkUniform(n),this._colors3[n]=t,this},i.prototype.setColor4=function(n,t){return this._checkUniform(n),this._colors4[n]=t,this},i.prototype.setVector2=function(n,t){return this._checkUniform(n),this._vectors2[n]=t,this},i.prototype.setVector3=function(n,t){return this._checkUniform(n),this._vectors3[n]=t,this},i.prototype.setMatrix=function(n,t){return this._checkUniform(n),this._matrices[n]=t,this},i.prototype.render=function(){var u=this.getScene(),t=u.getEngine(),n,r,i;t.enableEffect(this._effect);t.setState(!1);for(n in this._textures)this._effect.setTexture(n,this._textures[n]);for(n in this._floats)this._effect.setFloat(n,this._floats[n]);for(n in this._floatsArrays)this._effect.setArray(n,this._floatsArrays[n]);for(n in this._colors3)this._effect.setColor3(n,this._colors3[n]);for(n in this._colors4)r=this._colors4[n],this._effect.setFloat4(n,r.r,r.g,r.b,r.a);for(n in this._vectors2)this._effect.setVector2(n,this._vectors2[n]);for(n in this._vectors3)this._effect.setVector3(n,this._vectors3[n]);for(n in this._matrices)this._effect.setMatrix(n,this._matrices[n]);if(t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),this.isCube)for(i=0;i<6;i++)t.bindFramebuffer(this._texture,i),this._effect.setFloat("face",i),t.clear(u.clearColor,!0,!0,!0),t.draw(!0,0,6),5===i&&t.generateMipMapsForCubemap(this._texture);else t.bindFramebuffer(this._texture),t.clear(u.clearColor,!0,!0,!0),t.draw(!0,0,6);t.unBindFramebuffer(this._texture,this.isCube);this.onGenerated&&this.onGenerated()},i.prototype.clone=function(){var t=this.getSize(),n=new i(this.name,t.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.coordinatesMode=this.coordinatesMode,n},i.prototype.dispose=function(){var r=this.getScene()._proceduralTextures.indexOf(this),i;r>=0&&this.getScene()._proceduralTextures.splice(r,1);i=this._vertexBuffers[n.VertexBuffer.PositionKind];i&&(i.dispose(),this._vertexBuffers[n.VertexBuffer.PositionKind]=null);this._indexBuffer&&this.getScene().getEngine()._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null);t.prototype.dispose.call(this)},i}(n.Texture);n.ProceduralTexture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f){var e=this;t.call(this,i,r,u,f,!0);this.mirrorPlane=new n.Plane(0,1,0,1);this._transformMatrix=n.Matrix.Zero();this._mirrorMatrix=n.Matrix.Zero();this.onBeforeRenderObservable.add(function(){n.Matrix.ReflectionToRef(e.mirrorPlane,e._mirrorMatrix);e._savedViewMatrix=u.getViewMatrix();e._mirrorMatrix.multiplyToRef(e._savedViewMatrix,e._transformMatrix);u.setTransformMatrix(e._transformMatrix,u.getProjectionMatrix());u.clipPlane=e.mirrorPlane;u.getEngine().cullBackFaces=!1;u._mirroredCameraPosition=n.Vector3.TransformCoordinates(u.activeCamera.position,e._mirrorMatrix)});this.onAfterRenderObservable.add(function(){u.setTransformMatrix(e._savedViewMatrix,u.getProjectionMatrix());u.getEngine().cullBackFaces=!0;u._mirroredCameraPosition=null;delete u.clipPlane})}return u(i,t),i.prototype.clone=function(){var t=this.getSize(),n=new i(this.name,t.width,this.getScene(),this._generateMipMaps);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.mirrorPlane=this.mirrorPlane.clone(),n.renderList=this.renderList.slice(0),n},i.prototype.serialize=function(){if(!this.name)return null;var n=t.prototype.serialize.call(this);return n.mirrorPlane=this.mirrorPlane.asArray(),n},i}(n.RenderTargetTexture);n.MirrorTexture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f){var e=this;t.call(this,i,r,u,f,!0);this.refractionPlane=new n.Plane(0,1,0,1);this.depth=2;this.onBeforeRenderObservable.add(function(){u.clipPlane=e.refractionPlane});this.onAfterRenderObservable.add(function(){delete u.clipPlane})}return u(i,t),i.prototype.clone=function(){var t=this.getSize(),n=new i(this.name,t.width,this.getScene(),this._generateMipMaps);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.refractionPlane=this.refractionPlane.clone(),n.renderList=this.renderList.slice(0),n.depth=this.depth,n},i.prototype.serialize=function(){if(!this.name)return null;var n=t.prototype.serialize.call(this);return n.mirrorPlane=this.refractionPlane.asArray(),n.depth=this.depth,n},i}(n.RenderTargetTexture);n.RefractionTexture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e){void 0===e&&(e=n.Texture.TRILINEAR_SAMPLINGMODE);t.call(this,null,u,!f);this.name=i;this.wrapU=n.Texture.CLAMP_ADDRESSMODE;this.wrapV=n.Texture.CLAMP_ADDRESSMODE;this._generateMipMaps=f;r.getContext?(this._canvas=r,this._texture=u.getEngine().createDynamicTexture(r.width,r.height,f,e)):(this._canvas=document.createElement("canvas"),this._texture=r.width?u.getEngine().createDynamicTexture(r.width,r.height,f,e):u.getEngine().createDynamicTexture(r,r,f,e));var o=this.getSize();this._canvas.width=o.width;this._canvas.height=o.height;this._context=this._canvas.getContext("2d")}return u(i,t),Object.defineProperty(i.prototype,"canRescale",{get:function(){return!0},enumerable:!0,configurable:!0}),i.prototype.scale=function(n){var t=this.getSize();t.width*=n;t.height*=n;this._canvas.width=t.width;this._canvas.height=t.height;this.releaseInternalTexture();this._texture=this.getScene().getEngine().createDynamicTexture(t.width,t.height,this._generateMipMaps,this._samplingMode)},i.prototype.getContext=function(){return this._context},i.prototype.clear=function(){var n=this.getSize();this._context.fillRect(0,0,n.width,n.height)},i.prototype.update=function(n){this.getScene().getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===n||n)},i.prototype.drawText=function(n,t,i,r,u,f,e,o){var s,h;void 0===o&&(o=!0);s=this.getSize();(f&&(this._context.fillStyle=f,this._context.fillRect(0,0,s.width,s.height)),this._context.font=r,null===t)&&(h=this._context.measureText(n),t=(s.width-h.width)/2);this._context.fillStyle=u;this._context.fillText(n,t,i);o&&this.update(e)},i.prototype.clone=function(){var t=this.getSize(),n=new i(this.name,t,this.getScene(),this._generateMipMaps);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.wrapU=this.wrapU,n.wrapV=this.wrapV,n},i}(n.Texture);n.DynamicTexture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o){var h=this,s;void 0===f&&(f=!1);void 0===e&&(e=!1);void 0===o&&(o=n.Texture.TRILINEAR_SAMPLINGMODE);t.call(this,null,u,!f,e);this._autoLaunch=!0;this.name=i;r instanceof HTMLVideoElement?this.video=r:(s=r,this.video=document.createElement("video"),this.video.autoplay=!1,this.video.loop=!0);this._generateMipMaps=f;this._samplingMode=o;n.Tools.IsExponentOfTwo(this.video.videoWidth)&&n.Tools.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=n.Texture.WRAP_ADDRESSMODE,this.wrapV=n.Texture.WRAP_ADDRESSMODE):(this.wrapU=n.Texture.CLAMP_ADDRESSMODE,this.wrapV=n.Texture.CLAMP_ADDRESSMODE,this._generateMipMaps=!1);s?(this.video.addEventListener("canplaythrough",function(){h._createTexture()}),s.forEach(function(n){var t=document.createElement("source");t.src=n;h.video.appendChild(t)})):this._createTexture();this._lastUpdate=n.Tools.Now}return u(i,t),i.prototype._createTexture=function(){this._texture=this.getScene().getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this._samplingMode);this._texture.isReady=!0},i.prototype.update=function(){this._autoLaunch&&(this._autoLaunch=!1,this.video.play());var t=n.Tools.Now;return!(t-this._lastUpdate<15||this.video.readyState!==this.video.HAVE_ENOUGH_DATA)&&(this._lastUpdate=t,this.getScene().getEngine().updateVideoTexture(this._texture,this.video,this._invertY),!0)},i}(n.Texture);n.VideoTexture=t}(i||(i={}));!function(n){var t=function(t){function i(n,i,r,u,f,e){t.call(this,n,r,null,u,f,e);this._animate=!0;this._time=0;this._texturePath=i;this.loadJson(i);this.refreshRate=1}return u(i,t),i.prototype.loadJson=function(t){function u(){n.Tools.Log("No config file found in "+t+" trying to use ShadersStore or DOM element");try{f.setFragment(f._texturePath)}catch(i){n.Tools.Error("No json or ShaderStore or DOM element found for CustomProceduralTexture")}}var i=this,f=this,e=t+"/config.json",r=new XMLHttpRequest;r.open("GET",e,!0);r.addEventListener("load",function(){if(200===r.status||n.Tools.ValidateXHRData(r,1))try{i._config=JSON.parse(r.response);i.updateShaderUniforms();i.updateTextures();i.setFragment(i._texturePath+"/custom");i._animate=i._config.animate;i.refreshRate=i._config.refreshrate}catch(t){u()}else u()},!1);r.addEventListener("error",function(){u()},!1);try{r.send()}catch(o){n.Tools.Error("CustomProceduralTexture: Error on XHR send request.")}},i.prototype.isReady=function(){var n,i;if(!t.prototype.isReady.call(this))return!1;for(n in this._textures)if(i=this._textures[n],!i.isReady())return!1;return!0},i.prototype.render=function(n){this._animate&&(this._time+=.03*this.getScene().getAnimationRatio(),this.updateShaderUniforms());t.prototype.render.call(this,n)},i.prototype.updateTextures=function(){for(var t=0;t<this._config.sampler2Ds.length;t++)this.setTexture(this._config.sampler2Ds[t].sample2Dname,new n.Texture(this._texturePath+"/"+this._config.sampler2Ds[t].textureRelativeUrl,this.getScene()))},i.prototype.updateShaderUniforms=function(){var i,t;if(this._config)for(i=0;i<this._config.uniforms.length;i++){t=this._config.uniforms[i];switch(t.type){case"float":this.setFloat(t.name,t.value);break;case"color3":this.setColor3(t.name,new n.Color3(t.r,t.g,t.b));break;case"color4":this.setColor4(t.name,new n.Color4(t.r,t.g,t.b,t.a));break;case"vector2":this.setVector2(t.name,new n.Vector2(t.x,t.y));break;case"vector3":this.setVector3(t.name,new n.Vector3(t.x,t.y,t.z))}}this.setFloat("time",this._time)},Object.defineProperty(i.prototype,"animate",{get:function(){return this._animate},set:function(n){this._animate=n},enumerable:!0,configurable:!0}),i}(n.ProceduralTexture);n.CustomProceduralTexture=t}(i||(i={}));!function(n){var i=function(){function t(){this._defines={};this._currentRank=32;this._maxRank=-1}return t.prototype.addFallback=function(n,t){this._defines[n]||(n<this._currentRank&&(this._currentRank=n),n>this._maxRank&&(this._maxRank=n),this._defines[n]=[]);this._defines[n].push(t)},t.prototype.addCPUSkinningFallback=function(n,t){this._meshRank=n;this._mesh=t;n>this._maxRank&&(this._maxRank=n)},Object.defineProperty(t.prototype,"isMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:!0,configurable:!0}),t.prototype.reduce=function(t){for(var r=this._defines[this._currentRank],i=0;i<r.length;i++)t=t.replace("#define "+r[i],"");return this._mesh&&this._currentRank===this._meshRank&&(this._mesh.computeBonesUsingShaders=!1,t=t.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),n.Tools.Log("Falling back to CPU skinning for "+this._mesh.name)),this._currentRank++,t},t}(),t;n.EffectFallbacks=i;t=function(){function t(n,t,i,r,u,f,e,o,s,h){var a=this,c,l;this._isReady=!1;this._compilationError="";this._valueCache={};this._engine=u;this.name=n;this.defines=f;this._uniformsNames=i.concat(r);this._samplers=r;this._attributesNames=t;this.onError=s;this.onCompiled=o;this._indexParameters=h;n.vertexElement?(c=document.getElementById(n.vertexElement),c||(c=n.vertexElement)):c=n.vertex||n;n.fragmentElement?(l=document.getElementById(n.fragmentElement),l||(l=n.fragmentElement)):l=n.fragment||n;this._loadVertexShader(c,function(n){a._processIncludes(n,function(n){a._loadFragmentShader(l,function(i){a._processIncludes(i,function(i){a._prepareEffect(n,i,t,f,e)})})})})}return t.prototype.isReady=function(){return this._isReady},t.prototype.getProgram=function(){return this._program},t.prototype.getAttributesNames=function(){return this._attributesNames},t.prototype.getAttributeLocation=function(n){return this._attributes[n]},t.prototype.getAttributeLocationByName=function(n){var t=this._attributesNames.indexOf(n);return this._attributes[t]},t.prototype.getAttributesCount=function(){return this._attributes.length},t.prototype.getUniformIndex=function(n){return this._uniformsNames.indexOf(n)},t.prototype.getUniform=function(n){return this._uniforms[this._uniformsNames.indexOf(n)]},t.prototype.getSamplers=function(){return this._samplers},t.prototype.getCompilationError=function(){return this._compilationError},t.prototype.getVertexShaderSource=function(){return this._engine.getVertexShaderSource(this._program)},t.prototype.getFragmentShaderSource=function(){return this._engine.getFragmentShaderSource(this._program)},t.prototype._loadVertexShader=function(i,r){var u,f,e;if(i instanceof HTMLElement)return u=n.Tools.GetDOMTextContent(i),void r(u);if("base64:"===i.substr(0,7))return f=window.atob(i.substr(7)),void r(f);if(t.ShadersStore[i+"VertexShader"])return void r(t.ShadersStore[i+"VertexShader"]);e="."===i[0]||"/"===i[0]||i.indexOf("http")>-1?i:n.Engine.ShadersRepository+i;n.Tools.LoadFile(e+".vertex.fx",r)},t.prototype._loadFragmentShader=function(i,r){var u,f,e;if(i instanceof HTMLElement)return u=n.Tools.GetDOMTextContent(i),void r(u);if("base64:"===i.substr(0,7))return f=window.atob(i.substr(7)),void r(f);if(t.ShadersStore[i+"PixelShader"])return void r(t.ShadersStore[i+"PixelShader"]);if(t.ShadersStore[i+"FragmentShader"])return void r(t.ShadersStore[i+"FragmentShader"]);e="."===i[0]||"/"===i[0]||i.indexOf("http")>-1?i:n.Engine.ShadersRepository+i;n.Tools.LoadFile(e+".fragment.fx",r)},t.prototype._dumpShadersName=function(){this.name.vertexElement?(n.Tools.Error("Vertex shader:"+this.name.vertexElement),n.Tools.Error("Fragment shader:"+this.name.fragmentElement)):this.name.vertex?(n.Tools.Error("Vertex shader:"+this.name.vertex),n.Tools.Error("Fragment shader:"+this.name.fragment)):(n.Tools.Error("Vertex shader:"+this.name),n.Tools.Error("Fragment shader:"+this.name))},t.prototype._processIncludes=function(i,r){for(var e,p,u,h,o,w,b,c,l,k=this,y=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,f=y.exec(i),s=new String(i);null!=f;){if(e=f[1],!t.IncludesShadersStore[e])return p=n.Engine.ShadersRepository+"ShadersInclude/"+e+".fx",void n.Tools.LoadFile(p,function(n){t.IncludesShadersStore[e]=n;k._processIncludes(s,r)});if(u=t.IncludesShadersStore[e],f[2])for(h=f[3].split(","),o=0;o<h.length;o+=2)w=new RegExp(h[o],"g"),b=h[o+1],u=u.replace(w,b);if(f[4])if(c=f[5],c.indexOf("..")!==-1){var a=c.split(".."),d=parseInt(a[0]),v=parseInt(a[1]),g=u.slice(0);for(u="",isNaN(v)&&(v=this._indexParameters[a[1]]),l=d;l<=v;l++)u+=g.replace(/\{X\}/g,l)+"\n"}else u=u.replace(/\{X\}/g,c);s=s.replace(f[0],u);f=y.exec(i)}r(s)},t.prototype._processPrecision=function(n){return n.indexOf("precision highp float")===-1?n=this._engine.getCaps().highPrecisionShaderSupported?"precision highp float;\n"+n:"precision mediump float;\n"+n:this._engine.getCaps().highPrecisionShaderSupported||(n=n.replace("precision highp float","precision mediump float")),n},t.prototype._prepareEffect=function(t,i,r,u,f){var o,e,s;try{for(o=this._engine,t=this._processPrecision(t),i=this._processPrecision(i),this._program=o.createShaderProgram(t,i,u),this._uniforms=o.getUniforms(this._program,this._uniformsNames),this._attributes=o.getAttributes(this._program,r),e=0;e<this._samplers.length;e++)s=this.getUniform(this._samplers[e]),null==s&&(this._samplers.splice(e,1),e--);o.bindSamplers(this);this._compilationError="";this._isReady=!0;this.onCompiled&&this.onCompiled(this)}catch(h){this._compilationError=h.message;n.Tools.Error("Unable to compile effect: ");n.Tools.Error("Defines: "+u);n.Tools.Error("Error: "+this._compilationError);this._dumpShadersName();f&&f.isMoreFallbacks?(n.Tools.Error("Trying next fallback."),u=f.reduce(u),this._prepareEffect(t,i,r,u,f)):this.onError&&this.onError(this,this._compilationError)}},Object.defineProperty(t.prototype,"isSupported",{get:function(){return""===this._compilationError},enumerable:!0,configurable:!0}),t.prototype._bindTexture=function(n,t){this._engine._bindTexture(this._samplers.indexOf(n),t)},t.prototype.setTexture=function(n,t){this._engine.setTexture(this._samplers.indexOf(n),this.getUniform(n),t)},t.prototype.setTextureArray=function(n,t){if(this._samplers.indexOf(n+"Ex")===-1)for(var r=this._samplers.indexOf(n),i=1;i<t.length;i++)this._samplers.splice(r+i,0,n+"Ex");this._engine.setTextureArray(this._samplers.indexOf(n),this.getUniform(n),t)},t.prototype.setTextureFromPostProcess=function(n,t){this._engine.setTextureFromPostProcess(this._samplers.indexOf(n),t)},t.prototype._cacheMatrix=function(t,i){var f=!1,u=this._valueCache[t];u&&u instanceof n.Matrix||(f=!0,u=new n.Matrix);for(var e=u.m,o=i.m,r=0;r<16;r++)e[r]!==o[r]&&(e[r]=o[r],f=!0);return this._valueCache[t]=u,f},t.prototype._cacheFloat2=function(n,t,i){var r=this._valueCache[n],u;return r?(u=!1,r[0]!==t&&(r[0]=t,u=!0),r[1]!==i&&(r[1]=i,u=!0),u):(r=[t,i],this._valueCache[n]=r,!0)},t.prototype._cacheFloat3=function(n,t,i,r){var u=this._valueCache[n],f;return u?(f=!1,u[0]!==t&&(u[0]=t,f=!0),u[1]!==i&&(u[1]=i,f=!0),u[2]!==r&&(u[2]=r,f=!0),f):(u=[t,i,r],this._valueCache[n]=u,!0)},t.prototype._cacheFloat4=function(n,t,i,r,u){var f=this._valueCache[n],e;return f?(e=!1,f[0]!==t&&(f[0]=t,e=!0),f[1]!==i&&(f[1]=i,e=!0),f[2]!==r&&(f[2]=r,e=!0),f[3]!==u&&(f[3]=u,e=!0),e):(f=[t,i,r,u],this._valueCache[n]=f,!0)},t.prototype.setIntArray=function(n,t){return this._valueCache[n]=null,this._engine.setIntArray(this.getUniform(n),t),this},t.prototype.setIntArray2=function(n,t){return this._valueCache[n]=null,this._engine.setIntArray2(this.getUniform(n),t),this},t.prototype.setIntArray3=function(n,t){return this._valueCache[n]=null,this._engine.setIntArray3(this.getUniform(n),t),this},t.prototype.setIntArray4=function(n,t){return this._valueCache[n]=null,this._engine.setIntArray4(this.getUniform(n),t),this},t.prototype.setFloatArray=function(n,t){return this._valueCache[n]=null,this._engine.setFloatArray(this.getUniform(n),t),this},t.prototype.setFloatArray2=function(n,t){return this._valueCache[n]=null,this._engine.setFloatArray2(this.getUniform(n),t),this},t.prototype.setFloatArray3=function(n,t){return this._valueCache[n]=null,this._engine.setFloatArray3(this.getUniform(n),t),this},t.prototype.setFloatArray4=function(n,t){return this._valueCache[n]=null,this._engine.setFloatArray4(this.getUniform(n),t),this},t.prototype.setArray=function(n,t){return this._valueCache[n]=null,this._engine.setArray(this.getUniform(n),t),this},t.prototype.setArray2=function(n,t){return this._valueCache[n]=null,this._engine.setArray2(this.getUniform(n),t),this},t.prototype.setArray3=function(n,t){return this._valueCache[n]=null,this._engine.setArray3(this.getUniform(n),t),this},t.prototype.setArray4=function(n,t){return this._valueCache[n]=null,this._engine.setArray4(this.getUniform(n),t),this},t.prototype.setMatrices=function(n,t){return this._valueCache[n]=null,this._engine.setMatrices(this.getUniform(n),t),this},t.prototype.setMatrix=function(n,t){return this._cacheMatrix(n,t)&&this._engine.setMatrix(this.getUniform(n),t),this},t.prototype.setMatrix3x3=function(n,t){return this._valueCache[n]=null,this._engine.setMatrix3x3(this.getUniform(n),t),this},t.prototype.setMatrix2x2=function(n,t){return this._valueCache[n]=null,this._engine.setMatrix2x2(this.getUniform(n),t),this},t.prototype.setFloat=function(n,t){var i=this._valueCache[n];return void 0!==i&&i===t?this:(this._valueCache[n]=t,this._engine.setFloat(this.getUniform(n),t),this)},t.prototype.setBool=function(n,t){var i=this._valueCache[n];return void 0!==i&&i===t?this:(this._valueCache[n]=t,this._engine.setBool(this.getUniform(n),t?1:0),this)},t.prototype.setVector2=function(n,t){return this._cacheFloat2(n,t.x,t.y)&&this._engine.setFloat2(this.getUniform(n),t.x,t.y),this},t.prototype.setFloat2=function(n,t,i){return this._cacheFloat2(n,t,i)&&this._engine.setFloat2(this.getUniform(n),t,i),this},t.prototype.setVector3=function(n,t){return this._cacheFloat3(n,t.x,t.y,t.z)&&this._engine.setFloat3(this.getUniform(n),t.x,t.y,t.z),this},t.prototype.setFloat3=function(n,t,i,r){return this._cacheFloat3(n,t,i,r)&&this._engine.setFloat3(this.getUniform(n),t,i,r),this},t.prototype.setVector4=function(n,t){return this._cacheFloat4(n,t.x,t.y,t.z,t.w)&&this._engine.setFloat4(this.getUniform(n),t.x,t.y,t.z,t.w),this},t.prototype.setFloat4=function(n,t,i,r,u){return this._cacheFloat4(n,t,i,r,u)&&this._engine.setFloat4(this.getUniform(n),t,i,r,u),this},t.prototype.setColor3=function(n,t){return this._cacheFloat3(n,t.r,t.g,t.b)&&this._engine.setColor3(this.getUniform(n),t),this},t.prototype.setColor4=function(n,t,i){return this._cacheFloat4(n,t.r,t.g,t.b,i)&&this._engine.setColor4(this.getUniform(n),t,i),this},t.ShadersStore={},t.IncludesShadersStore={},t}();n.Effect=t}(i||(i={}));!function(n){var t=function(){function t(){}return t.PrepareDefinesForLights=function(t,i,r,u){var f,h,v,c,y,p,s,l;void 0===u&&(u=4);for(var e=0,w=!1,o=!1,b=!1,k=!1,a=0;a<t.lights.length;a++)if(f=t.lights[a],f.isEnabled()){if(f._excludedMeshesIds.length>0){for(h=0;h<f._excludedMeshesIds.length;h++)v=t.getMeshByID(f._excludedMeshesIds[h]),v&&f.excludedMeshes.push(v);f._excludedMeshesIds=[]}if(f._includedOnlyMeshesIds.length>0){for(c=0;c<f._includedOnlyMeshesIds.length;c++)y=t.getMeshByID(f._includedOnlyMeshesIds[c]),y&&f.includedOnlyMeshes.push(y);f._includedOnlyMeshesIds=[]}if(f.canAffectMesh(i)&&(w=!0,void 0===r["LIGHT"+e]&&(o=!0),r["LIGHT"+e]=!0,(p=f instanceof n.SpotLight?"SPOTLIGHT"+e:f instanceof n.HemisphericLight?"HEMILIGHT"+e:f instanceof n.PointLight?"POINTLIGHT"+e:"DIRLIGHT"+e,void 0===r[p]&&(o=!0),r[p]=!0,f.specular.equalsFloats(0,0,0)||void 0===r.SPECULARTERM||(r.SPECULARTERM=!0),t.shadowsEnabled)&&(s=f.getShadowGenerator(),i&&i.receiveShadows&&s&&(void 0===r["SHADOW"+e]&&(o=!0),r["SHADOW"+e]=!0,r.SHADOWS=!0,(s.useVarianceShadowMap||s.useBlurVarianceShadowMap)&&(void 0===r["SHADOWVSM"+e]&&(o=!0),r["SHADOWVSM"+e]=!0),s.usePoissonSampling&&(void 0===r["SHADOWPCF"+e]&&(o=!0),r["SHADOWPCF"+e]=!0),b=!0)),f.lightmapMode!=n.Light.LIGHTMAP_DEFAULT&&(k=!0,void 0===r["LIGHTMAPEXCLUDED"+e]&&(o=!0),void 0===r["LIGHTMAPNOSPECULAR"+e]&&(o=!0),r["LIGHTMAPEXCLUDED"+e]=!0,f.lightmapMode==n.Light.LIGHTMAP_SHADOWSONLY&&(r["LIGHTMAPNOSPECULAR"+e]=!0)),e++,e===u))break}return l=t.getEngine().getCaps(),b&&l.textureFloat&&l.textureFloatLinearFiltering&&l.textureFloatRender&&(void 0===r.SHADOWFULLFLOAT&&(o=!0),r.SHADOWFULLFLOAT=!0),void 0===r.LIGHTMAPEXCLUDED&&(o=!0),k&&(r.LIGHTMAPEXCLUDED=!0),o&&r.rebuild(),w},t.PrepareUniformsAndSamplersList=function(n,t,i,r){void 0===r&&(r=4);for(var u=0;u<r&&i["LIGHT"+u];u++)n.push("vLightData"+u,"vLightDiffuse"+u,"vLightSpecular"+u,"vLightDirection"+u,"vLightGround"+u,"lightMatrix"+u,"shadowsInfo"+u),t.push("shadowSampler"+u)},t.HandleFallbacksForShadows=function(n,t,i){void 0===i&&(i=4);for(var r=0;r<i&&n["LIGHT"+r];r++)r>0&&t.addFallback(r,"LIGHT"+r),n["SHADOW"+r]&&t.addFallback(0,"SHADOW"+r),n["SHADOWPCF"+r]&&t.addFallback(0,"SHADOWPCF"+r),n["SHADOWVSM"+r]&&t.addFallback(0,"SHADOWVSM"+r)},t.PrepareAttributesForBones=function(t,i,r,u){r.NUM_BONE_INFLUENCERS>0&&(u.addCPUSkinningFallback(0,i),t.push(n.VertexBuffer.MatricesIndicesKind),t.push(n.VertexBuffer.MatricesWeightsKind),r.NUM_BONE_INFLUENCERS>4&&(t.push(n.VertexBuffer.MatricesIndicesExtraKind),t.push(n.VertexBuffer.MatricesWeightsExtraKind)))},t.PrepareAttributesForInstances=function(n,t){t.INSTANCES&&(n.push("world0"),n.push("world1"),n.push("world2"),n.push("world3"))},t.BindLightShadow=function(n,t,i,r,u,f){var e=n.getShadowGenerator();return i.receiveShadows&&e&&(n.needCube()?f||(f=!0,u.setFloat2("depthValues",t.activeCamera.minZ,t.activeCamera.maxZ)):u.setMatrix("lightMatrix"+r,e.getTransformMatrix()),u.setTexture("shadowSampler"+r,e.getShadowMapForRendering()),u.setFloat3("shadowsInfo"+r,e.getDarkness(),e.blurScale/e.getShadowMap().getSize().width,e.bias)),f},t.BindLightProperties=function(t,i,r){t instanceof n.PointLight?t.transferToEffect(i,"vLightData"+r):t instanceof n.DirectionalLight?t.transferToEffect(i,"vLightData"+r):t instanceof n.SpotLight?t.transferToEffect(i,"vLightData"+r,"vLightDirection"+r):t instanceof n.HemisphericLight&&t.transferToEffect(i,"vLightData"+r,"vLightGround"+r)},t.BindLights=function(i,r,u,f,e){var o;void 0===e&&(e=4);for(var s=0,c=!1,h=0;h<i.lights.length;h++)if(o=i.lights[h],o.isEnabled()&&o.canAffectMesh(r)&&(t.BindLightProperties(o,u,s),o.diffuse.scaleToRef(o.intensity,n.Tmp.Color3[0]),u.setColor4("vLightDiffuse"+s,n.Tmp.Color3[0],o.range),f.SPECULARTERM&&(o.specular.scaleToRef(o.intensity,n.Tmp.Color3[1]),u.setColor3("vLightSpecular"+s,n.Tmp.Color3[1])),i.shadowsEnabled&&(c=this.BindLightShadow(o,i,r,s,u,c)),s++,s===e))break},t.BindFogParameters=function(t,i,r){t.fogEnabled&&i.applyFog&&t.fogMode!==n.Scene.FOGMODE_NONE&&(r.setFloat4("vFogInfos",t.fogMode,t.fogStart,t.fogEnd,t.fogDensity),r.setColor3("vFogColor",t.fogColor))},t.BindBonesParameters=function(n,t){if(n&&n.useBones&&n.computeBonesUsingShaders){var i=n.skeleton.getTransformMatrices(n);i&&t.setMatrices("mBones",i)}},t.BindLogDepth=function(n,t,i){n.LOGARITHMICDEPTH&&t.setFloat("logarithmicDepthConstant",2/(Math.log(i.activeCamera.maxZ+1)/Math.LN2))},t.BindClipPlane=function(n,t){if(t.clipPlane){var i=t.clipPlane;n.setFloat4("vClipPlane",i.normal.x,i.normal.y,i.normal.z,i.d)}},t}();n.MaterialHelper=t}(i||(i={}));!function(n){var t=function(){function t(){this.isEnabled=!0;this.leftColor=n.Color3.White();this.rightColor=n.Color3.Black();this.bias=0;this.power=1}return t.prototype.clone=function(){var i=new t;return n.Tools.DeepCopy(this,i),i},t.prototype.serialize=function(){var n={};return n.isEnabled=this.isEnabled,n.leftColor=this.leftColor,n.rightColor=this.rightColor,n.bias=this.bias,n.power=this.power,n},t.Parse=function(i){var r=new t;return r.isEnabled=i.isEnabled,r.leftColor=n.Color3.FromArray(i.leftColor),r.rightColor=n.Color3.FromArray(i.rightColor),r.bias=i.bias,r.power=i.power||1,r},t}();n.FresnelParameters=t}(i||(i={}));!function(n){var i=function(){function n(){}return n.prototype.rebuild=function(){this._keys&&delete this._keys;this._keys=Object.keys(this)},n.prototype.isEqual=function(n){var t,i;if(this._keys.length!==n._keys.length)return!1;for(t=0;t<this._keys.length;t++)if(i=this._keys[t],this[i]!==n[i])return!1;return!0},n.prototype.cloneTo=function(n){var t,i;for(this._keys.length!==n._keys.length&&(n._keys=this._keys.slice(0)),t=0;t<this._keys.length;t++)i=this._keys[t],n[i]=this[i]},n.prototype.reset=function(){for(var t,n=0;n<this._keys.length;n++)t=this._keys[n],this[t]="number"==typeof this[t]?0:!1},n.prototype.toString=function(){for(var n,t="",i=0;i<this._keys.length;i++)n=this._keys[i],"number"==typeof this[n]?t+="#define "+n+" "+this[n]+"\n":this[n]&&(t+="#define "+n+"\n");return t},n}(),t;n.MaterialDefines=i;t=function(){function t(i,r,u){this.checkReadyOnEveryCall=!1;this.checkReadyOnlyOnce=!1;this.state="";this.alpha=1;this.backFaceCulling=!0;this.doNotSerialize=!1;this.onDisposeObservable=new n.Observable;this.onBindObservable=new n.Observable;this.onUnBindObservable=new n.Observable;this.alphaMode=n.Engine.ALPHA_COMBINE;this.disableDepthWrite=!1;this.fogEnabled=!0;this.pointSize=1;this.zOffset=0;this._wasPreviouslyReady=!1;this._fillMode=t.TriangleFillMode;this.name=i;this.id=i;this._scene=r;this.sideOrientation=r.useRightHandedSystem?t.ClockWiseSideOrientation:t.CounterClockWiseSideOrientation;u||r.materials.push(this)}return Object.defineProperty(t,"TriangleFillMode",{get:function(){return t._TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"WireFrameFillMode",{get:function(){return t._WireFrameFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"PointFillMode",{get:function(){return t._PointFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ClockWiseSideOrientation",{get:function(){return t._ClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CounterClockWiseSideOrientation",{get:function(){return t._CounterClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onBind",{set:function(n){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver);this._onBindObserver=this.onBindObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wireframe",{get:function(){return this._fillMode===t.WireFrameFillMode},set:function(n){this._fillMode=n?t.WireFrameFillMode:t.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointsCloud",{get:function(){return this._fillMode===t.PointFillMode},set:function(n){this._fillMode=n?t.PointFillMode:t.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fillMode",{get:function(){return this._fillMode},set:function(n){this._fillMode=n},enumerable:!0,configurable:!0}),t.prototype.toString=function(){return"Name: "+this.name},Object.defineProperty(t.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:!0,configurable:!0}),t.prototype.freeze=function(){this.checkReadyOnlyOnce=!0},t.prototype.unfreeze=function(){this.checkReadyOnlyOnce=!1},t.prototype.isReady=function(){return!0},t.prototype.getEffect=function(){return this._effect},t.prototype.getScene=function(){return this._scene},t.prototype.needAlphaBlending=function(){return this.alpha<1},t.prototype.needAlphaTesting=function(){return!1},t.prototype.getAlphaTestTexture=function(){return null},t.prototype.markDirty=function(){this._wasPreviouslyReady=!1},t.prototype._preBind=function(){var n=this._scene.getEngine(),i=this.sideOrientation===t.ClockWiseSideOrientation;n.enableEffect(this._effect);n.setState(this.backFaceCulling,this.zOffset,!1,i)},t.prototype.bind=function(n,t){if(this._scene._cachedMaterial=this,this.onBindObservable.notifyObservers(t),this.disableDepthWrite){var i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite();i.setDepthWrite(!1)}},t.prototype.bindOnlyWorldMatrix=function(){},t.prototype.unbind=function(){if(this.onUnBindObservable.notifyObservers(this),this.disableDepthWrite){var n=this._scene.getEngine();n.setDepthWrite(this._cachedDepthWriteState)}},t.prototype.clone=function(){return null},t.prototype.getBindedMeshes=function(){for(var i,t=[],n=0;n<this._scene.meshes.length;n++)i=this._scene.meshes[n],i.material===this&&t.push(i);return t},t.prototype.dispose=function(n){var t,i;for(this.getScene().stopAnimation(this),t=this._scene.materials.indexOf(this),t>=0&&this._scene.materials.splice(t,1),n&&this._effect&&(this._scene.getEngine()._releaseEffect(this._effect),this._effect=null),t=0;t<this._scene.meshes.length;t++)i=this._scene.meshes[t],i.material===this&&(i.material=null);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBindObservable.clear();this.onUnBindObservable.clear()},t.prototype.serialize=function(){return n.SerializationHelper.Serialize(this)},t.ParseMultiMaterial=function(t,i){var r=new n.MultiMaterial(t.name,i),u,f;for(r.id=t.id,n.Tags.AddTagsTo(r,t.tags),u=0;u<t.materials.length;u++)f=t.materials[u],f?r.subMaterials.push(i.getMaterialByID(f)):r.subMaterials.push(null);return r},t.Parse=function(t,i,r){if(!t.customType)return n.StandardMaterial.Parse(t,i,r);var u=n.Tools.Instantiate(t.customType);return u.Parse(t,i,r)},t._TriangleFillMode=0,t._WireFrameFillMode=1,t._PointFillMode=2,t._ClockWiseSideOrientation=0,t._CounterClockWiseSideOrientation=1,r([n.serialize()],t.prototype,"id",void 0),r([n.serialize()],t.prototype,"name",void 0),r([n.serialize()],t.prototype,"checkReadyOnEveryCall",void 0),r([n.serialize()],t.prototype,"checkReadyOnlyOnce",void 0),r([n.serialize()],t.prototype,"state",void 0),r([n.serialize()],t.prototype,"alpha",void 0),r([n.serialize()],t.prototype,"backFaceCulling",void 0),r([n.serialize()],t.prototype,"sideOrientation",void 0),r([n.serialize()],t.prototype,"alphaMode",void 0),r([n.serialize()],t.prototype,"disableDepthWrite",void 0),r([n.serialize()],t.prototype,"fogEnabled",void 0),r([n.serialize()],t.prototype,"pointSize",void 0),r([n.serialize()],t.prototype,"zOffset",void 0),r([n.serialize()],t.prototype,"wireframe",null),r([n.serialize()],t.prototype,"pointsCloud",null),r([n.serialize()],t.prototype,"fillMode",null),t}();n.Material=t}(i||(i={}));!function(n){var t=function(n){function t(){n.call(this);this.DIFFUSE=!1;this.AMBIENT=!1;this.OPACITY=!1;this.OPACITYRGB=!1;this.REFLECTION=!1;this.EMISSIVE=!1;this.SPECULAR=!1;this.BUMP=!1;this.PARALLAX=!1;this.PARALLAXOCCLUSION=!1;this.SPECULAROVERALPHA=!1;this.CLIPPLANE=!1;this.ALPHATEST=!1;this.ALPHAFROMDIFFUSE=!1;this.POINTSIZE=!1;this.FOG=!1;this.SPECULARTERM=!1;this.DIFFUSEFRESNEL=!1;this.OPACITYFRESNEL=!1;this.REFLECTIONFRESNEL=!1;this.REFRACTIONFRESNEL=!1;this.EMISSIVEFRESNEL=!1;this.FRESNEL=!1;this.NORMAL=!1;this.UV1=!1;this.UV2=!1;this.VERTEXCOLOR=!1;this.VERTEXALPHA=!1;this.NUM_BONE_INFLUENCERS=0;this.BonesPerMesh=0;this.INSTANCES=!1;this.GLOSSINESS=!1;this.ROUGHNESS=!1;this.EMISSIVEASILLUMINATION=!1;this.LINKEMISSIVEWITHDIFFUSE=!1;this.REFLECTIONFRESNELFROMSPECULAR=!1;this.LIGHTMAP=!1;this.USELIGHTMAPASSHADOWMAP=!1;this.REFLECTIONMAP_3D=!1;this.REFLECTIONMAP_SPHERICAL=!1;this.REFLECTIONMAP_PLANAR=!1;this.REFLECTIONMAP_CUBIC=!1;this.REFLECTIONMAP_PROJECTION=!1;this.REFLECTIONMAP_SKYBOX=!1;this.REFLECTIONMAP_EXPLICIT=!1;this.REFLECTIONMAP_EQUIRECTANGULAR=!1;this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1;this.INVERTCUBICMAP=!1;this.LOGARITHMICDEPTH=!1;this.REFRACTION=!1;this.REFRACTIONMAP_3D=!1;this.REFLECTIONOVERALPHA=!1;this.INVERTNORMALMAPX=!1;this.INVERTNORMALMAPY=!1;this.SHADOWFULLFLOAT=!1;this.CAMERACOLORGRADING=!1;this.CAMERACOLORCURVES=!1;this.rebuild()}return u(t,n),t}(n.MaterialDefines),i=function(i){function f(r,u){var f=this;i.call(this,r,u);this.ambientColor=new n.Color3(0,0,0);this.diffuseColor=new n.Color3(1,1,1);this.specularColor=new n.Color3(1,1,1);this.emissiveColor=new n.Color3(0,0,0);this.specularPower=64;this.useAlphaFromDiffuseTexture=!1;this.useEmissiveAsIllumination=!1;this.linkEmissiveWithDiffuse=!1;this.useReflectionFresnelFromSpecular=!1;this.useSpecularOverAlpha=!1;this.useReflectionOverAlpha=!1;this.disableLighting=!1;this.useParallax=!1;this.useParallaxOcclusion=!1;this.parallaxScaleBias=.05;this.roughness=0;this.indexOfRefraction=.98;this.invertRefractionY=!0;this.useLightmapAsShadowmap=!1;this.useGlossinessFromSpecularMapAlpha=!1;this.maxSimultaneousLights=4;this.invertNormalMapX=!1;this.invertNormalMapY=!1;this.cameraColorGradingTexture=null;this.cameraColorCurves=null;this._renderTargets=new n.SmartArray(16);this._worldViewProjectionMatrix=n.Matrix.Zero();this._globalAmbientColor=new n.Color3(0,0,0);this._defines=new t;this._cachedDefines=new t;this._cachedDefines.BonesPerMesh=-1;this.getRenderTargetTextures=function(){return f._renderTargets.reset(),f.reflectionTexture&&f.reflectionTexture.isRenderTarget&&f._renderTargets.push(f.reflectionTexture),f.refractionTexture&&f.refractionTexture.isRenderTarget&&f._renderTargets.push(f.refractionTexture),f._renderTargets}}return u(f,i),Object.defineProperty(f.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(n){this._useLogarithmicDepth=n&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!0,configurable:!0}),f.prototype.needAlphaBlending=function(){return this.alpha<1||null!=this.opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled},f.prototype.needAlphaTesting=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha},f.prototype._shouldUseAlphaFromDiffuseTexture=function(){return null!=this.diffuseTexture&&this.diffuseTexture.hasAlpha&&this.useAlphaFromDiffuseTexture},f.prototype.getAlphaTestTexture=function(){return this.diffuseTexture},f.prototype._checkCache=function(n,t,i){return!t||this._defines.INSTANCES===i&&!(!t._materialDefines||!t._materialDefines.isEqual(this._defines))},f.prototype.isReady=function(i,r){var u,s;if(this.isFrozen&&this._wasPreviouslyReady)return!0;var e=this.getScene(),a=e.getEngine(),o=!1,h=!1;if(this._defines.reset(),e.lightsEnabled&&!this.disableLighting&&(h=n.MaterialHelper.PrepareDefinesForLights(e,i,this._defines,this.maxSimultaneousLights)),!this.checkReadyOnEveryCall&&this._renderId===e.getRenderId()&&this._checkCache(e,i,r))return!0;if(e.texturesEnabled){if(this.diffuseTexture&&f.DiffuseTextureEnabled){if(!this.diffuseTexture.isReady())return!1;o=!0;this._defines.DIFFUSE=!0}if(this.ambientTexture&&f.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;o=!0;this._defines.AMBIENT=!0}if(this.opacityTexture&&f.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;o=!0;this._defines.OPACITY=!0;this.opacityTexture.getAlphaFromRGB&&(this._defines.OPACITYRGB=!0)}if(this.reflectionTexture&&f.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;switch(h=!0,this._defines.REFLECTION=!0,this.roughness>0&&(this._defines.ROUGHNESS=!0),this.useReflectionOverAlpha&&(this._defines.REFLECTIONOVERALPHA=!0),this.reflectionTexture.coordinatesMode===n.Texture.INVCUBIC_MODE&&(this._defines.INVERTCUBICMAP=!0),this._defines.REFLECTIONMAP_3D=this.reflectionTexture.isCube,this.reflectionTexture.coordinatesMode){case n.Texture.CUBIC_MODE:case n.Texture.INVCUBIC_MODE:this._defines.REFLECTIONMAP_CUBIC=!0;break;case n.Texture.EXPLICIT_MODE:this._defines.REFLECTIONMAP_EXPLICIT=!0;break;case n.Texture.PLANAR_MODE:this._defines.REFLECTIONMAP_PLANAR=!0;break;case n.Texture.PROJECTION_MODE:this._defines.REFLECTIONMAP_PROJECTION=!0;break;case n.Texture.SKYBOX_MODE:this._defines.REFLECTIONMAP_SKYBOX=!0;break;case n.Texture.SPHERICAL_MODE:this._defines.REFLECTIONMAP_SPHERICAL=!0;break;case n.Texture.EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case n.Texture.FIXED_EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0}}if(this.emissiveTexture&&f.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;o=!0;this._defines.EMISSIVE=!0}if(this.lightmapTexture&&f.LightmapTextureEnabled){if(!this.lightmapTexture.isReady())return!1;o=!0;this._defines.LIGHTMAP=!0;this._defines.USELIGHTMAPASSHADOWMAP=this.useLightmapAsShadowmap}if(this.specularTexture&&f.SpecularTextureEnabled){if(!this.specularTexture.isReady())return!1;o=!0;this._defines.SPECULAR=!0;this._defines.GLOSSINESS=this.useGlossinessFromSpecularMapAlpha}if(e.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&f.BumpTextureEnabled){if(!this.bumpTexture.isReady())return!1;o=!0;this._defines.BUMP=!0;this.useParallax&&(this._defines.PARALLAX=!0,this.useParallaxOcclusion&&(this._defines.PARALLAXOCCLUSION=!0));this.invertNormalMapX&&(this._defines.INVERTNORMALMAPX=!0);this.invertNormalMapY&&(this._defines.INVERTNORMALMAPY=!0)}if(this.refractionTexture&&f.RefractionTextureEnabled){if(!this.refractionTexture.isReady())return!1;o=!0;this._defines.REFRACTION=!0;this._defines.REFRACTIONMAP_3D=this.refractionTexture.isCube}if(this.cameraColorGradingTexture&&f.ColorGradingTextureEnabled){if(!this.cameraColorGradingTexture.isReady())return!1;this._defines.CAMERACOLORGRADING=!0}}if(e.clipPlane&&(this._defines.CLIPPLANE=!0),a.getAlphaTesting()&&(this._defines.ALPHATEST=!0),this._shouldUseAlphaFromDiffuseTexture()&&(this._defines.ALPHAFROMDIFFUSE=!0),this.useEmissiveAsIllumination&&(this._defines.EMISSIVEASILLUMINATION=!0),this.linkEmissiveWithDiffuse&&(this._defines.LINKEMISSIVEWITHDIFFUSE=!0),this.useLogarithmicDepth&&(this._defines.LOGARITHMICDEPTH=!0),this.cameraColorCurves&&(this._defines.CAMERACOLORCURVES=!0),(this.pointsCloud||e.forcePointsCloud)&&(this._defines.POINTSIZE=!0),e.fogEnabled&&i&&i.applyFog&&e.fogMode!==n.Scene.FOGMODE_NONE&&this.fogEnabled&&(this._defines.FOG=!0),f.FresnelEnabled&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled||this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled||this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled||this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled||this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled)&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(this._defines.DIFFUSEFRESNEL=!0),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&(this._defines.OPACITYFRESNEL=!0),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(this._defines.REFLECTIONFRESNEL=!0,this.useReflectionFresnelFromSpecular&&(this._defines.REFLECTIONFRESNELFROMSPECULAR=!0)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(this._defines.REFRACTIONFRESNEL=!0),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._defines.EMISSIVEFRESNEL=!0),h=!0,this._defines.FRESNEL=!0),this._defines.SPECULARTERM&&this.useSpecularOverAlpha&&(this._defines.SPECULAROVERALPHA=!0),i&&(h&&i.isVerticesDataPresent(n.VertexBuffer.NormalKind)&&(this._defines.NORMAL=!0),o&&(i.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(this._defines.UV1=!0),i.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&(this._defines.UV2=!0)),i.useVertexColors&&i.isVerticesDataPresent(n.VertexBuffer.ColorKind)&&(this._defines.VERTEXCOLOR=!0,i.hasVertexAlpha&&(this._defines.VERTEXALPHA=!0)),i.useBones&&i.computeBonesUsingShaders&&(this._defines.NUM_BONE_INFLUENCERS=i.numBoneInfluencers,this._defines.BonesPerMesh=i.skeleton.bones.length+1),r&&(this._defines.INSTANCES=!0)),!this._defines.isEqual(this._cachedDefines)){this._defines.cloneTo(this._cachedDefines);e.resetCachedMaterial();u=new n.EffectFallbacks;this._defines.REFLECTION&&u.addFallback(0,"REFLECTION");this._defines.SPECULAR&&u.addFallback(0,"SPECULAR");this._defines.BUMP&&u.addFallback(0,"BUMP");this._defines.PARALLAX&&u.addFallback(1,"PARALLAX");this._defines.PARALLAXOCCLUSION&&u.addFallback(0,"PARALLAXOCCLUSION");this._defines.SPECULAROVERALPHA&&u.addFallback(0,"SPECULAROVERALPHA");this._defines.FOG&&u.addFallback(1,"FOG");this._defines.POINTSIZE&&u.addFallback(0,"POINTSIZE");this._defines.LOGARITHMICDEPTH&&u.addFallback(0,"LOGARITHMICDEPTH");n.MaterialHelper.HandleFallbacksForShadows(this._defines,u,this.maxSimultaneousLights);this._defines.SPECULARTERM&&u.addFallback(0,"SPECULARTERM");this._defines.DIFFUSEFRESNEL&&u.addFallback(1,"DIFFUSEFRESNEL");this._defines.OPACITYFRESNEL&&u.addFallback(2,"OPACITYFRESNEL");this._defines.REFLECTIONFRESNEL&&u.addFallback(3,"REFLECTIONFRESNEL");this._defines.EMISSIVEFRESNEL&&u.addFallback(4,"EMISSIVEFRESNEL");this._defines.FRESNEL&&u.addFallback(4,"FRESNEL");s=[n.VertexBuffer.PositionKind];this._defines.NORMAL&&s.push(n.VertexBuffer.NormalKind);this._defines.UV1&&s.push(n.VertexBuffer.UVKind);this._defines.UV2&&s.push(n.VertexBuffer.UV2Kind);this._defines.VERTEXCOLOR&&s.push(n.VertexBuffer.ColorKind);n.MaterialHelper.PrepareAttributesForBones(s,i,this._defines,u);n.MaterialHelper.PrepareAttributesForInstances(s,this._defines);var v=this._defines.toString(),c=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","depthValues","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","logarithmicDepthConstant"],l=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"];this._defines.CAMERACOLORCURVES&&n.ColorCurves.PrepareUniforms(c);this._defines.CAMERACOLORGRADING&&n.ColorGradingTexture.PrepareUniformsAndSamplers(c,l);n.MaterialHelper.PrepareUniformsAndSamplersList(c,l,this._defines,this.maxSimultaneousLights);this._effect=e.getEngine().createEffect("default",s,c,l,v,u,this.onCompiled,this.onError,{maxSimultaneousLights:this.maxSimultaneousLights-1})}return!!this._effect.isReady()&&(this._renderId=e.getRenderId(),this._wasPreviouslyReady=!0,i&&(i._materialDefines||(i._materialDefines=new t),this._defines.cloneTo(i._materialDefines)),!0)},f.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null);this.refractionTexture&&this.refractionTexture.isRenderTarget&&this._effect.setTexture("refraction2DSampler",null);i.prototype.unbind.call(this)},f.prototype.bindOnlyWorldMatrix=function(n){this._effect.setMatrix("world",n)},f.prototype.bind=function(t,r){var u=this.getScene(),e;(this.bindOnlyWorldMatrix(t),n.MaterialHelper.BindBonesParameters(r,this._effect),u.getCachedMaterial()!==this)&&((this._effect.setMatrix("viewProjection",u.getTransformMatrix()),f.FresnelEnabled&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(this._effect.setColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),this._effect.setColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&this._effect.setColor4("opacityParts",new n.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(this._effect.setColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),this._effect.setColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(this._effect.setColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),this._effect.setColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._effect.setColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),this._effect.setColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),u.texturesEnabled)&&((this.diffuseTexture&&f.DiffuseTextureEnabled&&(this._effect.setTexture("diffuseSampler",this.diffuseTexture),this._effect.setFloat2("vDiffuseInfos",this.diffuseTexture.coordinatesIndex,this.diffuseTexture.level),this._effect.setMatrix("diffuseMatrix",this.diffuseTexture.getTextureMatrix())),this.ambientTexture&&f.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat2("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level),this._effect.setMatrix("ambientMatrix",this.ambientTexture.getTextureMatrix())),this.opacityTexture&&f.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture.getTextureMatrix())),this.reflectionTexture&&f.ReflectionTextureEnabled&&(this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat2("vReflectionInfos",this.reflectionTexture.level,this.roughness)),this.emissiveTexture&&f.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture.getTextureMatrix())),this.lightmapTexture&&f.LightmapTextureEnabled&&(this._effect.setTexture("lightmapSampler",this.lightmapTexture),this._effect.setFloat2("vLightmapInfos",this.lightmapTexture.coordinatesIndex,this.lightmapTexture.level),this._effect.setMatrix("lightmapMatrix",this.lightmapTexture.getTextureMatrix())),this.specularTexture&&f.SpecularTextureEnabled&&(this._effect.setTexture("specularSampler",this.specularTexture),this._effect.setFloat2("vSpecularInfos",this.specularTexture.coordinatesIndex,this.specularTexture.level),this._effect.setMatrix("specularMatrix",this.specularTexture.getTextureMatrix())),this.bumpTexture&&u.getEngine().getCaps().standardDerivatives&&f.BumpTextureEnabled&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat3("vBumpInfos",this.bumpTexture.coordinatesIndex,1/this.bumpTexture.level,this.parallaxScaleBias),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix())),this.refractionTexture&&f.RefractionTextureEnabled)&&(e=1,this.refractionTexture.isCube?this._effect.setTexture("refractionCubeSampler",this.refractionTexture):(this._effect.setTexture("refraction2DSampler",this.refractionTexture),this._effect.setMatrix("refractionMatrix",this.refractionTexture.getReflectionTextureMatrix()),this.refractionTexture.depth&&(e=this.refractionTexture.depth)),this._effect.setFloat4("vRefractionInfos",this.refractionTexture.level,this.indexOfRefraction,e,this.invertRefractionY?-1:1)),this.cameraColorGradingTexture&&f.ColorGradingTextureEnabled&&n.ColorGradingTexture.Bind(this.cameraColorGradingTexture,this._effect)),n.MaterialHelper.BindClipPlane(this._effect,u),this.pointsCloud&&this._effect.setFloat("pointSize",this.pointSize),u.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),this._effect.setVector3("vEyePosition",u._mirroredCameraPosition?u._mirroredCameraPosition:u.activeCamera.position),this._effect.setColor3("vAmbientColor",this._globalAmbientColor),this._defines.SPECULARTERM&&this._effect.setColor4("vSpecularColor",this.specularColor,this.specularPower),this._effect.setColor3("vEmissiveColor",this.emissiveColor));u.getCachedMaterial()===this&&this.isFrozen||(this._effect.setColor4("vDiffuseColor",this.diffuseColor,this.alpha*r.visibility),u.lightsEnabled&&!this.disableLighting&&n.MaterialHelper.BindLights(u,r,this._effect,this._defines,this.maxSimultaneousLights),(u.fogEnabled&&r.applyFog&&u.fogMode!==n.Scene.FOGMODE_NONE||this.reflectionTexture||this.refractionTexture)&&this._effect.setMatrix("view",u.getViewMatrix()),n.MaterialHelper.BindFogParameters(u,r,this._effect),n.MaterialHelper.BindLogDepth(this._defines,this._effect,u),this.cameraColorCurves&&n.ColorCurves.Bind(this.cameraColorCurves,this._effect));i.prototype.bind.call(this,t,r)},f.prototype.getAnimatables=function(){var n=[];return this.diffuseTexture&&this.diffuseTexture.animations&&this.diffuseTexture.animations.length>0&&n.push(this.diffuseTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&n.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&n.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&n.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&n.push(this.emissiveTexture),this.specularTexture&&this.specularTexture.animations&&this.specularTexture.animations.length>0&&n.push(this.specularTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&n.push(this.bumpTexture),this.lightmapTexture&&this.lightmapTexture.animations&&this.lightmapTexture.animations.length>0&&n.push(this.lightmapTexture),this.refractionTexture&&this.refractionTexture.animations&&this.refractionTexture.animations.length>0&&n.push(this.refractionTexture),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.animations&&this.cameraColorGradingTexture.animations.length>0&&n.push(this.cameraColorGradingTexture),n},f.prototype.dispose=function(n,t){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.ambientTexture&&this.ambientTexture.dispose(),this.opacityTexture&&this.opacityTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),this.emissiveTexture&&this.emissiveTexture.dispose(),this.specularTexture&&this.specularTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),this.lightmapTexture&&this.lightmapTexture.dispose(),this.refractionTexture&&this.refractionTexture.dispose(),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.dispose());i.prototype.dispose.call(this,n,t)},f.prototype.clone=function(t){var i=this;return n.SerializationHelper.Clone(function(){return new f(t,i.getScene())},this)},f.prototype.serialize=function(){return n.SerializationHelper.Serialize(this)},f.Parse=function(t,i,r){return n.SerializationHelper.Parse(function(){return new f(t.name,i)},t,i,r)},f.DiffuseTextureEnabled=!0,f.AmbientTextureEnabled=!0,f.OpacityTextureEnabled=!0,f.ReflectionTextureEnabled=!0,f.EmissiveTextureEnabled=!0,f.SpecularTextureEnabled=!0,f.BumpTextureEnabled=!0,f.FresnelEnabled=!0,f.LightmapTextureEnabled=!0,f.RefractionTextureEnabled=!0,f.ColorGradingTextureEnabled=!0,r([n.serializeAsTexture()],f.prototype,"diffuseTexture",void 0),r([n.serializeAsTexture()],f.prototype,"ambientTexture",void 0),r([n.serializeAsTexture()],f.prototype,"opacityTexture",void 0),r([n.serializeAsTexture()],f.prototype,"reflectionTexture",void 0),r([n.serializeAsTexture()],f.prototype,"emissiveTexture",void 0),r([n.serializeAsTexture()],f.prototype,"specularTexture",void 0),r([n.serializeAsTexture()],f.prototype,"bumpTexture",void 0),r([n.serializeAsTexture()],f.prototype,"lightmapTexture",void 0),r([n.serializeAsTexture()],f.prototype,"refractionTexture",void 0),r([n.serializeAsColor3("ambient")],f.prototype,"ambientColor",void 0),r([n.serializeAsColor3("diffuse")],f.prototype,"diffuseColor",void 0),r([n.serializeAsColor3("specular")],f.prototype,"specularColor",void 0),r([n.serializeAsColor3("emissive")],f.prototype,"emissiveColor",void 0),r([n.serialize()],f.prototype,"specularPower",void 0),r([n.serialize()],f.prototype,"useAlphaFromDiffuseTexture",void 0),r([n.serialize()],f.prototype,"useEmissiveAsIllumination",void 0),r([n.serialize()],f.prototype,"linkEmissiveWithDiffuse",void 0),r([n.serialize()],f.prototype,"useReflectionFresnelFromSpecular",void 0),r([n.serialize()],f.prototype,"useSpecularOverAlpha",void 0),r([n.serialize()],f.prototype,"useReflectionOverAlpha",void 0),r([n.serialize()],f.prototype,"disableLighting",void 0),r([n.serialize()],f.prototype,"useParallax",void 0),r([n.serialize()],f.prototype,"useParallaxOcclusion",void 0),r([n.serialize()],f.prototype,"parallaxScaleBias",void 0),r([n.serialize()],f.prototype,"roughness",void 0),r([n.serialize()],f.prototype,"indexOfRefraction",void 0),r([n.serialize()],f.prototype,"invertRefractionY",void 0),r([n.serialize()],f.prototype,"useLightmapAsShadowmap",void 0),r([n.serializeAsFresnelParameters()],f.prototype,"diffuseFresnelParameters",void 0),r([n.serializeAsFresnelParameters()],f.prototype,"opacityFresnelParameters",void 0),r([n.serializeAsFresnelParameters()],f.prototype,"reflectionFresnelParameters",void 0),r([n.serializeAsFresnelParameters()],f.prototype,"refractionFresnelParameters",void 0),r([n.serializeAsFresnelParameters()],f.prototype,"emissiveFresnelParameters",void 0),r([n.serialize()],f.prototype,"useGlossinessFromSpecularMapAlpha",void 0),r([n.serialize()],f.prototype,"maxSimultaneousLights",void 0),r([n.serialize()],f.prototype,"invertNormalMapX",void 0),r([n.serialize()],f.prototype,"invertNormalMapY",void 0),r([n.serializeAsTexture()],f.prototype,"cameraColorGradingTexture",void 0),r([n.serializeAsColorCurves()],f.prototype,"cameraColorCurves",void 0),r([n.serialize()],f.prototype,"useLogarithmicDepth",null),f}(n.Material);n.StandardMaterial=i}(i||(i={}));!function(n){var t=function(t){function i(n,i){t.call(this,n,i,!0);this.subMaterials=[];i.multiMaterials.push(this)}return u(i,t),i.prototype.getSubMaterial=function(n){return n<0||n>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[n]},i.prototype.isReady=function(n){for(var i,t=0;t<this.subMaterials.length;t++)if(i=this.subMaterials[t],i&&!this.subMaterials[t].isReady(n))return!1;return!0},i.prototype.clone=function(n,t){for(var f,u=new i(n,this.getScene()),r=0;r<this.subMaterials.length;r++)f=null,f=t?this.subMaterials[r].clone(n+"-"+this.subMaterials[r].name):this.subMaterials[r],u.subMaterials.push(f);return u},i.prototype.serialize=function(){var t={},i,r;for(t.name=this.name,t.id=this.id,t.tags=n.Tags.GetTags(this),t.materials=[],i=0;i<this.subMaterials.length;i++)r=this.subMaterials[i],r?t.materials.push(r.id):t.materials.push(null);return t},i}(n.Material);n.MultiMaterial=t}(i||(i={}));!function(n){var t=function(){function t(){}return Object.defineProperty(t,"NO_LOGGING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MINIMAL_LOGGING",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(t,"SUMMARY_LOGGING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(t,"DETAILED_LOGGING",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ForceFullSceneLoadingForIncremental",{get:function(){return t._ForceFullSceneLoadingForIncremental},set:function(n){t._ForceFullSceneLoadingForIncremental=n},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ShowLoadingScreen",{get:function(){return t._ShowLoadingScreen},set:function(n){t._ShowLoadingScreen=n},enumerable:!0,configurable:!0}),Object.defineProperty(t,"loggingLevel",{get:function(){return t._loggingLevel},set:function(n){t._loggingLevel=n},enumerable:!0,configurable:!0}),t._getDefaultPlugin=function(){return t._registeredPlugins[".babylon"]},t._getPluginForExtension=function(n){var i=t._registeredPlugins[n];return i?i:t._getDefaultPlugin()},t._getPluginForFilename=function(n){var r,i,u;return n.name&&(n=n.name),r=n.lastIndexOf("."),i=n.indexOf("?"),i===-1&&(i=n.length),u=n.substring(r,i).toLowerCase(),t._getPluginForExtension(u)},t._getDirectLoad=function(n){return n.substr&&"data:"===n.substr(0,5)?n.substr(5):null},t.GetPluginForExtension=function(n){return t._getPluginForExtension(n).plugin},t.RegisterPlugin=function(n){var r,i;"string"==typeof n.extensions?(r=n.extensions,t._registeredPlugins[r.toLowerCase()]={plugin:n,isBinary:!1}):(i=n.extensions,Object.keys(i).forEach(function(r){t._registeredPlugins[r.toLowerCase()]={plugin:n,isBinary:i[r].isBinary}}))},t.ImportMesh=function(i,r,u,f,e,o,s){var c,h,l,a;if(u.substr&&"/"===u.substr(0,1)||u.substr&&"/"===u.substr(0,1))return void n.Tools.Error("Wrong sceneFilename parameter");c=t._getDirectLoad(u);h={};f._addPendingData(h);l=function(){f.database=a;var v=c?t._getDefaultPlugin():t._getPluginForFilename(u),l=v.plugin,p=v.isBinary,y=function(n){var t=[],o=[],c=[],a,v;try{if(l.importMesh){if(a=l,!a.importMesh(i,f,n,r,t,o,c))return s&&s(f,"Unable to import meshes from "+r+u),void f._removePendingData(h);e&&(f.importedMeshesFiles.push(r+u),e(t,o,c),f._removePendingData(h))}else v=l,v.importMeshAsync(i,f,n,r,function(n,t,i){e&&(f.importedMeshesFiles.push(r+u),e(n,t,i),f._removePendingData(h))},function(){s&&s(f,"Unable to import meshes from "+r+u);f._removePendingData(h)})}catch(y){s&&s(f,"Unable to import meshes from "+r+u,y);f._removePendingData(h)}};return c?void y(c):void n.Tools.LoadFile(r+u,function(n){y(n)},o,a,p)};f.getEngine().enableOfflineSupport&&!c?a=new n.Database(r+u,l):l(!0)},t.Load=function(i,r,u,f,e,o){t.Append(i,r,new n.Scene(u),f,e,o)},t.Append=function(i,r,u,f,e,o){var h,v;if(r.substr&&"/"===r.substr(0,1))return void n.Tools.Error("Wrong sceneFilename parameter");var c,l=t._getDirectLoad(r),y=l?t._getDefaultPlugin():t._getPluginForFilename(r),a=y.plugin,p=y.isBinary,s={};return u._addPendingData(s),t.ShowLoadingScreen&&u.getEngine().displayLoadingUI(),h=function(n){var r,e;if(u.database=c,a.load){if(r=a,!r.load(u,n,i))return o&&o(u),u._removePendingData(s),void u.getEngine().hideLoadingUI();f&&f(u);u._removePendingData(s)}else e=a,e.loadAsync(u,n,i,function(){f&&f(u);u._removePendingData(s)},function(){o&&o(u);u._removePendingData(s);u.getEngine().hideLoadingUI()});t.ShowLoadingScreen&&u.executeWhenReady(function(){u.getEngine().hideLoadingUI()})},v=function(){n.Tools.LoadFile(i+r,h,e,c,p)},l?void h(l):void(i.indexOf("file:")===-1?u.getEngine().enableOfflineSupport?c=new n.Database(i+r,v):v(!0):n.Tools.ReadFile(r,h,e,p))},t._ForceFullSceneLoadingForIncremental=!1,t._ShowLoadingScreen=!0,t._loggingLevel=t.NO_LOGGING,t._registeredPlugins={},t}();n.SceneLoader=t}(i||(i={}));!function(n){var t;!function(){var i=function(t,i,r,u){for(var e,f=0,o=i.materials.length;f<o;f++)if(e=i.materials[f],e.id===t)return n.Material.Parse(e,r,u);return null},r=function(n,t,i){t=t instanceof Array?t:[t];for(var r in t)if(n.name===t[r])return i.push(n.id),!0;return!(!n.parentId||i.indexOf(n.parentId)===-1)&&(i.push(n.id),!0)},t=function(n,t){return n+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown")};n.SceneLoader.RegisterPlugin({extensions:".babylon",importMesh:function(u,f,e,o,s,h,c){var y="importMesh has failed JSON parse",l,v,nt,tt,it,at,b,rt,vt,et,yt,d,pt,ut,wt,ft,ot,st,p,ht;try{l=JSON.parse(e);y="";for(var k=n.SceneLoader.loggingLevel===n.SceneLoader.DETAILED_LOGGING,ct=[],g=[],lt=[],a=0,w=l.meshes.length;a<w;a++)if(v=l.meshes[a],!u||r(v,u,lt)){if((u instanceof Array&&delete u[u.indexOf(v.name)],v.geometryId&&l.geometries)&&(nt=!1,["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(function(t){!nt&&l.geometries[t]&&l.geometries[t]instanceof Array&&l.geometries[t].forEach(function(i){if(i.id===v.geometryId){switch(t){case"boxes":n.Geometry.Primitives.Box.Parse(i,f);break;case"spheres":n.Geometry.Primitives.Sphere.Parse(i,f);break;case"cylinders":n.Geometry.Primitives.Cylinder.Parse(i,f);break;case"toruses":n.Geometry.Primitives.Torus.Parse(i,f);break;case"grounds":n.Geometry.Primitives.Ground.Parse(i,f);break;case"planes":n.Geometry.Primitives.Plane.Parse(i,f);break;case"torusKnots":n.Geometry.Primitives.TorusKnot.Parse(i,f);break;case"vertexData":n.Geometry.Parse(i,f,o)}nt=!0}})}),nt||n.Tools.Warn("Geometry not found for mesh "+v.id)),v.materialId){if(tt=g.indexOf(v.materialId)!==-1,!tt&&l.multiMaterials)for(it=0,at=l.multiMaterials.length;it<at;it++)if(b=l.multiMaterials[it],b.id===v.materialId){for(rt=0,vt=b.materials.length;rt<vt;rt++)et=b.materials[rt],g.push(et),d=i(et,l,f,o),y+="\n\tMaterial "+d.toString(k);g.push(b.id);yt=n.Material.ParseMultiMaterial(b,f);tt=!0;y+="\n\tMulti-Material "+yt.toString(k);break}tt||(g.push(v.materialId),d=i(v.materialId,l,f,o),d?y+="\n\tMaterial "+d.toString(k):n.Tools.Warn("Material not found for mesh "+v.id))}if(v.skeletonId>-1&&f.skeletons&&(pt=ct.indexOf(v.skeletonId)>-1,!pt))for(ut=0,wt=l.skeletons.length;ut<wt;ut++)ft=l.skeletons[ut],ft.id===v.skeletonId&&(ot=n.Skeleton.Parse(ft,f),c.push(ot),ct.push(ft.id),y+="\n\tSkeleton "+ot.toString(k));st=n.Mesh.Parse(v,f,o);s.push(st);y+="\n\tMesh "+st.toString(k)}for(a=0,w=f.meshes.length;a<w;a++)p=f.meshes[a],p._waitingParentId&&(p.parent=f.getLastEntryByID(p._waitingParentId),p._waitingParentId=void 0);for(a=0,w=f.meshes.length;a<w;a++)p=f.meshes[a],p._waitingFreezeWorldMatrix?(p.freezeWorldMatrix(),p._waitingFreezeWorldMatrix=void 0):p.computeWorldMatrix(!0);if(l.particleSystems)for(a=0,w=l.particleSystems.length;a<w;a++)ht=l.particleSystems[a],lt.indexOf(ht.emitterId)!==-1&&h.push(n.ParticleSystem.Parse(ht,f,o));return!0}catch(bt){throw n.Tools.Log(t("importMesh",l?l.producer:"Unknown")+y),y=null,bt;}finally{null!==y&&n.SceneLoader.loggingLevel!==n.SceneLoader.NO_LOGGING&&n.Tools.Log(t("importMesh",l?l.producer:"Unknown")+(n.SceneLoader.loggingLevel!==n.SceneLoader.MINIMAL_LOGGING?y:""))}},load:function(i,r,u){var s="importScene has failed JSON parse",e,a,ut,et,f,o,ot,st,ft,ht,ct,lt,at,vt,yt,c,b,pt,k,wt,d,bt,g,kt,nt,dt,tt,gt,it,ni,rt,ti,ii,ri,y,v,ui,p,l,h,w,fi,ei,oi;try{if(e=JSON.parse(r),s="",a=n.SceneLoader.loggingLevel===n.SceneLoader.DETAILED_LOGGING,i.useDelayedTextureLoading=e.useDelayedTextureLoading&&!n.SceneLoader.ForceFullSceneLoadingForIncremental,i.autoClear=e.autoClear,i.clearColor=n.Color4.FromArray(e.clearColor),i.ambientColor=n.Color3.FromArray(e.ambientColor),e.gravity&&(i.gravity=n.Vector3.FromArray(e.gravity)),e.fogMode&&0!==e.fogMode)switch(i.fogMode=e.fogMode,i.fogColor=n.Color3.FromArray(e.fogColor),i.fogStart=e.fogStart,i.fogEnd=e.fogEnd,i.fogDensity=e.fogDensity,s+="\tFog mode for scene:  ",i.fogMode){case 1:s+="exp\n";break;case 2:s+="exp2\n";break;case 3:s+="linear\n"}for(e.physicsEnabled&&("cannon"===e.physicsEngine?ut=new n.CannonJSPlugin:"oimo"===e.physicsEngine&&(ut=new n.OimoJSPlugin),s="\tPhysics engine "+(e.physicsEngine?e.physicsEngine:"oimo")+" enabled\n",et=e.physicsGravity?n.Vector3.FromArray(e.physicsGravity):null,i.enablePhysics(et,ut)),void 0!==e.metadata&&(i.metadata=e.metadata),void 0!=e.collisionsEnabled&&(i.collisionsEnabled=e.collisionsEnabled),i.workerCollisions=!!e.workerCollisions,f=0,o=e.lights.length;f<o;f++)ot=e.lights[f],v=n.Light.Parse(ot,i),s+=0===f?"\n\tLights:":"",s+="\n\t\t"+v.toString(a);if(e.animations)for(f=0,o=e.animations.length;f<o;f++)st=e.animations[f],ft=n.Animation.Parse(st),i.animations.push(ft),s+=0===f?"\n\tAnimations:":"",s+="\n\t\t"+ft.toString(a);if(e.autoAnimate&&i.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.materials)for(f=0,o=e.materials.length;f<o;f++)ht=e.materials[f],ct=n.Material.Parse(ht,i,u),s+=0===f?"\n\tMaterials:":"",s+="\n\t\t"+ct.toString(a);if(e.multiMaterials)for(f=0,o=e.multiMaterials.length;f<o;f++)lt=e.multiMaterials[f],at=n.Material.ParseMultiMaterial(lt,i),s+=0===f?"\n\tMultiMaterials:":"",s+="\n\t\t"+at.toString(a);if(e.skeletons)for(f=0,o=e.skeletons.length;f<o;f++)vt=e.skeletons[f],yt=n.Skeleton.Parse(vt,i),s+=0===f?"\n\tSkeletons:":"",s+="\n\t\t"+yt.toString(a);if(c=e.geometries,c){if(b=c.boxes,b)for(f=0,o=b.length;f<o;f++)pt=b[f],n.Geometry.Primitives.Box.Parse(pt,i);if(k=c.spheres,k)for(f=0,o=k.length;f<o;f++)wt=k[f],n.Geometry.Primitives.Sphere.Parse(wt,i);if(d=c.cylinders,d)for(f=0,o=d.length;f<o;f++)bt=d[f],n.Geometry.Primitives.Cylinder.Parse(bt,i);if(g=c.toruses,g)for(f=0,o=g.length;f<o;f++)kt=g[f],n.Geometry.Primitives.Torus.Parse(kt,i);if(nt=c.grounds,nt)for(f=0,o=nt.length;f<o;f++)dt=nt[f],n.Geometry.Primitives.Ground.Parse(dt,i);if(tt=c.planes,tt)for(f=0,o=tt.length;f<o;f++)gt=tt[f],n.Geometry.Primitives.Plane.Parse(gt,i);if(it=c.torusKnots,it)for(f=0,o=it.length;f<o;f++)ni=it[f],n.Geometry.Primitives.TorusKnot.Parse(ni,i);if(rt=c.vertexData,rt)for(f=0,o=rt.length;f<o;f++)ti=rt[f],n.Geometry.Parse(ti,i,u)}for(f=0,o=e.meshes.length;f<o;f++)ii=e.meshes[f],h=n.Mesh.Parse(ii,i,u),s+=0===f?"\n\tMeshes:":"",s+="\n\t\t"+h.toString(a);for(f=0,o=e.cameras.length;f<o;f++)ri=e.cameras[f],y=n.Camera.Parse(ri,i),s+=0===f?"\n\tCameras:":"",s+="\n\t\t"+y.toString(a);for(e.activeCameraID&&i.setActiveCameraByID(e.activeCameraID),f=0,o=i.cameras.length;f<o;f++)y=i.cameras[f],y._waitingParentId&&(y.parent=i.getLastEntryByID(y._waitingParentId),y._waitingParentId=void 0);for(f=0,o=i.lights.length;f<o;f++)v=i.lights[f],v._waitingParentId&&(v.parent=i.getLastEntryByID(v._waitingParentId),v._waitingParentId=void 0);if(p=[],n.AudioEngine&&e.sounds)for(f=0,o=e.sounds.length;f<o;f++)l=e.sounds[f],n.Engine.audioEngine.canUseWebAudio?(l.url||(l.url=l.name),p[l.url]?n.Sound.Parse(l,i,u,p[l.url]):(ui=n.Sound.Parse(l,i,u),p[l.url]=ui)):new n.Sound(l.name,null,i);for(p=[],f=0,o=i.meshes.length;f<o;f++)h=i.meshes[f],h._waitingParentId&&(h.parent=i.getLastEntryByID(h._waitingParentId),h._waitingParentId=void 0),h._waitingActions&&(n.ActionManager.Parse(h._waitingActions,h,i),h._waitingActions=void 0);for(f=0,o=i.meshes.length;f<o;f++)w=i.meshes[f],w._waitingFreezeWorldMatrix?(w.freezeWorldMatrix(),w._waitingFreezeWorldMatrix=void 0):w.computeWorldMatrix(!0);if(e.particleSystems)for(f=0,o=e.particleSystems.length;f<o;f++)fi=e.particleSystems[f],n.ParticleSystem.Parse(fi,i,u);if(e.lensFlareSystems)for(f=0,o=e.lensFlareSystems.length;f<o;f++)ei=e.lensFlareSystems[f],n.LensFlareSystem.Parse(ei,i,u);if(e.shadowGenerators)for(f=0,o=e.shadowGenerators.length;f<o;f++)oi=e.shadowGenerators[f],n.ShadowGenerator.Parse(oi,i);return e.actions&&n.ActionManager.Parse(e.actions,null,i),!0}catch(si){throw n.Tools.Log(t("importScene",e?e.producer:"Unknown")+s),s=null,si;}finally{null!==s&&n.SceneLoader.loggingLevel!==n.SceneLoader.NO_LOGGING&&n.Tools.Log(t("importScene",e?e.producer:"Unknown")+(n.SceneLoader.loggingLevel!==n.SceneLoader.MINIMAL_LOGGING?s:""))}}})}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f,e,o){if(void 0===e&&(e=.01),void 0===o&&(o=n.Texture.TRILINEAR_SAMPLINGMODE),this.name=t,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.fogEnabled=!0,this.isPickable=!1,this.onDisposeObservable=new n.Observable,this._vertexBuffers={},this._capacity=r,this._spriteTexture=new n.Texture(i,f,!0,!1,o),this._spriteTexture.wrapU=n.Texture.CLAMP_ADDRESSMODE,this._spriteTexture.wrapV=n.Texture.CLAMP_ADDRESSMODE,u.width&&u.height)this.cellWidth=u.width,this.cellHeight=u.height;else{if(void 0===u)return;this.cellWidth=u;this.cellHeight=u}this._epsilon=e;this._scene=f;this._scene.spriteManagers.push(this);for(var s=[],h=0,c=0;c<r;c++)s.push(h),s.push(h+1),s.push(h+2),s.push(h),s.push(h+2),s.push(h+3),h+=4;this._indexBuffer=f.getEngine().createIndexBuffer(s);this._vertexData=new Float32Array(64*r);this._buffer=new n.Buffer(f.getEngine(),this._vertexData,!0,16);var l=this._buffer.createVertexBuffer(n.VertexBuffer.PositionKind,0,4),a=this._buffer.createVertexBuffer("options",4,4),v=this._buffer.createVertexBuffer("cellInfo",8,4),y=this._buffer.createVertexBuffer(n.VertexBuffer.ColorKind,12,4);this._vertexBuffers[n.VertexBuffer.PositionKind]=l;this._vertexBuffers.options=a;this._vertexBuffers.cellInfo=v;this._vertexBuffers[n.VertexBuffer.ColorKind]=y;this._effectBase=this._scene.getEngine().createEffect("sprites",[n.VertexBuffer.PositionKind,"options","cellInfo",n.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest"],["diffuseSampler"],"");this._effectFog=this._scene.getEngine().createEffect("sprites",[n.VertexBuffer.PositionKind,"options","cellInfo",n.VertexBuffer.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor"],["diffuseSampler"],"#define FOG")}return Object.defineProperty(t.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"texture",{get:function(){return this._spriteTexture},set:function(n){this._spriteTexture=n},enumerable:!0,configurable:!0}),t.prototype._appendSpriteVertex=function(n,t,i,r,u){var f=16*n,e;0===i?i=this._epsilon:1===i&&(i=1-this._epsilon);0===r?r=this._epsilon:1===r&&(r=1-this._epsilon);this._vertexData[f]=t.position.x;this._vertexData[f+1]=t.position.y;this._vertexData[f+2]=t.position.z;this._vertexData[f+3]=t.angle;this._vertexData[f+4]=t.width;this._vertexData[f+5]=t.height;this._vertexData[f+6]=i;this._vertexData[f+7]=r;this._vertexData[f+8]=t.invertU?1:0;this._vertexData[f+9]=t.invertV?1:0;e=t.cellIndex/u>>0;this._vertexData[f+10]=t.cellIndex-e*u;this._vertexData[f+11]=e;this._vertexData[f+12]=t.color.r;this._vertexData[f+13]=t.color.g;this._vertexData[f+14]=t.color.b;this._vertexData[f+15]=t.color.a},t.prototype.intersects=function(t,i,r,u){for(var f,l,o,s,y=Math.min(this._capacity,this.sprites.length),a=n.Vector3.Zero(),v=n.Vector3.Zero(),h=Number.MAX_VALUE,e=n.Vector3.Zero(),p=i.getViewMatrix(),c=0;c<y;c++)if(f=this.sprites[c],f){if(r){if(!r(f))continue}else if(!f.isPickable)continue;if((n.Vector3.TransformCoordinatesToRef(f.position,p,e),a.copyFromFloats(e.x-f.width/2,e.y-f.height/2,e.z),v.copyFromFloats(e.x+f.width/2,e.y+f.height/2,e.z),t.intersectsBoxMinMax(a,v))&&(l=n.Vector3.Distance(e,t.origin),h>l&&(h=l,s=f,u)))break}return s?(o=new n.PickingInfo,o.hit=!0,o.pickedSprite=s,o.distance=h,o):null},t.prototype.render=function(){var r,t,h;if(this._effectBase.isReady()&&this._effectFog.isReady()&&this._spriteTexture&&this._spriteTexture.isReady()){for(var i=this._scene.getEngine(),e=this._spriteTexture.getBaseSize(),c=i.getDeltaTime(),o=Math.min(this._capacity,this.sprites.length),u=e.width/this.cellWidth,f=0,s=0;s<o;s++)r=this.sprites[s],r&&(r._animate(c),this._appendSpriteVertex(f++,r,0,0,u),this._appendSpriteVertex(f++,r,1,0,u),this._appendSpriteVertex(f++,r,1,1,u),this._appendSpriteVertex(f++,r,0,1,u));this._buffer.update(this._vertexData);t=this._effectBase;this._scene.fogEnabled&&this._scene.fogMode!==n.Scene.FOGMODE_NONE&&this.fogEnabled&&(t=this._effectFog);i.enableEffect(t);h=this._scene.getViewMatrix();t.setTexture("diffuseSampler",this._spriteTexture);t.setMatrix("view",h);t.setMatrix("projection",this._scene.getProjectionMatrix());t.setFloat2("textureInfos",this.cellWidth/e.width,this.cellHeight/e.height);this._scene.fogEnabled&&this._scene.fogMode!==n.Scene.FOGMODE_NONE&&this.fogEnabled&&(t.setFloat4("vFogInfos",this._scene.fogMode,this._scene.fogStart,this._scene.fogEnd,this._scene.fogDensity),t.setColor3("vFogColor",this._scene.fogColor));i.bindBuffers(this._vertexBuffers,this._indexBuffer,t);i.setDepthFunctionToLessOrEqual();t.setBool("alphaTest",!0);i.setColorWrite(!1);i.draw(!0,0,6*o);i.setColorWrite(!0);t.setBool("alphaTest",!1);i.setAlphaMode(n.Engine.ALPHA_COMBINE);i.draw(!0,0,6*o);i.setAlphaMode(n.Engine.ALPHA_DISABLE)}},t.prototype.dispose=function(){this._buffer&&(this._buffer.dispose(),this._buffer=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this._spriteTexture&&(this._spriteTexture.dispose(),this._spriteTexture=null);var n=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(n,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()},t}();n.SpriteManager=t}(i||(i={}));!function(n){var t=function(){function t(t,i){this.name=t;this.color=new n.Color4(1,1,1,1);this.width=1;this.height=1;this.angle=0;this.cellIndex=0;this.invertU=0;this.invertV=0;this.animations=[];this.isPickable=!1;this._animationStarted=!1;this._loopAnimation=!1;this._fromIndex=0;this._toIndex=0;this._delay=0;this._direction=1;this._frameCount=0;this._time=0;this._manager=i;this._manager.sprites.push(this);this.position=n.Vector3.Zero()}return Object.defineProperty(t.prototype,"size",{get:function(){return this.width},set:function(n){this.width=n;this.height=n},enumerable:!0,configurable:!0}),t.prototype.playAnimation=function(n,t,i,r,u){this._fromIndex=n;this._toIndex=t;this._loopAnimation=i;this._delay=r;this._animationStarted=!0;this._direction=n<t?1:-1;this.cellIndex=n;this._time=0;this._onAnimationEnd=u},t.prototype.stopAnimation=function(){this._animationStarted=!1},t.prototype._animate=function(n){this._animationStarted&&(this._time+=n,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,this.cellIndex===this._toIndex&&(this._loopAnimation?this.cellIndex=this._fromIndex:(this._animationStarted=!1,this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()))))},t.prototype.dispose=function(){for(var n=0;n<this._manager.sprites.length;n++)this._manager.sprites[n]==this&&this._manager.sprites.splice(n,1)},t}();n.Sprite=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f){var s,o,h,e;this.name=t;this.scale=new n.Vector2(1,1);this.offset=new n.Vector2(0,0);this.alphaBlendingMode=n.Engine.ALPHA_COMBINE;this._vertexBuffers={};this.onDisposeObservable=new n.Observable;this.onBeforeRenderObservable=new n.Observable;this.onAfterRenderObservable=new n.Observable;this.texture=i?new n.Texture(i,r,!0):null;this.isBackground=void 0===u||u;this.color=void 0===f?new n.Color4(1,1,1,1):f;this._scene=r;this._scene.layers.push(this);s=r.getEngine();o=[];o.push(1,1);o.push(-1,1);o.push(-1,-1);o.push(1,-1);h=new n.VertexBuffer(s,o,n.VertexBuffer.PositionKind,!1,!1,2);this._vertexBuffers[n.VertexBuffer.PositionKind]=h;e=[];e.push(0);e.push(1);e.push(2);e.push(0);e.push(2);e.push(3);this._indexBuffer=s.createIndexBuffer(e);this._effect=s.createEffect("layer",[n.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],"");this._alphaTestEffect=s.createEffect("layer",[n.VertexBuffer.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],"#define ALPHATEST")}return Object.defineProperty(t.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeRender",{set:function(n){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver);this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onAfterRender",{set:function(n){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver);this._onAfterRenderObserver=this.onAfterRenderObservable.add(n)},enumerable:!0,configurable:!0}),t.prototype.render=function(){var t=this.alphaTest?this._alphaTestEffect:this._effect,i;t.isReady()&&this.texture&&this.texture.isReady()&&(i=this._scene.getEngine(),this.onBeforeRenderObservable.notifyObservers(this),i.enableEffect(t),i.setState(!1),t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix()),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),i.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?i.draw(!0,0,6):(i.setAlphaMode(this.alphaBlendingMode),i.draw(!0,0,6),i.setAlphaMode(n.Engine.ALPHA_DISABLE)),this.onAfterRenderObservable.notifyObservers(this))},t.prototype.dispose=function(){var t=this._vertexBuffers[n.VertexBuffer.PositionKind],i;t&&(t.dispose(),this._vertexBuffers[n.VertexBuffer.PositionKind]=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.texture&&(this.texture.dispose(),this.texture=null);i=this._scene.layers.indexOf(this);this._scene.layers.splice(i,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onAfterRenderObservable.clear();this.onBeforeRenderObservable.clear()},t}();n.Layer=t}(i||(i={}));!function(n){var t=function(){function t(){this.position=n.Vector3.Zero();this.direction=n.Vector3.Zero();this.color=new n.Color4(0,0,0,0);this.colorStep=new n.Color4(0,0,0,0);this.lifeTime=1;this.age=0;this.size=0;this.angle=0;this.angularSpeed=0}return t.prototype.copyTo=function(n){n.position.copyFrom(this.position);n.direction.copyFrom(this.direction);n.color.copyFrom(this.color);n.colorStep.copyFrom(this.colorStep);n.lifeTime=this.lifeTime;n.age=this.age;n.size=this.size;n.angle=this.angle;n.angularSpeed=this.angularSpeed},t}();n.Particle=t}(i||(i={}));!function(n){var t=function(n,t){if(n===t)return n;var i=Math.random();return i*(t-n)+n},i=function(){function i(r,u,f,e){var o=this;this.name=r;this.animations=[];this.renderingGroupId=0;this.emitter=null;this.emitRate=10;this.manualEmitCount=-1;this.updateSpeed=.01;this.targetStopDuration=0;this.disposeOnStop=!1;this.minEmitPower=1;this.maxEmitPower=1;this.minLifeTime=1;this.maxLifeTime=1;this.minSize=1;this.maxSize=1;this.minAngularSpeed=0;this.maxAngularSpeed=0;this.layerMask=268435455;this.onDisposeObservable=new n.Observable;this.blendMode=i.BLENDMODE_ONEONE;this.forceDepthWrite=!1;this.gravity=n.Vector3.Zero();this.direction1=new n.Vector3(0,1,0);this.direction2=new n.Vector3(0,1,0);this.minEmitBox=new n.Vector3(-.5,-.5,-.5);this.maxEmitBox=new n.Vector3(.5,.5,.5);this.color1=new n.Color4(1,1,1,1);this.color2=new n.Color4(1,1,1,1);this.colorDead=new n.Color4(0,0,0,1);this.textureMask=new n.Color4(1,1,1,1);this.particles=[];this._stockParticles=[];this._newPartsExcess=0;this._vertexBuffers={};this._scaledColorStep=new n.Color4(0,0,0,0);this._colorDiff=new n.Color4(0,0,0,0);this._scaledDirection=n.Vector3.Zero();this._scaledGravity=n.Vector3.Zero();this._currentRenderId=-1;this._started=!1;this._stopped=!1;this._actualFrame=0;this.id=r;this._capacity=u;this._scene=f;this._customEffect=e;f.particleSystems.push(this);for(var s=[],h=0,c=0;c<u;c++)s.push(h),s.push(h+1),s.push(h+2),s.push(h),s.push(h+2),s.push(h+3),h+=4;this._indexBuffer=f.getEngine().createIndexBuffer(s);this._vertexData=new Float32Array(44*u);this._vertexBuffer=new n.Buffer(f.getEngine(),this._vertexData,!0,11);var l=this._vertexBuffer.createVertexBuffer(n.VertexBuffer.PositionKind,0,3),a=this._vertexBuffer.createVertexBuffer(n.VertexBuffer.ColorKind,3,4),v=this._vertexBuffer.createVertexBuffer("options",7,4);this._vertexBuffers[n.VertexBuffer.PositionKind]=l;this._vertexBuffers[n.VertexBuffer.ColorKind]=a;this._vertexBuffers.options=v;this.startDirectionFunction=function(i,r,u){var f=t(o.direction1.x,o.direction2.x),e=t(o.direction1.y,o.direction2.y),s=t(o.direction1.z,o.direction2.z);n.Vector3.TransformNormalFromFloatsToRef(f*i,e*i,s*i,r,u)};this.startPositionFunction=function(i,r){var u=t(o.minEmitBox.x,o.maxEmitBox.x),f=t(o.minEmitBox.y,o.maxEmitBox.y),e=t(o.minEmitBox.z,o.maxEmitBox.z);n.Vector3.TransformCoordinatesFromFloatsToRef(u,f,e,i,r)};this.updateFunction=function(n){for(var t,i=0;i<n.length;i++)t=n[i],t.age+=o._scaledUpdateSpeed,t.age>=t.lifeTime?(o.recycleParticle(t),i--):(t.colorStep.scaleToRef(o._scaledUpdateSpeed,o._scaledColorStep),t.color.addInPlace(o._scaledColorStep),t.color.a<0&&(t.color.a=0),t.angle+=t.angularSpeed*o._scaledUpdateSpeed,t.direction.scaleToRef(o._scaledUpdateSpeed,o._scaledDirection),t.position.addInPlace(o._scaledDirection),o.gravity.scaleToRef(o._scaledUpdateSpeed,o._scaledGravity),t.direction.addInPlace(o._scaledGravity))}}return Object.defineProperty(i.prototype,"onDispose",{set:function(n){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver);this._onDisposeObserver=this.onDisposeObservable.add(n)},enumerable:!0,configurable:!0}),i.prototype.recycleParticle=function(n){var t=this.particles.pop();t!==n&&(t.copyTo(n),this._stockParticles.push(t))},i.prototype.getCapacity=function(){return this._capacity},i.prototype.isAlive=function(){return this._alive},i.prototype.isStarted=function(){return this._started},i.prototype.start=function(){this._started=!0;this._stopped=!1;this._actualFrame=0},i.prototype.stop=function(){this._stopped=!0},i.prototype._appendParticleVertex=function(n,t,i,r){var u=11*n;this._vertexData[u]=t.position.x;this._vertexData[u+1]=t.position.y;this._vertexData[u+2]=t.position.z;this._vertexData[u+3]=t.color.r;this._vertexData[u+4]=t.color.g;this._vertexData[u+5]=t.color.b;this._vertexData[u+6]=t.color.a;this._vertexData[u+7]=t.angle;this._vertexData[u+8]=t.size;this._vertexData[u+9]=i;this._vertexData[u+10]=r},i.prototype._update=function(i){var u,r,f,e,o;for(this._alive=this.particles.length>0,this.updateFunction(this.particles),u=this.emitter.position?this.emitter.getWorldMatrix():n.Matrix.Translation(this.emitter.x,this.emitter.y,this.emitter.z),f=0;f<i&&this.particles.length!==this._capacity;f++)0!==this._stockParticles.length?(r=this._stockParticles.pop(),r.age=0):r=new n.Particle,this.particles.push(r),e=t(this.minEmitPower,this.maxEmitPower),this.startDirectionFunction(e,u,r.direction,r),r.lifeTime=t(this.minLifeTime,this.maxLifeTime),r.size=t(this.minSize,this.maxSize),r.angularSpeed=t(this.minAngularSpeed,this.maxAngularSpeed),this.startPositionFunction(u,r.position,r),o=t(0,1),n.Color4.LerpToRef(this.color1,this.color2,o,r.color),this.colorDead.subtractToRef(r.color,this._colorDiff),this._colorDiff.scaleToRef(1/r.lifeTime,r.colorStep)},i.prototype._getEffect=function(){var i,t;return this._customEffect?this._customEffect:(i=[],this._scene.clipPlane&&i.push("#define CLIPPLANE"),t=i.join("\n"),this._cachedDefines!==t&&(this._cachedDefines=t,this._effect=this._scene.getEngine().createEffect("particles",[n.VertexBuffer.PositionKind,n.VertexBuffer.ColorKind,"options"],["invView","view","projection","vClipPlane","textureMask"],["diffuseSampler"],t)),this._effect)},i.prototype.animate=function(){var u,n,t,r,i;if(this._started&&(u=this._getEffect(),this.emitter&&u.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this._currentRenderId!==this._scene.getRenderId())){for(this._currentRenderId=this._scene.getRenderId(),this._scaledUpdateSpeed=this.updateSpeed*this._scene.getAnimationRatio(),this.manualEmitCount>-1?(n=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0):(n=this.emitRate*this._scaledUpdateSpeed>>0,this._newPartsExcess+=this.emitRate*this._scaledUpdateSpeed-n),this._newPartsExcess>1&&(n+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?n=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(n),this._stopped&&(this._alive||(this._started=!1,this.disposeOnStop&&this._scene._toBeDisposed.push(this))),t=0,r=0;r<this.particles.length;r++)i=this.particles[r],this._appendParticleVertex(t++,i,0,0),this._appendParticleVertex(t++,i,1,0),this._appendParticleVertex(t++,i,1,1),this._appendParticleVertex(t++,i,0,1);this._vertexBuffer.update(this._vertexData)}},i.prototype.render=function(){var t=this._getEffect(),r,f,u,e;return(this.emitter&&t.isReady()&&this.particleTexture&&this.particleTexture.isReady()&&this.particles.length)?(r=this._scene.getEngine(),r.enableEffect(t),r.setState(!1),f=this._scene.getViewMatrix(),(t.setTexture("diffuseSampler",this.particleTexture),t.setMatrix("view",f),t.setMatrix("projection",this._scene.getProjectionMatrix()),t.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._scene.clipPlane)&&(u=this._scene.clipPlane,e=f.clone(),e.invert(),t.setMatrix("invView",e),t.setFloat4("vClipPlane",u.normal.x,u.normal.y,u.normal.z,u.d)),r.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.blendMode===i.BLENDMODE_ONEONE?r.setAlphaMode(n.Engine.ALPHA_ONEONE):r.setAlphaMode(n.Engine.ALPHA_COMBINE),this.forceDepthWrite&&r.setDepthWrite(!0),r.draw(!0,0,6*this.particles.length),r.setAlphaMode(n.Engine.ALPHA_DISABLE),this.particles.length):0},i.prototype.dispose=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null);var n=this._scene.particleSystems.indexOf(this);this._scene.particleSystems.splice(n,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()},i.prototype.clone=function(t,r){var u=new i(t,this._capacity,this._scene);return n.Tools.DeepCopy(this,u,["particles"]),void 0===r&&(r=this.emitter),u.emitter=r,this.particleTexture&&(u.particleTexture=new n.Texture(this.particleTexture.url,this._scene)),u.start(),u},i.prototype.serialize=function(){var t={};return t.name=this.name,t.id=this.id,this.emitter.position?t.emitterId=this.emitter.id:t.emitter=this.emitter.asArray(),t.capacity=this.getCapacity(),this.particleTexture&&(t.textureName=this.particleTexture.name),n.Animation.AppendSerializedAnimations(this,t),t.minAngularSpeed=this.minAngularSpeed,t.maxAngularSpeed=this.maxAngularSpeed,t.minSize=this.minSize,t.maxSize=this.maxSize,t.minEmitPower=this.minEmitPower,t.maxEmitPower=this.maxEmitPower,t.minLifeTime=this.minLifeTime,t.maxLifeTime=this.maxLifeTime,t.emitRate=this.emitRate,t.minEmitBox=this.minEmitBox.asArray(),t.maxEmitBox=this.maxEmitBox.asArray(),t.gravity=this.gravity.asArray(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.color1=this.color1.asArray(),t.color2=this.color2.asArray(),t.colorDead=this.colorDead.asArray(),t.updateSpeed=this.updateSpeed,t.targetStopDuration=this.targetStopDuration,t.textureMask=this.textureMask.asArray(),t.blendMode=this.blendMode,t},i.Parse=function(t,r,u){var s=t.name,f=new i(s,t.capacity,r),e,o;if(t.id&&(f.id=t.id),t.textureName&&(f.particleTexture=new n.Texture(u+t.textureName,r),f.particleTexture.name=t.textureName),f.emitter=t.emitterId?r.getLastMeshByID(t.emitterId):n.Vector3.FromArray(t.emitter),t.animations)for(e=0;e<t.animations.length;e++)o=t.animations[e],f.animations.push(n.Animation.Parse(o));return t.autoAnimate&&r.beginAnimation(f,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),f.minAngularSpeed=t.minAngularSpeed,f.maxAngularSpeed=t.maxAngularSpeed,f.minSize=t.minSize,f.maxSize=t.maxSize,f.minLifeTime=t.minLifeTime,f.maxLifeTime=t.maxLifeTime,f.minEmitPower=t.minEmitPower,f.maxEmitPower=t.maxEmitPower,f.emitRate=t.emitRate,f.minEmitBox=n.Vector3.FromArray(t.minEmitBox),f.maxEmitBox=n.Vector3.FromArray(t.maxEmitBox),f.gravity=n.Vector3.FromArray(t.gravity),f.direction1=n.Vector3.FromArray(t.direction1),f.direction2=n.Vector3.FromArray(t.direction2),f.color1=n.Color4.FromArray(t.color1),f.color2=n.Color4.FromArray(t.color2),f.colorDead=n.Color4.FromArray(t.colorDead),f.updateSpeed=t.updateSpeed,f.targetStopDuration=t.targetStopDuration,f.textureMask=n.Color4.FromArray(t.textureMask),f.blendMode=t.blendMode,t.preventAutoStart||f.start(),f},i.BLENDMODE_ONEONE=0,i.BLENDMODE_STANDARD=1,i}();n.ParticleSystem=i}(i||(i={}));!function(n){var t=function(){function n(n,t,i){this.name=n;this.from=t;this.to=i}return n.prototype.clone=function(){return new n(this.name,this.from,this.to)},n}(),i,r,u;n.AnimationRange=t;i=function(){function n(n,t,i){this.frame=n;this.action=t;this.onlyOnce=i;this.isDone=!1}return n}();n.AnimationEvent=i;r=function(){function t(n){this.path=n;this._onchange=[];this.value=0;this.animations=[]}return t.prototype.getPoint=function(){var t=this.path.getPointAtLengthPosition(this.value);return new n.Vector3(t.x,0,t.y)},t.prototype.moveAhead=function(n){return void 0===n&&(n=.002),this.move(n),this},t.prototype.moveBack=function(n){return void 0===n&&(n=.002),this.move(-n),this},t.prototype.move=function(n){if(Math.abs(n)>1)throw"step size should be less than 1.";return this.value+=n,this.ensureLimits(),this.raiseOnChange(),this},t.prototype.ensureLimits=function(){for(;this.value>1;)this.value-=1;for(;this.value<0;)this.value+=1;return this},t.prototype.markAsDirty=function(){return this.ensureLimits(),this.raiseOnChange(),this},t.prototype.raiseOnChange=function(){var n=this;return this._onchange.forEach(function(t){return t(n)}),this},t.prototype.onchange=function(n){return this._onchange.push(n),this},t}();n.PathCursor=r;u=function(){function i(n,t,r,u,f,e){this.name=n;this.targetProperty=t;this.framePerSecond=r;this.dataType=u;this.loopMode=f;this.enableBlending=e;this._offsetsCache={};this._highLimitsCache={};this._stopped=!1;this._blendingFactor=0;this._events=[];this.allowMatricesInterpolation=!1;this.blendingSpeed=.01;this._ranges={};this.targetPropertyPath=t.split(".");this.dataType=u;this.loopMode=void 0===f?i.ANIMATIONLOOPMODE_CYCLE:f}return i._PrepareAnimation=function(t,r,u,f,e,o,s,h){var c=void 0,l,a;return(!isNaN(parseFloat(e))&&isFinite(e)?c=i.ANIMATIONTYPE_FLOAT:e instanceof n.Quaternion?c=i.ANIMATIONTYPE_QUATERNION:e instanceof n.Vector3?c=i.ANIMATIONTYPE_VECTOR3:e instanceof n.Vector2?c=i.ANIMATIONTYPE_VECTOR2:e instanceof n.Color3?c=i.ANIMATIONTYPE_COLOR3:e instanceof n.Size&&(c=i.ANIMATIONTYPE_SIZE),void 0==c)?null:(l=new i(t,r,u,c,s),a=[{frame:0,value:e},{frame:f,value:o}],l.setKeys(a),void 0!==h&&l.setEasingFunction(h),l)},i.CreateAndStartAnimation=function(n,t,r,u,f,e,o,s,h,c){var l=i._PrepareAnimation(n,r,u,f,e,o,s,h);return t.getScene().beginDirectAnimation(t,[l],0,f,1===l.loopMode,1,c)},i.CreateMergeAndStartAnimation=function(n,t,r,u,f,e,o,s,h,c){var l=i._PrepareAnimation(n,r,u,f,e,o,s,h);return t.animations.push(l),t.getScene().beginAnimation(t,0,f,1===l.loopMode,1,c)},i.prototype.toString=function(n){var t="Name: "+this.name+", property: "+this.targetProperty,i,r;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),n){t+=", Ranges: {";i=!0;for(r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t},i.prototype.addEvent=function(n){this._events.push(n)},i.prototype.removeEvents=function(n){for(var t=0;t<this._events.length;t++)this._events[t].frame===n&&(this._events.splice(t,1),t--)},i.prototype.createRange=function(n,i,r){this._ranges[n]||(this._ranges[n]=new t(n,i,r))},i.prototype.deleteRange=function(n,t){if(void 0===t&&(t=!0),this._ranges[n]){if(t)for(var r=this._ranges[n].from,u=this._ranges[n].to,i=this._keys.length-1;i>=0;i--)this._keys[i].frame>=r&&this._keys[i].frame<=u&&this._keys.splice(i,1);this._ranges[n]=void 0}},i.prototype.getRange=function(n){return this._ranges[n]},i.prototype.reset=function(){this._offsetsCache={};this._highLimitsCache={};this.currentFrame=0;this._blendingFactor=0;this._originalBlendValue=null},i.prototype.isStopped=function(){return this._stopped},i.prototype.getKeys=function(){return this._keys},i.prototype.getHighestFrame=function(){for(var t=0,n=0,i=this._keys.length;n<i;n++)t<this._keys[n].frame&&(t=this._keys[n].frame);return t},i.prototype.getEasingFunction=function(){return this._easingFunction},i.prototype.setEasingFunction=function(n){this._easingFunction=n},i.prototype.floatInterpolateFunction=function(n,t,i){return n+(t-n)*i},i.prototype.quaternionInterpolateFunction=function(t,i,r){return n.Quaternion.Slerp(t,i,r)},i.prototype.vector3InterpolateFunction=function(t,i,r){return n.Vector3.Lerp(t,i,r)},i.prototype.vector2InterpolateFunction=function(t,i,r){return n.Vector2.Lerp(t,i,r)},i.prototype.sizeInterpolateFunction=function(t,i,r){return n.Size.Lerp(t,i,r)},i.prototype.color3InterpolateFunction=function(t,i,r){return n.Color3.Lerp(t,i,r)},i.prototype.matrixInterpolateFunction=function(t,i,r){return n.Matrix.Lerp(t,i,r)},i.prototype.clone=function(){var n=new i(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode),t;if(this._keys&&n.setKeys(this._keys),this._ranges){n._ranges={};for(t in this._ranges)n._ranges[t]=this._ranges[t].clone()}return n},i.prototype.setKeys=function(n){this._keys=n.slice(0);this._offsetsCache={};this._highLimitsCache={}},i.prototype._getKeyValue=function(n){return"function"==typeof n?n():n},i.prototype._interpolate=function(n,t,r,u,f){var c,h,l;if(r===i.ANIMATIONLOOPMODE_CONSTANT&&t>0)return f.clone?f.clone():f;if(this.currentFrame=n,c=Math.max(0,Math.min(this._keys.length-1,Math.floor(this._keys.length*(n-this._keys[0].frame)/(this._keys[this._keys.length-1].frame-this._keys[0].frame))-1)),this._keys[c].frame>=n)for(;c-1>=0&&this._keys[c].frame>=n;)c--;for(h=c;h<this._keys.length;h++)if(this._keys[h+1].frame>=n){var o=this._getKeyValue(this._keys[h].value),s=this._getKeyValue(this._keys[h+1].value),e=(n-this._keys[h].frame)/(this._keys[h+1].frame-this._keys[h].frame);switch(null!=this._easingFunction&&(e=this._easingFunction.ease(e)),this.dataType){case i.ANIMATIONTYPE_FLOAT:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.floatInterpolateFunction(o,s,e);case i.ANIMATIONLOOPMODE_RELATIVE:return u*t+this.floatInterpolateFunction(o,s,e)}break;case i.ANIMATIONTYPE_QUATERNION:l=null;switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:l=this.quaternionInterpolateFunction(o,s,e);break;case i.ANIMATIONLOOPMODE_RELATIVE:l=this.quaternionInterpolateFunction(o,s,e).add(u.scale(t))}return l;case i.ANIMATIONTYPE_VECTOR3:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.vector3InterpolateFunction(o,s,e);case i.ANIMATIONLOOPMODE_RELATIVE:return this.vector3InterpolateFunction(o,s,e).add(u.scale(t))}case i.ANIMATIONTYPE_VECTOR2:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.vector2InterpolateFunction(o,s,e);case i.ANIMATIONLOOPMODE_RELATIVE:return this.vector2InterpolateFunction(o,s,e).add(u.scale(t))}case i.ANIMATIONTYPE_SIZE:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(o,s,e);case i.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(o,s,e).add(u.scale(t))}case i.ANIMATIONTYPE_COLOR3:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:return this.color3InterpolateFunction(o,s,e);case i.ANIMATIONLOOPMODE_RELATIVE:return this.color3InterpolateFunction(o,s,e).add(u.scale(t))}case i.ANIMATIONTYPE_MATRIX:switch(r){case i.ANIMATIONLOOPMODE_CYCLE:case i.ANIMATIONLOOPMODE_CONSTANT:if(this.allowMatricesInterpolation)return this.matrixInterpolateFunction(o,s,e);case i.ANIMATIONLOOPMODE_RELATIVE:return o}}break}return this._getKeyValue(this._keys[this._keys.length-1].value)},i.prototype.setValue=function(t,i){var r,u,f,e;if(void 0===i&&(i=!1),this.targetPropertyPath.length>1){for(f=this._target[this.targetPropertyPath[0]],e=1;e<this.targetPropertyPath.length-1;e++)f=f[this.targetPropertyPath[e]];r=this.targetPropertyPath[this.targetPropertyPath.length-1];u=f}else r=this.targetPropertyPath[0],u=this._target;this.enableBlending&&this._blendingFactor<=1?(this._originalBlendValue||(this._originalBlendValue=u[r].clone?u[r].clone():u[r]),u[r]=this._originalBlendValue.prototype?this._originalBlendValue.prototype.Lerp?this._originalBlendValue.construtor.prototype.Lerp(t,this._originalBlendValue,this._blendingFactor):t:this._originalBlendValue.m?n.Matrix.Lerp(this._originalBlendValue,t,this._blendingFactor):this._originalBlendValue*(1-this._blendingFactor)+this._blendingFactor*t,this._blendingFactor+=this.blendingSpeed):u[r]=t;this._target.markAsDirty&&this._target.markAsDirty(this.targetProperty)},i.prototype.goToFrame=function(n){n<this._keys[0].frame?n=this._keys[0].frame:n>this._keys[this._keys.length-1].frame&&(n=this._keys[this._keys.length-1].frame);var t=this._interpolate(n,0,this.loopMode);this.setValue(t)},i.prototype.animate=function(t,r,u,f,e,o){var v,k,s,a,l,h,y;if(void 0===o&&(o=!1),!this.targetPropertyPath||this.targetPropertyPath.length<1)return this._stopped=!0,!1;v=!0;0!==this._keys[0].frame&&(k={frame:0,value:this._keys[0].value},this._keys.splice(0,0,k));(r<this._keys[0].frame||r>this._keys[this._keys.length-1].frame)&&(r=this._keys[0].frame);(u<this._keys[0].frame||u>this._keys[this._keys.length-1].frame)&&(u=this._keys[this._keys.length-1].frame);r===u&&r++;var c,p=u-r,w=t*this.framePerSecond*e/1e3,b=0;if(w>p&&!f)v=!1,b=this._getKeyValue(this._keys[this._keys.length-1].value);else if(this.loopMode!==i.ANIMATIONLOOPMODE_CYCLE){if(s=u.toString()+r.toString(),!this._offsetsCache[s]){a=this._interpolate(r,0,i.ANIMATIONLOOPMODE_CYCLE);l=this._interpolate(u,0,i.ANIMATIONLOOPMODE_CYCLE);switch(this.dataType){case i.ANIMATIONTYPE_FLOAT:this._offsetsCache[s]=l-a;break;case i.ANIMATIONTYPE_QUATERNION:this._offsetsCache[s]=l.subtract(a);break;case i.ANIMATIONTYPE_VECTOR3:this._offsetsCache[s]=l.subtract(a);case i.ANIMATIONTYPE_VECTOR2:this._offsetsCache[s]=l.subtract(a);case i.ANIMATIONTYPE_SIZE:this._offsetsCache[s]=l.subtract(a);case i.ANIMATIONTYPE_COLOR3:this._offsetsCache[s]=l.subtract(a)}this._highLimitsCache[s]=l}b=this._highLimitsCache[s];c=this._offsetsCache[s]}if(void 0===c)switch(this.dataType){case i.ANIMATIONTYPE_FLOAT:c=0;break;case i.ANIMATIONTYPE_QUATERNION:c=new n.Quaternion(0,0,0,0);break;case i.ANIMATIONTYPE_VECTOR3:c=n.Vector3.Zero();break;case i.ANIMATIONTYPE_VECTOR2:c=n.Vector2.Zero();break;case i.ANIMATIONTYPE_SIZE:c=n.Size.Zero();break;case i.ANIMATIONTYPE_COLOR3:c=n.Color3.Black()}var g=w/p>>0,d=v?r+w%p:u,nt=this._interpolate(d,g,this.loopMode,c,b);for(this.setValue(nt),h=0;h<this._events.length;h++)d>=this._events[h].frame?(y=this._events[h],y.isDone||(y.onlyOnce&&(this._events.splice(h,1),h--),y.isDone=!0,y.action())):this._events[h].isDone&&!this._events[h].onlyOnce&&(this._events[h].isDone=!1);return v||(this._stopped=!0),v},i.prototype.serialize=function(){var n={},s,o,u,f,t,e,r;for(n.name=this.name,n.property=this.targetProperty,n.framePerSecond=this.framePerSecond,n.dataType=this.dataType,n.loopBehavior=this.loopMode,s=this.dataType,n.keys=[],o=this.getKeys(),u=0;u<o.length;u++){f=o[u];t={};switch(t.frame=f.frame,s){case i.ANIMATIONTYPE_FLOAT:t.values=[f.value];break;case i.ANIMATIONTYPE_QUATERNION:case i.ANIMATIONTYPE_MATRIX:case i.ANIMATIONTYPE_VECTOR3:case i.ANIMATIONTYPE_COLOR3:t.values=f.value.asArray()}n.keys.push(t)}n.ranges=[];for(e in this._ranges)r={},r.name=e,r.from=this._ranges[e].from,r.to=this._ranges[e].to,n.ranges.push(r);return n},Object.defineProperty(i,"ANIMATIONTYPE_FLOAT",{get:function(){return i._ANIMATIONTYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_VECTOR3",{get:function(){return i._ANIMATIONTYPE_VECTOR3},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_VECTOR2",{get:function(){return i._ANIMATIONTYPE_VECTOR2},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_SIZE",{get:function(){return i._ANIMATIONTYPE_SIZE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_QUATERNION",{get:function(){return i._ANIMATIONTYPE_QUATERNION},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_MATRIX",{get:function(){return i._ANIMATIONTYPE_MATRIX},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONTYPE_COLOR3",{get:function(){return i._ANIMATIONTYPE_COLOR3},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONLOOPMODE_RELATIVE",{get:function(){return i._ANIMATIONLOOPMODE_RELATIVE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONLOOPMODE_CYCLE",{get:function(){return i._ANIMATIONLOOPMODE_CYCLE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ANIMATIONLOOPMODE_CONSTANT",{get:function(){return i._ANIMATIONLOOPMODE_CONSTANT},enumerable:!0,configurable:!0}),i.Parse=function(t){for(var r,e=new i(t.name,t.property,t.framePerSecond,t.dataType,t.loopBehavior),s=t.dataType,o=[],f,u=0;u<t.keys.length;u++){f=t.keys[u];switch(s){case i.ANIMATIONTYPE_FLOAT:r=f.values[0];break;case i.ANIMATIONTYPE_QUATERNION:r=n.Quaternion.FromArray(f.values);break;case i.ANIMATIONTYPE_MATRIX:r=n.Matrix.FromArray(f.values);break;case i.ANIMATIONTYPE_COLOR3:r=n.Color3.FromArray(f.values);break;case i.ANIMATIONTYPE_VECTOR3:default:r=n.Vector3.FromArray(f.values)}o.push({frame:f.frame,value:r})}if(e.setKeys(o),t.ranges)for(u=0;u<t.ranges.length;u++)r=t.ranges[u],e.createRange(r.name,r.from,r.to);return e},i.AppendSerializedAnimations=function(n,t){var i,r;if(n.animations)for(t.animations=[],i=0;i<n.animations.length;i++)r=n.animations[i],t.animations.push(r.serialize())},i._ANIMATIONTYPE_FLOAT=0,i._ANIMATIONTYPE_VECTOR3=1,i._ANIMATIONTYPE_QUATERNION=2,i._ANIMATIONTYPE_MATRIX=3,i._ANIMATIONTYPE_COLOR3=4,i._ANIMATIONTYPE_VECTOR2=5,i._ANIMATIONTYPE_SIZE=6,i._ANIMATIONLOOPMODE_RELATIVE=0,i._ANIMATIONLOOPMODE_CYCLE=1,i._ANIMATIONLOOPMODE_CONSTANT=2,i}();n.Animation=u}(i||(i={}));!function(n){var t=function(){function n(n,t,i,r,u,f,e,o){void 0===i&&(i=0);void 0===r&&(r=100);void 0===u&&(u=!1);void 0===f&&(f=1);this.target=t;this.fromFrame=i;this.toFrame=r;this.loopAnimation=u;this.speedRatio=f;this.onAnimationEnd=e;this._animations=[];this._paused=!1;this.animationStarted=!1;o&&this.appendAnimations(t,o);this._scene=n;n._activeAnimatables.push(this)}return n.prototype.getAnimations=function(){return this._animations},n.prototype.appendAnimations=function(n,t){for(var r,i=0;i<t.length;i++)r=t[i],r._target=n,this._animations.push(r)},n.prototype.getAnimationByTargetProperty=function(n){for(var i=this._animations,t=0;t<i.length;t++)if(i[t].targetProperty===n)return i[t];return null},n.prototype.reset=function(){for(var t=this._animations,n=0;n<t.length;n++)t[n].reset();this._localDelayOffset=null;this._pausedDelay=null},n.prototype.enableBlending=function(n){for(var i=this._animations,t=0;t<i.length;t++)i[t].enableBlending=!0,i[t].blendingSpeed=n},n.prototype.disableBlending=function(){for(var t=this._animations,n=0;n<t.length;n++)t[n].enableBlending=!1},n.prototype.goToFrame=function(n){var t=this._animations,i;if(t[0]){var r=t[0].framePerSecond,u=t[0].currentFrame,f=n-u,e=1e3*f/r;this._localDelayOffset-=e}for(i=0;i<t.length;i++)t[i].goToFrame(n)},n.prototype.pause=function(){this._paused||(this._paused=!0)},n.prototype.restart=function(){this._paused=!1},n.prototype.stop=function(n){var t=this._scene._activeAnimatables.indexOf(this);if(t>-1){for(var i=this._animations,r=0,t=i.length-1;t>=0;t--)"string"==typeof n&&i[t].name!=n||(i[t].reset(),i.splice(t,1),r++);i.length==r&&(this._scene._activeAnimatables.splice(t,1),this.onAnimationEnd&&this.onAnimationEnd())}},n.prototype._animate=function(n){var i,t,r,u,f;if(this._paused)return this.animationStarted=!1,this._pausedDelay||(this._pausedDelay=n),!0;for(this._localDelayOffset?this._pausedDelay&&(this._localDelayOffset+=n-this._pausedDelay,this._pausedDelay=null):this._localDelayOffset=n,t=!1,r=this._animations,i=0;i<r.length;i++)u=r[i],f=u.animate(n-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this.speedRatio),t=t||f;return this.animationStarted=t,t||(i=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(i,1)),!t&&this.onAnimationEnd&&(this.onAnimationEnd(),this.onAnimationEnd=null),t},n}();n.Animatable=t}(i||(i={}));!function(n){var t=function(){function n(){this._easingMode=n.EASINGMODE_EASEIN}return Object.defineProperty(n,"EASINGMODE_EASEIN",{get:function(){return n._EASINGMODE_EASEIN},enumerable:!0,configurable:!0}),Object.defineProperty(n,"EASINGMODE_EASEOUT",{get:function(){return n._EASINGMODE_EASEOUT},enumerable:!0,configurable:!0}),Object.defineProperty(n,"EASINGMODE_EASEINOUT",{get:function(){return n._EASINGMODE_EASEINOUT},enumerable:!0,configurable:!0}),n.prototype.setEasingMode=function(n){var t=Math.min(Math.max(n,0),2);this._easingMode=t},n.prototype.getEasingMode=function(){return this._easingMode},n.prototype.easeInCore=function(){throw new Error("You must implement this method");},n.prototype.ease=function(t){switch(this._easingMode){case n.EASINGMODE_EASEIN:return this.easeInCore(t);case n.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-t)}return t>=.5?.5*(1-this.easeInCore(2*(1-t)))+.5:.5*this.easeInCore(2*t)},n._EASINGMODE_EASEIN=0,n._EASINGMODE_EASEOUT=1,n._EASINGMODE_EASEINOUT=2,n}(),i,r,f,e,o,s,h,c,l,a,v,y;n.EasingFunction=t;i=function(n){function t(){n.apply(this,arguments)}return u(t,n),t.prototype.easeInCore=function(n){return n=Math.max(0,Math.min(1,n)),1-Math.sqrt(1-n*n)},t}(t);n.CircleEase=i;r=function(n){function t(t){void 0===t&&(t=1);n.call(this);this.amplitude=t}return u(t,n),t.prototype.easeInCore=function(n){var t=Math.max(0,this.amplitude);return Math.pow(n,3)-n*t*Math.sin(3.1415926535897931*n)},t}(t);n.BackEase=r;f=function(n){function t(t,i){void 0===t&&(t=3);void 0===i&&(i=2);n.call(this);this.bounces=t;this.bounciness=i}return u(t,n),t.prototype.easeInCore=function(n){var e=Math.max(0,this.bounces),t=this.bounciness;t<=1&&(t=1.001);var o=Math.pow(t,e),r=1-t,u=(1-o)/r+.5*o,l=n*u,a=Math.log(-l*(1-t)+1)/Math.log(t),f=Math.floor(a),v=f+1,s=(1-Math.pow(t,f))/(r*u),y=(1-Math.pow(t,v))/(r*u),h=.5*(s+y),c=n-h,i=h-s;return-Math.pow(1/t,e-f)/(i*i)*(c-i)*(c+i)},t}(t);n.BounceEase=f;e=function(n){function t(){n.apply(this,arguments)}return u(t,n),t.prototype.easeInCore=function(n){return n*n*n},t}(t);n.CubicEase=e;o=function(n){function t(t,i){void 0===t&&(t=3);void 0===i&&(i=3);n.call(this);this.oscillations=t;this.springiness=i}return u(t,n),t.prototype.easeInCore=function(n){var i,r=Math.max(0,this.oscillations),t=Math.max(0,this.springiness);return i=0==t?n:(Math.exp(t*n)-1)/(Math.exp(t)-1),i*Math.sin((6.2831853071795862*r+1.5707963267948966)*n)},t}(t);n.ElasticEase=o;s=function(n){function t(t){void 0===t&&(t=2);n.call(this);this.exponent=t}return u(t,n),t.prototype.easeInCore=function(n){return this.exponent<=0?n:(Math.exp(this.exponent*n)-1)/(Math.exp(this.exponent)-1)},t}(t);n.ExponentialEase=s;h=function(n){function t(t){void 0===t&&(t=2);n.call(this);this.power=t}return u(t,n),t.prototype.easeInCore=function(n){var t=Math.max(0,this.power);return Math.pow(n,t)},t}(t);n.PowerEase=h;c=function(n){function t(){n.apply(this,arguments)}return u(t,n),t.prototype.easeInCore=function(n){return n*n},t}(t);n.QuadraticEase=c;l=function(n){function t(){n.apply(this,arguments)}return u(t,n),t.prototype.easeInCore=function(n){return n*n*n*n},t}(t);n.QuarticEase=l;a=function(n){function t(){n.apply(this,arguments)}return u(t,n),t.prototype.easeInCore=function(n){return n*n*n*n*n},t}(t);n.QuinticEase=a;v=function(n){function t(){n.apply(this,arguments)}return u(t,n),t.prototype.easeInCore=function(n){return 1-Math.sin(1.5707963267948966*(1-n))},t}(t);n.SineEase=v;y=function(t){function i(n,i,r,u){void 0===n&&(n=0);void 0===i&&(i=0);void 0===r&&(r=1);void 0===u&&(u=1);t.call(this);this.x1=n;this.y1=i;this.x2=r;this.y2=u}return u(i,t),i.prototype.easeInCore=function(t){return n.BezierCurve.interpolate(t,this.x1,this.y1,this.x2,this.y2)},i}(t);n.BezierCurveEase=y}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e){t.call(this,i,r.getScene());this.name=i;this.children=[];this.animations=[];this._worldTransform=new n.Matrix;this._absoluteTransform=new n.Matrix;this._invertedAbsoluteTransform=new n.Matrix;this._scaleMatrix=n.Matrix.Identity();this._scaleVector=new n.Vector3(1,1,1);this._negateScaleChildren=new n.Vector3(1,1,1);this._scalingDeterminant=1;this._syncScaleVector=function(){var t=this.getLocalMatrix(),i=t.m[0]*t.m[0]+t.m[1]*t.m[1]+t.m[2]*t.m[2],r=t.m[4]*t.m[4]+t.m[5]*t.m[5]+t.m[6]*t.m[6],u=t.m[8]*t.m[8]+t.m[9]*t.m[9]+t.m[10]*t.m[10],f=t.m[0]*t.m[1]*t.m[2]*t.m[3]<0?-1:1,e=t.m[4]*t.m[5]*t.m[6]*t.m[7]<0?-1:1,o=t.m[8]*t.m[9]*t.m[10]*t.m[11]<0?-1:1;this._scaleVector.x=f*Math.sqrt(i);this._scaleVector.y=e*Math.sqrt(r);this._scaleVector.z=o*Math.sqrt(u);this._parent&&(this._scaleVector.x/=this._parent._negateScaleChildren.x,this._scaleVector.y/=this._parent._negateScaleChildren.y,this._scaleVector.z/=this._parent._negateScaleChildren.z);n.Matrix.FromValuesToRef(this._scaleVector.x,0,0,0,0,this._scaleVector.y,0,0,0,0,this._scaleVector.z,0,0,0,0,1,this._scaleMatrix)};this._skeleton=r;this._matrix=f;this._baseMatrix=f;this._restPose=e?e:f.clone();r.bones.push(this);u?(this._parent=u,u.children.push(this)):this._parent=null;this._updateDifferenceMatrix();this.getAbsoluteTransform().determinant()<0&&(this._scalingDeterminant*=-1)}return u(i,t),i.prototype.getParent=function(){return this._parent},i.prototype.getLocalMatrix=function(){return this._matrix},i.prototype.getBaseMatrix=function(){return this._baseMatrix},i.prototype.getRestPose=function(){return this._restPose},i.prototype.returnToRest=function(){this.updateMatrix(this._restPose.clone())},i.prototype.getWorldMatrix=function(){return this._worldTransform},i.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},i.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},i.prototype.updateMatrix=function(n,t){void 0===t&&(t=!0);this._baseMatrix=n.clone();this._matrix=n.clone();this._skeleton._markAsDirty();t&&this._updateDifferenceMatrix()},i.prototype._updateDifferenceMatrix=function(n){n||(n=this._baseMatrix);this._parent?n.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(n);this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform);for(var t=0;t<this.children.length;t++)this.children[t]._updateDifferenceMatrix()},i.prototype.markAsDirty=function(){this._currentRenderId++;this._skeleton._markAsDirty()},i.prototype.copyAnimationRange=function(t,i,r,u,f){var s;if(void 0===u&&(u=!1),void 0===f&&(f=null),0===this.animations.length&&(this.animations.push(new n.Animation(this.name,"_matrix",t.animations[0].framePerSecond,n.Animation.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([])),s=t.animations[0].getRange(i),!s)return!1;for(var o,h,e,l=s.from,a=s.to,v=t.animations[0].getKeys(),y=t.length,p=t.getParent(),w=this.getParent(),b=u&&p&&y&&this.length&&y!==this.length,k=b?w.length/p.length:null,d=u&&!w&&f&&(1!==f.x||1!==f.y||1!==f.z),g=this.animations[0].getKeys(),c=0,nt=v.length;c<nt;c++)o=v[c],o.frame>=l&&o.frame<=a&&(u?(e=o.value.clone(),b?(h=e.getTranslation(),e.setTranslation(h.scaleInPlace(k))):d?(h=e.getTranslation(),e.setTranslation(h.multiplyInPlace(f))):e=o.value):e=o.value,g.push({frame:o.frame+r,value:e}));return this.animations[0].createRange(i,l+r,a+r),!0},i.prototype.translate=function(t,i,r){var f,u,e;void 0===i&&(i=n.Space.LOCAL);f=this.getLocalMatrix();i==n.Space.LOCAL?(f.m[12]+=t.x,f.m[13]+=t.y,f.m[14]+=t.z):(this._skeleton.computeAbsoluteTransforms(),u=n.Tmp.Matrix[0],e=n.Tmp.Vector3[0],r?(u.copyFrom(this._parent.getAbsoluteTransform()),u.multiplyToRef(r.getWorldMatrix(),u)):u.copyFrom(this._parent.getAbsoluteTransform()),u.m[12]=0,u.m[13]=0,u.m[14]=0,u.invert(),n.Vector3.TransformCoordinatesToRef(t,u,e),f.m[12]+=e.x,f.m[13]+=e.y,f.m[14]+=e.z);this.markAsDirty()},i.prototype.setPosition=function(t,i,r){var u,f,e;void 0===i&&(i=n.Space.LOCAL);u=this.getLocalMatrix();i==n.Space.LOCAL?(u.m[12]=t.x,u.m[13]=t.y,u.m[14]=t.z):(this._skeleton.computeAbsoluteTransforms(),f=n.Tmp.Matrix[0],e=n.Tmp.Vector3[0],r?(f.copyFrom(this._parent.getAbsoluteTransform()),f.multiplyToRef(r.getWorldMatrix(),f)):f.copyFrom(this._parent.getAbsoluteTransform()),f.invert(),n.Vector3.TransformCoordinatesToRef(t,f,e),u.m[12]=e.x,u.m[13]=e.y,u.m[14]=e.z);this.markAsDirty()},i.prototype.setAbsolutePosition=function(t,i){this.setPosition(t,n.Space.WORLD,i)},i.prototype.setScale=function(n,t,i,r){void 0===r&&(r=!1);this.animations[0]&&!this.animations[0].isStopped()&&(r||(this._negateScaleChildren.x=1/n,this._negateScaleChildren.y=1/t,this._negateScaleChildren.z=1/i),this._syncScaleVector());this.scale(n/this._scaleVector.x,t/this._scaleVector.y,i/this._scaleVector.z,r)},i.prototype.scale=function(t,i,r,u){var f,s,h,o,l,a,v,y,c,e;for(void 0===u&&(u=!1),f=this.getLocalMatrix(),s=n.Tmp.Matrix[0],s.copyFrom(f),h=n.Tmp.Matrix[1],h.copyFrom(s),h.invert(),o=n.Tmp.Matrix[2],n.Matrix.FromValuesToRef(t,0,0,0,0,i,0,0,0,0,r,0,0,0,0,1,o),this._scaleMatrix.multiplyToRef(o,this._scaleMatrix),this._scaleVector.x*=t,this._scaleVector.y*=i,this._scaleVector.z*=r,f.multiplyToRef(h,f),f.multiplyToRef(o,f),f.multiplyToRef(s,f),l=this.getParent(),l?f.multiplyToRef(l.getAbsoluteTransform(),this.getAbsoluteTransform()):this.getAbsoluteTransform().copyFrom(f),a=this.children.length,o.invert(),e=0;e<a;e++)v=this.children[e],y=v.getLocalMatrix(),y.multiplyToRef(o,y),c=v.getLocalMatrix(),c.m[12]*=t,c.m[13]*=i,c.m[14]*=r;if(this.computeAbsoluteTransforms(),u)for(e=0;e<a;e++)this.children[e].scale(t,i,r,u);this.markAsDirty()},i.prototype.setYawPitchRoll=function(t,i,r,u,f){var e,o;void 0===u&&(u=n.Space.LOCAL);e=n.Tmp.Matrix[0];n.Matrix.RotationYawPitchRollToRef(t,i,r,e);o=n.Tmp.Matrix[1];this._getNegativeRotationToRef(o,u,f);o.multiplyToRef(e,e);this._rotateWithMatrix(e,u,f)},i.prototype.rotate=function(t,i,r,u){void 0===r&&(r=n.Space.LOCAL);var f=n.Tmp.Matrix[0];f.m[12]=0;f.m[13]=0;f.m[14]=0;n.Matrix.RotationAxisToRef(t,i,f);this._rotateWithMatrix(f,r,u)},i.prototype.setAxisAngle=function(t,i,r,u){var f,e;void 0===r&&(r=n.Space.LOCAL);f=n.Tmp.Matrix[0];n.Matrix.RotationAxisToRef(t,i,f);e=n.Tmp.Matrix[1];this._getNegativeRotationToRef(e,r,u);e.multiplyToRef(f,f);this._rotateWithMatrix(f,r,u)},i.prototype.setRotation=function(t,i,r){void 0===i&&(i=n.Space.LOCAL);this.setYawPitchRoll(t.y,t.x,t.z,i,r)},i.prototype.setRotationQuaternion=function(t,i,r){var f,u;void 0===i&&(i=n.Space.LOCAL);f=n.Tmp.Matrix[0];this._getNegativeRotationToRef(f,i,r);u=n.Tmp.Matrix[1];n.Matrix.FromQuaternionToRef(t,u);f.multiplyToRef(u,u);this._rotateWithMatrix(u,i,r)},i.prototype.setRotationMatrix=function(t,i,r){var f,u;void 0===i&&(i=n.Space.LOCAL);f=n.Tmp.Matrix[0];this._getNegativeRotationToRef(f,i,r);u=n.Tmp.Matrix[1];u.copyFrom(t);f.multiplyToRef(t,u);this._rotateWithMatrix(u,i,r)},i.prototype._rotateWithMatrix=function(t,i,r){void 0===i&&(i=n.Space.LOCAL);var u=this.getLocalMatrix(),s=u.m[12],h=u.m[13],c=u.m[14],o=this.getParent(),f=n.Tmp.Matrix[3],e=n.Tmp.Matrix[4];o?(i==n.Space.WORLD?r?(f.copyFrom(r.getWorldMatrix()),o.getAbsoluteTransform().multiplyToRef(f,f)):f.copyFrom(o.getAbsoluteTransform()):f=o._scaleMatrix,e.copyFrom(f),e.invert(),u.multiplyToRef(f,u),u.multiplyToRef(t,u),u.multiplyToRef(e,u)):i==n.Space.WORLD&&r?(f.copyFrom(r.getWorldMatrix()),e.copyFrom(f),e.invert(),u.multiplyToRef(f,u),u.multiplyToRef(t,u),u.multiplyToRef(e,u)):u.multiplyToRef(t,u);u.m[12]=s;u.m[13]=h;u.m[14]=c;this.computeAbsoluteTransforms();this.markAsDirty()},i.prototype._getNegativeRotationToRef=function(t,i,r){var e,u,f;(void 0===i&&(i=n.Space.LOCAL),i==n.Space.WORLD)?(u=n.Tmp.Matrix[2],(u.copyFrom(this._scaleMatrix),t.copyFrom(this.getAbsoluteTransform()),r)&&(t.multiplyToRef(r.getWorldMatrix(),t),e=n.Tmp.Matrix[3],n.Matrix.ScalingToRef(r.scaling.x,r.scaling.y,r.scaling.z,e),u.multiplyToRef(e,u)),t.invert(),u.m[0]*=this._scalingDeterminant,t.multiplyToRef(u,t)):(t.copyFrom(this.getLocalMatrix()),t.invert(),u=n.Tmp.Matrix[2],(u.copyFrom(this._scaleMatrix),this._parent)?(f=n.Tmp.Matrix[3],f.copyFrom(this._parent._scaleMatrix),f.invert(),f.multiplyToRef(t,t)):u.m[0]*=this._scalingDeterminant,t.multiplyToRef(u,t))},i.prototype.getScale=function(){return this._scaleVector.clone()},i.prototype.getScaleToRef=function(n){n.copyFrom(this._scaleVector)},i.prototype.getPosition=function(t,i){void 0===t&&(t=n.Space.LOCAL);var r=n.Vector3.Zero();return this.getPositionToRef(t,i,r),r},i.prototype.getPositionToRef=function(t,i,r){var f,u;(void 0===t&&(t=n.Space.LOCAL),t==n.Space.LOCAL)?(f=this.getLocalMatrix(),r.x=f.m[12],r.y=f.m[13],r.z=f.m[14]):(this._skeleton.computeAbsoluteTransforms(),u=n.Tmp.Matrix[0],i?(u.copyFrom(this.getAbsoluteTransform()),u.multiplyToRef(i.getWorldMatrix(),u)):u=this.getAbsoluteTransform(),r.x=u.m[12],r.y=u.m[13],r.z=u.m[14])},i.prototype.getAbsolutePosition=function(t){var i=n.Vector3.Zero();return this.getPositionToRef(n.Space.WORLD,t,i),i},i.prototype.getAbsolutePositionToRef=function(t,i){this.getPositionToRef(n.Space.WORLD,t,i)},i.prototype.computeAbsoluteTransforms=function(){var n;this._parent?this._matrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):(this._absoluteTransform.copyFrom(this._matrix),n=this._skeleton.getPoseMatrix(),n&&this._absoluteTransform.multiplyToRef(n,this._absoluteTransform));for(var i=this.children,r=i.length,t=0;t<r;t++)i[t].computeAbsoluteTransforms()},i.prototype.getDirection=function(t,i){var r=n.Vector3.Zero();return this.getDirectionToRef(t,i,r),r},i.prototype.getDirectionToRef=function(t,i,r){this._skeleton.computeAbsoluteTransforms();var u=n.Tmp.Matrix[0];u.copyFrom(this.getAbsoluteTransform());i&&u.multiplyToRef(i.getWorldMatrix(),u);n.Vector3.TransformNormalToRef(t,u,r);r.normalize()},i.prototype.getRotation=function(t,i){void 0===t&&(t=n.Space.LOCAL);var r=n.Vector3.Zero();return this.getRotationToRef(t,i,r),r},i.prototype.getRotationToRef=function(t,i,r){void 0===t&&(t=n.Space.LOCAL);var u=n.Tmp.Quaternion[0];this.getRotationQuaternionToRef(t,i,u);u.toEulerAnglesToRef(r)},i.prototype.getRotationQuaternion=function(t,i){void 0===t&&(t=n.Space.LOCAL);var r=n.Quaternion.Identity();return this.getRotationQuaternionToRef(t,i,r),r},i.prototype.getRotationQuaternionToRef=function(t,i,r){if(void 0===t&&(t=n.Space.LOCAL),t==n.Space.LOCAL)this.getLocalMatrix().decompose(n.Tmp.Vector3[0],r,n.Tmp.Vector3[1]);else{var u=n.Tmp.Matrix[0],f=this.getAbsoluteTransform();i?f.multiplyToRef(i.getWorldMatrix(),u):u.copyFrom(f);u.m[0]*=this._scalingDeterminant;u.m[1]*=this._scalingDeterminant;u.m[2]*=this._scalingDeterminant;u.decompose(n.Tmp.Vector3[0],r,n.Tmp.Vector3[1])}},i.prototype.getRotationMatrix=function(t,i){void 0===t&&(t=n.Space.LOCAL);var r=n.Matrix.Identity();return this.getRotationMatrixToRef(t,i,r),r},i.prototype.getRotationMatrixToRef=function(t,i,r){if(void 0===t&&(t=n.Space.LOCAL),t==n.Space.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(r);else{var u=n.Tmp.Matrix[0],f=this.getAbsoluteTransform();i?f.multiplyToRef(i.getWorldMatrix(),u):u.copyFrom(f);u.m[0]*=this._scalingDeterminant;u.m[1]*=this._scalingDeterminant;u.m[2]*=this._scalingDeterminant;u.getRotationMatrixToRef(r)}},i.prototype.getAbsolutePositionFromLocal=function(t,i){var r=n.Vector3.Zero();return this.getAbsolutePositionFromLocalToRef(t,i,r),r},i.prototype.getAbsolutePositionFromLocalToRef=function(t,i,r){this._skeleton.computeAbsoluteTransforms();var u=n.Tmp.Matrix[0];i?(u.copyFrom(this.getAbsoluteTransform()),u.multiplyToRef(i.getWorldMatrix(),u)):u=this.getAbsoluteTransform();n.Vector3.TransformCoordinatesToRef(t,u,r)},i.prototype.getLocalPositionFromAbsolute=function(t,i){var r=n.Vector3.Zero();return this.getLocalPositionFromAbsoluteToRef(t,i,r),r},i.prototype.getLocalPositionFromAbsoluteToRef=function(t,i,r){this._skeleton.computeAbsoluteTransforms();var u=n.Tmp.Matrix[0];u.copyFrom(this.getAbsoluteTransform());i&&u.multiplyToRef(i.getWorldMatrix(),u);u.invert();n.Vector3.TransformCoordinatesToRef(t,u,r)},i}(n.Node);n.Bone=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r){var u,f;if(this.targetPosition=n.Vector3.Zero(),this.poleTargetPosition=n.Vector3.Zero(),this.poleTargetLocalOffset=n.Vector3.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=n.Quaternion.Identity(),this._bone1Mat=n.Matrix.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._tmpVec1=n.Vector3.Zero(),this._tmpVec2=n.Vector3.Zero(),this._tmpVec3=n.Vector3.Zero(),this._tmpVec4=n.Vector3.Zero(),this._tmpVec5=n.Vector3.Zero(),this._tmpMat1=n.Matrix.Identity(),this._tmpMat2=n.Matrix.Identity(),this._tmpQuat1=n.Quaternion.Identity(),this._rightHandedSystem=!1,this._bendAxis=n.Vector3.Right(),this._slerping=!1,this._bone2=i,this._bone1=i.getParent(),this.mesh=t,i.getAbsoluteTransform().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=1),this._bone1.length)u=this._bone1.getScale(),f=this._bone2.getScale(),this._bone1Length=this._bone1.length*u.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*f.y*this.mesh.scaling.y;else if(this._bone1.children[0]){t.computeWorldMatrix(!0);var o=this._bone2.children[0].getAbsolutePosition(t),e=this._bone2.getAbsolutePosition(t),s=this._bone1.getAbsolutePosition(t);this._bone1Length=n.Vector3.Distance(o,e);this._bone2Length=n.Vector3.Distance(e,s)}this._bone1.getRotationMatrixToRef(n.Space.WORLD,t,this._bone1Mat);this.maxAngle=Math.PI;r&&(r.targetMesh&&(this.targetMesh=r.targetMesh,this.targetMesh.computeWorldMatrix(!0)),r.poleTargetMesh?(this.poleTargetMesh=r.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):r.poleTargetBone?this.poleTargetBone=r.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),r.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(r.poleTargetLocalOffset),r.poleAngle&&(this.poleAngle=r.poleAngle),r.bendAxis&&this._bendAxis.copyFrom(r.bendAxis),r.maxAngle&&(this.maxAngle=r.maxAngle),r.slerpAmount&&(this.slerpAmount=r.slerpAmount))}return Object.defineProperty(t.prototype,"maxAngle",{get:function(){return this._maxAngle},set:function(n){this._setMaxAngle(n)},enumerable:!0,configurable:!0}),t.prototype._setMaxAngle=function(n){n<0&&(n=0);(n>Math.PI||void 0==n)&&(n=Math.PI);this._maxAngle=n;var t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(n))},t.prototype.update=function(){var b=this._bone1,v=this.targetPosition,y=this.poleTargetPosition,t=this._tmpMat1,i=this._tmpMat2,e,o;this.targetMesh&&v.copyFrom(this.targetMesh.getAbsolutePosition());this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,y):this.poleTargetMesh&&n.Vector3.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),y);var c=this._tmpVec1,l=this._tmpVec2,p=this._tmpVec3,f=this._tmpVec4,u=this._tmpVec5;b.getAbsolutePositionToRef(this.mesh,c);y.subtractToRef(c,u);0==u.x&&0==u.y&&0==u.z?u.y=1:u.normalize();v.subtractToRef(c,f);f.normalize();n.Vector3.CrossToRef(f,u,l);l.normalize();n.Vector3.CrossToRef(f,l,p);p.normalize();n.Matrix.FromXYZAxesToRef(p,f,l,t);var s=this._bone1Length,h=this._bone2Length,r=n.Vector3.Distance(c,v);this._maxReach>0&&(r=Math.min(this._maxReach,r));e=(h*h+r*r-s*s)/(2*h*r);o=(r*r+s*s-h*h)/(2*r*s);e>1&&(e=1);o>1&&(o=1);e<-1&&(e=-1);o<-1&&(o=-1);var k=Math.acos(e),w=Math.acos(o),a=-k-w;this._rightHandedSystem?(n.Matrix.RotationYawPitchRollToRef(0,0,.5*Math.PI,i),i.multiplyToRef(t,t),n.Matrix.RotationAxisToRef(this._bendAxis,w,i),i.multiplyToRef(t,t)):(this._tmpVec1.copyFrom(this._bendAxis),this._tmpVec1.x*=-1,n.Matrix.RotationAxisToRef(this._tmpVec1,-w,i),i.multiplyToRef(t,t));this.poleAngle&&(n.Matrix.RotationAxisToRef(f,this.poleAngle,i),t.multiplyToRef(i,t));this.slerpAmount<1?(this._slerping||n.Quaternion.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),n.Quaternion.FromRotationMatrixToRef(t,this._tmpQuat1),n.Quaternion.SlerpToRef(this._bone1Quat,this._tmpQuat1,this.slerpAmount,this._bone1Quat),a=this._bone2Ang*(1-this.slerpAmount)+a*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,n.Space.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(t,n.Space.WORLD,this.mesh),this._bone1Mat.copyFrom(t),this._slerping=!1);this._bone2.setAxisAngle(this._bendAxis,a,n.Space.LOCAL);this._bone2Ang=a},t}();n.BoneIKController=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u){this.upAxis=n.Vector3.Up();this.adjustYaw=0;this.adjustPitch=0;this.adjustRoll=0;this._tmpVec1=n.Vector3.Zero();this._tmpVec2=n.Vector3.Zero();this._tmpVec3=n.Vector3.Zero();this._tmpVec4=n.Vector3.Zero();this._tmpMat1=n.Matrix.Identity();this._tmpMat2=n.Matrix.Identity();this.mesh=t;this.bone=i;this.target=r;u&&(u.adjustYaw&&(this.adjustYaw=u.adjustYaw),u.adjustPitch&&(this.adjustPitch=u.adjustPitch),u.adjustRoll&&(this.adjustRoll=u.adjustRoll))}return t.prototype.update=function(){var o=this.bone,s=this.target,f=this._tmpVec1,t=this._tmpVec2,i=this._tmpVec3,u=this._tmpVec4,r=this._tmpMat1,e=this._tmpMat2;o.getAbsolutePositionToRef(this.mesh,f);s.subtractToRef(f,t);t.normalize();n.Vector3.CrossToRef(this.upAxis,t,i);i.normalize();n.Vector3.CrossToRef(t,i,u);u.normalize();n.Matrix.FromXYZAxesToRef(i,u,t,r);(this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(n.Matrix.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,e),e.multiplyToRef(r,r));this.bone.setRotationMatrix(r,n.Space.WORLD,this.mesh)},t}();n.BoneLookController=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r){this.name=t;this.id=i;this.bones=[];this.needInitialSkinMatrix=!1;this._isDirty=!0;this._meshesWithPoseMatrix=[];this._identity=n.Matrix.Identity();this._ranges={};this._lastAbsoluteTransformsUpdateId=-1;this.bones=[];this._scene=r;r.skeletons.push(this);this._isDirty=!0}return t.prototype.getTransformMatrices=function(n){return this.needInitialSkinMatrix&&n._bonesTransformMatrices?n._bonesTransformMatrices:this._transformMatrices},t.prototype.getScene=function(){return this._scene},t.prototype.toString=function(n){var t="Name: "+this.name+", nBones: "+this.bones.length,i,r;if(t+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),n){t+=", Ranges: {";i=!0;for(r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t},t.prototype.getBoneIndexByName=function(n){for(var t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===n)return t;return-1},t.prototype.createAnimationRange=function(t,i,r){if(!this._ranges[t]){this._ranges[t]=new n.AnimationRange(t,i,r);for(var u=0,f=this.bones.length;u<f;u++)this.bones[u].animations[0]&&this.bones[u].animations[0].createRange(t,i,r)}},t.prototype.deleteAnimationRange=function(n,t){void 0===t&&(t=!0);for(var i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(n,t);this._ranges[n]=void 0},t.prototype.getAnimationRange=function(n){return this._ranges[n]},t.prototype.getAnimationRanges=function(){var n,t=[],i=0;for(n in this._ranges)t[i]=this._ranges[n],i++;return t},t.prototype.copyAnimationRange=function(t,i,r){var v,h,c,l;if(void 0===r&&(r=!1),this._ranges[i]||!t.getAnimationRange(i))return!1;for(var f=!0,s=this._getHighestAnimationFrame()+1,a={},e=t.bones,u=0,o=e.length;u<o;u++)a[e[u].name]=e[u];for(this.bones.length!==e.length&&(n.Tools.Warn("copyAnimationRange: this rig has "+this.bones.length+" bones, while source as "+e.length),f=!1),v=r&&this.dimensionsAtRest&&t.dimensionsAtRest?this.dimensionsAtRest.divide(t.dimensionsAtRest):null,u=0,o=this.bones.length;u<o;u++)h=this.bones[u].name,c=a[h],c?f=f&&this.bones[u].copyAnimationRange(c,i,s,r,v):(n.Tools.Warn("copyAnimationRange: not same rig, missing source bone "+h),f=!1);return l=t.getAnimationRange(i),this._ranges[i]=new n.AnimationRange(i,l.from+s,l.to+s),f},t.prototype.returnToRest=function(){for(var n=0;n<this.bones.length;n++)this.bones[n].returnToRest()},t.prototype._getHighestAnimationFrame=function(){for(var i,t=0,n=0,r=this.bones.length;n<r;n++)this.bones[n].animations[0]&&(i=this.bones[n].animations[0].getHighestFrame(),t<i&&(t=i));return t},t.prototype.beginAnimation=function(n,t,i,r){var u=this.getAnimationRange(n);return u?this._scene.beginAnimation(this,u.from,u.to,t,i,r):null},t.prototype._markAsDirty=function(){this._isDirty=!0},t.prototype._registerMeshWithPoseMatrix=function(n){this._meshesWithPoseMatrix.push(n)},t.prototype._unregisterMeshWithPoseMatrix=function(n){var t=this._meshesWithPoseMatrix.indexOf(n);t>-1&&this._meshesWithPoseMatrix.splice(t,1)},t.prototype._computeTransformMatrices=function(n,t){for(var i,u,r=0;r<this.bones.length;r++)i=this.bones[r],u=i.getParent(),u?i.getLocalMatrix().multiplyToRef(u.getWorldMatrix(),i.getWorldMatrix()):t?i.getLocalMatrix().multiplyToRef(t,i.getWorldMatrix()):i.getWorldMatrix().copyFrom(i.getLocalMatrix()),i.getInvertedAbsoluteTransform().multiplyToArray(i.getWorldMatrix(),n,16*r);this._identity.copyToArray(n,16*this.bones.length)},t.prototype.prepare=function(){var i,t,f,r,u,e;if(this._isDirty){if(this.needInitialSkinMatrix)for(i=0;i<this._meshesWithPoseMatrix.length;i++){for(t=this._meshesWithPoseMatrix[i],t._bonesTransformMatrices&&t._bonesTransformMatrices.length===16*(this.bones.length+1)||(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1))),f=t.getPoseMatrix(),r=0;r<this.bones.length;r++)u=this.bones[r],u.getParent()||(e=u.getBaseMatrix(),e.multiplyToRef(f,n.Tmp.Matrix[0]),u._updateDifferenceMatrix(n.Tmp.Matrix[0]));this._computeTransformMatrices(t._bonesTransformMatrices,f)}else this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1))),this._computeTransformMatrices(this._transformMatrices,null);this._isDirty=!1;this._scene._activeBones.addCount(this.bones.length,!1)}},t.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var n=0;n<this.bones.length;n++)this._animatables.push(this.bones[n])}return this._animatables},t.prototype.clone=function(i,r){var f=new t(i,r||i,this._scene),e,u,o,h,c,s;for(f.needInitialSkinMatrix=this.needInitialSkinMatrix,e=0;e<this.bones.length;e++)u=this.bones[e],o=null,u.getParent()&&(h=this.bones.indexOf(u.getParent()),o=f.bones[h]),c=new n.Bone(u.name,f,o,u.getBaseMatrix().clone(),u.getRestPose().clone()),n.Tools.DeepCopy(u.animations,c.animations);if(this._ranges){f._ranges={};for(s in this._ranges)f._ranges[s]=this._ranges[s].clone()}return this._isDirty=!0,f},t.prototype.enableBlending=function(n){void 0===n&&(n=.01);this.bones.forEach(function(t){t.animations.forEach(function(t){t.enableBlending=!0;t.blendingSpeed=n})})},t.prototype.dispose=function(){this._meshesWithPoseMatrix=[];this.getScene().stopAnimation(this);this.getScene().removeSkeleton(this)},t.prototype.serialize=function(){var t={},r,n,u,f,i;for(t.name=this.name,t.id=this.id,t.dimensionsAtRest=this.dimensionsAtRest,t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix,r=0;r<this.bones.length;r++){n=this.bones[r];u={parentBoneIndex:n.getParent()?this.bones.indexOf(n.getParent()):-1,name:n.name,matrix:n.getLocalMatrix().toArray(),rest:n.getRestPose().toArray()};t.bones.push(u);n.length&&(u.length=n.length);n.animations&&n.animations.length>0&&(u.animation=n.animations[0].serialize());t.ranges=[];for(f in this._ranges)i={},i.name=f,i.from=this._ranges[f].from,i.to=this._ranges[f].to,t.ranges.push(i)}return t},t.Parse=function(i,r){var e=new t(i.name,i.id,r),f,u,s,c,h,o;for(i.dimensionsAtRest&&(e.dimensionsAtRest=n.Vector3.FromArray(i.dimensionsAtRest)),e.needInitialSkinMatrix=i.needInitialSkinMatrix,f=0;f<i.bones.length;f++)u=i.bones[f],s=null,u.parentBoneIndex>-1&&(s=e.bones[u.parentBoneIndex]),c=u.rest?n.Matrix.FromArray(u.rest):null,h=new n.Bone(u.name,e,s,n.Matrix.FromArray(u.matrix),c),u.length&&(h.length=u.length),u.animation&&h.animations.push(n.Animation.Parse(u.animation));if(i.ranges)for(f=0;f<i.ranges.length;f++)o=i.ranges[f],e.createAnimationRange(o.name,o.from,o.to);return e},t.prototype.computeAbsoluteTransforms=function(n){void 0===n&&(n=!1);var t=this._scene.getRenderId();(this._lastAbsoluteTransformsUpdateId!=t||n)&&(this.bones[0].computeAbsoluteTransforms(),this._lastAbsoluteTransformsUpdateId=t)},t.prototype.getPoseMatrix=function(){var n;return this._meshesWithPoseMatrix.length>0&&(n=this._meshesWithPoseMatrix[0].getPoseMatrix()),n},t}();n.Skeleton=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f,e,o,s,h,c,l){void 0===o&&(o=n.Texture.NEAREST_SAMPLINGMODE);void 0===l&&(l=n.Engine.TEXTURETYPE_UNSIGNED_INT);this.name=t;this.width=-1;this.height=-1;this.enablePixelPerfectMode=!1;this._reusable=!1;this._textures=new n.SmartArray(2);this._currentRenderTextureInd=0;this._scaleRatio=new n.Vector2(1,1);this.onActivateObservable=new n.Observable;this.onSizeChangedObservable=new n.Observable;this.onApplyObservable=new n.Observable;this.onBeforeRenderObservable=new n.Observable;this.onAfterRenderObservable=new n.Observable;null!=e?(this._camera=e,this._scene=e.getScene(),e.attachPostProcess(this),this._engine=this._scene.getEngine()):this._engine=s;this._options=f;this.renderTargetSamplingMode=o?o:n.Texture.NEAREST_SAMPLINGMODE;this._reusable=h||!1;this._textureType=l;this._samplers=u||[];this._samplers.push("textureSampler");this._fragmentUrl=i;this._parameters=r||[];this._parameters.push("scale");this.updateEffect(c)}return Object.defineProperty(t.prototype,"onActivate",{set:function(n){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver);this._onActivateObserver=this.onActivateObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onSizeChanged",{set:function(n){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver);this._onSizeChangedObserver=this.onSizeChangedObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onApply",{set:function(n){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver);this._onApplyObserver=this.onApplyObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onBeforeRender",{set:function(n){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver);this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onAfterRender",{set:function(n){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver);this._onAfterRenderObserver=this.onAfterRenderObservable.add(n)},enumerable:!0,configurable:!0}),t.prototype.updateEffect=function(n){this._effect=this._engine.createEffect({vertex:"postprocess",fragment:this._fragmentUrl},["position"],this._parameters,this._samplers,void 0!==n?n:"")},t.prototype.isReusable=function(){return this._reusable},t.prototype.markTextureDirty=function(){this.width=-1},t.prototype.activate=function(t,i){var f,h,c;t=t||this._camera;var e=t.getScene(),l=t.getEngine().getCaps().maxTextureSize,o=(i?i._width:this._engine.getRenderingCanvas().width)*this._options|0,s=(i?i._height:this._engine.getRenderingCanvas().height)*this._options|0,r=this._options.width||o,u=this._options.height||s;if(this.renderTargetSamplingMode!==n.Texture.NEAREST_SAMPLINGMODE&&(this._options.width||(r=n.Tools.GetExponentOfTwo(r,l)),this._options.height||(u=n.Tools.GetExponentOfTwo(u,l))),this.width!==r||this.height!==u){if(this._textures.length>0){for(f=0;f<this._textures.length;f++)this._engine._releaseTexture(this._textures.data[f]);this._textures.reset()}this.width=r;this.height=u;h={width:this.width,height:this.height};c={generateMipMaps:!1,generateDepthBuffer:0===t._postProcesses.indexOf(this),generateStencilBuffer:0===t._postProcesses.indexOf(this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType};this._textures.push(this._engine.createRenderTargetTexture(h,c));this._reusable&&this._textures.push(this._engine.createRenderTargetTexture(h,c));this.onSizeChangedObservable.notifyObservers(this)}this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(o/r,s/u),this._engine.bindFramebuffer(this._textures.data[this._currentRenderTextureInd],0,o,s)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(this._textures.data[this._currentRenderTextureInd]));this.onActivateObservable.notifyObservers(t);this.clearColor?this._engine.clear(this.clearColor,!0,!0,!0):this._engine.clear(e.clearColor,e.autoClear||e.forceWireframe,!0,!0);this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2)},Object.defineProperty(t.prototype,"isSupported",{get:function(){return this._effect.isSupported},enumerable:!0,configurable:!0}),t.prototype.apply=function(){return this._effect.isReady()?(this._engine.enableEffect(this._effect),this._engine.setState(!1),this._engine.setAlphaMode(n.Engine.ALPHA_DISABLE),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._effect._bindTexture("textureSampler",this._textures.data[this._currentRenderTextureInd]),this._effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effect),this._effect):null},t.prototype.dispose=function(n){var t,i;if(n=n||this._camera,this._textures.length>0){for(t=0;t<this._textures.length;t++)this._engine._releaseTexture(this._textures.data[t]);this._textures.reset()}n&&(n.detachPostProcess(this),i=n._postProcesses.indexOf(this),0===i&&n._postProcesses.length>0&&this._camera._postProcesses[0].markTextureDirty(),this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear())},t}();n.PostProcess=t}(i||(i={}));!function(n){var t=function(){function t(n){this._vertexBuffers={};this._scene=n}return t.prototype._prepareBuffers=function(){var i,t;this._vertexBuffers[n.VertexBuffer.PositionKind]||(i=[],i.push(1,1),i.push(-1,1),i.push(-1,-1),i.push(1,-1),this._vertexBuffers[n.VertexBuffer.PositionKind]=new n.VertexBuffer(this._scene.getEngine(),i,n.VertexBuffer.PositionKind,!1,!1,2),t=[],t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(t))},t.prototype._prepareFrame=function(n){var t=this._scene.activeCamera._postProcesses;return!(0===t.length||!this._scene.postProcessesEnabled)&&(t[0].activate(this._scene.activeCamera,n),!0)},t.prototype.directRender=function(n,t){for(var f,u,i=this._scene.getEngine(),r=0;r<n.length;r++)r<n.length-1?n[r+1].activate(this._scene.activeCamera,t):t?i.bindFramebuffer(t):i.restoreDefaultFramebuffer(),f=n[r],u=f.apply(),u&&(f.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),i.bindBuffers(this._vertexBuffers,this._indexBuffer,u),i.draw(!0,0,6),f.onAfterRenderObservable.notifyObservers(u));i.setDepthBuffer(!0);i.setDepthWrite(!0)},t.prototype._finalizeFrame=function(n,t,i,r){var o,e;if(r=r||this._scene.activeCamera._postProcesses,0!==r.length&&this._scene.postProcessesEnabled){for(var u=this._scene.getEngine(),f=0,s=r.length;f<s&&(f<s-1?r[f+1].activate(this._scene.activeCamera,t):t?u.bindFramebuffer(t,i):u.restoreDefaultFramebuffer(),!n);f++)o=r[f],e=o.apply(),e&&(o.onBeforeRenderObservable.notifyObservers(e),this._prepareBuffers(),u.bindBuffers(this._vertexBuffers,this._indexBuffer,e),u.draw(!0,0,6),o.onAfterRenderObservable.notifyObservers(e));u.setDepthBuffer(!0);u.setDepthWrite(!0)}},t.prototype.dispose=function(){var t=this._vertexBuffers[n.VertexBuffer.PositionKind];t&&(t.dispose(),this._vertexBuffers[n.VertexBuffer.PositionKind]=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)},t}();n.PostProcessManager=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r,u,f,e){n.call(this,t,"pass",null,null,i,r,u,f,e)}return u(t,n),t}(n.PostProcess);n.PassPostProcess=t}(i||(i={}));!function(n){var t=function(){function n(n,t){this.type=n;this.jointData=t;t.nativeParams=t.nativeParams||{}}return Object.defineProperty(n.prototype,"physicsJoint",{get:function(){return this._physicsJoint},set:function(n){this._physicsJoint;this._physicsJoint=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"physicsPlugin",{set:function(n){this._physicsPlugin=n},enumerable:!0,configurable:!0}),n.prototype.executeNativeFunction=function(n){n(this._physicsPlugin.world,this._physicsJoint)},n.DistanceJoint=0,n.HingeJoint=1,n.BallAndSocketJoint=2,n.WheelJoint=3,n.SliderJoint=4,n.PrismaticJoint=5,n.UniversalJoint=6,n.Hinge2Joint=n.WheelJoint,n.PointToPointJoint=8,n.SpringJoint=9,n.LockJoint=10,n}(),r,i,f,e;n.PhysicsJoint=t;r=function(n){function i(i){n.call(this,t.DistanceJoint,i)}return u(i,n),i.prototype.updateDistance=function(n,t){this._physicsPlugin.updateDistanceJoint(this,n,t)},i}(t);n.DistanceJoint=r;i=function(n){function t(t,i){n.call(this,t,i)}return u(t,n),t.prototype.setMotor=function(n,t){this._physicsPlugin.setMotor(this,n,t)},t.prototype.setLimit=function(n,t){this._physicsPlugin.setLimit(this,n,t)},t}(t);n.MotorEnabledJoint=i;f=function(n){function i(i){n.call(this,t.HingeJoint,i)}return u(i,n),i.prototype.setMotor=function(n,t){this._physicsPlugin.setMotor(this,n,t)},i.prototype.setLimit=function(n,t){this._physicsPlugin.setLimit(this,n,t)},i}(i);n.HingeJoint=f;e=function(n){function i(i){n.call(this,t.Hinge2Joint,i)}return u(i,n),i.prototype.setMotor=function(n,t,i){void 0===i&&(i=0);this._physicsPlugin.setMotor(this,n,t,i)},i.prototype.setLimit=function(n,t,i){void 0===i&&(i=0);this._physicsPlugin.setLimit(this,n,t,i)},i}(i);n.Hinge2Joint=e}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u){var f=this;return void 0===r&&(r={mass:0}),this.object=t,this.type=i,this._options=r,this._scene=u,this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=[],this._onAfterPhysicsStepCallbacks=[],this._onPhysicsCollideCallbacks=[],this._deltaPosition=n.Vector3.Zero(),this._tmpPositionWithDelta=n.Vector3.Zero(),this._tmpRotationWithDelta=new n.Quaternion,this.beforeStep=function(){f.object.position.subtractToRef(f._deltaPosition,f._tmpPositionWithDelta);f._deltaRotationConjugated?f.object.rotationQuaternion.multiplyToRef(f._deltaRotationConjugated,f._tmpRotationWithDelta):f._tmpRotationWithDelta.copyFrom(f.object.rotationQuaternion);f._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(f,f._tmpPositionWithDelta,f._tmpRotationWithDelta);f._onBeforePhysicsStepCallbacks.forEach(function(n){n(f)})},this.afterStep=function(){f._onAfterPhysicsStepCallbacks.forEach(function(n){n(f)});f._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(f);f.object.position.addInPlace(f._deltaPosition);f._deltaRotation&&f.object.rotationQuaternion.multiplyInPlace(f._deltaRotation)},this.onCollide=function(n){if(f._onPhysicsCollideCallbacks.length){var t=f._physicsEngine.getImpostorWithPhysicsBody(n.body);t&&f._onPhysicsCollideCallbacks.filter(function(n){return n.otherImpostors.indexOf(t)!==-1}).forEach(function(n){n.callback(f,t)})}},this.object?(!this._scene&&t.getScene&&(this._scene=t.getScene()),this._physicsEngine=this._scene.getPhysicsEngine(),void(this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotationQuaternion=this.object.rotation?n.Quaternion.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):new n.Quaternion),this._options.mass=void 0===r.mass?0:r.mass,this._options.friction=void 0===r.friction?.2:r.friction,this._options.restitution=void 0===r.restitution?.2:r.restitution,this._joints=[],this.object.parent||this._init()):n.Tools.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))):void n.Tools.Error("No object was provided. A physics object is obligatory")}return t.prototype._init=function(){this._physicsEngine.removeImpostor(this);this.physicsBody=null;this._parent=this._parent||this._getPhysicsParent();this.parent||this._physicsEngine.addImpostor(this)},t.prototype._getPhysicsParent=function(){if(this.object.parent instanceof n.AbstractMesh){var t=this.object.parent;return t.physicsImpostor}},t.prototype.isBodyInitRequired=function(){return this._bodyUpdateRequired||!this._physicsBody&&!this._parent},t.prototype.setScalingUpdated=function(){this.forceUpdate()},t.prototype.forceUpdate=function(){this._init();this.parent&&this.parent.forceUpdate()},Object.defineProperty(t.prototype,"physicsBody",{get:function(){return this._parent?this._parent.physicsBody:this._physicsBody},set:function(n){this._physicsBody&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this);this._physicsBody=n;this.resetUpdateFlags()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},set:function(n){this._parent=n},enumerable:!0,configurable:!0}),t.prototype.resetUpdateFlags=function(){this._bodyUpdateRequired=!1},t.prototype.getObjectExtendSize=function(){return this.object.getBoundingInfo?(this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiply(this.object.scaling)):t.DEFAULT_OBJECT_SIZE},t.prototype.getObjectCenter=function(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.center:this.object.position},t.prototype.getParam=function(n){return this._options[n]},t.prototype.setParam=function(n,t){this._options[n]=t;this._bodyUpdateRequired=!0},t.prototype.setMass=function(n){this.getParam("mass")!==n&&this.setParam("mass",n);this._physicsEngine.getPhysicsPlugin().setBodyMass(this,n)},t.prototype.getLinearVelocity=function(){return this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this)},t.prototype.setLinearVelocity=function(n){this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,n)},t.prototype.getAngularVelocity=function(){return this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this)},t.prototype.setAngularVelocity=function(n){this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,n)},t.prototype.executeNativeFunction=function(n){n(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)},t.prototype.registerBeforePhysicsStep=function(n){this._onBeforePhysicsStepCallbacks.push(n)},t.prototype.unregisterBeforePhysicsStep=function(t){var i=this._onBeforePhysicsStepCallbacks.indexOf(t);i>-1?this._onBeforePhysicsStepCallbacks.splice(i,1):n.Tools.Warn("Function to remove was not found")},t.prototype.registerAfterPhysicsStep=function(n){this._onAfterPhysicsStepCallbacks.push(n)},t.prototype.unregisterAfterPhysicsStep=function(t){var i=this._onAfterPhysicsStepCallbacks.indexOf(t);i>-1?this._onAfterPhysicsStepCallbacks.splice(i,1):n.Tools.Warn("Function to remove was not found")},t.prototype.registerOnPhysicsCollide=function(n,t){var i=n instanceof Array?n:[n];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})},t.prototype.unregisterOnPhysicsCollide=function(t,i){var u=t instanceof Array?t:[t],r=this._onPhysicsCollideCallbacks.indexOf({callback:i,otherImpostors:u});r>-1?this._onPhysicsCollideCallbacks.splice(r,1):n.Tools.Warn("Function to remove was not found")},t.prototype.applyForce=function(n,t){this._physicsEngine.getPhysicsPlugin().applyForce(this,n,t)},t.prototype.applyImpulse=function(n,t){this._physicsEngine.getPhysicsPlugin().applyImpulse(this,n,t)},t.prototype.createJoint=function(t,i,r){var u=new n.PhysicsJoint(i,r);this.addJoint(t,u)},t.prototype.addJoint=function(n,t){this._joints.push({otherImpostor:n,joint:t});this._physicsEngine.addJoint(this,n,t)},t.prototype.sleep=function(){this._physicsEngine.getPhysicsPlugin().sleepBody(this)},t.prototype.wakeUp=function(){this._physicsEngine.getPhysicsPlugin().wakeUpBody(this)},t.prototype.clone=function(n){return n?new t(n,this.type,this._options,this._scene):null},t.prototype.dispose=function(){var n=this;this._physicsEngine&&(this._joints.forEach(function(t){n._physicsEngine.removeJoint(n,t.otherImpostor,t.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate())},t.prototype.setDeltaPosition=function(n){this._deltaPosition.copyFrom(n)},t.prototype.setDeltaRotation=function(t){this._deltaRotation||(this._deltaRotation=new n.Quaternion);this._deltaRotation.copyFrom(t);this._deltaRotationConjugated=this._deltaRotation.conjugate()},t.DEFAULT_OBJECT_SIZE=new n.Vector3(1,1,1),t.NoImpostor=0,t.SphereImpostor=1,t.BoxImpostor=2,t.PlaneImpostor=3,t.MeshImpostor=4,t.CylinderImpostor=7,t.ParticleImpostor=8,t.HeightmapImpostor=9,t}();n.PhysicsImpostor=t}(i||(i={}));!function(n){var t=function(){function t(t,i){if(void 0===i&&(i=new n.CannonJSPlugin),this._physicsPlugin=i,this._impostors=[],this._joints=[],!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");t=t||new n.Vector3(0,-9.807,0);this.setGravity(t);this.setTimeStep()}return t.prototype.setGravity=function(n){this.gravity=n;this._physicsPlugin.setGravity(this.gravity)},t.prototype.setTimeStep=function(n){void 0===n&&(n=1/60);this._physicsPlugin.setTimeStep(n)},t.prototype.dispose=function(){this._impostors.forEach(function(n){n.dispose()});this._physicsPlugin.dispose()},t.prototype.getPhysicsPluginName=function(){return this._physicsPlugin.name},t.prototype.addImpostor=function(n){n.uniqueId=this._impostors.push(n);n.parent||this._physicsPlugin.generatePhysicsBody(n)},t.prototype.removeImpostor=function(n){var i=this._impostors.indexOf(n),t;i>-1&&(t=this._impostors.splice(i,1),t.length&&(t[0].physicsBody=null))},t.prototype.addJoint=function(n,t,i){var r={mainImpostor:n,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin;this._joints.push(r);this._physicsPlugin.generateJoint(r)},t.prototype.removeJoint=function(n,t,i){var r=this._joints.filter(function(r){return r.connectedImpostor===t&&r.joint===i&&r.mainImpostor===n});r.length&&this._physicsPlugin.removeJoint(r[0])},t.prototype._step=function(n){var t=this;this._impostors.forEach(function(n){n.isBodyInitRequired()&&t._physicsPlugin.generatePhysicsBody(n)});n>.1?n=.1:n<=0&&(n=1/60);this._physicsPlugin.executeStep(n,this._impostors)},t.prototype.getPhysicsPlugin=function(){return this._physicsPlugin},t.prototype.getImpostorForPhysicsObject=function(n){for(var t=0;t<this._impostors.length;++t)if(this._impostors[t].object===n)return this._impostors[t]},t.prototype.getImpostorWithPhysicsBody=function(n){for(var t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===n)return this._impostors[t]},t.NoImpostor=n.PhysicsImpostor.NoImpostor,t.SphereImpostor=n.PhysicsImpostor.SphereImpostor,t.BoxImpostor=n.PhysicsImpostor.BoxImpostor,t.PlaneImpostor=n.PhysicsImpostor.PlaneImpostor,t.MeshImpostor=n.PhysicsImpostor.MeshImpostor,t.CylinderImpostor=n.PhysicsImpostor.CylinderImpostor,t.HeightmapImpostor=n.PhysicsImpostor.HeightmapImpostor,t.CapsuleImpostor=-1,t.ConeImpostor=-1,t.ConvexHullImpostor=-1,t.Epsilon=.001,t}();n.PhysicsEngine=t}(i||(i={}));!function(n){var t=function(){function t(){}return t.prototype.set=function(t,i){switch(i){case n.VertexBuffer.PositionKind:this.positions=t;break;case n.VertexBuffer.NormalKind:this.normals=t;break;case n.VertexBuffer.UVKind:this.uvs=t;break;case n.VertexBuffer.UV2Kind:this.uvs2=t;break;case n.VertexBuffer.UV3Kind:this.uvs3=t;break;case n.VertexBuffer.UV4Kind:this.uvs4=t;break;case n.VertexBuffer.UV5Kind:this.uvs5=t;break;case n.VertexBuffer.UV6Kind:this.uvs6=t;break;case n.VertexBuffer.ColorKind:this.colors=t;break;case n.VertexBuffer.MatricesIndicesKind:this.matricesIndices=t;break;case n.VertexBuffer.MatricesWeightsKind:this.matricesWeights=t;break;case n.VertexBuffer.MatricesIndicesExtraKind:this.matricesIndicesExtra=t;break;case n.VertexBuffer.MatricesWeightsExtraKind:this.matricesWeightsExtra=t}},t.prototype.applyToMesh=function(n,t){this._applyTo(n,t)},t.prototype.applyToGeometry=function(n,t){this._applyTo(n,t)},t.prototype.updateMesh=function(n){this._update(n)},t.prototype.updateGeometry=function(n){this._update(n)},t.prototype._applyTo=function(t,i){this.positions&&t.setVerticesData(n.VertexBuffer.PositionKind,this.positions,i);this.normals&&t.setVerticesData(n.VertexBuffer.NormalKind,this.normals,i);this.uvs&&t.setVerticesData(n.VertexBuffer.UVKind,this.uvs,i);this.uvs2&&t.setVerticesData(n.VertexBuffer.UV2Kind,this.uvs2,i);this.uvs3&&t.setVerticesData(n.VertexBuffer.UV3Kind,this.uvs3,i);this.uvs4&&t.setVerticesData(n.VertexBuffer.UV4Kind,this.uvs4,i);this.uvs5&&t.setVerticesData(n.VertexBuffer.UV5Kind,this.uvs5,i);this.uvs6&&t.setVerticesData(n.VertexBuffer.UV6Kind,this.uvs6,i);this.colors&&t.setVerticesData(n.VertexBuffer.ColorKind,this.colors,i);this.matricesIndices&&t.setVerticesData(n.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i);this.matricesWeights&&t.setVerticesData(n.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i);this.matricesIndicesExtra&&t.setVerticesData(n.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,i);this.matricesWeightsExtra&&t.setVerticesData(n.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,i);this.indices&&t.setIndices(this.indices)},t.prototype._update=function(t,i,r){this.positions&&t.updateVerticesData(n.VertexBuffer.PositionKind,this.positions,i,r);this.normals&&t.updateVerticesData(n.VertexBuffer.NormalKind,this.normals,i,r);this.uvs&&t.updateVerticesData(n.VertexBuffer.UVKind,this.uvs,i,r);this.uvs2&&t.updateVerticesData(n.VertexBuffer.UV2Kind,this.uvs2,i,r);this.uvs3&&t.updateVerticesData(n.VertexBuffer.UV3Kind,this.uvs3,i,r);this.uvs4&&t.updateVerticesData(n.VertexBuffer.UV4Kind,this.uvs4,i,r);this.uvs5&&t.updateVerticesData(n.VertexBuffer.UV5Kind,this.uvs5,i,r);this.uvs6&&t.updateVerticesData(n.VertexBuffer.UV6Kind,this.uvs6,i,r);this.colors&&t.updateVerticesData(n.VertexBuffer.ColorKind,this.colors,i,r);this.matricesIndices&&t.updateVerticesData(n.VertexBuffer.MatricesIndicesKind,this.matricesIndices,i,r);this.matricesWeights&&t.updateVerticesData(n.VertexBuffer.MatricesWeightsKind,this.matricesWeights,i,r);this.matricesIndicesExtra&&t.updateVerticesData(n.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,i,r);this.matricesWeightsExtra&&t.updateVerticesData(n.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,i,r);this.indices&&t.setIndices(this.indices)},t.prototype.transform=function(t){var i,r=n.Vector3.Zero(),u,f;if(this.positions)for(u=n.Vector3.Zero(),i=0;i<this.positions.length;i+=3)n.Vector3.FromArrayToRef(this.positions,i,u),n.Vector3.TransformCoordinatesToRef(u,t,r),this.positions[i]=r.x,this.positions[i+1]=r.y,this.positions[i+2]=r.z;if(this.normals)for(f=n.Vector3.Zero(),i=0;i<this.normals.length;i+=3)n.Vector3.FromArrayToRef(this.normals,i,f),n.Vector3.TransformNormalToRef(f,t,r),this.normals[i]=r.x,this.normals[i+1]=r.y,this.normals[i+2]=r.z},t.prototype.merge=function(n){if(n.indices){this.indices||(this.indices=[]);for(var i=this.positions?this.positions.length/3:0,t=0;t<n.indices.length;t++)this.indices.push(n.indices[t]+i)}this.positions=this._mergeElement(this.positions,n.positions);this.normals=this._mergeElement(this.normals,n.normals);this.uvs=this._mergeElement(this.uvs,n.uvs);this.uvs2=this._mergeElement(this.uvs2,n.uvs2);this.uvs3=this._mergeElement(this.uvs3,n.uvs3);this.uvs4=this._mergeElement(this.uvs4,n.uvs4);this.uvs5=this._mergeElement(this.uvs5,n.uvs5);this.uvs6=this._mergeElement(this.uvs6,n.uvs6);this.colors=this._mergeElement(this.colors,n.colors);this.matricesIndices=this._mergeElement(this.matricesIndices,n.matricesIndices);this.matricesWeights=this._mergeElement(this.matricesWeights,n.matricesWeights);this.matricesIndicesExtra=this._mergeElement(this.matricesIndicesExtra,n.matricesIndicesExtra);this.matricesWeightsExtra=this._mergeElement(this.matricesWeightsExtra,n.matricesWeightsExtra)},t.prototype._mergeElement=function(n,t){var i;if(!t)return n;if(!n)return t;var u=t.length+n.length,e=n instanceof Float32Array,o=t instanceof Float32Array;if(e)return i=new Float32Array(u),i.set(n),i.set(t,n.length),i;if(o){for(var f=n.slice(0),r=0,u=t.length;r<u;r++)f.push(t[r]);return f}return n.concat(t)},t.prototype.serialize=function(){var n=this.serialize();return this.positions&&(n.positions=this.positions),this.normals&&(n.normals=this.normals),this.uvs&&(n.uvs=this.uvs),this.uvs2&&(n.uvs2=this.uvs2),this.uvs3&&(n.uvs3=this.uvs3),this.uvs4&&(n.uvs4=this.uvs4),this.uvs5&&(n.uvs5=this.uvs5),this.uvs6&&(n.uvs6=this.uvs6),this.colors&&(n.colors=this.colors),this.matricesIndices&&(n.matricesIndices=this.matricesIndices,n.matricesIndices._isExpanded=!0),this.matricesWeights&&(n.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(n.matricesIndicesExtra=this.matricesIndicesExtra,n.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(n.matricesWeightsExtra=this.matricesWeightsExtra),n.indices=this.indices,n},t.ExtractFromMesh=function(n,i){return t._ExtractFrom(n,i)},t.ExtractFromGeometry=function(n,i){return t._ExtractFrom(n,i)},t._ExtractFrom=function(i,r){var u=new t;return i.isVerticesDataPresent(n.VertexBuffer.PositionKind)&&(u.positions=i.getVerticesData(n.VertexBuffer.PositionKind,r)),i.isVerticesDataPresent(n.VertexBuffer.NormalKind)&&(u.normals=i.getVerticesData(n.VertexBuffer.NormalKind,r)),i.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(u.uvs=i.getVerticesData(n.VertexBuffer.UVKind,r)),i.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&(u.uvs2=i.getVerticesData(n.VertexBuffer.UV2Kind,r)),i.isVerticesDataPresent(n.VertexBuffer.UV3Kind)&&(u.uvs3=i.getVerticesData(n.VertexBuffer.UV3Kind,r)),i.isVerticesDataPresent(n.VertexBuffer.UV4Kind)&&(u.uvs4=i.getVerticesData(n.VertexBuffer.UV4Kind,r)),i.isVerticesDataPresent(n.VertexBuffer.UV5Kind)&&(u.uvs5=i.getVerticesData(n.VertexBuffer.UV5Kind,r)),i.isVerticesDataPresent(n.VertexBuffer.UV6Kind)&&(u.uvs6=i.getVerticesData(n.VertexBuffer.UV6Kind,r)),i.isVerticesDataPresent(n.VertexBuffer.ColorKind)&&(u.colors=i.getVerticesData(n.VertexBuffer.ColorKind,r)),i.isVerticesDataPresent(n.VertexBuffer.MatricesIndicesKind)&&(u.matricesIndices=i.getVerticesData(n.VertexBuffer.MatricesIndicesKind,r)),i.isVerticesDataPresent(n.VertexBuffer.MatricesWeightsKind)&&(u.matricesWeights=i.getVerticesData(n.VertexBuffer.MatricesWeightsKind,r)),i.isVerticesDataPresent(n.VertexBuffer.MatricesIndicesExtraKind)&&(u.matricesIndicesExtra=i.getVerticesData(n.VertexBuffer.MatricesIndicesExtraKind,r)),i.isVerticesDataPresent(n.VertexBuffer.MatricesWeightsExtraKind)&&(u.matricesWeightsExtra=i.getVerticesData(n.VertexBuffer.MatricesWeightsExtraKind,r)),u.indices=i.getIndices(r),u},t.CreateRibbon=function(i){var e=i.pathArray,ti=i.closeArray||!1,ht=i.closePath||!1,ii=i.invertUV||!1,yt=Math.floor(e[0].length/2),it=i.offset||yt,wt,bt,o,g,kt,ft,p,l,at,et,vt,ot,dt,gt,a,w,b;it=it>yt?yt:Math.floor(it);var y,r,u,h,ri=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,rt=[],ut=[],f=[],ct=[],lt=[],pt=[],k=[],d=[],v=[],c=[];if(e.length<2){for(wt=[],bt=[],u=0;u<e[0].length-it;u++)wt.push(e[0][u]),bt.push(e[0][u+it]);e=[wt,bt]}for(kt=0,ft=ht?1:0,y=e[0].length,r=0;r<e.length;r++){for(k[r]=0,lt[r]=[0],o=e[r],g=o.length,y=y<g?y:g,h=0;h<g;)rt.push(o[h].x,o[h].y,o[h].z),h>0&&(p=o[h].subtract(o[h-1]).length(),l=p+k[r],lt[r].push(l),k[r]=l),h++;ht&&(h--,rt.push(o[0].x,o[0].y,o[0].z),p=o[h].subtract(o[0]).length(),l=p+k[r],lt[r].push(l),k[r]=l);v[r]=g+ft;c[r]=kt;kt+=g+ft}for(u=0;u<y+ft;u++){for(d[u]=0,pt[u]=[0],r=0;r<e.length-1;r++)at=e[r],et=e[r+1],u===y?(vt=at[0],ot=et[0]):(vt=at[u],ot=et[u]),p=ot.subtract(vt).length(),l=p+d[u],pt[u].push(l),d[u]=l;ti&&(at=e[r],et=e[0],u===y&&(ot=et[0]),p=ot.subtract(vt).length(),l=p+d[u],d[u]=l)}for(r=0;r<e.length;r++)for(u=0;u<y+ft;u++)dt=lt[r][u]/k[r],gt=pt[u][r]/d[u],ii?ct.push(gt,dt):ct.push(dt,gt);r=0;for(var s=0,nt=v[r]-1,tt=v[r+1]-1,ni=nt<tt?nt:tt,st=c[1]-c[0],ui=ti?v.length:v.length-1;s<=ni&&r<ui;)ut.push(s,s+st,s+1),ut.push(s+st+1,s+1,s+st),s+=1,s===ni&&(r++,r===v.length-1?(st=c[0]-c[r],nt=v[r]-1,tt=v[0]-1):(st=c[r+1]-c[r],nt=v[r]-1,tt=v[r+1]-1),s=c[r],ni=nt<tt?nt+s:tt+s);if(t.ComputeNormals(rt,ut,f),ht)for(a=0,w=0,r=0;r<e.length;r++)a=3*c[r],w=r+1<e.length?3*(c[r+1]-1):f.length-3,f[a]=.5*(f[a]+f[w]),f[a+1]=.5*(f[a+1]+f[w+1]),f[a+2]=.5*(f[a+2]+f[w+2]),f[w]=f[a],f[w+1]=f[a+1],f[w+2]=f[a+2];return t._ComputeSides(ri,rt,ut,f,ct),b=new t,b.indices=ut,b.positions=rt,b.normals=f,b.uvs=ct,ht&&(b._idx=c),b},t.CreateBox=function(i){for(var w,r,e,l,nt,d=[new n.Vector3(0,0,1),new n.Vector3(0,0,-1),new n.Vector3(1,0,0),new n.Vector3(-1,0,0),new n.Vector3(0,1,0),new n.Vector3(0,-1,0)],s=[],h=[],a=[],v=[],tt=i.width||i.size||1,it=i.height||i.size||1,rt=i.depth||i.size||1,g=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,o=i.faceUV||new Array(6),u=i.faceColors,c=[],y=0;y<6;y++)void 0===o[y]&&(o[y]=new n.Vector4(0,0,1,1)),u&&void 0===u[y]&&(u[y]=new n.Color4(1,1,1,1));for(w=new n.Vector3(tt/2,it/2,rt/2),r=0;r<d.length;r++){var f=d[r],b=new n.Vector3(f.y,f.z,f.x),k=n.Vector3.Cross(f,b),p=h.length/3;s.push(p);s.push(p+1);s.push(p+2);s.push(p);s.push(p+2);s.push(p+3);e=f.subtract(b).subtract(k).multiply(w);h.push(e.x,e.y,e.z);a.push(f.x,f.y,f.z);v.push(o[r].z,o[r].w);u&&c.push(u[r].r,u[r].g,u[r].b,u[r].a);e=f.subtract(b).add(k).multiply(w);h.push(e.x,e.y,e.z);a.push(f.x,f.y,f.z);v.push(o[r].x,o[r].w);u&&c.push(u[r].r,u[r].g,u[r].b,u[r].a);e=f.add(b).add(k).multiply(w);h.push(e.x,e.y,e.z);a.push(f.x,f.y,f.z);v.push(o[r].x,o[r].y);u&&c.push(u[r].r,u[r].g,u[r].b,u[r].a);e=f.add(b).subtract(k).multiply(w);h.push(e.x,e.y,e.z);a.push(f.x,f.y,f.z);v.push(o[r].z,o[r].y);u&&c.push(u[r].r,u[r].g,u[r].b,u[r].a)}return t._ComputeSides(g,h,s,a,v),l=new t,(l.indices=s,l.positions=h,l.normals=a,l.uvs=v,u)&&(nt=g===n.Mesh.DOUBLESIDE?c.concat(c):c,l.colors=nt),l},t.CreateSphere=function(i){for(var p,r,e,g=i.segments||32,nt=i.diameterX||i.diameter||1,tt=i.diameterY||i.diameter||1,it=i.diameterZ||i.diameter||1,rt=i.arc<=0||i.arc>1?1:i.arc||1,ut=i.slice<=0?1:i.slice||1,ft=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,w=new n.Vector3(nt/2,tt/2,it/2),h=2+g,f=2*h,u=[],o=[],c=[],l=[],s=0;s<=h;s++){for(var b=s/h,et=b*Math.PI*ut,a=0;a<=f;a++){var k=a/f,ot=k*Math.PI*2*rt,st=n.Matrix.RotationZ(-et),ht=n.Matrix.RotationY(ot),ct=n.Vector3.TransformCoordinates(n.Vector3.Up(),st),d=n.Vector3.TransformCoordinates(ct,ht),v=d.multiply(w),y=d.divide(w).normalize();o.push(v.x,v.y,v.z);c.push(y.x,y.y,y.z);l.push(k,b)}if(s>0)for(p=o.length/3,r=p-2*(f+1);r+f+2<p;r++)u.push(r),u.push(r+1),u.push(r+f+1),u.push(r+f+1),u.push(r+1),u.push(r+f+2)}return t._ComputeSides(ft,o,u,c,l),e=new t,e.indices=u,e.positions=o,e.normals=c,e.uvs=l,e},t.CreateCylinder=function(i){for(var ft=i.height||2,ct=0===i.diameterTop?0:i.diameterTop||i.diameter||1,lt=0===i.diameterBottom?0:i.diameterBottom||i.diameter||1,v=i.tessellation||24,nt=i.subdivisions||1,d=i.hasRings,et=i.enclose,tt=i.arc<=0||i.arc>1?1:i.arc||1,ti=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,f=i.faceUV||new Array(3),u=i.faceColors,ii=1!==tt&&et?2:0,ri=d?nt:1,at=2+(1+ii)*ri,r,ht,kt,g,y=0;y<at;y++)u&&void 0===u[y]&&(u[y]=new n.Color4(1,1,1,1));for(y=0;y<at;y++)f&&void 0===f[y]&&(f[y]=new n.Vector4(0,0,1,1));for(var yt,it,pt,l,ot,h=[],p=[],a=[],w=[],b=[],ui=2*Math.PI*tt/v,fi=(lt-ct)/2/ft,c=n.Vector3.Zero(),e=n.Vector3.Zero(),vt=n.Vector3.Zero(),dt=n.Vector3.Zero(),o=n.Vector3.Zero(),gt=n.Axis.Y,ni=1,r=1,st=0,k=0,s=0;s<=nt;s++)for(it=s/nt,pt=(it*(ct-lt)+lt)/2,ni=d&&0!==s&&s!==nt?2:1,ot=0;ot<ni;ot++){for(d&&(r+=ot),et&&(r+=2*ot),l=0;l<=v;l++)yt=l*ui,c.x=Math.cos(-yt)*pt,c.y=-ft/2+it*ft,c.z=Math.sin(-yt)*pt,0===ct&&s===nt?(e.x=a[a.length-3*(v+1)],e.y=a[a.length-3*(v+1)+1],e.z=a[a.length-3*(v+1)+2]):(e.x=c.x,e.z=c.z,e.y=Math.sqrt(e.x*e.x+e.z*e.z)*fi,e.normalize()),0===l&&(vt.copyFrom(c),dt.copyFrom(e)),p.push(c.x,c.y,c.z),a.push(e.x,e.y,e.z),k=d?st!==r?f[r].y:f[r].w:f[r].y+(f[r].w-f[r].y)*it,w.push(f[r].x+(f[r].z-f[r].x)*l/v,k),u&&b.push(u[r].r,u[r].g,u[r].b,u[r].a);1!==tt&&et&&(p.push(c.x,c.y,c.z),p.push(0,c.y,0),p.push(0,c.y,0),p.push(vt.x,vt.y,vt.z),n.Vector3.CrossToRef(gt,e,o),o.normalize(),a.push(o.x,o.y,o.z,o.x,o.y,o.z),n.Vector3.CrossToRef(dt,gt,o),o.normalize(),a.push(o.x,o.y,o.z,o.x,o.y,o.z),k=d?st!==r?f[r+1].y:f[r+1].w:f[r+1].y+(f[r+1].w-f[r+1].y)*it,w.push(f[r+1].x,k),w.push(f[r+1].z,k),k=d?st!==r?f[r+2].y:f[r+2].w:f[r+2].y+(f[r+2].w-f[r+2].y)*it,w.push(f[r+2].x,k),w.push(f[r+2].z,k),u&&(b.push(u[r+1].r,u[r+1].g,u[r+1].b,u[r+1].a),b.push(u[r+1].r,u[r+1].g,u[r+1].b,u[r+1].a),b.push(u[r+2].r,u[r+2].g,u[r+2].b,u[r+2].a),b.push(u[r+2].r,u[r+2].g,u[r+2].b,u[r+2].a)));st!==r&&(st=r)}for(ht=1!==tt&&et?v+4:v,s=0,r=0;r<nt;r++){for(l=0;l<v;l++){var wt=s*(ht+1)+l,rt=(s+1)*(ht+1)+l,ut=s*(ht+1)+(l+1),bt=(s+1)*(ht+1)+(l+1);h.push(wt,rt,ut);h.push(bt,ut,rt)}1!==tt&&et&&(h.push(wt+2,rt+2,ut+2),h.push(bt+2,ut+2,rt+2),h.push(wt+4,rt+4,ut+4),h.push(bt+4,ut+4,rt+4));s=d?s+2:s+1}return kt=function(t){var c=t?ct/2:lt/2,l,s,r,e,i,k,d,g,nt;if(0!==c){i=t?f[at-1]:f[0];u&&(e=t?u[at-1]:u[0]);var o=p.length/3,it=t?ft/2:-ft/2,y=new n.Vector3(0,it,0);for(p.push(y.x,y.y,y.z),a.push(0,t?1:-1,0),w.push(i.x+.5*(i.z-i.x),i.y+.5*(i.w-i.y)),u&&b.push(e.r,e.g,e.b,e.a),k=new n.Vector2(.5,.5),r=0;r<=v;r++)l=2*Math.PI*r*tt/v,d=Math.cos(-l),g=Math.sin(-l),s=new n.Vector3(d*c,it,g*c),nt=new n.Vector2(d*k.x+.5,g*k.y+.5),p.push(s.x,s.y,s.z),a.push(0,t?1:-1,0),w.push(i.x+(i.z-i.x)*nt.x,i.y+(i.w-i.y)*nt.y),u&&b.push(e.r,e.g,e.b,e.a);for(r=0;r<v;r++)t?(h.push(o),h.push(o+(r+2)),h.push(o+(r+1))):(h.push(o),h.push(o+(r+1)),h.push(o+(r+2)))}},kt(!1),kt(!0),t._ComputeSides(ti,p,h,a,w),g=new t,g.indices=h,g.positions=p,g.normals=a,g.uvs=w,u&&(g.colors=b),g},t.CreateTorus=function(i){for(var l,a,h,r=[],v=[],y=[],p=[],d=i.diameter||1,g=i.thickness||.5,o=i.tessellation||16,nt=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,u=o+1,f=0;f<=o;f++)for(var tt=f/o,it=f*Math.PI*2/o-Math.PI/2,w=n.Matrix.Translation(d/2,0,0).multiply(n.Matrix.RotationY(it)),e=0;e<=o;e++){var rt=1-e/o,b=e*Math.PI*2/o+Math.PI,ut=Math.cos(b),ft=Math.sin(b),s=new n.Vector3(ut,ft,0),c=s.scale(g/2),k=new n.Vector2(tt,rt);c=n.Vector3.TransformCoordinates(c,w);s=n.Vector3.TransformNormal(s,w);v.push(c.x,c.y,c.z);y.push(s.x,s.y,s.z);p.push(k.x,k.y);l=(f+1)%u;a=(e+1)%u;r.push(f*u+e);r.push(f*u+a);r.push(l*u+e);r.push(f*u+a);r.push(l*u+a);r.push(l*u+e)}return t._ComputeSides(nt,v,r,y,p),h=new t,h.indices=r,h.positions=v,h.normals=y,h.uvs=p,h},t.CreateLineSystem=function(n){for(var r,i,u,f=[],s=[],h=n.lines,e=0,o=0;o<h.length;o++)for(r=h[o],i=0;i<r.length;i++)s.push(r[i].x,r[i].y,r[i].z),i>0&&(f.push(e-1),f.push(e)),e++;return u=new t,u.indices=f,u.positions=s,u},t.CreateDashedLines=function(i){for(var v=i.dashSize||3,b=i.gapSize||1,k=i.dashNb||200,u=i.points,l=[],y=[],f=n.Vector3.Zero(),p=0,w=0,o=0,s=0,e=0,a=0,r=0,h,c,r=0;r<u.length-1;r++)u[r+1].subtractToRef(u[r],f),p+=f.length();for(o=p/k,s=v*o/(v+b),r=0;r<u.length-1;r++)for(u[r+1].subtractToRef(u[r],f),w=Math.floor(f.length()/o),f.normalize(),h=0;h<w;h++)e=o*h,l.push(u[r].x+e*f.x,u[r].y+e*f.y,u[r].z+e*f.z),l.push(u[r].x+(e+s)*f.x,u[r].y+(e+s)*f.y,u[r].z+(e+s)*f.z),y.push(a,a+1),a+=2;return c=new t,c.positions=l,c.indices=y,c},t.CreateGround=function(i){for(var u,e=[],l=[],a=[],v=[],y=i.width||1,p=i.height||1,f=i.subdivisionsX||i.subdivisions||1,s=i.subdivisionsY||i.subdivisions||1,h,c,o,r=0;r<=s;r++)for(u=0;u<=f;u++)h=new n.Vector3(u*y/f-y/2,0,(s-r)*p/s-p/2),c=new n.Vector3(0,1,0),l.push(h.x,h.y,h.z),a.push(c.x,c.y,c.z),v.push(u/f,1-r/f);for(r=0;r<s;r++)for(u=0;u<f;u++)e.push(u+1+(r+1)*(f+1)),e.push(u+1+r*(f+1)),e.push(u+r*(f+1)),e.push(u+(r+1)*(f+1)),e.push(u+1+(r+1)*(f+1)),e.push(u+r*(f+1));return o=new t,o.indices=e,o.positions=l,o.normals=a,o.uvs=v,o},t.CreateTiledGround=function(i){function b(t,i,e,s){var l=y.length/3,a=r.w+1,h,c,v;for(u=0;u<r.h;u++)for(f=0;f<r.w;f++)h=[l+f+u*a,l+(f+1)+u*a,l+(f+1)+(u+1)*a,l+f+(u+1)*a],o.push(h[1]),o.push(h[2]),o.push(h[3]),o.push(h[0]),o.push(h[1]),o.push(h[3]);for(c=n.Vector3.Zero(),v=new n.Vector3(0,1,0),u=0;u<=r.h;u++)for(c.z=u*(s-i)/r.h+i,f=0;f<=r.w;f++)c.x=f*(e-t)/r.w+t,c.y=0,y.push(c.x,c.y,c.z),p.push(v.x,v.y,v.z),w.push(f/r.w,u/r.h)}var u,f,h,c,a=i.xmin||-1,v=i.zmin||-1,k=i.xmax||1,d=i.zmax||1,e=i.subdivisions||{w:1,h:1},r=i.precision||{w:1,h:1},o=[],y=[],p=[],w=[],l,s;for(e.h=e.h<1?1:e.h,e.w=e.w<1?1:e.w,r.w=r.w<1?1:r.w,r.h=r.h<1?1:r.h,l={w:(k-a)/e.w,h:(d-v)/e.h},h=0;h<e.h;h++)for(c=0;c<e.w;c++)b(a+c*l.w,v+h*l.h,a+(c+1)*l.w,v+(h+1)*l.h);return s=new t,s.indices=o,s.positions=y,s.normals=p,s.uvs=w,s},t.CreateGroundFromHeightMap=function(i){for(var u,f=[],s=[],h=[],l=[],o,r=0;r<=i.subdivisions;r++)for(u=0;u<=i.subdivisions;u++){var e=new n.Vector3(u*i.width/i.subdivisions-i.width/2,0,(i.subdivisions-r)*i.height/i.subdivisions-i.height/2),a=(e.x+i.width/2)/i.width*(i.bufferWidth-1)|0,v=(1-(e.z+i.height/2)/i.height)*(i.bufferHeight-1)|0,c=4*(a+v*i.bufferWidth),y=i.buffer[c]/255,p=i.buffer[c+1]/255,w=i.buffer[c+2]/255,b=.3*y+.59*p+.11*w;e.y=i.minHeight+(i.maxHeight-i.minHeight)*b;s.push(e.x,e.y,e.z);h.push(0,0,0);l.push(u/i.subdivisions,1-r/i.subdivisions)}for(r=0;r<i.subdivisions;r++)for(u=0;u<i.subdivisions;u++)f.push(u+1+(r+1)*(i.subdivisions+1)),f.push(u+1+r*(i.subdivisions+1)),f.push(u+r*(i.subdivisions+1)),f.push(u+(r+1)*(i.subdivisions+1)),f.push(u+1+(r+1)*(i.subdivisions+1)),f.push(u+r*(i.subdivisions+1));return t.ComputeNormals(s,f,h),o=new t,o.indices=f,o.positions=s,o.normals=h,o.uvs=l,o},t.CreatePlane=function(i){var r=[],u=[],f=[],e=[],c=i.width||i.size||1,l=i.height||i.size||1,a=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,s=c/2,h=l/2,o;return u.push(-s,-h,0),f.push(0,0,-1),e.push(0,0),u.push(s,-h,0),f.push(0,0,-1),e.push(1,0),u.push(s,h,0),f.push(0,0,-1),e.push(1,1),u.push(-s,h,0),f.push(0,0,-1),e.push(0,1),r.push(0),r.push(1),r.push(2),r.push(0),r.push(2),r.push(3),t._ComputeSides(a,u,r,f,e),o=new t,o.indices=r,o.positions=u,o.normals=f,o.uvs=e,o},t.CreateDisc=function(i){var r=[],o=[],h=[],u=[],c=i.radius||.5,w=i.tessellation||64,l=i.arc<=0||i.arc>1?1:i.arc||1,b=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,p,e,f;r.push(0,0,0);u.push(.5,.5);for(var a=2*Math.PI*l,k=a/w,s=0;s<a;s+=k){var v=Math.cos(s),y=Math.sin(s),d=(v+1)/2,g=(1-y)/2;r.push(c*v,c*y,0);u.push(d,g)}for(1===l&&(r.push(r[3],r[4],r[5]),u.push(u[2],u[3])),p=r.length/3,e=1;e<p-1;e++)o.push(e+1,0,e);return t.ComputeNormals(r,o,h),t._ComputeSides(b,r,o,h,u),f=new t,f.indices=o,f.positions=r,f.normals=h,f.uvs=u,f},t.CreateIcoSphere=function(i){for(var et=i.sideOrientation||n.Mesh.DEFAULTSIDE,y=i.radius||1,ot=void 0===i.flat||i.flat,f=i.subdivisions||4,nt=i.radiusX||y,tt=i.radiusY||y,it=i.radiusZ||y,o=(1+Math.sqrt(5))/2,p=[-1,o,-0,1,o,0,-1,-o,0,1,-o,0,0,-1,-o,0,1,-o,0,-1,o,0,1,o,o,0,1,o,0,-1,-o,0,1,-o,0,-1],st=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],w=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],rt=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],ut=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],b=[],k=[],d=[],g=[],ft=0,s=new Array(3),h=new Array(3),l,a,c,r,u,v,e=0;e<3;e++)s[e]=n.Vector3.Zero(),h[e]=n.Vector2.Zero();for(l=0;l<20;l++){for(e=0;e<3;e++)a=st[3*l+e],s[e].copyFromFloats(p[3*w[a]],p[3*w[a]+1],p[3*w[a]+2]),s[e].normalize().scaleInPlace(y),h[e].copyFromFloats(rt[2*a]*(138/1024)+60/1024+ut[l]*(-40/1024),rt[2*a+1]*(239/1024)+26/1024+ut[l]*(20/1024));for(c=function(t,i,r,u){var v=n.Vector3.Lerp(s[0],s[2],i/f),y=n.Vector3.Lerp(s[1],s[2],i/f),o=f===i?s[2]:n.Vector3.Lerp(v,y,t/(f-i)),e,c,l;o.normalize();ot?(c=n.Vector3.Lerp(s[0],s[2],u/f),l=n.Vector3.Lerp(s[1],s[2],u/f),e=n.Vector3.Lerp(c,l,r/(f-u))):e=new n.Vector3(o.x,o.y,o.z);e.x/=nt;e.y/=tt;e.z/=it;e.normalize();var p=n.Vector2.Lerp(h[0],h[2],i/f),w=n.Vector2.Lerp(h[1],h[2],i/f),a=f===i?h[2]:n.Vector2.Lerp(p,w,t/(f-i));k.push(o.x*nt,o.y*tt,o.z*it);d.push(e.x,e.y,e.z);g.push(a.x,a.y);b.push(ft);ft++},r=0;r<f;r++)for(u=0;u+r<f;u++)c(u,r,u+1/3,r+1/3),c(u+1,r,u+1/3,r+1/3),c(u,r+1,u+1/3,r+1/3),u+r+1<f&&(c(u+1,r,u+2/3,r+2/3),c(u+1,r+1,u+2/3,r+2/3),c(u,r+1,u+2/3,r+2/3))}return t._ComputeSides(et,k,b,d,g),v=new t,v.indices=b,v.positions=k,v.normals=d,v.uvs=g,v},t.CreatePolyhedron=function(i){var f=[],p,h;f[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]};f[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]};f[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]};f[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]};f[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]};f[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]};f[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]};f[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]};f[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]};f[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]};f[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]};f[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]};f[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]};f[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]};f[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var it,rt,c,l,a,ut,ct=i.type<0||i.type>=f.length?0:i.type||0,g=i.size,ft=i.sizeX||g||1,et=i.sizeY||g||1,ot=i.sizeZ||g||1,e=i.custom||f[ct],w=e.face.length,o=i.faceUV||new Array(w),s=i.faceColors,nt=void 0===i.flat||i.flat,lt=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,v=[],y=[],tt=[],b=[],st=[],ht=0,k=0,d=[],u=0,r=0;if(nt)for(r=0;r<w;r++)s&&void 0===s[r]&&(s[r]=new n.Color4(1,1,1,1)),o&&void 0===o[r]&&(o[r]=new n.Vector4(0,0,1,1));if(nt)for(r=0;r<w;r++){for(p=e.face[r].length,c=2*Math.PI/p,l=.5*Math.tan(c/2),a=.5,u=0;u<p;u++)v.push(e.vertex[e.face[r][u]][0]*ft,e.vertex[e.face[r][u]][1]*et,e.vertex[e.face[r][u]][2]*ot),d.push(ht),ht++,it=o[r].x+(o[r].z-o[r].x)*(.5+l),rt=o[r].y+(o[r].w-o[r].y)*(a-.5),b.push(it,rt),ut=l*Math.cos(c)-a*Math.sin(c),a=l*Math.sin(c)+a*Math.cos(c),l=ut,s&&st.push(s[r].r,s[r].g,s[r].b,s[r].a);for(u=0;u<p-2;u++)y.push(d[0+k],d[u+2+k],d[u+1+k]);k+=p}else{for(u=0;u<e.vertex.length;u++)v.push(e.vertex[u][0]*ft,e.vertex[u][1]*et,e.vertex[u][2]*ot),b.push(0,0);for(r=0;r<w;r++)for(u=0;u<e.face[r].length-2;u++)y.push(e.face[r][0],e.face[r][u+2],e.face[r][u+1])}return t.ComputeNormals(v,y,tt),t._ComputeSides(lt,v,y,tt,b),h=new t,h.positions=v,h.indices=y,h.normals=tt,h.uvs=b,s&&nt&&(h.colors=st),h},t.CreateTorusKnot=function(i){for(var u,e=[],o=[],y=[],v=[],p=i.radius||2,k=i.tube||.5,c=i.radialSegments||32,f=i.tubularSegments||32,d=i.p||2,ot=i.q||3,st=0===i.sideOrientation?0:i.sideOrientation||n.Mesh.DEFAULTSIDE,g=function(t){var u=Math.cos(t),f=Math.sin(t),i=ot/d*t,r=Math.cos(i),e=p*(2+r)*.5*u,o=p*(2+r)*f*.5,s=p*Math.sin(i)*.5;return new n.Vector3(e,o,s)},h,r=0;r<=c;r++){var ht=r%c,nt=ht/c*2*d*Math.PI,l=g(nt),tt=g(nt+.01),it=tt.subtract(l),s=tt.add(l),a=n.Vector3.Cross(it,s);for(s=n.Vector3.Cross(a,it),a.normalize(),s.normalize(),u=0;u<f;u++){var ct=u%f,rt=ct/f*2*Math.PI,w=-k*Math.cos(rt),b=k*Math.sin(rt);o.push(l.x+w*s.x+b*a.x);o.push(l.y+w*s.y+b*a.y);o.push(l.z+w*s.z+b*a.z);v.push(r/c);v.push(u/f)}}for(r=0;r<c;r++)for(u=0;u<f;u++){var ut=(u+1)%f,lt=r*f+u,ft=(r+1)*f+u,at=(r+1)*f+ut,et=r*f+ut;e.push(et);e.push(ft);e.push(lt);e.push(et);e.push(at);e.push(ft)}return t.ComputeNormals(o,e,y),t._ComputeSides(st,o,e,y,v),h=new t,h.indices=e,h.positions=o,h.normals=y,h.uvs=v,h},t.ComputeNormals=function(n,t,i){for(var r=0,l=0,a=0,v=0,y=0,p=0,w=0,f=0,e=0,o=0,u=0,h=0,s=0,c=0,b,r=0;r<n.length;r++)i[r]=0;for(b=t.length/3,r=0;r<b;r++)h=t[3*r],s=t[3*r+1],c=t[3*r+2],l=n[3*h]-n[3*s],a=n[3*h+1]-n[3*s+1],v=n[3*h+2]-n[3*s+2],y=n[3*c]-n[3*s],p=n[3*c+1]-n[3*s+1],w=n[3*c+2]-n[3*s+2],f=a*w-v*p,e=v*y-l*w,o=l*p-a*y,u=Math.sqrt(f*f+e*e+o*o),u=0===u?1:u,f/=u,e/=u,o/=u,i[3*h]+=f,i[3*h+1]+=e,i[3*h+2]+=o,i[3*s]+=f,i[3*s+1]+=e,i[3*s+2]+=o,i[3*c]+=f,i[3*c+1]+=e,i[3*c+2]+=o;for(r=0;r<i.length/3;r++)f=i[3*r],e=i[3*r+1],o=i[3*r+2],u=Math.sqrt(f*f+e*e+o*o),u=0===u?1:u,f/=u,e/=u,o/=u,i[3*r]=f,i[3*r+1]=e,i[3*r+2]=o},t._ComputeSides=function(t,i,r,u,f){var e,o,s=r.length,l=u.length,p,y,h;switch(t=t||n.Mesh.DEFAULTSIDE){case n.Mesh.BACKSIDE:for(e=0;e<s;e+=3)p=r[e],r[e]=r[e+2],r[e+2]=p;for(o=0;o<l;o++)u[o]=-u[o];break;case n.Mesh.DOUBLESIDE:for(var a=i.length,v=a/3,c=0;c<a;c++)i[a+c]=i[c];for(e=0;e<s;e+=3)r[e+s]=r[e+2]+v,r[e+1+s]=r[e+1]+v,r[e+2+s]=r[e]+v;for(o=0;o<l;o++)u[l+o]=-u[o];for(y=f.length,h=0;h<y;h++)f[h+y]=f[h]}},t.ImportVertexData=function(i,r){var u=new t,f=i.positions,e,o,s,h,c,l,a,v,y,p,w;f&&u.set(f,n.VertexBuffer.PositionKind);e=i.normals;e&&u.set(e,n.VertexBuffer.NormalKind);o=i.uvs;o&&u.set(o,n.VertexBuffer.UVKind);s=i.uv2s;s&&u.set(s,n.VertexBuffer.UV2Kind);h=i.uv3s;h&&u.set(h,n.VertexBuffer.UV3Kind);c=i.uv4s;c&&u.set(c,n.VertexBuffer.UV4Kind);l=i.uv5s;l&&u.set(l,n.VertexBuffer.UV5Kind);a=i.uv6s;a&&u.set(a,n.VertexBuffer.UV6Kind);v=i.colors;v&&u.set(n.Color4.CheckColors4(v,f.length/3),n.VertexBuffer.ColorKind);y=i.matricesIndices;y&&u.set(y,n.VertexBuffer.MatricesIndicesKind);p=i.matricesWeights;p&&u.set(p,n.VertexBuffer.MatricesWeightsKind);w=i.indices;w&&(u.indices=w);r.setAllVerticesData(u,i.updatable)},t}();n.VertexData=t}(i||(i={}));!function(n){var t=function(){function t(){}return t.EnableFor=function(n){n._tags=n._tags||{};n.hasTags=function(){return t.HasTags(n)};n.addTags=function(i){return t.AddTagsTo(n,i)};n.removeTags=function(i){return t.RemoveTagsFrom(n,i)};n.matchesTagsQuery=function(i){return t.MatchesQuery(n,i)}},t.DisableFor=function(n){delete n._tags;delete n.hasTags;delete n.addTags;delete n.removeTags;delete n.matchesTagsQuery},t.HasTags=function(t){return!!t._tags&&!n.Tools.IsEmpty(t._tags)},t.GetTags=function(n,t){var r,i;if(void 0===t&&(t=!0),!n._tags)return null;if(t){r=[];for(i in n._tags)n._tags.hasOwnProperty(i)&&n._tags[i]===!0&&r.push(i);return r.join(" ")}return n._tags},t.AddTagsTo=function(n,i){if(i&&"string"==typeof i){var r=i.split(" ");r.forEach(function(i){t._AddTagTo(n,i)})}},t._AddTagTo=function(n,i){i=i.trim();""!==i&&"true"!==i&&"false"!==i&&(i.match(/[\s]/)||i.match(/^([!]|([|]|[&]){2})/)||(t.EnableFor(n),n._tags[i]=!0))},t.RemoveTagsFrom=function(n,i){var r,u;if(t.HasTags(n)){r=i.split(" ");for(u in r)t._RemoveTagFrom(n,r[u])}},t._RemoveTagFrom=function(n,t){delete n._tags[t]},t.MatchesQuery=function(i,r){return void 0===r||(""===r?t.HasTags(i):n.Internals.AndOrNotEvaluator.Eval(r,function(n){return t.HasTags(i)&&i._tags[n]}))},t}();n.Tags=t}(i||(i={}));!function(n){var t;!function(n){var t=function(){function n(){}return n.Eval=function(t,i){return t=t.match(/\([^\(\)]*\)/g)?t.replace(/\([^\(\)]*\)/g,function(t){return t=t.slice(1,t.length-1),n._HandleParenthesisContent(t,i)}):n._HandleParenthesisContent(t,i),"true"===t||"false"!==t&&n.Eval(t,i)},n._HandleParenthesisContent=function(t,i){var f,e,h,r,o,s,u;i=i||function(n){return"true"===n};e=t.split("||");for(h in e)if(e.hasOwnProperty(h)){if(r=n._SimplifyNegation(e[h].trim()),o=r.split("&&"),o.length>1)for(s=0;s<o.length;++s)if(u=n._SimplifyNegation(o[s].trim()),f="true"!==u&&"false"!==u?"!"===u[0]?!i(u.substring(1)):i(u):"true"===u,!f){r="false";break}if(f||"true"===r){f=!0;break}f="true"!==r&&"false"!==r?"!"===r[0]?!i(r.substring(1)):i(r):"true"===r}return f?"true":"false"},n._SimplifyNegation=function(n){return n=n.replace(/^[\s!]+/,function(n){return n=n.replace(/[\s]/g,function(){return""}),n.length%2?"!":""}),n=n.trim(),"!true"===n?n="false":"!false"===n&&(n="true"),n},n}();n.AndOrNotEvaluator=t}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f,e){this._enabled=!0;this._refCount=0;this._name=i;this._renderTexture=new n.RenderTargetTexture(i,r,t);this.setRenderList(u);this._renderTexture.onBeforeRenderObservable.add(f);this._renderTexture.onAfterRenderObservable.add(e);this._scene=t;this._renderList=u}return t.prototype._incRefCount=function(){return 0===this._refCount&&this._scene.customRenderTargets.push(this._renderTexture),++this._refCount},t.prototype._decRefCount=function(){return this._refCount--,this._refCount<=0&&this._scene.customRenderTargets.splice(this._scene.customRenderTargets.indexOf(this._renderTexture),1),this._refCount},t.prototype._update=function(){this.setRenderList(this._renderList)},t.prototype.setRenderList=function(n){this._renderTexture.renderList=n},t.prototype.getRenderTexture=function(){return this._renderTexture},t}();n.PostProcessRenderPass=t}(i||(i={}));!function(n){var t=function(){function t(n,t,i,r){this._engine=n;this._name=t;this._singleInstance=r||!0;this._getPostProcess=i;this._cameras=[];this._indicesForCamera=[];this._postProcesses={};this._renderPasses={};this._renderEffectAsPasses={}}return Object.defineProperty(t.prototype,"isSupported",{get:function(){for(var n in this._postProcesses)if(!this._postProcesses[n].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),t.prototype._update=function(){for(var n in this._renderPasses)this._renderPasses[n]._update()},t.prototype.addPass=function(n){this._renderPasses[n._name]=n;this._linkParameters()},t.prototype.removePass=function(n){delete this._renderPasses[n._name];this._linkParameters()},t.prototype.addRenderEffectAsPass=function(n){this._renderEffectAsPasses[n._name]=n;this._linkParameters()},t.prototype.getPass=function(n){for(var t in this._renderPasses)if(t===n)return this._renderPasses[n]},t.prototype.emptyPasses=function(){this._renderPasses={};this._linkParameters()},t.prototype._attachCameras=function(t){for(var u,r,i,o,s,e=n.Tools.MakeArray(t||this._cameras),f=0;f<e.length;f++){r=e[f];i=r.name;u=this._singleInstance?0:i;this._postProcesses[u]=this._postProcesses[u]||this._getPostProcess();o=r.attachPostProcess(this._postProcesses[u]);this._indicesForCamera[i]||(this._indicesForCamera[i]=[]);this._indicesForCamera[i].push(o);this._cameras.indexOf(r)===-1&&(this._cameras[i]=r);for(s in this._renderPasses)this._renderPasses[s]._incRefCount()}this._linkParameters()},t.prototype._detachCameras=function(t){for(var f,r,e,o,u=n.Tools.MakeArray(t||this._cameras),i=0;i<u.length;i++){f=u[i];r=f.name;f.detachPostProcess(this._postProcesses[this._singleInstance?0:r],this._indicesForCamera[r]);e=this._cameras.indexOf(r);this._indicesForCamera.splice(e,1);this._cameras.splice(e,1);for(o in this._renderPasses)this._renderPasses[o]._decRefCount()}},t.prototype._enable=function(t){for(var o,f=n.Tools.MakeArray(t||this._cameras),i=0;i<f.length;i++){for(var e=f[i],r=e.name,u=0;u<this._indicesForCamera[r].length;u++)void 0===e._postProcesses[this._indicesForCamera[r][u]]&&t[i].attachPostProcess(this._postProcesses[this._singleInstance?0:r],this._indicesForCamera[r][u]);for(o in this._renderPasses)this._renderPasses[o]._incRefCount()}},t.prototype._disable=function(t){for(var u,f,e,r=n.Tools.MakeArray(t||this._cameras),i=0;i<r.length;i++){u=r[i];f=u.Name;u.detachPostProcess(this._postProcesses[this._singleInstance?0:f],this._indicesForCamera[f]);for(e in this._renderPasses)this._renderPasses[e]._decRefCount()}},t.prototype.getPostProcess=function(n){return this._singleInstance?this._postProcesses[0]:this._postProcesses[n.name]},t.prototype._linkParameters=function(){var t=this;for(var n in this._postProcesses)this.applyParameters&&this.applyParameters(this._postProcesses[n]),this._postProcesses[n].onBeforeRenderObservable.add(function(n){t._linkTextures(n)})},t.prototype._linkTextures=function(n){var t,i;for(t in this._renderPasses)n.setTexture(t,this._renderPasses[t].getRenderTexture());for(i in this._renderEffectAsPasses)n.setTextureFromPostProcess(i+"Sampler",this._renderEffectAsPasses[i].getPostProcess())},t}();n.PostProcessRenderEffect=t}(i||(i={}));!function(n){var t=function(){function t(n,t){this._engine=n;this._name=t;this._renderEffects={};this._renderEffectsForIsolatedPass={};this._cameras=[]}return Object.defineProperty(t.prototype,"isSupported",{get:function(){for(var n in this._renderEffects)if(!this._renderEffects[n].isSupported)return!1;return!0},enumerable:!0,configurable:!0}),t.prototype.addEffect=function(n){this._renderEffects[n._name]=n},t.prototype._enableEffect=function(t,i){var r=this._renderEffects[t];r&&r._enable(n.Tools.MakeArray(i||this._cameras))},t.prototype._disableEffect=function(t,i){var r=this._renderEffects[t];r&&r._disable(n.Tools.MakeArray(i||this._cameras))},t.prototype._attachCameras=function(t,i){for(var f=n.Tools.MakeArray(t||this._cameras),e=[],u,o,s,r=0;r<f.length;r++)u=f[r],o=u.name,this._cameras.indexOf(u)===-1?this._cameras[o]=u:i&&e.push(r);for(r=0;r<e.length;r++)t.splice(e[r],1);for(s in this._renderEffects)this._renderEffects[s]._attachCameras(f)},t.prototype._detachCameras=function(t){var r=n.Tools.MakeArray(t||this._cameras),u,i;for(u in this._renderEffects)this._renderEffects[u]._detachCameras(r);for(i=0;i<r.length;i++)this._cameras.splice(this._cameras.indexOf(r[i]),1)},t.prototype._enableDisplayOnlyPass=function(i,r){var e,c=this,s=n.Tools.MakeArray(r||this._cameras),f=null,o,h,u;for(e in this._renderEffects)if(f=this._renderEffects[e].getPass(i),null!=f)break;if(null!==f){for(e in this._renderEffects)this._renderEffects[e]._disable(s);for(f._name=t.PASS_SAMPLER_NAME,o=0;o<s.length;o++)h=s[o],u=h.name,this._renderEffectsForIsolatedPass[u]=this._renderEffectsForIsolatedPass[u]||new n.PostProcessRenderEffect(this._engine,t.PASS_EFFECT_NAME,function(){return new n.DisplayPassPostProcess(t.PASS_EFFECT_NAME,1,null,null,c._engine,!0)}),this._renderEffectsForIsolatedPass[u].emptyPasses(),this._renderEffectsForIsolatedPass[u].addPass(f),this._renderEffectsForIsolatedPass[u]._attachCameras(h)}},t.prototype._disableDisplayOnlyPass=function(i){for(var e,r,o,s=this,u=n.Tools.MakeArray(i||this._cameras),f=0;f<u.length;f++)e=u[f],r=e.name,this._renderEffectsForIsolatedPass[r]=this._renderEffectsForIsolatedPass[r]||new n.PostProcessRenderEffect(this._engine,t.PASS_EFFECT_NAME,function(){return new n.DisplayPassPostProcess(t.PASS_EFFECT_NAME,1,null,null,s._engine,!0)}),this._renderEffectsForIsolatedPass[r]._disable(e);for(o in this._renderEffects)this._renderEffects[o]._enable(u)},t.prototype._update=function(){var i,n,t;for(i in this._renderEffects)this._renderEffects[i]._update();for(n=0;n<this._cameras.length;n++)t=this._cameras[n].name,this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()},t.prototype.dispose=function(){},t.PASS_EFFECT_NAME="passEffect",t.PASS_SAMPLER_NAME="passSampler",t}();n.PostProcessRenderPipeline=t}(i||(i={}));!function(n){var t=function(){function n(){this._renderPipelines={}}return n.prototype.addPipeline=function(n){this._renderPipelines[n._name]=n},n.prototype.attachCamerasToRenderPipeline=function(n,t,i){var r=this._renderPipelines[n];r&&r._attachCameras(t,i)},n.prototype.detachCamerasFromRenderPipeline=function(n,t){var i=this._renderPipelines[n];i&&i._detachCameras(t)},n.prototype.enableEffectInPipeline=function(n,t,i){var r=this._renderPipelines[n];r&&r._enableEffect(t,i)},n.prototype.disableEffectInPipeline=function(n,t,i){var r=this._renderPipelines[n];r&&r._disableEffect(t,i)},n.prototype.enableDisplayOnlyPassInPipeline=function(n,t,i){var r=this._renderPipelines[n];r&&r._enableDisplayOnlyPass(t,i)},n.prototype.disableDisplayOnlyPassInPipeline=function(n,t){var i=this._renderPipelines[n];i&&i._disableDisplayOnlyPass(t)},n.prototype.update=function(){var t,n;for(t in this._renderPipelines)n=this._renderPipelines[t],n.isSupported?n._update():(n.dispose(),delete this._renderPipelines[t])},n}();n.PostProcessRenderPipelineManager=t}(i||(i={}));!function(n){var t=function(){function t(t){this.frontColor=new n.Color3(1,1,1);this.backColor=new n.Color3(.1,.1,.1);this.showBackLines=!0;this.renderList=new n.SmartArray(32);this._vertexBuffers={};this._scene=t}return t.prototype._prepareRessources=function(){if(!this._colorShader){this._colorShader=new n.ShaderMaterial("colorShader",this._scene,"color",{attributes:[n.VertexBuffer.PositionKind],uniforms:["worldViewProjection","color"]});var t=this._scene.getEngine(),i=n.VertexData.CreateBox(1);this._vertexBuffers[n.VertexBuffer.PositionKind]=new n.VertexBuffer(t,i.positions,n.VertexBuffer.PositionKind,!1);this._indexBuffer=t.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}},t.prototype.reset=function(){this.renderList.reset()},t.prototype.render=function(){var t,i;if(0!==this.renderList.length&&(this._prepareRessources(),this._colorShader.isReady())){for(t=this._scene.getEngine(),t.setDepthWrite(!1),this._colorShader._preBind(),i=0;i<this.renderList.length;i++){var u=this.renderList.data[i],e=u.minimum,s=u.maximum,r=s.subtract(e),f=e.add(r.scale(.5)),o=n.Matrix.Scaling(r.x,r.y,r.z).multiply(n.Matrix.Translation(f.x,f.y,f.z)).multiply(u.getWorldMatrix());t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect());this.showBackLines&&(t.setDepthFunctionToGreaterOrEqual(),this._scene.resetCachedMaterial(),this._colorShader.setColor4("color",this.backColor.toColor4()),this._colorShader.bind(o),t.draw(!1,0,24));t.setDepthFunctionToLess();this._scene.resetCachedMaterial();this._colorShader.setColor4("color",this.frontColor.toColor4());this._colorShader.bind(o);t.draw(!1,0,24)}this._colorShader.unbind();t.setDepthFunctionToLessOrEqual();t.setDepthWrite(!0)}},t.prototype.dispose=function(){if(this._colorShader){this._colorShader.dispose();var t=this._vertexBuffers[n.VertexBuffer.PositionKind];t&&(t.dispose(),this._vertexBuffers[n.VertexBuffer.PositionKind]=null);this._scene.getEngine()._releaseBuffer(this._indexBuffer)}},t}();n.BoundingBoxRenderer=t}(i||(i={}));!function(n){var t=function(){function n(n){this._actionManager=n}return n.prototype.isValid=function(){return!0},n.prototype._getProperty=function(n){return this._actionManager._getProperty(n)},n.prototype._getEffectiveTarget=function(n,t){return this._actionManager._getEffectiveTarget(n,t)},n.prototype.serialize=function(){},n.prototype._serialize=function(n){return{type:2,children:[],name:n.name,properties:n.properties}},n}(),i,r,f;n.Condition=t;i=function(t){function i(n,r,u,f,e){void 0===e&&(e=i.IsEqual);t.call(this,n);this.propertyPath=u;this.value=f;this.operator=e;this._target=r;this._effectiveTarget=this._getEffectiveTarget(r,this.propertyPath);this._property=this._getProperty(this.propertyPath)}return u(i,t),Object.defineProperty(i,"IsEqual",{get:function(){return i._IsEqual},enumerable:!0,configurable:!0}),Object.defineProperty(i,"IsDifferent",{get:function(){return i._IsDifferent},enumerable:!0,configurable:!0}),Object.defineProperty(i,"IsGreater",{get:function(){return i._IsGreater},enumerable:!0,configurable:!0}),Object.defineProperty(i,"IsLesser",{get:function(){return i._IsLesser},enumerable:!0,configurable:!0}),i.prototype.isValid=function(){switch(this.operator){case i.IsGreater:return this._effectiveTarget[this._property]>this.value;case i.IsLesser:return this._effectiveTarget[this._property]<this.value;case i.IsEqual:case i.IsDifferent:var n;return n=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===i.IsEqual?n:!n}return!1},i.prototype.serialize=function(){return this._serialize({name:"ValueCondition",properties:[n.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:n.Action._SerializeValueAsString(this.value)},{name:"operator",value:i.GetOperatorName(this.operator)}]})},i.GetOperatorName=function(n){switch(n){case i._IsEqual:return"IsEqual";case i._IsDifferent:return"IsDifferent";case i._IsGreater:return"IsGreater";case i._IsLesser:return"IsLesser";default:return""}},i._IsEqual=0,i._IsDifferent=1,i._IsGreater=2,i._IsLesser=3,i}(t);n.ValueCondition=i;r=function(n){function t(t,i){n.call(this,t);this.predicate=i}return u(t,n),t.prototype.isValid=function(){return this.predicate()},t}(t);n.PredicateCondition=r;f=function(t){function i(n,i,r){t.call(this,n);this.value=r;this._target=i}return u(i,t),i.prototype.isValid=function(){return this._target.state===this.value},i.prototype.serialize=function(){return this._serialize({name:"StateCondition",properties:[n.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]})},i}(t);n.StateCondition=f}(i||(i={}));!function(n){var t=function(){function t(n,t){this.triggerOptions=n;n.parameter?(this.trigger=n.trigger,this._triggerParameter=n.parameter):this.trigger=n;this._nextActiveAction=this;this._condition=t}return t.prototype._prepare=function(){},t.prototype.getTriggerParameter=function(){return this._triggerParameter},t.prototype._executeCurrent=function(n){if(this._nextActiveAction._condition){var t=this._nextActiveAction._condition,i=this._actionManager.getScene().getRenderId();if(t._evaluationId===i){if(!t._currentResult)return}else{if(t._evaluationId=i,!t.isValid())return void(t._currentResult=!1);t._currentResult=!0}}this._nextActiveAction.execute(n);this.skipToNextActiveAction()},t.prototype.execute=function(){},t.prototype.skipToNextActiveAction=function(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this},t.prototype.then=function(n){return this._child=n,n._actionManager=this._actionManager,n._prepare(),n},t.prototype._getProperty=function(n){return this._actionManager._getProperty(n)},t.prototype._getEffectiveTarget=function(n,t){return this._actionManager._getEffectiveTarget(n,t)},t.prototype.serialize=function(){},t.prototype._serialize=function(n,t){var i={type:1,children:[],name:n.name,properties:n.properties||[]},r;return(this._child&&this._child.serialize(i),this._condition)?(r=this._condition.serialize(),r.children.push(i),t&&t.children.push(r),r):(t&&t.children.push(i),i)},t._SerializeValueAsString=function(t){return"number"==typeof t?t.toString():"boolean"==typeof t?t?"true":"false":t instanceof n.Vector2?t.x+", "+t.y:t instanceof n.Vector3?t.x+", "+t.y+", "+t.z:t instanceof n.Color3?t.r+", "+t.g+", "+t.b:t instanceof n.Color4?t.r+", "+t.g+", "+t.b+", "+t.a:t},t._GetTargetProperty=function(t){return{name:"target",targetType:t instanceof n.Mesh?"MeshProperties":t instanceof n.Light?"LightProperties":t instanceof n.Camera?"CameraProperties":"SceneProperties",value:t instanceof n.Scene?"Scene":t.name}},t}();n.Action=t}(i||(i={}));!function(n){var i=function(){function n(n,t,i,r,u,f){this.source=n;this.pointerX=t;this.pointerY=i;this.meshUnderPointer=r;this.sourceEvent=u;this.additionalData=f}return n.CreateNew=function(t,i,r){var u=t.getScene();return new n(t,u.pointerX,u.pointerY,u.meshUnderPointer,i,r)},n.CreateNewFromSprite=function(t,i,r,u){return new n(t,i.pointerX,i.pointerY,i.meshUnderPointer,r,u)},n.CreateNewFromScene=function(t,i){return new n(null,t.pointerX,t.pointerY,t.meshUnderPointer,i)},n.CreateNewFromPrimitive=function(t,i,r,u){return new n(t,i.x,i.y,null,r,u)},n}(),t;n.ActionEvent=i;t=function(){function t(n){this.actions=[];this.hoverCursor="";this._scene=n;n._actionManagers.push(this)}return Object.defineProperty(t,"NothingTrigger",{get:function(){return t._NothingTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPickTrigger",{get:function(){return t._OnPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnLeftPickTrigger",{get:function(){return t._OnLeftPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnRightPickTrigger",{get:function(){return t._OnRightPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnCenterPickTrigger",{get:function(){return t._OnCenterPickTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPickDownTrigger",{get:function(){return t._OnPickDownTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPickUpTrigger",{get:function(){return t._OnPickUpTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPickOutTrigger",{get:function(){return t._OnPickOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnLongPressTrigger",{get:function(){return t._OnLongPressTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPointerOverTrigger",{get:function(){return t._OnPointerOverTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnPointerOutTrigger",{get:function(){return t._OnPointerOutTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnEveryFrameTrigger",{get:function(){return t._OnEveryFrameTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnIntersectionEnterTrigger",{get:function(){return t._OnIntersectionEnterTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnIntersectionExitTrigger",{get:function(){return t._OnIntersectionExitTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnKeyDownTrigger",{get:function(){return t._OnKeyDownTrigger},enumerable:!0,configurable:!0}),Object.defineProperty(t,"OnKeyUpTrigger",{get:function(){return t._OnKeyUpTrigger},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){var n=this._scene._actionManagers.indexOf(this);n>-1&&this._scene._actionManagers.splice(n,1)},t.prototype.getScene=function(){return this._scene},t.prototype.hasSpecificTriggers=function(n){for(var i,t=0;t<this.actions.length;t++)if(i=this.actions[t],n.indexOf(i.trigger)>-1)return!0;return!1},t.prototype.hasSpecificTrigger=function(n){for(var i,t=0;t<this.actions.length;t++)if(i=this.actions[t],i.trigger===n)return!0;return!1},Object.defineProperty(t.prototype,"hasPointerTriggers",{get:function(){for(var i,n=0;n<this.actions.length;n++)if(i=this.actions[n],i.trigger>=t._OnPickTrigger&&i.trigger<=t._OnPointerOutTrigger)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasPickTriggers",{get:function(){for(var i,n=0;n<this.actions.length;n++)if(i=this.actions[n],i.trigger>=t._OnPickTrigger&&i.trigger<=t._OnPickUpTrigger)return!0;return!1},enumerable:!0,configurable:!0}),t.prototype.registerAction=function(i){return i.trigger===t.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(n.Tools.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(i),i._actionManager=this,i._prepare(),i)},t.prototype.processTrigger=function(n,i){for(var u,f,e,o,r=0;r<this.actions.length;r++)if(u=this.actions[r],u.trigger===n){if((n===t.OnKeyUpTrigger||n===t.OnKeyDownTrigger)&&(f=u.getTriggerParameter(),f&&(e=i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode,o=String.fromCharCode(e).toLowerCase(),o!==f.toLowerCase())))continue;u._executeCurrent(i)}},t.prototype._getEffectiveTarget=function(n,t){for(var r=t.split("."),i=0;i<r.length-1;i++)n=n[r[i]];return n},t.prototype._getProperty=function(n){var t=n.split(".");return t[t.length-1]},t.prototype.serialize=function(i){for(var f,r,e,o={children:[],name:i,type:3,properties:[]},u=0;u<this.actions.length;u++)f={type:0,children:[],name:t.GetTriggerName(this.actions[u].trigger),properties:[]},r=this.actions[u].triggerOptions,r&&"number"!=typeof r&&(r.parameter instanceof n.Node?f.properties.push(n.Action._GetTargetProperty(r.parameter)):(e={},n.Tools.DeepCopy(r.parameter,e,["mesh"]),r.parameter.mesh&&(e._meshId=r.parameter.mesh.id),f.properties.push({name:"parameter",targetType:null,value:e}))),this.actions[u].serialize(f),o.children.push(f);return o},t.Parse=function(i,r,u){var e=new n.ActionManager(u),l,f,a,o,s;null===r?u.actionManager=e:r.actionManager=e;for(var v=function(t,i){var r=Object.create(n[t].prototype);return r.constructor.apply(r,i),r},y=function(t,i,r,u){var s,e,f;if(null===u)return s=parseFloat(i),"true"===i||"false"===i?"true"===i:isNaN(s)?i:s;for(var h=u.split("."),o=i.split(","),f=0;f<h.length;f++)r=r[h[f]];if("boolean"==typeof r)return"true"===o[0];if("string"==typeof r)return o[0];for(e=[],f=0;f<o.length;f++)e.push(parseFloat(o[f]));return r instanceof n.Vector3?n.Vector3.FromArray(e):r instanceof n.Vector4?n.Vector4.FromArray(e):r instanceof n.Color3?n.Color3.FromArray(e):r instanceof n.Color4?n.Color4.FromArray(e):parseFloat(o[0])},h=function(i,r,f,o,s){var d,b,it,p,k,a;if(void 0===s&&(s=null),!i.detached){var c=[],g=null,nt=null,rt=i.combine&&i.combine.length>0;if(2===i.type?c.push(e):c.push(r),rt){for(d=[],b=0;b<i.combine.length;b++)h(i.combine[b],t.NothingTrigger,f,o,d);c.push(d)}else for(a=0;a<i.properties.length;a++){var l=i.properties[a].value,w=i.properties[a].name,tt=i.properties[a].targetType;"target"===w?l=g=null!==tt&&"SceneProperties"===tt?u:u.getNodeByName(l):"parent"===w?l=u.getNodeByName(l):"sound"===w?l=u.getSoundByName(l):"propertyPath"!==w?l=2===i.type&&"operator"===w?n.ValueCondition[l]:y(w,l,g,"value"===w?nt:null):nt=l;c.push(l)}for((null===s?c.push(f):c.push(null),"InterpolateValueAction"===i.name)&&(it=c[c.length-2],c[c.length-1]=it,c[c.length-2]=f),p=v(i.name,c),p instanceof n.Condition&&null!==f&&(k=new n.DoNothingAction(r,f),o?o.then(k):e.registerAction(k),o=k),null===s?p instanceof n.Condition?(f=p,p=o):(f=null,o?o.then(p):e.registerAction(p)):s.push(p),a=0;a<i.children.length;a++)h(i.children[a],r,f,p,null)}},c=0;c<i.children.length;c++)for(f=i.children[c],f.properties.length>0?(a=f.properties[0].value,o=null===f.properties[0].targetType?a:u.getMeshByName(a),o._meshId&&(o.mesh=u.getMeshByID(o._meshId)),l={trigger:n.ActionManager[f.name],parameter:o}):l=n.ActionManager[f.name],s=0;s<f.children.length;s++)f.detached||h(f.children[s],l,null,null)},t.GetTriggerName=function(n){switch(n){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnPickUpTrigger";case 7:return"OnLongPressTrigger";case 8:return"OnPointerOverTrigger";case 9:return"OnPointerOutTrigger";case 10:return"OnEveryFrameTrigger";case 11:return"OnIntersectionEnterTrigger";case 12:return"OnIntersectionExitTrigger";case 13:return"OnKeyDownTrigger";case 14:return"OnKeyUpTrigger";case 15:return"OnPickOutTrigger";default:return""}},t._NothingTrigger=0,t._OnPickTrigger=1,t._OnLeftPickTrigger=2,t._OnRightPickTrigger=3,t._OnCenterPickTrigger=4,t._OnPickDownTrigger=5,t._OnPickUpTrigger=6,t._OnLongPressTrigger=7,t._OnPointerOverTrigger=8,t._OnPointerOutTrigger=9,t._OnEveryFrameTrigger=10,t._OnIntersectionEnterTrigger=11,t._OnIntersectionExitTrigger=12,t._OnKeyDownTrigger=13,t._OnKeyUpTrigger=14,t._OnPickOutTrigger=15,t.DragMovementThreshold=10,t.LongPressDelay=500,t}();n.ActionManager=t}(i||(i={}));!function(n){var t=function(t){function i(n,i,r,u,f,e,o,s){void 0===f&&(f=1e3);t.call(this,n,e);this.propertyPath=r;this.value=u;this.duration=f;this.stopOtherAnimations=o;this.onInterpolationDone=s;this._target=this._effectiveTarget=i}return u(i,t),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)},i.prototype.execute=function(){var t,r=this._actionManager.getScene(),u=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}],i;if("number"==typeof this.value)t=n.Animation.ANIMATIONTYPE_FLOAT;else if(this.value instanceof n.Color3)t=n.Animation.ANIMATIONTYPE_COLOR3;else if(this.value instanceof n.Vector3)t=n.Animation.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof n.Matrix)t=n.Animation.ANIMATIONTYPE_MATRIX;else{if(!(this.value instanceof n.Quaternion))return void n.Tools.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");t=n.Animation.ANIMATIONTYPE_QUATERNION}i=new n.Animation("InterpolateValueAction",this._property,1e5/this.duration,t,n.Animation.ANIMATIONLOOPMODE_CONSTANT);i.setKeys(u);this.stopOtherAnimations&&r.stopAnimation(this._effectiveTarget);r.beginDirectAnimation(this._effectiveTarget,[i],0,100,!1,1,this.onInterpolationDone)},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"InterpolateValueAction",properties:[n.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:n.Action._SerializeValueAsString(this.value)},{name:"duration",value:n.Action._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:n.Action._SerializeValueAsString(this.stopOtherAnimations)||!1}]},i)},i}(n.Action);n.InterpolateValueAction=t}(i||(i={}));!function(n){var v=function(t){function i(n,i,r,u){t.call(this,n,u);this.propertyPath=r;this._target=this._effectiveTarget=i}return u(i,t),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)},i.prototype.execute=function(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SwitchBooleanAction",properties:[n.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},i)},i}(n.Action),t,i,r,f,e,o,s,h,c,l,a;n.SwitchBooleanAction=v;t=function(t){function i(n,i,r,u){t.call(this,n,u);this.value=r;this._target=i}return u(i,t),i.prototype.execute=function(){this._target.state=this.value},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SetStateAction",properties:[n.Action._GetTargetProperty(this._target),{name:"value",value:this.value}]},i)},i}(n.Action);n.SetStateAction=t;i=function(t){function i(n,i,r,u,f){t.call(this,n,f);this.propertyPath=r;this.value=u;this._target=this._effectiveTarget=i}return u(i,t),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath)},i.prototype.execute=function(){this._effectiveTarget[this._property]=this.value;this._target.markAsDirty&&this._target.markAsDirty(this._property)},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SetValueAction",properties:[n.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:n.Action._SerializeValueAsString(this.value)}]},i)},i}(n.Action);n.SetValueAction=i;r=function(t){function i(n,i,r,u,f){t.call(this,n,f);this.propertyPath=r;this.value=u;this._target=this._effectiveTarget=i}return u(i,t),i.prototype._prepare=function(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath);this._property=this._getProperty(this.propertyPath);"number"!=typeof this._effectiveTarget[this._property]&&n.Tools.Warn("Warning: IncrementValueAction can only be used with number values")},i.prototype.execute=function(){this._effectiveTarget[this._property]+=this.value;this._target.markAsDirty&&this._target.markAsDirty(this._property)},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"IncrementValueAction",properties:[n.Action._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:n.Action._SerializeValueAsString(this.value)}]},i)},i}(n.Action);n.IncrementValueAction=r;f=function(t){function i(n,i,r,u,f,e){t.call(this,n,e);this.from=r;this.to=u;this.loop=f;this._target=i}return u(i,t),i.prototype._prepare=function(){},i.prototype.execute=function(){var n=this._actionManager.getScene();n.beginAnimation(this._target,this.from,this.to,this.loop)},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"PlayAnimationAction",properties:[n.Action._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:n.Action._SerializeValueAsString(this.loop)||!1}]},i)},i}(n.Action);n.PlayAnimationAction=f;e=function(t){function i(n,i,r){t.call(this,n,r);this._target=i}return u(i,t),i.prototype._prepare=function(){},i.prototype.execute=function(){var n=this._actionManager.getScene();n.stopAnimation(this._target)},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"StopAnimationAction",properties:[n.Action._GetTargetProperty(this._target)]},i)},i}(n.Action);n.StopAnimationAction=e;o=function(t){function i(i,r){void 0===i&&(i=n.ActionManager.NothingTrigger);t.call(this,i,r)}return u(i,t),i.prototype.execute=function(){},i.prototype.serialize=function(n){return t.prototype._serialize.call(this,{name:"DoNothingAction",properties:[]},n)},i}(n.Action);n.DoNothingAction=o;s=function(n){function t(t,i,r){n.call(this,t,r);this.children=i}return u(t,n),t.prototype._prepare=function(){for(var n=0;n<this.children.length;n++)this.children[n]._actionManager=this._actionManager,this.children[n]._prepare()},t.prototype.execute=function(n){for(var t=0;t<this.children.length;t++)this.children[t].execute(n)},t.prototype.serialize=function(t){for(var r=n.prototype._serialize.call(this,{name:"CombineAction",properties:[],combine:[]},t),i=0;i<this.children.length;i++)r.combine.push(this.children[i].serialize(null));return r},t}(n.Action);n.CombineAction=s;h=function(n){function t(t,i,r){n.call(this,t,r);this.func=i}return u(t,n),t.prototype.execute=function(n){this.func(n)},t}(n.Action);n.ExecuteCodeAction=h;c=function(t){function i(n,i,r,u){t.call(this,n,u);this._target=i;this._parent=r}return u(i,t),i.prototype._prepare=function(){},i.prototype.execute=function(){if(this._target.parent!==this._parent){var t=this._parent.getWorldMatrix().clone();t.invert();this._target.position=n.Vector3.TransformCoordinates(this._target.position,t);this._target.parent=this._parent}},i.prototype.serialize=function(i){return t.prototype._serialize.call(this,{name:"SetParentAction",properties:[n.Action._GetTargetProperty(this._target),n.Action._GetTargetProperty(this._parent)]},i)},i}(n.Action);n.SetParentAction=c;l=function(n){function t(t,i,r){n.call(this,t,r);this._sound=i}return u(t,n),t.prototype._prepare=function(){},t.prototype.execute=function(){void 0!==this._sound&&this._sound.play()},t.prototype.serialize=function(t){return n.prototype._serialize.call(this,{name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},t)},t}(n.Action);n.PlaySoundAction=l;a=function(n){function t(t,i,r){n.call(this,t,r);this._sound=i}return u(t,n),t.prototype._prepare=function(){},t.prototype.execute=function(){void 0!==this._sound&&this._sound.stop()},t.prototype.serialize=function(t){return n.prototype._serialize.call(this,{name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},t)},t}(n.Action);n.StopSoundAction=a}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f){this.delayLoadState=n.Engine.DELAYLOADSTATE_NONE;this._totalVertices=0;this._isDisposed=!1;this.id=t;this._engine=i.getEngine();this._meshes=[];this._scene=i;this._vertexBuffers={};this._indices=[];r?this.setAllVerticesData(r,u):(this._totalVertices=0,this._indices=[]);f&&(f instanceof n.LinesMesh&&(this.boundingBias=new n.Vector2(0,f.intersectionThreshold),this.updateExtend()),this.applyToMesh(f),f.computeWorldMatrix(!0))}return Object.defineProperty(t.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(n){this._boundingBias&&this._boundingBias.equals(n)||(this._boundingBias=n.clone(),this.updateBoundingInfo(!0,null))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"extend",{get:function(){return this._extend},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getEngine=function(){return this._engine},t.prototype.isReady=function(){return this.delayLoadState===n.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===n.Engine.DELAYLOADSTATE_NONE},Object.defineProperty(t.prototype,"doNotSerialize",{get:function(){for(var n=0;n<this._meshes.length;n++)if(!this._meshes[n].doNotSerialize)return!1;return!0},enumerable:!0,configurable:!0}),t.prototype.setAllVerticesData=function(n,t){n.applyToGeometry(this,t);this.notifyUpdate()},t.prototype.setVerticesData=function(t,i,r,u){var f=new n.VertexBuffer(this._engine,i,t,r,0===this._meshes.length,u);this.setVerticesBuffer(f)},t.prototype.setVerticesBuffer=function(t){var i=t.getKind(),u,f,r;if(this._vertexBuffers[i]&&this._vertexBuffers[i].dispose(),this._vertexBuffers[i]=t,i===n.VertexBuffer.PositionKind){u=t.getData();f=t.getStrideSize();this._totalVertices=u.length/f;this.updateExtend(u,f);for(var o=this._meshes,s=o.length,e=0;e<s;e++)r=o[e],r._resetPointsArrayCache(),r._boundingInfo=new n.BoundingInfo(this._extend.minimum,this._extend.maximum),r._createGlobalSubMesh(),r.computeWorldMatrix(!0)}this.notifyUpdate(i)},t.prototype.updateVerticesDataDirectly=function(n,t,i){var r=this.getVertexBuffer(n);r&&(r.updateDirectly(t,i),this.notifyUpdate(n))},t.prototype.updateVerticesData=function(t,i,r){var u=this.getVertexBuffer(t),f;u&&((u.update(i),t===n.VertexBuffer.PositionKind)&&(f=u.getStrideSize(),this._totalVertices=i.length/f,this.updateBoundingInfo(r,i)),this.notifyUpdate(t))},t.prototype.updateBoundingInfo=function(t,i){var r,u,o;t&&this.updateExtend(i);for(var e=this._meshes,s=e.length,f=0;f<s;f++)if(r=e[f],r._resetPointsArrayCache(),t)for(r._boundingInfo=new n.BoundingInfo(this._extend.minimum,this._extend.maximum),u=0;u<r.subMeshes.length;u++)o=r.subMeshes[u],o.refreshBoundingInfo()},t.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},t.prototype.getVerticesData=function(n,t){var u=this.getVertexBuffer(n),i;if(!u)return null;if(i=u.getData(),t&&1!==this._meshes.length){for(var e=i.length,f=[],r=0;r<e;r++)f.push(i[r]);return f}return i},t.prototype.getVertexBuffer=function(n){return this.isReady()?this._vertexBuffers[n]:null},t.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},t.prototype.isVerticesDataPresent=function(n){return this._vertexBuffers?void 0!==this._vertexBuffers[n]:!!this._delayInfo&&this._delayInfo.indexOf(n)!==-1},t.prototype.getVerticesDataKinds=function(){var n,t=[];if(!this._vertexBuffers&&this._delayInfo)for(n in this._delayInfo)t.push(n);else for(n in this._vertexBuffers)t.push(n);return t},t.prototype.setIndices=function(n,t){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer);this._indices=n;0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices));void 0!==t&&(this._totalVertices=t);for(var r=this._meshes,u=r.length,i=0;i<u;i++)r[i]._createGlobalSubMesh();this.notifyUpdate()},t.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},t.prototype.getIndices=function(n){var t;if(!this.isReady())return null;if(t=this._indices,n&&1!==this._meshes.length){for(var u=t.length,r=[],i=0;i<u;i++)r.push(t[i]);return r}return t},t.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},t.prototype.releaseForMesh=function(n,t){var i=this._meshes,r=i.indexOf(n),u;if(r!==-1){for(u in this._vertexBuffers)this._vertexBuffers[u].dispose();this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null);i.splice(r,1);n._geometry=null;0===i.length&&t&&this.dispose()}},t.prototype.applyToMesh=function(n){var t,i;n._geometry!==this&&(t=n._geometry,t&&t.releaseForMesh(n),i=this._meshes,n._geometry=this,this._scene.pushGeometry(this),i.push(n),this.isReady()?this._applyToMesh(n):n._boundingInfo=this._boundingInfo)},t.prototype.updateExtend=function(t,i){void 0===t&&(t=null);t||(t=this._vertexBuffers[n.VertexBuffer.PositionKind].getData());this._extend=n.Tools.ExtractMinAndMax(t,0,this._totalVertices,this.boundingBias,i)},t.prototype._applyToMesh=function(t){var i=this._meshes.length;for(var r in this._vertexBuffers)1===i&&this._vertexBuffers[r].create(),this._vertexBuffers[r].getBuffer().references=i,r===n.VertexBuffer.PositionKind&&(t._resetPointsArrayCache(),this._extend||this.updateExtend(this._vertexBuffers[r].getData()),t._boundingInfo=new n.BoundingInfo(this._extend.minimum,this._extend.maximum),t._createGlobalSubMesh(),t._updateBoundingInfo());1===i&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices));this._indexBuffer&&(this._indexBuffer.references=i)},t.prototype.notifyUpdate=function(n){this.onGeometryUpdated&&this.onGeometryUpdated(this,n)},t.prototype.load=function(t,i){if(this.delayLoadState!==n.Engine.DELAYLOADSTATE_LOADING){if(this.isReady())return void(i&&i());this.delayLoadState=n.Engine.DELAYLOADSTATE_LOADING;this._queueLoad(t,i)}},t.prototype._queueLoad=function(t,i){var r=this;t._addPendingData(this);n.Tools.LoadFile(this.delayLoadingFile,function(u){r._delayLoadingFunction(JSON.parse(u),r);r.delayLoadState=n.Engine.DELAYLOADSTATE_LOADED;r._delayInfo=[];t._removePendingData(r);for(var e=r._meshes,o=e.length,f=0;f<o;f++)r._applyToMesh(e[f]);i&&i()},function(){},t.database)},t.prototype.toLeftHanded=function(){var i=this.getIndices(!1),f,r,u,t;if(null!=i&&i.length>0){for(t=0;t<i.length;t+=3)f=i[t+0],i[t+0]=i[t+2],i[t+2]=f;this.setIndices(i)}if(r=this.getVerticesData(n.VertexBuffer.PositionKind,!1),null!=r&&r.length>0){for(t=0;t<r.length;t+=3)r[t+2]=-r[t+2];this.setVerticesData(n.VertexBuffer.PositionKind,r,!1)}if(u=this.getVerticesData(n.VertexBuffer.NormalKind,!1),null!=u&&u.length>0){for(t=0;t<u.length;t+=3)u[t+2]=-u[t+2];this.setVerticesData(n.VertexBuffer.NormalKind,u,!1)}},t.prototype.isDisposed=function(){return this._isDisposed},t.prototype.dispose=function(){for(var i=this._meshes,u=i.length,r,t=0;t<u;t++)this.releaseForMesh(i[t]);this._meshes=[];for(r in this._vertexBuffers)this._vertexBuffers[r].dispose();this._vertexBuffers={};this._totalVertices=0;this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer);this._indexBuffer=null;this._indices=[];this.delayLoadState=n.Engine.DELAYLOADSTATE_NONE;this.delayLoadingFile=null;this._delayLoadingFunction=null;this._delayInfo=[];this._boundingInfo=null;this._scene.removeGeometry(this);this._isDisposed=!0},t.prototype.copy=function(i){var f=new n.VertexData,h,e,u,o,c,s,r;for(f.indices=[],h=this.getIndices(),e=0;e<h.length;e++)f.indices.push(h[e]);o=!1;c=!1;for(u in this._vertexBuffers)s=this.getVerticesData(u),s instanceof Float32Array?f.set(new Float32Array(s),u):f.set(s.slice(0),u),c||(o=this.getVertexBuffer(u).isUpdatable(),c=!o);r=new t(i,this._scene,f,o,null);r.delayLoadState=this.delayLoadState;r.delayLoadingFile=this.delayLoadingFile;r._delayLoadingFunction=this._delayLoadingFunction;for(u in this._delayInfo)r._delayInfo=r._delayInfo||[],r._delayInfo.push(u);return r._boundingInfo=new n.BoundingInfo(this._extend.minimum,this._extend.maximum),r},t.prototype.serialize=function(){var t={};return t.id=this.id,n.Tags.HasTags(this)&&(t.tags=n.Tags.GetTags(this)),t},t.prototype.serializeVerticeData=function(){var t=this.serialize();return this.isVerticesDataPresent(n.VertexBuffer.PositionKind)&&(t.positions=this.getVerticesData(n.VertexBuffer.PositionKind)),this.isVerticesDataPresent(n.VertexBuffer.NormalKind)&&(t.normals=this.getVerticesData(n.VertexBuffer.NormalKind)),this.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(t.uvs=this.getVerticesData(n.VertexBuffer.UVKind)),this.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&(t.uv2s=this.getVerticesData(n.VertexBuffer.UV2Kind)),this.isVerticesDataPresent(n.VertexBuffer.UV3Kind)&&(t.uv3s=this.getVerticesData(n.VertexBuffer.UV3Kind)),this.isVerticesDataPresent(n.VertexBuffer.UV4Kind)&&(t.uv4s=this.getVerticesData(n.VertexBuffer.UV4Kind)),this.isVerticesDataPresent(n.VertexBuffer.UV5Kind)&&(t.uv5s=this.getVerticesData(n.VertexBuffer.UV5Kind)),this.isVerticesDataPresent(n.VertexBuffer.UV6Kind)&&(t.uv6s=this.getVerticesData(n.VertexBuffer.UV6Kind)),this.isVerticesDataPresent(n.VertexBuffer.ColorKind)&&(t.colors=this.getVerticesData(n.VertexBuffer.ColorKind)),this.isVerticesDataPresent(n.VertexBuffer.MatricesIndicesKind)&&(t.matricesIndices=this.getVerticesData(n.VertexBuffer.MatricesIndicesKind),t.matricesIndices._isExpanded=!0),this.isVerticesDataPresent(n.VertexBuffer.MatricesWeightsKind)&&(t.matricesWeights=this.getVerticesData(n.VertexBuffer.MatricesWeightsKind)),t.indices=this.getIndices(),t},t.ExtractFromMesh=function(n,t){var i=n._geometry;return i?i.copy(t):null},t.RandomId=function(){return n.Tools.RandomId()},t.ImportGeometry=function(t,i){var c=i.getScene(),a=t.geometryId,l,r,v,y,p,w,b,k,d,g,nt,tt,it,rt,o,f,u,e,h,s;if(a)l=c.getGeometryByID(a),l&&l.applyToMesh(i);else if(t instanceof ArrayBuffer){if(r=i._binaryInfo,r.positionsAttrDesc&&r.positionsAttrDesc.count>0&&(v=new Float32Array(t,r.positionsAttrDesc.offset,r.positionsAttrDesc.count),i.setVerticesData(n.VertexBuffer.PositionKind,v,!1)),r.normalsAttrDesc&&r.normalsAttrDesc.count>0&&(y=new Float32Array(t,r.normalsAttrDesc.offset,r.normalsAttrDesc.count),i.setVerticesData(n.VertexBuffer.NormalKind,y,!1)),r.uvsAttrDesc&&r.uvsAttrDesc.count>0&&(p=new Float32Array(t,r.uvsAttrDesc.offset,r.uvsAttrDesc.count),i.setVerticesData(n.VertexBuffer.UVKind,p,!1)),r.uvs2AttrDesc&&r.uvs2AttrDesc.count>0&&(w=new Float32Array(t,r.uvs2AttrDesc.offset,r.uvs2AttrDesc.count),i.setVerticesData(n.VertexBuffer.UV2Kind,w,!1)),r.uvs3AttrDesc&&r.uvs3AttrDesc.count>0&&(b=new Float32Array(t,r.uvs3AttrDesc.offset,r.uvs3AttrDesc.count),i.setVerticesData(n.VertexBuffer.UV3Kind,b,!1)),r.uvs4AttrDesc&&r.uvs4AttrDesc.count>0&&(k=new Float32Array(t,r.uvs4AttrDesc.offset,r.uvs4AttrDesc.count),i.setVerticesData(n.VertexBuffer.UV4Kind,k,!1)),r.uvs5AttrDesc&&r.uvs5AttrDesc.count>0&&(d=new Float32Array(t,r.uvs5AttrDesc.offset,r.uvs5AttrDesc.count),i.setVerticesData(n.VertexBuffer.UV5Kind,d,!1)),r.uvs6AttrDesc&&r.uvs6AttrDesc.count>0&&(g=new Float32Array(t,r.uvs6AttrDesc.offset,r.uvs6AttrDesc.count),i.setVerticesData(n.VertexBuffer.UV6Kind,g,!1)),r.colorsAttrDesc&&r.colorsAttrDesc.count>0&&(nt=new Float32Array(t,r.colorsAttrDesc.offset,r.colorsAttrDesc.count),i.setVerticesData(n.VertexBuffer.ColorKind,nt,!1,r.colorsAttrDesc.stride)),r.matricesIndicesAttrDesc&&r.matricesIndicesAttrDesc.count>0&&(tt=new Int32Array(t,r.matricesIndicesAttrDesc.offset,r.matricesIndicesAttrDesc.count),i.setVerticesData(n.VertexBuffer.MatricesIndicesKind,tt,!1)),r.matricesWeightsAttrDesc&&r.matricesWeightsAttrDesc.count>0&&(it=new Float32Array(t,r.matricesWeightsAttrDesc.offset,r.matricesWeightsAttrDesc.count),i.setVerticesData(n.VertexBuffer.MatricesWeightsKind,it,!1)),r.indicesAttrDesc&&r.indicesAttrDesc.count>0&&(rt=new Int32Array(t,r.indicesAttrDesc.offset,r.indicesAttrDesc.count),i.setIndices(rt)),r.subMeshesAttrDesc&&r.subMeshesAttrDesc.count>0)for(o=new Int32Array(t,r.subMeshesAttrDesc.offset,5*r.subMeshesAttrDesc.count),i.subMeshes=[],u=0;u<r.subMeshesAttrDesc.count;u++){var ut=o[5*u+0],ft=o[5*u+1],et=o[5*u+2],ot=o[5*u+3],st=o[5*u+4];new n.SubMesh(ut,ft,et,ot,st,i)}}else if(t.positions&&t.normals&&t.indices){if(i.setVerticesData(n.VertexBuffer.PositionKind,t.positions,!1),i.setVerticesData(n.VertexBuffer.NormalKind,t.normals,!1),t.uvs&&i.setVerticesData(n.VertexBuffer.UVKind,t.uvs,!1),t.uvs2&&i.setVerticesData(n.VertexBuffer.UV2Kind,t.uvs2,!1),t.uvs3&&i.setVerticesData(n.VertexBuffer.UV3Kind,t.uvs3,!1),t.uvs4&&i.setVerticesData(n.VertexBuffer.UV4Kind,t.uvs4,!1),t.uvs5&&i.setVerticesData(n.VertexBuffer.UV5Kind,t.uvs5,!1),t.uvs6&&i.setVerticesData(n.VertexBuffer.UV6Kind,t.uvs6,!1),t.colors&&i.setVerticesData(n.VertexBuffer.ColorKind,n.Color4.CheckColors4(t.colors,t.positions.length/3),!1),t.matricesIndices)if(t.matricesIndices._isExpanded)delete t.matricesIndices._isExpanded,i.setVerticesData(n.VertexBuffer.MatricesIndicesKind,t.matricesIndices,!1);else{for(f=[],u=0;u<t.matricesIndices.length;u++)e=t.matricesIndices[u],f.push(255&e),f.push((65280&e)>>8),f.push((16711680&e)>>16),f.push(e>>24);i.setVerticesData(n.VertexBuffer.MatricesIndicesKind,f,!1)}if(t.matricesIndicesExtra)if(t.matricesIndicesExtra._isExpanded)delete t.matricesIndices._isExpanded,i.setVerticesData(n.VertexBuffer.MatricesIndicesExtraKind,t.matricesIndicesExtra,!1);else{for(f=[],u=0;u<t.matricesIndicesExtra.length;u++)e=t.matricesIndicesExtra[u],f.push(255&e),f.push((65280&e)>>8),f.push((16711680&e)>>16),f.push(e>>24);i.setVerticesData(n.VertexBuffer.MatricesIndicesExtraKind,f,!1)}t.matricesWeights&&i.setVerticesData(n.VertexBuffer.MatricesWeightsKind,t.matricesWeights,!1);t.matricesWeightsExtra&&i.setVerticesData(n.VertexBuffer.MatricesWeightsExtraKind,t.matricesWeightsExtra,!1);i.setIndices(t.indices)}if(t.subMeshes)for(i.subMeshes=[],h=0;h<t.subMeshes.length;h++)s=t.subMeshes[h],new n.SubMesh(s.materialIndex,s.verticesStart,s.verticesCount,s.indexStart,s.indexCount,i);i._shouldGenerateFlatShading&&(i.convertToFlatShadedMesh(),delete i._shouldGenerateFlatShading);i.computeWorldMatrix(!0);c._selectionOctree&&c._selectionOctree.addMesh(i)},t.Parse=function(i,r,u){if(r.getGeometryByID(i.id))return null;var f=new t(i.id,r);return n.Tags.AddTagsTo(f,i.tags),i.delayLoadingFile?(f.delayLoadState=n.Engine.DELAYLOADSTATE_NOTLOADED,f.delayLoadingFile=u+i.delayLoadingFile,f._boundingInfo=new n.BoundingInfo(n.Vector3.FromArray(i.boundingBoxMinimum),n.Vector3.FromArray(i.boundingBoxMaximum)),f._delayInfo=[],i.hasUVs&&f._delayInfo.push(n.VertexBuffer.UVKind),i.hasUVs2&&f._delayInfo.push(n.VertexBuffer.UV2Kind),i.hasUVs3&&f._delayInfo.push(n.VertexBuffer.UV3Kind),i.hasUVs4&&f._delayInfo.push(n.VertexBuffer.UV4Kind),i.hasUVs5&&f._delayInfo.push(n.VertexBuffer.UV5Kind),i.hasUVs6&&f._delayInfo.push(n.VertexBuffer.UV6Kind),i.hasColors&&f._delayInfo.push(n.VertexBuffer.ColorKind),i.hasMatricesIndices&&f._delayInfo.push(n.VertexBuffer.MatricesIndicesKind),i.hasMatricesWeights&&f._delayInfo.push(n.VertexBuffer.MatricesWeightsKind),f._delayLoadingFunction=n.VertexData.ImportVertexData):n.VertexData.ImportVertexData(i,f),r.pushGeometry(f,!0),f},t}();n.Geometry=t;!function(t){var i;!function(i){var r=function(n){function t(t,i,r,u){n.call(this,t,i,null,!1,u);this._canBeRegenerated=r;this._beingRegenerated=!0;this.regenerate();this._beingRegenerated=!1}return u(t,n),t.prototype.canBeRegenerated=function(){return this._canBeRegenerated},t.prototype.regenerate=function(){this._canBeRegenerated&&(this._beingRegenerated=!0,this.setAllVerticesData(this._regenerateVertexData(),!1),this._beingRegenerated=!1)},t.prototype.asNewGeometry=function(t){return n.prototype.copy.call(this,t)},t.prototype.setAllVerticesData=function(t){this._beingRegenerated&&n.prototype.setAllVerticesData.call(this,t,!1)},t.prototype.setVerticesData=function(t,i){this._beingRegenerated&&n.prototype.setVerticesData.call(this,t,i,!1)},t.prototype._regenerateVertexData=function(){throw new Error("Abstract method");},t.prototype.copy=function(){throw new Error("Must be overriden in sub-classes.");},t.prototype.serialize=function(){var t=n.prototype.serialize.call(this);return t.canBeRegenerated=this.canBeRegenerated(),t},t}(t),f,e,o,s,h,c,l,a,v,y;i._Primitive=r;f=function(t){function i(i,r,u,f,e,o,s,h,c){void 0===c&&(c=n.Mesh.DEFAULTSIDE);t.call(this,i,r,s,h);this.pathArray=u;this.closeArray=f;this.closePath=e;this.offset=o;this.side=c}return u(i,t),i.prototype._regenerateVertexData=function(){return n.VertexData.CreateRibbon({pathArray:this.pathArray,closeArray:this.closeArray,closePath:this.closePath,offset:this.offset,sideOrientation:this.side})},i.prototype.copy=function(n){return new i(n,this.getScene(),this.pathArray,this.closeArray,this.closePath,this.offset,this.canBeRegenerated(),null,this.side)},i}(r);i.Ribbon=f;e=function(i){function r(t,r,u,f,e,o){void 0===o&&(o=n.Mesh.DEFAULTSIDE);i.call(this,t,r,f,e);this.size=u;this.side=o}return u(r,i),r.prototype._regenerateVertexData=function(){return n.VertexData.CreateBox({size:this.size,sideOrientation:this.side})},r.prototype.copy=function(n){return new r(n,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var n=i.prototype.serialize.call(this);return n.size=this.size,n},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var u=new t.Primitives.Box(i.id,r,i.size,i.canBeRegenerated,null);return n.Tags.AddTagsTo(u,i.tags),r.pushGeometry(u,!0),u},r}(r);i.Box=e;o=function(i){function r(t,r,u,f,e,o,s){void 0===s&&(s=n.Mesh.DEFAULTSIDE);i.call(this,t,r,e,o);this.segments=u;this.diameter=f;this.side=s}return u(r,i),r.prototype._regenerateVertexData=function(){return n.VertexData.CreateSphere({segments:this.segments,diameter:this.diameter,sideOrientation:this.side})},r.prototype.copy=function(n){return new r(n,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var n=i.prototype.serialize.call(this);return n.segments=this.segments,n.diameter=this.diameter,n},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var u=new t.Primitives.Sphere(i.id,r,i.segments,i.diameter,i.canBeRegenerated,null);return n.Tags.AddTagsTo(u,i.tags),r.pushGeometry(u,!0),u},r}(r);i.Sphere=o;s=function(t){function i(i,r,u,f,e,o,s){void 0===s&&(s=n.Mesh.DEFAULTSIDE);t.call(this,i,r,e,o);this.radius=u;this.tessellation=f;this.side=s}return u(i,t),i.prototype._regenerateVertexData=function(){return n.VertexData.CreateDisc({radius:this.radius,tessellation:this.tessellation,sideOrientation:this.side})},i.prototype.copy=function(n){return new i(n,this.getScene(),this.radius,this.tessellation,this.canBeRegenerated(),null,this.side)},i}(r);i.Disc=s;h=function(i){function r(t,r,u,f,e,o,s,h,c,l){void 0===s&&(s=1);void 0===l&&(l=n.Mesh.DEFAULTSIDE);i.call(this,t,r,h,c);this.height=u;this.diameterTop=f;this.diameterBottom=e;this.tessellation=o;this.subdivisions=s;this.side=l}return u(r,i),r.prototype._regenerateVertexData=function(){return n.VertexData.CreateCylinder({height:this.height,diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,tessellation:this.tessellation,subdivisions:this.subdivisions,sideOrientation:this.side})},r.prototype.copy=function(n){return new r(n,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.subdivisions,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var n=i.prototype.serialize.call(this);return n.height=this.height,n.diameterTop=this.diameterTop,n.diameterBottom=this.diameterBottom,n.tessellation=this.tessellation,n},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var u=new t.Primitives.Cylinder(i.id,r,i.height,i.diameterTop,i.diameterBottom,i.tessellation,i.subdivisions,i.canBeRegenerated,null);return n.Tags.AddTagsTo(u,i.tags),r.pushGeometry(u,!0),u},r}(r);i.Cylinder=h;c=function(i){function r(t,r,u,f,e,o,s,h){void 0===h&&(h=n.Mesh.DEFAULTSIDE);i.call(this,t,r,o,s);this.diameter=u;this.thickness=f;this.tessellation=e;this.side=h}return u(r,i),r.prototype._regenerateVertexData=function(){return n.VertexData.CreateTorus({diameter:this.diameter,thickness:this.thickness,tessellation:this.tessellation,sideOrientation:this.side})},r.prototype.copy=function(n){return new r(n,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var n=i.prototype.serialize.call(this);return n.diameter=this.diameter,n.thickness=this.thickness,n.tessellation=this.tessellation,n},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var u=new t.Primitives.Torus(i.id,r,i.diameter,i.thickness,i.tessellation,i.canBeRegenerated,null);return n.Tags.AddTagsTo(u,i.tags),r.pushGeometry(u,!0),u},r}(r);i.Torus=c;l=function(i){function r(n,t,r,u,f,e,o){i.call(this,n,t,e,o);this.width=r;this.height=u;this.subdivisions=f}return u(r,i),r.prototype._regenerateVertexData=function(){return n.VertexData.CreateGround({width:this.width,height:this.height,subdivisions:this.subdivisions})},r.prototype.copy=function(n){return new r(n,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)},r.prototype.serialize=function(){var n=i.prototype.serialize.call(this);return n.width=this.width,n.height=this.height,n.subdivisions=this.subdivisions,n},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var u=new t.Primitives.Ground(i.id,r,i.width,i.height,i.subdivisions,i.canBeRegenerated,null);return n.Tags.AddTagsTo(u,i.tags),r.pushGeometry(u,!0),u},r}(r);i.Ground=l;a=function(t){function i(n,i,r,u,f,e,o,s,h,c){t.call(this,n,i,h,c);this.xmin=r;this.zmin=u;this.xmax=f;this.zmax=e;this.subdivisions=o;this.precision=s}return u(i,t),i.prototype._regenerateVertexData=function(){return n.VertexData.CreateTiledGround({xmin:this.xmin,zmin:this.zmin,xmax:this.xmax,zmax:this.zmax,subdivisions:this.subdivisions,precision:this.precision})},i.prototype.copy=function(n){return new i(n,this.getScene(),this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision,this.canBeRegenerated(),null)},i}(r);i.TiledGround=a;v=function(i){function r(t,r,u,f,e,o){void 0===o&&(o=n.Mesh.DEFAULTSIDE);i.call(this,t,r,f,e);this.size=u;this.side=o}return u(r,i),r.prototype._regenerateVertexData=function(){return n.VertexData.CreatePlane({size:this.size,sideOrientation:this.side})},r.prototype.copy=function(n){return new r(n,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var n=i.prototype.serialize.call(this);return n.size=this.size,n},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var u=new t.Primitives.Plane(i.id,r,i.size,i.canBeRegenerated,null);return n.Tags.AddTagsTo(u,i.tags),r.pushGeometry(u,!0),u},r}(r);i.Plane=v;y=function(i){function r(t,r,u,f,e,o,s,h,c,l,a){void 0===a&&(a=n.Mesh.DEFAULTSIDE);i.call(this,t,r,c,l);this.radius=u;this.tube=f;this.radialSegments=e;this.tubularSegments=o;this.p=s;this.q=h;this.side=a}return u(r,i),r.prototype._regenerateVertexData=function(){return n.VertexData.CreateTorusKnot({radius:this.radius,tube:this.tube,radialSegments:this.radialSegments,tubularSegments:this.tubularSegments,p:this.p,q:this.q,sideOrientation:this.side})},r.prototype.copy=function(n){return new r(n,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var n=i.prototype.serialize.call(this);return n.radius=this.radius,n.tube=this.tube,n.radialSegments=this.radialSegments,n.tubularSegments=this.tubularSegments,n.p=this.p,n.q=this.q,n},r.Parse=function(i,r){if(r.getGeometryByID(i.id))return null;var u=new t.Primitives.TorusKnot(i.id,r,i.radius,i.tube,i.radialSegments,i.tubularSegments,i.p,i.q,i.canBeRegenerated,null);return n.Tags.AddTagsTo(u,i.tags),r.pushGeometry(u,!0),u},r}(r);i.TorusKnot=y}(i=t.Primitives||(t.Primitives={}))}(t=n.Geometry||(n.Geometry={}))}(i||(i={}));!function(n){var t=function(t){function i(i,r){t.call(this,i,r);this.generateOctree=!1;this._worldInverse=new n.Matrix}return u(i,t),Object.defineProperty(i.prototype,"subdivisions",{get:function(){return Math.min(this._subdivisionsX,this._subdivisionsY)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"subdivisionsX",{get:function(){return this._subdivisionsX},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"subdivisionsY",{get:function(){return this._subdivisionsY},enumerable:!0,configurable:!0}),i.prototype.optimize=function(n,t){void 0===t&&(t=32);this._subdivisionsX=n;this._subdivisionsY=n;this.subdivide(n);this.createOrUpdateSubmeshesOctree(t)},i.prototype.getHeightAtCoordinates=function(n,t){if(n-=this.position.x,t-=this.position.z,n/=this.scaling.x,t/=this.scaling.z,n<this._minX||n>this._maxX||t<this._minZ||t>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var i=this._getFacetAt(n,t),r=-(i.x*n+i.z*t+i.w)/i.y;return r*this.scaling.y+this.position.y},i.prototype.getNormalAtCoordinates=function(t,i){var r=new n.Vector3(0,1,0);return this.getNormalAtCoordinatesToRef(t,i,r),r},i.prototype.getNormalAtCoordinatesToRef=function(n,t,i){if(n-=this.position.x,t-=this.position.z,n/=this.scaling.x,t/=this.scaling.z,!(n<this._minX||n>this._maxX||t<this._minZ||t>this._maxZ)){this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var r=this._getFacetAt(n,t);i.x=r.x;i.y=r.y;i.z=r.z}},i.prototype.updateCoordinateHeights=function(){this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads();this._computeHeightQuads()},i.prototype._getFacetAt=function(n,t){var r=(this._subdivisionsX,this._subdivisionsY,Math.floor((n+this._maxX)*this._subdivisionsX/this._width)),u=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),i=this._heightQuads[u*this._subdivisionsX+r];return t<i.slope.x*n+i.slope.y?i.facet1:i.facet2},i.prototype._initHeightQuads=function(){var r=this._subdivisionsX,f=this._subdivisionsY,t,i,u;for(this._heightQuads=[],t=0;t<f;t++)for(i=0;i<r;i++)u={slope:n.Vector2.Zero(),facet1:new n.Vector4(0,0,0,0),facet2:new n.Vector4(0,0,0,0)},this._heightQuads[t*r+i]=u},i.prototype._computeHeightQuads=function(){for(var l,y,r=this.getVerticesData(n.VertexBuffer.PositionKind),t=n.Tmp.Vector3[3],e=n.Tmp.Vector3[2],a=n.Tmp.Vector3[1],h=n.Tmp.Vector3[0],b=n.Tmp.Vector3[4],k=n.Tmp.Vector3[5],p=n.Tmp.Vector3[6],u=n.Tmp.Vector3[7],f=n.Tmp.Vector3[8],i=0,o=0,s=0,w=0,d=0,g=0,nt=0,v=this._subdivisionsX,tt=this._subdivisionsY,c=0;c<tt;c++)for(l=0;l<v;l++)i=3*l,o=c*(v+1)*3,s=(c+1)*(v+1)*3,t.x=r[o+i],t.y=r[o+i+1],t.z=r[o+i+2],e.x=r[o+i+3],e.y=r[o+i+4],e.z=r[o+i+5],a.x=r[s+i],a.y=r[s+i+1],a.z=r[s+i+2],h.x=r[s+i+3],h.y=r[s+i+4],h.z=r[s+i+5],w=(h.z-t.z)/(h.x-t.x),d=t.z-w*t.x,e.subtractToRef(t,b),a.subtractToRef(t,k),h.subtractToRef(t,p),n.Vector3.CrossToRef(p,k,u),n.Vector3.CrossToRef(b,p,f),u.normalize(),f.normalize(),g=-(u.x*t.x+u.y*t.y+u.z*t.z),nt=-(f.x*e.x+f.y*e.y+f.z*e.z),y=this._heightQuads[c*v+l],y.slope.copyFromFloats(w,d),y.facet1.copyFromFloats(u.x,u.y,u.z,g),y.facet2.copyFromFloats(f.x,f.y,f.z,nt)},i}(n.Mesh);n.GroundMesh=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e){void 0===u&&(u=null);t.call(this,i,r,u,f,e);this.color=new n.Color3(1,1,1);this.alpha=1;this._positionBuffer={};f&&(this.color=f.color.clone(),this.alpha=f.alpha);this._intersectionThreshold=.1;this._colorShader=new n.ShaderMaterial("colorShader",r,"color",{attributes:[n.VertexBuffer.PositionKind],uniforms:["worldViewProjection","color"],needAlphaBlending:!0});this._positionBuffer[n.VertexBuffer.PositionKind]=null}return u(i,t),Object.defineProperty(i.prototype,"intersectionThreshold",{get:function(){return this._intersectionThreshold},set:function(t){this._intersectionThreshold!==t&&(this._intersectionThreshold=t,this.geometry&&(this.geometry.boundingBias=new n.Vector2(0,t)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"material",{get:function(){return this._colorShader},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"checkCollisions",{get:function(){return!1},enumerable:!0,configurable:!0}),i.prototype.createInstance=function(){return n.Tools.Log("LinesMeshes do not support createInstance."),null},i.prototype._bind=function(){var t=this.getScene().getEngine();this._positionBuffer[n.VertexBuffer.PositionKind]=this._geometry.getVertexBuffer(n.VertexBuffer.PositionKind);t.bindBuffers(this._positionBuffer,this._geometry.getIndexBuffer(),this._colorShader.getEffect());this._colorShader.setColor4("color",this.color.toColor4(this.alpha))},i.prototype._draw=function(n){if(this._geometry&&this._geometry.getVertexBuffers()&&this._geometry.getIndexBuffer()){var t=this.getScene().getEngine();t.draw(!1,n.indexStart,n.indexCount)}},i.prototype.dispose=function(n){this._colorShader.dispose();t.prototype.dispose.call(this,n)},i.prototype.clone=function(n,t,r){return new i(n,this.getScene(),t,this,r)},i}(n.Mesh);n.LinesMesh=t}(i||(i={}));!function(n){var t=function(){function n(n,t,i){var r=this;void 0===t&&(t="");void 0===i&&(i="black");this._renderingCanvas=n;this._loadingText=t;this._loadingDivBackgroundColor=i;this._resizeLoadingUI=function(){var n=r._renderingCanvas.getBoundingClientRect();r._loadingDiv.style.position="absolute";r._loadingDiv.style.left=n.left+"px";r._loadingDiv.style.top=n.top+"px";r._loadingDiv.style.width=n.width+"px";r._loadingDiv.style.height=n.height+"px"}}return n.prototype.displayLoadingUI=function(){var u=this,n,i,r,t;this._loadingDiv||(this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,n=new Image,n.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuM4zml1AAAARbSURBVHhe7Z09aFNRFMc716kuLrq4FdyLq4Wi4CAoRQcR0UJBUBdRiuLSIYMo6CA4FF2sgw6CFAdFUOpSQYcWO4hD26UQCfXrIQrx/JJzw1OSWq3NPeL/B4Fy+0jg/HO+7j3vpUcI8b/Q39+/49ihfWdPHT94Yf/e3Se3bd263f8lus218TPn6vV6Ya8Wi/MzNRNmj18iusX9W1evmP1/EKNEIVG6CMbG6E3bt+fT++pHha8NoHdT72bLE8NDg7tGU64gLLndV4Wc4m8j/pS+vr4tGB/DT16v3Fyr8dvBe/jbit8BL0AES9LX1iPAz+BR/hFiLVCynj95dPzNy6fv3IZ/k4L3948Sq7FzYGBg4vLFGxitabuOFCbWNKGrMnbiUuo18KaV6tIHv6YtvL9/nOgE31jCktmrY7k6+/zhE4yP4Vf7hiNqh/BWWEl8mzDol4p22Lf7cIdvdUMEvv0Y2S9fE5S1hLzpqTsPkiep//gFGPnR3Yl7GL5p/xYFBrTwM+iXio3GqpwDGL5p/xYNIX7XG8Q6IJRgdIzf1KBBgafII7oMidhyQtVFaMA2Bt7il4huQRhaXphbcR2g4RXqBzKAGHiCCwGFVUAj/m/RTRDj29cvn10I0PZ3LghH5f4CL1EFlQmqqXK3jDDKFxmhQ3Yt6oQseUZGKmMnTpsOqc8o1F9kBOMjQlOLeqEeIyOc6JV6jYLJD/+XyIFvnzdgl9aXRQ5I2qZDK1SpospMqaoqON/wZZGDciLnMMiXRS7IF4hhqMTNTdk7CFu+LHLhR7BQqBvPDJUUQqCGvCMATHUgBmhWNgApmdOda9YpM+VwRYfuyyIXDK8hBlilNerLIheMZCKGwlUAyru6GlwOgPUbRxADdJ9FAChxXY864viyyEXqPxhc0M2TAfAbatSdRyHtXymhByEdRnE3ky+JnHAIhSA0h74kckETmHoQbSgGwJrCIRMEPSRIBCRIMAhZaYhaggQhJXUJEoRU9mofKwh+F22dLRRfEjlJM7w6KQwCoQpBOKTyJZETjmwRxKqtGV8SOSkNOGjKPQppBEgDDkFgpxdBVGkFgaYQQXRIFQSObk0P5ZFIpAZRHXsQ0r0hCluBWKkuvVbYCkQaCdL5ehBScudJP4yY+rLISdps1NBDEJKXMMmoSfggWC4ZQRR17oFYXph7hSiquIKQ+hJGTX1J5MYSPD/GVdNzsgLBwZVCVyAQAkF0ohiI/c1fS6tNXq9UfEnkhudmIQolsS+J3Hh/UtNDzQLhj42VKJFInqLwFYiUU5ToA+HdfI0JevUpQUAIn+vSz2lHIuUV/dJOIHhOY/IWVWGBIHQtzs88s9zyWBuTgcBLzGOmeNnfF/QslSDgMeQW85i3DOQxuipxAkCyZ8SIm4Omp+7MMlCB59j6sKZcMoM4iIEoeI2J9AKxrFobZx0v4vYInuHFS4J1GQRCAGaLEYQXfyMML5XSQgghhBBCCCH+cXp6vgNhKpSKX/XdOAAAAABJRU5ErkJggg==",n.style.position="absolute",n.style.left="50%",n.style.top="50%",n.style.marginLeft="-50px",n.style.marginTop="-50px",n.style.transition="transform 1.0s ease",n.style.webkitTransition="-webkit-transform 1.0s ease",i=360,r=function(){i+=360;n.style.transform="rotateZ("+i+"deg)";n.style.webkitTransform="rotateZ("+i+"deg)"},n.addEventListener("transitionend",r),n.addEventListener("webkitTransitionEnd",r),this._loadingDiv.appendChild(n),t=new Image,t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuM4zml1AAAAYJSURBVHhe7Zy/qx1FFMff/2Av2Nvbi4WFiiAEY/OQ2IgQsbCJQoqkCAgpFLXyoZURLfwBIiIpgqZJoYQYlWelNsIrNOxDJcrzfHe+G97dnTl75u7euzv7zgcWHrlnZmfOmXPmzI/NjuM4juM4juM4juM4juM4juM4juM4juM45fPic08/uHf5/CvffH7lnT8PfrtxdHS0n3p+/fHGl5+89/prr5599iEWd8bg0rkXHoFyqehKnlxQpjYSDHTm9JMPsGrHylOPPXofvICKXMcIGtXdf/76AYbm6xyNW9e/eAtKC7rbKLXnvHHx5Sf4auc4Ek7OQkFU1Dap/vv37k/wSjblZANFiFIGzw98hhizwqBgs04mCBdQRNCHidoAEtY+lLIvtSdoGFeyql2ZH57HBH4sE7O+o/r9l+8/ZXUni68+2jsHBQQ9qNRGeP/tSxdSYQX/roUcpL4/f3vtM9TD+jTq92n1LQ7jxF1hhGPtwWL3gGccy8JuS1r8sVWBGXNVdSKMYjBGPUJjCzooiGuSpnwlnnOGP2dhHRSLNgpHp2oMKIriK8TmG4Qh/rwW8D6pps9b9im+LDDipXOqMVJrAngBfg9i98gevWKA+/nnCod3Dr5GfaHaDgidVym6HKRjGIkpqthcAVKGxNqBImbEo66kjCih8AOpNmkUmbMuUrR8kEqiU6FvHZLGAPJ71JCYSyhiBqmwFE2GoD6jLGIfDHtG6EzoU4dK21PCqIRMEF0FGRjFzGDtIkXVAdATvsqfT9CJ0JcOFdYiFIsiMlqYy1YOFpQo2OddqBtyEaq9y+efoVh5oPHoROjLKn0j3JIE5Ka8UqZRtGrMnneX6yVofOhDh94MSbznTcpqmDOt1vyQzOgaJAF4F3JBfIXesrNEGWWmjIX7UBZ6jRJbBMLg/DmJiKUGVHleIpnVNTa+jakzkAviJqLhi4MC9XQGBrZeKJZESSrKy7ik0VGFWhQBRDTHIACKQ5l9nAjy75gya4a2w+Jhs0FJdc0xX/GwUbAqFBkZi7QpJ2w16WUbjFyK9MJF3KaoEM74KhVtLrQOrsmRxkbdHEqmSC/c+EuGnIFkjW7Ih2Kr4CCMIvNG2hrrgLpCjiFloooYCjyYrzCRyvhyBthkIPuQtsZGdnbMTezyDiU71KTC5zr7aVsHbsz2tllrEkS5UHwU1tq1HbtPW4UbeB0O7xx8R5EsMJql+BheUmHjkNVmIRP7LutoM3+D4O4tG7vCkNO9ESZ4lL3J6rKRMPx4qKbD/A0icf8CG7tC7kTahnMTwleuYSrsS7GatRAvfZh1tTm5BmmQCdZ8a0Sefe28xUrRBkmFLKy8KTIKUDRX0Y1xagPgwbaIdeFnQULmKak3xvwNMkVGgok/N5XNoehJvejRlCDl9escI28dJU0tZ++nBTJE9mEF647x5Ehbo4s5hDOKFIU0PdofeA5F5k1q63zIWmQqNI/P3ZubjFTqKxQ3jyjHAOX0RdlgVO9hzRFpczRcjZ3Gbxxpc7Qj6+5pTYF2OFXawNI+yDGf1k2NcvOlzBQeDQ/t7zD7DsEDpJ2xATXaNtDWUS4IzP4DS2ljajAVu57SUkYw245ptxZxA5JiZaJ0DswudGn3kYUy54426EjoT4dZfYbccxC2nI92cDkZHQr96jD4AGkMDKeSy/COBsRe6VTSKFN6irLeaCh3IteQjt1E5+oudsG/b/2DfZ5AqsYo8vMDK9LB1HzSsLWvlGThdxXvC6+NsqyPPWP0pMINtbdsajfVeC6f/GZ+cdAofQoB1d+Hf9waY98I7+RXWab3Lt4zYkjHtTnlOLXHYMsCh1zWeQYehu1zfNPOOiys/d91LAKEBSgh6MJMbSA82AaHofDgAIwbgvVvlLNS11nModMm4UZergLHZBZrodmBuA3lBB1thdorSjkOmATMDwg/UBQVtglqQyx6fbEJ+H3IWIapjYAjAfeIgeCMHldueJvFaqDaAHhwf8qNsEEQ1iQbOoUUGIbCLRc8+Bvfp4jyd2FEijuO4ziO4ziO4ziO4ziO4ziO4ziO4ziOUzw7O/8D0P7rcZ/GEboAAAAASUVORK5CYII=",t.style.position="absolute",t.style.left="50%",t.style.top="50%",t.style.marginLeft="-50px",t.style.marginTop="-50px",this._loadingDiv.appendChild(t),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),setTimeout(function(){u._loadingDiv.style.opacity="1";n.style.transform="rotateZ(360deg)";n.style.webkitTransform="rotateZ(360deg)"},0))},n.prototype.hideLoadingUI=function(){var n=this,t;this._loadingDiv&&(t=function(){n._loadingDiv&&(document.body.removeChild(n._loadingDiv),window.removeEventListener("resize",n._resizeLoadingUI),n._loadingDiv=null)},this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",t))},Object.defineProperty(n.prototype,"loadingUIText",{set:function(n){this._loadingText=n;this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"loadingUIBackgroundColor",{get:function(){return this._loadingDivBackgroundColor},set:function(n){this._loadingDivBackgroundColor=n;this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)},enumerable:!0,configurable:!0}),n}();n.DefaultLoadingScreen=t}(i||(i={}));!function(n){var t=function(){function t(){this._audioContext=null;this._audioContextInitialized=!1;this.canUseWebAudio=!1;this.WarnedWebAudioUnsupported=!1;this.unlocked=!1;this.isMP3supported=!1;this.isOGGsupported=!1;"undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext||(window.AudioContext=window.AudioContext||window.webkitAudioContext,this.canUseWebAudio=!0);var n=document.createElement("audio");n&&n.canPlayType&&n.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")&&(this.isMP3supported=!0);n&&n.canPlayType&&n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0);/iPad|iPhone|iPod/.test(navigator.platform)?this._unlockiOSaudio():this.unlocked=!0}return Object.defineProperty(t.prototype,"audioContext",{get:function(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext},enumerable:!0,configurable:!0}),t.prototype._unlockiOSaudio=function(){var n=this,t=function(){var r=n.audioContext.createBuffer(1,1,22050),i=n.audioContext.createBufferSource();i.buffer=r;i.connect(n.audioContext.destination);i.start(0);setTimeout(function(){i.playbackState!==i.PLAYING_STATE&&i.playbackState!==i.FINISHED_STATE||(n.unlocked=!0,window.removeEventListener("touchend",t,!1),n.onAudioUnlocked&&n.onAudioUnlocked())},0)};window.addEventListener("touchend",t,!1)},t.prototype._initializeAudioContext=function(){try{this.canUseWebAudio&&(this._audioContext=new AudioContext,this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this.masterGain.connect(this._audioContext.destination),this._audioContextInitialized=!0)}catch(t){this.canUseWebAudio=!1;n.Tools.Error("Web Audio: "+t.message)}},t.prototype.dispose=function(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1);this.WarnedWebAudioUnsupported=!1},t.prototype.getGlobalVolume=function(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1},t.prototype.setGlobalVolume=function(n){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=n)},t.prototype.connectToAnalyser=function(n){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser=n,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))},t}();n.AudioEngine=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f){var o=this,l,h,s,c,e;if(this.autoplay=!1,this.loop=!1,this.useCustomAttenuation=!1,this.spatialSound=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=n.Vector3.Zero(),this._localDirection=new n.Vector3(1,0,0),this._volume=1,this._isLoaded=!1,this._isReadyToPlay=!1,this.isPlaying=!1,this.isPaused=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,this._scene=r,this._readyToPlayCallback=u,this._customAttenuationFunction=function(n,t,i){return t<i?n*(1-t/i):0},f&&(this.autoplay=f.autoplay||!1,this.loop=f.loop||!1,void 0!==f.volume&&(this._volume=f.volume),this.spatialSound=f.spatialSound||!1,this.maxDistance=f.maxDistance||100,this.useCustomAttenuation=f.useCustomAttenuation||!1,this.rolloffFactor=f.rolloffFactor||1,this.refDistance=f.refDistance||1,this.distanceModel=f.distanceModel||"linear",this._playbackRate=f.playbackRate||1,this._streaming=f.streaming||!1),n.Engine.audioEngine.canUseWebAudio){if(this._soundGain=n.Engine.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._ouputAudioNode=this._soundGain,this.spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.AddSound(this),l=!0,i){"string"==typeof i&&(this._urlType="String");Array.isArray(i)&&(this._urlType="Array");i instanceof ArrayBuffer&&(this._urlType="ArrayBuffer");h=[];s=!1;switch(this._urlType){case"ArrayBuffer":i.byteLength>0&&(s=!0,this._soundLoaded(i));break;case"String":h.push(i);case"Array":for(0===h.length&&(h=i),c=0;c<h.length;c++)if(e=h[c],e.indexOf(".mp3",e.length-4)!==-1&&n.Engine.audioEngine.isMP3supported&&(s=!0),e.indexOf(".ogg",e.length-4)!==-1&&n.Engine.audioEngine.isOGGsupported&&(s=!0),e.indexOf(".wav",e.length-4)!==-1&&(s=!0),s){this._streaming?(this._htmlAudioElement=new Audio(e),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,this._htmlAudioElement.crossOrigin="anonymous",this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",function(){o._isReadyToPlay=!0;o.autoplay&&o.play();o._readyToPlayCallback&&o._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement)):n.Tools.LoadFile(e,function(n){o._soundLoaded(n)},null,this._scene.database,!0);break}break;default:l=!1}l?s||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(function(){o._readyToPlayCallback()},1e3)):n.Tools.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}}else this._scene.mainSoundTrack.AddSound(this),n.Engine.audioEngine.WarnedWebAudioUnsupported||(n.Tools.Error("Web Audio is not supported by your browser."),n.Engine.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(function(){o._readyToPlayCallback()},1e3)}return t.prototype.dispose=function(){n.Engine.audioEngine.canUseWebAudio&&this._isReadyToPlay&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.RemoveSound(this):this._scene.soundTracks[this.soundTrackId].RemoveSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._connectedMesh&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedMesh=null))},t.prototype._soundLoaded=function(t){var i=this;this._isLoaded=!0;n.Engine.audioEngine.audioContext.decodeAudioData(t,function(n){i._audioBuffer=n;i._isReadyToPlay=!0;i.autoplay&&i.play();i._readyToPlayCallback&&i._readyToPlayCallback()},function(t){n.Tools.Error("Error while decoding audio data for: "+i.name+" / Error: "+t)})},t.prototype.setAudioBuffer=function(t){n.Engine.audioEngine.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=!0)},t.prototype.updateOptions=function(n){n&&(this.loop=n.loop||this.loop,this.maxDistance=n.maxDistance||this.maxDistance,this.useCustomAttenuation=n.useCustomAttenuation||this.useCustomAttenuation,this.rolloffFactor=n.rolloffFactor||this.rolloffFactor,this.refDistance=n.refDistance||this.refDistance,this.distanceModel=n.distanceModel||this.distanceModel,this._playbackRate=n.playbackRate||this._playbackRate,this._updateSpatialParameters(),this.isPlaying&&(this._streaming?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource.playbackRate.value=this._playbackRate))},t.prototype._createSpatialParameters=function(){n.Engine.audioEngine.canUseWebAudio&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=n.Engine.audioEngine.audioContext.createPanner(),this._updateSpatialParameters(),this._soundPanner.connect(this._ouputAudioNode),this._inputAudioNode=this._soundPanner)},t.prototype._updateSpatialParameters=function(){this.spatialSound&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},t.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF";this._switchPanningModel()},t.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower";this._switchPanningModel()},t.prototype._switchPanningModel=function(){n.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&(this._soundPanner.panningModel=this._panningModel)},t.prototype.connectToSoundTrackAudioNode=function(t){n.Engine.audioEngine.canUseWebAudio&&(this._isOutputConnected&&this._ouputAudioNode.disconnect(),this._ouputAudioNode.connect(t),this._isOutputConnected=!0)},t.prototype.setDirectionalCone=function(t,i,r){return i<t?void n.Tools.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._coneInnerAngle=t,this._coneOuterAngle=i,this._coneOuterGain=r,this._isDirectional=!0,void(this.isPlaying&&this.loop&&(this.stop(),this.play())))},t.prototype.setPosition=function(t){this._position=t;n.Engine.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)},t.prototype.setLocalDirectionToMesh=function(t){this._localDirection=t;n.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.isPlaying&&this._updateDirection()},t.prototype._updateDirection=function(){var i=this._connectedMesh.getWorldMatrix(),t=n.Vector3.TransformNormal(this._localDirection,i);t.normalize();this._soundPanner.setOrientation(t.x,t.y,t.z)},t.prototype.updateDistanceFromListener=function(){if(n.Engine.audioEngine.canUseWebAudio&&this._connectedMesh&&this.useCustomAttenuation){var t=this._connectedMesh.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}},t.prototype.setAttenuationFunction=function(n){this._customAttenuationFunction=n},t.prototype.play=function(t,i){var u=this,r;if(this._isReadyToPlay&&this._scene.audioEnabled)try{this._startOffset<0&&(t=-this._startOffset,this._startOffset=0);r=t?n.Engine.audioEngine.audioContext.currentTime+t:n.Engine.audioEngine.audioContext.currentTime;this._soundSource&&this._streamingSource||this.spatialSound&&(this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedMesh?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z)));this._streaming?(this._streamingSource||(this._streamingSource=n.Engine.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){u._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement.play()):(this._soundSource=n.Engine.audioEngine.audioContext.createBufferSource(),this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=function(){u._onended()},this._soundSource.start(r,this.isPaused?this._startOffset%this._soundSource.buffer.duration:i?i:0));this._startTime=r;this.isPlaying=!0;this.isPaused=!1}catch(f){n.Tools.Error("Error while trying to play audio: "+this.name+", "+f.message)}},t.prototype._onended=function(){this.isPlaying=!1;this.onended&&this.onended()},t.prototype.stop=function(t){if(this.isPlaying){if(this._streaming)this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0);else{var i=t?n.Engine.audioEngine.audioContext.currentTime+t:n.Engine.audioEngine.audioContext.currentTime;this._soundSource.stop(i);this._soundSource.onended=null;this.isPaused||(this._startOffset=0)}this.isPlaying=!1}},t.prototype.pause=function(){this.isPlaying&&(this.isPaused=!0,this._streaming?this._htmlAudioElement.pause():(this.stop(0),this._startOffset+=n.Engine.audioEngine.audioContext.currentTime-this._startTime))},t.prototype.setVolume=function(t,i){n.Engine.audioEngine.canUseWebAudio&&(i?(this._soundGain.gain.cancelScheduledValues(n.Engine.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,n.Engine.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,n.Engine.audioEngine.audioContext.currentTime+i)):this._soundGain.gain.value=t);this._volume=t},t.prototype.setPlaybackRate=function(n){this._playbackRate=n;this.isPlaying&&(this._streaming?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource.playbackRate.value=this._playbackRate)},t.prototype.getVolume=function(){return this._volume},t.prototype.attachToMesh=function(n){var t=this;this._connectedMesh&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null);this._connectedMesh=n;this.spatialSound||(this.spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play()));this._onRegisterAfterWorldMatrixUpdate(this._connectedMesh);this._registerFunc=function(n){return t._onRegisterAfterWorldMatrixUpdate(n)};n.registerAfterWorldMatrixUpdate(this._registerFunc)},t.prototype.detachFromMesh=function(){this._connectedMesh&&(this._connectedMesh.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedMesh=null)},t.prototype._onRegisterAfterWorldMatrixUpdate=function(t){this.setPosition(t.getBoundingInfo().boundingSphere.centerWorld);n.Engine.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()},t.prototype.clone=function(){var i=this;if(this._streaming)return null;var r=function(){i._isReadyToPlay?(n._audioBuffer=i.getAudioBuffer(),n._isReadyToPlay=!0,n.autoplay&&n.play()):window.setTimeout(r,300)},u={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},n=new t(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,u);return this.useCustomAttenuation&&n.setAttenuationFunction(this._customAttenuationFunction),n.setPosition(this._position),n.setPlaybackRate(this._playbackRate),r(),n},t.prototype.getAudioBuffer=function(){return this._audioBuffer},t.prototype.serialize=function(){var n={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId};return this.spatialSound&&(this._connectedMesh&&(n.connectedMeshId=this._connectedMesh.id),n.position=this._position.asArray(),n.refDistance=this.refDistance,n.distanceModel=this.distanceModel,n.isDirectional=this._isDirectional,n.localDirectionToMesh=this._localDirection.asArray(),n.coneInnerAngle=this._coneInnerAngle,n.coneOuterAngle=this._coneOuterAngle,n.coneOuterGain=this._coneOuterGain),n},t.Parse=function(i,r,u,f){var l,o=i.name,e,s,h,a,v,c;return l=i.url?u+i.url:u+o,s={autoplay:i.autoplay,loop:i.loop,volume:i.volume,spatialSound:i.spatialSound,maxDistance:i.maxDistance,rolloffFactor:i.rolloffFactor,refDistance:i.refDistance,distanceModel:i.distanceModel,playbackRate:i.playbackRate},f?(h=function(){f._isReadyToPlay?(e._audioBuffer=f.getAudioBuffer(),e._isReadyToPlay=!0,e.autoplay&&e.play()):window.setTimeout(h,300)},e=new t(o,new ArrayBuffer(0),r,null,s),h()):(e=new t(o,l,r,function(){r._removePendingData(e)},s),r._addPendingData(e)),i.position&&(a=n.Vector3.FromArray(i.position),e.setPosition(a)),i.isDirectional&&(e.setDirectionalCone(i.coneInnerAngle||360,i.coneOuterAngle||360,i.coneOuterGain||0),i.localDirectionToMesh)&&(v=n.Vector3.FromArray(i.localDirectionToMesh),e.setLocalDirectionToMesh(v)),i.connectedMeshId&&(c=r.getMeshByID(i.connectedMeshId),c&&e.attachToMesh(c)),e},t}();n.Sound=t}(i||(i={}));!function(n){var t=function(){function t(n,t){this.id=-1;this._isMainTrack=!1;this._isInitialized=!1;this._scene=n;this.soundCollection=[];this._options=t;this._isMainTrack||(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1)}return t.prototype._initializeSoundTrackAudioGraph=function(){n.Engine.audioEngine.canUseWebAudio&&(this._outputAudioNode=n.Engine.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(n.Engine.audioEngine.masterGain),this._options&&(this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._options.mainTrack&&(this._isMainTrack=this._options.mainTrack)),this._isInitialized=!0)},t.prototype.dispose=function(){if(n.Engine.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect();this._outputAudioNode=null}},t.prototype.AddSound=function(t){this._isInitialized||this._initializeSoundTrackAudioGraph();n.Engine.audioEngine.canUseWebAudio&&t.connectToSoundTrackAudioNode(this._outputAudioNode);t.soundTrackId&&(t.soundTrackId===-1?this._scene.mainSoundTrack.RemoveSound(t):this._scene.soundTracks[t.soundTrackId].RemoveSound(t));this.soundCollection.push(t);t.soundTrackId=this.id},t.prototype.RemoveSound=function(n){var t=this.soundCollection.indexOf(n);t!==-1&&this.soundCollection.splice(t,1)},t.prototype.setVolume=function(t){n.Engine.audioEngine.canUseWebAudio&&(this._outputAudioNode.gain.value=t)},t.prototype.switchPanningModelToHRTF=function(){if(n.Engine.audioEngine.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()},t.prototype.switchPanningModelToEqualPower=function(){if(n.Engine.audioEngine.canUseWebAudio)for(var t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()},t.prototype.connectToAnalyser=function(t){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this._connectedAnalyser=t;n.Engine.audioEngine.canUseWebAudio&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,n.Engine.audioEngine.masterGain))},t}();n.SoundTrack=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s,h){var c=this;void 0===o&&(o=n.Texture.BILINEAR_SAMPLINGMODE);t.call(this,i,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,f,e,o,s,h);this.direction=r;this.blurWidth=u;this.onApplyObservable.add(function(n){n.setFloat2("screenSize",c.width,c.height);n.setVector2("direction",c.direction);n.setFloat("blurWidth",c.blurWidth)})}return u(i,t),i}(n.PostProcess),i=function(){function i(t,r,u){var o,e,s,f;this._vertexBuffers={};this._mainTextureDesiredSize={width:0,height:0};this._meshes={};this._maxSize=0;this._shouldRender=!1;this._instanceGlowingMeshStencilReference=i.glowingMeshStencilReference++;this._excludedMeshes={};this.innerGlow=!0;this.outerGlow=!0;this.isEnabled=!0;this.onDisposeObservable=new n.Observable;this.onBeforeRenderMainTextureObservable=new n.Observable;this.onBeforeBlurObservable=new n.Observable;this.onAfterBlurObservable=new n.Observable;this.onBeforeComposeObservable=new n.Observable;this.onAfterComposeObservable=new n.Observable;this.onSizeChangedObservable=new n.Observable;this._scene=r;o=r.getEngine();this._engine=o;this._maxSize=this._engine.getCaps().maxTextureSize;this._scene.highlightLayers.push(this);this._engine.isStencilEnable||n.Tools.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new BABYLON.Engine(canvas, antialias, { stencil: true }");this._options=u||{mainTextureRatio:.25,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:n.Engine.ALPHA_COMBINE};this._options.mainTextureRatio=this._options.mainTextureRatio||.25;this._options.blurTextureSizeRatio=this._options.blurTextureSizeRatio||.5;this._options.blurHorizontalSize=this._options.blurHorizontalSize||1;this._options.blurVerticalSize=this._options.blurVerticalSize||1;this._options.alphaBlendingMode=this._options.alphaBlendingMode||n.Engine.ALPHA_COMBINE;e=[];e.push(1,1);e.push(-1,1);e.push(-1,-1);e.push(1,-1);s=new n.VertexBuffer(o,e,n.VertexBuffer.PositionKind,!1,!1,2);this._vertexBuffers[n.VertexBuffer.PositionKind]=s;f=[];f.push(0);f.push(1);f.push(2);f.push(0);f.push(2);f.push(3);this._indexBuffer=o.createIndexBuffer(f);this._glowMapMergeEffect=o.createEffect("glowMapMerge",[n.VertexBuffer.PositionKind],["offset"],["textureSampler"],"");this.setMainTextureSize();this.createTextureAndPostProcesses()}return Object.defineProperty(i.prototype,"blurHorizontalSize",{get:function(){return this._horizontalBlurPostprocess.blurWidth},set:function(n){this._horizontalBlurPostprocess.blurWidth=n},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"blurVerticalSize",{get:function(){return this._verticalBlurPostprocess.blurWidth},set:function(n){this._verticalBlurPostprocess.blurWidth=n},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"camera",{get:function(){return this._options.camera},enumerable:!0,configurable:!0}),i.prototype.createTextureAndPostProcesses=function(){var r=this,u=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,f=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio,e;u=n.Tools.GetExponentOfTwo(u,this._maxSize);f=n.Tools.GetExponentOfTwo(f,this._maxSize);this._mainTexture=new n.RenderTargetTexture("HighlightLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,n.Engine.TEXTURETYPE_UNSIGNED_INT);this._mainTexture.activeCamera=this._options.camera;this._mainTexture.wrapU=n.Texture.CLAMP_ADDRESSMODE;this._mainTexture.wrapV=n.Texture.CLAMP_ADDRESSMODE;this._mainTexture.anisotropicFilteringLevel=1;this._mainTexture.updateSamplingMode(n.Texture.BILINEAR_SAMPLINGMODE);this._mainTexture.renderParticles=!1;this._mainTexture.renderList=null;this._blurTexture=new n.RenderTargetTexture("HighlightLayerBlurRTT",{width:u,height:f},this._scene,!1,!0,n.Engine.TEXTURETYPE_UNSIGNED_INT);this._blurTexture.wrapU=n.Texture.CLAMP_ADDRESSMODE;this._blurTexture.wrapV=n.Texture.CLAMP_ADDRESSMODE;this._blurTexture.anisotropicFilteringLevel=16;this._blurTexture.updateSamplingMode(n.Texture.TRILINEAR_SAMPLINGMODE);this._blurTexture.renderParticles=!1;this._downSamplePostprocess=new n.PassPostProcess("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine());this._downSamplePostprocess.onApplyObservable.add(function(n){n.setTexture("textureSampler",r._mainTexture)});this._options.alphaBlendingMode===n.Engine.ALPHA_COMBINE?(this._horizontalBlurPostprocess=new t("HighlightLayerHBP",new n.Vector2(1,0),this._options.blurHorizontalSize,1,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(n){n.setFloat2("screenSize",u,f)}),this._verticalBlurPostprocess=new t("HighlightLayerVBP",new n.Vector2(0,1),this._options.blurVerticalSize,1,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(n){n.setFloat2("screenSize",u,f)})):(this._horizontalBlurPostprocess=new n.BlurPostProcess("HighlightLayerHBP",new n.Vector2(1,0),this._options.blurHorizontalSize,1,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(function(n){n.setFloat2("screenSize",u,f)}),this._verticalBlurPostprocess=new n.BlurPostProcess("HighlightLayerVBP",new n.Vector2(0,1),this._options.blurVerticalSize,1,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(function(n){n.setFloat2("screenSize",u,f)}));this._mainTexture.onAfterUnbindObservable.add(function(){r.onBeforeBlurObservable.notifyObservers(r);r._scene.postProcessManager.directRender([r._downSamplePostprocess,r._horizontalBlurPostprocess,r._verticalBlurPostprocess],r._blurTexture.getInternalTexture());r.onAfterBlurObservable.notifyObservers(r)});e=function(t){var u=t.getRenderingMesh(),l=r._scene,h=l.getEngine(),e,c;if(h.setState(t.getMaterial().backFaceCulling),e=u._getInstancesRenderList(t._id),!e.mustReturn&&!r._excludedMeshes[u.id]){var a=null!==h.getCaps().instancedArrays&&null!==e.visibleInstances[t._id]&&void 0!==e.visibleInstances[t._id],f=r._meshes[u.id],o=t.getMaterial(),s=null;(f&&f.glowEmissiveOnly&&o&&(s=o.emissiveTexture),r.isReady(t,a,s))?((h.enableEffect(r._glowMapGenerationEffect),u._bind(t,r._glowMapGenerationEffect,n.Material.TriangleFillMode),r._glowMapGenerationEffect.setMatrix("viewProjection",l.getTransformMatrix()),f?r._glowMapGenerationEffect.setFloat4("color",f.color.r,f.color.g,f.color.b,1):r._glowMapGenerationEffect.setFloat4("color",i.neutralColor.r,i.neutralColor.g,i.neutralColor.b,i.neutralColor.a),o&&o.needAlphaTesting())&&(c=o.getAlphaTestTexture(),r._glowMapGenerationEffect.setTexture("diffuseSampler",c),r._glowMapGenerationEffect.setMatrix("diffuseMatrix",c.getTextureMatrix())),s&&(r._glowMapGenerationEffect.setTexture("emissiveSampler",s),r._glowMapGenerationEffect.setMatrix("emissiveMatrix",s.getTextureMatrix())),u.useBones&&u.computeBonesUsingShaders&&r._glowMapGenerationEffect.setMatrices("mBones",u.skeleton.getTransformMatrices(u)),u._processRendering(t,r._glowMapGenerationEffect,n.Material.TriangleFillMode,e,a,function(n,t){return r._glowMapGenerationEffect.setMatrix("world",t)})):r._mainTexture.resetRefreshCounter()}};this._mainTexture.customRenderFunction=function(n,t,i){r.onBeforeRenderMainTextureObservable.notifyObservers(r);for(var u=0;u<n.length;u++)e(n.data[u]);for(u=0;u<t.length;u++)e(t.data[u]);for(u=0;u<i.length;u++)e(i.data[u])};this._mainTexture.onClearObservable.add(function(n){n.clear(i.neutralColor,!0,!0,!0)})},i.prototype.isReady=function(t,i,r){var l,o;if(!t.getMaterial().isReady(t.getMesh(),i))return!1;var u=[],f=[n.VertexBuffer.PositionKind],e=t.getMesh(),s=t.getMaterial(),h=!1,c=!1;return s&&s.needAlphaTesting()&&(l=s.getAlphaTestTexture(),l&&(u.push("#define ALPHATEST"),e.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&1===l.coordinatesIndex?(u.push("#define DIFFUSEUV2"),c=!0):e.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(u.push("#define DIFFUSEUV1"),h=!0))),r&&(u.push("#define EMISSIVE"),e.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&1===r.coordinatesIndex?(u.push("#define EMISSIVEUV2"),c=!0):e.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(u.push("#define EMISSIVEUV1"),h=!0)),h&&(f.push(n.VertexBuffer.UVKind),u.push("#define UV1")),c&&(f.push(n.VertexBuffer.UV2Kind),u.push("#define UV2")),e.useBones&&e.computeBonesUsingShaders?(f.push(n.VertexBuffer.MatricesIndicesKind),f.push(n.VertexBuffer.MatricesWeightsKind),e.numBoneInfluencers>4&&(f.push(n.VertexBuffer.MatricesIndicesExtraKind),f.push(n.VertexBuffer.MatricesWeightsExtraKind)),u.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),u.push("#define BonesPerMesh "+(e.skeleton.bones.length+1))):u.push("#define NUM_BONE_INFLUENCERS 0"),i&&(u.push("#define INSTANCES"),f.push("world0"),f.push("world1"),f.push("world2"),f.push("world3")),o=u.join("\n"),this._cachedDefines!==o&&(this._cachedDefines=o,this._glowMapGenerationEffect=this._scene.getEngine().createEffect("glowMapGeneration",f,["world","mBones","viewProjection","diffuseMatrix","color","emissiveMatrix"],["diffuseSampler","emissiveSampler"],o)),this._glowMapGenerationEffect.isReady()},i.prototype.render=function(){var i=this._glowMapMergeEffect,t,r;if(i.isReady()&&this._blurTexture.isReady()){t=this._scene.getEngine();this.onBeforeComposeObservable.notifyObservers(this);t.enableEffect(i);t.setState(!1);var u=t.getStencilBuffer(),f=t.getStencilFunction(),e=t.getStencilMask(),o=t.getAlphaMode();i.setTexture("textureSampler",this._blurTexture);t.bindBuffers(this._vertexBuffers,this._indexBuffer,i);t.setAlphaMode(this._options.alphaBlendingMode);t.setStencilMask(0);t.setStencilBuffer(!0);t.setStencilFunctionReference(this._instanceGlowingMeshStencilReference);this.outerGlow&&(i.setFloat("offset",0),t.setStencilFunction(n.Engine.NOTEQUAL),t.draw(!0,0,6));this.innerGlow&&(i.setFloat("offset",1),t.setStencilFunction(n.Engine.EQUAL),t.draw(!0,0,6));t.setStencilFunction(f);t.setStencilMask(e);t.setAlphaMode(o);t.setStencilBuffer(u);this.onAfterComposeObservable.notifyObservers(this);r=this._mainTexture.getSize();this.setMainTextureSize();r.width===this._mainTextureDesiredSize.width&&r.height===this._mainTextureDesiredSize.height||(this.onSizeChangedObservable.notifyObservers(this),this.disposeTextureAndPostProcesses(),this.createTextureAndPostProcesses())}},i.prototype.addExcludedMesh=function(n){var t=this._excludedMeshes[n.id];t||(this._excludedMeshes[n.id]={mesh:n,beforeRender:n.onBeforeRenderObservable.add(function(n){n.getEngine().setStencilBuffer(!1)}),afterRender:n.onAfterRenderObservable.add(function(n){n.getEngine().setStencilBuffer(!0)})})},i.prototype.removeExcludedMesh=function(n){var t=this._excludedMeshes[n.id];t&&(n.onBeforeRenderObservable.remove(t.beforeRender),n.onAfterRenderObservable.remove(t.afterRender));this._excludedMeshes[n.id]=void 0},i.prototype.addMesh=function(n,t,i){var r=this,u;void 0===i&&(i=!1);u=this._meshes[n.id];u?u.color=t:this._meshes[n.id]={mesh:n,color:t,observerHighlight:n.onBeforeRenderObservable.add(function(n){r._excludedMeshes[n.id]?r.defaultStencilReference(n):n.getScene().getEngine().setStencilFunctionReference(r._instanceGlowingMeshStencilReference)}),observerDefault:n.onAfterRenderObservable.add(this.defaultStencilReference),glowEmissiveOnly:i};this._shouldRender=!0},i.prototype.removeMesh=function(n){var t=this._meshes[n.id],i;t&&(n.onBeforeRenderObservable.remove(t.observerHighlight),n.onAfterRenderObservable.remove(t.observerDefault));this._meshes[n.id]=void 0;this._shouldRender=!1;for(i in this._meshes)if(i){this._shouldRender=!0;break}},i.prototype.shouldRender=function(){return this.isEnabled&&this._shouldRender},i.prototype.setMainTextureSize=function(){this._options.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._options.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._options.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderingCanvas().width*this._options.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderingCanvas().height*this._options.mainTextureRatio,this._mainTextureDesiredSize.width=n.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize),this._mainTextureDesiredSize.height=n.Tools.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize))},i.prototype.defaultStencilReference=function(n){n.getScene().getEngine().setStencilFunctionReference(i.normalMeshStencilReference)},i.prototype.disposeTextureAndPostProcesses=function(){this._blurTexture.dispose();this._mainTexture.dispose();this._downSamplePostprocess.dispose();this._horizontalBlurPostprocess.dispose();this._verticalBlurPostprocess.dispose()},i.prototype.dispose=function(){var u=this._vertexBuffers[n.VertexBuffer.PositionKind],i,t,r;u&&(u.dispose(),this._vertexBuffers[n.VertexBuffer.PositionKind]=null);this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.disposeTextureAndPostProcesses();for(i in this._meshes)t=this._meshes[i],t&&t.mesh&&(t.mesh.onBeforeRenderObservable.remove(t.observerHighlight),t.mesh.onAfterRenderObservable.remove(t.observerDefault));this._meshes=null;for(i in this._excludedMeshes)t=this._excludedMeshes[i],t&&(t.mesh.onBeforeRenderObservable.remove(t.beforeRender),t.mesh.onAfterRenderObservable.remove(t.afterRender));this._excludedMeshes=null;r=this._scene.highlightLayers.indexOf(this,0);r>-1&&this._scene.highlightLayers.splice(r,1);this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear();this.onBeforeRenderMainTextureObservable.clear();this.onBeforeBlurObservable.clear();this.onBeforeComposeObservable.clear();this.onAfterComposeObservable.clear();this.onSizeChangedObservable.clear()},i.neutralColor=new n.Color4(0,0,0,0),i.glowingMeshStencilReference=2,i.normalMeshStencilReference=1,i}();n.HighlightLayer=i}(i||(i={}));!function(n){var i=function(){function n(){}return n.TransformCoordinatesToRefSIMD=function(t,i,r){n.TransformCoordinatesFromFloatsToRefSIMD(t.x,t.y,t.z,i,r)},n.TransformCoordinatesFromFloatsToRefSIMD=function(n,t,i,r,u){var e=r.m,o=SIMD.Float32x4.load(e,0),s=SIMD.Float32x4.load(e,4),h=SIMD.Float32x4.load(e,8),c=SIMD.Float32x4.load(e,12),f=SIMD.Float32x4.add(SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(n),o),SIMD.Float32x4.mul(SIMD.Float32x4.splat(t),s)),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(i),h),c));f=SIMD.Float32x4.div(f,SIMD.Float32x4.swizzle(f,3,3,3,3));u.x=SIMD.Float32x4.extractLane(f,0);u.y=SIMD.Float32x4.extractLane(f,1);u.z=SIMD.Float32x4.extractLane(f,2)},n}(),t=function(){function n(){}return n.prototype.multiplyToArraySIMD=function(n,t,i){for(var u=this.m,f=n.m,e=SIMD.Float32x4.load(f,0),o=SIMD.Float32x4.load(f,4),s=SIMD.Float32x4.load(f,8),h=SIMD.Float32x4.load(f,12),r=0;r<16;r+=4)SIMD.Float32x4.store(t,r+i,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(u[r]),e),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(u[r+1]),o),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.splat(u[r+2]),s),SIMD.Float32x4.mul(SIMD.Float32x4.splat(u[r+3]),h)))));return this},n.prototype.invertToRefSIMD=function(n){var l=this.m,a=n.m,v=SIMD.Float32x4.load(l,0),y=SIMD.Float32x4.load(l,4),p=SIMD.Float32x4.load(l,8),w=SIMD.Float32x4.load(l,12),t=SIMD.Float32x4.shuffle(v,y,0,1,4,5),s=SIMD.Float32x4.shuffle(p,w,0,1,4,5),c=SIMD.Float32x4.shuffle(t,s,0,2,4,6),e,h,o,u,f,r,i;return s=SIMD.Float32x4.shuffle(s,t,1,3,5,7),t=SIMD.Float32x4.shuffle(v,y,2,3,6,7),e=SIMD.Float32x4.shuffle(p,w,2,3,6,7),h=SIMD.Float32x4.shuffle(t,e,0,2,4,6),e=SIMD.Float32x4.shuffle(e,t,1,3,5,7),t=SIMD.Float32x4.mul(h,e),t=SIMD.Float32x4.swizzle(t,1,0,3,2),o=SIMD.Float32x4.mul(s,t),u=SIMD.Float32x4.mul(c,t),t=SIMD.Float32x4.swizzle(t,2,3,0,1),o=SIMD.Float32x4.sub(SIMD.Float32x4.mul(s,t),o),u=SIMD.Float32x4.sub(SIMD.Float32x4.mul(c,t),u),u=SIMD.Float32x4.swizzle(u,2,3,0,1),t=SIMD.Float32x4.mul(s,h),t=SIMD.Float32x4.swizzle(t,1,0,3,2),o=SIMD.Float32x4.add(SIMD.Float32x4.mul(e,t),o),f=SIMD.Float32x4.mul(c,t),t=SIMD.Float32x4.swizzle(t,2,3,0,1),o=SIMD.Float32x4.sub(o,SIMD.Float32x4.mul(e,t)),f=SIMD.Float32x4.sub(SIMD.Float32x4.mul(c,t),f),f=SIMD.Float32x4.swizzle(f,2,3,0,1),t=SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(s,2,3,0,1),e),t=SIMD.Float32x4.swizzle(t,1,0,3,2),h=SIMD.Float32x4.swizzle(h,2,3,0,1),o=SIMD.Float32x4.add(SIMD.Float32x4.mul(h,t),o),r=SIMD.Float32x4.mul(c,t),t=SIMD.Float32x4.swizzle(t,2,3,0,1),o=SIMD.Float32x4.sub(o,SIMD.Float32x4.mul(h,t)),r=SIMD.Float32x4.sub(SIMD.Float32x4.mul(c,t),r),r=SIMD.Float32x4.swizzle(r,2,3,0,1),t=SIMD.Float32x4.mul(c,s),t=SIMD.Float32x4.swizzle(t,1,0,3,2),r=SIMD.Float32x4.add(SIMD.Float32x4.mul(e,t),r),f=SIMD.Float32x4.sub(SIMD.Float32x4.mul(h,t),f),t=SIMD.Float32x4.swizzle(t,2,3,0,1),r=SIMD.Float32x4.sub(SIMD.Float32x4.mul(e,t),r),f=SIMD.Float32x4.sub(f,SIMD.Float32x4.mul(h,t)),t=SIMD.Float32x4.mul(c,e),t=SIMD.Float32x4.swizzle(t,1,0,3,2),u=SIMD.Float32x4.sub(u,SIMD.Float32x4.mul(h,t)),r=SIMD.Float32x4.add(SIMD.Float32x4.mul(s,t),r),t=SIMD.Float32x4.swizzle(t,2,3,0,1),u=SIMD.Float32x4.add(SIMD.Float32x4.mul(h,t),u),r=SIMD.Float32x4.sub(r,SIMD.Float32x4.mul(s,t)),t=SIMD.Float32x4.mul(c,h),t=SIMD.Float32x4.swizzle(t,1,0,3,2),u=SIMD.Float32x4.add(SIMD.Float32x4.mul(e,t),u),f=SIMD.Float32x4.sub(f,SIMD.Float32x4.mul(s,t)),t=SIMD.Float32x4.swizzle(t,2,3,0,1),u=SIMD.Float32x4.sub(u,SIMD.Float32x4.mul(e,t)),f=SIMD.Float32x4.add(SIMD.Float32x4.mul(s,t),f),i=SIMD.Float32x4.mul(c,o),i=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(i,2,3,0,1),i),i=SIMD.Float32x4.add(SIMD.Float32x4.swizzle(i,1,0,3,2),i),t=SIMD.Float32x4.reciprocalApproximation(i),i=SIMD.Float32x4.sub(SIMD.Float32x4.add(t,t),SIMD.Float32x4.mul(i,SIMD.Float32x4.mul(t,t))),i=SIMD.Float32x4.swizzle(i,0,0,0,0),SIMD.Float32x4.store(a,0,SIMD.Float32x4.mul(i,o)),SIMD.Float32x4.store(a,4,SIMD.Float32x4.mul(i,u)),SIMD.Float32x4.store(a,8,r=SIMD.Float32x4.mul(i,r)),SIMD.Float32x4.store(a,12,SIMD.Float32x4.mul(i,f)),this},n.LookAtLHToRefSIMD=function(n,t,i,r){var h=r.m,d=SIMD.Float32x4(t.x,t.y,t.z,0),w=SIMD.Float32x4(n.x,n.y,n.z,0),s=SIMD.Float32x4(i.x,i.y,i.z,0),o=SIMD.Float32x4.sub(d,w),u=SIMD.Float32x4.mul(o,o),e,y,p;u=SIMD.Float32x4.add(u,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(u,1,2,0,3),SIMD.Float32x4.swizzle(u,2,0,1,3)));o=SIMD.Float32x4.mul(o,SIMD.Float32x4.reciprocalSqrtApproximation(u));u=SIMD.Float32x4.mul(s,s);u=SIMD.Float32x4.add(u,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(u,1,2,0,3),SIMD.Float32x4.swizzle(u,2,0,1,3)));s=SIMD.Float32x4.mul(s,SIMD.Float32x4.reciprocalSqrtApproximation(u));e=SIMD.Float32x4.sub(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(o,1,2,0,3),SIMD.Float32x4.swizzle(s,2,0,1,3)),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(o,2,0,1,3),SIMD.Float32x4.swizzle(s,1,2,0,3)));u=SIMD.Float32x4.mul(e,e);u=SIMD.Float32x4.add(u,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(u,1,2,0,3),SIMD.Float32x4.swizzle(u,2,0,1,3)));e=SIMD.Float32x4.mul(e,SIMD.Float32x4.reciprocalSqrtApproximation(u));y=SIMD.Float32x4.sub(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(e,1,2,0,3),SIMD.Float32x4.swizzle(o,2,0,1,3)),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(e,2,0,1,3),SIMD.Float32x4.swizzle(o,1,2,0,3)));u=SIMD.Float32x4.mul(e,e);u=SIMD.Float32x4.add(u,SIMD.Float32x4.add(SIMD.Float32x4.swizzle(u,1,2,0,3),SIMD.Float32x4.swizzle(u,2,0,1,3)));e=SIMD.Float32x4.mul(e,SIMD.Float32x4.reciprocalSqrtApproximation(u));p=SIMD.Float32x4.splat(0);e=SIMD.Float32x4.neg(e);var b=SIMD.Float32x4.shuffle(e,y,0,1,4,5),k=SIMD.Float32x4.shuffle(o,p,0,1,4,5),c=SIMD.Float32x4.shuffle(b,k,0,2,4,6),l=SIMD.Float32x4.shuffle(b,k,1,3,5,7),a=SIMD.Float32x4.shuffle(SIMD.Float32x4.shuffle(e,y,2,3,6,7),SIMD.Float32x4.shuffle(o,p,2,3,6,7),0,2,4,6),v=SIMD.Float32x4(0,0,0,1),f=SIMD.Float32x4(1,0,0,0);SIMD.Float32x4.store(h,0,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,0,0,0,0),c),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,1,1,1,1),l),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,2,2,2,2),a),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,3,3,3,3),v)))));f=SIMD.Float32x4(0,1,0,0);SIMD.Float32x4.store(h,4,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,0,0,0,0),c),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,1,1,1,1),l),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,2,2,2,2),a),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,3,3,3,3),v)))));f=SIMD.Float32x4(0,0,1,0);SIMD.Float32x4.store(h,8,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,0,0,0,0),c),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,1,1,1,1),l),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,2,2,2,2),a),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,3,3,3,3),v)))));f=SIMD.Float32x4.replaceLane(SIMD.Float32x4.neg(w),3,1);SIMD.Float32x4.store(h,12,SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,0,0,0,0),c),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,1,1,1,1),l),SIMD.Float32x4.add(SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,2,2,2,2),a),SIMD.Float32x4.mul(SIMD.Float32x4.swizzle(f,3,3,3,3),v)))))},n}(),r=n.Matrix.prototype.multiplyToArray,u=n.Matrix.prototype.invertToRef,f=n.Matrix.LookAtLHToRef,e=n.Vector3.TransformCoordinatesToRef,o=n.Vector3.TransformCoordinatesFromFloatsToRef,s=function(){function s(){}return Object.defineProperty(s,"IsEnabled",{get:function(){return s._isEnabled},enumerable:!0,configurable:!0}),s.DisableSIMD=function(){n.Matrix.prototype.multiplyToArray=r;n.Matrix.prototype.invertToRef=u;n.Matrix.LookAtLHToRef=f;n.Vector3.TransformCoordinatesToRef=e;n.Vector3.TransformCoordinatesFromFloatsToRef=o;s._isEnabled=!1},s.EnableSIMD=function(){void 0!==self.SIMD&&(self.Math.fround||(self.Math.fround=function(n){return function(t){return n[0]=t,n[0]}}(new Float32Array(1))),self.Math.imul||(self.Math.imul=function(n,t){var u=n>>>16&65535,i=65535&n,f=t>>>16&65535,r=65535&t;return i*r+(u*r+i*f<<16>>>0)|0}),n.Matrix.prototype.multiplyToArray=t.prototype.multiplyToArraySIMD,n.Matrix.prototype.invertToRef=t.prototype.invertToRefSIMD,n.Matrix.LookAtLHToRef=t.LookAtLHToRefSIMD,n.Vector3.TransformCoordinatesToRef=i.TransformCoordinatesToRefSIMD,n.Vector3.TransformCoordinatesFromFloatsToRef=i.TransformCoordinatesFromFloatsToRefSIMD,s._isEnabled=!0)},s._isEnabled=!1,s}();n.SIMDHelper=s}(i||(i={}));!function(n){var t=function(){function t(n,t,i,r){this._pos=i;this._size=r;this._root=n;this._parent=t;this._contentSize=null;this._bottomNode=null;this._leftNode=null;this._initialSize=null;this._rightNode=null}return Object.defineProperty(t.prototype,"pos",{get:function(){return this._pos},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"contentSize",{get:function(){return this._contentSize},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"UVs",{get:function(){return this.getUVsForCustomSize(this._root._size)},enumerable:!0,configurable:!0}),t.prototype.getUVsForCustomSize=function(t){var f=this._root._size.width,e=this._root._size.height,r=new n.Vector2(this._pos.x/f,this._pos.y/e),u=new n.Vector2((this._pos.x+t.width-1)/f,(this._pos.y+t.height-1)/e),i=[];return i.push(r),i.push(new n.Vector2(u.x,r.y)),i.push(u),i.push(new n.Vector2(r.x,u.y)),i},t.prototype.freeContent=function(){this.contentSize&&(this._contentSize=null,this.attemptDefrag())},Object.defineProperty(t.prototype,"isUsed",{get:function(){return null!=this._contentSize||null!=this._leftNode},enumerable:!0,configurable:!0}),t.prototype.findAndSplitNode=function(n){var t=this.findNode(n);return t?(t.splitNode(n),t):null},t.prototype.findNode=function(n){var t=null;if(this.isUsed)this._leftNode&&(t=this._leftNode.findNode(n)),!t&&this._rightNode&&(t=this._rightNode.findNode(n)),!t&&this._bottomNode&&(t=this._bottomNode.findNode(n));else if(this._initialSize){if(!(n.width<=this._initialSize.width&&n.height<=this._initialSize.height))return null;t=this}else n.width<=this._size.width&&n.height<=this._size.height&&(t=this);return t},t.prototype.splitNode=function(i){return!this._contentSize&&this._initialSize?(this._contentSize=i.clone(),this._leftNode=new t(this._root,this,new n.Vector2(this._pos.x,this._pos.y),new n.Size(this._initialSize.width,this._initialSize.height)),this._leftNode.splitNode(i)):(this._contentSize=i.clone(),this._initialSize=i.clone(),i.width!==this._size.width&&(this._rightNode=new t(this._root,this,new n.Vector2(this._pos.x+i.width,this._pos.y),new n.Size(this._size.width-i.width,i.height))),i.height!==this._size.height&&(this._bottomNode=new t(this._root,this,new n.Vector2(this._pos.x,this._pos.y+i.height),new n.Size(this._size.width,this._size.height-i.height))),this)},t.prototype.attemptDefrag=function(){!this.isUsed&&this.isRecursiveFree&&(this.clearNode(),this._parent&&this._parent.attemptDefrag())},t.prototype.clearNode=function(){this._initialSize=null;this._rightNode=null;this._bottomNode=null},Object.defineProperty(t.prototype,"isRecursiveFree",{get:function(){return!this.contentSize&&(!this._leftNode||this._leftNode.isRecursiveFree)&&(!this._rightNode||this._rightNode.isRecursiveFree)&&(!this._bottomNode||this._bottomNode.isRecursiveFree)},enumerable:!0,configurable:!0}),t.prototype.evalFreeSize=function(n){var t=0;return this.isUsed||(t=this._initialSize?this._initialSize.surface:this._size.surface),this._rightNode&&(t+=this._rightNode.evalFreeSize(0)),this._bottomNode&&(t+=this._bottomNode.evalFreeSize(0)),t+n},t}(),i;n.PackedRect=t;i=function(t){function i(i){t.call(this,null,null,n.Vector2.Zero(),i);this._root=this}return u(i,t),i.prototype.addRect=function(n){return this.findAndSplitNode(n)},Object.defineProperty(i.prototype,"freeSpace",{get:function(){var n=0;return n=this.evalFreeSize(n),n/(this._size.width*this._size.height)},enumerable:!0,configurable:!0}),i}(t);n.RectPackingMap=i}(i||(i={}));!function(n){var t=function(){function n(){}return n}(),i,r;n.DynamicFloatArrayElementInfo=t;i=function(){function n(n,i){var r,u;for(this.compareValueOffset=null,this.sortingAscending=!0,this._stride=n,this.buffer=new Float32Array(n*i),this._lastUsed=0,this._firstFree=0,this._allEntries=new Array(i),this._freeEntries=new Array(i),r=0;r<i;r++)u=new t,u.offset=r*n,this._allEntries[r]=u,this._freeEntries[i-r-1]=u}return n.prototype.allocElement=function(){0===this._freeEntries.length&&this._growBuffer();var n=this._freeEntries.pop();return this._lastUsed=Math.max(n.offset,this._lastUsed),n.offset===this._firstFree&&(this._freeEntries.length>0?this._firstFree=this._freeEntries[this._freeEntries.length-1].offset:this._firstFree+=this._stride),n},n.prototype.freeElement=function(n){this._firstFree=Math.min(n.offset,this._firstFree);this._freeEntries.push(n)},n.prototype.pack=function(){var n,s,l,d;if(0===this._freeEntries.length)return this.buffer;if(this._lastUsed<this._firstFree)return this.buffer.subarray(0,this._lastUsed+this._stride);n=this._stride;s=new t;s.offset=this.totalElementCount*n;this._freeEntries.push(s);for(var r=this._freeEntries.sort(function(n,t){return n.offset-t.offset}),u=this._allEntries.sort(function(n,t){return n.offset-t.offset}),i=r[0].offset,f=1,g=(this.usedElementCount+1)*n,h=r[0].offset,c=1;c<r.length&&!(i>=g);c++){var nt=r[c],e=nt.offset,a=e-h;if(a!==n){for(var v=a/n-1,o=e-n,y=Math.min(f,v),p=0;p<y;p++){var w=i/n,b=o/n,k=u[b];this._moveElement(k,i);l=u[w];l.offset=o;u[w]=k;u[b]=l;o-=n;i+=n}f<=v?(i=o+n,f=1+y):f=(e-i)/n+1;h=e}else++f,h=e}return d=this.buffer.subarray(0,i),this._lastUsed=i-n,this._firstFree=i,r.pop(),this._freeEntries=r.sort(function(n,t){return t.offset-n.offset}),this._allEntries=u,d},n.prototype._moveElement=function(n,t){for(var i=0;i<this._stride;i++)this.buffer[t+i]=this.buffer[n.offset+i];n.offset=t},n.prototype._growBuffer=function(){var r=Math.floor(1.5*this.totalElementCount),u=new Float32Array(r*this._stride),i;u.set(this.buffer);for(var f=this.totalElementCount,e=r-this.totalElementCount,n=0;n<e;n++)i=new t,i.offset=(f+n)*this.stride,this._allEntries.push(i),this._freeEntries[e-n-1]=i;this._firstFree=f*this.stride;this.buffer=u},Object.defineProperty(n.prototype,"totalElementCount",{get:function(){return this._allEntries.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"freeElementCount",{get:function(){return this._freeEntries.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"usedElementCount",{get:function(){return this._allEntries.length-this._freeEntries.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"stride",{get:function(){return this._stride},enumerable:!0,configurable:!0}),n.prototype.sort=function(){var f=this,i,l,t,a,n,u;if(!this.compareValueOffset)throw new Error("The DynamicFloatArray.sort() method needs a valid 'compareValueOffset' property");i=this.usedElementCount;(!this._sortTable||this._sortTable.length<i)&&(l=Math.min(this.totalElementCount,2*i),this._sortTable=new Array(l));this._sortedTable&&this._sortedTable.length===i||(this._sortedTable=new Array(i));this.pack();for(var c=0,e=this.stride,n=0;n<i;n++,c+=e)t=this._sortTable[n],t||(t=new r,this._sortTable[n]=t),t.compareData=this.buffer[c+this.compareValueOffset],t.offset=c,t.swapedOffset=null,this._sortedTable[n]=t;for(this.sortingAscending?this._sortedTable.sort(function(n,t){return n.compareData-t.compareData}):this._sortedTable.sort(function(n,t){return t.compareData-n.compareData}),a=function(n,t){for(var r,i=0;i<e;i++)r=f.buffer[t+i],f.buffer[t+i]=f.buffer[n+i],f.buffer[n+i]=r},n=0;n<i;n++){var o=this._sortedTable[n],s=this._sortTable[n],h=o.offset;if(o.swapedOffset){for(u=o;u.swapedOffset;)u=this._sortTable[u.swapedOffset/e];h=u.offset}s.swapedOffset=h;h!==s.offset&&a(h,s.offset);this._allEntries[o.offset/e].offset=s.offset}return this._allEntries.sort(function(n,t){return n.offset-t.offset}),!0},n}();n.DynamicFloatArray=i;r=function(){function n(){this.compareData=this.offset=this.swapedOffset=null}return n}()}(i||(i={}));!function(n){var t=function(){function n(){}return n}(),i;n.CharInfo=t;i=function(i){function r(t,r,u,f,e,o,s){var y,p,w,c,l,a,h,v,k;(void 0===f&&(f=200),void 0===e&&(e=n.Texture.TRILINEAR_SAMPLINGMODE),void 0===o&&(o=!1),void 0===s&&(s=!1),i.call(this,null,u,!0,!1,e),this._charInfos={},this._curCharCount=0,this._lastUpdateCharCount=-1,this._usedCounter=1,this.name=t,this.wrapU=n.Texture.CLAMP_ADDRESSMODE,this.wrapV=n.Texture.CLAMP_ADDRESSMODE,this._sdfScale=8,this._signedDistanceField=s,this._superSample=!1,o||s)&&(y=this.getSuperSampleFont(r),y&&(this._superSample=!0,r=y));this._canvas=document.createElement("canvas");this._context=this._canvas.getContext("2d");this._context.font=r;this._context.fillStyle="white";this._context.textBaseline="top";this._cachedFontId=null;p=this.getFontHeight(r);this._lineHeightSuper=p.height+4;this._lineHeight=this._superSample?Math.ceil(this._lineHeightSuper/2):this._lineHeightSuper;this._offset=p.offset-1;this._xMargin=1+Math.ceil(this._lineHeightSuper/15);this._yMargin=this._xMargin;w=this._context.measureText("W").width;this._spaceWidthSuper=this._context.measureText(" ").width;this._spaceWidth=this._superSample?this._spaceWidthSuper/2:this._spaceWidthSuper;var d=(this._lineHeightSuper+this._yMargin)*(w+this._xMargin)*f,g=Math.sqrt(d),b=Math.pow(2,Math.ceil(Math.log(g)/Math.log(2)));for(this._texture=u.getEngine().createDynamicTexture(b,b,!1,e),c=this.getSize(),(this.hasAlpha=this._signedDistanceField===!1,this._canvas=document.createElement("canvas"),this._canvas.width=c.width,this._canvas.height=c.height,this._context=this._canvas.getContext("2d"),this._context.textBaseline="top",this._context.font=r,this._context.fillStyle="white",this._context.imageSmoothingEnabled=!1,this._context.clearRect(0,0,c.width,c.height),this._signedDistanceField)&&(l=document.createElement("canvas"),a=this._sdfScale,l.width=w*a,l.height=this._lineHeightSuper*a,h=l.getContext("2d"),h.scale(a,a),h.textBaseline="top",h.font=r,h.fillStyle="white",h.imageSmoothingEnabled=!1,this._sdfCanvas=l,this._sdfContext=h),this._currentFreePosition=n.Vector2.Zero(),v=32;v<127;v++)k=String.fromCharCode(v),this.getChar(k);this.update()}return u(r,i),Object.defineProperty(r.prototype,"isSuperSampled",{get:function(){return this._superSample},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isSignedDistanceField",{get:function(){return this._signedDistanceField},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"spaceWidth",{get:function(){return this._spaceWidth},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"lineHeight",{get:function(){return this._lineHeight},enumerable:!0,configurable:!0}),r.GetCachedFontTexture=function(t,i,u,f){var o;void 0===u&&(u=!1);void 0===f&&(f=!1);o=t;o.__fontTextureCache__||(o.__fontTextureCache__=new n.StringDictionary);var h=o.__fontTextureCache__,s=i.toLocaleLowerCase()+(u?"_+SS":"_-SS")+(f?"_+SDF":"_-SDF"),e=h.get(s);return e?(++e._usedCounter,e):(e=new r(null,i,t,u?100:200,n.Texture.BILINEAR_SAMPLINGMODE,u,f),e._cachedFontId=s,h.add(s,e),e)},r.ReleaseCachedFontTexture=function(n,t,i,r){var o,u,f,e;void 0===i&&(i=!1);void 0===r&&(r=!1);o=n;u=o.__fontTextureCache__;u&&(f=t.toLocaleLowerCase()+(i?"_+SS":"_-SS")+(r?"_+SDF":"_-SDF"),e=u.get(f),0==--e._usedCounter&&(u.remove(f),e.dispose()))},r.prototype.getChar=function(i){var r,o,s,e;if(1!==i.length)return null;if(r=this._charInfos[i],r)return r;r=new t;var h=this._context.measureText(i),u=this.getSize(),f=Math.round(h.width);return this._currentFreePosition.x+f+this._xMargin>u.width&&(this._currentFreePosition.x=0,this._currentFreePosition.y+=this._lineHeightSuper+this._yMargin,this._currentFreePosition.y>u.height)?this.getChar("!"):(this._signedDistanceField?(this._sdfContext.clearRect(0,0,this._sdfCanvas.width,this._sdfCanvas.height),this._sdfContext.fillText(i,0,-this._offset),o=this._sdfContext.getImageData(0,0,f*this._sdfScale,this._sdfCanvas.height),s=this._computeSDFChar(o),this._context.putImageData(s,this._currentFreePosition.x,this._currentFreePosition.y)):this._context.fillText(i,this._currentFreePosition.x,this._currentFreePosition.y-this._offset),(r.topLeftUV=new n.Vector2(this._currentFreePosition.x/u.width,this._currentFreePosition.y/u.height),r.bottomRightUV=new n.Vector2((this._currentFreePosition.x+f)/u.width,r.topLeftUV.y+(this._lineHeightSuper+2)/u.height),this._signedDistanceField)&&(e=1/u.width,r.topLeftUV.addInPlace(new n.Vector2(e,e)),r.bottomRightUV.addInPlace(new n.Vector2(e,e))),r.charWidth=this._superSample?f/2:f,this._charInfos[i]=r,this._curCharCount++,this._currentFreePosition.x+=f+this._xMargin,r)},r.prototype._computeSDFChar=function(n){for(var e,p,u,k,o=this._sdfScale,y=n.width,w=n.height,s=y/o,a=w/o,t=0,i=0,h=o,v=h-1,r=function(r,u,f,e,s){var h=r*o,c=u*o,a,l;return h+f<0||h+f>=y||c+e<0||c+e>=w?!0:(a=n.data[4*((c+e)*y+(h+f))],l=a>0===s,l||(t=f,i=e),l)},d=function(n,u,f){var e,o,s,c;if(r(n,u,0,v,f)&&r(n,u,0,-v,f)&&r(n,u,-v,0,f)&&r(n,u,v,0,f))return 0;for(e=1;e<=h;e++){if(!(r(n,u,0,e,f)&&r(n,u,0,-e,f)&&r(n,u,-e,0,f)&&r(n,u,e,0,f)))return e*e;for(o=1;o<=e;o++)if(!(r(n,u,-o,e,f)&&r(n,u,o,e,f)&&r(n,u,e,-o,f)&&r(n,u,e,o,f)&&r(n,u,-o,-e,f)&&r(n,u,o,-e,f)&&r(n,u,-e,-o,f)&&r(n,u,-e,o,f)))return s=e*e+o*o,c=1,r(n,u,t-1,i,f)||(s+=(t-1)*(t-1)+i*i,++c),r(n,u,t+1,i,f)||(s+=(t+1)*(t+1)+i*i,++c),r(n,u,t,i-1,f)||(s+=t*t+(i-1)*(i-1),++c),r(n,u,t,i+1,f)||(s+=t*t+(i+1)*(i+1),++c),r(n,u,t-1,i-1,f)||(s+=(t-1)*(t-1)+(i-1)*(i-1),++c),r(n,u,t+1,i+1,f)||(s+=(t+1)*(t+1)+(i+1)*(i+1),++c),r(n,u,t+1,i-1,f)||(s+=(t+1)*(t+1)+(i-1)*(i-1),++c),r(n,u,t-1,i+1,f)||(s+=(t-1)*(t-1)+(i+1)*(i+1),++c),s/c}return 0},b=new Array(s*a),c=0;c<a;c++)for(e=0;e<s;e++)p=r(e,c,0,0,!0),u=d(e,c,p),0===u&&(u=h*h*2),b[c*s+e]=p?u:-u;for(var l=this._context.createImageData(s,a),g=s*a,f=0;f<g;f++)u=b[f],k=u<0?-1:1,u=Math.sqrt(Math.abs(u))*k,u*=127.5/h,u+=127.5,u<0?u=0:u>255&&(u=255),u+=.5,l.data[4*f+0]=u,l.data[4*f+1]=u,l.data[4*f+2]=u,l.data[4*f+3]=255;return l},r.prototype.measureText=function(t,i){var e,o;void 0===i&&(i=4);for(var r=0,u=0,h=1,f=0,s=0,c=t;s<c.length;s++)e=c[s],"\n"!==e?"\t"!==e?e<" "||(u+=this.getChar(e).charWidth,++f):(o=f+i,o-=o%i,u+=(o-f)*this.spaceWidth,f=o):(r=Math.max(r,u),f=0,u=0,++h);return r=Math.max(r,u),new n.Size(r,h*this.lineHeight)},r.prototype.getSuperSampleFont=function(n){var t=n.toLocaleLowerCase().match(/^\s*(?=(?:(?:[-a-z]+\s*){0,2}(italic|oblique))?)(?=(?:(?:[-a-z]+\s*){0,2}(small-caps))?)(?=(?:(?:[-a-z]+\s*){0,2}(bold(?:er)?|lighter|[1-9]00))?)(?:(?:normal|\1|\2|\3)\s*){0,3}((?:xx?-)?(?:small|large)|medium|smaller|larger|[.\d]+(?:\%|in|[cem]m|ex|p[ctx]))(?:\s*\/\s*(normal|[.\d]+(?:\%|in|[cem]m|ex|p[ctx])))?\s*([-,\"\sa-z]+?)\s*$/),u,r,i;if(null==t)return null;for(u=parseInt(t[4]),t[4]=(2*u).toString()+(t[4].match(/\D+/)||[]).pop(),r="",i=1;i<t.length;i++)null!=t[i]&&(r+=t[i]+" ");return r},r.prototype.getFontHeight=function(n){var t=document.createElement("canvas"),i=t.getContext("2d"),f,o;i.fillRect(0,0,t.width,t.height);i.textBaseline="top";i.fillStyle="white";i.font=n;i.fillText("jH|",0,0);for(var s=i.getImageData(0,0,t.width,t.height).data,u=-1,e=-1,r=0;r<t.height;r++)for(f=0;f<t.width;f++){if(o=4*(r*t.width+f),0!==s[o]){u===-1&&(u=r);break}if(f===t.width-1&&u!==-1){e=r;r=t.height;break}}return{height:e-u+1,offset:u-1}},Object.defineProperty(r.prototype,"canRescale",{get:function(){return!1},enumerable:!0,configurable:!0}),r.prototype.getContext=function(){return this._context},r.prototype.update=function(){this._lastUpdateCharCount<this._curCharCount&&(this.getScene().getEngine().updateDynamicTexture(this._texture,this._canvas,!1,!0),this._lastUpdateCharCount=this._curCharCount)},r.prototype.clone=function(){return null},r.prototype.incCachedFontTextureCounter=function(){++this._usedCounter},r.prototype.decCachedFontTextureCounter=function(){var t=this.getScene(),n=t.__fontTextureCache__;n&&0==--this._usedCounter&&(n.remove(this._cachedFontId),this.dispose())},r}(n.Texture);n.FontTexture=i}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e){void 0===f&&(f=n.Texture.TRILINEAR_SAMPLINGMODE);void 0===e&&(e=!1);t.call(this,null,r,!e,!1,f);this.name=i;this._size=u;this.wrapU=n.Texture.CLAMP_ADDRESSMODE;this.wrapV=n.Texture.CLAMP_ADDRESSMODE;this._rectPackingMap=new n.RectPackingMap(new n.Size(u.width,u.height));this._texture=r.getEngine().createRenderTargetTexture(u,{generateMipMaps:!this.noMipmap,type:n.Engine.TEXTURETYPE_UNSIGNED_INT})}return u(i,t),i.prototype.allocateRect=function(n){return this._rectPackingMap.addRect(n)},i.prototype.freeRect=function(n){n&&n.freeContent()},Object.defineProperty(i.prototype,"freeSpace",{get:function(){return this._rectPackingMap.freeSpace},enumerable:!0,configurable:!0}),i.prototype.bindTextureForRect=function(n,t){return this.bindTextureForPosSize(n.pos,n.contentSize,t)},i.prototype.bindTextureForPosSize=function(t,i,r){var u=this.getScene().getEngine();u.bindFramebuffer(this._texture);this._replacedViewport=u.setDirectViewport(t.x,t.y,i.width,i.height);r&&u.scissorClear(t.x,t.y,i.width,i.height,new n.Color4(0,0,0,0))},i.prototype.unbindTexture=function(t){t&&n.Tools.DumpFramebuffer(this._size.width,this._size.height,this.getScene().getEngine());var i=this.getScene().getEngine();this._replacedViewport&&(i.setViewport(this._replacedViewport),this._replacedViewport=null);i.unBindFramebuffer(this._texture)},Object.defineProperty(i.prototype,"canRescale",{get:function(){return!1},enumerable:!0,configurable:!0}),i.prototype.clone=function(){return null},i}(n.Texture);n.MapTexture=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f){t.call(this,i,r);this._textures={};this._textureArrays={};this._floats={};this._floatsArrays={};this._colors3={};this._colors4={};this._vectors2={};this._vectors3={};this._vectors4={};this._matrices={};this._matrices3x3={};this._matrices2x2={};this._vectors3Arrays={};this._cachedWorldViewMatrix=new n.Matrix;this._shaderPath=u;f.needAlphaBlending=f.needAlphaBlending||!1;f.needAlphaTesting=f.needAlphaTesting||!1;f.attributes=f.attributes||["position","normal","uv"];f.uniforms=f.uniforms||["worldViewProjection"];f.samplers=f.samplers||[];f.defines=f.defines||[];this._options=f}return u(i,t),i.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending},i.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},i.prototype._checkUniform=function(n){this._options.uniforms.indexOf(n)===-1&&this._options.uniforms.push(n)},i.prototype.setTexture=function(n,t){return this._options.samplers.indexOf(n)===-1&&this._options.samplers.push(n),this._textures[n]=t,this},i.prototype.setTextureArray=function(n,t){return this._options.samplers.indexOf(n)===-1&&this._options.samplers.push(n),this._checkUniform(n),this._textureArrays[n]=t,this},i.prototype.setFloat=function(n,t){return this._checkUniform(n),this._floats[n]=t,this},i.prototype.setFloats=function(n,t){return this._checkUniform(n),this._floatsArrays[n]=t,this},i.prototype.setColor3=function(n,t){return this._checkUniform(n),this._colors3[n]=t,this},i.prototype.setColor4=function(n,t){return this._checkUniform(n),this._colors4[n]=t,this},i.prototype.setVector2=function(n,t){return this._checkUniform(n),this._vectors2[n]=t,this},i.prototype.setVector3=function(n,t){return this._checkUniform(n),this._vectors3[n]=t,this},i.prototype.setVector4=function(n,t){return this._checkUniform(n),this._vectors4[n]=t,this},i.prototype.setMatrix=function(n,t){return this._checkUniform(n),this._matrices[n]=t,this},i.prototype.setMatrix3x3=function(n,t){return this._checkUniform(n),this._matrices3x3[n]=t,this},i.prototype.setMatrix2x2=function(n,t){return this._checkUniform(n),this._matrices2x2[n]=t,this},i.prototype.setArray3=function(n,t){return this._checkUniform(n),this._vectors3Arrays[n]=t,this},i.prototype._checkCache=function(n,t,i){return!t||(this._effect&&this._effect.defines.indexOf("#define INSTANCES")!==-1!==i,!1)},i.prototype.isReady=function(t,i){var u=this.getScene(),o=u.getEngine(),r,e,f,s,h;if(!this.checkReadyOnEveryCall&&this._renderId===u.getRenderId()&&this._checkCache(u,t,i))return!0;for(r=[],e=new n.EffectFallbacks,i&&r.push("#define INSTANCES"),f=0;f<this._options.defines.length;f++)r.push(this._options.defines[f]);return t&&t.useBones&&t.computeBonesUsingShaders&&(r.push("#define NUM_BONE_INFLUENCERS "+t.numBoneInfluencers),r.push("#define BonesPerMesh "+(t.skeleton.bones.length+1)),e.addCPUSkinningFallback(0,t)),o.getAlphaTesting()&&r.push("#define ALPHATEST"),s=this._effect,h=r.join("\n"),this._effect=o.createEffect(this._shaderPath,this._options.attributes,this._options.uniforms,this._options.samplers,h,e,this.onCompiled,this.onError),!!this._effect.isReady()&&(s!==this._effect&&u.resetCachedMaterial(),this._renderId=u.getRenderId(),!0)},i.prototype.bindOnlyWorldMatrix=function(n){var t=this.getScene();this._options.uniforms.indexOf("world")!==-1&&this._effect.setMatrix("world",n);this._options.uniforms.indexOf("worldView")!==-1&&(n.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),this._effect.setMatrix("worldView",this._cachedWorldViewMatrix));this._options.uniforms.indexOf("worldViewProjection")!==-1&&this._effect.setMatrix("worldViewProjection",n.multiply(t.getTransformMatrix()))},i.prototype.bind=function(i,r){var u,f;if(this.bindOnlyWorldMatrix(i),this.getScene().getCachedMaterial()!==this){this._options.uniforms.indexOf("view")!==-1&&this._effect.setMatrix("view",this.getScene().getViewMatrix());this._options.uniforms.indexOf("projection")!==-1&&this._effect.setMatrix("projection",this.getScene().getProjectionMatrix());this._options.uniforms.indexOf("viewProjection")!==-1&&this._effect.setMatrix("viewProjection",this.getScene().getTransformMatrix());n.MaterialHelper.BindBonesParameters(r,this._effect);for(u in this._textures)this._effect.setTexture(u,this._textures[u]);for(u in this._textureArrays)this._effect.setTextureArray(u,this._textureArrays[u]);for(u in this._floats)this._effect.setFloat(u,this._floats[u]);for(u in this._floatsArrays)this._effect.setArray(u,this._floatsArrays[u]);for(u in this._colors3)this._effect.setColor3(u,this._colors3[u]);for(u in this._colors4)f=this._colors4[u],this._effect.setFloat4(u,f.r,f.g,f.b,f.a);for(u in this._vectors2)this._effect.setVector2(u,this._vectors2[u]);for(u in this._vectors3)this._effect.setVector3(u,this._vectors3[u]);for(u in this._vectors4)this._effect.setVector4(u,this._vectors4[u]);for(u in this._matrices)this._effect.setMatrix(u,this._matrices[u]);for(u in this._matrices3x3)this._effect.setMatrix3x3(u,this._matrices3x3[u]);for(u in this._matrices2x2)this._effect.setMatrix2x2(u,this._matrices2x2[u]);for(u in this._vectors3Arrays)this._effect.setArray3(u,this._vectors3Arrays[u])}t.prototype.bind.call(this,i,r)},i.prototype.clone=function(n){return new i(n,this.getScene(),this._shaderPath,this._options)},i.prototype.dispose=function(n,i){var r,f,u;if(i){for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays)for(f=this._textureArrays[r],u=0;u<f.length;u++)f[u].dispose()}this._textures={};t.prototype.dispose.call(this,n,i)},i.prototype.serialize=function(){var i=n.SerializationHelper.Serialize(this),t,u,r;i.customType="BABYLON.ShaderMaterial";i.options=this._options;i.shaderPath=this._shaderPath;i.textures={};for(t in this._textures)i.textures[t]=this._textures[t].serialize();i.textureArrays={};for(t in this._textureArrays)for(i.textureArrays[t]=[],u=this._textureArrays[t],r=0;r<u.length;r++)i.textureArrays[t].push(u[r].serialize());i.floats={};for(t in this._floats)i.floats[t]=this._floats[t];i.floatArrays={};for(t in this._floatsArrays)i.floatArrays[t]=this._floatsArrays[t];i.colors3={};for(t in this._colors3)i.colors3[t]=this._colors3[t].asArray();i.colors4={};for(t in this._colors4)i.colors4[t]=this._colors4[t].asArray();i.vectors2={};for(t in this._vectors2)i.vectors2[t]=this._vectors2[t].asArray();i.vectors3={};for(t in this._vectors3)i.vectors3[t]=this._vectors3[t].asArray();i.vectors4={};for(t in this._vectors4)i.vectors4[t]=this._vectors4[t].asArray();i.matrices={};for(t in this._matrices)i.matrices[t]=this._matrices[t].asArray();i.matrices3x3={};for(t in this._matrices3x3)i.matrices3x3[t]=this._matrices3x3[t];i.matrices2x2={};for(t in this._matrices2x2)i.matrices2x2[t]=this._matrices2x2[t];i.vectors3Arrays={};for(t in this._vectors3Arrays)i.vectors3Arrays[t]=this._vectors3Arrays[t];return i},i.Parse=function(t,r,u){var f,e=n.SerializationHelper.Parse(function(){return new i(t.name,r,t.shaderPath,t.options)},t,r,u);for(f in t.textures)e.setTexture(f,n.Texture.Parse(t.textures[f],r,u));for(f in t.textureArrays){for(var s=t.textureArrays[f],h=[],o=0;o<s.length;o++)h.push(n.Texture.Parse(s[o],r,u));e.setTextureArray(f,h)}for(f in t.floats)e.setFloat(f,t.floats[f]);for(f in t.floatsArrays)e.setFloats(f,t.floatsArrays[f]);for(f in t.colors3)e.setColor3(f,n.Color3.FromArray(t.colors3[f]));for(f in t.colors4)e.setColor4(f,n.Color4.FromArray(t.colors4[f]));for(f in t.vectors2)e.setVector2(f,n.Vector2.FromArray(t.vectors2[f]));for(f in t.vectors3)e.setVector3(f,n.Vector3.FromArray(t.vectors3[f]));for(f in t.vectors4)e.setVector4(f,n.Vector4.FromArray(t.vectors4[f]));for(f in t.matrices)e.setMatrix(f,n.Matrix.FromArray(t.matrices[f]));for(f in t.matrices3x3)e.setMatrix3x3(f,t.matrices3x3[f]);for(f in t.matrices2x2)e.setMatrix2x2(f,t.matrices2x2[f]);for(f in t.vectors3Arrays)e.setArray3(f,t.vectors3Arrays[f]);return e},i}(n.Material);n.ShaderMaterial=t}(i||(i={}));!function(n){var t;!function(t){function i(n){return n.charCodeAt(0)+(n.charCodeAt(1)<<8)+(n.charCodeAt(2)<<16)+(n.charCodeAt(3)<<24)}function y(n){return String.fromCharCode(255&n,n>>8&255,n>>16&255,n>>24&255)}var p=542327876,u=131072,f=512,e=4,o=64,s=131072,w=i("DXT1"),b=i("DXT3"),k=i("DXT5"),h=31,d=0,g=1,c=2,l=3,a=4,v=7,r=20,nt=21,tt=22,it=28,rt=function(){function t(){}return t.GetDDSInfo=function(n){var t=new Int32Array(n,0,h),i=1;return t[c]&u&&(i=Math.max(1,t[v])),{width:t[a],height:t[l],mipmapCount:i,isFourCC:(t[r]&e)===e,isRGB:(t[r]&o)===o,isLuminance:(t[r]&s)===s,isCube:(t[it]&f)===f}},t.GetRGBAArrayBuffer=function(n,t,i,r,u){for(var h,o,f=new Uint8Array(r),s=new Uint8Array(u),e=0,c=t-1;c>=0;c--)for(h=0;h<n;h++)o=i+4*(h+c*n),f[e+2]=s[o],f[e+1]=s[o+1],f[e]=s[o+2],f[e+3]=s[o+3],e+=4;return f},t.GetRGBArrayBuffer=function(n,t,i,r,u){for(var o,s,f=new Uint8Array(r),h=new Uint8Array(u),e=0,c=t-1;c>=0;c--)for(o=0;o<n;o++)s=i+3*(o+c*n),f[e+2]=h[s],f[e+1]=h[s+1],f[e]=h[s+2],e+=3;return f},t.GetLuminanceArrayBuffer=function(n,t,i,r,u){for(var f,h,o=new Uint8Array(r),c=new Uint8Array(u),s=0,e=t-1;e>=0;e--)for(f=0;f<n;f++)h=i+(f+e*n),o[s]=c[h],s++;return o},t.UploadDDSLevels=function(i,r,f,e,o,s){var pt,ct,lt,it,rt,ut,st,ft,vt,ot,et=new Int32Array(f,0,h),wt,at,ht;if(et[d]!=p)return void n.Tools.Error("Invalid magic number in DDS header");if(!e.isFourCC&&!e.isRGB&&!e.isLuminance)return void n.Tools.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");if(e.isFourCC)switch(pt=et[nt]){case w:ct=8;lt=r.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case b:ct=16;lt=r.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case k:ct=16;lt=r.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return void console.error("Unsupported FourCC code:",y(pt))}for(vt=1,et[c]&u&&o!==!1&&(vt=Math.max(1,et[v])),wt=et[tt],at=0;at<s;at++)for(ht=1===s?i.TEXTURE_2D:i.TEXTURE_CUBE_MAP_POSITIVE_X+at,it=et[a],rt=et[l],st=et[g]+4,ot=0;ot<vt;++ot){if(e.isRGB)24===wt?(ut=it*rt*3,ft=t.GetRGBArrayBuffer(it,rt,st,ut,f),i.texImage2D(ht,ot,i.RGB,it,rt,0,i.RGB,i.UNSIGNED_BYTE,ft)):(ut=it*rt*4,ft=t.GetRGBAArrayBuffer(it,rt,st,ut,f),i.texImage2D(ht,ot,i.RGBA,it,rt,0,i.RGBA,i.UNSIGNED_BYTE,ft));else if(e.isLuminance){var yt=i.getParameter(i.UNPACK_ALIGNMENT),bt=it,kt=Math.floor((it+yt-1)/yt)*yt;ut=kt*(rt-1)+bt;ft=t.GetLuminanceArrayBuffer(it,rt,st,ut,f);i.texImage2D(ht,ot,i.LUMINANCE,it,rt,0,i.LUMINANCE,i.UNSIGNED_BYTE,ft)}else ut=Math.max(4,it)/4*Math.max(4,rt)/4*ct,ft=new Uint8Array(f,st,ut),i.compressedTexImage2D(ht,ot,lt,it,rt,0,ft);st+=ut;it*=.5;rt*=.5;it=Math.max(1,it);rt=Math.max(1,rt)}},t}();t.DDSTools=rt}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t=function(){function t(t,i){return void 0===t&&(t=!0),void 0===i&&(i=10),this._useDeltaForWorldStep=t,this.name="CannonJSPlugin",this._physicsMaterials=[],this._fixedTimeStep=1/60,this._currentCollisionGroup=2,this._minus90X=new n.Quaternion(-.70710678118654746,0,0,.70710678118654746),this._plus90X=new n.Quaternion(.70710678118654746,0,0,.70710678118654746),this._tmpPosition=n.Vector3.Zero(),this._tmpQuaternion=new n.Quaternion,this._tmpDeltaPosition=n.Vector3.Zero(),this._tmpDeltaRotation=new n.Quaternion,this._tmpUnityRotation=new n.Quaternion,this.isSupported()?(this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,void(this.world.solver.iterations=i)):void n.Tools.Error("CannonJS is not available. Please make sure you included the js file.")}return t.prototype.setGravity=function(n){this.world.gravity.copy(n)},t.prototype.setTimeStep=function(n){this._fixedTimeStep=n},t.prototype.executeStep=function(n){this.world.step(this._fixedTimeStep,this._useDeltaForWorldStep?1e3*n:0,3)},t.prototype.applyImpulse=function(n,t,i){var r=new CANNON.Vec3(i.x,i.y,i.z),u=new CANNON.Vec3(t.x,t.y,t.z);n.physicsBody.applyImpulse(u,r)},t.prototype.applyForce=function(n,t,i){var r=new CANNON.Vec3(i.x,i.y,i.z),u=new CANNON.Vec3(t.x,t.y,t.z);n.physicsBody.applyImpulse(u,r)},t.prototype.generatePhysicsBody=function(n){var u,t,i;if(n.parent)return void(n.physicsBody&&(this.removePhysicsBody(n),n.forceUpdate()));if(n.isBodyInitRequired()){u=this._createShape(n);t=n.physicsBody;t&&this.removePhysicsBody(n);var e=this._addMaterial("mat-"+n.uniqueId,n.getParam("friction"),n.getParam("restitution")),f={mass:n.getParam("mass"),material:e},r=n.getParam("nativeOptions");for(i in r)r.hasOwnProperty(i)&&(f[i]=r[i]);n.physicsBody=new CANNON.Body(f);n.physicsBody.addEventListener("collide",n.onCollide);this.world.addEventListener("preStep",n.beforeStep);this.world.addEventListener("postStep",n.afterStep);n.physicsBody.addShape(u);this.world.add(n.physicsBody);t&&["force","torque","velocity","angularVelocity"].forEach(function(i){n.physicsBody[i].copy(t[i])});this._processChildMeshes(n)}this._updatePhysicsBodyTransformation(n)},t.prototype._processChildMeshes=function(t){var i=this,u=t.object.getChildMeshes?t.object.getChildMeshes():[],r;u.length&&(r=function(n,u){var f=u.getPhysicsImpostor(),e,n;f&&(e=f.parent,e!==t&&(n=u.position,f.physicsBody&&(i.removePhysicsBody(f),f.physicsBody=null),f.parent=t,f.resetUpdateFlags(),t.physicsBody.addShape(i._createShape(f),new CANNON.Vec3(n.x,n.y,n.z)),t.physicsBody.mass+=f.getParam("mass")));u.getChildMeshes().forEach(r.bind(i,u.position))},u.forEach(r.bind(this,n.Vector3.Zero())))},t.prototype.removePhysicsBody=function(n){n.physicsBody.removeEventListener("collide",n.onCollide);this.world.removeEventListener("preStep",n.beforeStep);this.world.removeEventListener("postStep",n.afterStep);this.world.remove(n.physicsBody)},t.prototype.generateJoint=function(t){var f=t.mainImpostor.physicsBody,e=t.connectedImpostor.physicsBody,r,i,u,o;if(f&&e){i=t.joint.jointData;u={pivotA:i.mainPivot?(new CANNON.Vec3).copy(i.mainPivot):null,pivotB:i.connectedPivot?(new CANNON.Vec3).copy(i.connectedPivot):null,axisA:i.mainAxis?(new CANNON.Vec3).copy(i.mainAxis):null,axisB:i.connectedAxis?(new CANNON.Vec3).copy(i.connectedAxis):null,maxForce:i.nativeParams.maxForce,collideConnected:!!i.collision};switch(t.joint.type){case n.PhysicsJoint.HingeJoint:case n.PhysicsJoint.Hinge2Joint:r=new CANNON.HingeConstraint(f,e,u);break;case n.PhysicsJoint.DistanceJoint:r=new CANNON.DistanceConstraint(f,e,i.maxDistance||2);break;case n.PhysicsJoint.SpringJoint:o=i;r=new CANNON.Spring(f,e,{restLength:o.length,stiffness:o.stiffness,damping:o.damping,localAnchorA:u.pivotA,localAnchorB:u.pivotB});break;case n.PhysicsJoint.LockJoint:r=new CANNON.LockConstraint(f,e,u);break;case n.PhysicsJoint.PointToPointJoint:case n.PhysicsJoint.BallAndSocketJoint:default:r=new CANNON.PointToPointConstraint(f,u.pivotA,e,u.pivotA,u.maxForce)}r.collideConnected=!!i.collision;t.joint.physicsJoint=r;t.joint.type!==n.PhysicsJoint.SpringJoint?this.world.addConstraint(r):t.mainImpostor.registerAfterPhysicsStep(function(){r.applyForce()})}},t.prototype.removeJoint=function(n){this.world.removeConstraint(n.joint.physicsJoint)},t.prototype._addMaterial=function(n,t,i){for(var f,r,u=0;u<this._physicsMaterials.length;u++)if(f=this._physicsMaterials[u],f.friction===t&&f.restitution===i)return f;return r=new CANNON.Material(n),r.friction=t,r.restitution=i,this._physicsMaterials.push(r),r},t.prototype._checkWithEpsilon=function(t){return t<n.PhysicsEngine.Epsilon?n.PhysicsEngine.Epsilon:t},t.prototype._createShape=function(t){var i,u=t.object,r=t.getObjectExtendSize(),f,e,o;switch(t.type){case n.PhysicsEngine.SphereImpostor:var s=r.x,h=r.y,c=r.z;i=new CANNON.Sphere(Math.max(this._checkWithEpsilon(s),this._checkWithEpsilon(h),this._checkWithEpsilon(c))/2);break;case n.PhysicsImpostor.CylinderImpostor:i=new CANNON.Cylinder(this._checkWithEpsilon(r.x)/2,this._checkWithEpsilon(r.x)/2,this._checkWithEpsilon(r.y),16);break;case n.PhysicsImpostor.BoxImpostor:f=r.scale(.5);i=new CANNON.Box(new CANNON.Vec3(this._checkWithEpsilon(f.x),this._checkWithEpsilon(f.y),this._checkWithEpsilon(f.z)));break;case n.PhysicsImpostor.PlaneImpostor:n.Tools.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead");i=new CANNON.Plane;break;case n.PhysicsImpostor.MeshImpostor:e=u.getVerticesData?u.getVerticesData(n.VertexBuffer.PositionKind):[];o=u.getIndices?u.getIndices():[];n.Tools.Warn("MeshImpostor only collides against spheres.");i=new CANNON.Trimesh(e,o);break;case n.PhysicsImpostor.HeightmapImpostor:i=this._createHeightmap(u);break;case n.PhysicsImpostor.ParticleImpostor:i=new CANNON.Particle}return i},t.prototype._createHeightmap=function(t,i){for(var r,f,l,o,a,s=t.getVerticesData(n.VertexBuffer.PositionKind),u=[],e=i||~~(Math.sqrt(s.length/3)-1),p=Math.min(t.getBoundingInfo().boundingBox.extendSize.x,t.getBoundingInfo().boundingBox.extendSize.z),c=2*p/e,v=t.getBoundingInfo().boundingBox.extendSize.y,h=0;h<s.length;h+=3){var r=Math.round(s[h+0]/c+e/2),f=Math.round((s[h+2]/c-e/2)*-1),y=s[h+1]+v;u[r]||(u[r]=[]);u[r][f]||(u[r][f]=y);u[r][f]=Math.max(y,u[r][f])}for(r=0;r<=e;++r){if(!u[r]){for(o=1;!u[(r+o)%e];)o++;u[r]=u[(r+o)%e].slice()}for(f=0;f<=e;++f)if(!u[r][f]){for(o=1;void 0===l;)l=u[r][(f+o++)%e];u[r][f]=l}}return a=new CANNON.Heightfield(u,{elementSize:c}),a.minY=v,a},t.prototype._updatePhysicsBodyTransformation=function(t){var r=t.object,u,f,i,o,s,h,c,e;r.computeWorldMatrix&&r.computeWorldMatrix(!0);u=t.getObjectCenter();t.getObjectExtendSize();this._tmpDeltaPosition.copyFrom(r.position.subtract(u));this._tmpPosition.copyFrom(u);f=r.rotationQuaternion;(t.type!==n.PhysicsImpostor.PlaneImpostor&&t.type!==n.PhysicsImpostor.HeightmapImpostor&&t.type!==n.PhysicsImpostor.CylinderImpostor||(f=f.multiply(this._minus90X),t.setDeltaRotation(this._plus90X)),t.type===n.PhysicsEngine.HeightmapImpostor)?(i=r,o=i.rotationQuaternion,i.rotationQuaternion=this._tmpUnityRotation,i.computeWorldMatrix(!0),s=u.clone(),h=i.getPivotMatrix()||n.Matrix.Translation(0,0,0),i.rotationQuaternion=o,c=n.Matrix.Translation(i.getBoundingInfo().boundingBox.extendSize.x,0,-i.getBoundingInfo().boundingBox.extendSize.z),i.setPivotMatrix(c),i.computeWorldMatrix(!0),e=i.getBoundingInfo().boundingBox.center.subtract(u).subtract(i.position).negate(),this._tmpPosition.copyFromFloats(e.x,e.y-i.getBoundingInfo().boundingBox.extendSize.y,e.z),this._tmpDeltaPosition.copyFrom(i.getBoundingInfo().boundingBox.center.subtract(s)),this._tmpDeltaPosition.y+=i.getBoundingInfo().boundingBox.extendSize.y,i.setPivotMatrix(h),i.computeWorldMatrix(!0)):t.type===n.PhysicsEngine.MeshImpostor&&(this._tmpDeltaPosition.copyFromFloats(0,0,0),this._tmpPosition.copyFrom(r.position));t.setDeltaPosition(this._tmpDeltaPosition);t.physicsBody.position.copy(this._tmpPosition);t.physicsBody.quaternion.copy(f)},t.prototype.setTransformationFromPhysicsBody=function(n){n.object.position.copyFrom(n.physicsBody.position);n.object.rotationQuaternion.copyFrom(n.physicsBody.quaternion)},t.prototype.setPhysicsBodyTransformation=function(n,t,i){n.physicsBody.position.copy(t);n.physicsBody.quaternion.copy(i)},t.prototype.isSupported=function(){return void 0!==window.CANNON},t.prototype.setLinearVelocity=function(n,t){n.physicsBody.velocity.copy(t)},t.prototype.setAngularVelocity=function(n,t){n.physicsBody.angularVelocity.copy(t)},t.prototype.getLinearVelocity=function(t){var i=t.physicsBody.velocity;return i?new n.Vector3(i.x,i.y,i.z):null},t.prototype.getAngularVelocity=function(t){var i=t.physicsBody.angularVelocity;return i?new n.Vector3(i.x,i.y,i.z):null},t.prototype.setBodyMass=function(n,t){n.physicsBody.mass=t;n.physicsBody.updateMassProperties()},t.prototype.sleepBody=function(n){n.physicsBody.sleep()},t.prototype.wakeUpBody=function(n){n.physicsBody.wakeUp()},t.prototype.updateDistanceJoint=function(n,t){n.physicsJoint.distance=t},t.prototype.enableMotor=function(n,t){t||n.physicsJoint.enableMotor()},t.prototype.disableMotor=function(n,t){t||n.physicsJoint.disableMotor()},t.prototype.setMotor=function(n,t,i,r){r||(n.physicsJoint.enableMotor(),n.physicsJoint.setMotorSpeed(t),i&&this.setLimit(n,i))},t.prototype.setLimit=function(n,t,i){n.physicsJoint.motorEquation.maxForce=t;n.physicsJoint.motorEquation.minForce=void 0===i?-t:i},t.prototype.dispose=function(){},t}();n.CannonJSPlugin=t}(i||(i={}));!function(n){var t=function(){function t(t){this.name="OimoJSPlugin";this._tmpImpostorsArray=[];this._tmpPositionVector=n.Vector3.Zero();this.world=new OIMO.World(1/60,2,t,!0);this.world.worldscale(1);this.world.clear();this.world.isNoStat=!0}return t.prototype.setGravity=function(n){this.world.gravity.copy(n)},t.prototype.setTimeStep=function(n){this.world.timeStep=n},t.prototype.executeStep=function(n,t){var f=this,i,r,u;for(t.forEach(function(n){n.beforeStep()}),this.world.step(),t.forEach(function(n){n.afterStep();f._tmpImpostorsArray[n.uniqueId]=n}),i=this.world.contacts;null!==i;)!i.touching||i.body1.sleeping||i.body2.sleeping?(r=this._tmpImpostorsArray[+i.body1.name],u=this._tmpImpostorsArray[+i.body2.name],r&&u?(r.onCollide({body:u.physicsBody}),u.onCollide({body:r.physicsBody}),i=i.next):i=i.next):i=i.next},t.prototype.applyImpulse=function(n,t,i){var r=n.physicsBody.massInfo.mass;n.physicsBody.applyImpulse(i.scale(OIMO.INV_SCALE),t.scale(OIMO.INV_SCALE*r))},t.prototype.applyForce=function(t,i,r){n.Tools.Warn("Oimo doesn't support applying force. Using impule instead.");this.applyImpulse(t,i,r)},t.prototype.generatePhysicsBody=function(t){var f=this,r;if(t.parent)return void(t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate()));if(t.isBodyInitRequired()){var i={name:t.uniqueId,config:[t.getParam("mass")||1,t.getParam("friction"),t.getParam("restitution")],size:[],type:[],pos:[],rot:[],move:0!==t.getParam("mass"),world:this.world},u=[t],e=function(n){n.getChildMeshes&&n.getChildMeshes().forEach(function(n){n.physicsImpostor&&(u.push(n.physicsImpostor),n.physicsImpostor._init())})};e(t.object);r=function(t){return Math.max(t,n.PhysicsEngine.Epsilon)};u.forEach(function(u){var a=u.object.rotationQuaternion,h=(new OIMO.Euler).setFromQuaternion({x:t.object.rotationQuaternion.x,y:t.object.rotationQuaternion.y,z:t.object.rotationQuaternion.z,s:t.object.rotationQuaternion.w}),e=u.getObjectExtendSize(),o,l,s;u===t?(o=t.getObjectCenter(),t.object.position.subtractToRef(o,f._tmpPositionVector),i.pos.push(o.x),i.pos.push(o.y),i.pos.push(o.z),i.rot.push(h.x/(OIMO.degtorad||OIMO.TO_RAD)),i.rot.push(h.y/(OIMO.degtorad||OIMO.TO_RAD)),i.rot.push(h.z/(OIMO.degtorad||OIMO.TO_RAD))):(i.pos.push(u.object.position.x),i.pos.push(u.object.position.y),i.pos.push(u.object.position.z),i.rot.push(0),i.rot.push(0),i.rot.push(0));switch(u.type){case n.PhysicsImpostor.ParticleImpostor:n.Tools.Warn("No Particle support in Oimo.js. using SphereImpostor instead");case n.PhysicsImpostor.SphereImpostor:var v=e.x,y=e.y,p=e.z,c=Math.max(r(v),r(y),r(p))/2;i.type.push("sphere");i.size.push(c);i.size.push(c);i.size.push(c);break;case n.PhysicsImpostor.CylinderImpostor:l=r(e.x)/2;s=r(e.y);i.type.push("cylinder");i.size.push(l);i.size.push(s);i.size.push(s);break;case n.PhysicsImpostor.PlaneImpostor:case n.PhysicsImpostor.BoxImpostor:default:var l=r(e.x),s=r(e.y),w=r(e.z);i.type.push("box");i.size.push(l);i.size.push(s);i.size.push(w)}u.object.rotationQuaternion=a});t.physicsBody=new OIMO.Body(i).body}else this._tmpPositionVector.copyFromFloats(0,0,0);t.setDeltaPosition(this._tmpPositionVector)},t.prototype.removePhysicsBody=function(n){this.world.removeRigidBody(n.physicsBody)},t.prototype.generateJoint=function(t){var e=t.mainImpostor.physicsBody,o=t.connectedImpostor.physicsBody,s;if(e&&o){var f,i=t.joint.jointData,r=i.nativeParams||{},u={body1:e,body2:o,axe1:r.axe1||(i.mainAxis?i.mainAxis.asArray():null),axe2:r.axe2||(i.connectedAxis?i.connectedAxis.asArray():null),pos1:r.pos1||(i.mainPivot?i.mainPivot.asArray():null),pos2:r.pos2||(i.connectedPivot?i.connectedPivot.asArray():null),min:r.min,max:r.max,collision:r.collision||i.collision,spring:r.spring,world:this.world};switch(t.joint.type){case n.PhysicsJoint.BallAndSocketJoint:f="jointBall";break;case n.PhysicsJoint.SpringJoint:n.Tools.Warn("Oimo.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");s=i;u.min=s.length||u.min;u.max=Math.max(u.min,u.max);case n.PhysicsJoint.DistanceJoint:f="jointDistance";u.max=i.maxDistance;break;case n.PhysicsJoint.PrismaticJoint:f="jointPrisme";break;case n.PhysicsJoint.SliderJoint:f="jointSlide";break;case n.PhysicsJoint.WheelJoint:f="jointWheel";break;case n.PhysicsJoint.HingeJoint:default:f="jointHinge"}u.type=f;t.joint.physicsJoint=new OIMO.Link(u).joint}},t.prototype.removeJoint=function(t){try{this.world.removeJoint(t.joint.physicsJoint)}catch(i){n.Tools.Warn(i)}},t.prototype.isSupported=function(){return void 0!==OIMO},t.prototype.setTransformationFromPhysicsBody=function(n){if(!n.physicsBody.sleeping){if(n.physicsBody.shapes.next){var t=this._getLastShape(n.physicsBody);n.object.position.x=t.position.x*OIMO.WORLD_SCALE;n.object.position.y=t.position.y*OIMO.WORLD_SCALE;n.object.position.z=t.position.z*OIMO.WORLD_SCALE}else n.object.position.copyFrom(n.physicsBody.getPosition());n.object.rotationQuaternion.copyFrom(n.physicsBody.getQuaternion());n.object.rotationQuaternion.normalize()}},t.prototype.setPhysicsBodyTransformation=function(n,t,i){var r=n.physicsBody;r.position.init(t.x*OIMO.INV_SCALE,t.y*OIMO.INV_SCALE,t.z*OIMO.INV_SCALE);r.orientation.init(i.w,i.x,i.y,i.z);r.syncShapes();r.awake()},t.prototype._getLastShape=function(n){for(var t=n.shapes;t.next;)t=t.next;return t},t.prototype.setLinearVelocity=function(n,t){n.physicsBody.linearVelocity.init(t.x,t.y,t.z)},t.prototype.setAngularVelocity=function(n,t){n.physicsBody.angularVelocity.init(t.x,t.y,t.z)},t.prototype.getLinearVelocity=function(t){var i=t.physicsBody.linearVelocity;return i?new n.Vector3(i.x,i.y,i.z):null},t.prototype.getAngularVelocity=function(t){var i=t.physicsBody.angularVelocity;return i?new n.Vector3(i.x,i.y,i.z):null},t.prototype.setBodyMass=function(n,t){var i=0===t;n.physicsBody.shapes.density=i?1:t;n.physicsBody.setupMass(i?2:1)},t.prototype.sleepBody=function(n){n.physicsBody.sleep()},t.prototype.wakeUpBody=function(n){n.physicsBody.awake()},t.prototype.updateDistanceJoint=function(n,t,i){n.physicsJoint.limitMotor.upperLimit=t;void 0!==i&&(n.physicsJoint.limitMotor.lowerLimit=i)},t.prototype.setMotor=function(n,t,i,r){var u=r?n.physicsJoint.rotationalLimitMotor2:n.physicsJoint.rotationalLimitMotor1||n.physicsJoint.rotationalLimitMotor||n.physicsJoint.limitMotor;u&&u.setMotor(t,i)},t.prototype.setLimit=function(n,t,i,r){var u=r?n.physicsJoint.rotationalLimitMotor2:n.physicsJoint.rotationalLimitMotor1||n.physicsJoint.rotationalLimitMotor||n.physicsJoint.limitMotor;u&&u.setLimit(t,void 0===i?-t:i)},t.prototype.dispose=function(){this.world.clear()},t}();n.OimoJSPlugin=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r,u,f,e){n.call(this,t,"displayPass",["passSampler"],["passSampler"],i,r,u,f,e)}return u(t,n),t}(n.PostProcess);n.DisplayPassPostProcess=t}(i||(i={}));!function(n){var s=function(){function n(n,t,i){this.quality=n;this.distance=t;this.optimizeMesh=i}return n}(),e,o,i,r,t,u,f;n.SimplificationSettings=s;e=function(){function t(){this.running=!1;this._simplificationArray=[]}return t.prototype.addTask=function(n){this._simplificationArray.push(n)},t.prototype.executeNext=function(){var n=this._simplificationArray.pop();n?(this.running=!0,this.runSimplification(n)):this.running=!1},t.prototype.runSimplification=function(t){var i=this,r,u;t.parallelProcessing?t.settings.forEach(function(n){var r=i.getSimplifier(t);r.simplify(n,function(r){t.mesh.addLODLevel(n.distance,r);r.isVisible=!0;n.quality===t.settings[t.settings.length-1].quality&&t.successCallback&&t.successCallback();i.executeNext()})}):(r=this.getSimplifier(t),u=function(n,i){r.simplify(n,function(r){t.mesh.addLODLevel(n.distance,r);r.isVisible=!0;i()})},n.AsyncLoop.Run(t.settings.length,function(n){u(t.settings[n.index],function(){n.executeNext()})},function(){t.successCallback&&t.successCallback();i.executeNext()}))},t.prototype.getSimplifier=function(n){switch(n.simplificationType){case o.QUADRATIC:default:return new f(n.mesh)}},t}();n.SimplificationQueue=e,function(n){n[n.QUADRATIC=0]="QUADRATIC"}(n.SimplificationType||(n.SimplificationType={}));o=n.SimplificationType;i=function(){function n(n){this.vertices=n;this.error=new Array(4);this.deleted=!1;this.isDirty=!1;this.deletePending=!1;this.borderFactor=0}return n}();n.DecimationTriangle=i;r=function(){function n(n,i){this.position=n;this.id=i;this.isBorder=!0;this.q=new t;this.triangleCount=0;this.triangleStart=0;this.originalOffsets=[]}return n.prototype.updatePosition=function(n){this.position.copyFrom(n)},n}();n.DecimationVertex=r;t=function(){function n(n){this.data=new Array(10);for(var t=0;t<10;++t)this.data[t]=n&&n[t]?n[t]:0}return n.prototype.det=function(n,t,i,r,u,f,e,o,s){return this.data[n]*this.data[u]*this.data[s]+this.data[i]*this.data[r]*this.data[o]+this.data[t]*this.data[f]*this.data[e]-this.data[i]*this.data[u]*this.data[e]-this.data[n]*this.data[f]*this.data[o]-this.data[t]*this.data[r]*this.data[s]},n.prototype.addInPlace=function(n){for(var t=0;t<10;++t)this.data[t]+=n.data[t]},n.prototype.addArrayInPlace=function(n){for(var t=0;t<10;++t)this.data[t]+=n[t]},n.prototype.add=function(t){for(var r=new n,i=0;i<10;++i)r.data[i]=this.data[i]+t.data[i];return r},n.FromData=function(t,i,r,u){return new n(n.DataFromNumbers(t,i,r,u))},n.DataFromNumbers=function(n,t,i,r){return[n*n,n*t,n*i,n*r,t*t,t*i,t*r,i*i,i*r,r*r]},n}();n.QuadraticMatrix=t;u=function(){function n(n,t){this.vertexId=n;this.triangleId=t}return n}();n.Reference=u;f=function(){function f(t){this._mesh=t;this.initialized=!1;this.syncIterations=5e3;this.aggressiveness=7;this.decimationIterations=100;this.boundingBoxEpsilon=n.Epsilon}return f.prototype.simplify=function(t,i){var r=this;this.initDecimatedMesh();n.AsyncLoop.Run(this._mesh.subMeshes.length,function(n){r.initWithMesh(n.index,function(){r.runDecimation(t,n.index,function(){n.executeNext()})},t.optimizeMesh)},function(){setTimeout(function(){i(r._reconstructedMesh)},0)})},f.prototype.isTriangleOnBoundingBox=function(n){var i=this,t=0;return n.vertices.forEach(function(n){var f=0,r=n.position,u=i._mesh.getBoundingInfo().boundingBox;(u.maximum.x-r.x<i.boundingBoxEpsilon||r.x-u.minimum.x>i.boundingBoxEpsilon)&&++f;u.maximum.y!==r.y&&r.y!==u.minimum.y||++f;u.maximum.z!==r.z&&r.z!==u.minimum.z||++f;f>1&&++t}),t>1&&console.log(n,t),t>1},f.prototype.runDecimation=function(t,i,r){var u=this,e=~~(this.triangles.length*t.quality),f=0,o=this.triangles.length,s=function(t,i){setTimeout(function(){var r,s,h;for(t%5==0&&u.updateMesh(0===t),r=0;r<u.triangles.length;++r)u.triangles[r].isDirty=!1;s=1e-9*Math.pow(t+3,u.aggressiveness);h=function(t){var b=~~((u.triangles.length/2+t)%u.triangles.length),r=u.triangles[b],e,a,v,y,h,c;if(r&&!(r.error[3]>s||r.deleted||r.isDirty))for(e=0;e<3;++e)if(r.error[e]<s){var p=[],w=[],i=r.vertices[e],o=r.vertices[(e+1)%3];if(i.isBorder||o.isBorder)continue;var l=n.Vector3.Zero(),k=n.Vector3.Zero(),d=n.Vector2.Zero(),g=new n.Color4(0,0,0,1);if(u.calculateError(i,o,l,k,d,g),a=[],u.isFlipped(i,o,l,p,r.borderFactor,a))continue;if(u.isFlipped(o,i,l,w,r.borderFactor,a))continue;if(p.indexOf(!0)<0||w.indexOf(!0)<0)continue;if(v=[],a.forEach(function(n){v.indexOf(n)===-1&&(n.deletePending=!0,v.push(n))}),v.length%2!=0)continue;if(i.q=o.q.add(i.q),i.updatePosition(l),y=u.references.length,f=u.updateTriangles(i,i,p,f),f=u.updateTriangles(i,o,w,f),h=u.references.length-y,h<=i.triangleCount){if(h)for(c=0;c<h;c++)u.references[i.triangleStart+c]=u.references[y+c]}else i.triangleStart=y;i.triangleCount=h;break}};n.AsyncLoop.SyncAsyncForLoop(u.triangles.length,u.syncIterations,h,i,function(){return o-f<=e})},0)};n.AsyncLoop.Run(this.decimationIterations,function(n){o-f<=e?n.breakLoop():s(n.index,function(){n.executeNext()})},function(){setTimeout(function(){u.reconstructMesh(i);r()},0)})},f.prototype.initWithMesh=function(t,u,f){var e=this;this.vertices=[];this.triangles=[];var c=this._mesh.getVerticesData(n.VertexBuffer.PositionKind),h=this._mesh.getIndices(),o=this._mesh.subMeshes[t],l=function(n){if(f)for(var t=0;t<e.vertices.length;++t)if(e.vertices[t].position.equals(n))return e.vertices[t];return null},s=[],a=function(t){var u=t+o.verticesStart,f=n.Vector3.FromArray(c,3*u),i=l(f)||new r(f,e.vertices.length);i.originalOffsets.push(u);i.id===e.vertices.length&&e.vertices.push(i);s.push(i.id)},v=o.verticesCount;n.AsyncLoop.SyncAsyncForLoop(v,this.syncIterations/4>>0,a,function(){var t=function(n){var u=o.indexStart/3+n,t=3*u,f=h[t+0],c=h[t+1],l=h[t+2],a=e.vertices[s[f-o.verticesStart]],v=e.vertices[s[c-o.verticesStart]],y=e.vertices[s[l-o.verticesStart]],r=new i([a,v,y]);r.originalOffset=t;e.triangles.push(r)};n.AsyncLoop.SyncAsyncForLoop(o.indexCount/3,e.syncIterations,t,function(){e.init(u)})})},f.prototype.init=function(i){var r=this,u=function(i){var u=r.triangles[i],f;for(u.normal=n.Vector3.Cross(u.vertices[1].position.subtract(u.vertices[0].position),u.vertices[2].position.subtract(u.vertices[0].position)).normalize(),f=0;f<3;f++)u.vertices[f].q.addArrayInPlace(t.DataFromNumbers(u.normal.x,u.normal.y,u.normal.z,-n.Vector3.Dot(u.normal,u.vertices[0].position)))};n.AsyncLoop.SyncAsyncForLoop(this.triangles.length,this.syncIterations,u,function(){var t=function(n){for(var t=r.triangles[n],i=0;i<3;++i)t.error[i]=r.calculateError(t.vertices[i],t.vertices[(i+1)%3]);t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])};n.AsyncLoop.SyncAsyncForLoop(r.triangles.length,r.syncIterations,t,function(){r.initialized=!0;i()})})},f.prototype.reconstructMesh=function(t){for(var o=[],r,s,u,p,b,k,i=0;i<this.vertices.length;++i)this.vertices[i].triangleCount=0;for(i=0;i<this.triangles.length;++i)if(!this.triangles[i].deleted){for(r=this.triangles[i],s=0;s<3;++s)r.vertices[s].triangleCount=1;o.push(r)}var h=this._reconstructedMesh.getVerticesData(n.VertexBuffer.PositionKind)||[],c=this._reconstructedMesh.getVerticesData(n.VertexBuffer.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(n.VertexBuffer.UVKind)||[],f=this._reconstructedMesh.getVerticesData(n.VertexBuffer.ColorKind)||[],v=this._mesh.getVerticesData(n.VertexBuffer.NormalKind),a=this._mesh.getVerticesData(n.VertexBuffer.UVKind),e=this._mesh.getVerticesData(n.VertexBuffer.ColorKind),y=0;for(i=0;i<this.vertices.length;++i)u=this.vertices[i],u.id=y,u.triangleCount&&u.originalOffsets.forEach(function(n){h.push(u.position.x);h.push(u.position.y);h.push(u.position.z);c.push(v[3*n]);c.push(v[3*n+1]);c.push(v[3*n+2]);a&&a.length?(l.push(a[2*n]),l.push(a[2*n+1])):e&&e.length&&(f.push(e[4*n]),f.push(e[4*n+1]),f.push(e[4*n+2]),f.push(e[4*n+3]));++y});var d=this._reconstructedMesh.getTotalIndices(),w=this._reconstructedMesh.getTotalVertices(),g=this._reconstructedMesh.subMeshes;for(this._reconstructedMesh.subMeshes=[],p=this._reconstructedMesh.getIndices(),b=this._mesh.getIndices(),i=0;i<o.length;++i)r=o[i],[0,1,2].forEach(function(n){var i=b[r.originalOffset+n],t=r.vertices[n].originalOffsets.indexOf(i);t<0&&(t=0);p.push(r.vertices[n].id+t+w)});this._reconstructedMesh.setIndices(p);this._reconstructedMesh.setVerticesData(n.VertexBuffer.PositionKind,h);this._reconstructedMesh.setVerticesData(n.VertexBuffer.NormalKind,c);l.length>0&&this._reconstructedMesh.setVerticesData(n.VertexBuffer.UVKind,l);f.length>0&&this._reconstructedMesh.setVerticesData(n.VertexBuffer.ColorKind,f);k=this._mesh.subMeshes[t];t>0&&(this._reconstructedMesh.subMeshes=[],g.forEach(function(t){new n.SubMesh(t.materialIndex,t.verticesStart,t.verticesCount,t.indexStart,t.indexCount,t.getMesh())}),new n.SubMesh(k.materialIndex,w,y,d,3*o.length,this._reconstructedMesh))},f.prototype.initDecimatedMesh=function(){this._reconstructedMesh=new n.Mesh(this._mesh.name+"Decimated",this._mesh.getScene());this._reconstructedMesh.material=this._mesh.material;this._reconstructedMesh.parent=this._mesh.parent;this._reconstructedMesh.isVisible=!1;this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId},f.prototype.isFlipped=function(t,i,r,u,f,e){for(var s,h,c,y,o=0;o<t.triangleCount;++o)if(s=this.triangles[this.references[t.triangleStart+o].triangleId],!s.deleted){var l=this.references[t.triangleStart+o].vertexId,a=s.vertices[(l+1)%3],v=s.vertices[(l+2)%3];if(a!==i&&v!==i){if((h=a.position.subtract(r),h=h.normalize(),c=v.position.subtract(r),c=c.normalize(),Math.abs(n.Vector3.Dot(h,c))>.999)||(y=n.Vector3.Cross(h,c).normalize(),u[o]=!1,n.Vector3.Dot(y,s.normal)<.2))return!0}else u[o]=!0,e.push(s)}return!1},f.prototype.updateTriangles=function(n,t,i,r){for(var e,u,o=r,f=0;f<t.triangleCount;++f)e=this.references[t.triangleStart+f],u=this.triangles[e.triangleId],u.deleted||(i[f]&&u.deletePending?(u.deleted=!0,o++):(u.vertices[e.vertexId]=n,u.isDirty=!0,u.error[0]=this.calculateError(u.vertices[0],u.vertices[1])+u.borderFactor/2,u.error[1]=this.calculateError(u.vertices[1],u.vertices[2])+u.borderFactor/2,u.error[2]=this.calculateError(u.vertices[2],u.vertices[0])+u.borderFactor/2,u.error[3]=Math.min(u.error[0],u.error[1],u.error[2]),this.references.push(e)));return o},f.prototype.identifyBorder=function(){for(var s,u,i,e,r=0;r<this.vertices.length;++r){for(var t=[],f=[],o=this.vertices[r],n=0;n<o.triangleCount;++n)for(s=this.triangles[this.references[o.triangleStart+n].triangleId],u=0;u<3;u++){for(i=0,e=s.vertices[u];i<t.length&&f[i]!==e.id;)++i;i===t.length?(t.push(1),f.push(e.id)):t[i]++}for(n=0;n<t.length;++n)this.vertices[f[n]].isBorder=1===t[n]?!0:!1}},f.prototype.updateMesh=function(n){var t,e,f,i,r,o,s;if(void 0===n&&(n=!1),!n){for(e=[],t=0;t<this.triangles.length;++t)this.triangles[t].deleted||e.push(this.triangles[t]);this.triangles=e}for(t=0;t<this.vertices.length;++t)this.vertices[t].triangleCount=0,this.vertices[t].triangleStart=0;for(t=0;t<this.triangles.length;++t)for(f=this.triangles[t],i=0;i<3;++i)r=f.vertices[i],r.triangleCount++;for(o=0,t=0;t<this.vertices.length;++t)this.vertices[t].triangleStart=o,o+=this.vertices[t].triangleCount,this.vertices[t].triangleCount=0;for(s=new Array(3*this.triangles.length),t=0;t<this.triangles.length;++t)for(f=this.triangles[t],i=0;i<3;++i)r=f.vertices[i],s[r.triangleStart+r.triangleCount]=new u(i,t),r.triangleCount++;this.references=s;n&&this.identifyBorder()},f.prototype.vertexError=function(n,t){var i=t.x,r=t.y,u=t.z;return n.data[0]*i*i+2*n.data[1]*i*r+2*n.data[2]*i*u+2*n.data[3]*i+n.data[4]*r*r+2*n.data[5]*r*u+2*n.data[6]*r+n.data[7]*u*u+2*n.data[8]*u+n.data[9]},f.prototype.calculateError=function(t,i,r){var u=t.q.add(i.q),c=t.isBorder&&i.isBorder,f=0,e=u.det(0,1,2,1,4,5,2,5,7);if(0===e||c){var o=t.position.add(i.position).divide(new n.Vector3(2,2,2)),s=this.vertexError(u,t.position),h=this.vertexError(u,i.position),l=this.vertexError(u,o);f=Math.min(s,h,l);f===s?r&&r.copyFrom(t.position):f===h?r&&r.copyFrom(i.position):r&&r.copyFrom(o)}else r||(r=n.Vector3.Zero()),r.x=-1/e*u.det(1,2,3,4,5,6,5,7,8),r.y=1/e*u.det(0,2,3,1,5,6,2,7,8),r.z=-1/e*u.det(0,1,3,1,4,6,2,5,8),f=this.vertexError(u,r);return f},f}();n.QuadraticErrorSimplification=f}(i||(i={}));!function(n){var t=[],i=function(i,r){if(!t[i.id]&&!i.doNotSerialize){if(i instanceof n.Geometry.Primitives.Box)r.boxes.push(i.serialize());else if(i instanceof n.Geometry.Primitives.Sphere)r.spheres.push(i.serialize());else if(i instanceof n.Geometry.Primitives.Cylinder)r.cylinders.push(i.serialize());else if(i instanceof n.Geometry.Primitives.Torus)r.toruses.push(i.serialize());else if(i instanceof n.Geometry.Primitives.Ground)r.grounds.push(i.serialize());else if(i instanceof n.Geometry.Primitives.Plane)r.planes.push(i.serialize());else if(i instanceof n.Geometry.Primitives.TorusKnot)r.torusKnots.push(i.serialize());else{if(i instanceof n.Geometry.Primitives._Primitive)throw new Error("Unknown primitive type");r.vertexData.push(i.serializeVerticeData())}t[i.id]=!0}},r=function(t,r){var u={},s,l,h,e,c,f,o;if(u.name=t.name,u.id=t.id,n.Tags.HasTags(t)&&(u.tags=n.Tags.GetTags(t)),u.position=t.position.asArray(),t.rotationQuaternion?u.rotationQuaternion=t.rotationQuaternion.asArray():t.rotation&&(u.rotation=t.rotation.asArray()),u.scaling=t.scaling.asArray(),u.localMatrix=t.getPivotMatrix().asArray(),u.isEnabled=t.isEnabled(),u.isVisible=t.isVisible,u.infiniteDistance=t.infiniteDistance,u.pickable=t.isPickable,u.receiveShadows=t.receiveShadows,u.billboardMode=t.billboardMode,u.visibility=t.visibility,u.checkCollisions=t.checkCollisions,u.isBlocker=t.isBlocker,t.parent&&(u.parentId=t.parent.id),s=t._geometry,s)for(l=s.id,u.geometryId=l,t.getScene().getGeometryByID(l)||i(s,r.geometries),u.subMeshes=[],h=0;h<t.subMeshes.length;h++)e=t.subMeshes[h],u.subMeshes.push({materialIndex:e.materialIndex,verticesStart:e.verticesStart,verticesCount:e.verticesCount,indexStart:e.indexStart,indexCount:e.indexCount});for(t.material?u.materialId=t.material.id:t.material=null,t.skeleton&&(u.skeletonId=t.skeleton.id),t.getPhysicsImpostor()&&(u.physicsMass=t.getPhysicsMass(),u.physicsFriction=t.getPhysicsFriction(),u.physicsRestitution=t.getPhysicsRestitution(),u.physicsImpostor=t.getPhysicsImpostor().type),t.metadata&&(u.metadata=t.metadata),u.instances=[],c=0;c<t.instances.length;c++)f=t.instances[c],o={name:f.name,position:f.position.asArray(),scaling:f.scaling.asArray()},f.rotationQuaternion?o.rotationQuaternion=f.rotationQuaternion.asArray():f.rotation&&(o.rotation=f.rotation.asArray()),u.instances.push(o),n.Animation.AppendSerializedAnimations(f,o),o.ranges=f.serializeAnimationRanges();return n.Animation.AppendSerializedAnimations(t,u),u.ranges=t.serializeAnimationRanges(),u.layerMask=t.layerMask,u.alphaIndex=t.alphaIndex,u.hasVertexAlpha=t.hasVertexAlpha,u.overlayAlpha=t.overlayAlpha,u.overlayColor=t.overlayColor.asArray(),u.renderOverlay=t.renderOverlay,u.applyFog=t.applyFog,t.actionManager&&(u.actions=t.actionManager.serialize(t.name)),u},u=function(t,u){if(t.delayLoadState===n.Engine.DELAYLOADSTATE_LOADED||t.delayLoadState===n.Engine.DELAYLOADSTATE_NONE){t.material&&(t.material instanceof n.StandardMaterial?(u.materials=u.materials||[],u.materials.some(function(n){return n.id===t.material.id})||u.materials.push(t.material.serialize())):t.material instanceof n.MultiMaterial&&(u.multiMaterials=u.multiMaterials||[],u.multiMaterials.some(function(n){return n.id===t.material.id})||u.multiMaterials.push(t.material.serialize())));var f=t._geometry;f&&(u.geometries||(u.geometries={},u.geometries.boxes=[],u.geometries.spheres=[],u.geometries.cylinders=[],u.geometries.toruses=[],u.geometries.grounds=[],u.geometries.planes=[],u.geometries.torusKnots=[],u.geometries.vertexData=[]),i(f,u.geometries));t.skeleton&&(u.skeletons=u.skeletons||[],u.skeletons.push(t.skeleton.serialize()));u.meshes=u.meshes||[];u.meshes.push(r(t,u))}},f=function(){function f(){}return f.ClearCache=function(){t=[]},f.Serialize=function(u){var f={},e,o,l,a,b,v,y,p,s,h,w,c;for(f.useDelayedTextureLoading=u.useDelayedTextureLoading,f.autoClear=u.autoClear,f.clearColor=u.clearColor.asArray(),f.ambientColor=u.ambientColor.asArray(),f.gravity=u.gravity.asArray(),f.collisionsEnabled=u.collisionsEnabled,f.workerCollisions=u.workerCollisions,u.fogMode&&0!==u.fogMode&&(f.fogMode=u.fogMode,f.fogColor=u.fogColor.asArray(),f.fogStart=u.fogStart,f.fogEnd=u.fogEnd,f.fogDensity=u.fogDensity),u.isPhysicsEnabled()&&(f.physicsEnabled=!0,f.physicsGravity=u.getPhysicsEngine().gravity.asArray(),f.physicsEngine=u.getPhysicsEngine().getPhysicsPluginName()),u.metadata&&(f.metadata=u.metadata),f.lights=[],e=0;e<u.lights.length;e++)o=u.lights[e],o.doNotSerialize||f.lights.push(o.serialize());for(f.cameras=[],e=0;e<u.cameras.length;e++)l=u.cameras[e],l.doNotSerialize||f.cameras.push(l.serialize());for(u.activeCamera&&(f.activeCameraID=u.activeCamera.id),n.Animation.AppendSerializedAnimations(u,f),f.materials=[],f.multiMaterials=[],e=0;e<u.materials.length;e++)a=u.materials[e],a.doNotSerialize||f.materials.push(a.serialize());for(f.multiMaterials=[],e=0;e<u.multiMaterials.length;e++)b=u.multiMaterials[e],f.multiMaterials.push(b.serialize());for(f.skeletons=[],e=0;e<u.skeletons.length;e++)f.skeletons.push(u.skeletons[e].serialize());for(f.geometries={},f.geometries.boxes=[],f.geometries.spheres=[],f.geometries.cylinders=[],f.geometries.toruses=[],f.geometries.grounds=[],f.geometries.planes=[],f.geometries.torusKnots=[],f.geometries.vertexData=[],t=[],v=u.getGeometries(),e=0;e<v.length;e++)y=v[e],y.isReady()&&i(y,f.geometries);for(f.meshes=[],e=0;e<u.meshes.length;e++)p=u.meshes[e],p instanceof n.Mesh&&(s=p,s.doNotSerialize||s.delayLoadState!==n.Engine.DELAYLOADSTATE_LOADED&&s.delayLoadState!==n.Engine.DELAYLOADSTATE_NONE||f.meshes.push(r(s,f)));for(f.particleSystems=[],e=0;e<u.particleSystems.length;e++)f.particleSystems.push(u.particleSystems[e].serialize());for(f.lensFlareSystems=[],e=0;e<u.lensFlareSystems.length;e++)f.lensFlareSystems.push(u.lensFlareSystems[e].serialize());for(f.shadowGenerators=[],e=0;e<u.lights.length;e++)o=u.lights[e],h=o.getShadowGenerator(),h&&h instanceof n.ShadowGenerator&&f.shadowGenerators.push(h.serialize());for(u.actionManager&&(f.actions=u.actionManager.serialize("scene")),f.sounds=[],e=0;e<u.soundTracks.length;e++)for(w=u.soundTracks[e],c=0;c<w.soundCollection.length;c++)f.sounds.push(w.soundCollection[c].serialize());return f},f.SerializeMesh=function(t,i,r){var e,f;if(void 0===i&&(i=!1),void 0===r&&(r=!1),e={},t=t instanceof Array?t:[t],i||r)for(f=0;f<t.length;++f)r&&t[f].getDescendants().forEach(function(i){i instanceof n.Mesh&&t.indexOf(i)<0&&t.push(i)}),i&&t[f].parent&&t.indexOf(t[f].parent)<0&&t.push(t[f].parent);return t.forEach(function(n){u(n,e)}),e},f}();n.SceneSerializer=f}(i||(i={}));!function(n){function p(n,t,i){var r,f,c,a,e,o,w,s;i=i||2;var y=t&&t.length,p=y?t[0]*i:n.length,h=l(n,0,p,i,!0),v=[];if(!h)return v;if(y&&(h=g(n,t,h,i)),n.length>80*i){for(r=c=n[0],f=a=n[1],s=i;s<p;s+=i)e=n[s],o=n[s+1],e<r&&(r=e),o<f&&(f=o),e>c&&(c=e),o>a&&(a=o);w=Math.max(c-r,a-f)}return u(h,v,i,r,f,w,void 0),v}function l(n,t,r,u,f){var o,s;if(f===c(n,t,r,u)>0)for(o=t;o<r;o+=u)s=y(o,n[o],n[o+1],s);else for(o=r-u;o>=t;o-=u)s=y(o,n[o],n[o+1],s);return s&&i(s,s.next)&&(e(s),s=s.next),s}function r(n,r){if(!n)return n;r||(r=n);var f,u=n;do if(f=!1,u.steiner||!i(u,u.next)&&0!==t(u.prev,u,u.next))u=u.next;else{if(e(u),u=r=u.prev,u===u.next)return null;f=!0}while(f||u!==r);return r}function u(n,t,i,f,o,s,h){if(n){!h&&s&&rt(n,f,o,s);for(var l,c,a=n;n.prev!==n.next;)if(l=n.prev,c=n.next,s?b(n,f,o,s):w(n))t.push(l.i/i),t.push(n.i/i),t.push(c.i/i),e(n),n=c.next,a=c.next;else if(n=c,n===a){h?1===h?(n=k(n,t,i),u(n,t,i,f,o,s,2)):2===h&&d(n,t,i,f,o,s):u(r(n,void 0),t,i,f,o,s,1);break}}}function w(n){var r=n.prev,u=n,f=n.next,i;if(t(r,u,f)>=0)return!1;for(i=n.next.next;i!==n.prev;){if(o(r.x,r.y,u.x,u.y,f.x,f.y,i.x,i.y)&&t(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function b(n,i,r,u){var h=n.prev,c=n,e=n.next;if(t(h,c,e)>=0)return!1;for(var l=h.x<c.x?h.x<e.x?h.x:e.x:c.x<e.x?c.x:e.x,a=h.y<c.y?h.y<e.y?h.y:e.y:c.y<e.y?c.y:e.y,v=h.x>c.x?h.x>e.x?h.x:e.x:c.x>e.x?c.x:e.x,y=h.y>c.y?h.y>e.y?h.y:e.y:c.y>e.y?c.y:e.y,p=s(l,a,i,r,u),w=s(v,y,i,r,u),f=n.nextZ;f&&f.z<=w;){if(f!==n.prev&&f!==n.next&&o(h.x,h.y,c.x,c.y,e.x,e.y,f.x,f.y)&&t(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=n.prevZ;f&&f.z>=p;){if(f!==n.prev&&f!==n.next&&o(h.x,h.y,c.x,c.y,e.x,e.y,f.x,f.y)&&t(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function k(n,t,r){var u=n,s,o;do s=u.prev,o=u.next.next,!i(s,o)&&a(s,u,u.next,o)&&f(s,o)&&f(o,s)&&(t.push(s.i/r),t.push(u.i/r),t.push(o.i/r),e(u),e(u.next),u=n=o),u=u.next;while(u!==n);return u}function d(n,t,i,f,e,o){var s=n,h,c;do{for(h=s.next.next;h!==s.prev;){if(s.i!==h.i&&et(s,h))return c=v(s,h),s=r(s,s.next),c=r(c,c.next),u(s,t,i,f,e,o,void 0),void u(c,t,i,f,e,o,void 0);h=h.next}s=s.next}while(s!==n)}function g(n,t,i,u){for(var h,c,e,o=[],f=0,s=t.length;f<s;f++)h=t[f]*u,c=f<s-1?t[f+1]*u:n.length,e=l(n,h,c,u,!1),e===e.next&&(e.steiner=!0),o.push(ft(e));for(o.sort(nt),f=0;f<o.length;f++)tt(o[f],i),i=r(i,i.next);return i}function nt(n,t){return n.x-t.x}function tt(n,t){if(t=it(n,t)){var i=v(t,n);r(i,i.next)}}function it(n,t){var r,i=t,e=n.x,u=n.y,s=-(1/0),h;do{if(u<=i.y&&u>=i.next.y&&(h=i.x+(u-i.y)*(i.next.x-i.x)/(i.next.y-i.y),h<=e&&h>s)){if(s=h,h===e){if(u===i.y)return i;if(u===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}i=i.next}while(i!==t);if(!r)return null;if(e===s)return r.prev;var c,y=r,v=r.x,l=r.y,a=1/0;for(i=r.next;i!==y;)e>=i.x&&i.x>=v&&o(u<l?e:s,u,v,l,u<l?s:e,u,i.x,i.y)&&(c=Math.abs(u-i.y)/(e-i.x),(c<a||c===a&&i.x>r.x)&&f(i,n)&&(r=i,a=c)),i=i.next;return r}function rt(n,t,i,r){var u=n;do null===u.z&&(u.z=s(u.x,u.y,t,i,r)),u.prevZ=u.prev,u.nextZ=u.next,u=u.next;while(u!==n);u.prevZ.nextZ=null;u.prevZ=null;ut(u)}function ut(n){var o,i,t,r,u,s,f,e,h=1;do{for(i=n,n=null,u=null,s=0;i;){for(s++,t=i,f=0,o=0;o<h&&(f++,t=t.nextZ,t);o++);for(e=h;f>0||e>0&&t;)0===f?(r=t,t=t.nextZ,e--):0!==e&&t?i.z<=t.z?(r=i,i=i.nextZ,f--):(r=t,t=t.nextZ,e--):(r=i,i=i.nextZ,f--),u?u.nextZ=r:n=r,r.prevZ=u,u=r;i=t}u.nextZ=null;h*=2}while(s>1);return n}function s(n,t,i,r,u){return n=32767*(n-i)/u,t=32767*(t-r)/u,n=16711935&(n|n<<8),n=252645135&(n|n<<4),n=858993459&(n|n<<2),n=1431655765&(n|n<<1),t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),n|t<<1}function ft(n){var t=n,i=n;do t.x<i.x&&(i=t),t=t.next;while(t!==n);return i}function o(n,t,i,r,u,f,e,o){return(u-e)*(t-o)-(n-e)*(f-o)>=0&&(n-e)*(r-o)-(i-e)*(t-o)>=0&&(i-e)*(f-o)-(u-e)*(r-o)>=0}function et(n,t){return n.next.i!==t.i&&n.prev.i!==t.i&&!ot(n,t)&&f(n,t)&&f(t,n)&&st(n,t)}function t(n,t,i){return(t.y-n.y)*(i.x-t.x)-(t.x-n.x)*(i.y-t.y)}function i(n,t){return n.x===t.x&&n.y===t.y}function a(n,r,u,f){return!!(i(n,r)&&i(u,f)||i(n,f)&&i(u,r))||t(n,r,u)>0!=t(n,r,f)>0&&t(u,f,n)>0!=t(u,f,r)>0}function ot(n,t){var i=n;do{if(i.i!==n.i&&i.next.i!==n.i&&i.i!==t.i&&i.next.i!==t.i&&a(i,i.next,n,t))return!0;i=i.next}while(i!==n);return!1}function f(n,i){return t(n.prev,n,n.next)<0?t(n,i,n.next)>=0&&t(n,n.prev,i)>=0:t(n,i,n.prev)<0||t(n,n.next,i)<0}function st(n,t){var i=n,r=!1,f=(n.x+t.x)/2,u=(n.y+t.y)/2;do i.y>u!=i.next.y>u&&f<(i.next.x-i.x)*(u-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next;while(i!==n);return r}function v(n,t){var r=new h(n.i,n.x,n.y),i=new h(t.i,t.x,t.y),u=n.next,f=t.prev;return n.next=t,t.prev=n,r.next=u,u.prev=r,i.next=r,r.prev=i,f.next=i,i.prev=f,i}function y(n,t,i,r){var u=new h(n,t,i);return r?(u.next=r.next,u.prev=r,r.next.prev=u,r.next=u):(u.prev=u,u.next=u),u}function e(n){n.next.prev=n.prev;n.prev.next=n.next;n.prevZ&&(n.prevZ.nextZ=n.nextZ);n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function h(n,t,i){this.i=n;this.x=t;this.y=i;this.prev=null;this.next=null;this.z=null;this.prevZ=null;this.nextZ=null;this.steiner=!1}function ht(n,t,i,r){var h=t&&t.length,p=h?t[0]*i:n.length,f=Math.abs(c(n,0,p,i)),u,s,l,a,e;if(h)for(u=0,s=t.length;u<s;u++)l=t[u]*i,a=u<s-1?t[u+1]*i:n.length,f-=Math.abs(c(n,l,a,i));for(e=0,u=0;u<r.length;u+=3){var o=r[u]*i,v=r[u+1]*i,y=r[u+2]*i;e+=Math.abs((n[o]-n[y])*(n[v+1]-n[o+1])-(n[o]-n[v])*(n[y+1]-n[o+1]))}return 0===f&&0===e?0:Math.abs((e-f)/f)}function c(n,t,i,r){for(var e=0,u=t,f=i-r;u<i;u+=r)e+=(n[f]-n[u])*(n[u+1]+n[f+1]),f=u;return e}function ct(n){for(var i,r,f=n[0][0].length,u={vertices:[],holes:[],dimensions:f},e=0,t=0;t<n.length;t++){for(i=0;i<n[t].length;i++)for(r=0;r<f;r++)u.vertices.push(n[t][i][r]);t>0&&(e+=n[t-1].length,u.holes.push(e))}return u}n.earcut=p;n.deviation=ht;n.flatten=ct}(f||(f={}));!function(n){var r=0,u=function(){function t(n,t,i){this.pos=n;this.normal=t;this.uv=i}return t.prototype.clone=function(){return new t(this.pos.clone(),this.normal.clone(),this.uv.clone())},t.prototype.flip=function(){this.normal=this.normal.scale(-1)},t.prototype.interpolate=function(i,r){return new t(n.Vector3.Lerp(this.pos,i.pos,r),n.Vector3.Lerp(this.normal,i.normal,r),n.Vector2.Lerp(this.uv,i.uv,r))},t}(),f=function(){function t(n,t){this.normal=n;this.w=t}return t.FromPoints=function(i,r,u){var e=u.subtract(i),o=r.subtract(i),f;return 0===e.lengthSquared()||0===o.lengthSquared()?null:(f=n.Vector3.Normalize(n.Vector3.Cross(e,o)),new t(f,n.Vector3.Dot(f,i)))},t.prototype.clone=function(){return new t(this.normal.clone(),this.w)},t.prototype.flip=function(){this.normal.scaleInPlace(-1);this.w=-this.w},t.prototype.splitPolygon=function(r,u,f,e,o){for(var l,g=0,w=1,y=2,nt=3,tt=0,b=[],k,a,v,d,c,s=0;s<r.vertices.length;s++)l=n.Vector3.Dot(this.normal,r.vertices[s].pos)-this.w,k=l<-t.EPSILON?y:l>t.EPSILON?w:g,tt|=k,b.push(k);switch(tt){case g:(n.Vector3.Dot(this.normal,r.plane.normal)>0?u:f).push(r);break;case w:e.push(r);break;case y:o.push(r);break;case nt:for(a=[],v=[],s=0;s<r.vertices.length;s++){var it=(s+1)%r.vertices.length,p=b[s],ut=b[it],h=r.vertices[s],rt=r.vertices[it];(p!==y&&a.push(h),p!==w&&v.push(p!==y?h.clone():h),(p|ut)===nt)&&(l=(this.w-n.Vector3.Dot(this.normal,h.pos))/n.Vector3.Dot(this.normal,rt.pos.subtract(h.pos)),d=h.interpolate(rt,l),a.push(d),v.push(d.clone()))}a.length>=3&&(c=new i(a,r.shared),c.plane&&e.push(c));v.length>=3&&(c=new i(v,r.shared),c.plane&&o.push(c))}},t.EPSILON=1e-5,t}(),i=function(){function n(n,t){this.vertices=n;this.shared=t;this.plane=f.FromPoints(n[0].pos,n[1].pos,n[2].pos)}return n.prototype.clone=function(){var t=this.vertices.map(function(n){return n.clone()});return new n(t,this.shared)},n.prototype.flip=function(){this.vertices.reverse().map(function(n){n.flip()});this.plane.flip()},n}(),t=function(){function n(n){this.plane=null;this.front=null;this.back=null;this.polygons=[];n&&this.build(n)}return n.prototype.clone=function(){var t=new n;return t.plane=this.plane&&this.plane.clone(),t.front=this.front&&this.front.clone(),t.back=this.back&&this.back.clone(),t.polygons=this.polygons.map(function(n){return n.clone()}),t},n.prototype.invert=function(){for(var t,n=0;n<this.polygons.length;n++)this.polygons[n].flip();this.plane&&this.plane.flip();this.front&&this.front.invert();this.back&&this.back.invert();t=this.front;this.front=this.back;this.back=t},n.prototype.clipPolygons=function(n){if(!this.plane)return n.slice();for(var t=[],i=[],r=0;r<n.length;r++)this.plane.splitPolygon(n[r],t,i,t,i);return this.front&&(t=this.front.clipPolygons(t)),i=this.back?this.back.clipPolygons(i):[],t.concat(i)},n.prototype.clipTo=function(n){this.polygons=n.clipPolygons(this.polygons);this.front&&this.front.clipTo(n);this.back&&this.back.clipTo(n)},n.prototype.allPolygons=function(){var n=this.polygons.slice();return this.front&&(n=n.concat(this.front.allPolygons())),this.back&&(n=n.concat(this.back.allPolygons())),n},n.prototype.build=function(t){if(t.length){this.plane||(this.plane=t[0].plane.clone());for(var i=[],r=[],u=0;u<t.length;u++)this.plane.splitPolygon(t[u],this.polygons,this.polygons,i,r);i.length&&(this.front||(this.front=new n),this.front.build(i));r.length&&(this.back||(this.back=new n),this.back.build(r))}},n}(),e=function(){function f(){this.polygons=[]}return f.FromMesh=function(t){var b,k,d,g,v,y,a,nt,tt,it,rt,ut=[],e,et,o,ot,st,c;if(!(t instanceof n.Mesh))throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";t.computeWorldMatrix(!0);a=t.getWorldMatrix();nt=t.position.clone();tt=t.rotation.clone();t.rotationQuaternion&&(it=t.rotationQuaternion.clone());rt=t.scaling.clone();for(var s=t.getIndices(),p=t.getVerticesData(n.VertexBuffer.PositionKind),w=t.getVerticesData(n.VertexBuffer.NormalKind),ft=t.getVerticesData(n.VertexBuffer.UVKind),l=t.subMeshes,h=0,ht=l.length;h<ht;h++)for(e=l[h].indexStart,et=l[h].indexCount+l[h].indexStart;e<et;e+=3){for(y=[],o=0;o<3;o++)ot=new n.Vector3(w[3*s[e+o]],w[3*s[e+o]+1],w[3*s[e+o]+2]),d=new n.Vector2(ft[2*s[e+o]],ft[2*s[e+o]+1]),st=new n.Vector3(p[3*s[e+o]],p[3*s[e+o]+1],p[3*s[e+o]+2]),g=n.Vector3.TransformCoordinates(st,a),k=n.Vector3.TransformNormal(ot,a),b=new u(g,k,d),y.push(b);v=new i(y,{subMeshId:h,meshId:r,materialIndex:l[h].materialIndex});v.plane&&ut.push(v)}return c=f.FromPolygons(ut),c.matrix=a,c.position=nt,c.rotation=tt,c.scaling=rt,c.rotationQuaternion=it,r++,c},f.FromPolygons=function(n){var t=new f;return t.polygons=n,t},f.prototype.clone=function(){var n=new f;return n.polygons=this.polygons.map(function(n){return n.clone()}),n.copyTransformAttributes(this),n},f.prototype.toPolygons=function(){return this.polygons},f.prototype.union=function(n){var r=new t(this.clone().polygons),i=new t(n.clone().polygons);return r.clipTo(i),i.clipTo(r),i.invert(),i.clipTo(r),i.invert(),r.build(i.allPolygons()),f.FromPolygons(r.allPolygons()).copyTransformAttributes(this)},f.prototype.unionInPlace=function(n){var r=new t(this.polygons),i=new t(n.polygons);r.clipTo(i);i.clipTo(r);i.invert();i.clipTo(r);i.invert();r.build(i.allPolygons());this.polygons=r.allPolygons()},f.prototype.subtract=function(n){var i=new t(this.clone().polygons),r=new t(n.clone().polygons);return i.invert(),i.clipTo(r),r.clipTo(i),r.invert(),r.clipTo(i),r.invert(),i.build(r.allPolygons()),i.invert(),f.FromPolygons(i.allPolygons()).copyTransformAttributes(this)},f.prototype.subtractInPlace=function(n){var i=new t(this.polygons),r=new t(n.polygons);i.invert();i.clipTo(r);r.clipTo(i);r.invert();r.clipTo(i);r.invert();i.build(r.allPolygons());i.invert();this.polygons=i.allPolygons()},f.prototype.intersect=function(n){var i=new t(this.clone().polygons),r=new t(n.clone().polygons);return i.invert(),r.clipTo(i),r.invert(),i.clipTo(r),r.clipTo(i),i.build(r.allPolygons()),i.invert(),f.FromPolygons(i.allPolygons()).copyTransformAttributes(this)},f.prototype.intersectInPlace=function(n){var i=new t(this.polygons),r=new t(n.polygons);i.invert();r.clipTo(i);r.invert();i.clipTo(r);r.clipTo(i);i.build(r.allPolygons());i.invert();this.polygons=i.allPolygons()},f.prototype.inverse=function(){var n=this.clone();return n.inverseInPlace(),n},f.prototype.inverseInPlace=function(){this.polygons.map(function(n){n.flip()})},f.prototype.copyTransformAttributes=function(n){return this.matrix=n.matrix,this.position=n.position,this.rotation=n.rotation,this.scaling=n.scaling,this.rotationQuaternion=n.rotationQuaternion,this},f.prototype.buildMeshGeometry=function(t,i,r){var g=this.matrix.clone(),b,st,p,ht,l,e,k,d,rt,ut,ct;g.invert();var u,o,f,h=new n.Mesh(t,i),nt=[],ft=[],a=[],w=[],et=n.Vector3.Zero(),v=n.Vector3.Zero(),y=n.Vector2.Zero(),tt=this.polygons,c=[0,0,0],ot={},it=0,s={};for(r&&tt.sort(function(n,t){return n.shared.meshId===t.shared.meshId?n.shared.subMeshId-t.shared.subMeshId:n.shared.meshId-t.shared.meshId}),b=0,st=tt.length;b<st;b++)for(u=tt[b],s[u.shared.meshId]||(s[u.shared.meshId]={}),s[u.shared.meshId][u.shared.subMeshId]||(s[u.shared.meshId][u.shared.subMeshId]={indexStart:+(1/0),indexEnd:-(1/0),materialIndex:u.shared.materialIndex}),f=s[u.shared.meshId][u.shared.subMeshId],p=2,ht=u.vertices.length;p<ht;p++)for(c[0]=0,c[1]=p-1,c[2]=p,l=0;l<3;l++)et.copyFrom(u.vertices[c[l]].pos),v.copyFrom(u.vertices[c[l]].normal),y.copyFrom(u.vertices[c[l]].uv),e=n.Vector3.TransformCoordinates(et,g),k=n.Vector3.TransformNormal(v,g),o=ot[e.x+","+e.y+","+e.z],"undefined"!=typeof o&&a[3*o]===k.x&&a[3*o+1]===k.y&&a[3*o+2]===k.z&&w[2*o]===y.x&&w[2*o+1]===y.y||(nt.push(e.x,e.y,e.z),w.push(y.x,y.y),a.push(v.x,v.y,v.z),o=ot[e.x+","+e.y+","+e.z]=nt.length/3-1),ft.push(o),f.indexStart=Math.min(it,f.indexStart),f.indexEnd=Math.max(it,f.indexEnd),it++;if(h.setVerticesData(n.VertexBuffer.PositionKind,nt),h.setVerticesData(n.VertexBuffer.NormalKind,a),h.setVerticesData(n.VertexBuffer.UVKind,w),h.setIndices(ft),r){rt=0;h.subMeshes=[];for(ut in s){d=-1;for(ct in s[ut])f=s[ut][ct],n.SubMesh.CreateFromIndices(f.materialIndex+rt,f.indexStart,f.indexEnd-f.indexStart+1,h),d=Math.max(f.materialIndex,d);rt+=++d}}return h},f.prototype.toMesh=function(n,t,i,r){var u=this.buildMeshGeometry(n,i,r);return u.material=t,u.position.copyFrom(this.position),u.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(u.rotationQuaternion=this.rotationQuaternion.clone()),u.scaling.copyFrom(this.scaling),u.computeWorldMatrix(!0),u},f}();n.CSG=e}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f){var e=this;t.call(this,i,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,f.postProcessScaleFactor,r,n.Texture.BILINEAR_SAMPLINGMODE,null,null);this._isRightEye=u;this._distortionFactors=f.distortionK;this._postProcessScaleFactor=f.postProcessScaleFactor;this._lensCenterOffset=f.lensCenterOffset;this.onSizeChangedObservable.add(function(){e.aspectRatio=.5*e.width/e.height;e._scaleIn=new n.Vector2(2,2/e.aspectRatio);e._scaleFactor=new n.Vector2(.5*(1/e._postProcessScaleFactor),.5*(1/e._postProcessScaleFactor)*e.aspectRatio);e._lensCenter=new n.Vector2(e._isRightEye?.5-.5*e._lensCenterOffset:.5+.5*e._lensCenterOffset,.5)});this.onApplyObservable.add(function(n){n.setFloat2("LensCenter",e._lensCenter.x,e._lensCenter.y);n.setFloat2("Scale",e._scaleFactor.x,e._scaleFactor.y);n.setFloat2("ScaleIn",e._scaleIn.x,e._scaleIn.y);n.setFloat4("HmdWarpParam",e._distortionFactors[0],e._distortionFactors[1],e._distortionFactors[2],e._distortionFactors[3])})}return u(i,t),i}(n.PostProcess);n.VRDistortionCorrectionPostProcess=t}(i||(i={}));!function(n){!function(n){n[n.X=0]="X";n[n.Y=1]="Y";n[n.Z=2]="Z"}(n.JoystickAxis||(n.JoystickAxis={}));var t=n.JoystickAxis,i=function(){function i(r){var u=this;this._leftJoystick=r?!0:!1;this._joystickIndex=i._globalJoystickIndex;i._globalJoystickIndex++;this._axisTargetedByLeftAndRight=t.X;this._axisTargetedByUpAndDown=t.Y;this.reverseLeftRight=!1;this.reverseUpDown=!1;this._touches=new n.StringDictionary;this.deltaPosition=n.Vector3.Zero();this._joystickSensibility=25;this._inversedSensibility=1e3/this._joystickSensibility;this._rotationSpeed=25;this._inverseRotationSpeed=1e3/this._rotationSpeed;this._rotateOnAxisRelativeToMesh=!1;this._onResize=function(){i.vjCanvasWidth=window.innerWidth;i.vjCanvasHeight=window.innerHeight;i.vjCanvas.width=i.vjCanvasWidth;i.vjCanvas.height=i.vjCanvasHeight;i.halfWidth=i.vjCanvasWidth/2;i.halfHeight=i.vjCanvasHeight/2};i.vjCanvas||(window.addEventListener("resize",this._onResize,!1),i.vjCanvas=document.createElement("canvas"),i.vjCanvasWidth=window.innerWidth,i.vjCanvasHeight=window.innerHeight,i.vjCanvas.width=window.innerWidth,i.vjCanvas.height=window.innerHeight,i.vjCanvas.style.width="100%",i.vjCanvas.style.height="100%",i.vjCanvas.style.position="absolute",i.vjCanvas.style.backgroundColor="transparent",i.vjCanvas.style.top="0px",i.vjCanvas.style.left="0px",i.vjCanvas.style.zIndex="5",i.vjCanvas.style.msTouchAction="none",i.vjCanvas.setAttribute("touch-action","none"),i.vjCanvasContext=i.vjCanvas.getContext("2d"),i.vjCanvasContext.strokeStyle="#ffffff",i.vjCanvasContext.lineWidth=2,document.body.appendChild(i.vjCanvas));i.halfWidth=i.vjCanvas.width/2;i.halfHeight=i.vjCanvas.height/2;this.pressed=!1;this._joystickColor="cyan";this._joystickPointerID=-1;this._joystickPointerPos=new n.Vector2(0,0);this._joystickPreviousPointerPos=new n.Vector2(0,0);this._joystickPointerStartPos=new n.Vector2(0,0);this._deltaJoystickVector=new n.Vector2(0,0);this._onPointerDownHandlerRef=function(n){u._onPointerDown(n)};this._onPointerMoveHandlerRef=function(n){u._onPointerMove(n)};this._onPointerOutHandlerRef=function(n){u._onPointerUp(n)};this._onPointerUpHandlerRef=function(n){u._onPointerUp(n)};i.vjCanvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1);i.vjCanvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1);i.vjCanvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1);i.vjCanvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1);i.vjCanvas.addEventListener("contextmenu",function(n){n.preventDefault()},!1);requestAnimationFrame(function(){u._drawVirtualJoystick()})}return i.prototype.setJoystickSensibility=function(n){this._joystickSensibility=n;this._inversedSensibility=1e3/this._joystickSensibility},i.prototype._onPointerDown=function(n){var t;n.preventDefault();t=this._leftJoystick===!0?n.clientX<i.halfWidth:n.clientX>i.halfWidth;t&&this._joystickPointerID<0?(this._joystickPointerID=n.pointerId,this._joystickPointerStartPos.x=n.clientX,this._joystickPointerStartPos.y=n.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone(),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(n.pointerId.toString(),n)):i._globalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(n.pointerId.toString(),{x:n.clientX,y:n.clientY,prevX:n.clientX,prevY:n.clientY}))},i.prototype._onPointerMove=function(n){var f,i,e,r,u;if(this._joystickPointerID==n.pointerId){this._joystickPointerPos.x=n.clientX;this._joystickPointerPos.y=n.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone();this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos);f=this.reverseLeftRight?-1:1;i=f*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case t.X:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case t.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case t.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,i))}e=this.reverseUpDown?1:-1;r=e*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case t.X:this.deltaPosition.x=Math.min(1,Math.max(-1,r));break;case t.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,r));break;case t.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,r))}}else u=this._touches.get(n.pointerId.toString()),u&&(u.x=n.clientX,u.y=n.clientY)},i.prototype._onPointerUp=function(n){if(this._joystickPointerID==n.pointerId)i.vjCanvasContext.clearRect(this._joystickPointerStartPos.x-63,this._joystickPointerStartPos.y-63,126,126),i.vjCanvasContext.clearRect(this._joystickPreviousPointerPos.x-41,this._joystickPreviousPointerPos.y-41,82,82),this._joystickPointerID=-1,this.pressed=!1;else{var t=this._touches.get(n.pointerId.toString());t&&i.vjCanvasContext.clearRect(t.prevX-43,t.prevY-43,86,86)}this._deltaJoystickVector.x=0;this._deltaJoystickVector.y=0;this._touches.remove(n.pointerId.toString())},i.prototype.setJoystickColor=function(n){this._joystickColor=n},i.prototype.setActionOnTouch=function(n){this._action=n},i.prototype.setAxisForLeftRight=function(n){switch(n){case t.X:case t.Y:case t.Z:this._axisTargetedByLeftAndRight=n;break;default:this._axisTargetedByLeftAndRight=t.X}},i.prototype.setAxisForUpDown=function(n){switch(n){case t.X:case t.Y:case t.Z:this._axisTargetedByUpAndDown=n;break;default:this._axisTargetedByUpAndDown=t.Y}},i.prototype._clearCanvas=function(){this._leftJoystick?i.vjCanvasContext.clearRect(0,0,i.vjCanvasWidth/2,i.vjCanvasHeight):i.vjCanvasContext.clearRect(i.vjCanvasWidth/2,0,i.vjCanvasWidth,i.vjCanvasHeight)},i.prototype._drawVirtualJoystick=function(){var n=this;this.pressed&&this._touches.forEach(function(t){t.pointerId===n._joystickPointerID?(i.vjCanvasContext.clearRect(n._joystickPointerStartPos.x-63,n._joystickPointerStartPos.y-63,126,126),i.vjCanvasContext.clearRect(n._joystickPreviousPointerPos.x-41,n._joystickPreviousPointerPos.y-41,82,82),i.vjCanvasContext.beginPath(),i.vjCanvasContext.lineWidth=6,i.vjCanvasContext.strokeStyle=n._joystickColor,i.vjCanvasContext.arc(n._joystickPointerStartPos.x,n._joystickPointerStartPos.y,40,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),i.vjCanvasContext.beginPath(),i.vjCanvasContext.strokeStyle=n._joystickColor,i.vjCanvasContext.lineWidth=2,i.vjCanvasContext.arc(n._joystickPointerStartPos.x,n._joystickPointerStartPos.y,60,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),i.vjCanvasContext.beginPath(),i.vjCanvasContext.strokeStyle=n._joystickColor,i.vjCanvasContext.arc(n._joystickPointerPos.x,n._joystickPointerPos.y,40,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),n._joystickPreviousPointerPos=n._joystickPointerPos.clone()):(i.vjCanvasContext.clearRect(t.prevX-43,t.prevY-43,86,86),i.vjCanvasContext.beginPath(),i.vjCanvasContext.fillStyle="white",i.vjCanvasContext.beginPath(),i.vjCanvasContext.strokeStyle="red",i.vjCanvasContext.lineWidth=6,i.vjCanvasContext.arc(t.x,t.y,40,0,2*Math.PI,!0),i.vjCanvasContext.stroke(),i.vjCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)});requestAnimationFrame(function(){n._drawVirtualJoystick()})},i.prototype.releaseCanvas=function(){i.vjCanvas&&(i.vjCanvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),i.vjCanvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),i.vjCanvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),i.vjCanvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(i.vjCanvas),i.vjCanvas=null)},i._globalJoystickIndex=0,i}();n.VirtualJoystick=i}(i||(i={}));!function(n){var t=function(n){function t(t,i,r){n.call(this,t,i,r);this.inputs.addVirtualJoystick()}return u(t,n),t}(n.FreeCamera);n.VirtualJoysticksCamera=t}(i||(i={}));!function(n){var t=function(){function t(){}return t.prototype.getLeftJoystick=function(){return this._leftjoystick},t.prototype.getRightJoystick=function(){return this._rightjoystick},t.prototype.checkInputs=function(){if(this._leftjoystick){var t=this.camera,i=50*t._computeLocalCameraSpeed(),r=n.Matrix.RotationYawPitchRoll(t.rotation.y,t.rotation.x,0),u=n.Vector3.TransformCoordinates(new n.Vector3(this._leftjoystick.deltaPosition.x*i,this._leftjoystick.deltaPosition.y*i,this._leftjoystick.deltaPosition.z*i),r);t.cameraDirection=t.cameraDirection.add(u);t.cameraRotation=t.cameraRotation.addVector3(this._rightjoystick.deltaPosition);this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9));this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}},t.prototype.attachControl=function(){this._leftjoystick=new n.VirtualJoystick(!0);this._leftjoystick.setAxisForUpDown(n.JoystickAxis.Z);this._leftjoystick.setAxisForLeftRight(n.JoystickAxis.X);this._leftjoystick.setJoystickSensibility(.15);this._rightjoystick=new n.VirtualJoystick(!1);this._rightjoystick.setAxisForUpDown(n.JoystickAxis.X);this._rightjoystick.setAxisForLeftRight(n.JoystickAxis.Y);this._rightjoystick.reverseUpDown=!0;this._rightjoystick.setJoystickSensibility(.05);this._rightjoystick.setJoystickColor("yellow")},t.prototype.detachControl=function(){this._leftjoystick.releaseCanvas();this._rightjoystick.releaseCanvas()},t.prototype.getTypeName=function(){return"FreeCameraVirtualJoystickInput"},t.prototype.getSimpleName=function(){return"virtualJoystick"},t}();n.FreeCameraVirtualJoystickInput=t;n.CameraInputTypes.FreeCameraVirtualJoystickInput=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r,u,f,e){var o=this;n.call(this,t,"anaglyph",null,["leftSampler"],i,r[1],u,f,e);this._passedProcess=r[0]._rigPostProcess;this.onApplyObservable.add(function(n){n.setTextureFromPostProcess("leftSampler",o._passedProcess)})}return u(t,n),t}(n.PostProcess);n.AnaglyphPostProcess=t}(i||(i={}));!function(n){var t=function(){function t(n){this._scene=n}return t.prototype.render=function(t,i,r){var h=this,u,f,e;void 0===r&&(r=!1);var c=this._scene,o=this._scene.getEngine(),s=null!==o.getCaps().instancedArrays&&null!==i.visibleInstances[t._id]&&void 0!==i.visibleInstances[t._id];this.isReady(t,s)&&(u=t.getRenderingMesh(),f=t.getMaterial(),(o.enableEffect(this._effect),this._effect.setFloat("offset",r?0:u.outlineWidth),this._effect.setColor4("color",r?u.overlayColor:u.outlineColor,r?u.overlayAlpha:1),this._effect.setMatrix("viewProjection",c.getTransformMatrix()),u.useBones&&u.computeBonesUsingShaders&&this._effect.setMatrices("mBones",u.skeleton.getTransformMatrices(u)),u._bind(t,this._effect,n.Material.TriangleFillMode),f&&f.needAlphaTesting())&&(e=f.getAlphaTestTexture(),this._effect.setTexture("diffuseSampler",e),this._effect.setMatrix("diffuseMatrix",e.getTextureMatrix())),u._processRendering(t,this._effect,n.Material.TriangleFillMode,i,s,function(n,t){h._effect.setMatrix("world",t)}))},t.prototype.isReady=function(t,i){var u=[],r=[n.VertexBuffer.PositionKind,n.VertexBuffer.NormalKind],f=t.getMesh(),o=t.getMaterial(),e;return o&&o.needAlphaTesting()&&(u.push("#define ALPHATEST"),f.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(r.push(n.VertexBuffer.UVKind),u.push("#define UV1")),f.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&(r.push(n.VertexBuffer.UV2Kind),u.push("#define UV2"))),f.useBones&&f.computeBonesUsingShaders?(r.push(n.VertexBuffer.MatricesIndicesKind),r.push(n.VertexBuffer.MatricesWeightsKind),f.numBoneInfluencers>4&&(r.push(n.VertexBuffer.MatricesIndicesExtraKind),r.push(n.VertexBuffer.MatricesWeightsExtraKind)),u.push("#define NUM_BONE_INFLUENCERS "+f.numBoneInfluencers),u.push("#define BonesPerMesh "+(f.skeleton.bones.length+1))):u.push("#define NUM_BONE_INFLUENCERS 0"),i&&(u.push("#define INSTANCES"),r.push("world0"),r.push("world1"),r.push("world2"),r.push("world3")),e=u.join("\n"),this._cachedDefines!==e&&(this._cachedDefines=e,this._effect=this._scene.getEngine().createEffect("outline",r,["world","mBones","viewProjection","diffuseMatrix","offset","color"],["diffuseSampler"],e)),this._effect.isReady()},t}();n.OutlineRenderer=t}(i||(i={}));!function(n){var f=function(){function t(n,t,i,r){this.name=n;this.meshesNames=t;this.rootUrl=i;this.sceneFilename=r;this.isCompleted=!1}return t.prototype.run=function(t,i,r){var u=this;n.SceneLoader.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,t,function(n,t,r){u.loadedMeshes=n;u.loadedParticleSystems=t;u.loadedSkeletons=r;u.isCompleted=!0;u.onSuccess&&u.onSuccess(u);i()},null,function(){u.onError&&u.onError(u);r()})},t}(),t,i,r,u,e,o;n.MeshAssetTask=f;t=function(){function t(n,t){this.name=n;this.url=t;this.isCompleted=!1}return t.prototype.run=function(t,i,r){var u=this;n.Tools.LoadFile(this.url,function(n){u.text=n;u.isCompleted=!0;u.onSuccess&&u.onSuccess(u);i()},null,t.database,!1,function(){u.onError&&u.onError(u);r()})},t}();n.TextFileAssetTask=t;i=function(){function t(n,t){this.name=n;this.url=t;this.isCompleted=!1}return t.prototype.run=function(t,i,r){var u=this;n.Tools.LoadFile(this.url,function(n){u.data=n;u.isCompleted=!0;u.onSuccess&&u.onSuccess(u);i()},null,t.database,!0,function(){u.onError&&u.onError(u);r()})},t}();n.BinaryFileAssetTask=i;r=function(){function t(n,t){this.name=n;this.url=t;this.isCompleted=!1}return t.prototype.run=function(t,i,r){var u=this,f=new Image;n.Tools.SetCorsBehavior(this.url,f);f.onload=function(){u.image=f;u.isCompleted=!0;u.onSuccess&&u.onSuccess(u);i()};f.onerror=function(){u.onError&&u.onError(u);r()};f.src=this.url},t}();n.ImageAssetTask=r;u=function(){function t(t,i,r,u,f){void 0===f&&(f=n.Texture.TRILINEAR_SAMPLINGMODE);this.name=t;this.url=i;this.noMipmap=r;this.invertY=u;this.samplingMode=f;this.isCompleted=!1}return t.prototype.run=function(t,i,r){var u=this,f=function(){u.isCompleted=!0;u.onSuccess&&u.onSuccess(u);i()},e=function(){u.onError&&u.onError(u);r()};this.texture=new n.Texture(this.url,t,this.noMipmap,this.invertY,this.samplingMode,f,e)},t}();n.TextureAssetTask=u;e=function(){function t(n,t,i,r,u){this.name=n;this.url=t;this.extensions=i;this.noMipmap=r;this.files=u;this.isCompleted=!1}return t.prototype.run=function(t,i,r){var u=this,f=function(){u.isCompleted=!0;u.onSuccess&&u.onSuccess(u);i()},e=function(){u.onError&&u.onError(u);r()};this.texture=new n.CubeTexture(this.url,t,this.extensions,this.noMipmap,this.files,f,e)},t}();n.CubeTextureAssetTask=e;o=function(){function e(n){this.tasks=[];this.waitingTasksCount=0;this.useDefaultLoadingScreen=!0;this._scene=n}return e.prototype.addMeshTask=function(n,t,i,r){var u=new f(n,t,i,r);return this.tasks.push(u),u},e.prototype.addTextFileTask=function(n,i){var r=new t(n,i);return this.tasks.push(r),r},e.prototype.addBinaryFileTask=function(n,t){var r=new i(n,t);return this.tasks.push(r),r},e.prototype.addImageTask=function(n,t){var i=new r(n,t);return this.tasks.push(i),i},e.prototype.addTextureTask=function(t,i,r,f,e){void 0===e&&(e=n.Texture.TRILINEAR_SAMPLINGMODE);var o=new u(t,i,r,f,e);return this.tasks.push(o),o},e.prototype._decreaseWaitingTasksCount=function(){this.waitingTasksCount--;0===this.waitingTasksCount&&(this.onFinish&&this.onFinish(this.tasks),this._scene.getEngine().hideLoadingUI())},e.prototype._runTask=function(n){var t=this;n.run(this._scene,function(){t.onTaskSuccess&&t.onTaskSuccess(n);t._decreaseWaitingTasksCount()},function(){t.onTaskError&&t.onTaskError(n);t._decreaseWaitingTasksCount()})},e.prototype.reset=function(){return this.tasks=[],this},e.prototype.load=function(){var n,t;if(this.waitingTasksCount=this.tasks.length,0===this.waitingTasksCount)return this.onFinish&&this.onFinish(this.tasks),this;for(this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI(),n=0;n<this.tasks.length;n++)t=this.tasks[n],this._runTask(t);return this},e}();n.AssetsManager=o}(i||(i={}));!function(n){var t=function(){function t(){this.compensateDistortion=!0}return Object.defineProperty(t.prototype,"aspectRatio",{get:function(){return this.hResolution/(2*this.vResolution)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"aspectRatioFov",{get:function(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"leftHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2,i=4*t/this.hScreenSize;return n.Matrix.Translation(i,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rightHMatrix",{get:function(){var t=this.hScreenSize/4-this.lensSeparationDistance/2,i=4*t/this.hScreenSize;return n.Matrix.Translation(-i,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"leftPreViewMatrix",{get:function(){return n.Matrix.Translation(.5*this.interpupillaryDistance,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rightPreViewMatrix",{get:function(){return n.Matrix.Translation(-.5*this.interpupillaryDistance,0,0)},enumerable:!0,configurable:!0}),t.GetDefault=function(){var n=new t;return n.hResolution=1280,n.vResolution=800,n.hScreenSize=.149759993,n.vScreenSize=.0935999975,n.vScreenCenter=.0467999987,n.eyeToScreenDistance=.0410000011,n.lensSeparationDistance=.063500002,n.interpupillaryDistance=.064000003,n.distortionK=[1,.219999999,.239999995,0],n.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],n.postProcessScaleFactor=1.7146055078084119,n.lensCenterOffset=.151976421,n},t}();n.VRCameraMetrics=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e){var o=this;void 0===f&&(f=!1);void 0===e&&(e={});t.call(this,i,r,u);this.webVROptions=e;this._vrDevice=null;this._cacheState=null;this._vrEnabled=!1;this._attached=!1;this._positionOffset=r;this.getEngine().initWebVR();this.getEngine().vrDisplaysPromise?(this._frameData=new VRFrameData,this.getEngine().vrDisplaysPromise.then(function(t){if(t.length>0){if(o._vrEnabled=!0,o.webVROptions.displayName){var i=t.some(function(n){return n.displayName===o.webVROptions.displayName&&(o._vrDevice=n,!0)});i||(o._vrDevice=t[0],n.Tools.Warn("Display "+o.webVROptions.displayName+" was not found. Using "+o._vrDevice.displayName))}else o._vrDevice=t[0];o.setCameraRigMode(n.Camera.RIG_MODE_WEBVR,{vrDisplay:o._vrDevice,frameData:o._frameData});o._attached&&o.getEngine().enableVR(o._vrDevice)}else n.Tools.Error("No WebVR devices found!")})):n.Tools.Error("WebVR is not enabled on your browser");this.rotationQuaternion=new n.Quaternion;this._quaternionCache=new n.Quaternion}return u(i,t),i.prototype._checkInputs=function(){if(this._vrEnabled&&this._vrDevice.getFrameData(this._frameData)){var n=this._frameData.pose;n&&n.orientation&&(this._cacheState=n,this.rotationQuaternion.copyFromFloats(this._cacheState.orientation[0],this._cacheState.orientation[1],-this._cacheState.orientation[2],-this._cacheState.orientation[3]),this.webVROptions.trackPosition&&this._cacheState.position&&(this.position.copyFromFloats(this._cacheState.position[0],this._cacheState.position[1],-this._cacheState.position[2]),this.webVROptions.positionScale&&this.position.scaleInPlace(this.webVROptions.positionScale),this.position.addInPlace(this._positionOffset)))}t.prototype._checkInputs.call(this)},i.prototype.attachControl=function(i,r){t.prototype.attachControl.call(this,i,r);this._attached=!0;r=!n.Camera.ForceAttachControlToAlwaysPreventDefault&&r;this._vrEnabled&&this.getEngine().enableVR(this._vrDevice)},i.prototype.detachControl=function(n){t.prototype.detachControl.call(this,n);this._vrEnabled=!1;this._attached=!1;this.getEngine().disableVR()},i.prototype.requestVRFullscreen=function(){n.Tools.Warn("requestVRFullscreen is deprecated. call attachControl() to start sending frames to the VR display.")},i.prototype.getTypeName=function(){return"WebVRFreeCamera"},i.prototype.resetToCurrentRotation=function(){this._vrDevice.resetPose()},i.prototype.setPositionOffset=function(n){n?this._positionOffset=n:this._positionOffset.copyFrom(this.position)},i}(n.FreeCamera);n.WebVRFreeCamera=t}(i||(i={}));!function(n){var t=function(){function n(n){void 0===n&&(n=0);this.priority=n;this.apply=function(){return!0}}return n}(),i,h,r,f,e,o,c,s,l,a;n.SceneOptimization=t;i=function(n){function t(t,i){var r=this;void 0===t&&(t=0);void 0===i&&(i=1024);n.call(this,t);this.priority=t;this.maximumSize=i;this.apply=function(n){for(var i,f,e,u=!0,t=0;t<n.textures.length;t++)i=n.textures[t],i.canRescale&&(f=i.getSize(),e=Math.max(f.width,f.height),e>r.maximumSize&&(i.scale(.5),u=!1));return u}}return u(t,n),t}(t);n.TextureOptimization=i;h=function(n){function t(t,i){var r=this;void 0===t&&(t=0);void 0===i&&(i=2);n.call(this,t);this.priority=t;this.maximumScale=i;this._currentScale=1;this.apply=function(n){return r._currentScale++,n.getEngine().setHardwareScalingLevel(r._currentScale),r._currentScale>=r.maximumScale}}return u(t,n),t}(t);n.HardwareScalingOptimization=h;r=function(n){function t(){n.apply(this,arguments);this.apply=function(n){return n.shadowsEnabled=!1,!0}}return u(t,n),t}(t);n.ShadowsOptimization=r;f=function(n){function t(){n.apply(this,arguments);this.apply=function(n){return n.postProcessesEnabled=!1,!0}}return u(t,n),t}(t);n.PostProcessesOptimization=f;e=function(n){function t(){n.apply(this,arguments);this.apply=function(n){return n.lensFlaresEnabled=!1,!0}}return u(t,n),t}(t);n.LensFlaresOptimization=e;o=function(n){function t(){n.apply(this,arguments);this.apply=function(n){return n.particlesEnabled=!1,!0}}return u(t,n),t}(t);n.ParticlesOptimization=o;c=function(n){function t(){n.apply(this,arguments);this.apply=function(n){return n.renderTargetsEnabled=!1,!0}}return u(t,n),t}(t);n.RenderTargetsOptimization=c;s=function(t){function i(){var r=this;t.apply(this,arguments);this._canBeMerged=function(t){if(!(t instanceof n.Mesh))return!1;var i=t;return!(!i.isVisible||!i.isEnabled())&&!(i.instances.length>0)&&!i.skeleton&&!i.hasLODLevels&&!i.parent};this.apply=function(t,u){for(var e,o,f,s,h=t.meshes.slice(0),l=h.length,c=0;c<l;c++)if(e=[],o=h[c],r._canBeMerged(o)){for(e.push(o),f=c+1;f<l;f++)s=h[f],r._canBeMerged(s)&&s.material===o.material&&s.checkCollisions===o.checkCollisions&&(e.push(s),l--,h.splice(f,1),f--);e.length<2||n.Mesh.MergeMeshes(e)}return void 0!=u?u&&t.createOrUpdateSelectionOctree():i.UpdateSelectionTree&&t.createOrUpdateSelectionOctree(),!0}}return u(i,t),Object.defineProperty(i,"UpdateSelectionTree",{get:function(){return i._UpdateSelectionTree},set:function(n){i._UpdateSelectionTree=n},enumerable:!0,configurable:!0}),i._UpdateSelectionTree=!1,i}(t);n.MergeMeshesOptimization=s;l=function(){function n(n,t){void 0===n&&(n=60);void 0===t&&(t=2e3);this.targetFrameRate=n;this.trackerDuration=t;this.optimizations=[]}return n.LowDegradationAllowed=function(t){var h=new n(t),u=0;return h.optimizations.push(new s(u)),h.optimizations.push(new r(u)),h.optimizations.push(new e(u)),u++,h.optimizations.push(new f(u)),h.optimizations.push(new o(u)),u++,h.optimizations.push(new i(u,1024)),h},n.ModerateDegradationAllowed=function(t){var l=new n(t),u=0;return l.optimizations.push(new s(u)),l.optimizations.push(new r(u)),l.optimizations.push(new e(u)),u++,l.optimizations.push(new f(u)),l.optimizations.push(new o(u)),u++,l.optimizations.push(new i(u,512)),u++,l.optimizations.push(new c(u)),u++,l.optimizations.push(new h(u,2)),l},n.HighDegradationAllowed=function(t){var l=new n(t),u=0;return l.optimizations.push(new s(u)),l.optimizations.push(new r(u)),l.optimizations.push(new e(u)),u++,l.optimizations.push(new f(u)),l.optimizations.push(new o(u)),u++,l.optimizations.push(new i(u,256)),u++,l.optimizations.push(new c(u)),u++,l.optimizations.push(new h(u,4)),l},n}();n.SceneOptimizerOptions=l;a=function(){function n(){}return n._CheckCurrentState=function(t,i,r,u,f){var s;if(t.getEngine().getFps()>=i.targetFrameRate)return void(u&&u());for(var e=!0,h=!0,o=0;o<i.optimizations.length;o++)s=i.optimizations[o],s.priority===r&&(h=!1,e=e&&s.apply(t));return h?void(f&&f()):(e&&r++,void t.executeWhenReady(function(){setTimeout(function(){n._CheckCurrentState(t,i,r,u,f)},i.trackerDuration)}))},n.OptimizeAsync=function(t,i,r,u){i||(i=l.ModerateDegradationAllowed());t.executeWhenReady(function(){setTimeout(function(){n._CheckCurrentState(t,i,0,r,u)},i.trackerDuration)})},n}();n.SceneOptimizer=a}(i||(i={}));!function(n){var t;!function(n){var t=function(){function n(n,t){this.distance=n;this.mesh=t}return n}();n.MeshLODLevel=t}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s,h){void 0===o&&(o=!0);void 0===s&&(s=!1);void 0===h&&(h=n.Texture.TRILINEAR_SAMPLINGMODE);t.call(this,null,e,!o,s);this.format=f;this._texture=e.getEngine().createRawTexture(i,r,u,f,o,s,h);this.wrapU=n.Texture.CLAMP_ADDRESSMODE;this.wrapV=n.Texture.CLAMP_ADDRESSMODE}return u(i,t),i.prototype.update=function(n){this.getScene().getEngine().updateRawTexture(this._texture,n,this.format,this._invertY)},i.CreateLuminanceTexture=function(t,r,u,f,e,o,s){return void 0===e&&(e=!0),void 0===o&&(o=!1),void 0===s&&(s=n.Texture.TRILINEAR_SAMPLINGMODE),new i(t,r,u,n.Engine.TEXTUREFORMAT_LUMINANCE,f,e,o,s)},i.CreateLuminanceAlphaTexture=function(t,r,u,f,e,o,s){return void 0===e&&(e=!0),void 0===o&&(o=!1),void 0===s&&(s=n.Texture.TRILINEAR_SAMPLINGMODE),new i(t,r,u,n.Engine.TEXTUREFORMAT_LUMINANCE_ALPHA,f,e,o,s)},i.CreateAlphaTexture=function(t,r,u,f,e,o,s){return void 0===e&&(e=!0),void 0===o&&(o=!1),void 0===s&&(s=n.Texture.TRILINEAR_SAMPLINGMODE),new i(t,r,u,n.Engine.TEXTUREFORMAT_ALPHA,f,e,o,s)},i.CreateRGBTexture=function(t,r,u,f,e,o,s){return void 0===e&&(e=!0),void 0===o&&(o=!1),void 0===s&&(s=n.Texture.TRILINEAR_SAMPLINGMODE),new i(t,r,u,n.Engine.TEXTUREFORMAT_RGB,f,e,o,s)},i.CreateRGBATexture=function(t,r,u,f,e,o,s){return void 0===e&&(e=!0),void 0===o&&(o=!1),void 0===s&&(s=n.Texture.TRILINEAR_SAMPLINGMODE),new i(t,r,u,n.Engine.TEXTUREFORMAT_RGBA,f,e,o,s)},i}(n.Texture);n.RawTexture=t}(i||(i={}));!function(n){var r=function(n){function t(t,i){n.call(this,t.x,t.y);this.index=i}return u(t,n),t}(n.Vector2),t=function(){function t(){this.elements=[]}return t.prototype.add=function(n){var i=this,t=[];return n.forEach(function(n){if(0===t.length||!n.equalsWithEpsilon(t[0])){var u=new r(n,i.elements.length);t.push(u);i.elements.push(u)}}),t},t.prototype.computeBounds=function(){var t=new n.Vector2(this.elements[0].x,this.elements[0].y),i=new n.Vector2(this.elements[0].x,this.elements[0].y);return this.elements.forEach(function(n){n.x<t.x?t.x=n.x:n.x>i.x&&(i.x=n.x);n.y<t.y?t.y=n.y:n.y>i.y&&(i.y=n.y)}),{min:t,max:i,width:i.x-t.x,height:i.y-t.y}},t}(),e=function(){function t(){}return t.Rectangle=function(t,i,r,u){return[new n.Vector2(t,i),new n.Vector2(r,i),new n.Vector2(r,u),new n.Vector2(t,u)]},t.Circle=function(t,i,r,u){void 0===i&&(i=0);void 0===r&&(r=0);void 0===u&&(u=32);for(var e=[],f=0,s=2*Math.PI/u,o=0;o<u;o++)e.push(new n.Vector2(i+Math.cos(f)*t,r+Math.sin(f)*t)),f-=s;return e},t.Parse=function(t){for(var r=t.split(/[^-+eE\.\d]+/).map(parseFloat).filter(function(n){return!isNaN(n)}),u=[],i=0;i<(2147483646&r.length);i+=2)u.push(new n.Vector2(r[i],r[i+1]));return u},t.StartingAt=function(t,i){return n.Path2.StartingAt(t,i)},t}(),i;n.Polygon=e;i=function(){function i(i,r,u){this._points=new t;this._outlinepoints=new t;this._holes=[];this._epoints=[];this._eholes=[];this._name=i;this._scene=u;var f;f=r instanceof n.Path2?r.getPoints():r;this._addToepoint(f);this._points.add(f);this._outlinepoints.add(f)}return i.prototype._addToepoint=function(n){for(var r,t=0,i=n;t<i.length;t++)r=i[t],this._epoints.push(r.x,r.y)},i.prototype.addHole=function(n){this._points.add(n);var i=new t;return i.add(n),this._holes.push(i),this._eholes.push(this._epoints.length/2),this._addToepoint(n),this},i.prototype.build=function(t,i){var y=this,l,v,e;void 0===t&&(t=!1);var s=new n.Mesh(this._name,this._scene),h=[],o=[],c=[],u=this._points.computeBounds();this._points.elements.forEach(function(n){h.push(0,1,0);o.push(n.x,0,n.y);c.push((n.x-u.min.x)/u.width,(n.y-u.min.y)/u.height)});for(var r=[],a=f.earcut(this._epoints,this._eholes,2),e=0;e<a.length;e++)r.push(a[e]);if(i>0){for(l=o.length/3,this._points.elements.forEach(function(n){h.push(0,-1,0);o.push(n.x,-i,n.y);c.push(1-(n.x-u.min.x)/u.width,1-(n.y-u.min.y)/u.height)}),v=r.length,e=0;e<v;e+=3){var p=r[e+0],w=r[e+1],b=r[e+2];r.push(b+l);r.push(w+l);r.push(p+l)}this.addSide(o,h,c,r,u,this._outlinepoints,i,!1);this._holes.forEach(function(n){y.addSide(o,h,c,r,u,n,i,!0)})}return s.setVerticesData(n.VertexBuffer.PositionKind,o,t),s.setVerticesData(n.VertexBuffer.NormalKind,h,t),s.setVerticesData(n.VertexBuffer.UVKind,c,t),s.setIndices(r),s},i.prototype.addSide=function(t,i,r,u,f,e,o,s){for(var l,a,c=t.length/3,v=0,y=0;y<e.elements.length;y++){a=e.elements[y];l=y+1>e.elements.length-1?e.elements[0]:e.elements[y+1];t.push(a.x,0,a.y);t.push(a.x,-o,a.y);t.push(l.x,0,l.y);t.push(l.x,-o,l.y);var w=new n.Vector3(a.x,0,a.y),b=new n.Vector3(l.x,0,l.y),p=b.subtract(w),k=new n.Vector3(0,1,0),h=n.Vector3.Cross(p,k);h=h.normalize();r.push(v/f.width,0);r.push(v/f.width,1);v+=p.length();r.push(v/f.width,0);r.push(v/f.width,1);s?(i.push(h.x,h.y,h.z),i.push(h.x,h.y,h.z),i.push(h.x,h.y,h.z),i.push(h.x,h.y,h.z),u.push(c),u.push(c+2),u.push(c+1),u.push(c+1),u.push(c+2),u.push(c+3)):(i.push(-h.x,-h.y,-h.z),i.push(-h.x,-h.y,-h.z),i.push(-h.x,-h.y,-h.z),i.push(-h.x,-h.y,-h.z),u.push(c),u.push(c+1),u.push(c+2),u.push(c+1),u.push(c+3),u.push(c+2));c+=4}},i}();n.PolygonMeshBuilder=i}(i||(i={}));!function(n){var t=function(){function t(t,i,r){void 0===r&&(r=2);this.maxDepth=r;this.dynamicContent=[];this._maxBlockCapacity=i||64;this._selectionContent=new n.SmartArray(1024);this._creationFunc=t}return t.prototype.update=function(n,i,r){t._CreateBlocks(n,i,r,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)},t.prototype.addMesh=function(n){for(var i,t=0;t<this.blocks.length;t++)i=this.blocks[t],i.addEntry(n)},t.prototype.select=function(n,t){var i,r;for(this._selectionContent.reset(),i=0;i<this.blocks.length;i++)r=this.blocks[i],r.select(n,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},t.prototype.intersects=function(n,t,i){var r,u;for(this._selectionContent.reset(),r=0;r<this.blocks.length;r++)u=this.blocks[r],u.intersects(n,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},t.prototype.intersectsRay=function(n){var t,i;for(this._selectionContent.reset(),t=0;t<this.blocks.length;t++)i=this.blocks[t],i.intersectsRay(n,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent},t._CreateBlocks=function(t,i,r,u,f,e,o,s){var a,h,c,l;for(o.blocks=[],a=new n.Vector3((i.x-t.x)/2,(i.y-t.y)/2,(i.z-t.z)/2),h=0;h<2;h++)for(c=0;c<2;c++)for(l=0;l<2;l++){var y=t.add(a.multiplyByFloats(h,c,l)),p=t.add(a.multiplyByFloats(h+1,c+1,l+1)),v=new n.OctreeBlock(y,p,u,f+1,e,s);v.addEntries(r);o.blocks.push(v)}},t.CreationFuncForMeshes=function(n,t){!n.isBlocked&&n.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(n)},t.CreationFuncForSubMeshes=function(n,t){n.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(n)},t}();n.Octree=t}(i||(i={}));!function(n){var t=function(){function t(n,t,i,r,u,f){this.entries=[];this._boundingVectors=[];this._capacity=i;this._depth=r;this._maxDepth=u;this._creationFunc=f;this._minPoint=n;this._maxPoint=t;this._boundingVectors.push(n.clone());this._boundingVectors.push(t.clone());this._boundingVectors.push(n.clone());this._boundingVectors[2].x=t.x;this._boundingVectors.push(n.clone());this._boundingVectors[3].y=t.y;this._boundingVectors.push(n.clone());this._boundingVectors[4].z=t.z;this._boundingVectors.push(t.clone());this._boundingVectors[5].z=n.z;this._boundingVectors.push(t.clone());this._boundingVectors[6].x=n.x;this._boundingVectors.push(t.clone());this._boundingVectors[7].y=n.y}return Object.defineProperty(t.prototype,"capacity",{get:function(){return this._capacity},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"minPoint",{get:function(){return this._minPoint},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"maxPoint",{get:function(){return this._maxPoint},enumerable:!0,configurable:!0}),t.prototype.addEntry=function(n){var t,i;if(this.blocks)for(t=0;t<this.blocks.length;t++)i=this.blocks[t],i.addEntry(n);else this._creationFunc(n,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()},t.prototype.addEntries=function(n){for(var i,t=0;t<n.length;t++)i=n[t],this.addEntry(i)},t.prototype.select=function(t,i,r){var u,f;if(n.BoundingBox.IsInFrustum(this._boundingVectors,t)){if(this.blocks){for(u=0;u<this.blocks.length;u++)f=this.blocks[u],f.select(t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}},t.prototype.intersects=function(t,i,r,u){var f,e;if(n.BoundingBox.IntersectsSphere(this._minPoint,this._maxPoint,t,i)){if(this.blocks){for(f=0;f<this.blocks.length;f++)e=this.blocks[f],e.intersects(t,i,r,u);return}u?r.concat(this.entries):r.concatWithNoDuplicate(this.entries)}},t.prototype.intersectsRay=function(n,t){var i,r;if(n.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(i=0;i<this.blocks.length;i++)r=this.blocks[i],r.intersectsRay(n,t);return}t.concatWithNoDuplicate(this.entries)}},t.prototype.createInnerBlocks=function(){n.Octree._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc)},t}();n.OctreeBlock=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s,h){var c=this;void 0===o&&(o=n.Texture.BILINEAR_SAMPLINGMODE);t.call(this,i,"blur",["screenSize","direction","blurWidth"],null,f,e,o,s,h);this.direction=r;this.blurWidth=u;this.onApplyObservable.add(function(n){n.setFloat2("screenSize",c.width,c.height);n.setVector2("direction",c.direction);n.setFloat("blurWidth",c.blurWidth)})}return u(i,t),i}(n.PostProcess);n.BlurPostProcess=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s,h,c,l){var a=this;t.call(this,i,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],o,s,h,c,l);this.color=u;this.depth=f;this.colorLevel=e;this.onActivateObservable.add(function(t){a._refRexture=a._refRexture||new n.Texture(r,t.getScene())});this.onApplyObservable.add(function(n){n.setColor3("baseColor",a.color);n.setFloat("depth",a.depth);n.setFloat("colorLevel",a.colorLevel);n.setTexture("refractionSampler",a._refRexture)})}return u(i,t),i.prototype.dispose=function(n){this._refRexture&&this._refRexture.dispose();t.prototype.dispose.call(this,n)},i}(n.PostProcess);n.RefractionPostProcess=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r,u,f,e){n.call(this,t,"blackAndWhite",null,null,i,r,u,f,e)}return u(t,n),t}(n.PostProcess);n.BlackAndWhitePostProcess=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r,u,f,e,o){var s=this;n.call(this,t,"convolution",["kernel","screenSize"],null,r,u,f,e,o);this.kernel=i;this.onApply=function(n){n.setFloat2("screenSize",s.width,s.height);n.setArray("kernel",s.kernel)}}return u(t,n),t.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],t.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],t.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],t.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],t.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],t.GaussianKernel=[0,1,0,1,1,1,0,1,0],t}(n.PostProcess);n.ConvolutionPostProcess=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r,u,f,e,o){var s=this;n.call(this,t,"filter",["kernelMatrix"],null,r,u,f,e,o);this.kernelMatrix=i;this.onApply=function(n){n.setMatrix("kernelMatrix",s.kernelMatrix)}}return u(t,n),t}(n.PostProcess);n.FilterPostProcess=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r,u,f,e){var o=this;n.call(this,t,"fxaa",["texelSize"],null,i,r,u,f,e);this.onSizeChangedObservable.add(function(){o.texelWidth=1/o.width;o.texelHeight=1/o.height});this.onApplyObservable.add(function(n){n.setFloat2("texelSize",o.texelWidth,o.texelHeight)})}return u(t,n),t}(n.PostProcess);n.FxaaPostProcess=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o){var s=this;t.call(this,i,"stereoscopicInterlace",["stepSize"],["camASampler"],1,r[1],f,e,o,u?"#define IS_STEREOSCOPIC_HORIZ 1":void 0);this._passedProcess=r[0]._rigPostProcess;this._stepSize=new n.Vector2(1/this.width,1/this.height);this.onSizeChangedObservable.add(function(){s._stepSize=new n.Vector2(1/s.width,1/s.height)});this.onApplyObservable.add(function(n){n.setTextureFromPostProcess("camASampler",s._passedProcess);n.setFloat2("stepSize",s._stepSize.x,s._stepSize.y)})}return u(i,t),i}(n.PostProcess);n.StereoscopicInterlacePostProcess=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u,f){this.size=t;this.position=i;this.alphaMode=n.Engine.ALPHA_ONEONE;this.dispose=function(){this.texture&&this.texture.dispose();var n=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(n,1)};this.color=r||new n.Color3(1,1,1);this.texture=u?new n.Texture(u,f.getScene(),!0):null;this._system=f;f.lensFlares.push(this)}return t}();n.LensFlare=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r){var e,f,u;this.name=t;this.lensFlares=[];this.borderLimit=300;this.viewportBorder=0;this.layerMask=268435455;this._vertexBuffers={};this._isEnabled=!0;this._scene=r;this._emitter=i;this.id=t;r.lensFlareSystems.push(this);this.meshesSelectionPredicate=function(n){return n.material&&n.isVisible&&n.isEnabled()&&n.isBlocker&&0!=(n.layerMask&r.activeCamera.layerMask)};e=r.getEngine();f=[];f.push(1,1);f.push(-1,1);f.push(-1,-1);f.push(1,-1);this._vertexBuffers[n.VertexBuffer.PositionKind]=new n.VertexBuffer(e,f,n.VertexBuffer.PositionKind,!1,!1,2);u=[];u.push(0);u.push(1);u.push(2);u.push(0);u.push(2);u.push(3);this._indexBuffer=e.createIndexBuffer(u);this._effect=e.createEffect("lensFlare",[n.VertexBuffer.PositionKind],["color","viewportMatrix"],["textureSampler"],"")}return Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(n){this._isEnabled=n},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getEmitter=function(){return this._emitter},t.prototype.setEmitter=function(n){this._emitter=n},t.prototype.getEmitterPosition=function(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position},t.prototype.computeEffectivePosition=function(t){var i=this.getEmitterPosition();return i=n.Vector3.Project(i,n.Matrix.Identity(),this._scene.getTransformMatrix(),t),this._positionX=i.x,this._positionY=i.y,i=n.Vector3.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(t.x-=this.viewportBorder,t.y-=this.viewportBorder,t.width+=2*this.viewportBorder,t.height+=2*this.viewportBorder,i.x+=this.viewportBorder,i.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder),i.z>0&&(this._positionX>t.x&&this._positionX<t.x+t.width&&this._positionY>t.y&&this._positionY<t.y+t.height,!0)},t.prototype._isVisible=function(){var r,i;if(!this._isEnabled)return!1;var u=this.getEmitterPosition(),t=u.subtract(this._scene.activeCamera.globalPosition),f=t.length();return t.normalize(),r=new n.Ray(this._scene.activeCamera.globalPosition,t),i=this._scene.pickWithRay(r,this.meshesSelectionPredicate,!0),!i.hit||i.distance>f},t.prototype.render=function(){var o,s,f,u,e,r;if(!this._effect.isReady())return!1;var i=this._scene.getEngine(),l=this._scene.activeCamera.viewport,t=l.toGlobal(i.getRenderWidth(!0),i.getRenderHeight(!0));if(!this.computeEffectivePosition(t)||!this._isVisible()||(o=this._positionX<this.borderLimit+t.x?this.borderLimit+t.x-this._positionX:this._positionX>t.x+t.width-this.borderLimit?this._positionX-t.x-t.width+this.borderLimit:0,s=this._positionY<this.borderLimit+t.y?this.borderLimit+t.y-this._positionY:this._positionY>t.y+t.height-this.borderLimit?this._positionY-t.y-t.height+this.borderLimit:0,f=o>s?o:s,f-=this.viewportBorder,f>this.borderLimit&&(f=this.borderLimit),u=1-f/this.borderLimit,u<0))return!1;u>1&&(u=1);this.viewportBorder>0&&(t.x+=this.viewportBorder,t.y+=this.viewportBorder,t.width-=2*this.viewportBorder,t.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);var h=t.x+t.width/2,c=t.y+t.height/2,a=h-this._positionX,v=c-this._positionY;for(i.enableEffect(this._effect),i.setState(!1),i.setDepthBuffer(!1),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._effect),e=0;e<this.lensFlares.length;e++){r=this.lensFlares[e];i.setAlphaMode(r.alphaMode);var y=h-a*r.position,p=c-v*r.position,w=r.size,b=r.size*i.getAspectRatio(this._scene.activeCamera,!0),k=2*(y/(t.width+2*t.x))-1,d=1-2*(p/(t.height+2*t.y)),g=n.Matrix.FromValues(w/2,0,0,0,0,b/2,0,0,0,0,1,0,k,d,0,1);this._effect.setMatrix("viewportMatrix",g);this._effect.setTexture("textureSampler",r.texture);this._effect.setFloat4("color",r.color.r*u,r.color.g*u,r.color.b*u,1);i.draw(!0,0,6)}return i.setDepthBuffer(!0),i.setAlphaMode(n.Engine.ALPHA_DISABLE),!0},t.prototype.dispose=function(){var t=this._vertexBuffers[n.VertexBuffer.PositionKind],i;for(t&&(t.dispose(),this._vertexBuffers[n.VertexBuffer.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();i=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(i,1)},t.Parse=function(i,r,u){var h=r.getLastEntryByID(i.emitterId),s=i.name||"lensFlareSystem#"+i.emitterId,e=new t(s,h,r),o,f;for(e.id=i.id||s,e.borderLimit=i.borderLimit,o=0;o<i.flares.length;o++)f=i.flares[o],new n.LensFlare(f.size,f.position,n.Color3.FromArray(f.color),u+f.textureName,e);return e},t.prototype.serialize=function(){var t={},r,i;for(t.id=this.id,t.name=this.name,t.emitterId=this.getEmitter().id,t.borderLimit=this.borderLimit,t.flares=[],r=0;r<this.lensFlares.length;r++)i=this.lensFlares[r],t.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:n.Tools.GetFilename(i.texture.name)});return t},t}();n.LensFlareSystem=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u){t.call(this,i,r,u);this._quaternionCache=new n.Quaternion;this.inputs.addDeviceOrientation()}return u(i,t),i.prototype.getTypeName=function(){return"DeviceOrientationCamera"},i.prototype._checkInputs=function(){t.prototype._checkInputs.call(this);this._quaternionCache.copyFrom(this.rotationQuaternion);this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)},i.prototype.resetToCurrentRotation=function(t){var i=this;void 0===t&&(t=n.Axis.Y);this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new n.Quaternion),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(function(n){t[n]?i._initialQuaternion[n]*=-1:i._initialQuaternion[n]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))},i}(n.FreeCamera);n.DeviceOrientationCamera=t}(i||(i={}));!function(n){var i=function(t){function i(i,r,u,f,e){void 0===f&&(f=!0);void 0===e&&(e=n.VRCameraMetrics.GetDefault());t.call(this,i,r,u);e.compensateDistortion=f;this.setCameraRigMode(n.Camera.RIG_MODE_VR,{vrCameraMetrics:e})}return u(i,t),i.prototype.getTypeName=function(){return"VRDeviceOrientationFreeCamera"},i}(n.DeviceOrientationCamera),t;n.VRDeviceOrientationFreeCamera=i;t=function(t){function i(i,r,u,f,e,o,s,h){void 0===s&&(s=!0);void 0===h&&(h=n.VRCameraMetrics.GetDefault());t.call(this,i,r,u,f,e,o);h.compensateDistortion=s;this.setCameraRigMode(n.Camera.RIG_MODE_VR,{vrCameraMetrics:h});this.inputs.addVRDeviceOrientation()}return u(i,t),i.prototype.getTypeName=function(){return"VRDeviceOrientationArcRotateCamera"},i}(n.ArcRotateCamera);n.VRDeviceOrientationArcRotateCamera=t}(i||(i={}));!function(n){var t=function(n){function t(t,i,r){n.call(this,t,i,r);this.inputs.addGamepad()}return u(t,n),Object.defineProperty(t.prototype,"gamepadAngularSensibility",{get:function(){var n=this.inputs.attached.gamepad;if(n)return n.gamepadAngularSensibility},set:function(n){var t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=n)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gamepadMoveSensibility",{get:function(){var n=this.inputs.attached.gamepad;if(n)return n.gamepadMoveSensibility},set:function(n){var t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=n)},enumerable:!0,configurable:!0}),t.prototype.getTypeName=function(){return"UniversalCamera"},t}(n.TouchCamera);n.UniversalCamera=t}(i||(i={}));!function(n){var s=function(){function n(n){var t=this;this.babylonGamepads=[];this.oneGamepadConnected=!1;this.isMonitoring=!1;this.gamepadEventSupported="GamepadEvent"in window;this.gamepadSupportAvailable=navigator.getGamepads||!!navigator.webkitGetGamepads||!!navigator.msGetGamepads||!!navigator.webkitGamepads;this._callbackGamepadConnected=n;this.gamepadSupportAvailable&&(this.gamepadEventSupported?(this._onGamepadConnectedEvent=function(n){t._onGamepadConnected(n)},this._onGamepadDisonnectedEvent=function(n){t._onGamepadDisconnected(n)},window.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),window.addEventListener("gamepaddisconnected",this._onGamepadDisonnectedEvent,!1)):this._startMonitoringGamepads())}return n.prototype.dispose=function(){n.gamepadDOMInfo&&document.body.removeChild(n.gamepadDOMInfo);this._onGamepadConnectedEvent&&(window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),window.removeEventListener("gamepaddisconnected",this._onGamepadDisonnectedEvent,!1),this._onGamepadConnectedEvent=null,this._onGamepadDisonnectedEvent=null)},n.prototype._onGamepadConnected=function(n){var t=this._addNewGamepad(n.gamepad);this._callbackGamepadConnected&&this._callbackGamepadConnected(t);this._startMonitoringGamepads()},n.prototype._addNewGamepad=function(t){this.oneGamepadConnected||(this.oneGamepadConnected=!0,n.gamepadDOMInfo&&(document.body.removeChild(n.gamepadDOMInfo),n.gamepadDOMInfo=null));var i,r=t.id.search("Xbox One")!==-1;return i=r||t.id.search("Xbox 360")!==-1||t.id.search("xinput")!==-1?new e(t.id,t.index,t,r):new f(t.id,t.index,t),this.babylonGamepads.push(i),i},n.prototype._onGamepadDisconnected=function(n){for(var t in this.babylonGamepads)if(this.babylonGamepads[t].index==n.gamepad.index){this.babylonGamepads.splice(+t,1);break}0==this.babylonGamepads.length&&this._stopMonitoringGamepads()},n.prototype._startMonitoringGamepads=function(){this.isMonitoring||(this.isMonitoring=!0,this._checkGamepadsStatus())},n.prototype._stopMonitoringGamepads=function(){this.isMonitoring=!1},n.prototype._checkGamepadsStatus=function(){var n=this,t;this._updateGamepadObjects();for(t in this.babylonGamepads)this.babylonGamepads[t].update();this.isMonitoring&&(window.requestAnimationFrame?window.requestAnimationFrame(function(){n._checkGamepadsStatus()}):window.mozRequestAnimationFrame?window.mozRequestAnimationFrame(function(){n._checkGamepadsStatus()}):window.webkitRequestAnimationFrame&&window.webkitRequestAnimationFrame(function(){n._checkGamepadsStatus()}))},n.prototype._updateGamepadObjects=function(){for(var i,t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[],n=0;n<t.length;n++)t[n]&&(t[n].index in this.babylonGamepads?this.babylonGamepads[n].browserGamepad=t[n]:(i=this._addNewGamepad(t[n]),this._callbackGamepadConnected&&this._callbackGamepadConnected(i)))},n}(),o,r,f,t,i,e;n.Gamepads=s;o=function(){function n(n,t){this.x=n;this.y=t}return n}();n.StickValues=o;r=function(){function n(n,t,i,r,u,f,e){void 0===r&&(r=0);void 0===u&&(u=1);void 0===f&&(f=2);void 0===e&&(e=3);this.id=n;this.index=t;this.browserGamepad=i;this._leftStickAxisX=r;this._leftStickAxisY=u;this._rightStickAxisX=f;this._rightStickAxisY=e;this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]});this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}return n.prototype.onleftstickchanged=function(n){this._onleftstickchanged=n},n.prototype.onrightstickchanged=function(n){this._onrightstickchanged=n},Object.defineProperty(n.prototype,"leftStick",{get:function(){return this._leftStick},set:function(n){this._onleftstickchanged&&(this._leftStick.x!==n.x||this._leftStick.y!==n.y)&&this._onleftstickchanged(n);this._leftStick=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rightStick",{get:function(){return this._rightStick},set:function(n){this._onrightstickchanged&&(this._rightStick.x!==n.x||this._rightStick.y!==n.y)&&this._onrightstickchanged(n);this._rightStick=n},enumerable:!0,configurable:!0}),n.prototype.update=function(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]});this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})},n}();n.Gamepad=r;f=function(n){function t(t,i,r){n.call(this,t,i,r);this.id=t;this.index=i;this.gamepad=r;this._buttons=new Array(r.buttons.length)}return u(t,n),t.prototype.onbuttondown=function(n){this._onbuttondown=n},t.prototype.onbuttonup=function(n){this._onbuttonup=n},t.prototype._setButtonValue=function(n,t,i){return n!==t&&(this._onbuttondown&&1===n&&this._onbuttondown(i),this._onbuttonup&&0===n&&this._onbuttonup(i)),n},t.prototype.update=function(){n.prototype.update.call(this);for(var t=0;t<this._buttons.length;t++)this._buttons[t]=this._setButtonValue(this.gamepad.buttons[t].value,this._buttons[t],t)},t}(r);n.GenericPad=f,function(n){n[n.A=0]="A";n[n.B=1]="B";n[n.X=2]="X";n[n.Y=3]="Y";n[n.Start=4]="Start";n[n.Back=5]="Back";n[n.LB=6]="LB";n[n.RB=7]="RB";n[n.LeftStick=8]="LeftStick";n[n.RightStick=9]="RightStick"}(n.Xbox360Button||(n.Xbox360Button={}));t=n.Xbox360Button;!function(n){n[n.Up=0]="Up";n[n.Down=1]="Down";n[n.Left=2]="Left";n[n.Right=3]="Right"}(n.Xbox360Dpad||(n.Xbox360Dpad={}));i=n.Xbox360Dpad;e=function(n){function r(t,i,r,u){void 0===u&&(u=!1);n.call(this,t,i,r,0,1,u?3:2,u?4:3);this._leftTrigger=0;this._rightTrigger=0;this._buttonA=0;this._buttonB=0;this._buttonX=0;this._buttonY=0;this._buttonBack=0;this._buttonStart=0;this._buttonLB=0;this._buttonRB=0;this._buttonLeftStick=0;this._buttonRightStick=0;this._dPadUp=0;this._dPadDown=0;this._dPadLeft=0;this._dPadRight=0;this._isXboxOnePad=!1;this._isXboxOnePad=u}return u(r,n),r.prototype.onlefttriggerchanged=function(n){this._onlefttriggerchanged=n},r.prototype.onrighttriggerchanged=function(n){this._onrighttriggerchanged=n},Object.defineProperty(r.prototype,"leftTrigger",{get:function(){return this._leftTrigger},set:function(n){this._onlefttriggerchanged&&this._leftTrigger!==n&&this._onlefttriggerchanged(n);this._leftTrigger=n},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rightTrigger",{get:function(){return this._rightTrigger},set:function(n){this._onrighttriggerchanged&&this._rightTrigger!==n&&this._onrighttriggerchanged(n);this._rightTrigger=n},enumerable:!0,configurable:!0}),r.prototype.onbuttondown=function(n){this._onbuttondown=n},r.prototype.onbuttonup=function(n){this._onbuttonup=n},r.prototype.ondpaddown=function(n){this._ondpaddown=n},r.prototype.ondpadup=function(n){this._ondpadup=n},r.prototype._setButtonValue=function(n,t,i){return n!==t&&(this._onbuttondown&&1===n&&this._onbuttondown(i),this._onbuttonup&&0===n&&this._onbuttonup(i)),n},r.prototype._setDPadValue=function(n,t,i){return n!==t&&(this._ondpaddown&&1===n&&this._ondpaddown(i),this._ondpadup&&0===n&&this._ondpadup(i)),n},Object.defineProperty(r.prototype,"buttonA",{get:function(){return this._buttonA},set:function(n){this._buttonA=this._setButtonValue(n,this._buttonA,t.A)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonB",{get:function(){return this._buttonB},set:function(n){this._buttonB=this._setButtonValue(n,this._buttonB,t.B)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonX",{get:function(){return this._buttonX},set:function(n){this._buttonX=this._setButtonValue(n,this._buttonX,t.X)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonY",{get:function(){return this._buttonY},set:function(n){this._buttonY=this._setButtonValue(n,this._buttonY,t.Y)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonStart",{get:function(){return this._buttonStart},set:function(n){this._buttonStart=this._setButtonValue(n,this._buttonStart,t.Start)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonBack",{get:function(){return this._buttonBack},set:function(n){this._buttonBack=this._setButtonValue(n,this._buttonBack,t.Back)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonLB",{get:function(){return this._buttonLB},set:function(n){this._buttonLB=this._setButtonValue(n,this._buttonLB,t.LB)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonRB",{get:function(){return this._buttonRB},set:function(n){this._buttonRB=this._setButtonValue(n,this._buttonRB,t.RB)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonLeftStick",{get:function(){return this._buttonLeftStick},set:function(n){this._buttonLeftStick=this._setButtonValue(n,this._buttonLeftStick,t.LeftStick)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"buttonRightStick",{get:function(){return this._buttonRightStick},set:function(n){this._buttonRightStick=this._setButtonValue(n,this._buttonRightStick,t.RightStick)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"dPadUp",{get:function(){return this._dPadUp},set:function(n){this._dPadUp=this._setDPadValue(n,this._dPadUp,i.Up)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"dPadDown",{get:function(){return this._dPadDown},set:function(n){this._dPadDown=this._setDPadValue(n,this._dPadDown,i.Down)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"dPadLeft",{get:function(){return this._dPadLeft},set:function(n){this._dPadLeft=this._setDPadValue(n,this._dPadLeft,i.Left)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"dPadRight",{get:function(){return this._dPadRight},set:function(n){this._dPadRight=this._setDPadValue(n,this._dPadRight,i.Right)},enumerable:!0,configurable:!0}),r.prototype.update=function(){n.prototype.update.call(this);this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.axes[2],this.rightTrigger=this.browserGamepad.axes[5],this.buttonBack=this.browserGamepad.buttons[9].value,this.buttonStart=this.browserGamepad.buttons[8].value,this.buttonLeftStick=this.browserGamepad.buttons[6].value,this.buttonRightStick=this.browserGamepad.buttons[7].value,this.dPadUp=this.browserGamepad.buttons[11].value,this.dPadDown=this.browserGamepad.buttons[12].value,this.dPadLeft=this.browserGamepad.buttons[13].value,this.dPadRight=this.browserGamepad.buttons[14].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)},r}(r);n.Xbox360Pad=e}(i||(i={}));!function(n){var t=function(t){function i(i,r,u){n.Tools.Warn("Deprecated. Please use Universal Camera instead.");t.call(this,i,r,u)}return u(i,t),Object.defineProperty(i.prototype,"gamepadAngularSensibility",{get:function(){var n=this.inputs.attached.gamepad;if(n)return n.gamepadAngularSensibility},set:function(n){var t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=n)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"gamepadMoveSensibility",{get:function(){var n=this.inputs.attached.gamepad;if(n)return n.gamepadMoveSensibility},set:function(n){var t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=n)},enumerable:!0,configurable:!0}),i.prototype.getTypeName=function(){return"GamepadCamera"},i}(n.UniversalCamera);n.GamepadCamera=t}(i||(i={}));!function(n){var t=function(){function t(t){this.SMOOTHING=.75;this.FFT_SIZE=512;this.BARGRAPHAMPLITUDE=256;this.DEBUGCANVASPOS={x:20,y:20};this.DEBUGCANVASSIZE={width:320,height:200};this._scene=t;this._audioEngine=n.Engine.audioEngine;this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser=this._audioEngine.audioContext.createAnalyser(),this._webAudioAnalyser.minDecibels=-140,this._webAudioAnalyser.maxDecibels=0,this._byteFreqs=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._byteTime=new Uint8Array(this._webAudioAnalyser.frequencyBinCount),this._floatFreqs=new Float32Array(this._webAudioAnalyser.frequencyBinCount))}return t.prototype.getFrequencyBinCount=function(){return this._audioEngine.canUseWebAudio?this._webAudioAnalyser.frequencyBinCount:0},t.prototype.getByteFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteFrequencyData(this._byteFreqs)),this._byteFreqs},t.prototype.getByteTimeDomainData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getByteTimeDomainData(this._byteTime)),this._byteTime},t.prototype.getFloatFrequencyData=function(){return this._audioEngine.canUseWebAudio&&(this._webAudioAnalyser.smoothingTimeConstant=this.SMOOTHING,this._webAudioAnalyser.fftSize=this.FFT_SIZE,this._webAudioAnalyser.getFloatFrequencyData(this._floatFreqs)),this._floatFreqs},t.prototype.drawDebugCanvas=function(){var u=this,t,n;if(this._audioEngine.canUseWebAudio&&(this._debugCanvas||(this._debugCanvas=document.createElement("canvas"),this._debugCanvas.width=this.DEBUGCANVASSIZE.width,this._debugCanvas.height=this.DEBUGCANVASSIZE.height,this._debugCanvas.style.position="absolute",this._debugCanvas.style.top=this.DEBUGCANVASPOS.y+"px",this._debugCanvas.style.left=this.DEBUGCANVASPOS.x+"px",this._debugCanvasContext=this._debugCanvas.getContext("2d"),document.body.appendChild(this._debugCanvas),this._registerFunc=function(){u.drawDebugCanvas()},this._scene.registerBeforeRender(this._registerFunc)),this._registerFunc))for(t=this.getByteFrequencyData(),this._debugCanvasContext.fillStyle="rgb(0, 0, 0)",this._debugCanvasContext.fillRect(0,0,this.DEBUGCANVASSIZE.width,this.DEBUGCANVASSIZE.height),n=0;n<this.getFrequencyBinCount();n++){var f=t[n],e=f/this.BARGRAPHAMPLITUDE,i=this.DEBUGCANVASSIZE.height*e,o=this.DEBUGCANVASSIZE.height-i-1,r=this.DEBUGCANVASSIZE.width/this.getFrequencyBinCount(),s=n/this.getFrequencyBinCount()*360;this._debugCanvasContext.fillStyle="hsl("+s+", 100%, 50%)";this._debugCanvasContext.fillRect(n*r,o,r,i)}},t.prototype.stopDebugCanvas=function(){this._debugCanvas&&(this._scene.unregisterBeforeRender(this._registerFunc),this._registerFunc=null,document.body.removeChild(this._debugCanvas),this._debugCanvas=null,this._debugCanvasContext=null)},t.prototype.connectAudioNodes=function(n,t){this._audioEngine.canUseWebAudio&&(n.connect(this._webAudioAnalyser),this._webAudioAnalyser.connect(t))},t.prototype.dispose=function(){this._audioEngine.canUseWebAudio&&this._webAudioAnalyser.disconnect()},t}();n.Analyser=t}(i||(i={}));!function(n){var t=function(){function t(t,i){var r=this,u,f;void 0===i&&(i=n.Engine.TEXTURETYPE_FLOAT);this._viewMatrix=n.Matrix.Zero();this._projectionMatrix=n.Matrix.Zero();this._transformMatrix=n.Matrix.Zero();this._worldViewProjection=n.Matrix.Zero();this._scene=t;u=t.getEngine();this._depthMap=new n.RenderTargetTexture("depthMap",{width:u.getRenderWidth(),height:u.getRenderHeight()},this._scene,!1,!0,i);this._depthMap.wrapU=n.Texture.CLAMP_ADDRESSMODE;this._depthMap.wrapV=n.Texture.CLAMP_ADDRESSMODE;this._depthMap.refreshRate=1;this._depthMap.renderParticles=!1;this._depthMap.renderList=null;this._depthMap.onClearObservable.add(function(t){t.clear(new n.Color4(1,1,1,1),!0,!0,!0)});f=function(t){var i=t.getRenderingMesh(),e=r._scene,o=e.getEngine(),u,s,f,h;o.setState(t.getMaterial().backFaceCulling);u=i._getInstancesRenderList(t._id);u.mustReturn||(s=null!==o.getCaps().instancedArrays&&null!==u.visibleInstances[t._id],r.isReady(t,s)&&(o.enableEffect(r._effect),i._bind(t,r._effect,n.Material.TriangleFillMode),f=t.getMaterial(),(r._effect.setMatrix("viewProjection",e.getTransformMatrix()),r._effect.setFloat("far",e.activeCamera.maxZ),f&&f.needAlphaTesting())&&(h=f.getAlphaTestTexture(),r._effect.setTexture("diffuseSampler",h),r._effect.setMatrix("diffuseMatrix",h.getTextureMatrix())),i.useBones&&i.computeBonesUsingShaders&&r._effect.setMatrices("mBones",i.skeleton.getTransformMatrices(i)),i._processRendering(t,r._effect,n.Material.TriangleFillMode,u,s,function(n,t){return r._effect.setMatrix("world",t)})))};this._depthMap.customRenderFunction=function(n,t){for(var i=0;i<n.length;i++)f(n.data[i]);for(i=0;i<t.length;i++)f(t.data[i])}}return t.prototype.isReady=function(t,i){var o=t.getMaterial(),e;if(o.disableDepthWrite)return!1;var u=[],r=[n.VertexBuffer.PositionKind],f=t.getMesh();return f.getScene(),o&&o.needAlphaTesting()&&(u.push("#define ALPHATEST"),f.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(r.push(n.VertexBuffer.UVKind),u.push("#define UV1")),f.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&(r.push(n.VertexBuffer.UV2Kind),u.push("#define UV2"))),f.useBones&&f.computeBonesUsingShaders?(r.push(n.VertexBuffer.MatricesIndicesKind),r.push(n.VertexBuffer.MatricesWeightsKind),f.numBoneInfluencers>4&&(r.push(n.VertexBuffer.MatricesIndicesExtraKind),r.push(n.VertexBuffer.MatricesWeightsExtraKind)),u.push("#define NUM_BONE_INFLUENCERS "+f.numBoneInfluencers),u.push("#define BonesPerMesh "+(f.skeleton.bones.length+1))):u.push("#define NUM_BONE_INFLUENCERS 0"),i&&(u.push("#define INSTANCES"),r.push("world0"),r.push("world1"),r.push("world2"),r.push("world3")),e=u.join("\n"),this._cachedDefines!==e&&(this._cachedDefines=e,this._effect=this._scene.getEngine().createEffect("depth",r,["world","mBones","viewProjection","diffuseMatrix","far"],["diffuseSampler"],e)),this._effect.isReady()},t.prototype.getDepthMap=function(){return this._depthMap},t.prototype.dispose=function(){this._depthMap.dispose()},t}();n.DepthRenderer=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f){var e=this,o,s;t.call(this,r.getEngine(),i);this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect";this.SSAORenderEffect="SSAORenderEffect";this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect";this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect";this.SSAOCombineRenderEffect="SSAOCombineRenderEffect";this.totalStrength=1;this.radius=.0001;this.area=.0075;this.fallOff=1e-6;this.base=.5;this._firstUpdate=!0;this._scene=r;this._createRandomTexture();this._depthTexture=r.enableDepthRenderer().getDepthMap();o=u.ssaoRatio||u;s=u.combineRatio||u;this._ratio={ssaoRatio:o,combineRatio:s};this._originalColorPostProcess=new n.PassPostProcess("SSAOOriginalSceneColor",s,null,n.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),!1);this._createSSAOPostProcess(o);this._createBlurPostProcess(o);this._createSSAOCombinePostProcess(s);this.addEffect(new n.PostProcessRenderEffect(r.getEngine(),this.SSAOOriginalSceneColorEffect,function(){return e._originalColorPostProcess},!0));this.addEffect(new n.PostProcessRenderEffect(r.getEngine(),this.SSAORenderEffect,function(){return e._ssaoPostProcess},!0));this.addEffect(new n.PostProcessRenderEffect(r.getEngine(),this.SSAOBlurHRenderEffect,function(){return e._blurHPostProcess},!0));this.addEffect(new n.PostProcessRenderEffect(r.getEngine(),this.SSAOBlurVRenderEffect,function(){return e._blurVPostProcess},!0));this.addEffect(new n.PostProcessRenderEffect(r.getEngine(),this.SSAOCombineRenderEffect,function(){return e._ssaoCombinePostProcess},!0));r.postProcessRenderPipelineManager.addPipeline(this);f&&r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,f)}return u(i,t),i.prototype.getBlurHPostProcess=function(){return n.Tools.Error("SSAORenderinPipeline.getBlurHPostProcess() is deprecated, no more blur post-process exists"),null},i.prototype.getBlurVPostProcess=function(){return n.Tools.Error("SSAORenderinPipeline.getBlurVPostProcess() is deprecated, no more blur post-process exists"),null},i.prototype.dispose=function(n){var i,t;for(void 0===n&&(n=!1),i=0;i<this._scene.cameras.length;i++)t=this._scene.cameras[i],this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t);this._randomTexture.dispose();n&&this._scene.disableDepthRenderer();this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras)},i.prototype._createBlurPostProcess=function(t){for(var i=this,r=[],u=-8;u<8;u++)r.push(2*u);this._blurHPostProcess=new n.PostProcess("BlurH","ssao",["outSize","samplerOffsets"],["depthSampler"],t,null,n.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define BILATERAL_BLUR_H\n#define SAMPLES 16");this._blurHPostProcess.onApply=function(n){n.setFloat("outSize",i._ssaoCombinePostProcess.width);n.setTexture("depthSampler",i._depthTexture);i._firstUpdate&&n.setArray("samplerOffsets",r)};this._blurVPostProcess=new n.PostProcess("BlurV","ssao",["outSize","samplerOffsets"],["depthSampler"],t,null,n.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define BILATERAL_BLUR\n#define SAMPLES 16");this._blurVPostProcess.onApply=function(n){n.setFloat("outSize",i._ssaoCombinePostProcess.height);n.setTexture("depthSampler",i._depthTexture);i._firstUpdate&&(n.setArray("samplerOffsets",r),i._firstUpdate=!1)}},i.prototype._createSSAOPostProcess=function(t){var i=this,r=16,u=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],f=1/r;this._ssaoPostProcess=new n.PostProcess("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],t,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES "+r+"\n#define SSAO");new n.Vector2(0,0);this._ssaoPostProcess.onApply=function(n){i._firstUpdate&&(n.setArray3("sampleSphere",u),n.setFloat("samplesFactor",f),n.setFloat("randTextureTiles",4));n.setFloat("totalStrength",i.totalStrength);n.setFloat("radius",i.radius);n.setFloat("area",i.area);n.setFloat("fallOff",i.fallOff);n.setFloat("base",i.base);n.setTexture("textureSampler",i._depthTexture);n.setTexture("randomSampler",i._randomTexture)}},i.prototype._createSSAOCombinePostProcess=function(t){var i=this;this._ssaoCombinePostProcess=new n.PostProcess("ssaoCombine","ssaoCombine",[],["originalColor"],t,null,n.Texture.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1);this._ssaoCombinePostProcess.onApply=function(n){n.setTextureFromPostProcess("originalColor",i._originalColorPostProcess)}},i.prototype._createRandomTexture=function(){var r=512,i;this._randomTexture=new n.DynamicTexture("SSAORandomTexture",r,this._scene,!1,n.Texture.TRILINEAR_SAMPLINGMODE);this._randomTexture.wrapU=n.Texture.WRAP_ADDRESSMODE;this._randomTexture.wrapV=n.Texture.WRAP_ADDRESSMODE;for(var e=this._randomTexture.getContext(),u=function(n,t){return Math.random()*(t-n)+n},t=n.Vector3.Zero(),f=0;f<r;f++)for(i=0;i<r;i++)t.x=Math.floor(255*u(-1,1)),t.y=Math.floor(255*u(-1,1)),t.z=Math.floor(255*u(-1,1)),e.fillStyle="rgb("+t.x+", "+t.y+", "+t.z+")",e.fillRect(f,i,1,1);this._randomTexture.update(!1)},r([n.serialize()],i.prototype,"totalStrength",void 0),r([n.serialize()],i.prototype,"radius",void 0),r([n.serialize()],i.prototype,"area",void 0),r([n.serialize()],i.prototype,"fallOff",void 0),r([n.serialize()],i.prototype,"base",void 0),r([n.serialize()],i.prototype,"_ratio",void 0),i}(n.PostProcessRenderPipeline);n.SSAORenderingPipeline=t}(i||(i={}));!function(n){var t=function(t){function i(r,u,f,e,o,s,h,c,l){var a=this,h;void 0===o&&(o=100);void 0===s&&(s=n.Texture.BILINEAR_SAMPLINGMODE);t.call(this,r,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],u.postProcessRatio||u,f,s,h,c,"#define NUM_SAMPLES "+o);this._screenCoordinates=n.Vector2.Zero();this.customMeshPosition=n.Vector3.Zero();this.useCustomMeshPosition=!1;this.invert=!0;this.excludedMeshes=[];this.exposure=.3;this.decay=.96815;this.weight=.58767;this.density=.926;l=null===f?l:f.getScene();h=l.getEngine();this._viewPort=new n.Viewport(0,0,1,1).toGlobal(h.getRenderWidth(),h.getRenderHeight());this.mesh=null!==e?e:i.CreateDefaultMesh("VolumetricLightScatteringMesh",l);this._createPass(l,u.passRatio||u);this.onActivate=function(n){a.isSupported||a.dispose(n);a.onActivate=null};this.onApplyObservable.add(function(n){a._updateMeshScreenCoordinates(l);n.setTexture("lightScatteringSampler",a._volumetricLightScatteringRTT);n.setFloat("exposure",a.exposure);n.setFloat("decay",a.decay);n.setFloat("weight",a.weight);n.setFloat("density",a.density);n.setVector2("meshPositionOnScreen",a._screenCoordinates)})}return u(i,t),Object.defineProperty(i.prototype,"useDiffuseColor",{get:function(){return n.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1},set:function(){n.Tools.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")},enumerable:!0,configurable:!0}),i.prototype.isReady=function(t,i){var r=t.getMesh(),e;if(r===this.mesh)return r.material.isReady(r);var f=[],u=[n.VertexBuffer.PositionKind],o=t.getMaterial();return o&&(o.needAlphaTesting()&&f.push("#define ALPHATEST"),r.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(u.push(n.VertexBuffer.UVKind),f.push("#define UV1")),r.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&(u.push(n.VertexBuffer.UV2Kind),f.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders?(u.push(n.VertexBuffer.MatricesIndicesKind),u.push(n.VertexBuffer.MatricesWeightsKind),f.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),f.push("#define BonesPerMesh "+(r.skeleton.bones.length+1))):f.push("#define NUM_BONE_INFLUENCERS 0"),i&&(f.push("#define INSTANCES"),u.push("world0"),u.push("world1"),u.push("world2"),u.push("world3")),e=f.join("\n"),this._cachedDefines!==e&&(this._cachedDefines=e,this._volumetricLightScatteringPass=r.getScene().getEngine().createEffect({vertexElement:"depth",fragmentElement:"volumetricLightScatteringPass"},u,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],e)),this._volumetricLightScatteringPass.isReady()},i.prototype.setCustomMeshPosition=function(n){this.customMeshPosition=n},i.prototype.getCustomMeshPosition=function(){return this.customMeshPosition},i.prototype.dispose=function(n){var i=n.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);i!==-1&&n.getScene().customRenderTargets.splice(i,1);this._volumetricLightScatteringRTT.dispose();t.prototype.dispose.call(this,n)},i.prototype.getPass=function(){return this._volumetricLightScatteringRTT},i.prototype._meshExcluded=function(n){return this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(n)!==-1},i.prototype._createPass=function(t,i){var r=this,f=t.getEngine(),e,u,o;this._volumetricLightScatteringRTT=new n.RenderTargetTexture("volumetricLightScatteringMap",{width:f.getRenderWidth()*i,height:f.getRenderHeight()*i},t,!1,!0,n.Engine.TEXTURETYPE_UNSIGNED_INT);this._volumetricLightScatteringRTT.wrapU=n.Texture.CLAMP_ADDRESSMODE;this._volumetricLightScatteringRTT.wrapV=n.Texture.CLAMP_ADDRESSMODE;this._volumetricLightScatteringRTT.renderList=null;this._volumetricLightScatteringRTT.renderParticles=!1;t.customRenderTargets.push(this._volumetricLightScatteringRTT);u=function(t){var i=t.getRenderingMesh(),h,f,e,c,u,o,s;r._meshExcluded(i)||(h=i.getScene(),f=h.getEngine(),f.setState(t.getMaterial().backFaceCulling),e=i._getInstancesRenderList(t._id),e.mustReturn||(c=null!==f.getCaps().instancedArrays&&null!==e.visibleInstances[t._id],r.isReady(t,c)&&(u=r._volumetricLightScatteringPass,(i===r.mesh&&(u=t.getMaterial().getEffect()),f.enableEffect(u),i._bind(t,u,n.Material.TriangleFillMode),i===r.mesh)?t.getMaterial().bind(i.getWorldMatrix(),i):(o=t.getMaterial(),(r._volumetricLightScatteringPass.setMatrix("viewProjection",h.getTransformMatrix()),o&&o.needAlphaTesting())&&(s=o.getAlphaTestTexture(),r._volumetricLightScatteringPass.setTexture("diffuseSampler",s),s&&r._volumetricLightScatteringPass.setMatrix("diffuseMatrix",s.getTextureMatrix())),i.useBones&&i.computeBonesUsingShaders&&r._volumetricLightScatteringPass.setMatrices("mBones",i.skeleton.getTransformMatrices(i))),i._processRendering(t,r._volumetricLightScatteringPass,n.Material.TriangleFillMode,e,c,function(n,t){return u.setMatrix("world",t)}))))};o=new n.Color4(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(function(){e=t.clearColor;t.clearColor=o});this._volumetricLightScatteringRTT.onAfterRenderObservable.add(function(){t.clearColor=e});this._volumetricLightScatteringRTT.customRenderFunction=function(i,r,f){for(var s=t.getEngine(),o,h,e=0;e<i.length;e++)u(i.data[e]);for(s.setAlphaTesting(!0),e=0;e<r.length;e++)u(r.data[e]);if(s.setAlphaTesting(!1),f.length){for(e=0;e<f.length;e++)o=f.data[e],o._alphaIndex=o.getMesh().alphaIndex,o._distanceToCamera=o.getBoundingInfo().boundingSphere.centerWorld.subtract(t.activeCamera.position).length();for(h=f.data.slice(0,f.length),h.sort(function(n,t){return n._alphaIndex>t._alphaIndex?1:n._alphaIndex<t._alphaIndex?-1:n._distanceToCamera<t._distanceToCamera?1:n._distanceToCamera>t._distanceToCamera?-1:0}),s.setAlphaMode(n.Engine.ALPHA_COMBINE),e=0;e<h.length;e++)u(h[e]);s.setAlphaMode(n.Engine.ALPHA_DISABLE)}}},i.prototype._updateMeshScreenCoordinates=function(t){var r,u=t.getTransformMatrix(),i;r=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;i=n.Vector3.Project(r,n.Matrix.Identity(),u,this._viewPort);this._screenCoordinates.x=i.x/this._viewPort.width;this._screenCoordinates.y=i.y/this._viewPort.height;this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)},i.CreateDefaultMesh=function(t,i){var r=n.Mesh.CreatePlane(t,1,i),u;return r.billboardMode=n.AbstractMesh.BILLBOARDMODE_ALL,u=new n.StandardMaterial(t+"Material",i),u.emissiveColor=new n.Color3(1,1,1),r.material=u,r},r([n.serializeAsVector3()],i.prototype,"customMeshPosition",void 0),r([n.serialize()],i.prototype,"useCustomMeshPosition",void 0),r([n.serialize()],i.prototype,"invert",void 0),r([n.serializeAsMeshReference()],i.prototype,"mesh",void 0),r([n.serialize()],i.prototype,"excludedMeshes",void 0),r([n.serialize()],i.prototype,"exposure",void 0),r([n.serialize()],i.prototype,"decay",void 0),r([n.serialize()],i.prototype,"weight",void 0),r([n.serialize()],i.prototype,"density",void 0),i}(n.PostProcess);n.VolumetricLightScatteringPostProcess=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e){var o=this;void 0===f&&(f=1);t.call(this,u.getEngine(),i);this.LensChromaticAberrationEffect="LensChromaticAberrationEffect";this.HighlightsEnhancingEffect="HighlightsEnhancingEffect";this.LensDepthOfFieldEffect="LensDepthOfFieldEffect";this._scene=u;this._depthTexture=u.enableDepthRenderer().getDepthMap();r.grain_texture?this._grainTexture=r.grain_texture:this._createGrainTexture();this._edgeBlur=r.edge_blur?r.edge_blur:0;this._grainAmount=r.grain_amount?r.grain_amount:0;this._chromaticAberration=r.chromatic_aberration?r.chromatic_aberration:0;this._distortion=r.distortion?r.distortion:0;this._highlightsGain=void 0!==r.dof_gain?r.dof_gain:-1;this._highlightsThreshold=r.dof_threshold?r.dof_threshold:1;this._dofDistance=void 0!==r.dof_focus_distance?r.dof_focus_distance:-1;this._dofAperture=r.dof_aperture?r.dof_aperture:1;this._dofDarken=r.dof_darken?r.dof_darken:0;this._dofPentagon=void 0===r.dof_pentagon||r.dof_pentagon;this._blurNoise=void 0===r.blur_noise||r.blur_noise;this._createChromaticAberrationPostProcess(f);this._createHighlightsPostProcess(f);this._createDepthOfFieldPostProcess(f/4);this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),this.LensChromaticAberrationEffect,function(){return o._chromaticAberrationPostProcess},!0));this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),this.HighlightsEnhancingEffect,function(){return o._highlightsPostProcess},!0));this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),this.LensDepthOfFieldEffect,function(){return o._depthOfFieldPostProcess},!0));this._highlightsGain===-1&&this._disableEffect(this.HighlightsEnhancingEffect,null);u.postProcessRenderPipelineManager.addPipeline(this);e&&u.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,e)}return u(i,t),i.prototype.setEdgeBlur=function(n){this._edgeBlur=n},i.prototype.disableEdgeBlur=function(){this._edgeBlur=0},i.prototype.setGrainAmount=function(n){this._grainAmount=n},i.prototype.disableGrain=function(){this._grainAmount=0},i.prototype.setChromaticAberration=function(n){this._chromaticAberration=n},i.prototype.disableChromaticAberration=function(){this._chromaticAberration=0},i.prototype.setEdgeDistortion=function(n){this._distortion=n},i.prototype.disableEdgeDistortion=function(){this._distortion=0},i.prototype.setFocusDistance=function(n){this._dofDistance=n},i.prototype.disableDepthOfField=function(){this._dofDistance=-1},i.prototype.setAperture=function(n){this._dofAperture=n},i.prototype.setDarkenOutOfFocus=function(n){this._dofDarken=n},i.prototype.enablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect("#define PENTAGON\n")},i.prototype.disablePentagonBokeh=function(){this._highlightsPostProcess.updateEffect()},i.prototype.enableNoiseBlur=function(){this._blurNoise=!0},i.prototype.disableNoiseBlur=function(){this._blurNoise=!1},i.prototype.setHighlightsGain=function(n){this._highlightsGain=n},i.prototype.setHighlightsThreshold=function(n){this._highlightsGain===-1&&(this._highlightsGain=1);this._highlightsThreshold=n},i.prototype.disableHighlights=function(){this._highlightsGain=-1},i.prototype.dispose=function(n){void 0===n&&(n=!1);this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);this._chromaticAberrationPostProcess=void 0;this._highlightsPostProcess=void 0;this._depthOfFieldPostProcess=void 0;this._grainTexture.dispose();n&&this._scene.disableDepthRenderer()},i.prototype._createChromaticAberrationPostProcess=function(t){var i=this;this._chromaticAberrationPostProcess=new n.PostProcess("LensChromaticAberration","chromaticAberration",["chromatic_aberration","screen_width","screen_height"],[],t,null,n.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1);this._chromaticAberrationPostProcess.onApply=function(n){n.setFloat("chromatic_aberration",i._chromaticAberration);n.setFloat("screen_width",i._scene.getEngine().getRenderingCanvas().width);n.setFloat("screen_height",i._scene.getEngine().getRenderingCanvas().height)}},i.prototype._createHighlightsPostProcess=function(t){var i=this;this._highlightsPostProcess=new n.PostProcess("LensHighlights","lensHighlights",["gain","threshold","screen_width","screen_height"],[],t,null,n.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,this._dofPentagon?"#define PENTAGON\n":"");this._highlightsPostProcess.onApply=function(n){n.setFloat("gain",i._highlightsGain);n.setFloat("threshold",i._highlightsThreshold);n.setTextureFromPostProcess("textureSampler",i._chromaticAberrationPostProcess);n.setFloat("screen_width",i._scene.getEngine().getRenderingCanvas().width);n.setFloat("screen_height",i._scene.getEngine().getRenderingCanvas().height)}},i.prototype._createDepthOfFieldPostProcess=function(t){var i=this;this._depthOfFieldPostProcess=new n.PostProcess("LensDepthOfField","depthOfField",["grain_amount","blur_noise","screen_width","screen_height","distortion","dof_enabled","screen_distance","aperture","darken","edge_blur","highlights","near","far"],["depthSampler","grainSampler","highlightsSampler"],t,null,n.Texture.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1);this._depthOfFieldPostProcess.onApply=function(n){n.setTexture("depthSampler",i._depthTexture);n.setTexture("grainSampler",i._grainTexture);n.setTextureFromPostProcess("textureSampler",i._highlightsPostProcess);n.setTextureFromPostProcess("highlightsSampler",i._depthOfFieldPostProcess);n.setFloat("grain_amount",i._grainAmount);n.setBool("blur_noise",i._blurNoise);n.setFloat("screen_width",i._scene.getEngine().getRenderingCanvas().width);n.setFloat("screen_height",i._scene.getEngine().getRenderingCanvas().height);n.setFloat("distortion",i._distortion);n.setBool("dof_enabled",i._dofDistance!==-1);n.setFloat("screen_distance",1/(.1-1/i._dofDistance));n.setFloat("aperture",i._dofAperture);n.setFloat("darken",i._dofDarken);n.setFloat("edge_blur",i._edgeBlur);n.setBool("highlights",i._highlightsGain!==-1);n.setFloat("near",i._scene.activeCamera.minZ);n.setFloat("far",i._scene.activeCamera.maxZ)}},i.prototype._createGrainTexture=function(){var r=512,i;this._grainTexture=new n.DynamicTexture("LensNoiseTexture",r,this._scene,!1,n.Texture.BILINEAR_SAMPLINGMODE);this._grainTexture.wrapU=n.Texture.WRAP_ADDRESSMODE;this._grainTexture.wrapV=n.Texture.WRAP_ADDRESSMODE;for(var t,f=this._grainTexture.getContext(),e=function(n,t){return Math.random()*(t-n)+n},u=0;u<r;u++)for(i=0;i<r;i++)t=Math.floor(255*e(.42,.58)),f.fillStyle="rgb("+t+", "+t+", "+t+")",f.fillRect(u,i,1,1);this._grainTexture.update(!1)},i}(n.PostProcessRenderPipeline);n.LensRenderingPipeline=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s){var h=this;t.call(this,i,"colorCorrection",null,["colorTable"],u,f,e,o,s);this._colorTableTexture=new n.Texture(r,f.getScene(),!0,!1,n.Texture.TRILINEAR_SAMPLINGMODE);this._colorTableTexture.anisotropicFilteringLevel=1;this._colorTableTexture.wrapU=n.Texture.CLAMP_ADDRESSMODE;this._colorTableTexture.wrapV=n.Texture.CLAMP_ADDRESSMODE;this.onApply=function(n){n.setTexture("colorTable",h._colorTableTexture)}}return u(i,t),i}(n.PostProcess);n.ColorCorrectionPostProcess=t}(i||(i={}));!function(n){var h=function(t){function i(i,r,u,f){t.call(this,i,r,f);this.interaxialDistance=u;this.setCameraRigMode(n.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:u})}return u(i,t),i.prototype.getTypeName=function(){return"AnaglyphFreeCamera"},i}(n.FreeCamera),t,i,r,f,e,o,s;n.AnaglyphFreeCamera=h;t=function(t){function i(i,r,u,f,e,o,s){t.call(this,i,r,u,f,e,s);this.interaxialDistance=o;this.setCameraRigMode(n.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:o})}return u(i,t),i.prototype.getTypeName=function(){return"AnaglyphArcRotateCamera"},i}(n.ArcRotateCamera);n.AnaglyphArcRotateCamera=t;i=function(t){function i(i,r,u,f){t.call(this,i,r,f);this.interaxialDistance=u;this.setCameraRigMode(n.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:u})}return u(i,t),i.prototype.getTypeName=function(){return"AnaglyphGamepadCamera"},i}(n.GamepadCamera);n.AnaglyphGamepadCamera=i;r=function(t){function i(i,r,u,f){t.call(this,i,r,f);this.interaxialDistance=u;this.setCameraRigMode(n.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:u})}return u(i,t),i.prototype.getTypeName=function(){return"AnaglyphUniversalCamera"},i}(n.UniversalCamera);n.AnaglyphUniversalCamera=r;f=function(t){function i(i,r,u,f,e){t.call(this,i,r,e);this.interaxialDistance=u;this.isStereoscopicSideBySide=f;this.setCameraRigMode(f?n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:n.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:u})}return u(i,t),i.prototype.getTypeName=function(){return"StereoscopicFreeCamera"},i}(n.FreeCamera);n.StereoscopicFreeCamera=f;e=function(t){function i(i,r,u,f,e,o,s,h){t.call(this,i,r,u,f,e,h);this.interaxialDistance=o;this.isStereoscopicSideBySide=s;this.setCameraRigMode(s?n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:n.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:o})}return u(i,t),i.prototype.getTypeName=function(){return"StereoscopicArcRotateCamera"},i}(n.ArcRotateCamera);n.StereoscopicArcRotateCamera=e;o=function(t){function i(i,r,u,f,e){t.call(this,i,r,e);this.interaxialDistance=u;this.isStereoscopicSideBySide=f;this.setCameraRigMode(f?n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:n.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:u})}return u(i,t),i.prototype.getTypeName=function(){return"StereoscopicGamepadCamera"},i}(n.GamepadCamera);n.StereoscopicGamepadCamera=o;s=function(t){function i(i,r,u,f,e){t.call(this,i,r,e);this.interaxialDistance=u;this.isStereoscopicSideBySide=f;this.setCameraRigMode(f?n.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:n.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:u})}return u(i,t),i.prototype.getTypeName=function(){return"StereoscopicUniversalCamera"},i}(n.UniversalCamera);n.StereoscopicUniversalCamera=s}(i||(i={}));!function(n){var t=function(t){function i(r,u,f,e,o){var s=this,c,h;for(void 0===e&&(e=null),t.call(this,u.getEngine(),r),this.gaussCoeff=.3,this.gaussMean=1,this.gaussStandDev=.8,this.gaussMultiplier=4,this.exposure=1,this.minimumLuminance=1,this.maximumLuminance=1e20,this.luminanceIncreaserate=.5,this.luminanceDecreaseRate=.5,this.brightThreshold=.8,this._needUpdate=!0,this._scene=u,this._createBrightPassPostProcess(u,f),this._createDownSampleX4PostProcess(u,f),this._createGaussianBlurPostProcess(u,f),this._createTextureAdderPostProcess(u,f),this._createLuminanceGeneratorPostProcess(u),this._createHDRPostProcess(u,f),this._originalPostProcess=null===e?new n.PassPostProcess("hdr",f,null,n.Texture.BILINEAR_SAMPLINGMODE,u.getEngine(),!1):e,this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDRPassPostProcess",function(){return s._originalPostProcess},!0)),this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDRBrightPass",function(){return s._brightPassPostProcess},!0)),this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDRDownSampleX4",function(){return s._downSampleX4PostProcess},!0)),this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDRGaussianBlurH",function(){return s._guassianBlurHPostProcess},!0)),this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDRGaussianBlurV",function(){return s._guassianBlurVPostProcess},!0)),this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDRTextureAdder",function(){return s._textureAdderPostProcess},!0)),c=function(t){s.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDRDownSampler"+t,function(){return s._downSamplePostProcesses[t]},!0))},h=i.LUM_STEPS-1;h>=0;h--)c(h);this.addEffect(new n.PostProcessRenderEffect(u.getEngine(),"HDR",function(){return s._hdrPostProcess},!0));u.postProcessRenderPipelineManager.addPipeline(this);null!==o&&u.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(r,o);this.update()}return u(i,t),i.prototype.update=function(){this._needUpdate=!0},i.prototype.getCurrentLuminance=function(){return this._hdrCurrentLuminance},i.prototype.getOutputLuminance=function(){return this._hdrOutputLuminance},i.prototype.dispose=function(){this._originalPostProcess=void 0;this._brightPassPostProcess=void 0;this._downSampleX4PostProcess=void 0;this._guassianBlurHPostProcess=void 0;this._guassianBlurVPostProcess=void 0;this._textureAdderPostProcess=void 0;for(var n=i.LUM_STEPS-1;n>=0;n--)this._downSamplePostProcesses[n]=void 0;this._hdrPostProcess=void 0;this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras)},i.prototype._createHDRPostProcess=function(t,i){var r=this,u=0;this._hdrOutputLuminance=-1;this._hdrCurrentLuminance=1;this._hdrPostProcess=new n.PostProcess("hdr","hdr",["exposure","avgLuminance"],["otherSampler"],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define HDR");this._hdrPostProcess.onApply=function(i){if(r._hdrOutputLuminance<0)r._hdrOutputLuminance=r._hdrCurrentLuminance;else{var f=(u-(u+t.getEngine().getDeltaTime()))/1e3;r._hdrCurrentLuminance<r._hdrOutputLuminance+r.luminanceDecreaseRate*f?r._hdrOutputLuminance+=r.luminanceDecreaseRate*f:r._hdrCurrentLuminance>r._hdrOutputLuminance-r.luminanceIncreaserate*f?r._hdrOutputLuminance-=r.luminanceIncreaserate*f:r._hdrOutputLuminance=r._hdrCurrentLuminance}r._hdrOutputLuminance=n.MathTools.Clamp(r._hdrOutputLuminance,r.minimumLuminance,r.maximumLuminance);u+=t.getEngine().getDeltaTime();i.setTextureFromPostProcess("textureSampler",r._textureAdderPostProcess);i.setTextureFromPostProcess("otherSampler",r._originalPostProcess);i.setFloat("exposure",r.exposure);i.setFloat("avgLuminance",r._hdrOutputLuminance);r._needUpdate=!1}},i.prototype._createTextureAdderPostProcess=function(t,i){var r=this;this._textureAdderPostProcess=new n.PostProcess("hdr","hdr",[],["otherSampler"],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define TEXTURE_ADDER");this._textureAdderPostProcess.onApply=function(n){n.setTextureFromPostProcess("otherSampler",r._originalPostProcess)}},i.prototype._createDownSampleX4PostProcess=function(t,i){var r=this,u=new Array(32);this._downSampleX4PostProcess=new n.PostProcess("hdr","hdr",["dsOffsets"],[],i/4,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define DOWN_SAMPLE_X4");this._downSampleX4PostProcess.onApply=function(n){var t,i,f;if(r._needUpdate)for(t=0,i=-2;i<2;i++)for(f=-2;f<2;f++)u[t]=(i+.5)*(1/r._downSampleX4PostProcess.width),u[t+1]=(f+.5)*(1/r._downSampleX4PostProcess.height),t+=2;n.setArray2("dsOffsets",u)}},i.prototype._createBrightPassPostProcess=function(t,i){var u=this,r=new Array(8),f=function(n){if(u._needUpdate){var t=1/u._brightPassPostProcess.width,i=1/u._brightPassPostProcess.height;r[0]=-.5*t;r[1]=.5*i;r[2]=.5*t;r[3]=.5*i;r[4]=-.5*t;r[5]=-.5*i;r[6]=.5*t;r[7]=-.5*i}n.setArray2("dsOffsets",r);n.setFloat("brightThreshold",u.brightThreshold)};this._brightPassPostProcess=new n.PostProcess("hdr","hdr",["dsOffsets","brightThreshold"],[],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define BRIGHT_PASS");this._brightPassPostProcess.onApply=f},i.prototype._createLuminanceGeneratorPostProcess=function(t){var l,r=this,e=i.LUM_STEPS,f=new Array(8),o=new Array(18),u,h,c;this._downSamplePostProcesses=new Array(e);var a=function(n,t){var i=1/n,r=1/t;f[0]=-.5*i;f[1]=.5*r;f[2]=.5*i;f[3]=.5*r;f[4]=-.5*i;f[5]=-.5*r;f[6]=.5*i;f[7]=-.5*r},v=function(n,t){for(var u,i=0,r=-1;r<2;r++)for(u=-1;u<2;u++)o[i]=r/n,o[i+1]=u/t,i+=2},y=function(n){r._needUpdate&&a(r._textureAdderPostProcess.width,r._textureAdderPostProcess.height);n.setTextureFromPostProcess("textureSampler",r._textureAdderPostProcess);n.setArray2("lumOffsets",f)},p=function(n){var t=n;return function(n){a(r._downSamplePostProcesses[t].width,r._downSamplePostProcesses[t].height);v(r._downSamplePostProcesses[t].width,r._downSamplePostProcesses[t].height);l=.5/r._downSamplePostProcesses[t].width;n.setTextureFromPostProcess("textureSampler",r._downSamplePostProcesses[t+1]);n.setFloat("halfDestPixelSize",l);n.setArray2("dsOffsets",o)}},w=function(){var i=t.getEngine().readPixels(0,0,1,1),u=new n.Vector4(1/16581375,1/65025,1/255,1);r._hdrCurrentLuminance=(i[0]*u.x+i[1]*u.y+i[2]*u.z+i[3]*u.w)/100},s={width:Math.pow(3,e-1),height:Math.pow(3,e-1)};for(this._downSamplePostProcesses[e-1]=new n.PostProcess("hdr","hdr",["lumOffsets"],[],s,null,n.Texture.NEAREST_SAMPLINGMODE,t.getEngine(),!1,"#define LUMINANCE_GENERATOR",n.Engine.TEXTURETYPE_FLOAT),this._downSamplePostProcesses[e-1].onApply=y,u=e-2;u>=0;u--)h=Math.pow(3,u),s={width:h,height:h},c="#define DOWN_SAMPLE\n",0===u&&(c+="#define FINAL_DOWN_SAMPLE\n"),this._downSamplePostProcesses[u]=new n.PostProcess("hdr","hdr",["dsOffsets","halfDestPixelSize"],[],s,null,n.Texture.NEAREST_SAMPLINGMODE,t.getEngine(),!1,c,n.Engine.TEXTURETYPE_FLOAT),this._downSamplePostProcesses[u].onApply=p(u),0===u&&(this._downSamplePostProcesses[u].onAfterRender=w)},i.prototype._createGaussianBlurPostProcess=function(t,i){var r=this,u=new Array(9),f=new Array(9),e=new Array(9),o=["blurOffsets","blurWeights","multiplier"],h=function(n){for(var e,r={width:t.getEngine().getRenderWidth(),height:t.getEngine().getRenderHeight()},i=0;i<9;i++)e=(i-4)*(1/(n===!0?r.height:r.width)),n?f[i]=e:u[i]=e},c=function(){for(var t=0,n=0;n<9;n++)t=(n-4)/4,e[n]=r.gaussCoeff*(1/Math.sqrt(2*Math.PI*r.gaussStandDev))*Math.exp(-((t-r.gaussMean)*(t-r.gaussMean))/(2*r.gaussStandDev*r.gaussStandDev))},s=function(n){return function(t){r._needUpdate&&(c(),h(n));t.setArray("blurOffsets",n?f:u);t.setArray("blurWeights",e);t.setFloat("multiplier",r.gaussMultiplier)}};this._guassianBlurHPostProcess=new n.PostProcess("hdr","hdr",o,[],i/4,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define GAUSSIAN_BLUR_H");this._guassianBlurHPostProcess.onApply=s(!1);this._guassianBlurVPostProcess=new n.PostProcess("hdr","hdr",o,[],i/4,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define GAUSSIAN_BLUR_V");this._guassianBlurVPostProcess.onApply=s(!0)},i.LUM_STEPS=6,i}(n.PostProcessRenderPipeline);n.HDRRenderingPipeline=t}(i||(i={}));!function(n){var t=function(){function n(){this.edges=[];this.edgesConnectedCount=0}return n}(),i=function(){function i(n,t,i){void 0===t&&(t=.95);void 0===i&&(i=!1);this.edgesWidthScalerForOrthographic=1e3;this.edgesWidthScalerForPerspective=50;this._linesPositions=[];this._linesNormals=[];this._linesIndices=[];this._buffers={};this._checkVerticesInsteadOfIndices=!1;this._source=n;this._checkVerticesInsteadOfIndices=i;this._epsilon=t;this._prepareRessources();this._generateEdgesLines()}return i.prototype._prepareRessources=function(){this._lineShader||(this._lineShader=new n.ShaderMaterial("lineShader",this._source.getScene(),"line",{attributes:["position","normal"],uniforms:["worldViewProjection","color","width","aspectRatio"]}),this._lineShader.disableDepthWrite=!0,this._lineShader.backFaceCulling=!1)},i.prototype.dispose=function(){var t=this._buffers[n.VertexBuffer.PositionKind];t&&(t.dispose(),this._buffers[n.VertexBuffer.PositionKind]=null);t=this._buffers[n.VertexBuffer.NormalKind];t&&(t.dispose(),this._buffers[n.VertexBuffer.NormalKind]=null);this._source.getScene().getEngine()._releaseBuffer(this._ib);this._lineShader.dispose()},i.prototype._processEdgeForAdjacencies=function(n,t,i,r,u){return n===i&&t===r||n===r&&t===i?0:n===r&&t===u||n===u&&t===r?1:n===u&&t===i||n===i&&t===u?2:-1},i.prototype._processEdgeForAdjacenciesWithVertices=function(n,t,i,r,u){return n.equalsWithEpsilon(i)&&t.equalsWithEpsilon(r)||n.equalsWithEpsilon(r)&&t.equalsWithEpsilon(i)?0:n.equalsWithEpsilon(r)&&t.equalsWithEpsilon(u)||n.equalsWithEpsilon(u)&&t.equalsWithEpsilon(r)?1:n.equalsWithEpsilon(u)&&t.equalsWithEpsilon(i)||n.equalsWithEpsilon(i)&&t.equalsWithEpsilon(u)?2:-1},i.prototype._checkEdge=function(t,i,r,u,f){var o,s,e,h;void 0===i?o=!0:(s=n.Vector3.Dot(r[t],r[i]),o=s<this._epsilon);o&&(e=this._linesPositions.length/3,h=u.subtract(f),h.normalize(),this._linesPositions.push(u.x),this._linesPositions.push(u.y),this._linesPositions.push(u.z),this._linesPositions.push(u.x),this._linesPositions.push(u.y),this._linesPositions.push(u.z),this._linesPositions.push(f.x),this._linesPositions.push(f.y),this._linesPositions.push(f.z),this._linesPositions.push(f.x),this._linesPositions.push(f.y),this._linesPositions.push(f.z),this._linesNormals.push(f.x),this._linesNormals.push(f.y),this._linesNormals.push(f.z),this._linesNormals.push(-1),this._linesNormals.push(f.x),this._linesNormals.push(f.y),this._linesNormals.push(f.z),this._linesNormals.push(1),this._linesNormals.push(u.x),this._linesNormals.push(u.y),this._linesNormals.push(u.z),this._linesNormals.push(-1),this._linesNormals.push(u.x),this._linesNormals.push(u.y),this._linesNormals.push(u.z),this._linesNormals.push(1),this._linesIndices.push(e),this._linesIndices.push(e+1),this._linesIndices.push(e+2),this._linesIndices.push(e),this._linesIndices.push(e+2),this._linesIndices.push(e+3))},i.prototype._generateEdgesLines=function(){for(var r,o=this._source.getVerticesData(n.VertexBuffer.PositionKind),u=this._source.getIndices(),h=[],a=[],b,s,f,l,e,v,i=0;i<u.length;i+=3){r=new t;var y=u[i],p=u[i+1],w=u[i+2];r.p0=new n.Vector3(o[3*y],o[3*y+1],o[3*y+2]);r.p1=new n.Vector3(o[3*p],o[3*p+1],o[3*p+2]);r.p2=new n.Vector3(o[3*w],o[3*w+1],o[3*w+2]);b=n.Vector3.Cross(r.p1.subtract(r.p0),r.p2.subtract(r.p1));b.normalize();a.push(b);h.push(r)}for(i=0;i<h.length;i++)for(r=h[i],s=i+1;s<h.length;s++){if(f=h[s],3===r.edgesConnectedCount)break;if(3!==f.edgesConnectedCount)for(var k=u[3*s],d=u[3*s+1],g=u[3*s+2],c=0;c<3;c++)if(void 0===r.edges[c]){switch(c){case 0:l=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(r.p0,r.p1,f.p0,f.p1,f.p2):this._processEdgeForAdjacencies(u[3*i],u[3*i+1],k,d,g);break;case 1:l=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(r.p1,r.p2,f.p0,f.p1,f.p2):this._processEdgeForAdjacencies(u[3*i+1],u[3*i+2],k,d,g);break;case 2:l=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(r.p2,r.p0,f.p0,f.p1,f.p2):this._processEdgeForAdjacencies(u[3*i+2],u[3*i],k,d,g)}if(l!==-1&&(r.edges[c]=s,f.edges[l]=i,r.edgesConnectedCount++,f.edgesConnectedCount++,3===r.edgesConnectedCount))break}}for(i=0;i<h.length;i++)e=h[i],this._checkEdge(i,e.edges[0],a,e.p0,e.p1),this._checkEdge(i,e.edges[1],a,e.p1,e.p2),this._checkEdge(i,e.edges[2],a,e.p2,e.p0);v=this._source.getScene().getEngine();this._buffers[n.VertexBuffer.PositionKind]=new n.VertexBuffer(v,this._linesPositions,n.VertexBuffer.PositionKind,!1);this._buffers[n.VertexBuffer.NormalKind]=new n.VertexBuffer(v,this._linesNormals,n.VertexBuffer.NormalKind,!1,!1,4);this._ib=v.createIndexBuffer(this._linesIndices);this._indicesCount=this._linesIndices.length},i.prototype.render=function(){if(this._lineShader.isReady()){var t=this._source.getScene(),i=t.getEngine();this._lineShader._preBind();i.bindBuffers(this._buffers,this._ib,this._lineShader.getEffect());t.resetCachedMaterial();this._lineShader.setColor4("color",this._source.edgesColor);t.activeCamera.mode===n.Camera.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective);this._lineShader.setFloat("aspectRatio",i.getAspectRatio(t.activeCamera));this._lineShader.bind(this._source.getWorldMatrix());i.draw(!0,0,this._indicesCount);this._lineShader.unbind();i.setDepthWrite(!0)}},i}();n.EdgesRenderer=i}(i||(i={}));!function(n){!function(n){n[n.Hable=0]="Hable";n[n.Reinhard=1]="Reinhard";n[n.HejiDawson=2]="HejiDawson";n[n.Photographic=3]="Photographic"}(n.TonemappingOperator||(n.TonemappingOperator={}));var t=n.TonemappingOperator,i=function(i){function r(r,u,f,e,o,s,h){var l=this,c;void 0===o&&(o=n.Texture.BILINEAR_SAMPLINGMODE);void 0===h&&(h=n.Engine.TEXTURETYPE_UNSIGNED_INT);i.call(this,r,"tonemap",["_ExposureAdjustment"],null,1,e,o,s,!0,c,h);this._operator=u;this.exposureAdjustment=f;c="#define ";this._operator===t.Hable?c+="HABLE_TONEMAPPING":this._operator===t.Reinhard?c+="REINHARD_TONEMAPPING":this._operator===t.HejiDawson?c+="OPTIMIZED_HEJIDAWSON_TONEMAPPING":this._operator===t.Photographic&&(c+="PHOTOGRAPHIC_TONEMAPPING");this.updateEffect(c);this.onApply=function(n){n.setFloat("_ExposureAdjustment",l.exposureAdjustment)}}return u(r,i),r}(n.PostProcess);n.TonemapPostProcess=i}(i||(i={}));!function(n){var t=function(){function t(t,i,r,u){var f=this;void 0===u&&(u=!0);this.name=t;this._viewMatrix=n.Matrix.Identity();this._target=n.Vector3.Zero();this._add=n.Vector3.Zero();this.invertYAxis=!1;this.position=n.Vector3.Zero();this._scene=r;this._scene.reflectionProbes.push(this);this._renderTargetTexture=new n.RenderTargetTexture(t,i,r,u,!0,n.Engine.TEXTURETYPE_UNSIGNED_INT,!0);this._renderTargetTexture.onBeforeRenderObservable.add(function(t){switch(t){case 0:f._add.copyFromFloats(1,0,0);break;case 1:f._add.copyFromFloats(-1,0,0);break;case 2:f._add.copyFromFloats(0,f.invertYAxis?1:-1,0);break;case 3:f._add.copyFromFloats(0,f.invertYAxis?-1:1,0);break;case 4:f._add.copyFromFloats(0,0,1);break;case 5:f._add.copyFromFloats(0,0,-1)}f._attachedMesh&&f.position.copyFrom(f._attachedMesh.getAbsolutePosition());f.position.addToRef(f._add,f._target);n.Matrix.LookAtLHToRef(f.position,f._target,n.Vector3.Up(),f._viewMatrix);r.setTransformMatrix(f._viewMatrix,f._projectionMatrix)});this._renderTargetTexture.onAfterUnbindObservable.add(function(){r.updateTransformMatrix(!0)});this._projectionMatrix=n.Matrix.PerspectiveFovLH(Math.PI/2,1,r.activeCamera.minZ,r.activeCamera.maxZ)}return Object.defineProperty(t.prototype,"refreshRate",{get:function(){return this._renderTargetTexture.refreshRate},set:function(n){this._renderTargetTexture.refreshRate=n},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},Object.defineProperty(t.prototype,"cubeTexture",{get:function(){return this._renderTargetTexture},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderList",{get:function(){return this._renderTargetTexture.renderList},enumerable:!0,configurable:!0}),t.prototype.attachToMesh=function(n){this._attachedMesh=n},t.prototype.dispose=function(){var n=this._scene.reflectionProbes.indexOf(this);n!==-1&&this._scene.reflectionProbes.splice(n,1);this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null)},t}();n.ReflectionProbe=t}(i||(i={}));!function(n){var i=function(){function t(t,i,r,u,f,e,o){this.idx=0;this.color=new n.Color4(1,1,1,1);this.position=n.Vector3.Zero();this.rotation=n.Vector3.Zero();this.scaling=new n.Vector3(1,1,1);this.uvs=new n.Vector4(0,0,1,1);this.velocity=n.Vector3.Zero();this.alive=!0;this.isVisible=!0;this._pos=0;this.shapeId=0;this.idxInShape=0;this.idx=t;this._pos=i;this._model=r;this.shapeId=u;this.idxInShape=f;this._sps=e;o&&(this._modelBoundingInfo=o,this._boundingInfo=new n.BoundingInfo(o.minimum,o.maximum))}return Object.defineProperty(t.prototype,"scale",{get:function(){return this.scaling},set:function(n){this.scaling=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"quaternion",{get:function(){return this.rotationQuaternion},set:function(n){this.rotationQuaternion=n},enumerable:!0,configurable:!0}),t.prototype.intersectsMesh=function(t){return!(!this._boundingInfo||!t._boundingInfo)&&(this._sps._bSphereOnly?n.BoundingSphere.Intersects(this._boundingInfo.boundingSphere,t._boundingInfo.boundingSphere):this._boundingInfo.intersects(t._boundingInfo,!1))},t}(),t;n.SolidParticle=i;t=function(){function n(n,t,i,r,u){this.shapeID=n;this._shape=t;this._shapeUV=i;this._positionFunction=r;this._vertexFunction=u}return n}();n.ModelShape=t}(i||(i={}));!function(n){var t=function(){function t(t,i,r){this.particles=[];this.nbParticles=0;this.billboard=!1;this.recomputeNormals=!0;this.counter=0;this.vars={};this._positions=[];this._indices=[];this._normals=[];this._colors=[];this._uvs=[];this._index=0;this._updatable=!0;this._pickable=!1;this._isVisibilityBoxLocked=!1;this._alwaysVisible=!1;this._shapeCounter=0;this._copy=new n.SolidParticle(null,null,null,null,null,null);this._color=new n.Color4(0,0,0,0);this._computeParticleColor=!0;this._computeParticleTexture=!0;this._computeParticleRotation=!0;this._computeParticleVertex=!1;this._computeBoundingBox=!1;this._cam_axisZ=n.Vector3.Zero();this._cam_axisY=n.Vector3.Zero();this._cam_axisX=n.Vector3.Zero();this._axisX=n.Axis.X;this._axisY=n.Axis.Y;this._axisZ=n.Axis.Z;this._camDir=n.Vector3.Zero();this._rotMatrix=new n.Matrix;this._invertMatrix=new n.Matrix;this._rotated=n.Vector3.Zero();this._quaternion=new n.Quaternion;this._vertex=n.Vector3.Zero();this._normal=n.Vector3.Zero();this._yaw=0;this._pitch=0;this._roll=0;this._halfroll=0;this._halfpitch=0;this._halfyaw=0;this._sinRoll=0;this._cosRoll=0;this._sinPitch=0;this._cosPitch=0;this._sinYaw=0;this._cosYaw=0;this._w=0;this._minimum=n.Tmp.Vector3[0];this._maximum=n.Tmp.Vector3[1];this._scale=n.Tmp.Vector3[2];this._translation=n.Tmp.Vector3[3];this._minBbox=n.Tmp.Vector3[4];this._maxBbox=n.Tmp.Vector3[5];this._particlesIntersect=!1;this._bSphereOnly=!1;this._bSphereRadiusFactor=1;this.name=t;this._scene=i;this._camera=i.activeCamera;this._pickable=!!r&&r.isPickable;this._particlesIntersect=!!r&&r.particleIntersection;this._bSphereOnly=!!r&&r.boundingSphereOnly;this._bSphereRadiusFactor=r&&r.bSphereRadiusFactor?r.bSphereRadiusFactor:1;this._updatable=r&&r.updatable?r.updatable:!0;this._pickable&&(this.pickedParticles=[])}return t.prototype.buildMesh=function(){var r,t,i;return 0===this.nbParticles&&(r=n.MeshBuilder.CreateDisc("",{radius:1,tessellation:3},this._scene),this.addShape(r,1),r.dispose()),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),this.recomputeNormals&&n.VertexData.ComputeNormals(this._positions32,this._indices,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),t=new n.VertexData,t.set(this._positions32,n.VertexBuffer.PositionKind),t.indices=this._indices,t.set(this._normals32,n.VertexBuffer.NormalKind),this._uvs32&&t.set(this._uvs32,n.VertexBuffer.UVKind),this._colors32&&t.set(this._colors32,n.VertexBuffer.ColorKind),i=new n.Mesh(this.name,this._scene),t.applyToMesh(i,this._updatable),this.mesh=i,this.mesh.isPickable=this._pickable,this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0),i},t.prototype.digest=function(t,i){var r=i&&i.facetNb||1,c=i&&i.number,nt=i&&i.delta||0,y=t.getVerticesData(n.VertexBuffer.PositionKind),tt=t.getIndices(),p=t.getVerticesData(n.VertexBuffer.UVKind),l=t.getVerticesData(n.VertexBuffer.ColorKind),ut=t.getVerticesData(n.VertexBuffer.NormalKind),s=0,f=tt.length/3,d,v,u,it,rt;c?(c=c>f?f:c,r=Math.round(f/c),nt=0):r=r>f?f:r;for(var w=[],b=[],a=[],k=[],h=n.Tmp.Vector3[0],ft=r;s<f;){for(r=ft+Math.floor((1+nt)*Math.random()),s>f-r&&(r=f-s),w.length=0,b.length=0,a.length=0,k.length=0,d=0,v=3*s;v<3*(s+r);v++)b.push(d),u=tt[v],w.push(y[3*u],y[3*u+1],y[3*u+2]),p&&a.push(p[2*u],p[2*u+1]),l&&k.push(l[4*u],l[4*u+1],l[4*u+2],l[4*u+3]),d++;for(var g=this.nbParticles,o=this._posToShape(w),et=this._uvsToShapeUV(a),e=0;e<o.length;e++)h.addInPlace(o[e]);for(h.scaleInPlace(1/o.length),e=0;e<o.length;e++)o[e].subtractInPlace(h);this._particlesIntersect&&(it=new n.BoundingInfo(h,h));rt=new n.ModelShape(this._shapeCounter,o,et,null,null);this._meshBuilder(this._index,o,this._positions,b,this._indices,a,this._uvs,k,this._colors,ut,this._normals,g,0,null);this._addParticle(g,this._positions.length,rt,this._shapeCounter,0,it);this.particles[this.nbParticles].position.addInPlace(h);this._index+=o.length;g++;this.nbParticles++;this._shapeCounter++;s+=r}return this},t.prototype._resetCopy=function(){this._copy.position.x=0;this._copy.position.y=0;this._copy.position.z=0;this._copy.rotation.x=0;this._copy.rotation.y=0;this._copy.rotation.z=0;this._copy.rotationQuaternion=null;this._copy.scaling.x=1;this._copy.scaling.y=1;this._copy.scaling.z=1;this._copy.uvs.x=0;this._copy.uvs.y=0;this._copy.uvs.z=1;this._copy.uvs.w=1;this._copy.color=null},t.prototype._meshBuilder=function(t,i,r,u,f,e,o,s,h,c,l,a,v,y){var p,k=0,w=0,b=0,d;for(this._resetCopy(),y&&y.positionFunction&&y.positionFunction(this._copy,a,v),this._copy.rotationQuaternion?this._quaternion.copyFrom(this._copy.rotationQuaternion):(this._yaw=this._copy.rotation.y,this._pitch=this._copy.rotation.x,this._roll=this._copy.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix(),p=0;p<i.length;p++)this._vertex.x=i[p].x,this._vertex.y=i[p].y,this._vertex.z=i[p].z,y&&y.vertexFunction&&y.vertexFunction(this._copy,this._vertex,p),this._vertex.x*=this._copy.scaling.x,this._vertex.y*=this._copy.scaling.y,this._vertex.z*=this._copy.scaling.z,n.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated),r.push(this._copy.position.x+this._rotated.x,this._copy.position.y+this._rotated.y,this._copy.position.z+this._rotated.z),e&&(o.push((this._copy.uvs.z-this._copy.uvs.x)*e[k]+this._copy.uvs.x,(this._copy.uvs.w-this._copy.uvs.y)*e[k+1]+this._copy.uvs.y),k+=2),this._copy.color?this._color=this._copy.color:s&&void 0!==s[w]?(this._color.r=s[w],this._color.g=s[w+1],this._color.b=s[w+2],this._color.a=s[w+3]):(this._color.r=1,this._color.g=1,this._color.b=1,this._color.a=1),h.push(this._color.r,this._color.g,this._color.b,this._color.a),w+=4,!this.recomputeNormals&&c&&(this._normal.x=c[b],this._normal.y=c[b+1],this._normal.z=c[b+2],n.Vector3.TransformCoordinatesToRef(this._normal,this._rotMatrix,this._normal),l.push(this._normal.x,this._normal.y,this._normal.z),b+=3);for(p=0;p<u.length;p++)f.push(t+u[p]);if(this._pickable)for(d=u.length/3,p=0;p<d;p++)this.pickedParticles.push({idx:a,faceId:p})},t.prototype._posToShape=function(t){for(var r=[],i=0;i<t.length;i+=3)r.push(new n.Vector3(t[i],t[i+1],t[i+2]));return r},t.prototype._uvsToShapeUV=function(n){var i=[],t;if(n)for(t=0;t<n.length;t++)i.push(n[t]);return i},t.prototype._addParticle=function(t,i,r,u,f,e){this.particles.push(new n.SolidParticle(t,i,r,u,f,this,e))},t.prototype.addShape=function(t,i,r){var o,h=t.getVerticesData(n.VertexBuffer.PositionKind),c=t.getIndices(),s=t.getVerticesData(n.VertexBuffer.UVKind),l=t.getVerticesData(n.VertexBuffer.ColorKind),a=t.getVerticesData(n.VertexBuffer.NormalKind);this._particlesIntersect&&(o=t.getBoundingInfo());for(var f=this._posToShape(h),v=this._uvsToShapeUV(s),y=r?r.positionFunction:null,p=r?r.vertexFunction:null,w=new n.ModelShape(this._shapeCounter,f,v,y,p),e=this.nbParticles,u=0;u<i;u++)this._meshBuilder(this._index,f,this._positions,c,this._indices,s,this._uvs,l,this._colors,a,this._normals,e,u,r),this._updatable&&this._addParticle(e,this._positions.length,w,this._shapeCounter,u,o),this._index+=f.length,e++;return this.nbParticles+=i,this._shapeCounter++,this._shapeCounter-1},t.prototype._rebuildParticle=function(t){this._resetCopy();t._model._positionFunction&&t._model._positionFunction(this._copy,t.idx,t.idxInShape);this._copy.rotationQuaternion?this._quaternion.copyFrom(this._copy.rotationQuaternion):(this._yaw=this._copy.rotation.y,this._pitch=this._copy.rotation.x,this._roll=this._copy.rotation.z,this._quaternionRotationYPR());this._quaternionToRotationMatrix();this._shape=t._model._shape;for(var i=0;i<this._shape.length;i++)this._vertex.x=this._shape[i].x,this._vertex.y=this._shape[i].y,this._vertex.z=this._shape[i].z,t._model._vertexFunction&&t._model._vertexFunction(this._copy,this._vertex,i),this._vertex.x*=this._copy.scaling.x,this._vertex.y*=this._copy.scaling.y,this._vertex.z*=this._copy.scaling.z,n.Vector3.TransformCoordinatesToRef(this._vertex,this._rotMatrix,this._rotated),this._positions32[t._pos+3*i]=this._copy.position.x+this._rotated.x,this._positions32[t._pos+3*i+1]=this._copy.position.y+this._rotated.y,this._positions32[t._pos+3*i+2]=this._copy.position.z+this._rotated.z;t.position.x=0;t.position.y=0;t.position.z=0;t.rotation.x=0;t.rotation.y=0;t.rotation.z=0;t.rotationQuaternion=null;t.scaling.x=1;t.scaling.y=1;t.scaling.z=1},t.prototype.rebuildMesh=function(){for(var t=0;t<this.particles.length;t++)this._rebuildParticle(this.particles[t]);this.mesh.updateVerticesData(n.VertexBuffer.PositionKind,this._positions32,!1,!1)},t.prototype.setParticles=function(t,i,r){var a,o,l;if(void 0===t&&(t=0),void 0===i&&(i=this.nbParticles-1),void 0===r&&(r=!0),this._updatable){this.beforeUpdateParticles(t,i,r);this._cam_axisX.x=1;this._cam_axisX.y=0;this._cam_axisX.z=0;this._cam_axisY.x=0;this._cam_axisY.y=1;this._cam_axisY.z=0;this._cam_axisZ.x=0;this._cam_axisZ.y=0;this._cam_axisZ.z=1;this.billboard&&this.mesh._worldMatrix.decompose(this._scale,this._quaternion,this._translation)&&(this._quaternionToRotationMatrix(),this._rotMatrix.invertToRef(this._invertMatrix),this._camera._currentTarget.subtractToRef(this._camera.globalPosition,this._camDir),n.Vector3.TransformCoordinatesToRef(this._camDir,this._invertMatrix,this._cam_axisZ),this._cam_axisZ.normalize(),n.Vector3.CrossToRef(this._cam_axisZ,this._axisX,this._cam_axisY),n.Vector3.CrossToRef(this._cam_axisY,this._cam_axisZ,this._cam_axisX),this._cam_axisY.normalize(),this._cam_axisX.normalize());n.Matrix.IdentityToRef(this._rotMatrix);var u=0,v=0,e=0,y=0,s=0,p=0,f=0;for(this._computeBoundingBox&&(n.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this._minimum),n.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this._maximum)),i=i>this.nbParticles-1?this.nbParticles-1:i,a=t;a<=i;a++){if(this._particle=this.particles[a],this._shape=this._particle._model._shape,this._shapeUV=this._particle._model._shapeUV,this.updateParticle(this._particle),this._particle.isVisible)for(this.billboard&&(this._particle.rotation.x=0,this._particle.rotation.y=0),(this._computeParticleRotation||this.billboard)&&(this._particle.rotationQuaternion?this._quaternion.copyFrom(this._particle.rotationQuaternion):(this._yaw=this._particle.rotation.y,this._pitch=this._particle.rotation.x,this._roll=this._particle.rotation.z,this._quaternionRotationYPR()),this._quaternionToRotationMatrix()),f=0;f<this._shape.length;f++)u=v+3*f,e=y+4*f,s=p+2*f,this._vertex.x=this._shape[f].x,this._vertex.y=this._shape[f].y,this._vertex.z=this._shape[f].z,this._computeParticleVertex&&this.updateParticleVertex(this._particle,this._vertex,f),this._vertex.x*=this._particle.scaling.x,this._vertex.y*=this._particle.scaling.y,this._vertex.z*=this._particle.scaling.z,this._w=this._vertex.x*this._rotMatrix.m[3]+this._vertex.y*this._rotMatrix.m[7]+this._vertex.z*this._rotMatrix.m[11]+this._rotMatrix.m[15],this._rotated.x=(this._vertex.x*this._rotMatrix.m[0]+this._vertex.y*this._rotMatrix.m[4]+this._vertex.z*this._rotMatrix.m[8]+this._rotMatrix.m[12])/this._w,this._rotated.y=(this._vertex.x*this._rotMatrix.m[1]+this._vertex.y*this._rotMatrix.m[5]+this._vertex.z*this._rotMatrix.m[9]+this._rotMatrix.m[13])/this._w,this._rotated.z=(this._vertex.x*this._rotMatrix.m[2]+this._vertex.y*this._rotMatrix.m[6]+this._vertex.z*this._rotMatrix.m[10]+this._rotMatrix.m[14])/this._w,this._positions32[u]=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,this._positions32[u+1]=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,this._positions32[u+2]=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z,this._computeBoundingBox&&(this._positions32[u]<this._minimum.x&&(this._minimum.x=this._positions32[u]),this._positions32[u]>this._maximum.x&&(this._maximum.x=this._positions32[u]),this._positions32[u+1]<this._minimum.y&&(this._minimum.y=this._positions32[u+1]),this._positions32[u+1]>this._maximum.y&&(this._maximum.y=this._positions32[u+1]),this._positions32[u+2]<this._minimum.z&&(this._minimum.z=this._positions32[u+2]),this._positions32[u+2]>this._maximum.z&&(this._maximum.z=this._positions32[u+2])),this._computeParticleVertex||(this._normal.x=this._fixedNormal32[u],this._normal.y=this._fixedNormal32[u+1],this._normal.z=this._fixedNormal32[u+2],this._w=this._normal.x*this._rotMatrix.m[3]+this._normal.y*this._rotMatrix.m[7]+this._normal.z*this._rotMatrix.m[11]+this._rotMatrix.m[15],this._rotated.x=(this._normal.x*this._rotMatrix.m[0]+this._normal.y*this._rotMatrix.m[4]+this._normal.z*this._rotMatrix.m[8]+this._rotMatrix.m[12])/this._w,this._rotated.y=(this._normal.x*this._rotMatrix.m[1]+this._normal.y*this._rotMatrix.m[5]+this._normal.z*this._rotMatrix.m[9]+this._rotMatrix.m[13])/this._w,this._rotated.z=(this._normal.x*this._rotMatrix.m[2]+this._normal.y*this._rotMatrix.m[6]+this._normal.z*this._rotMatrix.m[10]+this._rotMatrix.m[14])/this._w,this._normals32[u]=this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,this._normals32[u+1]=this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,this._normals32[u+2]=this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z),this._computeParticleColor&&(this._colors32[e]=this._particle.color.r,this._colors32[e+1]=this._particle.color.g,this._colors32[e+2]=this._particle.color.b,this._colors32[e+3]=this._particle.color.a),this._computeParticleTexture&&(this._uvs32[s]=this._shapeUV[2*f]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x,this._uvs32[s+1]=this._shapeUV[2*f+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y);else for(f=0;f<this._shape.length;f++)u=v+3*f,e=y+4*f,s=p+2*f,this._positions32[u]=this._camera.position.x,this._positions32[u+1]=this._camera.position.y,this._positions32[u+2]=this._camera.position.z,this._normals32[u]=0,this._normals32[u+1]=0,this._normals32[u+2]=0,this._computeParticleColor&&(this._colors32[e]=this._particle.color.r,this._colors32[e+1]=this._particle.color.g,this._colors32[e+2]=this._particle.color.b,this._colors32[e+3]=this._particle.color.a),this._computeParticleTexture&&(this._uvs32[s]=this._shapeUV[2*f]*(this._particle.uvs.z-this._particle.uvs.x)+this._particle.uvs.x,this._uvs32[s+1]=this._shapeUV[2*f+1]*(this._particle.uvs.w-this._particle.uvs.y)+this._particle.uvs.y);if(this._particlesIntersect){var w=this._particle._boundingInfo,h=w.boundingBox,c=w.boundingSphere;if(!this._bSphereOnly){for(o=0;o<h.vectors.length;o++)this._vertex.x=this._particle._modelBoundingInfo.boundingBox.vectors[o].x*this._particle.scaling.x,this._vertex.y=this._particle._modelBoundingInfo.boundingBox.vectors[o].y*this._particle.scaling.y,this._vertex.z=this._particle._modelBoundingInfo.boundingBox.vectors[o].z*this._particle.scaling.z,this._w=this._vertex.x*this._rotMatrix.m[3]+this._vertex.y*this._rotMatrix.m[7]+this._vertex.z*this._rotMatrix.m[11]+this._rotMatrix.m[15],this._rotated.x=(this._vertex.x*this._rotMatrix.m[0]+this._vertex.y*this._rotMatrix.m[4]+this._vertex.z*this._rotMatrix.m[8]+this._rotMatrix.m[12])/this._w,this._rotated.y=(this._vertex.x*this._rotMatrix.m[1]+this._vertex.y*this._rotMatrix.m[5]+this._vertex.z*this._rotMatrix.m[9]+this._rotMatrix.m[13])/this._w,this._rotated.z=(this._vertex.x*this._rotMatrix.m[2]+this._vertex.y*this._rotMatrix.m[6]+this._vertex.z*this._rotMatrix.m[10]+this._rotMatrix.m[14])/this._w,h.vectors[o].x=this._particle.position.x+this._cam_axisX.x*this._rotated.x+this._cam_axisY.x*this._rotated.y+this._cam_axisZ.x*this._rotated.z,h.vectors[o].y=this._particle.position.y+this._cam_axisX.y*this._rotated.x+this._cam_axisY.y*this._rotated.y+this._cam_axisZ.y*this._rotated.z,h.vectors[o].z=this._particle.position.z+this._cam_axisX.z*this._rotated.x+this._cam_axisY.z*this._rotated.y+this._cam_axisZ.z*this._rotated.z;h._update(this.mesh._worldMatrix)}this._minBbox.x=this._particle._modelBoundingInfo.minimum.x*this._particle.scaling.x;this._minBbox.y=this._particle._modelBoundingInfo.minimum.y*this._particle.scaling.y;this._minBbox.z=this._particle._modelBoundingInfo.minimum.z*this._particle.scaling.z;this._maxBbox.x=this._particle._modelBoundingInfo.maximum.x*this._particle.scaling.x;this._maxBbox.y=this._particle._modelBoundingInfo.maximum.y*this._particle.scaling.y;this._maxBbox.z=this._particle._modelBoundingInfo.maximum.z*this._particle.scaling.z;c.center.x=this._particle.position.x+.5*(this._minBbox.x+this._maxBbox.x);c.center.y=this._particle.position.y+.5*(this._minBbox.y+this._maxBbox.y);c.center.z=this._particle.position.z+.5*(this._minBbox.z+this._maxBbox.z);c.radius=.5*this._bSphereRadiusFactor*Math.sqrt((this._maxBbox.x-this._minBbox.x)*(this._maxBbox.x-this._minBbox.x)+(this._maxBbox.y-this._minBbox.y)*(this._maxBbox.y-this._minBbox.y)+(this._maxBbox.z-this._minBbox.z)*(this._maxBbox.z-this._minBbox.z));c._update(this.mesh._worldMatrix)}v=u+3;y=e+4;p=s+2}if(r&&(this._computeParticleColor&&this.mesh.updateVerticesData(n.VertexBuffer.ColorKind,this._colors32,!1,!1),this._computeParticleTexture&&this.mesh.updateVerticesData(n.VertexBuffer.UVKind,this._uvs32,!1,!1),this.mesh.updateVerticesData(n.VertexBuffer.PositionKind,this._positions32,!1,!1),!this.mesh.areNormalsFrozen)){if(this._computeParticleVertex)for(n.VertexData.ComputeNormals(this._positions32,this._indices,this._normals32),l=0;l<this._normals32.length;l++)this._fixedNormal32[l]=this._normals32[l];this.mesh.updateVerticesData(n.VertexBuffer.NormalKind,this._normals32,!1,!1)}this._computeBoundingBox&&(this.mesh._boundingInfo=new n.BoundingInfo(this._minimum,this._maximum),this.mesh._boundingInfo.update(this.mesh._worldMatrix));this.afterUpdateParticles(t,i,r)}},t.prototype._quaternionRotationYPR=function(){this._halfroll=.5*this._roll;this._halfpitch=.5*this._pitch;this._halfyaw=.5*this._yaw;this._sinRoll=Math.sin(this._halfroll);this._cosRoll=Math.cos(this._halfroll);this._sinPitch=Math.sin(this._halfpitch);this._cosPitch=Math.cos(this._halfpitch);this._sinYaw=Math.sin(this._halfyaw);this._cosYaw=Math.cos(this._halfyaw);this._quaternion.x=this._cosYaw*this._sinPitch*this._cosRoll+this._sinYaw*this._cosPitch*this._sinRoll;this._quaternion.y=this._sinYaw*this._cosPitch*this._cosRoll-this._cosYaw*this._sinPitch*this._sinRoll;this._quaternion.z=this._cosYaw*this._cosPitch*this._sinRoll-this._sinYaw*this._sinPitch*this._cosRoll;this._quaternion.w=this._cosYaw*this._cosPitch*this._cosRoll+this._sinYaw*this._sinPitch*this._sinRoll},t.prototype._quaternionToRotationMatrix=function(){this._rotMatrix.m[0]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.z*this._quaternion.z);this._rotMatrix.m[1]=2*(this._quaternion.x*this._quaternion.y+this._quaternion.z*this._quaternion.w);this._rotMatrix.m[2]=2*(this._quaternion.z*this._quaternion.x-this._quaternion.y*this._quaternion.w);this._rotMatrix.m[3]=0;this._rotMatrix.m[4]=2*(this._quaternion.x*this._quaternion.y-this._quaternion.z*this._quaternion.w);this._rotMatrix.m[5]=1-2*(this._quaternion.z*this._quaternion.z+this._quaternion.x*this._quaternion.x);this._rotMatrix.m[6]=2*(this._quaternion.y*this._quaternion.z+this._quaternion.x*this._quaternion.w);this._rotMatrix.m[7]=0;this._rotMatrix.m[8]=2*(this._quaternion.z*this._quaternion.x+this._quaternion.y*this._quaternion.w);this._rotMatrix.m[9]=2*(this._quaternion.y*this._quaternion.z-this._quaternion.x*this._quaternion.w);this._rotMatrix.m[10]=1-2*(this._quaternion.y*this._quaternion.y+this._quaternion.x*this._quaternion.x);this._rotMatrix.m[11]=0;this._rotMatrix.m[12]=0;this._rotMatrix.m[13]=0;this._rotMatrix.m[14]=0;this._rotMatrix.m[15]=1},t.prototype.dispose=function(){this.mesh.dispose();this.vars=null;this._positions=null;this._indices=null;this._normals=null;this._uvs=null;this._colors=null;this._positions32=null;this._normals32=null;this._fixedNormal32=null;this._uvs32=null;this._colors32=null;this.pickedParticles=null},t.prototype.refreshVisibleSize=function(){this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo()},t.prototype.setVisibilityBox=function(t){var i=t/2;this.mesh._boundingInfo=new n.BoundingInfo(new n.Vector3(-i,-i,-i),new n.Vector3(i,i,i))},Object.defineProperty(t.prototype,"isAlwaysVisible",{get:function(){return this._alwaysVisible},set:function(n){this._alwaysVisible=n;this.mesh.alwaysSelectAsActiveMesh=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isVisibilityBoxLocked",{get:function(){return this._isVisibilityBoxLocked},set:function(n){this._isVisibilityBoxLocked=n;this.mesh.getBoundingInfo().isLocked=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleRotation",{get:function(){return this._computeParticleRotation},set:function(n){this._computeParticleRotation=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleColor",{get:function(){return this._computeParticleColor},set:function(n){this._computeParticleColor=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleTexture",{get:function(){return this._computeParticleTexture},set:function(n){this._computeParticleTexture=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"computeParticleVertex",{get:function(){return this._computeParticleVertex},set:function(n){this._computeParticleVertex=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"computeBoundingBox",{get:function(){return this._computeBoundingBox},set:function(n){this._computeBoundingBox=n},enumerable:!0,configurable:!0}),t.prototype.initParticles=function(){},t.prototype.recycleParticle=function(n){return n},t.prototype.updateParticle=function(n){return n},t.prototype.updateParticleVertex=function(n,t){return t},t.prototype.beforeUpdateParticles=function(){},t.prototype.afterUpdateParticles=function(){},t}();n.SolidParticleSystem=t}(i||(i={}));!function(n){var t;!function(t){var i=function(){function n(n,t,i,r){this.name=n;this.worldAxisForNormal=t;this.worldAxisForFileX=i;this.worldAxisForFileY=r}return n}(),r=function(){function t(){}return t.ConvertCubeMapToSphericalPolynomial=function(t){for(var u,i,l,p,w,f=new n.SphericalHarmonics,a=0,s=2/t.size,b=s,v=.5*s-1,h=0;h<6;h++)for(var e=this.FileFaces[h],c=t[e.name],o=v,r=0;r<t.size;r++){for(u=v,i=0;i<t.size;i++){l=e.worldAxisForFileX.scale(u).add(e.worldAxisForFileY.scale(o)).add(e.worldAxisForNormal);l.normalize();var y=Math.pow(1+u*u+o*o,-1.5),k=c[r*t.size*3+3*i+0],d=c[r*t.size*3+3*i+1],g=c[r*t.size*3+3*i+2],nt=new n.Color3(k,d,g);f.addLight(l,nt,y);a+=y;u+=s}o+=b}return p=4*Math.PI,w=p/a,f.scale(w),f.scale(1/Math.PI),n.SphericalPolynomial.getSphericalPolynomialFromHarmonics(f)},t.FileFaces=[new i("right",new n.Vector3(1,0,0),new n.Vector3(0,0,-1),new n.Vector3(0,-1,0)),new i("left",new n.Vector3(-1,0,0),new n.Vector3(0,0,1),new n.Vector3(0,-1,0)),new i("up",new n.Vector3(0,1,0),new n.Vector3(1,0,0),new n.Vector3(0,0,1)),new i("down",new n.Vector3(0,-1,0),new n.Vector3(1,0,0),new n.Vector3(0,0,-1)),new i("front",new n.Vector3(0,0,1),new n.Vector3(1,0,0),new n.Vector3(0,-1,0)),new i("back",new n.Vector3(0,0,-1),new n.Vector3(-1,0,0),new n.Vector3(0,-1,0))],t}();t.CubeMapToSphericalPolynomialTools=r}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t;!function(t){var i=function(){function t(){}return t.ConvertPanoramaToCubemap=function(n,t,i,r){if(!n)throw"ConvertPanoramaToCubemap: input cannot be null";if(n.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";var u=this.CreateCubemapTexture(r,this.FACE_FRONT,n,t,i),f=this.CreateCubemapTexture(r,this.FACE_BACK,n,t,i),e=this.CreateCubemapTexture(r,this.FACE_LEFT,n,t,i),o=this.CreateCubemapTexture(r,this.FACE_RIGHT,n,t,i),s=this.CreateCubemapTexture(r,this.FACE_UP,n,t,i),h=this.CreateCubemapTexture(r,this.FACE_DOWN,n,t,i);return{front:u,back:f,left:e,right:o,up:s,down:h,size:r}},t.CreateCubemapTexture=function(n,t,i,r,u){for(var l,h,v=new ArrayBuffer(n*n*12),o=new Float32Array(v),y=t[1].subtract(t[0]).scale(1/n),p=t[3].subtract(t[2]).scale(1/n),w=1/n,a=0,f=0;f<n;f++){for(var s=t[0],c=t[2],e=0;e<n;e++)l=c.subtract(s).scale(a).add(s),l.normalize(),h=this.CalcProjectionSpherical(l,i,r,u),o[f*n*3+3*e+0]=h.r,o[f*n*3+3*e+1]=h.g,o[f*n*3+3*e+2]=h.b,s=s.add(y),c=c.add(p);a+=w}return o},t.CalcProjectionSpherical=function(n,t,i,r){for(var o,c,u,e,f=Math.atan2(n.z,n.x),h=Math.acos(n.y);f<-Math.PI;)f+=2*Math.PI;for(;f>Math.PI;)f-=2*Math.PI;o=f/Math.PI;c=h/Math.PI;o=.5*o+.5;u=Math.round(o*i);u<0?u=0:u>=i&&(u=i-1);e=Math.round(c*r);e<0?e=0:e>=r&&(e=r-1);var s=r-e-1,l=t[s*i*3+3*u+0],a=t[s*i*3+3*u+1],v=t[s*i*3+3*u+2];return{r:l,g:a,b:v}},t.FACE_FRONT=[new n.Vector3(-1,-1,-1),new n.Vector3(1,-1,-1),new n.Vector3(-1,1,-1),new n.Vector3(1,1,-1)],t.FACE_BACK=[new n.Vector3(1,-1,1),new n.Vector3(-1,-1,1),new n.Vector3(1,1,1),new n.Vector3(-1,1,1)],t.FACE_RIGHT=[new n.Vector3(1,-1,-1),new n.Vector3(1,-1,1),new n.Vector3(1,1,-1),new n.Vector3(1,1,1)],t.FACE_LEFT=[new n.Vector3(-1,-1,1),new n.Vector3(-1,-1,-1),new n.Vector3(-1,1,1),new n.Vector3(-1,1,-1)],t.FACE_DOWN=[new n.Vector3(-1,1,-1),new n.Vector3(1,1,-1),new n.Vector3(-1,1,1),new n.Vector3(1,1,1)],t.FACE_UP=[new n.Vector3(-1,-1,1),new n.Vector3(1,-1,1),new n.Vector3(-1,-1,-1),new n.Vector3(1,-1,-1)],t}();t.PanoramaToCubeMapTools=i}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t;!function(n){var t=function(){function t(){}return t.Ldexp=function(n,t){return t>1023?n*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?n*Math.pow(2,-1074)*Math.pow(2,t+1074):n*Math.pow(2,t)},t.Rgbe2float=function(n,t,i,r,u,f){u>0?(u=this.Ldexp(1,u-136),n[f+0]=t*u,n[f+1]=i*u,n[f+2]=r*u):(n[f+0]=0,n[f+1]=0,n[f+2]=0)},t.readStringLine=function(n,t){for(var u="",i="",r=t;r<n.length-t&&(i=String.fromCharCode(n[r]),"\n"!=i);r++)u+=i;return u},t.RGBE_ReadHeader=function(n){var f=0,r=0,t=this.readStringLine(n,0),s,u;if("#"!=t[0]||"?"!=t[1])throw"Bad HDR Format.";var e=!1,o=!1,i=0;do i+=t.length+1,t=this.readStringLine(n,i),"FORMAT=32-bit_rle_rgbe"==t?o=!0:0==t.length&&(e=!0);while(!e);if(!o)throw"HDR Bad header format, unsupported FORMAT";if(i+=t.length+1,t=this.readStringLine(n,i),s=/^\-Y (.*) \+X (.*)$/g,u=s.exec(t),u.length<3)throw"HDR Bad header format, no size";if(r=parseInt(u[2]),f=parseInt(u[1]),r<8||r>32767)throw"HDR Bad header format, unsupported size";return i+=t.length+1,{height:f,width:r,dataPosition:i}},t.GetCubeMapTextureData=function(t,i){var u=new Uint8Array(t),r=this.RGBE_ReadHeader(u),f=this.RGBE_ReadPixels_RLE(u,r);return n.PanoramaToCubeMapTools.ConvertPanoramaToCubemap(f,r.width,r.height,i)},t.RGBE_ReadPixels=function(n,t){return this.RGBE_ReadPixels_RLE(n,t)},t.RGBE_ReadPixels_RLE=function(n,t){for(var y,u,e,c,l,r,v=t.height,f=t.width,o=t.dataPosition,s=0,a=0,i=0,w=new ArrayBuffer(4*f),h=new Uint8Array(w),b=new ArrayBuffer(t.width*t.height*12),p=new Float32Array(b);v>0;){if(u=n[o++],e=n[o++],c=n[o++],l=n[o++],2!=u||2!=e||128&c)throw"HDR Bad header format, not RLE";if((c<<8|l)!=f)throw"HDR Bad header format, wrong scan line width";for(s=0,i=0;i<4;i++)for(a=(i+1)*f;s<a;)if(u=n[o++],e=n[o++],u>128){if(r=u-128,0==r||r>a-s)throw"HDR Bad Format, bad scanline data (run)";for(;r-->0;)h[s++]=e}else{if(r=u,0==r||r>a-s)throw"HDR Bad Format, bad scanline data (non-run)";if(h[s++]=e,--r>0)for(y=0;y<r;y++)h[s++]=n[o++]}for(i=0;i<f;i++)u=h[i],e=h[i+f],c=h[i+2*f],l=h[i+3*f],this.Rgbe2float(p,u,e,c,l,(t.height-v)*f*3+3*i);v--}return p},t}();n.HDRTools=t}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t;!function(t){var i=function(){function t(){this.min=new n.Vector3(0,0,0);this.max=new n.Vector3(0,0,0);this.clear()}return t.prototype.clear=function(){this.min.x=t.MAX;this.min.y=t.MAX;this.min.z=t.MAX;this.max.x=t.MIN;this.max.y=t.MIN;this.max.z=t.MIN},t.prototype.augment=function(n,t,i){this.min.x=Math.min(this.min.x,n);this.min.y=Math.min(this.min.y,t);this.min.z=Math.min(this.min.z,i);this.max.x=Math.max(this.max.x,n);this.max.y=Math.max(this.max.y,t);this.max.z=Math.max(this.max.z,i)},t.prototype.clampMin=function(n,t,i){this.min.x=Math.max(this.min.x,n);this.min.y=Math.max(this.min.y,t);this.min.z=Math.max(this.min.z,i)},t.prototype.clampMax=function(n,t,i){this.max.x=Math.min(this.max.x,n);this.max.y=Math.min(this.max.y,t);this.max.z=Math.min(this.max.z,i)},t.prototype.empty=function(){return this.min.x>this.max.y||this.min.y>this.max.y||this.min.z>this.max.y},t.MAX=Number.MAX_VALUE,t.MIN=Number.MIN_VALUE,t}(),r=function(){function t(n,t,i,r,u,f,e,o,s,h){this.input=n;this.inputSize=t;this.outputSize=i;this.maxNumMipLevels=r;this.numChannels=u;this.isFloat=f;this.specularPower=e;this.cosinePowerDropPerMip=o;this.excludeBase=s;this.fixup=h;this._outputSurface=[];this._numMipLevels=0}return t.prototype.filterCubeMap=function(){return this.init(),this.filterCubeMapMipChain(),this._outputSurface},t.prototype.init=function(){var r,n,i;for(0==this.maxNumMipLevels&&(this.maxNumMipLevels=t.CP_MAX_MIPLEVELS),i=this.outputSize,n=0;n<this.maxNumMipLevels;n++){for(this._outputSurface.length++,this._outputSurface[n]=[],r=0;r<6;r++)this._outputSurface[n].length++,this._outputSurface[n][r]=this.isFloat?new Float32Array(i*i*this.numChannels):new Uint32Array(i*i*this.numChannels);if(i>>=1,this._numMipLevels++,0==i)return void(this.maxNumMipLevels=n)}},t.prototype.filterCubeMapMipChain=function(){var t=this.specularPower,n;for(this.precomputeFilterLookupTables(this.inputSize),n=0;n<this._numMipLevels;n++){this.excludeBase&&0==n&&(t=1e5);var u=this.input,i=this._outputSurface[n],r=this.outputSize>>n,f=this.getBaseFilterAngle(t);this.filterCubeSurfaces(u,this.inputSize,i,r,f,t);this.fixup&&this.fixupCubeEdges(i,r);this.excludeBase&&0==n&&(t=this.specularPower);t*=this.cosinePowerDropPerMip}},t.prototype.getBaseFilterAngle=function(n){var t=180;return t=Math.acos(Math.pow(1e-6,1/n)),t*=180/Math.PI,t*2},t.prototype.precomputeFilterLookupTables=function(n){this._normCubeMap=[];this.buildNormalizerSolidAngleCubemap(n)},t.prototype.buildNormalizerSolidAngleCubemap=function(n){for(var i,r,u,f,t=0;t<6;t++)for(this._normCubeMap.push(new Float32Array(n*n*4)),this.input[t],r=0;r<n;r++)for(i=0;i<n;i++)u=this.texelCoordToVect(t,i,r,n,this.fixup),this._normCubeMap[t][4*(r*n+i)+0]=u.x,this._normCubeMap[t][4*(r*n+i)+1]=u.y,this._normCubeMap[t][4*(r*n+i)+2]=u.z,f=this.texelCoordSolidAngle(t,i,r,n),this._normCubeMap[t][4*(r*n+i)+4]=f},t.prototype.texelCoordToVect=function(n,i,r,u,f){var e,o,l,s,h,c;return(e=2*(i+.5)/u-1,o=2*(r+.5)/u-1,f&&u>1)&&(l=Math.pow(u,2)/Math.pow(u-1,3),e=l*Math.pow(e,3)+e,o=l*Math.pow(o,3)+o),s=t._sgFace2DMapping[n][t.CP_UDIR],t._vectorTemp.x=s[0]*e,t._vectorTemp.y=s[1]*e,t._vectorTemp.z=s[2]*e,h=t._sgFace2DMapping[n][t.CP_VDIR],t._vectorTemp.x+=h[0]*o,t._vectorTemp.y+=h[1]*o,t._vectorTemp.z+=h[2]*o,c=t._sgFace2DMapping[n][t.CP_FACEAXIS],t._vectorTemp.x+=c[0],t._vectorTemp.y+=c[1],t._vectorTemp.z+=c[2],t._vectorTemp.normalize(),t._vectorTemp},t.prototype.vectToTexelCoord=function(n,i,r,u){var o,e,s=Math.abs(n),h=Math.abs(i),l=Math.abs(r),c,f,a;s>=h&&s>=l?(o=s,e=n>=0?t.CP_FACE_X_POS:t.CP_FACE_X_NEG):h>=s&&h>=l?(o=h,e=i>=0?t.CP_FACE_Y_POS:t.CP_FACE_Y_NEG):(o=l,e=r>=0?t.CP_FACE_Z_POS:t.CP_FACE_Z_NEG);c=1/o;n*=c;i*=c;r*=c;f=t._sgFace2DMapping[e][t.CP_UDIR];a=f[0]*n+f[1]*i+f[2]*r;f=t._sgFace2DMapping[e][t.CP_VDIR];var v=f[0]*n+f[1]*i+f[2]*r,y=Math.floor(.5*(u-1)*(a+1)),p=Math.floor(.5*(u-1)*(v+1));return t._vectorTemp.x=e,t._vectorTemp.y=y,t._vectorTemp.z=p,t._vectorTemp},t.prototype.areaElement=function(n,t){return Math.atan2(n*t,Math.sqrt(n*n+t*t+1))},t.prototype.texelCoordSolidAngle=function(n,t,i,r){t=2*(t+.5)/r-1;i=2*(i+.5)/r-1;var u=1/r,f=t-u,e=i-u,o=t+u,s=i+u;return this.areaElement(f,e)-this.areaElement(f,s)-this.areaElement(o,e)+this.areaElement(o,s)},t.prototype.filterCubeSurfaces=function(n,t,r,u,f,e){for(var s,h,l=[],a,c,v,w,p,y,o=0;o<6;o++)l.push(new i);for(a=180/Math.PI*Math.atan2(1,t),c=f/2,c<a&&(c=a),c>90&&(c=90),v=Math.ceil(c/a),v<1&&(v=1),w=Math.cos(Math.PI/180*c),o=0;o<6;o++)for(h=0;h<u;h++)for(s=0;s<u;s++)p=this.texelCoordToVect(o,s,h,u,this.fixup).clone(),this.clearFilterExtents(l),this.determineFilterExtents(p,t,v,l),y=this.processFilterExtents(p,w,l,n,t,e),r[o][(h*u+s)*this.numChannels+0]=y.x,r[o][(h*u+s)*this.numChannels+1]=y.y,r[o][(h*u+s)*this.numChannels+2]=y.z},t.prototype.clearFilterExtents=function(n){for(var t=0;t<6;t++)n[t].clear()},t.prototype.determineFilterExtents=function(n,i,r,u){var o,y,l,s=[0,0,0,0],h=[0,0,0,0],c=[0,0,0,0],p=this.vectToTexelCoord(n.x,n.y,n.z,i),e=p.x,a=p.y,v=p.z,f;u[e].augment(a-r,v-r,0);u[e].augment(a+r,v+r,0);u[e].clampMin(0,0,0);u[e].clampMax(i-1,i-1,0);var w=u[e].min.x,b=u[e].min.y,k=u[e].max.x,d=u[e].max.y;for(s[0]=r-a,h[0]=b,c[0]=d,s[1]=a+r-(i-1),h[1]=b,c[1]=d,s[2]=r-v,h[2]=w,c[2]=k,s[3]=v+r-(i-1),h[3]=w,c[3]=k,f=0;f<4;f++){if(s[f]>0){switch(o=t._sgCubeNgh[e][f][0],y=t._sgCubeNgh[e][f][1],f!=y&&f+y!=3||(h[f]=i-1-h[f],c[f]=i-1-c[f]),t._sgCubeNgh[e][f][1]){case t.CP_EDGE_LEFT:u[o].augment(0,h[f],0);u[o].augment(s[f],c[f],0);break;case t.CP_EDGE_RIGHT:u[o].augment(i-1,h[f],0);u[o].augment(i-1-s[f],c[f],0);break;case t.CP_EDGE_TOP:u[o].augment(h[f],0,0);u[o].augment(c[f],s[f],0);break;case t.CP_EDGE_BOTTOM:u[o].augment(h[f],i-1,0);u[o].augment(c[f],i-1-s[f],0)}u[o].clampMin(0,0,0);u[o].clampMax(i-1,i-1,0)}if(s[f]>i){switch(e){case t.CP_FACE_X_POS:l=t.CP_FACE_X_NEG;break;case t.CP_FACE_X_NEG:l=t.CP_FACE_X_POS;break;case t.CP_FACE_Y_POS:l=t.CP_FACE_Y_NEG;break;case t.CP_FACE_Y_NEG:l=t.CP_FACE_Y_POS;break;case t.CP_FACE_Z_POS:l=t.CP_FACE_Z_NEG;break;case t.CP_FACE_Z_NEG:l=t.CP_FACE_Z_POS}u[l].augment(0,0,0);u[l].augment(i-1,i-1,0)}}},t.prototype.processFilterExtents=function(n,i,r,u,f,e){for(var p,o,c=[0,0,0,0],h=0,v=0,g=this.numChannels,y=f,rt=4*y,ut=y*this.numChannels,s=0;s<6;s++)if(!r[s].empty())for(var w=r[s].min.x,b=r[s].min.y,ft=r[s].max.x,et=r[s].max.y,l=4*(b*y+w),nt=this.numChannels*(b*y+w),tt=b;tt<=et;tt++){for(var a=0,k=0,it=w;it<=ft;it++){var ot=this._normCubeMap[s][l+a+0],st=this._normCubeMap[s][l+a+1],ht=this._normCubeMap[s][l+a+2],d=ot*n.x+st*n.y+ht*n.z;if(d>=i&&d>0){for(p=this._normCubeMap[s][l+a+3],p*=Math.pow(d,e+1),v=0;v<g;v++)c[v]+=p*u[s][nt+k],k++;h+=p}else k+=g;a+=4}l+=rt;nt+=ut}return 0!=h?(t._vectorTemp.x=c[0]/h,t._vectorTemp.y=c[1]/h,t._vectorTemp.z=c[2]/h,this.numChannels>3&&(t._vectorTemp.w=c[3]/h)):(o=this.vectToTexelCoord(n.x,n.y,n.z,f).clone(),t._vectorTemp.x=u[o.x][this.numChannels*(o.z*f+o.y)+0],t._vectorTemp.y=u[o.x][this.numChannels*(o.z*f+o.y)+1],t._vectorTemp.z=u[o.x][this.numChannels*(o.z*f+o.y)+2],this.numChannels>3&&(t._vectorTemp.z=u[o.x][this.numChannels*(o.z*f+o.y)+3])),t._vectorTemp},t.prototype.fixupCubeEdges=function(n,i){var r,d,f,u,e=0,g=[0,0,0,0,0,0,0,0],l=[[],[],[],[]],a=[[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]],[[],[],[]]],y,p,k;if(!(i<1))if(1!=i){for(u=0;u<6;u++)for(l[0]=[u,0],l[1]=[u,(i-1)*this.numChannels],l[2]=[u,i*(i-1)*this.numChannels],l[3]=[u,(i*(i-1)+(i-1))*this.numChannels],e=0;e<4;e++)y=t._sgCubeCornerList[u][e],a[y][g[y]]=l[e],g[y]++;for(e=0;e<8;e++)for(r=0;r<this.numChannels;r++){for(p=0,f=0;f<3;f++)p+=n[a[e][f][0]][a[e][f][1]+r];for(p*=1/3,f=0;f<3;f++)n[a[e][f][0]][a[e][f][1]+r]=p}for(f=0;f<12;f++){var w=t._sgCubeEdgeList[f][0],v=t._sgCubeEdgeList[f][1],nt=t._sgCubeNgh[w][v][0],b=t._sgCubeNgh[w][v][1],h=0,o=0,c=0,s=0;switch(v){case t.CP_EDGE_LEFT:c=this.numChannels*i;break;case t.CP_EDGE_RIGHT:h+=(i-1)*this.numChannels;c=this.numChannels*i;break;case t.CP_EDGE_TOP:c=this.numChannels;break;case t.CP_EDGE_BOTTOM:h+=i*(i-1)*this.numChannels;c=this.numChannels}if(v==b||v+b==3)switch(b){case t.CP_EDGE_LEFT:o+=(i-1)*i*this.numChannels;s=-(this.numChannels*i);break;case t.CP_EDGE_RIGHT:o+=((i-1)*i+(i-1))*this.numChannels;s=-(this.numChannels*i);break;case t.CP_EDGE_TOP:o+=(i-1)*this.numChannels;s=-this.numChannels;break;case t.CP_EDGE_BOTTOM:o+=((i-1)*i+(i-1))*this.numChannels;s=-this.numChannels}else switch(b){case t.CP_EDGE_LEFT:s=this.numChannels*i;break;case t.CP_EDGE_RIGHT:o+=(i-1)*this.numChannels;s=this.numChannels*i;break;case t.CP_EDGE_TOP:s=this.numChannels;break;case t.CP_EDGE_BOTTOM:o+=i*(i-1)*this.numChannels;s=this.numChannels}for(h+=c,o+=s,d=1;d<i-1;d++){for(r=0;r<this.numChannels;r++){var it=n[w][h+r],rt=n[nt][o+r],tt=.5*(it+rt);n[w][h+r]=tt;n[nt][o+r]=tt}h+=c;o+=s}}}else for(r=0;r<this.numChannels;r++){for(k=0,u=0;u<6;u++)k+=n[u][r];for(k/=6,u=0;u<6;u++)n[u][r]=k}},t.CP_MAX_MIPLEVELS=16,t.CP_UDIR=0,t.CP_VDIR=1,t.CP_FACEAXIS=2,t.CP_FACE_X_POS=0,t.CP_FACE_X_NEG=1,t.CP_FACE_Y_POS=2,t.CP_FACE_Y_NEG=3,t.CP_FACE_Z_POS=4,t.CP_FACE_Z_NEG=5,t.CP_EDGE_LEFT=0,t.CP_EDGE_RIGHT=1,t.CP_EDGE_TOP=2,t.CP_EDGE_BOTTOM=3,t.CP_CORNER_NNN=0,t.CP_CORNER_NNP=1,t.CP_CORNER_NPN=2,t.CP_CORNER_NPP=3,t.CP_CORNER_PNN=4,t.CP_CORNER_PNP=5,t.CP_CORNER_PPN=6,t.CP_CORNER_PPP=7,t._vectorTemp=new n.Vector4(0,0,0,0),t._sgFace2DMapping=[[[0,0,-1],[0,-1,0],[1,0,0]],[[0,0,1],[0,-1,0],[-1,0,0]],[[1,0,0],[0,0,1],[0,1,0]],[[1,0,0],[0,0,-1],[0,-1,0]],[[1,0,0],[0,-1,0],[0,0,1]],[[-1,0,0],[0,-1,0],[0,0,-1]]],t._sgCubeNgh=[[[t.CP_FACE_Z_POS,t.CP_EDGE_RIGHT],[t.CP_FACE_Z_NEG,t.CP_EDGE_LEFT],[t.CP_FACE_Y_POS,t.CP_EDGE_RIGHT],[t.CP_FACE_Y_NEG,t.CP_EDGE_RIGHT]],[[t.CP_FACE_Z_NEG,t.CP_EDGE_RIGHT],[t.CP_FACE_Z_POS,t.CP_EDGE_LEFT],[t.CP_FACE_Y_POS,t.CP_EDGE_LEFT],[t.CP_FACE_Y_NEG,t.CP_EDGE_LEFT]],[[t.CP_FACE_X_NEG,t.CP_EDGE_TOP],[t.CP_FACE_X_POS,t.CP_EDGE_TOP],[t.CP_FACE_Z_NEG,t.CP_EDGE_TOP],[t.CP_FACE_Z_POS,t.CP_EDGE_TOP]],[[t.CP_FACE_X_NEG,t.CP_EDGE_BOTTOM],[t.CP_FACE_X_POS,t.CP_EDGE_BOTTOM],[t.CP_FACE_Z_POS,t.CP_EDGE_BOTTOM],[t.CP_FACE_Z_NEG,t.CP_EDGE_BOTTOM]],[[t.CP_FACE_X_NEG,t.CP_EDGE_RIGHT],[t.CP_FACE_X_POS,t.CP_EDGE_LEFT],[t.CP_FACE_Y_POS,t.CP_EDGE_BOTTOM],[t.CP_FACE_Y_NEG,t.CP_EDGE_TOP]],[[t.CP_FACE_X_POS,t.CP_EDGE_RIGHT],[t.CP_FACE_X_NEG,t.CP_EDGE_LEFT],[t.CP_FACE_Y_POS,t.CP_EDGE_TOP],[t.CP_FACE_Y_NEG,t.CP_EDGE_BOTTOM]]],t._sgCubeEdgeList=[[t.CP_FACE_X_POS,t.CP_EDGE_LEFT],[t.CP_FACE_X_POS,t.CP_EDGE_RIGHT],[t.CP_FACE_X_POS,t.CP_EDGE_TOP],[t.CP_FACE_X_POS,t.CP_EDGE_BOTTOM],[t.CP_FACE_X_NEG,t.CP_EDGE_LEFT],[t.CP_FACE_X_NEG,t.CP_EDGE_RIGHT],[t.CP_FACE_X_NEG,t.CP_EDGE_TOP],[t.CP_FACE_X_NEG,t.CP_EDGE_BOTTOM],[t.CP_FACE_Z_POS,t.CP_EDGE_TOP],[t.CP_FACE_Z_POS,t.CP_EDGE_BOTTOM],[t.CP_FACE_Z_NEG,t.CP_EDGE_TOP],[t.CP_FACE_Z_NEG,t.CP_EDGE_BOTTOM]],t._sgCubeCornerList=[[t.CP_CORNER_PPP,t.CP_CORNER_PPN,t.CP_CORNER_PNP,t.CP_CORNER_PNN],[t.CP_CORNER_NPN,t.CP_CORNER_NPP,t.CP_CORNER_NNN,t.CP_CORNER_NNP],[t.CP_CORNER_NPN,t.CP_CORNER_PPN,t.CP_CORNER_NPP,t.CP_CORNER_PPP],[t.CP_CORNER_NNP,t.CP_CORNER_PNP,t.CP_CORNER_NNN,t.CP_CORNER_PNN],[t.CP_CORNER_NPP,t.CP_CORNER_PPP,t.CP_CORNER_NNP,t.CP_CORNER_PNP],[t.CP_CORNER_PPN,t.CP_CORNER_NPN,t.CP_CORNER_PNN,t.CP_CORNER_NNN]],t}();t.PMREMGenerator=r}(t=n.Internals||(n.Internals={}))}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e,o,s){void 0===f&&(f=!1);void 0===e&&(e=!0);void 0===o&&(o=!1);void 0===s&&(s=!1);t.call(this,r);this._useInGammaSpace=!1;this._generateHarmonics=!0;this._isBABYLONPreprocessed=!1;this.coordinatesMode=n.Texture.CUBIC_MODE;this.sphericalPolynomial=null;this.isPMREM=!1;i&&(this.name=i,this.url=i,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=n.Matrix.Identity(),u?(this._isBABYLONPreprocessed=!1,this._noMipmap=f,this._size=u,this._useInGammaSpace=o,this._usePMREMGenerator=s&&r.getEngine().getCaps().textureLOD&&this.getScene().getEngine().getCaps().textureFloat&&!this._useInGammaSpace):(this._isBABYLONPreprocessed=!0,this._noMipmap=!1,this._useInGammaSpace=!1,this._usePMREMGenerator=r.getEngine().getCaps().textureLOD&&this.getScene().getEngine().getCaps().textureFloat&&!this._useInGammaSpace),this.isPMREM=this._usePMREMGenerator,this._texture=this._getFromCache(i,this._noMipmap),this._texture||(r.useDelayedTextureLoading?this.delayLoadState=n.Engine.DELAYLOADSTATE_NOTLOADED:this.loadTexture()))}return u(i,t),i.prototype.loadBabylonTexture=function(){var i=this,r=0,t=null,u=!this._useInGammaSpace&&this.getScene().getEngine().getCaps().textureFloat?function(){for(var e,o,s,u=[],f=30,n=0;n<r;n++)for(u.push([]),e=3*Math.pow(i._size>>n,2),o=0;o<6;o++)s=t.subarray(f,f+e),u[n].push(s),f+=e;return u}:null,f=function(f){var l=new Int32Array(f),o,g,nt,e,c;t=new Float32Array(f);l[0];i._size=l[1];i.getScene().getEngine().updateTextureSize(i._texture,i._size,i._size);i.sphericalPolynomial=new n.SphericalPolynomial;i.sphericalPolynomial.x.copyFromFloats(t[2],t[3],t[4]);i.sphericalPolynomial.y.copyFromFloats(t[5],t[6],t[7]);i.sphericalPolynomial.z.copyFromFloats(t[8],t[9],t[10]);i.sphericalPolynomial.xx.copyFromFloats(t[11],t[12],t[13]);i.sphericalPolynomial.yy.copyFromFloats(t[14],t[15],t[16]);i.sphericalPolynomial.zz.copyFromFloats(t[17],t[18],t[19]);i.sphericalPolynomial.xy.copyFromFloats(t[20],t[21],t[22]);i.sphericalPolynomial.yz.copyFromFloats(t[23],t[24],t[25]);i.sphericalPolynomial.zx.copyFromFloats(t[26],t[27],t[28]);r=l[29];for(var a=30,v=[],y=3*Math.pow(i._size,2),d=0;d<6;d++)v.push(t.subarray(a,a+y)),a+=y;for(var p=[],s=null,h=0;h<6;h++){if(o=null,u)o=v[h];else for(g=[0,2,4,1,3,5][h],(o=v[g],i.getScene().getEngine().getCaps().textureFloat)||(nt=new ArrayBuffer(y),s=new Uint8Array(nt)),e=0;e<i._size*i._size;e++)if(i._useInGammaSpace&&(o[3*e+0]=Math.pow(o[3*e+0],n.ToGammaSpace),o[3*e+1]=Math.pow(o[3*e+1],n.ToGammaSpace),o[3*e+2]=Math.pow(o[3*e+2],n.ToGammaSpace)),s){var w=Math.max(255*o[3*e+0],0),b=Math.max(255*o[3*e+1],0),k=Math.max(255*o[3*e+2],0),tt=Math.max(Math.max(w,b),k);tt>255&&(c=255/tt,w*=c,b*=c,k*=c);s[3*e+0]=w;s[3*e+1]=b;s[3*e+2]=k}s?p.push(s):p.push(o)}return p};this._texture=this.getScene().getEngine().createRawCubeTexture(this.url,this.getScene(),this._size,n.Engine.TEXTUREFORMAT_RGB,this.getScene().getEngine().getCaps().textureFloat?n.Engine.TEXTURETYPE_FLOAT:n.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,f,u)},i.prototype.loadHDRTexture=function(){var t=this,u=function(r){var v=n.Internals.HDRTools.GetCubeMapTextureData(r,t._size),y,f,u,o;t._generateHarmonics&&(t.sphericalPolynomial=n.Internals.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial(v));for(var s=[],e=null,h=0;h<6;h++){if(t.getScene().getEngine().getCaps().textureFloat||(y=new ArrayBuffer(t._size*t._size*3),e=new Uint8Array(y)),f=v[i._facesMapping[h]],t._useInGammaSpace||e)for(u=0;u<t._size*t._size;u++)if(t._useInGammaSpace&&(f[3*u+0]=Math.pow(f[3*u+0],n.ToGammaSpace),f[3*u+1]=Math.pow(f[3*u+1],n.ToGammaSpace),f[3*u+2]=Math.pow(f[3*u+2],n.ToGammaSpace)),e){var c=Math.max(255*f[3*u+0],0),l=Math.max(255*f[3*u+1],0),a=Math.max(255*f[3*u+2],0),p=Math.max(Math.max(c,l),a);p>255&&(o=255/p,c*=o,l*=o,a*=o);e[3*u+0]=c;e[3*u+1]=l;e[3*u+2]=a}e?s.push(e):s.push(f)}return s},r=null;!this._noMipmap&&this._usePMREMGenerator&&(r=function(i){var r=new n.Internals.PMREMGenerator(i,t._size,t._size,0,3,t.getScene().getEngine().getCaps().textureFloat,2048,.25,!1,!0);return r.filterCubeMap()});this._texture=this.getScene().getEngine().createRawCubeTexture(this.url,this.getScene(),this._size,n.Engine.TEXTUREFORMAT_RGB,this.getScene().getEngine().getCaps().textureFloat?n.Engine.TEXTURETYPE_FLOAT:n.Engine.TEXTURETYPE_UNSIGNED_INT,this._noMipmap,u,r)},i.prototype.loadTexture=function(){this._isBABYLONPreprocessed?this.loadBabylonTexture():this.loadHDRTexture()},i.prototype.clone=function(){var t=this._isBABYLONPreprocessed?null:this._size,n=new i(this.url,this.getScene(),t,this._noMipmap,this._generateHarmonics,this._useInGammaSpace,this._usePMREMGenerator);return n.level=this.level,n.wrapU=this.wrapU,n.wrapV=this.wrapV,n.coordinatesIndex=this.coordinatesIndex,n.coordinatesMode=this.coordinatesMode,n},i.prototype.delayLoad=function(){this.delayLoadState===n.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=n.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this.loadTexture())},i.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},i.Parse=function(t,i,r){var u=null,f;return t.name&&!t.isRenderTarget&&(f=t.isBABYLONPreprocessed?null:t.size,u=new n.HDRCubeTexture(r+t.name,i,f,t.generateHarmonics,t.useInGammaSpace,t.usePMREMGenerator),u.name=t.name,u.hasAlpha=t.hasAlpha,u.level=t.level,u.coordinatesMode=t.coordinatesMode),u},i.prototype.serialize=function(){if(!this.name)return null;var n={};return n.name=this.name,n.hasAlpha=this.hasAlpha,n.isCube=!0,n.level=this.level,n.size=this._size,n.coordinatesMode=this.coordinatesMode,n.useInGammaSpace=this._useInGammaSpace,n.generateHarmonics=this._generateHarmonics,n.usePMREMGenerator=this._usePMREMGenerator,n.isBABYLONPreprocessed=this._isBABYLONPreprocessed,n.customType="BABYLON.HDRCubeTexture",n},i.generateBabylonHDROnDisk=function(n,t,r){void 0===r&&(r=null);var u=function(n){var i=new Blob([n],{type:"application/octet-stream"}),r=window.URL.createObjectURL(i),t=document.createElement("a");document.body.appendChild(t);t.style.display="none";t.href=r;t.download="envmap.babylon.hdr";t.click()};i.generateBabylonHDR(n,t,u,r)},i.generateBabylonHDR=function(t,i,r,u){if((void 0===u&&(u=null),!t)||!n.Tools.IsExponentOfTwo(i))return null;var f=function(t){var o=n.Internals.HDRTools.GetCubeMapTextureData(t,i),f=n.Internals.CubeMapToSphericalPolynomialTools.ConvertCubeMapToSphericalPolynomial(o),s=[],a,p,e,w,l;s.push(o.right);s.push(o.left);s.push(o.up);s.push(o.down);s.push(o.front);s.push(o.back);var b=new n.Internals.PMREMGenerator(s,i,i,0,3,!0,2048,.25,!1,!0),c=b.filterCubeMap(),h=4;for(h+=4,h+=108,h+=4,e=0;e<c.length;e++)a=i>>e,h+=6*a*a*12;var v=new ArrayBuffer(h),y=new Int32Array(v),u=new Float32Array(v);for(y[0]=1,y[1]=i,f.x.toArray(u,2),f.y.toArray(u,5),f.z.toArray(u,8),f.xx.toArray(u,11),f.yy.toArray(u,14),f.zz.toArray(u,17),f.xy.toArray(u,20),f.yz.toArray(u,23),f.zx.toArray(u,26),y[29]=c.length,p=30,e=0;e<c.length;e++)for(w=3*Math.pow(i>>e,2),l=0;l<6;l++)u.set(c[e][l],p),p+=w;r(v)};n.Tools.LoadFile(t,function(n){f(n)},null,null,!0,u)},i._facesMapping=["right","up","front","left","down","back"],i}(n.BaseTexture);n.HDRCubeTexture=t}(i||(i={}));!function(n){var t;!function(t){var i=function(){function t(t,i,r,u,f){void 0===u&&(u=!0);void 0===f&&(f=1);this.skeleton=t;this.mesh=i;this.autoUpdateBonesMatrices=u;this.renderingGroupId=f;this.color=n.Color3.White();this._debugLines=[];this._isEnabled=!1;this._scene=r;this.update();this._renderFunction=this.update.bind(this)}return Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(n){this._isEnabled!==n&&(this._isEnabled=n,n?this._scene.registerBeforeRender(this._renderFunction):this._scene.unregisterBeforeRender(this._renderFunction))},enumerable:!0,configurable:!0}),t.prototype._getBonePosition=function(t,i,r,u,f,e){var o,h,s;void 0===u&&(u=0);void 0===f&&(f=0);void 0===e&&(e=0);o=n.Tmp.Matrix[0];h=i.getParent();(o.copyFrom(i.getLocalMatrix()),0!==u||0!==f||0!==e)&&(s=n.Tmp.Matrix[1],n.Matrix.IdentityToRef(s),s.m[12]=u,s.m[13]=f,s.m[14]=e,s.multiplyToRef(o,o));h&&o.multiplyToRef(h.getAbsoluteTransform(),o);o.multiplyToRef(r,o);t.x=o.m[12];t.y=o.m[13];t.z=o.m[14]},t.prototype._getLinesForBonesWithLength=function(t,i){for(var f,u,e=t.length,r=0;r<e;r++)f=t[r],u=this._debugLines[r],u||(u=[n.Vector3.Zero(),n.Vector3.Zero()],this._debugLines[r]=u),this._getBonePosition(u[0],f,i),this._getBonePosition(u[1],f,i,0,f.length,0)},t.prototype._getLinesForBonesNoLength=function(t){for(var f,e,i,o=t.length,r=0,u=o-1;u>=0;u--)f=t[u],e=f.getParent(),e&&(i=this._debugLines[r],i||(i=[n.Vector3.Zero(),n.Vector3.Zero()],this._debugLines[r]=i),f.getAbsolutePositionToRef(this.mesh,i[0]),e.getAbsolutePositionToRef(this.mesh,i[1]),r++)},t.prototype.update=function(){this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteTransforms();void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones,this.mesh.getWorldMatrix()):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh.getWorldMatrix());this._debugMesh?n.MeshBuilder.CreateLineSystem(null,{lines:this._debugLines,updatable:!0,instance:this._debugMesh},this._scene):(this._debugMesh=n.MeshBuilder.CreateLineSystem(null,{lines:this._debugLines,updatable:!0},this._scene),this._debugMesh.renderingGroupId=this.renderingGroupId);this._debugMesh.color=this.color},t.prototype.dispose=function(){this._debugMesh&&(this.isEnabled=!1,this._debugMesh.dispose(),this._debugMesh=null)},t}();t.SkeletonViewer=i}(t=n.Debug||(n.Debug={}))}(i||(i={}));!function(n){var t;!function(t){var i=function(){function t(t,i){void 0===i&&(i=1);this._xline=[n.Vector3.Zero(),n.Vector3.Zero()];this._yline=[n.Vector3.Zero(),n.Vector3.Zero()];this._zline=[n.Vector3.Zero(),n.Vector3.Zero()];this.scaleLines=1;this.scaleLines=i;this._xmesh=n.Mesh.CreateLines("xline",this._xline,t,!0);this._ymesh=n.Mesh.CreateLines("yline",this._yline,t,!0);this._zmesh=n.Mesh.CreateLines("zline",this._zline,t,!0);this._xmesh.renderingGroupId=2;this._ymesh.renderingGroupId=2;this._zmesh.renderingGroupId=2;this._xmesh.material.checkReadyOnlyOnce=!0;this._xmesh.color=new n.Color3(1,0,0);this._ymesh.material.checkReadyOnlyOnce=!0;this._ymesh.color=new n.Color3(0,1,0);this._zmesh.material.checkReadyOnlyOnce=!0;this._zmesh.color=new n.Color3(0,0,1);this.scene=t}return t.prototype.update=function(t,i,r,u){var o=this.scaleLines,f=this._xline[0],e=this._xline[1];f.x=t.x;f.y=t.y;f.z=t.z;e.x=f.x+i.x*o;e.y=f.y+i.y*o;e.z=f.z+i.z*o;n.Mesh.CreateLines(null,this._xline,null,null,this._xmesh);f=this._yline[0];e=this._yline[1];f.x=t.x;f.y=t.y;f.z=t.z;e.x=f.x+r.x*o;e.y=f.y+r.y*o;e.z=f.z+r.z*o;n.Mesh.CreateLines(null,this._yline,null,null,this._ymesh);f=this._zline[0];e=this._zline[1];f.x=t.x;f.y=t.y;f.z=t.z;e.x=f.x+u.x*o;e.y=f.y+u.y*o;e.z=f.z+u.z*o;n.Mesh.CreateLines(null,this._zline,null,null,this._zmesh)},t.prototype.dispose=function(){this._xmesh&&(this._xmesh.dispose(),this._ymesh.dispose(),this._zmesh.dispose(),this._xmesh=null,this._ymesh=null,this._zmesh=null,this._xline=null,this._yline=null,this._zline=null,this.scene=null)},t}();t.AxesViewer=i}(t=n.Debug||(n.Debug={}))}(i||(i={}));!function(n){var t;!function(t){var i=function(t){function i(i,r,u,f){void 0===f&&(f=1);t.call(this,i,f);this.pos=n.Vector3.Zero();this.xaxis=n.Vector3.Zero();this.yaxis=n.Vector3.Zero();this.zaxis=n.Vector3.Zero();this.mesh=u;this.bone=r}return u(i,t),i.prototype.update=function(){var i=this.bone;i.getAbsolutePositionToRef(this.mesh,this.pos);i.getDirectionToRef(n.Axis.X,this.mesh,this.xaxis);i.getDirectionToRef(n.Axis.Y,this.mesh,this.yaxis);i.getDirectionToRef(n.Axis.Z,this.mesh,this.zaxis);t.prototype.update.call(this,this.pos,this.xaxis,this.yaxis,this.zaxis)},i.prototype.dispose=function(){this.pos&&(this.pos=null,this.xaxis=null,this.yaxis=null,this.zaxis=null,this.mesh=null,this.bone=null,t.prototype.dispose.call(this))},i}(t.AxesViewer);t.BoneAxesViewer=i}(t=n.Debug||(n.Debug={}))}(i||(i={}));!function(n){var t=function(t){function i(i,r){t.call(this,r);i&&(this._textureMatrix=n.Matrix.Identity(),this.name=i,this.url=i,this.hasAlpha=!1,this.isCube=!1,this.wrapU=n.Texture.CLAMP_ADDRESSMODE,this.wrapV=n.Texture.CLAMP_ADDRESSMODE,this.anisotropicFilteringLevel=1,this._texture=this._getFromCache(i,!0),this._texture||(r.useDelayedTextureLoading?this.delayLoadState=n.Engine.DELAYLOADSTATE_NOTLOADED:this.loadTexture()))}return u(i,t),i.prototype.getTextureMatrix=function(){return this._textureMatrix},i.prototype.load3dlTexture=function(){var r=this,t=this.getScene().getEngine().createRawTexture(null,1,1,n.Engine.TEXTUREFORMAT_RGBA,!1,!1,n.Texture.BILINEAR_SAMPLINGMODE),u;return this._texture=t,u=function(u){for(var h,c,g,y,o,l,p=u.split("\n"),f=0,w=0,a=0,v=0,s=0,e=0;e<p.length;e++)if(l=p[e],i._noneEmptyLineRegex.test(l)&&0!==l.indexOf("#"))if(h=l.split(" "),0!==f){if(0!=f){var b=Math.max(parseInt(h[0]),0),k=Math.max(parseInt(h[1]),0),d=Math.max(parseInt(h[2]),0);s=Math.max(b,s);s=Math.max(k,s);s=Math.max(d,s);c=4*(w+v*f+a*f*f);o[c+0]=b;o[c+1]=k;o[c+2]=d;o[c+3]=0;v++;v%f==0&&(a++,v=0,a%f==0&&(w++,a=0))}}else f=h.length,y=new Uint8Array(f*f*f*4),o=new Float32Array(f*f*f*4);for(e=0;e<o.length;e++)g=o[e],y[e]=g/s*255;r.getScene().getEngine().updateTextureSize(t,f*f,f);r.getScene().getEngine().updateRawTexture(t,y,n.Engine.TEXTUREFORMAT_RGBA,!1)},n.Tools.LoadFile(this.url,u),this._texture},i.prototype.loadTexture=function(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this.load3dlTexture()},i.prototype.clone=function(){var n=new i(this.url,this.getScene());return n.level=this.level,n},i.prototype.delayLoad=function(){this.delayLoadState===n.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=n.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,!0),this._texture||this.loadTexture())},i.Bind=function(n,t){t.setTexture("cameraColorGrading2DSampler",n);var e=n.level,i=n.getSize().height,r=i-1,u=1/i;t.setFloat4("vCameraColorGradingInfos",e,i,r,u);var f=u/i,o=u,s=r*f,h=r/i,c=.5*f,l=.5*o;t.setFloat4("vCameraColorGradingScaleOffset",s,h,c,l)},i.PrepareUniformsAndSamplers=function(n,t){n.push("vCameraColorGradingInfos","vCameraColorGradingScaleOffset");t.push("cameraColorGrading2DSampler")},i.Parse=function(t,i){var r=null;return t.name&&!t.isRenderTarget&&(r=new n.ColorGradingTexture(t.name,i),r.name=t.name,r.level=t.level),r},i.prototype.serialize=function(){if(!this.name)return null;var n={};return n.name=this.name,n.level=this.level,n.customType="BABYLON.ColorGradingTexture",n},i._noneEmptyLineRegex=/\S+/,i}(n.BaseTexture);n.ColorGradingTexture=t}(i||(i={}));!function(n){var t=function(){function t(){this._dirty=!0;this._tempColor=new n.Color4(0,0,0,0);this._globalCurve=new n.Color4(0,0,0,0);this._highlightsCurve=new n.Color4(0,0,0,0);this._midtonesCurve=new n.Color4(0,0,0,0);this._shadowsCurve=new n.Color4(0,0,0,0);this._positiveCurve=new n.Color4(0,0,0,0);this._negativeCurve=new n.Color4(0,0,0,0);this._globalHue=30;this._globalDensity=0;this._globalSaturation=0;this._globalExposure=0;this._highlightsHue=30;this._highlightsDensity=0;this._highlightsSaturation=0;this._highlightsExposure=0;this._midtonesHue=30;this._midtonesDensity=0;this._midtonesSaturation=0;this._midtonesExposure=0;this._shadowsHue=30;this._shadowsDensity=0;this._shadowsSaturation=0;this._shadowsExposure=0}return Object.defineProperty(t.prototype,"GlobalHue",{get:function(){return this._globalHue},set:function(n){this._globalHue=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"GlobalDensity",{get:function(){return this._globalDensity},set:function(n){this._globalDensity=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"GlobalSaturation",{get:function(){return this._globalSaturation},set:function(n){this._globalSaturation=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"HighlightsHue",{get:function(){return this._highlightsHue},set:function(n){this._highlightsHue=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"HighlightsDensity",{get:function(){return this._highlightsDensity},set:function(n){this._highlightsDensity=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"HighlightsSaturation",{get:function(){return this._highlightsSaturation},set:function(n){this._highlightsSaturation=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"HighlightsExposure",{get:function(){return this._highlightsExposure},set:function(n){this._highlightsExposure=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"MidtonesHue",{get:function(){return this._midtonesHue},set:function(n){this._midtonesHue=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"MidtonesDensity",{get:function(){return this._midtonesDensity},set:function(n){this._midtonesDensity=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"MidtonesSaturation",{get:function(){return this._midtonesSaturation},set:function(n){this._midtonesSaturation=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"MidtonesExposure",{get:function(){return this._midtonesExposure},set:function(n){this._midtonesExposure=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ShadowsHue",{get:function(){return this._shadowsHue},set:function(n){this._shadowsHue=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ShadowsDensity",{get:function(){return this._shadowsDensity},set:function(n){this._shadowsDensity=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ShadowsSaturation",{get:function(){return this._shadowsSaturation},set:function(n){this._shadowsSaturation=n;this._dirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ShadowsExposure",{get:function(){return this._shadowsExposure},set:function(n){this._shadowsExposure=n;this._dirty=!0},enumerable:!0,configurable:!0}),t.Bind=function(n,t){n._dirty&&(n._dirty=!1,n.getColorGradingDataToRef(n._globalHue,n._globalDensity,n._globalSaturation,n._globalExposure,n._globalCurve),n.getColorGradingDataToRef(n._highlightsHue,n._highlightsDensity,n._highlightsSaturation,n._highlightsExposure,n._tempColor),n._tempColor.multiplyToRef(n._globalCurve,n._highlightsCurve),n.getColorGradingDataToRef(n._midtonesHue,n._midtonesDensity,n._midtonesSaturation,n._midtonesExposure,n._tempColor),n._tempColor.multiplyToRef(n._globalCurve,n._midtonesCurve),n.getColorGradingDataToRef(n._shadowsHue,n._shadowsDensity,n._shadowsSaturation,n._shadowsExposure,n._tempColor),n._tempColor.multiplyToRef(n._globalCurve,n._shadowsCurve),n._highlightsCurve.subtractToRef(n._midtonesCurve,n._positiveCurve),n._midtonesCurve.subtractToRef(n._shadowsCurve,n._negativeCurve));t.setFloat4("vCameraColorCurvePositive",n._positiveCurve.r,n._positiveCurve.g,n._positiveCurve.b,n._positiveCurve.a);t.setFloat4("vCameraColorCurveNeutral",n._midtonesCurve.r,n._midtonesCurve.g,n._midtonesCurve.b,n._midtonesCurve.a);t.setFloat4("vCameraColorCurveNegative",n._negativeCurve.r,n._negativeCurve.g,n._negativeCurve.b,n._negativeCurve.a)},t.PrepareUniforms=function(n){n.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")},t.prototype.getColorGradingDataToRef=function(n,i,r,u,f){null!=n&&(n=t.clamp(n,0,360),i=t.clamp(i,-100,100),r=t.clamp(r,-100,100),u=t.clamp(u,-100,100),i=t.applyColorGradingSliderNonlinear(i),i*=.5,u=t.applyColorGradingSliderNonlinear(u),i<0&&(i*=-1,n=(n+180)%360),t.fromHSBToRef(n,i,50+.25*u,f),f.scaleToRef(2,f),f.a=1+.01*r)},t.applyColorGradingSliderNonlinear=function(n){n/=100;var t=Math.abs(n);return t=Math.pow(t,2),n<0&&(t*=-1),t*100},t.fromHSBToRef=function(n,i,r,u){var s=t.clamp(n,0,360),o=t.clamp(i/100,0,1),f=t.clamp(r/100,0,1);if(0===o)u.r=f,u.g=f,u.b=f;else{s/=60;var l=Math.floor(s),a=s-l,e=f*(1-o),h=f*(1-o*a),c=f*(1-o*(1-a));switch(l){case 0:u.r=f;u.g=c;u.b=e;break;case 1:u.r=h;u.g=f;u.b=e;break;case 2:u.r=e;u.g=f;u.b=c;break;case 3:u.r=e;u.g=h;u.b=f;break;case 4:u.r=c;u.g=e;u.b=f;break;default:u.r=f;u.g=e;u.b=h}}u.a=1},t.clamp=function(n,t,i){return Math.min(Math.max(n,t),i)},t.prototype.clone=function(){return n.SerializationHelper.Clone(function(){return new t},this)},t.prototype.serialize=function(){return n.SerializationHelper.Serialize(this)},t.Parse=function(i){return n.SerializationHelper.Parse(function(){return new t},i,null,null)},r([n.serialize()],t.prototype,"_globalHue",void 0),r([n.serialize()],t.prototype,"_globalDensity",void 0),r([n.serialize()],t.prototype,"_globalSaturation",void 0),r([n.serialize()],t.prototype,"_globalExposure",void 0),r([n.serialize()],t.prototype,"_highlightsHue",void 0),r([n.serialize()],t.prototype,"_highlightsDensity",void 0),r([n.serialize()],t.prototype,"_highlightsSaturation",void 0),r([n.serialize()],t.prototype,"_highlightsExposure",void 0),r([n.serialize()],t.prototype,"_midtonesHue",void 0),r([n.serialize()],t.prototype,"_midtonesDensity",void 0),r([n.serialize()],t.prototype,"_midtonesSaturation",void 0),r([n.serialize()],t.prototype,"_midtonesExposure",void 0),t}();n.ColorCurves=t}(i||(i={}));!function(n){var t=function(n){function t(){n.call(this);this.ALBEDO=!1;this.AMBIENT=!1;this.OPACITY=!1;this.OPACITYRGB=!1;this.REFLECTION=!1;this.EMISSIVE=!1;this.REFLECTIVITY=!1;this.BUMP=!1;this.PARALLAX=!1;this.PARALLAXOCCLUSION=!1;this.SPECULAROVERALPHA=!1;this.CLIPPLANE=!1;this.ALPHATEST=!1;this.ALPHAFROMALBEDO=!1;this.POINTSIZE=!1;this.FOG=!1;this.SPECULARTERM=!1;this.OPACITYFRESNEL=!1;this.EMISSIVEFRESNEL=!1;this.FRESNEL=!1;this.NORMAL=!1;this.UV1=!1;this.UV2=!1;this.VERTEXCOLOR=!1;this.VERTEXALPHA=!1;this.NUM_BONE_INFLUENCERS=0;this.BonesPerMesh=0;this.INSTANCES=!1;this.MICROSURFACEFROMREFLECTIVITYMAP=!1;this.MICROSURFACEAUTOMATIC=!1;this.EMISSIVEASILLUMINATION=!1;this.LINKEMISSIVEWITHALBEDO=!1;this.LIGHTMAP=!1;this.USELIGHTMAPASSHADOWMAP=!1;this.REFLECTIONMAP_3D=!1;this.REFLECTIONMAP_SPHERICAL=!1;this.REFLECTIONMAP_PLANAR=!1;this.REFLECTIONMAP_CUBIC=!1;this.REFLECTIONMAP_PROJECTION=!1;this.REFLECTIONMAP_SKYBOX=!1;this.REFLECTIONMAP_EXPLICIT=!1;this.REFLECTIONMAP_EQUIRECTANGULAR=!1;this.INVERTCUBICMAP=!1;this.LOGARITHMICDEPTH=!1;this.CAMERATONEMAP=!1;this.CAMERACONTRAST=!1;this.CAMERACOLORGRADING=!1;this.CAMERACOLORCURVES=!1;this.OVERLOADEDVALUES=!1;this.OVERLOADEDSHADOWVALUES=!1;this.USESPHERICALFROMREFLECTIONMAP=!1;this.REFRACTION=!1;this.REFRACTIONMAP_3D=!1;this.LINKREFRACTIONTOTRANSPARENCY=!1;this.REFRACTIONMAPINLINEARSPACE=!1;this.LODBASEDMICROSFURACE=!1;this.USEPHYSICALLIGHTFALLOFF=!1;this.RADIANCEOVERALPHA=!1;this.USEPMREMREFLECTION=!1;this.USEPMREMREFRACTION=!1;this.OPENGLNORMALMAP=!1;this.INVERTNORMALMAPX=!1;this.INVERTNORMALMAPY=!1;this.SHADOWFULLFLOAT=!1;this.METALLICWORKFLOW=!1;this.METALLICROUGHNESSGSTOREINALPHA=!1;this.METALLICROUGHNESSGSTOREINGREEN=!1;this.rebuild()}return u(t,n),t}(n.MaterialDefines),i=function(i){function f(r,u){var f=this;i.call(this,r,u);this.directIntensity=1;this.emissiveIntensity=1;this.environmentIntensity=1;this.specularIntensity=1;this._lightingInfos=new n.Vector4(this.directIntensity,this.emissiveIntensity,this.environmentIntensity,this.specularIntensity);this.disableBumpMap=!1;this.overloadedShadowIntensity=1;this.overloadedShadeIntensity=1;this._overloadedShadowInfos=new n.Vector4(this.overloadedShadowIntensity,this.overloadedShadeIntensity,0,0);this.cameraExposure=1;this.cameraContrast=1;this.cameraColorGradingTexture=null;this.cameraColorCurves=null;this._cameraInfos=new n.Vector4(1,1,0,0);this._microsurfaceTextureLods=new n.Vector2(0,0);this.overloadedAmbient=n.Color3.White();this.overloadedAmbientIntensity=0;this.overloadedAlbedo=n.Color3.White();this.overloadedAlbedoIntensity=0;this.overloadedReflectivity=new n.Color3(.3,.3,.3);this.overloadedReflectivityIntensity=0;this.overloadedEmissive=n.Color3.White();this.overloadedEmissiveIntensity=0;this._overloadedIntensity=new n.Vector4(this.overloadedAmbientIntensity,this.overloadedAlbedoIntensity,this.overloadedReflectivityIntensity,this.overloadedEmissiveIntensity);this.overloadedReflection=n.Color3.White();this.overloadedReflectionIntensity=0;this.overloadedMicroSurface=0;this.overloadedMicroSurfaceIntensity=0;this._overloadedMicroSurface=new n.Vector3(this.overloadedMicroSurface,this.overloadedMicroSurfaceIntensity,this.overloadedReflectionIntensity);this.ambientTextureStrength=1;this.ambientColor=new n.Color3(0,0,0);this.albedoColor=new n.Color3(1,1,1);this.reflectivityColor=new n.Color3(1,1,1);this.reflectionColor=new n.Color3(.5,.5,.5);this.emissiveColor=new n.Color3(0,0,0);this.microSurface=.9;this.indexOfRefraction=.66;this.invertRefractionY=!1;this.linkRefractionWithTransparency=!1;this.linkEmissiveWithAlbedo=!1;this.useLightmapAsShadowmap=!1;this.useEmissiveAsIllumination=!1;this.useAlphaFromAlbedoTexture=!1;this.useSpecularOverAlpha=!0;this.useMicroSurfaceFromReflectivityMapAlpha=!1;this.useRoughnessFromMetallicTextureAlpha=!0;this.useRoughnessFromMetallicTextureGreen=!1;this.useAutoMicroSurfaceFromReflectivityMap=!1;this.useScalarInLinearSpace=!1;this.usePhysicalLightFalloff=!0;this.useRadianceOverAlpha=!0;this.useParallax=!1;this.useParallaxOcclusion=!1;this.parallaxScaleBias=.05;this.disableLighting=!1;this.maxSimultaneousLights=4;this.invertNormalMapX=!1;this.invertNormalMapY=!1;this._renderTargets=new n.SmartArray(16);this._worldViewProjectionMatrix=n.Matrix.Zero();this._globalAmbientColor=new n.Color3(0,0,0);this._tempColor=new n.Color3;this._defines=new t;this._cachedDefines=new t;this._myScene=null;this._myShadowGenerator=null;this._cachedDefines.BonesPerMesh=-1;this.getRenderTargetTextures=function(){return f._renderTargets.reset(),f.reflectionTexture&&f.reflectionTexture.isRenderTarget&&f._renderTargets.push(f.reflectionTexture),f.refractionTexture&&f.refractionTexture.isRenderTarget&&f._renderTargets.push(f.refractionTexture),f._renderTargets}}return u(f,i),Object.defineProperty(f.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(n){this._useLogarithmicDepth=n&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!0,configurable:!0}),f.prototype.needAlphaBlending=function(){return!this.linkRefractionWithTransparency&&(this.alpha<1||null!=this.opacityTexture||this._shouldUseAlphaFromAlbedoTexture()||this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled)},f.prototype.needAlphaTesting=function(){return!this.linkRefractionWithTransparency&&null!=this.albedoTexture&&this.albedoTexture.hasAlpha},f.prototype._shouldUseAlphaFromAlbedoTexture=function(){return null!=this.albedoTexture&&this.albedoTexture.hasAlpha&&this.useAlphaFromAlbedoTexture},f.prototype.getAlphaTestTexture=function(){return this.albedoTexture},f.prototype._checkCache=function(n,t,i){return!t||this._defines.INSTANCES===i&&!(!t._materialDefines||!t._materialDefines.isEqual(this._defines))},f.prototype.convertColorToLinearSpaceToRef=function(n,t){f.convertColorToLinearSpaceToRef(n,t,this.useScalarInLinearSpace)},f.convertColorToLinearSpaceToRef=function(n,t,i){i?(t.r=n.r,t.g=n.g,t.b=n.b):n.toLinearSpaceToRef(t)},f.BindLights=function(t,i,r,u,e,o,s){for(var h,c=0,a=!1,l=0;l<t.lights.length;l++)if(h=t.lights[l],h.isEnabled()&&h.canAffectMesh(i)&&(n.MaterialHelper.BindLightProperties(h,r,c),this.convertColorToLinearSpaceToRef(h.diffuse,f._scaledAlbedo,e),f._scaledAlbedo.scaleToRef(h.intensity,f._scaledAlbedo),r.setColor4("vLightDiffuse"+c,f._scaledAlbedo,s?h.radius:h.range),u.SPECULARTERM&&(this.convertColorToLinearSpaceToRef(h.specular,f._scaledReflectivity,e),f._scaledReflectivity.scaleToRef(h.intensity,f._scaledReflectivity),r.setColor3("vLightSpecular"+c,f._scaledReflectivity)),t.shadowsEnabled&&(a=n.MaterialHelper.BindLightShadow(h,t,i,c,r,a)),c++,c===o))break},f.prototype.isReady=function(i,r){var u,o;if(this.checkReadyOnlyOnce&&this._wasPreviouslyReady)return!0;var f=this.getScene(),l=f.getEngine(),s=!1,e=!1;if(this._defines.reset(),f.lightsEnabled&&!this.disableLighting&&(s=n.MaterialHelper.PrepareDefinesForLights(f,i,this._defines,this.maxSimultaneousLights)||s),!this.checkReadyOnEveryCall&&this._renderId===f.getRenderId()&&this._checkCache(f,i,r))return!0;if(f.texturesEnabled){if(f.getEngine().getCaps().textureLOD&&(this._defines.LODBASEDMICROSFURACE=!0),this.albedoTexture&&n.StandardMaterial.DiffuseTextureEnabled){if(!this.albedoTexture.isReady())return!1;e=!0;this._defines.ALBEDO=!0}if(this.ambientTexture&&n.StandardMaterial.AmbientTextureEnabled){if(!this.ambientTexture.isReady())return!1;e=!0;this._defines.AMBIENT=!0}if(this.opacityTexture&&n.StandardMaterial.OpacityTextureEnabled){if(!this.opacityTexture.isReady())return!1;e=!0;this._defines.OPACITY=!0;this.opacityTexture.getAlphaFromRGB&&(this._defines.OPACITYRGB=!0)}if(this.reflectionTexture&&n.StandardMaterial.ReflectionTextureEnabled){if(!this.reflectionTexture.isReady())return!1;switch(s=!0,this._defines.REFLECTION=!0,this.reflectionTexture.coordinatesMode===n.Texture.INVCUBIC_MODE&&(this._defines.INVERTCUBICMAP=!0),this._defines.REFLECTIONMAP_3D=this.reflectionTexture.isCube,this.reflectionTexture.coordinatesMode){case n.Texture.CUBIC_MODE:case n.Texture.INVCUBIC_MODE:this._defines.REFLECTIONMAP_CUBIC=!0;break;case n.Texture.EXPLICIT_MODE:this._defines.REFLECTIONMAP_EXPLICIT=!0;break;case n.Texture.PLANAR_MODE:this._defines.REFLECTIONMAP_PLANAR=!0;break;case n.Texture.PROJECTION_MODE:this._defines.REFLECTIONMAP_PROJECTION=!0;break;case n.Texture.SKYBOX_MODE:this._defines.REFLECTIONMAP_SKYBOX=!0;break;case n.Texture.SPHERICAL_MODE:this._defines.REFLECTIONMAP_SPHERICAL=!0;break;case n.Texture.EQUIRECTANGULAR_MODE:this._defines.REFLECTIONMAP_EQUIRECTANGULAR=!0}this.reflectionTexture instanceof n.HDRCubeTexture&&this.reflectionTexture&&(this._defines.USESPHERICALFROMREFLECTIONMAP=!0,s=!0,this.reflectionTexture.isPMREM&&(this._defines.USEPMREMREFLECTION=!0))}if(this.lightmapTexture&&n.StandardMaterial.LightmapTextureEnabled){if(!this.lightmapTexture.isReady())return!1;e=!0;this._defines.LIGHTMAP=!0;this._defines.USELIGHTMAPASSHADOWMAP=this.useLightmapAsShadowmap}if(this.emissiveTexture&&n.StandardMaterial.EmissiveTextureEnabled){if(!this.emissiveTexture.isReady())return!1;e=!0;this._defines.EMISSIVE=!0}if(n.StandardMaterial.SpecularTextureEnabled)if(this.metallicTexture){if(!this.metallicTexture.isReady())return!1;e=!0;this._defines.METALLICWORKFLOW=!0;this._defines.METALLICROUGHNESSGSTOREINALPHA=this.useRoughnessFromMetallicTextureAlpha;this._defines.METALLICROUGHNESSGSTOREINGREEN=!this.useRoughnessFromMetallicTextureAlpha&&this.useRoughnessFromMetallicTextureGreen}else if(this.reflectivityTexture){if(!this.reflectivityTexture.isReady())return!1;e=!0;this._defines.REFLECTIVITY=!0;this._defines.MICROSURFACEFROMREFLECTIVITYMAP=this.useMicroSurfaceFromReflectivityMapAlpha;this._defines.MICROSURFACEAUTOMATIC=this.useAutoMicroSurfaceFromReflectivityMap}if(f.getEngine().getCaps().standardDerivatives&&this.bumpTexture&&n.StandardMaterial.BumpTextureEnabled&&!this.disableBumpMap){if(!this.bumpTexture.isReady())return!1;e=!0;this._defines.BUMP=!0;this.useParallax&&this.albedoTexture&&n.StandardMaterial.DiffuseTextureEnabled&&(this._defines.PARALLAX=!0,this.useParallaxOcclusion&&(this._defines.PARALLAXOCCLUSION=!0));this.invertNormalMapX&&(this._defines.INVERTNORMALMAPX=!0);this.invertNormalMapY&&(this._defines.INVERTNORMALMAPY=!0)}if(this.refractionTexture&&n.StandardMaterial.RefractionTextureEnabled){if(!this.refractionTexture.isReady())return!1;e=!0;this._defines.REFRACTION=!0;this._defines.REFRACTIONMAP_3D=this.refractionTexture.isCube;this.linkRefractionWithTransparency&&(this._defines.LINKREFRACTIONTOTRANSPARENCY=!0);this.refractionTexture instanceof n.HDRCubeTexture&&(this._defines.REFRACTIONMAPINLINEARSPACE=!0,this.refractionTexture.isPMREM&&(this._defines.USEPMREMREFRACTION=!0))}if(this.cameraColorGradingTexture&&n.StandardMaterial.ColorGradingTextureEnabled){if(!this.cameraColorGradingTexture.isReady())return!1;this._defines.CAMERACOLORGRADING=!0}}if(f.clipPlane&&(this._defines.CLIPPLANE=!0),l.getAlphaTesting()&&(this._defines.ALPHATEST=!0),this._shouldUseAlphaFromAlbedoTexture()&&(this._defines.ALPHAFROMALBEDO=!0),this.useEmissiveAsIllumination&&(this._defines.EMISSIVEASILLUMINATION=!0),this.linkEmissiveWithAlbedo&&(this._defines.LINKEMISSIVEWITHALBEDO=!0),this.useLogarithmicDepth&&(this._defines.LOGARITHMICDEPTH=!0),1!=this.cameraContrast&&(this._defines.CAMERACONTRAST=!0),1!=this.cameraExposure&&(this._defines.CAMERATONEMAP=!0),this.cameraColorCurves&&(this._defines.CAMERACOLORCURVES=!0),1==this.overloadedShadeIntensity&&1==this.overloadedShadowIntensity||(this._defines.OVERLOADEDSHADOWVALUES=!0),(this.overloadedMicroSurfaceIntensity>0||this.overloadedEmissiveIntensity>0||this.overloadedReflectivityIntensity>0||this.overloadedAlbedoIntensity>0||this.overloadedAmbientIntensity>0||this.overloadedReflectionIntensity>0)&&(this._defines.OVERLOADEDVALUES=!0),(this.pointsCloud||f.forcePointsCloud)&&(this._defines.POINTSIZE=!0),f.fogEnabled&&i&&i.applyFog&&f.fogMode!==n.Scene.FOGMODE_NONE&&this.fogEnabled&&(this._defines.FOG=!0),n.StandardMaterial.FresnelEnabled&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled||this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled)&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&(this._defines.OPACITYFRESNEL=!0),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._defines.EMISSIVEFRESNEL=!0),s=!0,this._defines.FRESNEL=!0),this._defines.SPECULARTERM&&this.useSpecularOverAlpha&&(this._defines.SPECULAROVERALPHA=!0),this.usePhysicalLightFalloff&&(this._defines.USEPHYSICALLIGHTFALLOFF=!0),this.useRadianceOverAlpha&&(this._defines.RADIANCEOVERALPHA=!0),i&&(s&&i.isVerticesDataPresent(n.VertexBuffer.NormalKind)&&(this._defines.NORMAL=!0),e&&(i.isVerticesDataPresent(n.VertexBuffer.UVKind)&&(this._defines.UV1=!0),i.isVerticesDataPresent(n.VertexBuffer.UV2Kind)&&(this._defines.UV2=!0)),i.useVertexColors&&i.isVerticesDataPresent(n.VertexBuffer.ColorKind)&&(this._defines.VERTEXCOLOR=!0,i.hasVertexAlpha&&(this._defines.VERTEXALPHA=!0)),i.useBones&&i.computeBonesUsingShaders&&(this._defines.NUM_BONE_INFLUENCERS=i.numBoneInfluencers,this._defines.BonesPerMesh=i.skeleton.bones.length+1),r&&(this._defines.INSTANCES=!0)),!this._defines.isEqual(this._cachedDefines)){this._defines.cloneTo(this._cachedDefines);f.resetCachedMaterial();u=new n.EffectFallbacks;this._defines.REFLECTION&&u.addFallback(0,"REFLECTION");this._defines.REFRACTION&&u.addFallback(0,"REFRACTION");this._defines.REFLECTIVITY&&u.addFallback(0,"REFLECTIVITY");this._defines.BUMP&&u.addFallback(0,"BUMP");this._defines.PARALLAX&&u.addFallback(1,"PARALLAX");this._defines.PARALLAXOCCLUSION&&u.addFallback(0,"PARALLAXOCCLUSION");this._defines.SPECULAROVERALPHA&&u.addFallback(0,"SPECULAROVERALPHA");this._defines.FOG&&u.addFallback(1,"FOG");this._defines.POINTSIZE&&u.addFallback(0,"POINTSIZE");this._defines.LOGARITHMICDEPTH&&u.addFallback(0,"LOGARITHMICDEPTH");n.MaterialHelper.HandleFallbacksForShadows(this._defines,u,this.maxSimultaneousLights);this._defines.SPECULARTERM&&u.addFallback(0,"SPECULARTERM");this._defines.OPACITYFRESNEL&&u.addFallback(1,"OPACITYFRESNEL");this._defines.EMISSIVEFRESNEL&&u.addFallback(2,"EMISSIVEFRESNEL");this._defines.FRESNEL&&u.addFallback(3,"FRESNEL");this._defines.NUM_BONE_INFLUENCERS>0&&u.addCPUSkinningFallback(0,i);o=[n.VertexBuffer.PositionKind];this._defines.NORMAL&&o.push(n.VertexBuffer.NormalKind);this._defines.UV1&&o.push(n.VertexBuffer.UVKind);this._defines.UV2&&o.push(n.VertexBuffer.UV2Kind);this._defines.VERTEXCOLOR&&o.push(n.VertexBuffer.ColorKind);n.MaterialHelper.PrepareAttributesForBones(o,i,this._defines,u);n.MaterialHelper.PrepareAttributesForInstances(o,this._defines);var a=this._defines.toString(),h=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vEmissiveColor","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vReflectivityInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","bumpMatrix","lightmapMatrix","refractionMatrix","depthValues","opacityParts","emissiveLeftColor","emissiveRightColor","vLightingIntensity","vOverloadedShadowIntensity","vOverloadedIntensity","vOverloadedAlbedo","vOverloadedReflection","vOverloadedReflectivity","vOverloadedEmissive","vOverloadedMicroSurface","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX","vSphericalYY","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vMicrosurfaceTextureLods","vCameraInfos"],c=["albedoSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","reflectivitySampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"];n.ColorCurves.PrepareUniforms(h);n.ColorGradingTexture.PrepareUniformsAndSamplers(h,c);n.MaterialHelper.PrepareUniformsAndSamplersList(h,c,this._defines,this.maxSimultaneousLights);this._effect=f.getEngine().createEffect("pbr",o,h,c,a,u,this.onCompiled,this.onError,{maxSimultaneousLights:this.maxSimultaneousLights})}return!!this._effect.isReady()&&(this._renderId=f.getRenderId(),this._wasPreviouslyReady=!0,i&&(i._materialDefines||(i._materialDefines=new t),this._defines.cloneTo(i._materialDefines)),!0)},f.prototype.unbind=function(){this.reflectionTexture&&this.reflectionTexture.isRenderTarget&&this._effect.setTexture("reflection2DSampler",null);this.refractionTexture&&this.refractionTexture.isRenderTarget&&this._effect.setTexture("refraction2DSampler",null);i.prototype.unbind.call(this)},f.prototype.bindOnlyWorldMatrix=function(n){this._effect.setMatrix("world",n)},f.prototype.bind=function(t,r){if(this._myScene=this.getScene(),this.bindOnlyWorldMatrix(t),n.MaterialHelper.BindBonesParameters(r,this._effect),this._myScene.getCachedMaterial()!==this){if(this._effect.setMatrix("viewProjection",this._myScene.getTransformMatrix()),n.StandardMaterial.FresnelEnabled&&(this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&this._effect.setColor4("opacityParts",new n.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._effect.setColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),this._effect.setColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),this._myScene.texturesEnabled){if(this.albedoTexture&&n.StandardMaterial.DiffuseTextureEnabled&&(this._effect.setTexture("albedoSampler",this.albedoTexture),this._effect.setFloat2("vAlbedoInfos",this.albedoTexture.coordinatesIndex,this.albedoTexture.level),this._effect.setMatrix("albedoMatrix",this.albedoTexture.getTextureMatrix())),this.ambientTexture&&n.StandardMaterial.AmbientTextureEnabled&&(this._effect.setTexture("ambientSampler",this.ambientTexture),this._effect.setFloat3("vAmbientInfos",this.ambientTexture.coordinatesIndex,this.ambientTexture.level,this.ambientTextureStrength),this._effect.setMatrix("ambientMatrix",this.ambientTexture.getTextureMatrix())),this.opacityTexture&&n.StandardMaterial.OpacityTextureEnabled&&(this._effect.setTexture("opacitySampler",this.opacityTexture),this._effect.setFloat2("vOpacityInfos",this.opacityTexture.coordinatesIndex,this.opacityTexture.level),this._effect.setMatrix("opacityMatrix",this.opacityTexture.getTextureMatrix())),this.reflectionTexture&&n.StandardMaterial.ReflectionTextureEnabled&&(this._microsurfaceTextureLods.x=Math.round(Math.log(this.reflectionTexture.getSize().width)*Math.LOG2E),this.reflectionTexture.isCube?this._effect.setTexture("reflectionCubeSampler",this.reflectionTexture):this._effect.setTexture("reflection2DSampler",this.reflectionTexture),this._effect.setMatrix("reflectionMatrix",this.reflectionTexture.getReflectionTextureMatrix()),this._effect.setFloat2("vReflectionInfos",this.reflectionTexture.level,0),this._defines.USESPHERICALFROMREFLECTIONMAP&&(this._effect.setFloat3("vSphericalX",this.reflectionTexture.sphericalPolynomial.x.x,this.reflectionTexture.sphericalPolynomial.x.y,this.reflectionTexture.sphericalPolynomial.x.z),this._effect.setFloat3("vSphericalY",this.reflectionTexture.sphericalPolynomial.y.x,this.reflectionTexture.sphericalPolynomial.y.y,this.reflectionTexture.sphericalPolynomial.y.z),this._effect.setFloat3("vSphericalZ",this.reflectionTexture.sphericalPolynomial.z.x,this.reflectionTexture.sphericalPolynomial.z.y,this.reflectionTexture.sphericalPolynomial.z.z),this._effect.setFloat3("vSphericalXX",this.reflectionTexture.sphericalPolynomial.xx.x,this.reflectionTexture.sphericalPolynomial.xx.y,this.reflectionTexture.sphericalPolynomial.xx.z),this._effect.setFloat3("vSphericalYY",this.reflectionTexture.sphericalPolynomial.yy.x,this.reflectionTexture.sphericalPolynomial.yy.y,this.reflectionTexture.sphericalPolynomial.yy.z),this._effect.setFloat3("vSphericalZZ",this.reflectionTexture.sphericalPolynomial.zz.x,this.reflectionTexture.sphericalPolynomial.zz.y,this.reflectionTexture.sphericalPolynomial.zz.z),this._effect.setFloat3("vSphericalXY",this.reflectionTexture.sphericalPolynomial.xy.x,this.reflectionTexture.sphericalPolynomial.xy.y,this.reflectionTexture.sphericalPolynomial.xy.z),this._effect.setFloat3("vSphericalYZ",this.reflectionTexture.sphericalPolynomial.yz.x,this.reflectionTexture.sphericalPolynomial.yz.y,this.reflectionTexture.sphericalPolynomial.yz.z),this._effect.setFloat3("vSphericalZX",this.reflectionTexture.sphericalPolynomial.zx.x,this.reflectionTexture.sphericalPolynomial.zx.y,this.reflectionTexture.sphericalPolynomial.zx.z))),this.emissiveTexture&&n.StandardMaterial.EmissiveTextureEnabled&&(this._effect.setTexture("emissiveSampler",this.emissiveTexture),this._effect.setFloat2("vEmissiveInfos",this.emissiveTexture.coordinatesIndex,this.emissiveTexture.level),this._effect.setMatrix("emissiveMatrix",this.emissiveTexture.getTextureMatrix())),this.lightmapTexture&&n.StandardMaterial.LightmapTextureEnabled&&(this._effect.setTexture("lightmapSampler",this.lightmapTexture),this._effect.setFloat2("vLightmapInfos",this.lightmapTexture.coordinatesIndex,this.lightmapTexture.level),this._effect.setMatrix("lightmapMatrix",this.lightmapTexture.getTextureMatrix())),n.StandardMaterial.SpecularTextureEnabled&&(this.metallicTexture?(this._effect.setTexture("reflectivitySampler",this.metallicTexture),this._effect.setFloat2("vReflectivityInfos",this.metallicTexture.coordinatesIndex,this.metallicTexture.level),this._effect.setMatrix("reflectivityMatrix",this.metallicTexture.getTextureMatrix())):this.reflectivityTexture&&(this._effect.setTexture("reflectivitySampler",this.reflectivityTexture),this._effect.setFloat2("vReflectivityInfos",this.reflectivityTexture.coordinatesIndex,this.reflectivityTexture.level),this._effect.setMatrix("reflectivityMatrix",this.reflectivityTexture.getTextureMatrix()))),this.bumpTexture&&this._myScene.getEngine().getCaps().standardDerivatives&&n.StandardMaterial.BumpTextureEnabled&&!this.disableBumpMap&&(this._effect.setTexture("bumpSampler",this.bumpTexture),this._effect.setFloat3("vBumpInfos",this.bumpTexture.coordinatesIndex,1/this.bumpTexture.level,this.parallaxScaleBias),this._effect.setMatrix("bumpMatrix",this.bumpTexture.getTextureMatrix())),this.refractionTexture&&n.StandardMaterial.RefractionTextureEnabled){this._microsurfaceTextureLods.y=Math.round(Math.log(this.refractionTexture.getSize().width)*Math.LOG2E);var u=1;this.refractionTexture.isCube?this._effect.setTexture("refractionCubeSampler",this.refractionTexture):(this._effect.setTexture("refraction2DSampler",this.refractionTexture),this._effect.setMatrix("refractionMatrix",this.refractionTexture.getReflectionTextureMatrix()),this.refractionTexture.depth&&(u=this.refractionTexture.depth));this._effect.setFloat4("vRefractionInfos",this.refractionTexture.level,this.indexOfRefraction,u,this.invertRefractionY?-1:1)}(this.reflectionTexture||this.refractionTexture)&&this._effect.setFloat2("vMicrosurfaceTextureLods",this._microsurfaceTextureLods.x,this._microsurfaceTextureLods.y);this.cameraColorGradingTexture&&n.StandardMaterial.ColorGradingTextureEnabled&&n.ColorGradingTexture.Bind(this.cameraColorGradingTexture,this._effect)}n.MaterialHelper.BindClipPlane(this._effect,this._myScene);this.pointsCloud&&this._effect.setFloat("pointSize",this.pointSize);this._myScene.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor);this.convertColorToLinearSpaceToRef(this.reflectivityColor,f._scaledReflectivity);this._effect.setVector3("vEyePosition",this._myScene._mirroredCameraPosition?this._myScene._mirroredCameraPosition:this._myScene.activeCamera.position);this._effect.setColor3("vAmbientColor",this._globalAmbientColor);this._effect.setColor4("vReflectivityColor",f._scaledReflectivity,this.microSurface);this.convertColorToLinearSpaceToRef(this.emissiveColor,f._scaledEmissive);this._effect.setColor3("vEmissiveColor",f._scaledEmissive);this.convertColorToLinearSpaceToRef(this.reflectionColor,f._scaledReflection);this._effect.setColor3("vReflectionColor",f._scaledReflection)}this._myScene.getCachedMaterial()===this&&this.isFrozen||(this.convertColorToLinearSpaceToRef(this.albedoColor,f._scaledAlbedo),this._effect.setColor4("vAlbedoColor",f._scaledAlbedo,this.alpha*r.visibility),this._myScene.lightsEnabled&&!this.disableLighting&&f.BindLights(this._myScene,r,this._effect,this._defines,this.useScalarInLinearSpace,this.maxSimultaneousLights,this.usePhysicalLightFalloff),(this._myScene.fogEnabled&&r.applyFog&&this._myScene.fogMode!==n.Scene.FOGMODE_NONE||this.reflectionTexture)&&this._effect.setMatrix("view",this._myScene.getViewMatrix()),n.MaterialHelper.BindFogParameters(this._myScene,r,this._effect),this._lightingInfos.x=this.directIntensity,this._lightingInfos.y=this.emissiveIntensity,this._lightingInfos.z=this.environmentIntensity,this._lightingInfos.w=this.specularIntensity,this._effect.setVector4("vLightingIntensity",this._lightingInfos),this._overloadedShadowInfos.x=this.overloadedShadowIntensity,this._overloadedShadowInfos.y=this.overloadedShadeIntensity,this._effect.setVector4("vOverloadedShadowIntensity",this._overloadedShadowInfos),this._cameraInfos.x=this.cameraExposure,this._cameraInfos.y=this.cameraContrast,this._effect.setVector4("vCameraInfos",this._cameraInfos),this.cameraColorCurves&&n.ColorCurves.Bind(this.cameraColorCurves,this._effect),this._overloadedIntensity.x=this.overloadedAmbientIntensity,this._overloadedIntensity.y=this.overloadedAlbedoIntensity,this._overloadedIntensity.z=this.overloadedReflectivityIntensity,this._overloadedIntensity.w=this.overloadedEmissiveIntensity,this._effect.setVector4("vOverloadedIntensity",this._overloadedIntensity),this.convertColorToLinearSpaceToRef(this.overloadedAmbient,this._tempColor),this._effect.setColor3("vOverloadedAmbient",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedAlbedo,this._tempColor),this._effect.setColor3("vOverloadedAlbedo",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedReflectivity,this._tempColor),this._effect.setColor3("vOverloadedReflectivity",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedEmissive,this._tempColor),this._effect.setColor3("vOverloadedEmissive",this._tempColor),this.convertColorToLinearSpaceToRef(this.overloadedReflection,this._tempColor),this._effect.setColor3("vOverloadedReflection",this._tempColor),this._overloadedMicroSurface.x=this.overloadedMicroSurface,this._overloadedMicroSurface.y=this.overloadedMicroSurfaceIntensity,this._overloadedMicroSurface.z=this.overloadedReflectionIntensity,this._effect.setVector3("vOverloadedMicroSurface",this._overloadedMicroSurface),n.MaterialHelper.BindLogDepth(this._defines,this._effect,this._myScene));i.prototype.bind.call(this,t,r);this._myScene=null},f.prototype.getAnimatables=function(){var n=[];return this.albedoTexture&&this.albedoTexture.animations&&this.albedoTexture.animations.length>0&&n.push(this.albedoTexture),this.ambientTexture&&this.ambientTexture.animations&&this.ambientTexture.animations.length>0&&n.push(this.ambientTexture),this.opacityTexture&&this.opacityTexture.animations&&this.opacityTexture.animations.length>0&&n.push(this.opacityTexture),this.reflectionTexture&&this.reflectionTexture.animations&&this.reflectionTexture.animations.length>0&&n.push(this.reflectionTexture),this.emissiveTexture&&this.emissiveTexture.animations&&this.emissiveTexture.animations.length>0&&n.push(this.emissiveTexture),this.metallicTexture&&this.metallicTexture.animations&&this.metallicTexture.animations.length>0?n.push(this.metallicTexture):this.reflectivityTexture&&this.reflectivityTexture.animations&&this.reflectivityTexture.animations.length>0&&n.push(this.reflectivityTexture),this.bumpTexture&&this.bumpTexture.animations&&this.bumpTexture.animations.length>0&&n.push(this.bumpTexture),this.lightmapTexture&&this.lightmapTexture.animations&&this.lightmapTexture.animations.length>0&&n.push(this.lightmapTexture),this.refractionTexture&&this.refractionTexture.animations&&this.refractionTexture.animations.length>0&&n.push(this.refractionTexture),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.animations&&this.cameraColorGradingTexture.animations.length>0&&n.push(this.cameraColorGradingTexture),n},f.prototype.dispose=function(n,t){t&&(this.albedoTexture&&this.albedoTexture.dispose(),this.ambientTexture&&this.ambientTexture.dispose(),this.opacityTexture&&this.opacityTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose(),this.emissiveTexture&&this.emissiveTexture.dispose(),this.metallicTexture&&this.metallicTexture.dispose(),this.reflectivityTexture&&this.reflectivityTexture.dispose(),this.bumpTexture&&this.bumpTexture.dispose(),this.lightmapTexture&&this.lightmapTexture.dispose(),this.refractionTexture&&this.refractionTexture.dispose(),this.cameraColorGradingTexture&&this.cameraColorGradingTexture.dispose());i.prototype.dispose.call(this,n,t)},f.prototype.clone=function(t){var i=this;return n.SerializationHelper.Clone(function(){return new f(t,i.getScene())},this)},f.prototype.serialize=function(){var t=n.SerializationHelper.Serialize(this);return t.customType="BABYLON.PBRMaterial",t},f.Parse=function(t,i,r){return n.SerializationHelper.Parse(function(){return new f(t.name,i)},t,i,r)},f._scaledAlbedo=new n.Color3,f._scaledReflectivity=new n.Color3,f._scaledEmissive=new n.Color3,f._scaledReflection=new n.Color3,r([n.serialize()],f.prototype,"directIntensity",void 0),r([n.serialize()],f.prototype,"emissiveIntensity",void 0),r([n.serialize()],f.prototype,"environmentIntensity",void 0),r([n.serialize()],f.prototype,"specularIntensity",void 0),r([n.serialize()],f.prototype,"disableBumpMap",void 0),r([n.serialize()],f.prototype,"overloadedShadowIntensity",void 0),r([n.serialize()],f.prototype,"overloadedShadeIntensity",void 0),r([n.serialize()],f.prototype,"cameraExposure",void 0),r([n.serialize()],f.prototype,"cameraContrast",void 0),r([n.serializeAsTexture()],f.prototype,"cameraColorGradingTexture",void 0),r([n.serializeAsColorCurves()],f.prototype,"cameraColorCurves",void 0),r([n.serializeAsColor3()],f.prototype,"overloadedAmbient",void 0),r([n.serialize()],f.prototype,"overloadedAmbientIntensity",void 0),r([n.serializeAsColor3()],f.prototype,"overloadedAlbedo",void 0),r([n.serialize()],f.prototype,"overloadedAlbedoIntensity",void 0),r([n.serializeAsColor3()],f.prototype,"overloadedReflectivity",void 0),r([n.serialize()],f.prototype,"overloadedReflectivityIntensity",void 0),r([n.serializeAsColor3()],f.prototype,"overloadedEmissive",void 0),r([n.serialize()],f.prototype,"overloadedEmissiveIntensity",void 0),r([n.serializeAsColor3()],f.prototype,"overloadedReflection",void 0),r([n.serialize()],f.prototype,"overloadedReflectionIntensity",void 0),r([n.serialize()],f.prototype,"overloadedMicroSurface",void 0),r([n.serialize()],f.prototype,"overloadedMicroSurfaceIntensity",void 0),r([n.serializeAsTexture()],f.prototype,"albedoTexture",void 0),r([n.serializeAsTexture()],f.prototype,"ambientTexture",void 0),r([n.serialize()],f.prototype,"ambientTextureStrength",void 0),r([n.serializeAsTexture()],f.prototype,"opacityTexture",void 0),r([n.serializeAsTexture()],f.prototype,"reflectionTexture",void 0),r([n.serializeAsTexture()],f.prototype,"emissiveTexture",void 0),r([n.serializeAsTexture()],f.prototype,"reflectivityTexture",void 0),r([n.serializeAsTexture()],f.prototype,"metallicTexture",void 0),r([n.serializeAsTexture()],f.prototype,"bumpTexture",void 0),r([n.serializeAsTexture()],f.prototype,"lightmapTexture",void 0),r([n.serializeAsTexture()],f.prototype,"refractionTexture",void 0),r([n.serializeAsColor3("ambient")],f.prototype,"ambientColor",void 0),r([n.serializeAsColor3("albedo")],f.prototype,"albedoColor",void 0),r([n.serializeAsColor3("reflectivity")],f.prototype,"reflectivityColor",void 0),r([n.serializeAsColor3("reflection")],f.prototype,"reflectionColor",void 0),r([n.serializeAsColor3("emissive")],f.prototype,"emissiveColor",void 0),r([n.serialize()],f.prototype,"microSurface",void 0),r([n.serialize()],f.prototype,"indexOfRefraction",void 0),r([n.serialize()],f.prototype,"invertRefractionY",void 0),r([n.serializeAsFresnelParameters()],f.prototype,"opacityFresnelParameters",void 0),r([n.serializeAsFresnelParameters()],f.prototype,"emissiveFresnelParameters",void 0),r([n.serialize()],f.prototype,"linkRefractionWithTransparency",void 0),r([n.serialize()],f.prototype,"linkEmissiveWithAlbedo",void 0),r([n.serialize()],f.prototype,"useLightmapAsShadowmap",void 0),r([n.serialize()],f.prototype,"useEmissiveAsIllumination",void 0),r([n.serialize()],f.prototype,"useAlphaFromAlbedoTexture",void 0),r([n.serialize()],f.prototype,"useSpecularOverAlpha",void 0),r([n.serialize()],f.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),r([n.serialize()],f.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),r([n.serialize()],f.prototype,"useRoughnessFromMetallicTextureGreen",void 0),r([n.serialize()],f.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),r([n.serialize()],f.prototype,"useScalarInLinearSpace",void 0),r([n.serialize()],f.prototype,"usePhysicalLightFalloff",void 0),r([n.serialize()],f.prototype,"useRadianceOverAlpha",void 0),r([n.serialize()],f.prototype,"useParallax",void 0),r([n.serialize()],f.prototype,"useParallaxOcclusion",void 0),r([n.serialize()],f.prototype,"parallaxScaleBias",void 0),r([n.serialize()],f.prototype,"disableLighting",void 0),r([n.serialize()],f.prototype,"maxSimultaneousLights",void 0),r([n.serialize()],f.prototype,"invertNormalMapX",void 0),r([n.serialize()],f.prototype,"invertNormalMapY",void 0),r([n.serialize()],f.prototype,"useLogarithmicDepth",null),f}(n.Material);n.PBRMaterial=i}(i||(i={}));!function(n){var t=function(){function t(t){var i=this;this._transformationMatrix=n.Matrix.Identity();this._enabled=!1;this._labelsEnabled=!1;this._displayStatistics=!0;this._displayTree=!1;this._displayLogs=!1;this._skeletonViewers=[];this._identityMatrix=n.Matrix.Identity();this.axisRatio=.02;this.accentColor="orange";this._scene=t;this._syncPositions=function(){var t=i._scene.getEngine(),n=t.getRenderingCanvasClientRect();i._showUI&&(i._statsDiv.style.left=n.width-410+"px",i._statsDiv.style.top=n.height-290+"px",i._statsDiv.style.width="400px",i._statsDiv.style.height="auto",i._statsSubsetDiv.style.maxHeight="240px",i._optionsDiv.style.left="0px",i._optionsDiv.style.top="10px",i._optionsDiv.style.width="200px",i._optionsDiv.style.height="auto",i._optionsSubsetDiv.style.maxHeight=n.height-225+"px",i._logDiv.style.left="0px",i._logDiv.style.top=n.height-170+"px",i._logDiv.style.width="600px",i._logDiv.style.height="160px",i._treeDiv.style.left=n.width-310+"px",i._treeDiv.style.top="10px",i._treeDiv.style.width="300px",i._treeDiv.style.height="auto",i._treeSubsetDiv.style.maxHeight=n.height-340+"px");i._globalDiv.style.left=n.left+"px";i._globalDiv.style.top=n.top+"px";i._drawingCanvas.style.left="0px";i._drawingCanvas.style.top="0px";i._drawingCanvas.style.width=t.getRenderWidth()+"px";i._drawingCanvas.style.height=t.getRenderHeight()+"px";var u=window.devicePixelRatio||1,r=i._drawingContext,f=r.webkitBackingStorePixelRatio||r.mozBackingStorePixelRatio||r.msBackingStorePixelRatio||r.oBackingStorePixelRatio||r.backingStorePixelRatio||1;i._ratio=u/f;i._drawingCanvas.width=t.getRenderWidth()*i._ratio;i._drawingCanvas.height=t.getRenderHeight()*i._ratio};this._onCanvasClick=function(n){i._clickPosition={x:n.clientX*i._ratio,y:n.clientY*i._ratio}};this._syncUI=function(){i._showUI&&(i._displayStatistics?(i._displayStats(),i._statsDiv.style.display=""):i._statsDiv.style.display="none",i._logDiv.style.display=i._displayLogs?"":"none",i._displayTree?(i._treeDiv.style.display="",i._needToRefreshMeshesTree&&(i._needToRefreshMeshesTree=!1,i._refreshMeshesTreeContent())):i._treeDiv.style.display="none")};this._syncData=function(){var r,a,h,e,c,u;if(i._labelsEnabled||!i._showUI){i._camera.getViewMatrix().multiplyToRef(i._camera.getProjectionMatrix(),i._transformationMatrix);i._drawingContext.clearRect(0,0,i._drawingCanvas.width,i._drawingCanvas.height);for(var f,o=i._scene.getEngine(),v=i._camera.viewport,s=v.toGlobal(o.getRenderWidth(),o.getRenderHeight()),l=i._camera.getActiveMeshes(),t=0;t<l.length;t++)r=l.data[t],a=r.getBoundingInfo().boundingSphere.center,f=n.Vector3.Project(a,r.getWorldMatrix(),i._transformationMatrix,s),(r.renderOverlay||i.shouldDisplayAxis&&i.shouldDisplayAxis(r))&&i._renderAxis(f,r,s),i.shouldDisplayLabel&&!i.shouldDisplayLabel(r)||i._renderLabel(r.name,f,12,function(){r.renderOverlay=!r.renderOverlay},function(){return r.renderOverlay?"red":"black"});for(h=i._scene.cameras,t=0;t<h.length;t++)e=h[t],e!==i._camera&&(f=n.Vector3.Project(n.Vector3.Zero(),e.getWorldMatrix(),i._transformationMatrix,s),i.shouldDisplayLabel&&!i.shouldDisplayLabel(e)||i._renderLabel(e.name,f,12,function(){i._camera.detachControl(o.getRenderingCanvas());i._camera=e;i._camera.attachControl(o.getRenderingCanvas())},function(){return"purple"}));for(c=i._scene.lights,t=0;t<c.length;t++)u=c[t],u.position&&(f=n.Vector3.Project(u.getAbsolutePosition(),i._identityMatrix,i._transformationMatrix,s),i.shouldDisplayLabel&&!i.shouldDisplayLabel(u)||i._renderLabel(u.name,f,-20,function(){u.setEnabled(!u.isEnabled())},function(){return u.isEnabled()?"orange":"gray"}))}i._clickPosition=void 0}}return t.prototype._refreshMeshesTreeContent=function(){for(var t,i,n;this._treeSubsetDiv.hasChildNodes();)this._treeSubsetDiv.removeChild(this._treeSubsetDiv.lastChild);for(t=this._scene.meshes.slice(0,this._scene.meshes.length),t.sort(function(n,t){return n.name===t.name?0:n.name>t.name?1:-1}),i=0;i<t.length;i++)n=t[i],n.isEnabled()&&this._generateAdvancedCheckBox(this._treeSubsetDiv,n.name,n.getTotalVertices()+" verts",n.isVisible,function(n,t){t.isVisible=n.checked},n)},t.prototype._renderSingleAxis=function(n,t,i,r,u){this._drawingContext.beginPath();this._drawingContext.moveTo(n.x,n.y);this._drawingContext.lineTo(t.x,t.y);this._drawingContext.strokeStyle=u;this._drawingContext.lineWidth=4;this._drawingContext.stroke();this._drawingContext.font="normal 14px Segoe UI";this._drawingContext.fillStyle=u;this._drawingContext.fillText(r,i.x,i.y)},t.prototype._renderAxis=function(t,i,r){var u=i.getBoundingInfo().boundingSphere.center,f=i.getWorldMatrix(),l=n.Vector3.UnprojectFromTransform(t.add(new n.Vector3(this._drawingCanvas.width*this.axisRatio,0,0)),r.width,r.height,f,this._transformationMatrix),e=l.subtract(u).length(),a=n.Vector3.Project(u.add(new n.Vector3(e,0,0)),f,this._transformationMatrix,r),v=n.Vector3.Project(u.add(new n.Vector3(1.5*e,0,0)),f,this._transformationMatrix,r),o,s,h,c;this._renderSingleAxis(t,a,v,"x","#FF0000");o=n.Vector3.Project(u.add(new n.Vector3(0,e,0)),f,this._transformationMatrix,r);s=n.Vector3.Project(u.add(new n.Vector3(0,1.5*e,0)),f,this._transformationMatrix,r);this._renderSingleAxis(t,o,s,"y","#00FF00");h=n.Vector3.Project(u.add(new n.Vector3(0,0,e)),f,this._transformationMatrix,r);c=n.Vector3.Project(u.add(new n.Vector3(0,0,1.5*e)),f,this._transformationMatrix,r);this._renderSingleAxis(t,h,c,"z","#0000FF")},t.prototype._renderLabel=function(n,t,i,r,u){if(t.z>0&&t.z<1){this._drawingContext.font="normal 12px Segoe UI";var e=this._drawingContext.measureText(n),o=t.x-e.width/2,f=t.y,s=this._drawingCanvas.getBoundingClientRect();this._showUI&&this._isClickInsideRect(s.left*this._ratio+o-5,s.top*this._ratio+f-i-12,e.width+10,17)&&r();this._drawingContext.beginPath();this._drawingContext.rect(o-5,f-i-12,e.width+10,17);this._drawingContext.fillStyle=u();this._drawingContext.globalAlpha=.5;this._drawingContext.fill();this._drawingContext.globalAlpha=1;this._drawingContext.strokeStyle="#FFFFFF";this._drawingContext.lineWidth=1;this._drawingContext.stroke();this._drawingContext.fillStyle="#FFFFFF";this._drawingContext.fillText(n,o,f-i);this._drawingContext.beginPath();this._drawingContext.arc(t.x,f,5,0,2*Math.PI,!1);this._drawingContext.fill()}},t.prototype._isClickInsideRect=function(n,t,i,r){return!!this._clickPosition&&!(this._clickPosition.x<n||this._clickPosition.x>n+i)&&!(this._clickPosition.y<t||this._clickPosition.y>t+r)},t.prototype.isVisible=function(){return this._enabled},t.prototype.hide=function(){if(this._enabled){this._enabled=!1;var t=this._scene.getEngine();this._scene.unregisterBeforeRender(this._syncData);this._scene.unregisterAfterRender(this._syncUI);this._rootElement.removeChild(this._globalDiv);this._scene.forceShowBoundingBoxes=!1;this._scene.forceWireframe=!1;n.StandardMaterial.DiffuseTextureEnabled=!0;n.StandardMaterial.AmbientTextureEnabled=!0;n.StandardMaterial.SpecularTextureEnabled=!0;n.StandardMaterial.EmissiveTextureEnabled=!0;n.StandardMaterial.BumpTextureEnabled=!0;n.StandardMaterial.OpacityTextureEnabled=!0;n.StandardMaterial.ReflectionTextureEnabled=!0;n.StandardMaterial.LightmapTextureEnabled=!0;n.StandardMaterial.RefractionTextureEnabled=!0;n.StandardMaterial.ColorGradingTextureEnabled=!0;this._scene.shadowsEnabled=!0;this._scene.particlesEnabled=!0;this._scene.postProcessesEnabled=!0;this._scene.collisionsEnabled=!0;this._scene.lightsEnabled=!0;this._scene.texturesEnabled=!0;this._scene.lensFlaresEnabled=!0;this._scene.proceduralTexturesEnabled=!0;this._scene.renderTargetsEnabled=!0;this._scene.probesEnabled=!0;t.getRenderingCanvas().removeEventListener("click",this._onCanvasClick);this._clearSkeletonViewers()}},t.prototype._clearSkeletonViewers=function(){for(var n=0;n<this._skeletonViewers.length;n++)this._skeletonViewers[n].dispose();this._skeletonViewers=[]},t.prototype.show=function(n,t,i){if(void 0===n&&(n=!0),void 0===t&&(t=null),void 0===i&&(i=null),!this._enabled){this._enabled=!0;this._camera=t?t:this._scene.activeCamera;this._showUI=n;var r=this._scene.getEngine();this._globalDiv=document.createElement("div");this._rootElement=i||document.body;this._rootElement.appendChild(this._globalDiv);this._generateDOMelements();r.getRenderingCanvas().addEventListener("click",this._onCanvasClick);this._syncPositions();this._scene.registerBeforeRender(this._syncData);this._scene.registerAfterRender(this._syncUI)}},t.prototype._clearLabels=function(){var n,t;for(this._drawingContext.clearRect(0,0,this._drawingCanvas.width,this._drawingCanvas.height),n=0;n<this._scene.meshes.length;n++)t=this._scene.meshes[n],t.renderOverlay=!1},t.prototype._generateheader=function(n,t){var i=document.createElement("div");i.innerHTML=t+"&nbsp;";i.style.textAlign="right";i.style.width="100%";i.style.color="white";i.style.backgroundColor="Black";i.style.padding="5px 5px 4px 0px";i.style.marginLeft="-5px";i.style.fontWeight="bold";n.appendChild(i)},t.prototype._generateTexBox=function(n,t,i){var r=document.createElement("label");r.style.display="inline";r.innerHTML=t;r.style.color=i;n.appendChild(r);n.appendChild(document.createElement("br"))},t.prototype._generateAdvancedCheckBox=function(n,t,i,r,u,f){var o,e;void 0===f&&(f=null);o=document.createElement("label");o.style.display="inline";e=document.createElement("input");e.type="checkbox";e.checked=r;e.style.display="inline";e.style.margin="0px 5px 0px 0px";e.style.verticalAlign="sub";e.addEventListener("change",function(n){u(n.target,f)});o.appendChild(e);var h=document.createElement("span"),c=document.createElement("span"),s=document.createElement("span");s.style.cssFloat="right";c.innerHTML=t;s.innerHTML=i;s.style.fontSize="12px";s.style.maxWidth="200px";h.appendChild(c);h.appendChild(s);o.appendChild(h);n.appendChild(o);n.appendChild(document.createElement("br"))},t.prototype._generateCheckBox=function(n,t,i,r,u){var e,f;void 0===u&&(u=null);e=document.createElement("label");e.style.display="inline";f=document.createElement("input");f.type="checkbox";f.checked=i;f.style.display="inline";f.style.margin="0px 5px 0px 0px";f.style.verticalAlign="sub";f.addEventListener("change",function(n){r(n.target,u)});e.appendChild(f);e.appendChild(document.createTextNode(t));n.appendChild(e);n.appendChild(document.createElement("br"))},t.prototype._generateButton=function(n,t,i,r){void 0===r&&(r=null);var u=document.createElement("button");u.innerHTML=t;u.style.height="24px";u.style.width="150px";u.style.marginBottom="5px";u.style.color="#444444";u.style.border="1px solid white";u.className="debugLayerButton";u.addEventListener("click",function(n){i(n.target,r)});n.appendChild(u);n.appendChild(document.createElement("br"))},t.prototype._generateRadio=function(n,t,i,r,u,f){var o,e;void 0===f&&(f=null);o=document.createElement("label");o.style.display="inline";e=document.createElement("input");e.type="radio";e.name=i;e.checked=r;e.style.display="inline";e.style.margin="0px 5px 0px 0px";e.style.verticalAlign="sub";e.addEventListener("change",function(n){u(n.target,f)});o.appendChild(e);o.appendChild(document.createTextNode(t));n.appendChild(o);n.appendChild(document.createElement("br"))},t.prototype._generateDOMelements=function(){var t=this,i,r;(this._globalDiv.id="DebugLayer",this._globalDiv.style.position="absolute",this._globalDiv.style.fontFamily="Segoe UI, Arial",this._globalDiv.style.fontSize="14px",this._globalDiv.style.color="white",this._drawingCanvas=document.createElement("canvas"),this._drawingCanvas.id="DebugLayerDrawingCanvas",this._drawingCanvas.style.position="absolute",this._drawingCanvas.style.pointerEvents="none",this._drawingCanvas.style.backgroundColor="transparent",this._drawingContext=this._drawingCanvas.getContext("2d"),this._globalDiv.appendChild(this._drawingCanvas),this._showUI)&&(i="rgba(128, 128, 128, 0.4)",r="rgb(180, 180, 180) solid 1px",this._statsDiv=document.createElement("div"),this._statsDiv.id="DebugLayerStats",this._statsDiv.style.border=r,this._statsDiv.style.position="absolute",this._statsDiv.style.background=i,this._statsDiv.style.padding="0px 0px 0px 5px",this._generateheader(this._statsDiv,"STATISTICS"),this._statsSubsetDiv=document.createElement("div"),this._statsSubsetDiv.style.paddingTop="5px",this._statsSubsetDiv.style.paddingBottom="5px",this._statsSubsetDiv.style.overflowY="auto",this._statsDiv.appendChild(this._statsSubsetDiv),this._treeDiv=document.createElement("div"),this._treeDiv.id="DebugLayerTree",this._treeDiv.style.border=r,this._treeDiv.style.position="absolute",this._treeDiv.style.background=i,this._treeDiv.style.padding="0px 0px 0px 5px",this._treeDiv.style.display="none",this._generateheader(this._treeDiv,"MESHES TREE"),this._treeSubsetDiv=document.createElement("div"),this._treeSubsetDiv.style.paddingTop="5px",this._treeSubsetDiv.style.paddingRight="5px",this._treeSubsetDiv.style.overflowY="auto",this._treeSubsetDiv.style.maxHeight="300px",this._treeDiv.appendChild(this._treeSubsetDiv),this._needToRefreshMeshesTree=!0,this._logDiv=document.createElement("div"),this._logDiv.style.border=r,this._logDiv.id="DebugLayerLogs",this._logDiv.style.position="absolute",this._logDiv.style.background=i,this._logDiv.style.padding="0px 0px 0px 5px",this._logDiv.style.display="none",this._generateheader(this._logDiv,"LOGS"),this._logSubsetDiv=document.createElement("div"),this._logSubsetDiv.style.height="127px",this._logSubsetDiv.style.paddingTop="5px",this._logSubsetDiv.style.overflowY="auto",this._logSubsetDiv.style.fontSize="12px",this._logSubsetDiv.style.fontFamily="consolas",this._logSubsetDiv.innerHTML=n.Tools.LogCache,this._logDiv.appendChild(this._logSubsetDiv),n.Tools.OnNewCacheEntry=function(n){t._logSubsetDiv.innerHTML=n+t._logSubsetDiv.innerHTML},this._optionsDiv=document.createElement("div"),this._optionsDiv.id="DebugLayerOptions",this._optionsDiv.style.border=r,this._optionsDiv.style.position="absolute",this._optionsDiv.style.background=i,this._optionsDiv.style.padding="0px 0px 0px 5px",this._optionsDiv.style.overflowY="auto",this._generateheader(this._optionsDiv,"OPTIONS"),this._optionsSubsetDiv=document.createElement("div"),this._optionsSubsetDiv.style.paddingTop="5px",this._optionsSubsetDiv.style.paddingBottom="5px",this._optionsSubsetDiv.style.overflowY="auto",this._optionsSubsetDiv.style.maxHeight="200px",this._optionsDiv.appendChild(this._optionsSubsetDiv),this._generateTexBox(this._optionsSubsetDiv,"<b>Windows:<\/b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Statistics",this._displayStatistics,function(n){t._displayStatistics=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Logs",this._displayLogs,function(n){t._displayLogs=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Meshes tree",this._displayTree,function(n){t._displayTree=n.checked;t._needToRefreshMeshesTree=!0}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>General:<\/b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Bounding boxes",this._scene.forceShowBoundingBoxes,function(n){t._scene.forceShowBoundingBoxes=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Clickable labels",this._labelsEnabled,function(n){t._labelsEnabled=n.checked;t._labelsEnabled||t._clearLabels()}),this._generateCheckBox(this._optionsSubsetDiv,"Generate user marks (F12)",n.Tools.PerformanceLogLevel===n.Tools.PerformanceUserMarkLogLevel,function(t){n.Tools.PerformanceLogLevel=t.checked?n.Tools.PerformanceUserMarkLogLevel:n.Tools.PerformanceNoneLogLevel}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Rendering mode:<\/b>",this.accentColor),this._generateRadio(this._optionsSubsetDiv,"Solid","renderMode",!this._scene.forceWireframe&&!this._scene.forcePointsCloud,function(n){n.checked&&(t._scene.forceWireframe=!1,t._scene.forcePointsCloud=!1)}),this._generateRadio(this._optionsSubsetDiv,"Wireframe","renderMode",this._scene.forceWireframe,function(n){n.checked&&(t._scene.forceWireframe=!0,t._scene.forcePointsCloud=!1)}),this._generateRadio(this._optionsSubsetDiv,"Point","renderMode",this._scene.forcePointsCloud,function(n){n.checked&&(t._scene.forceWireframe=!1,t._scene.forcePointsCloud=!0)}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Texture channels:<\/b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Diffuse",n.StandardMaterial.DiffuseTextureEnabled,function(t){n.StandardMaterial.DiffuseTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Ambient",n.StandardMaterial.AmbientTextureEnabled,function(t){n.StandardMaterial.AmbientTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Specular",n.StandardMaterial.SpecularTextureEnabled,function(t){n.StandardMaterial.SpecularTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Emissive",n.StandardMaterial.EmissiveTextureEnabled,function(t){n.StandardMaterial.EmissiveTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Bump",n.StandardMaterial.BumpTextureEnabled,function(t){n.StandardMaterial.BumpTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Opacity",n.StandardMaterial.OpacityTextureEnabled,function(t){n.StandardMaterial.OpacityTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Reflection",n.StandardMaterial.ReflectionTextureEnabled,function(t){n.StandardMaterial.ReflectionTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Refraction",n.StandardMaterial.RefractionTextureEnabled,function(t){n.StandardMaterial.RefractionTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"ColorGrading",n.StandardMaterial.ColorGradingTextureEnabled,function(t){n.StandardMaterial.ColorGradingTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Lightmap",n.StandardMaterial.LightmapTextureEnabled,function(t){n.StandardMaterial.LightmapTextureEnabled=t.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Fresnel",n.StandardMaterial.FresnelEnabled,function(t){n.StandardMaterial.FresnelEnabled=t.checked}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Options:<\/b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Animations",this._scene.animationsEnabled,function(n){t._scene.animationsEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Collisions",this._scene.collisionsEnabled,function(n){t._scene.collisionsEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Fog",this._scene.fogEnabled,function(n){t._scene.fogEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Lens flares",this._scene.lensFlaresEnabled,function(n){t._scene.lensFlaresEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Lights",this._scene.lightsEnabled,function(n){t._scene.lightsEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Particles",this._scene.particlesEnabled,function(n){t._scene.particlesEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Post-processes",this._scene.postProcessesEnabled,function(n){t._scene.postProcessesEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Probes",this._scene.probesEnabled,function(n){t._scene.probesEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Procedural textures",this._scene.proceduralTexturesEnabled,function(n){t._scene.proceduralTexturesEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Render targets",this._scene.renderTargetsEnabled,function(n){t._scene.renderTargetsEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Shadows",this._scene.shadowsEnabled,function(n){t._scene.shadowsEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Skeletons",this._scene.skeletonsEnabled,function(n){t._scene.skeletonsEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Sprites",this._scene.spritesEnabled,function(n){t._scene.spritesEnabled=n.checked}),this._generateCheckBox(this._optionsSubsetDiv,"Textures",this._scene.texturesEnabled,function(n){t._scene.texturesEnabled=n.checked}),n.AudioEngine&&n.Engine.audioEngine.canUseWebAudio&&(this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Audio:<\/b>",this.accentColor),this._generateRadio(this._optionsSubsetDiv,"Headphones","panningModel",this._scene.headphone,function(n){n.checked&&(t._scene.headphone=!0)}),this._generateRadio(this._optionsSubsetDiv,"Normal Speakers","panningModel",!this._scene.headphone,function(n){n.checked&&(t._scene.headphone=!1)}),this._generateCheckBox(this._optionsSubsetDiv,"Disable audio",!this._scene.audioEnabled,function(n){t._scene.audioEnabled=!n.checked})),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Viewers:<\/b>",this.accentColor),this._generateCheckBox(this._optionsSubsetDiv,"Skeletons",!1,function(i){var u,r,e,f,o;if(!i.checked)return void t._clearSkeletonViewers();for(u=0;u<t._scene.meshes.length;u++)if(r=t._scene.meshes[u],r.skeleton){for(e=!1,f=0;f<t._skeletonViewers.length;f++)if(t._skeletonViewers[f].skeleton===r.skeleton){e=!0;break}if(e)continue;o=new n.Debug.SkeletonViewer(r.skeleton,r,t._scene);o.isEnabled=!0;t._skeletonViewers.push(o)}}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._generateTexBox(this._optionsSubsetDiv,"<b>Tools:<\/b>",this.accentColor),this._generateButton(this._optionsSubsetDiv,"Dump rendertargets",function(){t._scene.dumpNextRenderTargets=!0}),this._generateButton(this._optionsSubsetDiv,"Run SceneOptimizer",function(){n.SceneOptimizer.OptimizeAsync(t._scene)}),this._generateButton(this._optionsSubsetDiv,"Log camera object",function(){t._camera?console.log(t._camera):console.warn("No camera defined, or debug layer created before camera creation!")}),this._optionsSubsetDiv.appendChild(document.createElement("br")),this._globalDiv.appendChild(this._statsDiv),this._globalDiv.appendChild(this._logDiv),this._globalDiv.appendChild(this._optionsDiv),this._globalDiv.appendChild(this._treeDiv))},t.prototype._displayStats=function(){var i=this._scene,t=i.getEngine(),r=t.getGlInfo();this._statsSubsetDiv.innerHTML="Babylon.js v"+n.Engine.Version+" - <b>"+n.Tools.Format(t.getFps(),0)+" fps<\/b><br><br><div style='column-count: 2;-moz-column-count:2;-webkit-column-count:2'><b>Count<\/b><br>Total meshes: "+i.meshes.length+"<br>Total lights: "+i.lights.length+"<br>Total vertices: "+i.getTotalVertices()+"<br>Total materials: "+i.materials.length+"<br>Total textures: "+i.textures.length+"<br>Active meshes: "+i.getActiveMeshes().length+"<br>Active indices: "+i.getActiveIndices()+"<br>Active bones: "+i.getActiveBones()+"<br>Active particles: "+i.getActiveParticles()+"<br><b>Draw calls: "+t.drawCalls+"<\/b><br><br><b>Duration<\/b><br>Meshes selection:<\/i> "+n.Tools.Format(i.getEvaluateActiveMeshesDuration())+" ms<br>Render Targets: "+n.Tools.Format(i.getRenderTargetsDuration())+" ms<br>Particles: "+n.Tools.Format(i.getParticlesDuration())+" ms<br>Sprites: "+n.Tools.Format(i.getSpritesDuration())+" ms<br><br>Render: <b>"+n.Tools.Format(i.getRenderDuration())+" ms<\/b><br>Frame: "+n.Tools.Format(i.getLastFrameDuration())+" ms<br>Potential FPS: "+n.Tools.Format(1e3/i.getLastFrameDuration(),0)+"<br>Resolution: "+t.getRenderWidth()+"x"+t.getRenderHeight()+"<br><br><\/div><div style='column-count: 2;-moz-column-count:2;-webkit-column-count:2'><b>Extensions<\/b><br>Std derivatives: "+(t.getCaps().standardDerivatives?"Yes":"No")+"<br>Compressed textures: "+(t.getCaps().s3tc?"Yes":"No")+"<br>Hardware instances: "+(t.getCaps().instancedArrays?"Yes":"No")+"<br>Texture float: "+(t.getCaps().textureFloat?"Yes":"No")+"<br><br>32bits indices: "+(t.getCaps().uintIndices?"Yes":"No")+"<br>Fragment depth: "+(t.getCaps().fragmentDepthSupported?"Yes":"No")+"<br>High precision shaders: "+(t.getCaps().highPrecisionShaderSupported?"Yes":"No")+"<br>Draw buffers: "+(t.getCaps().drawBuffersExtension?"Yes":"No")+"<br><\/div><br><div style='column-count: 2;-moz-column-count:2;-webkit-column-count:2'><b>Caps.<\/b><br>Stencil: "+(t.isStencilEnable?"Enabled":"Disabled")+"<br>Max textures units: "+t.getCaps().maxTexturesImageUnits+"<br>Max textures size: "+t.getCaps().maxTextureSize+"<br>Max anisotropy: "+t.getCaps().maxAnisotropy+"<br><b>Info<\/b><br>WebGL feature level: "+t.webGLVersion+"<br>"+r.version+"<br><\/div><br>"+r.renderer+"<br>";this.customStatsFunction&&(this._statsSubsetDiv.innerHTML+=this.customStatsFunction())},t}();n.DebugLayer=t}(i||(i={}));!function(n){var t=function(t){function i(i,r,u,f,e){var o=this;void 0===f&&(f=null);t.call(this,r.getEngine(),i);this.downSampleX4PostProcess=null;this.brightPassPostProcess=null;this.gaussianBlurHPostProcesses=[];this.gaussianBlurVPostProcesses=[];this.textureAdderPostProcess=null;this.textureAdderFinalPostProcess=null;this.lensFlarePostProcess=null;this.lensFlareComposePostProcess=null;this.depthOfFieldPostProcess=null;this.brightThreshold=1;this.blurWidth=2;this.gaussianCoefficient=.25;this.gaussianMean=1;this.gaussianStandardDeviation=1;this.exposure=1;this.lensTexture=null;this.lensColorTexture=null;this.lensFlareStrength=20;this.lensFlareGhostDispersal=1.4;this.lensFlareHaloWidth=.7;this.lensFlareDistortionStrength=16;this.lensStarTexture=null;this.lensFlareDirtTexture=null;this.depthOfFieldDistance=10;this.animations=[];this._depthRenderer=null;this._depthOfFieldEnabled=!0;this._lensFlareEnabled=!0;this._scene=r;this.originalPostProcess=f?f:new n.PostProcess("HDRPass","standard",[],[],u,null,n.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),!0,"#define PASS_POST_PROCESS",n.Engine.TEXTURETYPE_FLOAT);this.addEffect(new n.PostProcessRenderEffect(r.getEngine(),"HDRPassPostProcess",function(){return o.originalPostProcess},!0));this._createDownSampleX4PostProcess(r,u/2);this._createBrightPassPostProcess(r,u/2);this._createGaussianBlurPostProcesses(r,u/2,0);this._createGaussianBlurPostProcesses(r,u/4,1);this._createGaussianBlurPostProcesses(r,u/8,2);this._createGaussianBlurPostProcesses(r,u/16,3);this._createTextureAdderPostProcess(r,u);this.textureAdderFinalPostProcess=new n.PostProcess("HDRDepthOfFieldSource","standard",[],[],u,null,n.Texture.BILINEAR_SAMPLINGMODE,r.getEngine(),!0,"#define PASS_POST_PROCESS",n.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new n.PostProcessRenderEffect(r.getEngine(),"HDRDepthOfFieldSource",function(){return o.textureAdderFinalPostProcess},!0));this._createLensFlarePostProcess(r,u);this._createGaussianBlurPostProcesses(r,u/2,5);this._createDepthOfFieldPostProcess(r,u);r.postProcessRenderPipelineManager.addPipeline(this);null!==e&&r.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(i,e);this.LensFlareEnabled=!1;this.DepthOfFieldEnabled=!1}return u(i,t),Object.defineProperty(i.prototype,"DepthOfFieldEnabled",{get:function(){return this._depthOfFieldEnabled},set:function(n){var t=this.gaussianBlurHPostProcesses.length-1;n&&!this._depthOfFieldEnabled?(this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurH"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurV"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRDepthOfField",this._scene.cameras),this._depthRenderer=this._scene.enableDepthRenderer()):!n&&this._depthOfFieldEnabled&&(this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurH"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurV"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRDepthOfField",this._scene.cameras));this._depthOfFieldEnabled=n},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"LensFlareEnabled",{get:function(){return this._lensFlareEnabled},set:function(n){var t=this.gaussianBlurHPostProcesses.length-2;n&&!this._lensFlareEnabled?(this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRLensFlare",this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRLensFlareShift",this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurH"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRGaussianBlurV"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.enableEffectInPipeline(this._name,"HDRLensFlareCompose",this._scene.cameras)):!n&&this._lensFlareEnabled&&(this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRLensFlare",this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRLensFlareShift",this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurH"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRGaussianBlurV"+t,this._scene.cameras),this._scene.postProcessRenderPipelineManager.disableEffectInPipeline(this._name,"HDRLensFlareCompose",this._scene.cameras));this._lensFlareEnabled=n},enumerable:!0,configurable:!0}),i.prototype._createDownSampleX4PostProcess=function(t,i){var r=this,u=new Array(32);this.downSampleX4PostProcess=new n.PostProcess("HDRDownSampleX4","standard",["dsOffsets"],[],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define DOWN_SAMPLE_X4",n.Engine.TEXTURETYPE_UNSIGNED_INT);this.downSampleX4PostProcess.onApply=function(n){for(var f,t=0,i=-2;i<2;i++)for(f=-2;f<2;f++)u[t]=(i+.5)*(1/r.downSampleX4PostProcess.width),u[t+1]=(f+.5)*(1/r.downSampleX4PostProcess.height),t+=2;n.setArray2("dsOffsets",u)};this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRDownSampleX4",function(){return r.downSampleX4PostProcess},!0))},i.prototype._createBrightPassPostProcess=function(t,i){var u=this,r=new Array(8);this.brightPassPostProcess=new n.PostProcess("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define BRIGHT_PASS",n.Engine.TEXTURETYPE_UNSIGNED_INT);this.brightPassPostProcess.onApply=function(n){var t=1/u.brightPassPostProcess.width,i=1/u.brightPassPostProcess.height;r[0]=-.5*t;r[1]=.5*i;r[2]=.5*t;r[3]=.5*i;r[4]=-.5*t;r[5]=-.5*i;r[6]=.5*t;r[7]=-.5*i;n.setArray2("dsOffsets",r);n.setFloat("brightThreshold",u.brightThreshold)};this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRBrightPass",function(){return u.brightPassPostProcess},!0))},i.prototype._createGaussianBlurPostProcesses=function(t,i,r){var u=this,o=new Array(9),s=new Array(9),h=["blurOffsets","blurWeights","blurWidth"],c=function(n){return function(i){for(var e,h,f=0,r=0;r<9;r++)f=(r-4)/4,s[r]=u.gaussianCoefficient*(1/Math.sqrt(2*Math.PI*u.gaussianStandardDeviation))*Math.exp(-((f-u.gaussianMean)*(f-u.gaussianMean))/(2*u.gaussianStandardDeviation*u.gaussianStandardDeviation));for(e={width:t.getEngine().getRenderWidth(),height:t.getEngine().getRenderHeight()},r=0;r<9;r++)h=(r-4)*(1/(n===!0?e.height:e.width)),o[r]=h;i.setArray("blurOffsets",o);i.setArray("blurWeights",s);i.setFloat("blurWidth",u.blurWidth)}},e=new n.PostProcess("HDRGaussianBlurH"+i,"standard",h,[],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define GAUSSIAN_BLUR_H",n.Engine.TEXTURETYPE_UNSIGNED_INT),f;e.onApply=c(!1);f=new n.PostProcess("HDRGaussianBlurV"+i,"standard",h,[],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define GAUSSIAN_BLUR_V",n.Engine.TEXTURETYPE_UNSIGNED_INT);f.onApply=c(!0);this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRGaussianBlurH"+r,function(){return e},!0));this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRGaussianBlurV"+r,function(){return f},!0));this.gaussianBlurHPostProcesses.push(e);this.gaussianBlurVPostProcesses.push(f)},i.prototype._createTextureAdderPostProcess=function(t,i){var r=this;this.gaussianBlurVPostProcesses[3];this.textureAdderPostProcess=new n.PostProcess("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define TEXTURE_ADDER",n.Engine.TEXTURETYPE_UNSIGNED_INT);this.textureAdderPostProcess.onApply=function(n){n.setTextureFromPostProcess("otherSampler",r.originalPostProcess);n.setTexture("lensSampler",r.lensTexture);n.setFloat("exposure",r.exposure)};this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRTextureAdder",function(){return r.textureAdderPostProcess},!0))},i.prototype._createLensFlarePostProcess=function(t,i){var r=this,u,f,e;this.lensFlarePostProcess=new n.PostProcess("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],i/2,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!0,"#define LENS_FLARE",n.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRLensFlare",function(){return r.lensFlarePostProcess},!1));this._createGaussianBlurPostProcesses(t,i/4,4);this.lensFlareComposePostProcess=new n.PostProcess("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define LENS_FLARE_COMPOSE",n.Engine.TEXTURETYPE_UNSIGNED_INT);this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRLensFlareCompose",function(){return r.lensFlareComposePostProcess},!1));u=new n.Vector2(0,0);this.lensFlarePostProcess.onApply=function(n){n.setTextureFromPostProcess("textureSampler",r.gaussianBlurHPostProcesses[0]);n.setTexture("lensColorSampler",r.lensColorTexture);n.setFloat("strength",r.lensFlareStrength);n.setFloat("ghostDispersal",r.lensFlareGhostDispersal);n.setFloat("haloWidth",r.lensFlareHaloWidth);u.x=r.lensFlarePostProcess.width;u.y=r.lensFlarePostProcess.height;n.setVector2("resolution",u);n.setFloat("distortionStrength",r.lensFlareDistortionStrength)};f=n.Matrix.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1);e=n.Matrix.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=function(t){var u,o;t.setTextureFromPostProcess("otherSampler",r.textureAdderFinalPostProcess);t.setTexture("lensDirtSampler",r.lensFlareDirtTexture);t.setTexture("lensStarSampler",r.lensStarTexture);var s=r._scene.activeCamera.getViewMatrix().getRow(0),h=r._scene.activeCamera.getViewMatrix().getRow(2),i=n.Vector3.Dot(s.toVector3(),new n.Vector3(1,0,0))+n.Vector3.Dot(h.toVector3(),new n.Vector3(0,0,1));i*=4;u=n.Matrix.FromValues(.5*Math.cos(i),-Math.sin(i),0,0,Math.sin(i),.5*Math.cos(i),0,0,0,0,1,0,0,0,0,1);o=e.multiply(u).multiply(f);t.setMatrix("lensStarMatrix",o)}},i.prototype._createDepthOfFieldPostProcess=function(t,i){var r=this;this.depthOfFieldPostProcess=new n.PostProcess("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],i,null,n.Texture.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define DEPTH_OF_FIELD",n.Engine.TEXTURETYPE_UNSIGNED_INT);this.depthOfFieldPostProcess.onApply=function(n){n.setTextureFromPostProcess("otherSampler",r.textureAdderFinalPostProcess);n.setTexture("depthSampler",r._depthRenderer.getDepthMap());n.setFloat("distance",r.depthOfFieldDistance)};this.addEffect(new n.PostProcessRenderEffect(t.getEngine(),"HDRDepthOfField",function(){return r.depthOfFieldPostProcess},!0))},i.prototype.dispose=function(){for(var n,i,r=0;r<this._scene.cameras.length;r++){for(n=this._scene.cameras[r],this.originalPostProcess.dispose(n),this.downSampleX4PostProcess.dispose(n),this.brightPassPostProcess.dispose(n),this.textureAdderPostProcess.dispose(n),i=0;i<this.gaussianBlurHPostProcesses.length;i++)this.gaussianBlurHPostProcesses[i].dispose(n);for(i=0;i<this.gaussianBlurVPostProcesses.length;i++)this.gaussianBlurVPostProcesses[i].dispose(n);this.textureAdderFinalPostProcess.dispose(n);this.lensFlarePostProcess.dispose(n);this.lensFlareComposePostProcess.dispose(n);this.depthOfFieldPostProcess.dispose(n)}this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras);t.prototype.dispose.call(this)},i}(n.PostProcessRenderPipeline);n.StandardRenderingPipeline=t}(i||(i={}));i.Effect.ShadersStore={anaglyphPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D leftSampler;\nvoid main(void)\n{\nvec4 leftFrag=texture2D(leftSampler,vUV);\nleftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);\nvec4 rightFrag=texture2D(textureSampler,vUV);\nrightFrag=vec4(rightFrag.r,1.0,1.0,1.0);\ngl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);\n}",blackAndWhitePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nvoid main(void) \n{\nfloat luminance=dot(texture2D(textureSampler,vUV).rgb,vec3(0.3,0.59,0.11));\ngl_FragColor=vec4(luminance,luminance,luminance,1.0);\n}",blurPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\nbaseColor+=texture2D(textureSampler,start+texelOffset)*weights[i];\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",chromaticAberrationPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float chromatic_aberration;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\nvoid main(void)\n{\nvec2 centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nfloat radius2=centered_screen_pos.x*centered_screen_pos.x\n+centered_screen_pos.y*centered_screen_pos.y;\nfloat radius=sqrt(radius2);\nvec4 original=texture2D(textureSampler,vUV);\nif (chromatic_aberration>0.0) {\n\nvec3 ref_indices=vec3(-0.3,0.0,0.3);\nfloat ref_shiftX=chromatic_aberration*radius*17.0/screen_width;\nfloat ref_shiftY=chromatic_aberration*radius*17.0/screen_height;\n\nvec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);\nvec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);\nvec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);\noriginal.r=texture2D(textureSampler,ref_coords_r).r;\noriginal.g=texture2D(textureSampler,ref_coords_g).g;\noriginal.b=texture2D(textureSampler,ref_coords_b).b;\n}\ngl_FragColor=original;\n}",colorPixelShader:"uniform vec4 color;\nvoid main(void) {\ngl_FragColor=color;\n}",colorVertexShader:"\nattribute vec3 position;\n\nuniform mat4 worldViewProjection;\nvoid main(void) {\ngl_Position=worldViewProjection*vec4(position,1.0);\n}",colorCorrectionPixelShader:"\nuniform sampler2D textureSampler; \nuniform sampler2D colorTable; \n\nvarying vec2 vUV;\n\nconst float SLICE_COUNT=16.0; \n\nvec4 sampleAs3DTexture(sampler2D texture,vec3 uv,float width) {\nfloat sliceSize=1.0/width; \nfloat slicePixelSize=sliceSize/width; \nfloat sliceInnerSize=slicePixelSize*(width-1.0); \nfloat zSlice0=min(floor(uv.z*width),width-1.0);\nfloat zSlice1=min(zSlice0+1.0,width-1.0);\nfloat xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;\nfloat s0=xOffset+(zSlice0*sliceSize);\nfloat s1=xOffset+(zSlice1*sliceSize);\nvec4 slice0Color=texture2D(texture,vec2(s0,uv.y));\nvec4 slice1Color=texture2D(texture,vec2(s1,uv.y));\nfloat zOffset=mod(uv.z*width,1.0);\nvec4 result=mix(slice0Color,slice1Color,zOffset);\nreturn result;\n}\nvoid main(void)\n{\nvec4 screen_color=texture2D(textureSampler,vUV);\ngl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);\n}",convolutionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 screenSize;\nuniform float kernel[9];\nvoid main(void)\n{\nvec2 onePixel=vec2(1.0,1.0)/screenSize;\nvec4 colorSum =\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +\ntexture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +\ntexture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +\ntexture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];\nfloat kernelWeight =\nkernel[0] +\nkernel[1] +\nkernel[2] +\nkernel[3] +\nkernel[4] +\nkernel[5] +\nkernel[6] +\nkernel[7] +\nkernel[8];\nif (kernelWeight<=0.0) {\nkernelWeight=1.0;\n}\ngl_FragColor=vec4((colorSum/kernelWeight).rgb,1);\n}",defaultPixelShader:"#ifdef BUMP\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define RECIPROCAL_PI2 0.15915494\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n\n#include<helperFunctions>\n\n#include<lightFragmentDeclaration>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform sampler2D diffuseSampler;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform sampler2D ambientSampler;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nvarying vec2 vOpacityUV;\nuniform sampler2D opacitySampler;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform sampler2D lightmapSampler;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform sampler2D specularSampler;\n#endif\n\n#include<fresnelFunction>\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#endif\n#include<reflectionFunction>\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif\n#ifdef CAMERACOLORGRADING\n#include<colorGradingDefinition> \n#include<colorGrading>\n#endif\n#ifdef CAMERACOLORCURVES\n#include<colorCurvesDefinition>\n#include<colorCurves>\n#endif\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\n\nfloat alpha=vDiffuseColor.a;\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(1.0,1.0,1.0);\n#endif\n#include<bumpFragment>\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#ifdef VERTEXCOLOR\nbaseColor.rgb*=vColor.rgb;\n#endif\n\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\n\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\n\nvec3 refractionColor=vec3(0.,0.,0.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0)\n{\nrefractionColor=textureCube(refractionCubeSampler,refractionVector).rgb*vRefractionInfos.x;\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords).rgb*vRefractionInfos.x;\n#endif\n#endif\n\nvec3 reflectionColor=vec3(0.,0.,0.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias).rgb*vReflectionInfos.x;\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW).rgb*vReflectionInfos.x;\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords).rgb*vReflectionInfos.x;\n#endif\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+emissiveColor+refractionColor,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+refractionColor,alpha);\n#endif\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor;\n#else\ncolor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n#include<logDepthFragment>\n#include<fogFragment>\n#ifdef CAMERACOLORGRADING\ncolor=colorGrades(color);\n#endif\n#ifdef CAMERACOLORCURVES\ncolor.rgb=applyColorCurves(color.rgb);\n#endif\ngl_FragColor=color;\n}",defaultVertexShader:"\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef DIFFUSE\nvarying vec2 vDiffuseUV;\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nvarying vec2 vOpacityUV;\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nvarying vec2 vSpecularUV;\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#include<pointCloudVertexDeclaration>\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<shadowsVertexDeclaration>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef DIFFUSE\nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef AMBIENT\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef OPACITY\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef EMISSIVE\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef LIGHTMAP\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nif (vSpecularInfos.x == 0.)\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef BUMP\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n#include<pointCloudVertex>\n#include<logDepthVertex>\n}",depthPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nuniform float far;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\nfloat depth=(gl_FragCoord.z/gl_FragCoord.w)/far;\ngl_FragColor=vec4(depth,depth*depth,0.0,1.0);\n}",depthVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#if defined(ALPHATEST) || defined(BASIC_RENDER)\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",depthBoxBlurPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nvoid main(void)\n{\nvec4 colorDepth=vec4(0.0);\nfor (int x=-OFFSET; x<=OFFSET; x++)\nfor (int y=-OFFSET; y<=OFFSET; y++)\ncolorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);\ngl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));\n}",depthOfFieldPixelShader:"\n\n\n\n\nuniform sampler2D textureSampler;\nuniform sampler2D highlightsSampler;\nuniform sampler2D depthSampler;\nuniform sampler2D grainSampler;\n\nuniform float grain_amount;\nuniform bool blur_noise;\nuniform float screen_width;\nuniform float screen_height;\nuniform float distortion;\nuniform bool dof_enabled;\n\nuniform float screen_distance; \nuniform float aperture;\nuniform float darken;\nuniform float edge_blur;\nuniform bool highlights;\n\nuniform float near;\nuniform float far;\n\nvarying vec2 vUV;\n\n#define PI 3.14159265\n#define TWOPI 6.28318530\n#define inverse_focal_length 0.1 \n\nvec2 centered_screen_pos;\nvec2 distorted_coords;\nfloat radius2;\nfloat radius;\n\nvec2 rand(vec2 co)\n{\nfloat noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));\nfloat noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));\nreturn clamp(vec2(noise1,noise2),0.0,1.0);\n}\n\nvec2 getDistortedCoords(vec2 coords) {\nif (distortion == 0.0) { return coords; }\nvec2 direction=1.0*normalize(centered_screen_pos);\nvec2 dist_coords=vec2(0.5,0.5);\ndist_coords.x=0.5+direction.x*radius2*1.0;\ndist_coords.y=0.5+direction.y*radius2*1.0;\nfloat dist_amount=clamp(distortion*0.23,0.0,1.0);\ndist_coords=mix(coords,dist_coords,dist_amount);\nreturn dist_coords;\n}\n\nfloat sampleScreen(inout vec4 color,const in vec2 offset,const in float weight) {\n\nvec2 coords=distorted_coords;\nfloat angle=rand(coords*100.0).x*TWOPI;\ncoords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));\ncolor+=texture2D(textureSampler,coords)*weight;\nreturn weight;\n}\n\nfloat getBlurLevel(float size) {\nreturn min(3.0,ceil(size/1.0));\n}\n\nvec4 getBlurColor(float size) {\nvec4 col=texture2D(textureSampler,distorted_coords);\nif (size == 0.0) { return col; }\n\n\nfloat blur_level=getBlurLevel(size);\nfloat w=(size/screen_width);\nfloat h=(size/screen_height);\nfloat total_weight=1.0;\nvec2 sample_coords;\ntotal_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);\ntotal_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);\ntotal_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);\ntotal_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);\ntotal_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);\ntotal_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);\ntotal_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);\ntotal_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);\ntotal_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);\nif (blur_level>1.0) {\ntotal_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);\ntotal_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);\ntotal_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);\ntotal_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);\ntotal_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);\ntotal_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);\ntotal_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);\ntotal_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);\ntotal_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);\ntotal_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);\n}\nif (blur_level>2.0) {\ntotal_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);\ntotal_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);\ntotal_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);\ntotal_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);\ntotal_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);\ntotal_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);\ntotal_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);\ntotal_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);\ntotal_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);\n}\ncol/=total_weight; \n\nif (darken>0.0) {\ncol.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);\n}\n\n\n\n\nreturn col;\n}\nvoid main(void)\n{\n\ncentered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);\nradius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;\nradius=sqrt(radius2);\ndistorted_coords=getDistortedCoords(vUV); \nvec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); \nfloat depth=texture2D(depthSampler,distorted_coords).r; \nfloat distance=near+(far-near)*depth; \nvec4 color=texture2D(textureSampler,vUV); \n\n\nfloat coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));\n\nif (dof_enabled == false || coc<0.07) { coc=0.0; }\n\nfloat edge_blur_amount=0.0;\nif (edge_blur>0.0) {\nedge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;\n}\n\nfloat blur_amount=max(edge_blur_amount,coc);\n\nif (blur_amount == 0.0) {\ngl_FragColor=texture2D(textureSampler,distorted_coords);\n}\nelse {\n\ngl_FragColor=getBlurColor(blur_amount*1.7);\n\nif (highlights) {\ngl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;\n}\nif (blur_noise) {\n\nvec2 noise=rand(distorted_coords)*0.01*blur_amount;\nvec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);\ngl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;\n}\n}\n\nif (grain_amount>0.0) {\nvec4 grain_color=texture2D(grainSampler,texels_coords*0.003);\ngl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;\n}\n}\n",displayPassPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D passSampler;\nvoid main(void)\n{\ngl_FragColor=texture2D(passSampler,vUV);\n}",filterPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform mat4 kernelMatrix;\nvoid main(void)\n{\nvec3 baseColor=texture2D(textureSampler,vUV).rgb;\nvec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;\ngl_FragColor=vec4(updatedColor,1.0);\n}",fxaaPixelShader:"#define FXAA_REDUCE_MIN (1.0/128.0)\n#define FXAA_REDUCE_MUL (1.0/8.0)\n#define FXAA_SPAN_MAX 8.0\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 texelSize;\nvoid main(){\nvec2 localTexelSize=texelSize;\nvec4 rgbNW=texture2D(textureSampler,(vUV+vec2(-1.0,-1.0)*localTexelSize));\nvec4 rgbNE=texture2D(textureSampler,(vUV+vec2(1.0,-1.0)*localTexelSize));\nvec4 rgbSW=texture2D(textureSampler,(vUV+vec2(-1.0,1.0)*localTexelSize));\nvec4 rgbSE=texture2D(textureSampler,(vUV+vec2(1.0,1.0)*localTexelSize));\nvec4 rgbM=texture2D(textureSampler,vUV);\nvec4 luma=vec4(0.299,0.587,0.114,1.0);\nfloat lumaNW=dot(rgbNW,luma);\nfloat lumaNE=dot(rgbNE,luma);\nfloat lumaSW=dot(rgbSW,luma);\nfloat lumaSE=dot(rgbSE,luma);\nfloat lumaM=dot(rgbM,luma);\nfloat lumaMin=min(lumaM,min(min(lumaNW,lumaNE),min(lumaSW,lumaSE)));\nfloat lumaMax=max(lumaM,max(max(lumaNW,lumaNE),max(lumaSW,lumaSE)));\nvec2 dir=vec2(-((lumaNW+lumaNE)-(lumaSW+lumaSE)),((lumaNW+lumaSW)-(lumaNE+lumaSE)));\nfloat dirReduce=max(\n(lumaNW+lumaNE+lumaSW+lumaSE)*(0.25*FXAA_REDUCE_MUL),\nFXAA_REDUCE_MIN);\nfloat rcpDirMin=1.0/(min(abs(dir.x),abs(dir.y))+dirReduce);\ndir=min(vec2(FXAA_SPAN_MAX,FXAA_SPAN_MAX),\nmax(vec2(-FXAA_SPAN_MAX,-FXAA_SPAN_MAX),\ndir*rcpDirMin))*localTexelSize;\nvec4 rgbA=0.5*(\ntexture2D(textureSampler,vUV+dir*(1.0/3.0-0.5)) +\ntexture2D(textureSampler,vUV+dir*(2.0/3.0-0.5)));\nvec4 rgbB=rgbA*0.5+0.25*(\ntexture2D(textureSampler,vUV+dir*-0.5) +\ntexture2D(textureSampler,vUV+dir*0.5));\nfloat lumaB=dot(rgbB,luma);\nif ((lumaB<lumaMin) || (lumaB>lumaMax)) {\ngl_FragColor=rgbA;\n}\nelse {\ngl_FragColor=rgbB;\n}\n}",glowBlurPostProcessPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec2 screenSize;\nuniform vec2 direction;\nuniform float blurWidth;\n\nfloat getLuminance(vec3 color)\n{\nreturn dot(color,vec3(0.2126,0.7152,0.0722));\n}\nvoid main(void)\n{\nfloat weights[7];\nweights[0]=0.05;\nweights[1]=0.1;\nweights[2]=0.2;\nweights[3]=0.3;\nweights[4]=0.2;\nweights[5]=0.1;\nweights[6]=0.05;\nvec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);\nvec2 texelStep=texelSize*direction*blurWidth;\nvec2 start=vUV-3.0*texelStep;\nvec4 baseColor=vec4(0.,0.,0.,0.);\nvec2 texelOffset=vec2(0.,0.);\nfor (int i=0; i<7; i++)\n{\n\nvec4 texel=texture2D(textureSampler,start+texelOffset);\nbaseColor.a+=texel.a*weights[i];\n\nfloat luminance=getLuminance(baseColor.rgb);\nfloat luminanceTexel=getLuminance(texel.rgb);\nfloat choice=step(luminanceTexel,luminance);\nbaseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;\ntexelOffset+=texelStep;\n}\ngl_FragColor=baseColor;\n}",glowMapGenerationPixelShader:"#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform sampler2D emissiveSampler;\n#endif\nuniform vec4 color;\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUVDiffuse).a<0.4)\ndiscard;\n#endif\n#ifdef EMISSIVE\ngl_FragColor=texture2D(emissiveSampler,vUVEmissive);\n#else\ngl_FragColor=color;\n#endif\n}",glowMapGenerationVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef ALPHATEST\nvarying vec2 vUVDiffuse;\nuniform mat4 diffuseMatrix;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vUVEmissive;\nuniform mat4 emissiveMatrix;\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\n#ifdef CUBEMAP\nvPosition=finalWorld*vec4(position,1.0);\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*finalWorld*vec4(position,1.0);\ngl_Position=vPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef DIFFUSEUV1\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef DIFFUSEUV2\nvUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n#ifdef EMISSIVE\n#ifdef EMISSIVEUV1\nvUVEmissive=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef EMISSIVEUV2\nvUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",glowMapMergePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float offset;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\nbaseColor.a=abs(offset-baseColor.a);\ngl_FragColor=baseColor;\n}",glowMapMergeVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) {\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",hdrPixelShader:"uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#if defined(GAUSSIAN_BLUR_H) || defined(GAUSSIAN_BLUR_V)\nuniform float blurOffsets[9];\nuniform float blurWeights[9];\nuniform float multiplier;\nvoid main(void) {\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfor (int i=0; i<9; i++) {\n#ifdef GAUSSIAN_BLUR_H\ncolor+=(texture2D(textureSampler,vUV+vec2(blurOffsets[i]*multiplier,0.0))*blurWeights[i]);\n#else\ncolor+=(texture2D(textureSampler,vUV+vec2(0.0,blurOffsets[i]*multiplier))*blurWeights[i]);\n#endif\n}\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nvoid main() {\nvec4 sum=texture2D(textureSampler,vUV)+texture2D(otherSampler,vUV);\nsum.a=clamp(sum.a,0.0,1.0);\ngl_FragColor=sum;\n}\n#endif\n#if defined(LUMINANCE_GENERATOR)\nuniform vec2 lumOffsets[4];\nvoid main() {\nfloat average=0.0;\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfloat maximum=-1e20;\nfor (int i=0; i<4; i++) {\ncolor=texture2D(textureSampler,vUV+lumOffsets[i]);\nfloat GreyValue=length(color.rgb);\nmaximum=max(maximum,GreyValue);\naverage+=(0.25*log(1e-5+GreyValue));\n}\naverage=exp(average);\ngl_FragColor=vec4(average,maximum,0.0,1.0);\n}\n#endif\n#if defined(DOWN_SAMPLE)\nuniform vec2 dsOffsets[9];\nuniform float halfDestPixelSize;\n#ifdef FINAL_DOWN_SAMPLE\nvec4 pack(float value) {\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(value*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n#endif\nvoid main() {\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfloat average=0.0;\nfor (int i=0; i<9; i++) {\ncolor=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);\naverage+=color.r;\n}\naverage/=9.0;\n#ifndef FINAL_DOWN_SAMPLE\ngl_FragColor=vec4(average,average,0.0,1.0);\n#else\ngl_FragColor=pack(average);\n#endif\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main() {\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main() {\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(HDR)\nuniform sampler2D otherSampler;\nuniform float exposure;\nuniform float avgLuminance;\nvoid main() {\nvec4 color=texture2D(textureSampler,vUV)+texture2D(otherSampler,vUV);\nvec4 adjustedColor=color/avgLuminance*exposure;\ncolor=adjustedColor;\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n",layerPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\n#ifdef ALPHATEST\nif (baseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=baseColor*color;\n}",layerVertexShader:"\nattribute vec2 position;\n\nuniform vec2 scale;\nuniform vec2 offset;\nuniform mat4 textureMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvec2 shiftedPosition=position*scale+offset;\nvUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));\ngl_Position=vec4(shiftedPosition,0.0,1.0);\n}",lensFlarePixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform vec4 color;\nvoid main(void) {\nvec4 baseColor=texture2D(textureSampler,vUV);\ngl_FragColor=baseColor*color;\n}",lensFlareVertexShader:"\nattribute vec2 position;\n\nuniform mat4 viewportMatrix;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=position*madd+madd;\ngl_Position=viewportMatrix*vec4(position,0.0,1.0);\n}",lensHighlightsPixelShader:"\nuniform sampler2D textureSampler; \n\nuniform float gain;\nuniform float threshold;\nuniform float screen_width;\nuniform float screen_height;\n\nvarying vec2 vUV;\n\nvec4 highlightColor(vec4 color) {\nvec4 highlight=color;\nfloat luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));\nfloat lum_threshold;\nif (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }\nelse { lum_threshold=0.5+0.44*threshold; }\nluminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);\nhighlight*=luminance*gain;\nhighlight.a=1.0;\nreturn highlight;\n}\nvoid main(void)\n{\nvec4 original=texture2D(textureSampler,vUV);\n\nif (gain == -1.0) {\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nreturn;\n}\nfloat w=2.0/screen_width;\nfloat h=2.0/screen_height;\nfloat weight=1.0;\n\nvec4 blurred=vec4(0.0,0.0,0.0,0.0);\n#ifdef PENTAGON\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));\n#else\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));\nblurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));\n#endif\nblurred/=39.0;\ngl_FragColor=blurred;\n\n}",linePixelShader:"uniform vec4 color;\nvoid main(void) {\ngl_FragColor=color;\n}",lineVertexShader:"\nattribute vec3 position;\nattribute vec4 normal;\n\nuniform mat4 worldViewProjection;\nuniform float width;\nuniform float aspectRatio;\nvoid main(void) {\nvec4 viewPosition=worldViewProjection*vec4(position,1.0);\nvec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);\nvec2 currentScreen=viewPosition.xy/viewPosition.w;\nvec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;\ncurrentScreen.x*=aspectRatio;\nnextScreen.x*=aspectRatio;\nvec2 dir=normalize(nextScreen-currentScreen);\nvec2 normalDir=vec2(-dir.y,dir.x);\nnormalDir*=width/2.0;\nnormalDir.x/=aspectRatio;\nvec4 offset=vec4(normalDir*normal.w,0.0,0.0);\ngl_Position=viewPosition+offset;\n}",outlinePixelShader:"uniform vec4 color;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\nvoid main(void) {\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\ngl_FragColor=color;\n}",outlineVertexShader:"\nattribute vec3 position;\nattribute vec3 normal;\n#include<bonesDeclaration>\n\nuniform float offset;\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\nvec3 offsetPosition=position+normal*offset;\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(offsetPosition,1.0);\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}\n",particlesPixelShader:"\nvarying vec2 vUV;\nvarying vec4 vColor;\nuniform vec4 textureMask;\nuniform sampler2D diffuseSampler;\n#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif\nvoid main(void) {\n#ifdef CLIPPLANE\nif (fClipDistance>0.0)\ndiscard;\n#endif\nvec4 baseColor=texture2D(diffuseSampler,vUV);\ngl_FragColor=(baseColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;\n}",particlesVertexShader:"\nattribute vec3 position;\nattribute vec4 color;\nattribute vec4 options;\n\nuniform mat4 view;\nuniform mat4 projection;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nuniform mat4 invView;\nvarying float fClipDistance;\n#endif\nvoid main(void) { \nvec3 viewPos=(view*vec4(position,1.0)).xyz; \nvec3 cornerPos;\nfloat size=options.y;\nfloat angle=options.x;\nvec2 offset=options.zw;\ncornerPos=vec3(offset.x-0.5,offset.y-0.5,0.)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \nvColor=color;\nvUV=offset;\n\n#ifdef CLIPPLANE\nvec4 worldPos=invView*vec4(viewPos,1.0);\nfClipDistance=dot(worldPos,vClipPlane);\n#endif\n}",passPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nvoid main(void) \n{\ngl_FragColor=texture2D(textureSampler,vUV);\n}",pbrPixelShader:"#ifdef BUMP\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\nprecision highp float;\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\n\nuniform vec4 vLightingIntensity;\nuniform vec4 vCameraInfos;\n#ifdef OVERLOADEDVALUES\nuniform vec4 vOverloadedIntensity;\nuniform vec3 vOverloadedAmbient;\nuniform vec3 vOverloadedAlbedo;\nuniform vec3 vOverloadedReflectivity;\nuniform vec3 vOverloadedEmissive;\nuniform vec3 vOverloadedReflection;\nuniform vec3 vOverloadedMicroSurface;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nuniform vec4 vOverloadedShadowIntensity;\n#endif\n#if defined(REFLECTION) || defined(REFRACTION)\nuniform vec2 vMicrosurfaceTextureLods;\n#endif\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n\n#include<lightFragmentDeclaration>[0..maxSimultaneousLights]\n\n#ifdef ALBEDO\nvarying vec2 vAlbedoUV;\nuniform sampler2D albedoSampler;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform sampler2D ambientSampler;\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef OPACITY \nvarying vec2 vOpacityUV;\nuniform sampler2D opacitySampler;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform sampler2D lightmapSampler;\n#endif\n#if defined(REFLECTIVITY) || defined(METALLICWORKFLOW) \nvarying vec2 vReflectivityUV;\nuniform vec2 vReflectivityInfos;\nuniform sampler2D reflectivitySampler;\n#endif\n\n#include<fresnelFunction>\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\nuniform mat4 refractionMatrix;\n#endif\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#ifdef CAMERACOLORGRADING\n#include<colorGradingDefinition>\n#endif\n#ifdef CAMERACOLORCURVES\n#include<colorCurvesDefinition>\n#endif\n\n#include<pbrShadowFunctions>\n#include<pbrFunctions>\n#ifdef CAMERACOLORGRADING\n#include<colorGrading>\n#endif\n#ifdef CAMERACOLORCURVES\n#include<colorCurves>\n#endif\n#include<harmonicsFunctions>\n#include<pbrLightFunctions>\n#include<helperFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=vec3(1.0,1.0,1.0);\n#endif\n#include<bumpFragment>\n\nvec4 surfaceAlbedo=vec4(1.,1.,1.,1.);\nvec3 surfaceAlbedoContribution=vAlbedoColor.rgb;\n\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\nsurfaceAlbedo=texture2D(albedoSampler,vAlbedoUV+uvOffset);\nsurfaceAlbedo=vec4(toLinearSpace(surfaceAlbedo.rgb),surfaceAlbedo.a);\n#ifndef LINKREFRACTIONTOTRANSPARENCY\n#ifdef ALPHATEST\nif (surfaceAlbedo.a<0.4)\ndiscard;\n#endif\n#endif\n#ifdef ALPHAFROMALBEDO\nalpha*=surfaceAlbedo.a;\n#endif\nsurfaceAlbedo.rgb*=vAlbedoInfos.y;\n#else\n\nsurfaceAlbedo.rgb=surfaceAlbedoContribution;\nsurfaceAlbedoContribution=vec3(1.,1.,1.);\n#endif\n#ifdef VERTEXCOLOR\nsurfaceAlbedo.rgb*=vColor.rgb;\n#endif\n#ifdef OVERLOADEDVALUES\nsurfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,vOverloadedAlbedo,vOverloadedIntensity.y);\n#endif\n\nvec3 ambientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nambientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\nambientColor=vec3(1.,1.,1.)-((vec3(1.,1.,1.)-ambientColor)*vAmbientInfos.z);\n#ifdef OVERLOADEDVALUES\nambientColor.rgb=mix(ambientColor.rgb,vOverloadedAmbient,vOverloadedIntensity.x);\n#endif\n#endif\n\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef OVERLOADEDVALUES\nsurfaceReflectivityColor.rgb=mix(surfaceReflectivityColor.rgb,vOverloadedReflectivity,vOverloadedIntensity.z);\n#endif\n#ifdef REFLECTIVITY\nvec4 surfaceReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nsurfaceReflectivityColor=surfaceReflectivityColorMap.rgb;\nsurfaceReflectivityColor=toLinearSpace(surfaceReflectivityColor);\n#ifdef OVERLOADEDVALUES\nsurfaceReflectivityColor=mix(surfaceReflectivityColor,vOverloadedReflectivity,vOverloadedIntensity.z);\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface=surfaceReflectivityColorMap.a;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#endif\n#endif\n#ifdef METALLICWORKFLOW\nvec4 surfaceMetallicColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\n\nfloat metallic=surfaceMetallicColorMap.r; \n\nvec3 baseColor=surfaceAlbedo.rgb;\n\nsurfaceAlbedo.rgb*=(1.0-metallic);\n\n\nconst vec3 DefaultSpecularReflectanceDielectric=vec3(0.04,0.04,0.04);\n\nsurfaceReflectivityColor=mix(DefaultSpecularReflectanceDielectric,baseColor,metallic);\n#ifdef OVERLOADEDVALUES\nsurfaceReflectivityColor=mix(surfaceReflectivityColor,vOverloadedReflectivity,vOverloadedIntensity.z);\n#endif\n#ifdef METALLICROUGHNESSGSTOREINALPHA\nmicroSurface=1.0-surfaceMetallicColorMap.a;\n#else\n#ifdef METALLICROUGHNESSGSTOREINGREEN\nmicroSurface=1.0-surfaceMetallicColorMap.g;\n#endif\n#endif\n#endif\n#ifdef OVERLOADEDVALUES\nmicroSurface=mix(microSurface,vOverloadedMicroSurface.x,vOverloadedMicroSurface.y);\n#endif\n\nfloat NdotV=max(0.00000000001,dot(normalW,viewDirectionW));\n\nmicroSurface=clamp(microSurface,0.,1.)*0.98;\n\nfloat roughness=clamp(1.-microSurface,0.000001,1.0);\n\nvec3 lightDiffuseContribution=vec3(0.,0.,0.);\n#ifdef OVERLOADEDSHADOWVALUES\nvec3 shadowedOnlyLightDiffuseContribution=vec3(1.,1.,1.);\n#endif\n#ifdef SPECULARTERM\nvec3 lightSpecularContribution=vec3(0.,0.,0.);\n#endif\nfloat notShadowLevel=1.; \n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\nfloat NdotL=-1.;\nlightingInfo info;\n\nfloat reflectance=max(max(surfaceReflectivityColor.r,surfaceReflectivityColor.g),surfaceReflectivityColor.b);\n\n\nfloat reflectance90=clamp(reflectance*25.0,0.0,1.0);\nvec3 specularEnvironmentR0=surfaceReflectivityColor.rgb;\nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0)*reflectance90;\n#include<pbrLightFunctionsCall>[0..maxSimultaneousLights]\n#ifdef SPECULARTERM\nlightSpecularContribution*=vLightingIntensity.w;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 surfaceRefractionColor=vec3(0.,0.,0.);\n\n#ifdef LODBASEDMICROSFURACE\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\n#endif\n#ifdef REFRACTION\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFRACTION\nfloat lodRefraction=getMipMapIndexFromAverageSlopeWithPMREM(vMicrosurfaceTextureLods.y,alphaG);\n#else\nfloat lodRefraction=getMipMapIndexFromAverageSlope(vMicrosurfaceTextureLods.y,alphaG);\n#endif\n#else\nfloat biasRefraction=(vMicrosurfaceTextureLods.y+2.)*(1.0-microSurface);\n#endif\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0)\n{\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFRACTION\n\nif ((vMicrosurfaceTextureLods.y-lodRefraction)>4.0)\n{\n\nfloat scaleRefraction=1.-exp2(lodRefraction)/exp2(vMicrosurfaceTextureLods.y); \nfloat maxRefraction=max(max(abs(refractionVector.x),abs(refractionVector.y)),abs(refractionVector.z));\nif (abs(refractionVector.x) != maxRefraction) refractionVector.x*=scaleRefraction;\nif (abs(refractionVector.y) != maxRefraction) refractionVector.y*=scaleRefraction;\nif (abs(refractionVector.z) != maxRefraction) refractionVector.z*=scaleRefraction;\n}\n#endif\nsurfaceRefractionColor=textureCubeLodEXT(refractionCubeSampler,refractionVector,lodRefraction).rgb*vRefractionInfos.x;\n#else\nsurfaceRefractionColor=textureCube(refractionCubeSampler,refractionVector,biasRefraction).rgb*vRefractionInfos.x;\n#endif\n}\n#ifndef REFRACTIONMAPINLINEARSPACE\nsurfaceRefractionColor=toLinearSpace(surfaceRefractionColor.rgb);\n#endif\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#ifdef LODBASEDMICROSFURACE\nsurfaceRefractionColor=texture2DLodEXT(refraction2DSampler,refractionCoords,lodRefraction).rgb*vRefractionInfos.x;\n#else\nsurfaceRefractionColor=texture2D(refraction2DSampler,refractionCoords,biasRefraction).rgb*vRefractionInfos.x;\n#endif \nsurfaceRefractionColor=toLinearSpace(surfaceRefractionColor.rgb);\n#endif\n#endif\n\nvec3 environmentRadiance=vReflectionColor.rgb;\nvec3 environmentIrradiance=vReflectionColor.rgb;\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFLECTION\nfloat lodReflection=getMipMapIndexFromAverageSlopeWithPMREM(vMicrosurfaceTextureLods.x,alphaG);\n#else\nfloat lodReflection=getMipMapIndexFromAverageSlope(vMicrosurfaceTextureLods.x,alphaG);\n#endif\n#else\nfloat biasReflection=(vMicrosurfaceTextureLods.x+2.)*(1.0-microSurface);\n#endif\n#ifdef REFLECTIONMAP_3D\n#ifdef LODBASEDMICROSFURACE\n#ifdef USEPMREMREFLECTION\n\nif ((vMicrosurfaceTextureLods.y-lodReflection)>4.0)\n{\n\nfloat scaleReflection=1.-exp2(lodReflection)/exp2(vMicrosurfaceTextureLods.x); \nfloat maxReflection=max(max(abs(vReflectionUVW.x),abs(vReflectionUVW.y)),abs(vReflectionUVW.z));\nif (abs(vReflectionUVW.x) != maxReflection) vReflectionUVW.x*=scaleReflection;\nif (abs(vReflectionUVW.y) != maxReflection) vReflectionUVW.y*=scaleReflection;\nif (abs(vReflectionUVW.z) != maxReflection) vReflectionUVW.z*=scaleReflection;\n}\n#endif\nenvironmentRadiance=textureCubeLodEXT(reflectionCubeSampler,vReflectionUVW,lodReflection).rgb*vReflectionInfos.x;\n#else\nenvironmentRadiance=textureCube(reflectionCubeSampler,vReflectionUVW,biasReflection).rgb*vReflectionInfos.x;\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifndef REFLECTIONMAP_SKYBOX\nvec3 normalEnvironmentSpace=(reflectionMatrix*vec4(normalW,1)).xyz;\nenvironmentIrradiance=EnvironmentIrradiance(normalEnvironmentSpace);\n#endif\n#else\nenvironmentRadiance=toLinearSpace(environmentRadiance.rgb);\nenvironmentIrradiance=textureCube(reflectionCubeSampler,normalW,20.).rgb*vReflectionInfos.x;\nenvironmentIrradiance=toLinearSpace(environmentIrradiance.rgb);\nenvironmentIrradiance*=0.2; \n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\n#ifdef LODBASEDMICROSFURACE\nenvironmentRadiance=texture2DLodEXT(reflection2DSampler,coords,lodReflection).rgb*vReflectionInfos.x;\n#else\nenvironmentRadiance=texture2D(reflection2DSampler,coords,biasReflection).rgb*vReflectionInfos.x;\n#endif\nenvironmentRadiance=toLinearSpace(environmentRadiance.rgb);\nenvironmentIrradiance=texture2D(reflection2DSampler,coords,20.).rgb*vReflectionInfos.x;\nenvironmentIrradiance=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\n#ifdef OVERLOADEDVALUES\nenvironmentIrradiance=mix(environmentIrradiance,vOverloadedReflection,vOverloadedMicroSurface.z);\nenvironmentRadiance=mix(environmentRadiance,vOverloadedReflection,vOverloadedMicroSurface.z);\n#endif\nenvironmentRadiance*=vLightingIntensity.z;\nenvironmentIrradiance*=vLightingIntensity.z;\n\nvec3 specularEnvironmentReflectance=FresnelSchlickEnvironmentGGX(clamp(NdotV,0.,1.),specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n\nvec3 refractance=vec3(0.0,0.0,0.0);\n#ifdef REFRACTION\nvec3 transmission=vec3(1.0,1.0,1.0);\n#ifdef LINKREFRACTIONTOTRANSPARENCY\n\ntransmission*=(1.0-alpha);\n\n\nvec3 mixedAlbedo=surfaceAlbedoContribution.rgb*surfaceAlbedo.rgb;\nfloat maxChannel=max(max(mixedAlbedo.r,mixedAlbedo.g),mixedAlbedo.b);\nvec3 tint=clamp(maxChannel*mixedAlbedo,0.0,1.0);\n\nsurfaceAlbedoContribution*=alpha;\n\nenvironmentIrradiance*=alpha;\n\nsurfaceRefractionColor*=tint;\n\nalpha=1.0;\n#endif\n\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\nspecularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,alpha);\n\ntransmission*=1.0-specularEnvironmentReflectance;\n\nrefractance=surfaceRefractionColor*transmission;\n#endif\n\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\nrefractance*=vLightingIntensity.z;\nenvironmentRadiance*=specularEnvironmentReflectance;\n\nvec3 surfaceEmissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\nsurfaceEmissiveColor=toLinearSpace(emissiveColorTex.rgb)*surfaceEmissiveColor*vEmissiveInfos.y;\n#endif\n#ifdef OVERLOADEDVALUES\nsurfaceEmissiveColor=mix(surfaceEmissiveColor,vOverloadedEmissive,vOverloadedIntensity.w);\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nsurfaceEmissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=max(lightDiffuseContribution*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#ifdef OVERLOADEDSHADOWVALUES\nshadowedOnlyLightDiffuseContribution=max(shadowedOnlyLightDiffuseContribution*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#endif\n#else\n#ifdef LINKEMISSIVEWITHALBEDO\nvec3 finalDiffuse=max((lightDiffuseContribution+surfaceEmissiveColor)*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#ifdef OVERLOADEDSHADOWVALUES\nshadowedOnlyLightDiffuseContribution=max((shadowedOnlyLightDiffuseContribution+surfaceEmissiveColor)*surfaceAlbedoContribution+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#endif\n#else\nvec3 finalDiffuse=max(lightDiffuseContribution*surfaceAlbedoContribution+surfaceEmissiveColor+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#ifdef OVERLOADEDSHADOWVALUES\nshadowedOnlyLightDiffuseContribution=max(shadowedOnlyLightDiffuseContribution*surfaceAlbedoContribution+surfaceEmissiveColor+vAmbientColor,0.0)*surfaceAlbedo.rgb;\n#endif\n#endif\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nfinalDiffuse=mix(finalDiffuse,shadowedOnlyLightDiffuseContribution,(1.0-vOverloadedShadowIntensity.y));\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=lightSpecularContribution*surfaceReflectivityColor;\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+getLuminance(finalSpecular),0.,1.);\n#endif\n#ifdef RADIANCEOVERALPHA\nalpha=clamp(alpha+getLuminance(environmentRadiance),0.,1.);\n#endif\n\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 finalColor=vec4(finalDiffuse*ambientColor*vLightingIntensity.x+surfaceAlbedo.rgb*environmentIrradiance+finalSpecular*vLightingIntensity.x+environmentRadiance+surfaceEmissiveColor*vLightingIntensity.y+refractance,alpha);\n#else\nvec4 finalColor=vec4(finalDiffuse*ambientColor*vLightingIntensity.x+surfaceAlbedo.rgb*environmentIrradiance+finalSpecular*vLightingIntensity.x+environmentRadiance+refractance,alpha);\n#endif\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor;\n#else\nfinalColor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\nfinalColor=max(finalColor,0.0);\n#ifdef CAMERATONEMAP\nfinalColor.rgb=toneMaps(finalColor.rgb);\n#endif\nfinalColor.rgb=toGammaSpace(finalColor.rgb);\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#ifdef CAMERACONTRAST\nfinalColor=contrasts(finalColor);\n#endif\nfinalColor.rgb=clamp(finalColor.rgb,0.,1.);\n#ifdef CAMERACOLORGRADING\nfinalColor=colorGrades(finalColor);\n#endif\n#ifdef CAMERACOLORCURVES\nfinalColor.rgb=applyColorCurves(finalColor.rgb);\n#endif\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\ngl_FragColor=finalColor;\n}",pbrVertexShader:"precision highp float;\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nvarying vec2 vAlbedoUV;\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nvarying vec2 vAmbientUV;\nuniform mat4 ambientMatrix;\nuniform vec3 vAmbientInfos;\n#endif\n#ifdef OPACITY\nvarying vec2 vOpacityUV;\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nvarying vec2 vEmissiveUV;\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nvarying vec2 vLightmapUV;\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(REFLECTIVITY) || defined(METALLICWORKFLOW) \nvarying vec2 vReflectivityUV;\nuniform vec2 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<shadowsVertexDeclaration>[0..maxSimultaneousLights]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\nvoid main(void) {\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=position;\n#endif \n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\nvec4 worldPos=finalWorld*vec4(position,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nvNormalW=normalize(vec3(finalWorld*vec4(normal,0.0)));\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef ALBEDO\nif (vAlbedoInfos.x == 0.)\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef AMBIENT\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef OPACITY\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef EMISSIVE\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef LIGHTMAP\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(REFLECTIVITY) || defined(METALLICWORKFLOW) \nif (vReflectivityInfos.x == 0.)\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef BUMP\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n\n#include<logDepthVertex>\n}",postprocessVertexShader:"\nattribute vec2 position;\nuniform vec2 scale;\n\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvUV=(position*madd+madd)*scale;\ngl_Position=vec4(position,0.0,1.0);\n}",proceduralVertexShader:"\nattribute vec2 position;\n\nvarying vec2 vPosition;\nvarying vec2 vUV;\nconst vec2 madd=vec2(0.5,0.5);\nvoid main(void) { \nvPosition=position;\nvUV=position*madd+madd;\ngl_Position=vec4(position,0.0,1.0);\n}",refractionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform sampler2D refractionSampler;\n\nuniform vec3 baseColor;\nuniform float depth;\nuniform float colorLevel;\nvoid main() {\nfloat ref=1.0-texture2D(refractionSampler,vUV).r;\nvec2 uv=vUV-vec2(0.5);\nvec2 offset=uv*depth*ref;\nvec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;\ngl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);\n}",shadowMapPixelShader:"#ifndef FULLFLOAT\nvec4 pack(float depth)\n{\nconst vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);\nconst vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);\nvec4 res=fract(depth*bit_shift);\nres-=res.xxyz*bit_mask;\nreturn res;\n}\n\nvec2 packHalf(float depth) \n{ \nconst vec2 bitOffset=vec2(1.0/255.,0.);\nvec2 color=vec2(depth,fract(depth*255.));\nreturn color-(color.yy*bitOffset);\n}\n#endif\nvarying vec4 vPosition;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef CUBEMAP\nuniform vec3 lightPosition;\nuniform vec2 depthValues;\n#endif\nvoid main(void)\n{\n#ifdef ALPHATEST\nif (texture2D(diffuseSampler,vUV).a<0.4)\ndiscard;\n#endif\n#ifdef CUBEMAP\nvec3 directionToLight=vPosition.xyz-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\n#else\nfloat depth=vPosition.z/vPosition.w;\ndepth=depth*0.5+0.5;\n#endif\n#ifdef VSM\nfloat moment1=depth;\nfloat moment2=moment1*moment1;\n#ifndef FULLFLOAT\ngl_FragColor=vec4(packHalf(moment1),packHalf(moment2));\n#else\ngl_FragColor=vec4(moment1,moment2,1.0,1.0);\n#endif\n#else\n#ifndef FULLFLOAT\ngl_FragColor=pack(depth);\n#else\ngl_FragColor=vec4(depth,1.0,1.0,1.0);\n#endif\n#endif\n}",shadowMapVertexShader:"\nattribute vec3 position;\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\nuniform mat4 viewProjection;\nvarying vec4 vPosition;\n#ifdef ALPHATEST\nvarying vec2 vUV;\nuniform mat4 diffuseMatrix;\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#endif\nvoid main(void)\n{\n#include<instancesVertex>\n#include<bonesVertex>\n#ifdef CUBEMAP\nvPosition=finalWorld*vec4(position,1.0);\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#else\nvPosition=viewProjection*finalWorld*vec4(position,1.0);\ngl_Position=vPosition;\n#endif\n#ifdef ALPHATEST\n#ifdef UV1\nvUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n#endif\n#ifdef UV2\nvUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n#endif\n#endif\n}",spritesPixelShader:"uniform bool alphaTest;\nvarying vec4 vColor;\n\nvarying vec2 vUV;\nuniform sampler2D diffuseSampler;\n\n#include<fogFragmentDeclaration>\nvoid main(void) {\nvec4 color=texture2D(diffuseSampler,vUV);\nif (alphaTest) \n{\nif (color.a<0.95)\ndiscard;\n}\ncolor*=vColor;\n#include<fogFragment>\ngl_FragColor=color;\n}",spritesVertexShader:"\nattribute vec4 position;\nattribute vec4 options;\nattribute vec4 cellInfo;\nattribute vec4 color;\n\nuniform vec2 textureInfos;\nuniform mat4 view;\nuniform mat4 projection;\n\nvarying vec2 vUV;\nvarying vec4 vColor;\n#include<fogVertexDeclaration>\nvoid main(void) { \nvec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; \nvec2 cornerPos;\nfloat angle=position.w;\nvec2 size=vec2(options.x,options.y);\nvec2 offset=options.zw;\nvec2 uvScale=textureInfos.xy;\ncornerPos=vec2(offset.x-0.5,offset.y-0.5)*size;\n\nvec3 rotatedCorner;\nrotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);\nrotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);\nrotatedCorner.z=0.;\n\nviewPos+=rotatedCorner;\ngl_Position=projection*vec4(viewPos,1.0); \n\nvColor=color;\n\nvec2 uvOffset=vec2(abs(offset.x-cellInfo.x),1.0-abs(offset.y-cellInfo.y));\nvUV=(uvOffset+cellInfo.zw)*uvScale;\n\n#ifdef FOG\nfFogDistance=viewPos.z;\n#endif\n}",ssaoPixelShader:"\nuniform sampler2D textureSampler;\nvarying vec2 vUV;\n#ifdef SSAO\nuniform sampler2D randomSampler;\nuniform float randTextureTiles;\nuniform float samplesFactor;\nuniform vec3 sampleSphere[SAMPLES];\nuniform float totalStrength;\nuniform float radius;\nuniform float area;\nuniform float fallOff;\nuniform float base;\nvec3 normalFromDepth(float depth,vec2 coords)\n{\nvec2 offset1=vec2(0.0,radius);\nvec2 offset2=vec2(radius,0.0);\nfloat depth1=texture2D(textureSampler,coords+offset1).r;\nfloat depth2=texture2D(textureSampler,coords+offset2).r;\nvec3 p1=vec3(offset1,depth1-depth);\nvec3 p2=vec3(offset2,depth2-depth);\nvec3 normal=cross(p1,p2);\nnormal.z=-normal.z;\nreturn normalize(normal);\n}\nvoid main()\n{\nvec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);\nfloat depth=texture2D(textureSampler,vUV).r;\nvec3 position=vec3(vUV,depth);\nvec3 normal=normalFromDepth(depth,vUV);\nfloat radiusDepth=radius/depth;\nfloat occlusion=0.0;\nvec3 ray;\nvec3 hemiRay;\nfloat occlusionDepth;\nfloat difference;\nfor (int i=0; i<SAMPLES; i++)\n{\nray=radiusDepth*reflect(sampleSphere[i],random);\nhemiRay=position+sign(dot(ray,normal))*ray;\nocclusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;\ndifference=depth-occlusionDepth;\nocclusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));\n}\nfloat ao=1.0-totalStrength*occlusion*samplesFactor;\nfloat result=clamp(ao+base,0.0,1.0);\ngl_FragColor.r=result;\ngl_FragColor.g=result;\ngl_FragColor.b=result;\ngl_FragColor.a=1.0;\n}\n#endif\n#ifdef BILATERAL_BLUR\nuniform sampler2D depthSampler;\nuniform float outSize;\nuniform float samplerOffsets[SAMPLES];\nvoid main()\n{\nfloat texelsize=1.0/outSize;\nfloat compareDepth=texture2D(depthSampler,vUV).r;\nfloat result=0.0;\nfloat weightSum=0.0;\nfor (int i=0; i<SAMPLES; ++i)\n{\n#ifdef BILATERAL_BLUR_H\nvec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);\n#else\nvec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);\n#endif\nvec2 samplePos=vUV+sampleOffset;\nfloat sampleDepth=texture2D(depthSampler,samplePos).r;\nfloat weight=(1.0/(0.0001+abs(compareDepth-sampleDepth)));\nresult+=texture2D(textureSampler,samplePos).r*weight;\nweightSum+=weight;\n}\nresult/=weightSum;\ngl_FragColor.rgb=vec3(result);\ngl_FragColor.a=1.0;\n}\n#endif\n",ssaoCombinePixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D originalColor;\nvarying vec2 vUV;\nvoid main(void) {\nvec4 ssaoColor=texture2D(textureSampler,vUV);\nvec4 sceneColor=texture2D(originalColor,vUV);\ngl_FragColor=sceneColor*ssaoColor;\n}\n",standardPixelShader:"uniform sampler2D textureSampler;\nvarying vec2 vUV;\n#if defined(PASS_POST_PROCESS)\nvoid main(void)\n{\nvec4 color=texture2D(textureSampler,vUV);\ngl_FragColor=color;\n}\n#endif\n#if defined(DOWN_SAMPLE_X4)\nuniform vec2 dsOffsets[16];\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+dsOffsets[0]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[1]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[2]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[3]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[4]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[5]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[6]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[7]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[8]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[9]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[10]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[11]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[12]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[13]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[14]);\naverage+=texture2D(textureSampler,vUV+dsOffsets[15]);\naverage/=16.0;\ngl_FragColor=average;\n}\n#endif\n#if defined(BRIGHT_PASS)\nuniform vec2 dsOffsets[4];\nuniform float brightThreshold;\nvoid main(void)\n{\nvec4 average=vec4(0.0,0.0,0.0,0.0);\naverage=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));\naverage+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));\naverage*=0.25;\nfloat luminance=length(average.rgb);\nif (luminance<brightThreshold) {\naverage=vec4(0.0,0.0,0.0,1.0);\n}\ngl_FragColor=average;\n}\n#endif\n#if defined(GAUSSIAN_BLUR_H) || defined(GAUSSIAN_BLUR_V)\nuniform float blurOffsets[9];\nuniform float blurWeights[9];\nuniform float blurWidth;\nvoid main(void)\n{\nvec4 color=vec4(0.0,0.0,0.0,0.0);\nfor (int i=0; i<9; i++) {\n#ifdef GAUSSIAN_BLUR_H\ncolor+=(texture2D(textureSampler,vUV+vec2(blurOffsets[i]*blurWidth,0.0))*blurWeights[i]);\ncolor+=(texture2D(textureSampler,vUV-vec2(blurOffsets[i]*blurWidth,0.0))*blurWeights[i]);\n#else\ncolor+=(texture2D(textureSampler,vUV+vec2(0.0,blurOffsets[i]*blurWidth))*blurWeights[i]);\ncolor+=(texture2D(textureSampler,vUV-vec2(0.0,blurOffsets[i]*blurWidth))*blurWeights[i]);\n#endif\n}\ncolor.a=1.0;\ngl_FragColor=color;\n}\n#endif\n#if defined(TEXTURE_ADDER)\nuniform sampler2D otherSampler;\nuniform sampler2D lensSampler;\nuniform float exposure;\nvoid main(void)\n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\ncolour*=exposure;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\ncolour+=colour*texture2D(lensSampler,vUV).rgb;\nvec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);\ngl_FragColor=finalColor;\n}\n#endif\n#if defined(LENS_FLARE)\n#define GHOSTS 3\nuniform sampler2D lensColorSampler;\nuniform float strength;\nuniform float ghostDispersal;\nuniform float haloWidth;\nuniform vec2 resolution;\nuniform float distortionStrength;\nfloat hash(vec2 p)\n{\nfloat h=dot(p,vec2(127.1,311.7));\nreturn -1.0+2.0*fract(sin(h)*43758.5453123);\n}\nfloat noise(in vec2 p)\n{\nvec2 i=floor(p);\nvec2 f=fract(p);\nvec2 u=f*f*(3.0-2.0*f);\nreturn mix(mix(hash(i+vec2(0.0,0.0)),\nhash(i+vec2(1.0,0.0)),u.x),\nmix(hash(i+vec2(0.0,1.0)),\nhash(i+vec2(1.0,1.0)),u.x),u.y);\n}\nfloat fbm(vec2 p)\n{\nfloat f=0.0;\nf+=0.5000*noise(p); p*=2.02;\nf+=0.2500*noise(p); p*=2.03;\nf+=0.1250*noise(p); p*=2.01;\nf+=0.0625*noise(p); p*=2.04;\nf/=0.9375;\nreturn f;\n}\nvec3 pattern(vec2 uv)\n{\nvec2 p=-1.0+2.0*uv;\nfloat p2=dot(p,p);\nfloat f=fbm(vec2(15.0*p2))/2.0;\nfloat r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));\nfloat g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));\nfloat b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));\nreturn (1.0-f)*vec3(r,g,b);\n}\nfloat luminance(vec3 color)\n{\nreturn dot(color.rgb,vec3(0.2126,0.7152,0.0722));\n}\nvec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)\n{\nreturn vec4(\ntexture2D(tex,texcoord+direction*distortion.r).r,\ntexture2D(tex,texcoord+direction*distortion.g).g,\ntexture2D(tex,texcoord+direction*distortion.b).b,\n1.0\n);\n}\nvoid main(void)\n{\nvec2 uv=-vUV+vec2(1.0);\nvec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;\nvec2 texelSize=1.0/resolution;\nvec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);\nvec4 result=vec4(0.0);\nfloat ghostIndice=1.0;\nfor (int i=0; i<GHOSTS; ++i)\n{\nvec2 offset=fract(uv+ghostDir*ghostIndice);\nfloat weight=length(vec2(0.5)-offset)/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;\nghostIndice+=1.0;\n}\nvec2 haloVec=normalize(ghostDir)*haloWidth;\nfloat weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));\nweight=pow(1.0-weight,10.0);\nresult+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;\nresult*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));\ngl_FragColor=result;\n}\n#endif\n#if defined(LENS_FLARE_COMPOSE)\nuniform sampler2D otherSampler;\nuniform sampler2D lensDirtSampler;\nuniform sampler2D lensStarSampler;\nuniform mat4 lensStarMatrix;\nvoid main(void)\n{\nvec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;\nvec4 lensMod=texture2D(lensDirtSampler,vUV);\nlensMod+=texture2D(lensStarSampler,vUV);\nvec4 result=texture2D(textureSampler,vUV)*lensMod;\ngl_FragColor=texture2D(otherSampler,vUV)+result;\n}\n#endif\n#if defined(DEPTH_OF_FIELD)\nuniform sampler2D otherSampler;\nuniform sampler2D depthSampler;\nuniform float distance;\nvoid main(void)\n{\nvec4 sharp=texture2D(otherSampler,vUV);\nvec4 blur=texture2D(textureSampler,vUV);\nfloat dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);\nfloat factor=0.0;\nif (dist<0.05)\nfactor=1.0;\nelse if (dist<0.1)\nfactor=20.0*(0.1-dist);\nelse if (dist<0.5)\nfactor=0.0;\nelse\nfactor=2.0*(dist-0.5);\nfactor=clamp(factor,0.0,0.90);\ngl_FragColor=mix(sharp,blur,factor);\n}\n#endif\n",stereoscopicInterlacePixelShader:"const vec3 TWO=vec3(2.0,2.0,2.0);\nvarying vec2 vUV;\nuniform sampler2D camASampler;\nuniform sampler2D textureSampler;\nuniform vec2 stepSize;\nvoid main(void)\n{\nbool useCamB;\nvec2 texCoord1;\nvec2 texCoord2;\nvec3 frag1;\nvec3 frag2;\n#ifdef IS_STEREOSCOPIC_HORIZ\nuseCamB=vUV.x>0.5;\ntexCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);\ntexCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);\n#else\nuseCamB=vUV.y>0.5;\ntexCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);\ntexCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);\n#endif\n\nif (useCamB){\nfrag1=texture2D(textureSampler,texCoord1).rgb;\nfrag2=texture2D(textureSampler,texCoord2).rgb;\n}else{\nfrag1=texture2D(camASampler ,texCoord1).rgb;\nfrag2=texture2D(camASampler ,texCoord2).rgb;\n}\ngl_FragColor=vec4((frag1+frag2)/TWO,1.0);\n}",tonemapPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n\nuniform float _ExposureAdjustment;\n#if defined(HABLE_TONEMAPPING)\nconst float A=0.15;\nconst float B=0.50;\nconst float C=0.10;\nconst float D=0.20;\nconst float E=0.02;\nconst float F=0.30;\nconst float W=11.2;\n#endif\nfloat Luminance(vec3 c)\n{\nreturn dot(c,vec3(0.22,0.707,0.071));\n}\nvoid main(void) \n{\nvec3 colour=texture2D(textureSampler,vUV).rgb;\n#if defined(REINHARD_TONEMAPPING)\nfloat lum=Luminance(colour.rgb); \nfloat lumTm=lum*_ExposureAdjustment;\nfloat scale=lumTm/(1.0+lumTm); \ncolour*=scale/lum;\n#elif defined(HABLE_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nconst float ExposureBias=2.0;\nvec3 x=ExposureBias*colour;\nvec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\nx=vec3(W,W,W);\nvec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);\ncolour=curr*whiteScale;\n#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)\ncolour*=_ExposureAdjustment;\nvec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);\nvec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);\ncolour=retColor*retColor;\n#elif defined(PHOTOGRAPHIC_TONEMAPPING)\ncolour=vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);\n#endif\ngl_FragColor=vec4(colour.rgb,1.0);\n}",volumetricLightScatteringPixelShader:"uniform sampler2D textureSampler;\nuniform sampler2D lightScatteringSampler;\nuniform float decay;\nuniform float exposure;\nuniform float weight;\nuniform float density;\nuniform vec2 meshPositionOnScreen;\nvarying vec2 vUV;\nvoid main(void) {\nvec2 tc=vUV;\nvec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);\ndeltaTexCoord*=1.0/float(NUM_SAMPLES)*density;\nfloat illuminationDecay=1.0;\nvec4 color=texture2D(lightScatteringSampler,tc)*0.4;\nfor(int i=0; i<NUM_SAMPLES; i++) {\ntc-=deltaTexCoord;\nvec4 sample=texture2D(lightScatteringSampler,tc)*0.4;\nsample*=illuminationDecay*weight;\ncolor+=sample;\nilluminationDecay*=decay;\n}\nvec4 realColor=texture2D(textureSampler,vUV);\ngl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));\n}\n",volumetricLightScatteringPassPixelShader:"#if defined(ALPHATEST) || defined(NEED_UV)\nvarying vec2 vUV;\n#endif\n#if defined(ALPHATEST)\nuniform sampler2D diffuseSampler;\n#endif\nvoid main(void)\n{\n#if defined(ALPHATEST)\nvec4 diffuseColor=texture2D(diffuseSampler,vUV);\nif (diffuseColor.a<0.4)\ndiscard;\n#endif\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\n}\n",vrDistortionCorrectionPixelShader:"\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\nuniform vec2 LensCenter;\nuniform vec2 Scale;\nuniform vec2 ScaleIn;\nuniform vec4 HmdWarpParam;\nvec2 HmdWarp(vec2 in01) {\nvec2 theta=(in01-LensCenter)*ScaleIn; \nfloat rSq=theta.x*theta.x+theta.y*theta.y;\nvec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);\nreturn LensCenter+Scale*rvector;\n}\nvoid main(void)\n{\nvec2 tc=HmdWarp(vUV);\nif (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)\ngl_FragColor=vec4(0.0,0.0,0.0,1.0);\nelse{\ngl_FragColor=vec4(texture2D(textureSampler,tc).rgb,1.0);\n}\n}"};i.Effect.IncludesShadersStore={bonesDeclaration:"#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#endif",bonesVertex:"#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \nfinalWorld=finalWorld*influence;\n#endif",bumpFragment:"vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX)\nmat3 TBN=cotangent_frame(normalW*vBumpInfos.y,-viewDirectionW,vBumpUV);\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef BUMP\nnormalW=perturbNormal(viewDirectionW,TBN,vBumpUV+uvOffset);\n#endif",bumpFragmentFunctions:"#ifdef BUMP\nvarying vec2 vBumpUV;\nuniform vec3 vBumpInfos;\nuniform sampler2D bumpSampler;\n\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv)\n{\n\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\n\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;\n\nfloat invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));\nreturn mat3(tangent*invmax,binormal*invmax,normal);\n}\nvec3 perturbNormal(vec3 viewDir,mat3 cotangentFrame,vec2 uv)\n{\nvec3 map=texture2D(bumpSampler,uv).xyz;\n#ifdef INVERTNORMALMAPX\nmap.x=1.0-map.x;\n#endif\n#ifdef INVERTNORMALMAPY\nmap.y=1.0-map.y;\n#endif\nmap=map*255./127.-128./127.;\nreturn normalize(cotangentFrame*map);\n}\n#ifdef PARALLAX\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\n\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\n\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,vBumpUV+vCurrOffset).w;\n\nif (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\n\nbreak;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\n\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n#endif",clipPlaneFragment:"#ifdef CLIPPLANE\nif (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif",clipPlaneFragmentDeclaration:"#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif",clipPlaneVertex:"#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif",clipPlaneVertexDeclaration:"#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif",colorCurves:"const vec3 HDTVRec709_RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);\nvec3 applyColorCurves(vec3 original) {\nvec3 result=original;\n\n\n\nfloat luma=dot(result.rgb,HDTVRec709_RGBLuminanceCoefficients);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0,0.0),vec2(1.0,1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma,luma,luma),result.rgb,colorCurve.a);\nreturn result;\n}",colorCurvesDefinition:"uniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\nuniform vec4 vCameraColorCurveNegative;",colorGrading:"vec4 colorGrades(vec4 color) \n{ \n\nfloat sliceContinuous=color.z*vCameraColorGradingInfos.z;\nfloat sliceInteger=floor(sliceContinuous);\n\n\nfloat sliceFraction=sliceContinuous-sliceInteger; \n\nvec2 sliceUV=color.xy*vCameraColorGradingScaleOffset.xy+vCameraColorGradingScaleOffset.zw;\n\n\nsliceUV.x+=sliceInteger*vCameraColorGradingInfos.w;\nvec4 slice0Color=texture2D(cameraColorGrading2DSampler,sliceUV);\nsliceUV.x+=vCameraColorGradingInfos.w;\nvec4 slice1Color=texture2D(cameraColorGrading2DSampler,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\ncolor.rgb=mix(color.rgb,result,vCameraColorGradingInfos.x);\nreturn color;\n}",colorGradingDefinition:"uniform sampler2D cameraColorGrading2DSampler;\nuniform vec4 vCameraColorGradingInfos;\nuniform vec4 vCameraColorGradingScaleOffset;",fogFragment:"#ifdef FOG\nfloat fog=CalcFogFactor();\ncolor.rgb=fog*color.rgb+(1.0-fog)*vFogColor;\n#endif",fogFragmentDeclaration:"#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying float fFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nif (FOGMODE_LINEAR == vFogInfos.x)\n{\nfogCoeff=(fogEnd-fFogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fFogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2 == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fFogDistance*fFogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif",fogVertex:"#ifdef FOG\nfFogDistance=(view*worldPos).z;\n#endif",fogVertexDeclaration:"#ifdef FOG\nvarying float fFogDistance;\n#endif",fresnelFunction:"#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif",harmonicsFunctions:"#ifdef USESPHERICALFROMREFLECTIONMAP\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX;\nuniform vec3 vSphericalYY;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\nvec3 EnvironmentIrradiance(vec3 normal)\n{\n\n\n\nvec3 result =\nvSphericalX*normal.x +\nvSphericalY*normal.y +\nvSphericalZ*normal.z +\nvSphericalXX*normal.x*normal.x +\nvSphericalYY*normal.y*normal.y +\nvSphericalZZ*normal.z*normal.z +\nvSphericalYZ*normal.y*normal.z +\nvSphericalZX*normal.z*normal.x +\nvSphericalXY*normal.x*normal.y;\nreturn result.rgb;\n}\n#endif",helperFunctions:"mat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}",instancesDeclaration:"#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#else\nuniform mat4 world;\n#endif",instancesVertex:"#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#else\nmat4 finalWorld=world;\n#endif",lightFragment:"#ifdef LIGHT{X}\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n\n#else\n#ifndef SPECULARTERM\nvec3 vLightSpecular{X}=vec3(0.);\n#endif\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,vLightData{X},vLightDirection{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,glossiness);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightGround{X},glossiness);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,glossiness);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWVSM{X}\nshadow=computeShadowWithVSM(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\n#ifdef SHADOWPCF{X}\n#if defined(POINTLIGHT{X})\nshadow=computeShadowWithPCFCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\nshadow=computeShadowWithPCF(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#endif\n#else\n#if defined(POINTLIGHT{X})\nshadow=computeShadowCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#else\nshadow=computeShadow(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#endif\n#endif\n#endif\n#else\nshadow=1.;\n#endif\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor;\n#endif\n#endif\n#else\ndiffuseBase+=info.diffuse*shadow;\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#endif\n#endif",lightFragmentDeclaration:"#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec3 vLightSpecular{X};\n#endif\n#ifdef SHADOW{X}\n#if defined(SPOTLIGHT{X}) || defined(DIRLIGHT{X})\nvarying vec4 vPositionFromLight{X};\nuniform sampler2D shadowSampler{X};\n#else\nuniform samplerCube shadowSampler{X};\n#endif\nuniform vec3 shadowsInfo{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\n#endif\n#ifdef HEMILIGHT{X}\nuniform vec3 vLightGround{X};\n#endif\n#endif",lightsFragmentFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w == 0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\n\nfloat cosAngle=max(0.,dot(-lightDirection.xyz,lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\n\nfloat ndl=max(0.,dot(vNormal,-lightDirection.xyz));\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW-lightDirection.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\n\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\n",logDepthDeclaration:"#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif",logDepthFragment:"#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif",logDepthVertex:"#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif",pbrFunctions:"\n#define RECIPROCAL_PI2 0.15915494\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n\nconst float kPi=3.1415926535897932384626433832795;\nconst float kRougnhessToAlphaScale=0.1;\nconst float kRougnhessToAlphaOffset=0.29248125;\nfloat Square(float value)\n{\nreturn value*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,vec3(0.2126,0.7152,0.0722)),0.,1.);\n}\nfloat convertRoughnessToAverageSlope(float roughness)\n{\n\nconst float kMinimumVariance=0.0005;\nfloat alphaG=Square(roughness)+kMinimumVariance;\nreturn alphaG;\n}\n\nfloat getMipMapIndexFromAverageSlope(float maxMipLevel,float alpha)\n{\n\n\n\n\n\n\n\nfloat mip=kRougnhessToAlphaOffset+maxMipLevel+(maxMipLevel*kRougnhessToAlphaScale*log2(alpha));\nreturn clamp(mip,0.,maxMipLevel);\n}\nfloat getMipMapIndexFromAverageSlopeWithPMREM(float maxMipLevel,float alphaG)\n{\nfloat specularPower=clamp(2./alphaG-2.,0.000001,2048.);\n\nreturn clamp(- 0.5*log2(specularPower)+5.5,0.,maxMipLevel);\n}\n\nfloat smithVisibilityG1_TrowbridgeReitzGGX(float dot,float alphaG)\n{\nfloat tanSquared=(1.0-dot*dot)/(dot*dot);\nreturn 2.0/(1.0+sqrt(1.0+alphaG*alphaG*tanSquared));\n}\nfloat smithVisibilityG_TrowbridgeReitzGGX_Walter(float NdotL,float NdotV,float alphaG)\n{\nreturn smithVisibilityG1_TrowbridgeReitzGGX(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGX(NdotV,alphaG);\n}\n\n\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\n\n\n\nfloat a2=Square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(kPi*d*d);\n}\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow(clamp(1.0-VdotH,0.,1.),5.0);\n}\nvec3 FresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow(clamp(1.0-VdotN,0.,1.),5.0);\n}\n\nvec3 computeSpecularTerm(float NdotH,float NdotL,float NdotV,float VdotH,float roughness,vec3 specularColor,vec3 reflectance90)\n{\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\nfloat visibility=smithVisibilityG_TrowbridgeReitzGGX_Walter(NdotL,NdotV,alphaG);\nvisibility/=(4.0*NdotL*NdotV); \nvec3 fresnel=fresnelSchlickGGX(VdotH,specularColor,reflectance90);\nfloat specTerm=max(0.,visibility*distribution)*NdotL;\nreturn fresnel*specTerm*kPi; \n}\nfloat computeDiffuseTerm(float NdotL,float NdotV,float VdotH,float roughness)\n{\n\n\nfloat diffuseFresnelNV=pow(clamp(1.0-NdotL,0.000001,1.),5.0);\nfloat diffuseFresnelNL=pow(clamp(1.0-NdotV,0.000001,1.),5.0);\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat diffuseFresnelTerm =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn diffuseFresnelTerm*NdotL;\n\n\n}\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\n\nfloat lightRoughness=lightRadius/lightDistance;\n\nfloat totalRoughness=clamp(lightRoughness+roughness,0.,1.);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nfloat kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\nvec3 toLinearSpace(vec3 color)\n{\nreturn vec3(pow(color.r,2.2),pow(color.g,2.2),pow(color.b,2.2));\n}\nvec3 toGammaSpace(vec3 color)\n{\nreturn vec3(pow(color.r,1.0/2.2),pow(color.g,1.0/2.2),pow(color.b,1.0/2.2));\n}\n#ifdef CAMERATONEMAP\nvec3 toneMaps(vec3 color)\n{\ncolor=max(color,0.0);\n\ncolor.rgb=color.rgb*vCameraInfos.x;\nfloat tuning=1.5; \n\n\nvec3 tonemapped=1.0-exp2(-color.rgb*tuning); \ncolor.rgb=mix(color.rgb,tonemapped,1.0);\nreturn color;\n}\n#endif\n#ifdef CAMERACONTRAST\nvec4 contrasts(vec4 color)\n{\ncolor=clamp(color,0.0,1.0);\nvec3 resultHighContrast=color.rgb*color.rgb*(3.0-2.0*color.rgb);\nfloat contrast=vCameraInfos.y;\nif (contrast<1.0)\n{\n\ncolor.rgb=mix(vec3(0.5,0.5,0.5),color.rgb,contrast);\n}\nelse\n{\n\ncolor.rgb=mix(color.rgb,resultHighContrast,contrast-1.0);\n}\nreturn color;\n}\n#endif",pbrLightFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n};\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range)\n{ \n#ifdef USEPHYSICALLIGHTFALLOFF\nfloat lightDistanceFalloff=1.0/((lightDistanceSquared+0.0001));\n#else\nfloat lightDistanceFalloff=max(0.,1.0-length(lightOffset)/range);\n#endif\nreturn lightDistanceFalloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngle,float exponent)\n{\nfloat falloff=0.0;\n#ifdef USEPHYSICALLIGHTFALLOFF\nfloat cosHalfAngle=cos(lightAngle*0.5);\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977; \n\n\n\n\n\nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\n\n\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfalloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\n#else\nfloat cosAngle=max(0.000000000000001,dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=lightAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\n#endif\nreturn falloff;\n}\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\nvec3 lightDirection;\nfloat attenuation=1.0;\nfloat lightDistance;\n\nif (lightData.w == 0.)\n{\nvec3 lightOffset=lightData.xyz-vPositionW;\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nattenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\nlightDistance=sqrt(lightDistanceSquared);\nlightDirection=normalize(lightOffset);\n}\n\nelse\n{\nlightDistance=length(-lightData.xyz);\nlightDirection=normalize(-lightData.xyz);\n}\n\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW+lightDirection);\nNdotL=max(0.00000000001,dot(vNormal,lightDirection));\nfloat VdotH=clamp(0.00000000001,1.0,dot(viewDirectionW,H));\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=max(0.00000000001,dot(vNormal,H));\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,specularColor,reflectance90);\nresult.specular=specTerm*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float rangeRadius,float roughness,float NdotV,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\nvec3 lightOffset=lightData.xyz-vPositionW;\nvec3 directionToLightCenterW=normalize(lightOffset);\n\nfloat lightDistanceSquared=dot(lightOffset,lightOffset);\nfloat attenuation=computeDistanceLightFalloff(lightOffset,lightDistanceSquared,rangeRadius);\n\nfloat directionalAttenuation=computeDirectionalLightFalloff(lightDirection.xyz,directionToLightCenterW,lightDirection.w,lightData.w);\nattenuation*=directionalAttenuation;\n\nfloat lightDistance=sqrt(lightDistanceSquared);\nroughness=adjustRoughnessFromLightProperties(roughness,rangeRadius,lightDistance);\n\nvec3 H=normalize(viewDirectionW-lightDirection.xyz);\nNdotL=max(0.00000000001,dot(vNormal,-lightDirection.xyz));\nfloat VdotH=clamp(dot(viewDirectionW,H),0.00000000001,1.0);\nfloat diffuseTerm=computeDiffuseTerm(NdotL,NdotV,VdotH,roughness);\nresult.diffuse=diffuseTerm*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nfloat NdotH=max(0.00000000001,dot(vNormal,H));\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,specularColor,reflectance90);\nresult.specular=specTerm*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float roughness,float NdotV,vec3 reflectance90,out float NdotL) {\nlightingInfo result;\n\n\n\nNdotL=dot(vNormal,lightData.xyz)*0.5+0.5;\nresult.diffuse=mix(groundColor,diffuseColor,NdotL);\n#ifdef SPECULARTERM\n\nvec3 lightVectorW=normalize(lightData.xyz);\nvec3 H=normalize(viewDirectionW+lightVectorW);\nfloat NdotH=max(0.00000000001,dot(vNormal,H));\nNdotL=max(0.00000000001,NdotL);\nfloat VdotH=clamp(0.00000000001,1.0,dot(viewDirectionW,H));\nvec3 specTerm=computeSpecularTerm(NdotH,NdotL,NdotV,VdotH,roughness,specularColor,reflectance90);\nresult.specular=specTerm;\n#endif\nreturn result;\n}",pbrLightFunctionsCall:"#ifdef LIGHT{X}\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})\n\n#else\n#ifndef SPECULARTERM\nvec3 vLightSpecular{X}=vec3(0.0);\n#endif\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,vLightData{X},vLightDirection{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,roughness,NdotV,specularEnvironmentR90,NdotL);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightGround{X},roughness,NdotV,specularEnvironmentR90,NdotL);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,vLightData{X},vLightDiffuse{X}.rgb,vLightSpecular{X},vLightDiffuse{X}.a,roughness,NdotV,specularEnvironmentR90,NdotL);\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWVSM{X}\nnotShadowLevel=computeShadowWithVSM(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\n#ifdef SHADOWPCF{X}\n#if defined(POINTLIGHT{X})\nnotShadowLevel=computeShadowWithPCFCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#else\nnotShadowLevel=computeShadowWithPCF(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.y,shadowsInfo{X}.z,shadowsInfo{X}.x);\n#endif\n#else\n#if defined(POINTLIGHT{X})\nnotShadowLevel=computeShadowCube(vLightData{X}.xyz,shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#else\nnotShadowLevel=computeShadow(vPositionFromLight{X},shadowSampler{X},shadowsInfo{X}.x,shadowsInfo{X}.z);\n#endif\n#endif\n#endif\n#else\nnotShadowLevel=1.;\n#endif\n#if defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\nlightDiffuseContribution+=lightmapColor*notShadowLevel;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nlightSpecularContribution+=info.specular*notShadowLevel*lightmapColor;\n#endif\n#endif\n#else\nlightDiffuseContribution+=info.diffuse*notShadowLevel;\n#ifdef OVERLOADEDSHADOWVALUES\nif (NdotL<0.000000000011)\n{\nnotShadowLevel=1.;\n}\nshadowedOnlyLightDiffuseContribution*=notShadowLevel;\n#endif\n#ifdef SPECULARTERM\nlightSpecularContribution+=info.specular*notShadowLevel;\n#endif\n#endif\n#endif",pbrShadowFunctions:"\n#ifdef SHADOWS\n#ifndef SHADOWFULLFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nuniform vec2 depthValues;\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float bias)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y =-directionToLight.y;\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight))+bias;\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x+bias;\n#endif\nif (depth>shadow)\n{\n#ifdef OVERLOADEDSHADOWVALUES\nreturn mix(1.0,darkness,vOverloadedShadowIntensity.x);\n#else\nreturn darkness;\n#endif\n}\nreturn 1.0;\n}\nfloat computeShadowWithPCFCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\nfloat biasedDepth=depth-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nreturn min(1.0,mix(1.0,visibility+darkness,vOverloadedShadowIntensity.x));\n#else\nreturn min(1.0,visibility+darkness);\n#endif\n}\nfloat computeShadow(vec4 vPositionFromLight,sampler2D shadowSampler,float darkness,float bias)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv))+bias;\n#else\nfloat shadow=texture2D(shadowSampler,uv).x+bias;\n#endif\nif (depth.z>shadow)\n{\n#ifdef OVERLOADEDSHADOWVALUES\nreturn mix(1.0,darkness,vOverloadedShadowIntensity.x);\n#else\nreturn darkness;\n#endif\n}\nreturn 1.;\n}\nfloat computeShadowWithPCF(vec4 vPositionFromLight,sampler2D shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\nfloat biasedDepth=depth.z-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nreturn min(1.0,mix(1.0,visibility+darkness,vOverloadedShadowIntensity.x));\n#else\nreturn min(1.0,visibility+darkness);\n#endif\n}\n#ifndef SHADOWFULLFLOAT\n\nfloat unpackHalf(vec2 color)\n{\nreturn color.x+(color.y/255.0);\n}\n#endif\nfloat linstep(float low,float high,float v) {\nreturn clamp((v-low)/(high-low),0.0,1.0);\n}\nfloat ChebychevInequality(vec2 moments,float compare,float bias)\n{\nfloat p=smoothstep(compare-bias,compare,moments.x);\nfloat variance=max(moments.y-moments.x*moments.x,0.02);\nfloat d=compare-moments.x;\nfloat p_max=linstep(0.2,1.0,variance/(variance+d*d));\nreturn clamp(max(p,p_max),0.0,1.0);\n}\nfloat computeShadowWithVSM(vec4 vPositionFromLight,sampler2D shadowSampler,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0 || depth.z>=1.0)\n{\nreturn 1.0;\n}\nvec4 texel=texture2D(shadowSampler,uv);\n#ifndef SHADOWFULLFLOAT\nvec2 moments=vec2(unpackHalf(texel.xy),unpackHalf(texel.zw));\n#else\nvec2 moments=texel.xy;\n#endif\n#ifdef OVERLOADEDSHADOWVALUES\nreturn min(1.0,mix(1.0,1.0-ChebychevInequality(moments,depth.z,bias)+darkness,vOverloadedShadowIntensity.x));\n#else\nreturn min(1.0,1.0-ChebychevInequality(moments,depth.z,bias)+darkness);\n#endif\n}\n#endif",pointCloudVertex:"#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif",pointCloudVertexDeclaration:"#ifdef POINTSIZE\nuniform float pointSize;\n#endif",reflectionFunction:"vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED\nvec3 direction=normalize(vDirectionW);\nfloat t=clamp(direction.y*-0.5+0.5,0.,1.0);\nfloat s=atan(direction.z,direction.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nvec3 cameraToVertex=normalize(worldPos.xyz-vEyePosition);\nvec3 r=reflect(cameraToVertex,worldNormal);\nfloat t=clamp(r.y*-0.5+0.5,0.,1.0);\nfloat s=atan(r.z,r.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nvec3 viewDir=worldPos.xyz-vEyePosition;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n#endif\n#ifdef REFLECTIONMAP_CUBIC\nvec3 viewDir=worldPos.xyz-vEyePosition;\nvec3 coords=reflect(viewDir,worldNormal);\n#ifdef INVERTCUBICMAP\ncoords.y=1.0-coords.y;\n#endif\nreturn vec3(reflectionMatrix*vec4(coords,0));\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn vec3(reflectionMatrix*(view*worldPos));\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}",shadowsFragmentFunctions:"#ifdef SHADOWS\n#ifndef SHADOWFULLFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nuniform vec2 depthValues;\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float bias)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight))+bias;\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x+bias;\n#endif\nif (depth>shadow)\n{\nreturn darkness;\n}\nreturn 1.0;\n}\nfloat computeShadowWithPCFCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth-depthValues.x)/(depthValues.y-depthValues.x);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\nfloat biasedDepth=depth-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\nfloat computeShadow(vec4 vPositionFromLight,sampler2D shadowSampler,float darkness,float bias)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\n#ifndef SHADOWFULLFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv))+bias;\n#else\nfloat shadow=texture2D(shadowSampler,uv).x+bias;\n#endif\nif (depth.z>shadow)\n{\nreturn darkness;\n}\nreturn 1.;\n}\nfloat computeShadowWithPCF(vec4 vPositionFromLight,sampler2D shadowSampler,float mapSize,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\nfloat biasedDepth=depth.z-bias;\n#ifndef SHADOWFULLFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<biasedDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<biasedDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<biasedDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<biasedDepth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\n#ifndef SHADOWFULLFLOAT\n\nfloat unpackHalf(vec2 color)\n{\nreturn color.x+(color.y/255.0);\n}\n#endif\nfloat linstep(float low,float high,float v) {\nreturn clamp((v-low)/(high-low),0.0,1.0);\n}\nfloat ChebychevInequality(vec2 moments,float compare,float bias)\n{\nfloat p=smoothstep(compare-bias,compare,moments.x);\nfloat variance=max(moments.y-moments.x*moments.x,0.02);\nfloat d=compare-moments.x;\nfloat p_max=linstep(0.2,1.0,variance/(variance+d*d));\nreturn clamp(max(p,p_max),0.0,1.0);\n}\nfloat computeShadowWithVSM(vec4 vPositionFromLight,sampler2D shadowSampler,float bias,float darkness)\n{\nvec3 depth=vPositionFromLight.xyz/vPositionFromLight.w;\ndepth=0.5*depth+vec3(0.5);\nvec2 uv=depth.xy;\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0 || depth.z>=1.0)\n{\nreturn 1.0;\n}\nvec4 texel=texture2D(shadowSampler,uv);\n#ifndef SHADOWFULLFLOAT\nvec2 moments=vec2(unpackHalf(texel.xy),unpackHalf(texel.zw));\n#else\nvec2 moments=texel.xy;\n#endif\nreturn min(1.0,1.0-ChebychevInequality(moments,depth.z,bias)+darkness);\n}\n#endif",shadowsVertex:"#ifdef SHADOWS\n#if defined(SPOTLIGHT{X}) || defined(DIRLIGHT{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\n#endif\n#endif",shadowsVertexDeclaration:"#ifdef SHADOWS\n#if defined(SPOTLIGHT{X}) || defined(DIRLIGHT{X})\nuniform mat4 lightMatrix{X};\nvarying vec4 vPositionFromLight{X};\n#endif\n#endif\n"};i.CollisionWorker='var BABYLON;!function(t){var e=function(t,e,o,i){return!(t.x>o.x+i)&&(!(o.x-i>e.x)&&(!(t.y>o.y+i)&&(!(o.y-i>e.y)&&(!(t.z>o.z+i)&&!(o.z-i>e.z)))))},o=function(){var t={root:0,found:!1};return function(e,o,i,s){t.root=0,t.found=!1;var r=o*o-4*e*i;if(r<0)return t;var n=Math.sqrt(r),c=(-o-n)/(2*e),h=(-o+n)/(2*e);if(c>h){var a=h;h=c,c=a}return c>0&&c<s?(t.root=c,t.found=!0,t):h>0&&h<s?(t.root=h,t.found=!0,t):t}}(),i=function(){function i(){this.radius=new t.Vector3(1,1,1),this.retry=0,this.basePointWorld=t.Vector3.Zero(),this.velocityWorld=t.Vector3.Zero(),this.normalizedVelocity=t.Vector3.Zero(),this._collisionPoint=t.Vector3.Zero(),this._planeIntersectionPoint=t.Vector3.Zero(),this._tempVector=t.Vector3.Zero(),this._tempVector2=t.Vector3.Zero(),this._tempVector3=t.Vector3.Zero(),this._tempVector4=t.Vector3.Zero(),this._edge=t.Vector3.Zero(),this._baseToVertex=t.Vector3.Zero(),this._destinationPoint=t.Vector3.Zero(),this._slidePlaneNormal=t.Vector3.Zero(),this._displacementVector=t.Vector3.Zero()}return i.prototype._initialize=function(e,o,i){this.velocity=o,t.Vector3.NormalizeToRef(o,this.normalizedVelocity),this.basePoint=e,e.multiplyToRef(this.radius,this.basePointWorld),o.multiplyToRef(this.radius,this.velocityWorld),this.velocityWorldLength=this.velocityWorld.length(),this.epsilon=i,this.collisionFound=!1},i.prototype._checkPointInTriangle=function(e,o,i,s,r){o.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),t.Vector3.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);var n=t.Vector3.Dot(this._tempVector4,r);return!(n<0)&&(s.subtractToRef(e,this._tempVector3),t.Vector3.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),n=t.Vector3.Dot(this._tempVector4,r),!(n<0)&&(t.Vector3.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),n=t.Vector3.Dot(this._tempVector4,r),n>=0))},i.prototype._canDoCollision=function(o,i,s,r){var n=t.Vector3.Distance(this.basePointWorld,o),c=Math.max(this.radius.x,this.radius.y,this.radius.z);return!(n>this.velocityWorldLength+c+i)&&!!e(s,r,this.basePointWorld,this.velocityWorldLength+c)},i.prototype._testTriangle=function(e,i,s,r,n,c){var h,a=!1;i||(i=[]),i[e]||(i[e]=new t.Plane(0,0,0,0),i[e].copyFromPoints(s,r,n));var l=i[e];if(c||l.isFrontFacingTo(this.normalizedVelocity,0)){var _=l.signedDistanceTo(this.basePoint),d=t.Vector3.Dot(l.normal,this.velocity);if(0==d){if(Math.abs(_)>=1)return;a=!0,h=0}else{h=(-1-_)/d;var V=(1-_)/d;if(h>V){var u=V;V=h,h=u}if(h>1||V<0)return;h<0&&(h=0),h>1&&(h=1)}this._collisionPoint.copyFromFloats(0,0,0);var P=!1,p=1;if(a||(this.basePoint.subtractToRef(l.normal,this._planeIntersectionPoint),this.velocity.scaleToRef(h,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,s,r,n,l.normal)&&(P=!0,p=h,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!P){var f=this.velocity.lengthSquared(),m=f;this.basePoint.subtractToRef(s,this._tempVector);var T=2*t.Vector3.Dot(this.velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=o(m,T,b,p);y.found&&(p=y.root,P=!0,this._collisionPoint.copyFrom(s)),this.basePoint.subtractToRef(r,this._tempVector),T=2*t.Vector3.Dot(this.velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=o(m,T,b,p),y.found&&(p=y.root,P=!0,this._collisionPoint.copyFrom(r)),this.basePoint.subtractToRef(n,this._tempVector),T=2*t.Vector3.Dot(this.velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,y=o(m,T,b,p),y.found&&(p=y.root,P=!0,this._collisionPoint.copyFrom(n)),r.subtractToRef(s,this._edge),s.subtractToRef(this.basePoint,this._baseToVertex);var g=this._edge.lengthSquared(),v=t.Vector3.Dot(this._edge,this.velocity),R=t.Vector3.Dot(this._edge,this._baseToVertex);if(m=g*-f+v*v,T=g*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*v*R,b=g*(1-this._baseToVertex.lengthSquared())+R*R,y=o(m,T,b,p),y.found){var D=(v*y.root-R)/g;D>=0&&D<=1&&(p=y.root,P=!0,this._edge.scaleInPlace(D),s.addToRef(this._edge,this._collisionPoint))}n.subtractToRef(r,this._edge),r.subtractToRef(this.basePoint,this._baseToVertex),g=this._edge.lengthSquared(),v=t.Vector3.Dot(this._edge,this.velocity),R=t.Vector3.Dot(this._edge,this._baseToVertex),m=g*-f+v*v,T=g*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*v*R,b=g*(1-this._baseToVertex.lengthSquared())+R*R,y=o(m,T,b,p),y.found&&(D=(v*y.root-R)/g,D>=0&&D<=1&&(p=y.root,P=!0,this._edge.scaleInPlace(D),r.addToRef(this._edge,this._collisionPoint))),s.subtractToRef(n,this._edge),n.subtractToRef(this.basePoint,this._baseToVertex),g=this._edge.lengthSquared(),v=t.Vector3.Dot(this._edge,this.velocity),R=t.Vector3.Dot(this._edge,this._baseToVertex),m=g*-f+v*v,T=g*(2*t.Vector3.Dot(this.velocity,this._baseToVertex))-2*v*R,b=g*(1-this._baseToVertex.lengthSquared())+R*R,y=o(m,T,b,p),y.found&&(D=(v*y.root-R)/g,D>=0&&D<=1&&(p=y.root,P=!0,this._edge.scaleInPlace(D),n.addToRef(this._edge,this._collisionPoint)))}if(P){var x=p*this.velocity.length();(!this.collisionFound||x<this.nearestDistance)&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this.nearestDistance=x,this.collisionFound=!0)}}},i.prototype._collide=function(t,e,o,i,s,r,n){for(var c=i;c<s;c+=3){var h=e[o[c]-r],a=e[o[c+1]-r],l=e[o[c+2]-r];this._testTriangle(c,t,l,a,h,n)}},i.prototype._getResponse=function(e,o){e.addToRef(o,this._destinationPoint),o.scaleInPlace(this.nearestDistance/o.length()),this.basePoint.addToRef(o,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this.epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(t.Plane.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,o)},i}();t.Collider=i}(BABYLON||(BABYLON={}));var BABYLON;!function(o){o.WorkerIncluded=!0;var e=function(){function o(){this._meshes={},this._geometries={}}return o.prototype.getMeshes=function(){return this._meshes},o.prototype.getGeometries=function(){return this._geometries},o.prototype.getMesh=function(o){return this._meshes[o]},o.prototype.addMesh=function(o){this._meshes[o.uniqueId]=o},o.prototype.removeMesh=function(o){delete this._meshes[o]},o.prototype.getGeometry=function(o){return this._geometries[o]},o.prototype.addGeometry=function(o){this._geometries[o.id]=o},o.prototype.removeGeometry=function(o){delete this._geometries[o]},o}();o.CollisionCache=e;var i=function(){function e(e,i,r){this.collider=e,this._collisionCache=i,this.finalPosition=r,this.collisionsScalingMatrix=o.Matrix.Zero(),this.collisionTranformationMatrix=o.Matrix.Zero()}return e.prototype.collideWithWorld=function(o,e,i,r){var t=.01;if(this.collider.retry>=i)return void this.finalPosition.copyFrom(o);this.collider._initialize(o,e,t);for(var s,l=this._collisionCache.getMeshes(),n=Object.keys(l),a=n.length,c=0;c<a;++c)if(s=n[c],parseInt(s)!=r){var d=l[s];d.checkCollisions&&this.checkCollision(d)}return this.collider.collisionFound?(0===e.x&&0===e.y&&0===e.z||this.collider._getResponse(o,e),e.length()<=t?void this.finalPosition.copyFrom(o):(this.collider.retry++,void this.collideWithWorld(o,e,i,r))):void o.addToRef(e,this.finalPosition)},e.prototype.checkCollision=function(e){if(this.collider._canDoCollision(o.Vector3.FromArray(e.sphereCenter),e.sphereRadius,o.Vector3.FromArray(e.boxMinimum),o.Vector3.FromArray(e.boxMaximum))){o.Matrix.ScalingToRef(1/this.collider.radius.x,1/this.collider.radius.y,1/this.collider.radius.z,this.collisionsScalingMatrix);var i=o.Matrix.FromArray(e.worldMatrixFromCache);i.multiplyToRef(this.collisionsScalingMatrix,this.collisionTranformationMatrix),this.processCollisionsForSubMeshes(this.collisionTranformationMatrix,e)}},e.prototype.processCollisionsForSubMeshes=function(o,e){var i=e.subMeshes,r=i.length;if(!e.geometryId)return void console.log("no mesh geometry id");var t=this._collisionCache.getGeometry(e.geometryId);if(!t)return void console.log("couldn\'t find geometry",e.geometryId);for(var s=0;s<r;s++){var l=i[s];r>1&&!this.checkSubmeshCollision(l)||(this.collideForSubMesh(l,o,t),this.collider.collisionFound&&(this.collider.collidedMesh=e.uniqueId))}},e.prototype.collideForSubMesh=function(e,i,r){if(!r.positionsArray){r.positionsArray=[];for(var t=0,s=r.positions.length;t<s;t+=3){var l=o.Vector3.FromArray([r.positions[t],r.positions[t+1],r.positions[t+2]]);r.positionsArray.push(l)}}if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(i)){e._lastColliderTransformMatrix=i.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];for(var n=e.verticesStart,a=e.verticesStart+e.verticesCount,t=n;t<a;t++)e._lastColliderWorldVertices.push(o.Vector3.TransformCoordinates(r.positionsArray[t],i))}this.collider._collide(e._trianglePlanes,e._lastColliderWorldVertices,r.indices,e.indexStart,e.indexStart+e.indexCount,e.verticesStart,e.hasMaterial)},e.prototype.checkSubmeshCollision=function(e){return this.collider._canDoCollision(o.Vector3.FromArray(e.sphereCenter),e.sphereRadius,o.Vector3.FromArray(e.boxMinimum),o.Vector3.FromArray(e.boxMaximum))},e}();o.CollideWorker=i;var r=function(){function r(){}return r.prototype.onInit=function(i){this._collisionCache=new e;var r={error:o.WorkerReplyType.SUCCESS,taskType:o.WorkerTaskType.INIT};postMessage(r,void 0)},r.prototype.onUpdate=function(e){var i=this,r={error:o.WorkerReplyType.SUCCESS,taskType:o.WorkerTaskType.UPDATE};try{for(var t in e.updatedGeometries)e.updatedGeometries.hasOwnProperty(t)&&this._collisionCache.addGeometry(e.updatedGeometries[t]);for(var s in e.updatedMeshes)e.updatedMeshes.hasOwnProperty(s)&&this._collisionCache.addMesh(e.updatedMeshes[s]);e.removedGeometries.forEach(function(o){i._collisionCache.removeGeometry(o)}),e.removedMeshes.forEach(function(o){i._collisionCache.removeMesh(o)})}catch(l){r.error=o.WorkerReplyType.UNKNOWN_ERROR}postMessage(r,void 0)},r.prototype.onCollision=function(e){var r=o.Vector3.Zero(),t=new o.Collider;t.radius=o.Vector3.FromArray(e.collider.radius);var s=new i(t,this._collisionCache,r);s.collideWithWorld(o.Vector3.FromArray(e.collider.position),o.Vector3.FromArray(e.collider.velocity),e.maximumRetry,e.excludedMeshUniqueId);var l={collidedMeshUniqueId:t.collidedMesh,collisionId:e.collisionId,newPosition:r.asArray()},n={error:o.WorkerReplyType.SUCCESS,taskType:o.WorkerTaskType.COLLIDE,payload:l};postMessage(n,void 0)},r}();o.CollisionDetectorTransferable=r;try{if(self&&self instanceof WorkerGlobalScope){window={},o.Collider||(importScripts("./babylon.collisionCoordinator.js"),importScripts("./babylon.collider.js"),importScripts("../Math/babylon.math.js"));var t=new r,s=function(e){var i=e.data;switch(i.taskType){case o.WorkerTaskType.INIT:t.onInit(i.payload);break;case o.WorkerTaskType.COLLIDE:t.onCollision(i.payload);break;case o.WorkerTaskType.UPDATE:t.onUpdate(i.payload)}};self.onmessage=s}}catch(l){console.log("single worker init")}}(BABYLON||(BABYLON={}));var BABYLON;!function(e){e.CollisionWorker="",function(e){e[e.INIT=0]="INIT",e[e.UPDATE=1]="UPDATE",e[e.COLLIDE=2]="COLLIDE"}(e.WorkerTaskType||(e.WorkerTaskType={}));var o=e.WorkerTaskType;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.UNKNOWN_ERROR=1]="UNKNOWN_ERROR"}(e.WorkerReplyType||(e.WorkerReplyType={}));var i=e.WorkerReplyType,t=function(){function t(){var r=this;this._scaledPosition=e.Vector3.Zero(),this._scaledVelocity=e.Vector3.Zero(),this.onMeshUpdated=function(e){r._addUpdateMeshesList[e.uniqueId]=t.SerializeMesh(e)},this.onGeometryUpdated=function(e){r._addUpdateGeometriesList[e.id]=t.SerializeGeometry(e)},this._afterRender=function(){if(r._init&&!(0==r._toRemoveGeometryArray.length&&0==r._toRemoveMeshesArray.length&&0==Object.keys(r._addUpdateGeometriesList).length&&0==Object.keys(r._addUpdateMeshesList).length||r._runningUpdated>4)){++r._runningUpdated;var e={updatedMeshes:r._addUpdateMeshesList,updatedGeometries:r._addUpdateGeometriesList,removedGeometries:r._toRemoveGeometryArray,removedMeshes:r._toRemoveMeshesArray},i={payload:e,taskType:o.UPDATE},t=[];for(var s in e.updatedGeometries)e.updatedGeometries.hasOwnProperty(s)&&(t.push(i.payload.updatedGeometries[s].indices.buffer),t.push(i.payload.updatedGeometries[s].normals.buffer),t.push(i.payload.updatedGeometries[s].positions.buffer));r._worker.postMessage(i,t),r._addUpdateMeshesList={},r._addUpdateGeometriesList={},r._toRemoveGeometryArray=[],r._toRemoveMeshesArray=[]}},this._onMessageFromWorker=function(t){var s=t.data;if(s.error!=i.SUCCESS)return void e.Tools.Warn("error returned from worker!");switch(s.taskType){case o.INIT:r._init=!0,r._scene.meshes.forEach(function(e){r.onMeshAdded(e)}),r._scene.getGeometries().forEach(function(e){r.onGeometryAdded(e)});break;case o.UPDATE:r._runningUpdated--;break;case o.COLLIDE:r._runningCollisionTask=!1;var n=s.payload;if(!r._collisionsCallbackArray[n.collisionId])return;r._collisionsCallbackArray[n.collisionId](n.collisionId,e.Vector3.FromArray(n.newPosition),r._scene.getMeshByUniqueID(n.collidedMeshUniqueId)),r._collisionsCallbackArray[n.collisionId]=void 0}},this._collisionsCallbackArray=[],this._init=!1,this._runningUpdated=0,this._runningCollisionTask=!1,this._addUpdateMeshesList={},this._addUpdateGeometriesList={},this._toRemoveGeometryArray=[],this._toRemoveMeshesArray=[]}return t.prototype.getNewPosition=function(e,i,t,r,s,n,a){if(this._init&&!this._collisionsCallbackArray[a]&&!this._collisionsCallbackArray[a+1e5]){e.divideToRef(t.radius,this._scaledPosition),i.divideToRef(t.radius,this._scaledVelocity),this._collisionsCallbackArray[a]=n;var d={collider:{position:this._scaledPosition.asArray(),velocity:this._scaledVelocity.asArray(),radius:t.radius.asArray()},collisionId:a,excludedMeshUniqueId:s?s.uniqueId:null,maximumRetry:r},l={payload:d,taskType:o.COLLIDE};this._worker.postMessage(l)}},t.prototype.init=function(i){this._scene=i,this._scene.registerAfterRender(this._afterRender);var t=e.WorkerIncluded?e.Engine.CodeRepository+"Collisions/babylon.collisionWorker.js":URL.createObjectURL(new Blob([e.CollisionWorker],{type:"application/javascript"}));this._worker=new Worker(t),this._worker.onmessage=this._onMessageFromWorker;var r={payload:{},taskType:o.INIT};this._worker.postMessage(r)},t.prototype.destroy=function(){this._scene.unregisterAfterRender(this._afterRender),this._worker.terminate()},t.prototype.onMeshAdded=function(e){e.registerAfterWorldMatrixUpdate(this.onMeshUpdated),this.onMeshUpdated(e)},t.prototype.onMeshRemoved=function(e){this._toRemoveMeshesArray.push(e.uniqueId)},t.prototype.onGeometryAdded=function(e){e.onGeometryUpdated=this.onGeometryUpdated,this.onGeometryUpdated(e)},t.prototype.onGeometryDeleted=function(e){this._toRemoveGeometryArray.push(e.id)},t.SerializeMesh=function(o){var i=[];o.subMeshes&&(i=o.subMeshes.map(function(e,o){return{position:o,verticesStart:e.verticesStart,verticesCount:e.verticesCount,indexStart:e.indexStart,indexCount:e.indexCount,hasMaterial:!!e.getMaterial(),sphereCenter:e.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:e.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:e.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:e.getBoundingInfo().boundingBox.maximumWorld.asArray()}}));var t=null;return o instanceof e.Mesh?t=o.geometry?o.geometry.id:null:o instanceof e.InstancedMesh&&(t=o.sourceMesh&&o.sourceMesh.geometry?o.sourceMesh.geometry.id:null),{uniqueId:o.uniqueId,id:o.id,name:o.name,geometryId:t,sphereCenter:o.getBoundingInfo().boundingSphere.centerWorld.asArray(),sphereRadius:o.getBoundingInfo().boundingSphere.radiusWorld,boxMinimum:o.getBoundingInfo().boundingBox.minimumWorld.asArray(),boxMaximum:o.getBoundingInfo().boundingBox.maximumWorld.asArray(),worldMatrixFromCache:o.worldMatrixFromCache.asArray(),subMeshes:i,checkCollisions:o.checkCollisions}},t.SerializeGeometry=function(o){return{id:o.id,positions:new Float32Array(o.getVerticesData(e.VertexBuffer.PositionKind)||[]),normals:new Float32Array(o.getVerticesData(e.VertexBuffer.NormalKind)||[]),indices:new Int32Array(o.getIndices()||[])}},t}();e.CollisionCoordinatorWorker=t;var r=function(){function o(){this._scaledPosition=e.Vector3.Zero(),this._scaledVelocity=e.Vector3.Zero(),this._finalPosition=e.Vector3.Zero()}return o.prototype.getNewPosition=function(e,o,i,t,r,s,n){e.divideToRef(i.radius,this._scaledPosition),o.divideToRef(i.radius,this._scaledVelocity),i.collidedMesh=null,i.retry=0,i.initialVelocity=this._scaledVelocity,i.initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,t,this._finalPosition,r),this._finalPosition.multiplyInPlace(i.radius),s(n,this._finalPosition,i.collidedMesh)},o.prototype.init=function(e){this._scene=e},o.prototype.destroy=function(){},o.prototype.onMeshAdded=function(e){},o.prototype.onMeshUpdated=function(e){},o.prototype.onMeshRemoved=function(e){},o.prototype.onGeometryAdded=function(e){},o.prototype.onGeometryUpdated=function(e){},o.prototype.onGeometryDeleted=function(e){},o.prototype._collideWithWorld=function(o,i,t,r,s,n){void 0===n&&(n=null);var a=10*e.Engine.CollisionsEpsilon;if(t.retry>=r)return void s.copyFrom(o);t._initialize(o,i,a);for(var d=0;d<this._scene.meshes.length;d++){var l=this._scene.meshes[d];l.isEnabled()&&l.checkCollisions&&l.subMeshes&&l!==n&&l._checkCollision(t)}return t.collisionFound?(0===i.x&&0===i.y&&0===i.z||t._getResponse(o,i),i.length()<=a?void s.copyFrom(o):(t.retry++,void this._collideWithWorld(o,i,t,r,s,n))):void o.addToRef(i,s)},o}();e.CollisionCoordinatorLegacy=r}(BABYLON||(BABYLON={}));var BABYLON;!function(t){t.ToGammaSpace=1/2.2,t.ToLinearSpace=2.2,t.Epsilon=.001;var i=function(){function t(){}return t.WithinEpsilon=function(t,i,n){void 0===n&&(n=1.401298e-45);var r=t-i;return-n<=r&&r<=n},t.ToHex=function(t){var i=t.toString(16);return t<=15?("0"+i).toUpperCase():i.toUpperCase()},t.Sign=function(t){return t=+t,0===t||isNaN(t)?t:t>0?1:-1},t.Clamp=function(t,i,n){return void 0===i&&(i=0),void 0===n&&(n=1),Math.min(n,Math.max(i,t))},t}();t.MathTools=i;var n=function(){function n(t,i,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.r=t,this.g=i,this.b=n}return n.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},n.prototype.getClassName=function(){return"Color3"},n.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0)},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.r,t[i+1]=this.g,t[i+2]=this.b,this},n.prototype.toColor4=function(t){return void 0===t&&(t=1),new r(this.r,this.g,this.b,t)},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.toLuminance=function(){return.3*this.r+.59*this.g+.11*this.b},n.prototype.multiply=function(t){return new n(this.r*t.r,this.g*t.g,this.b*t.b)},n.prototype.multiplyToRef=function(t,i){return i.r=this.r*t.r,i.g=this.g*t.g,i.b=this.b*t.b,this},n.prototype.equals=function(t){return t&&this.r===t.r&&this.g===t.g&&this.b===t.b},n.prototype.equalsFloats=function(t,i,n){return this.r===t&&this.g===i&&this.b===n},n.prototype.scale=function(t){return new n(this.r*t,this.g*t,this.b*t)},n.prototype.scaleToRef=function(t,i){return i.r=this.r*t,i.g=this.g*t,i.b=this.b*t,this},n.prototype.add=function(t){return new n(this.r+t.r,this.g+t.g,this.b+t.b)},n.prototype.addToRef=function(t,i){return i.r=this.r+t.r,i.g=this.g+t.g,i.b=this.b+t.b,this},n.prototype.subtract=function(t){return new n(this.r-t.r,this.g-t.g,this.b-t.b)},n.prototype.subtractToRef=function(t,i){return i.r=this.r-t.r,i.g=this.g-t.g,i.b=this.b-t.b,this},n.prototype.clone=function(){return new n(this.r,this.g,this.b)},n.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},n.prototype.copyFromFloats=function(t,i,n){return this.r=t,this.g=i,this.b=n,this},n.prototype.toHexString=function(){var t=255*this.r|0,n=255*this.g|0,r=255*this.b|0;return"#"+i.ToHex(t)+i.ToHex(n)+i.ToHex(r)},n.prototype.toLinearSpace=function(){var t=new n;return this.toLinearSpaceToRef(t),t},n.prototype.toLinearSpaceToRef=function(i){return i.r=Math.pow(this.r,t.ToLinearSpace),i.g=Math.pow(this.g,t.ToLinearSpace),i.b=Math.pow(this.b,t.ToLinearSpace),this},n.prototype.toGammaSpace=function(){var t=new n;return this.toGammaSpaceToRef(t),t},n.prototype.toGammaSpaceToRef=function(i){return i.r=Math.pow(this.r,t.ToGammaSpace),i.g=Math.pow(this.g,t.ToGammaSpace),i.b=Math.pow(this.b,t.ToGammaSpace),this},n.FromHexString=function(t){if("#"!==t.substring(0,1)||7!==t.length)return new n(0,0,0);var i=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),o=parseInt(t.substring(5,7),16);return n.FromInts(i,r,o)},n.FromArray=function(t,i){return void 0===i&&(i=0),new n(t[i],t[i+1],t[i+2])},n.FromInts=function(t,i,r){return new n(t/255,i/255,r/255)},n.Lerp=function(t,i,r){var o=t.r+(i.r-t.r)*r,e=t.g+(i.g-t.g)*r,s=t.b+(i.b-t.b)*r;return new n(o,e,s)},n.Red=function(){return new n(1,0,0)},n.Green=function(){return new n(0,1,0)},n.Blue=function(){return new n(0,0,1)},n.Black=function(){return new n(0,0,0)},n.White=function(){return new n(1,1,1)},n.Purple=function(){return new n(.5,0,.5)},n.Magenta=function(){return new n(1,0,1)},n.Yellow=function(){return new n(1,1,0)},n.Gray=function(){return new n(.5,.5,.5)},n}();t.Color3=n;var r=function(){function t(t,i,n,r){this.r=t,this.g=i,this.b=n,this.a=r}return t.prototype.addInPlace=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},t.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},t.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.r,t[i+1]=this.g,t[i+2]=this.b,t[i+3]=this.a,this},t.prototype.add=function(i){return new t(this.r+i.r,this.g+i.g,this.b+i.b,this.a+i.a)},t.prototype.subtract=function(i){return new t(this.r-i.r,this.g-i.g,this.b-i.b,this.a-i.a)},t.prototype.subtractToRef=function(t,i){return i.r=this.r-t.r,i.g=this.g-t.g,i.b=this.b-t.b,i.a=this.a-t.a,this},t.prototype.scale=function(i){return new t(this.r*i,this.g*i,this.b*i,this.a*i)},t.prototype.scaleToRef=function(t,i){return i.r=this.r*t,i.g=this.g*t,i.b=this.b*t,i.a=this.a*t,this},t.prototype.multiply=function(i){return new t(this.r*i.r,this.g*i.g,this.b*i.b,this.a*i.a)},t.prototype.multiplyToRef=function(t,i){return i.r=this.r*t.r,i.g=this.g*t.g,i.b=this.b*t.b,i.a=this.a*t.a,i},t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},t.prototype.getClassName=function(){return"Color4"},t.prototype.getHashCode=function(){var t=this.r||0;return t=397*t^(this.g||0),t=397*t^(this.b||0),t=397*t^(this.a||0)},t.prototype.clone=function(){return new t(this.r,this.g,this.b,this.a)},t.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.toHexString=function(){var t=255*this.r|0,n=255*this.g|0,r=255*this.b|0,o=255*this.a|0;return"#"+i.ToHex(t)+i.ToHex(n)+i.ToHex(r)+i.ToHex(o)},t.FromHexString=function(i){if("#"!==i.substring(0,1)||9!==i.length)return new t(0,0,0,0);var n=parseInt(i.substring(1,3),16),r=parseInt(i.substring(3,5),16),o=parseInt(i.substring(5,7),16),e=parseInt(i.substring(7,9),16);return t.FromInts(n,r,o,e)},t.Lerp=function(i,n,r){var o=new t(0,0,0,0);return t.LerpToRef(i,n,r,o),o},t.LerpToRef=function(t,i,n,r){r.r=t.r+(i.r-t.r)*n,r.g=t.g+(i.g-t.g)*n,r.b=t.b+(i.b-t.b)*n,r.a=t.a+(i.a-t.a)*n},t.FromArray=function(i,n){return void 0===n&&(n=0),new t(i[n],i[n+1],i[n+2],i[n+3])},t.FromInts=function(i,n,r,o){return new t(i/255,n/255,r/255,o/255)},t.CheckColors4=function(t,i){if(t.length===3*i){for(var n=[],r=0;r<t.length;r+=3){var o=r/3*4;n[o]=t[r],n[o+1]=t[r+1],n[o+2]=t[r+2],n[o+3]=1}return n}return t},t}();t.Color4=r;var o=function(){function n(t,i){this.x=t,this.y=i}return n.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},n.prototype.getClassName=function(){return"Vector2"},n.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0)},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,this},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this},n.prototype.copyFromFloats=function(t,i){return this.x=t,this.y=i,this},n.prototype.add=function(t){return new n(this.x+t.x,this.y+t.y)},n.prototype.addToRef=function(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,this},n.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this},n.prototype.addVector3=function(t){return new n(this.x+t.x,this.y+t.y)},n.prototype.subtract=function(t){return new n(this.x-t.x,this.y-t.y)},n.prototype.subtractToRef=function(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,this},n.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this},n.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this},n.prototype.multiply=function(t){return new n(this.x*t.x,this.y*t.y)},n.prototype.multiplyToRef=function(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,this},n.prototype.multiplyByFloats=function(t,i){return new n(this.x*t,this.y*i)},n.prototype.divide=function(t){return new n(this.x/t.x,this.y/t.y)},n.prototype.divideToRef=function(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,this},n.prototype.negate=function(){return new n((-this.x),(-this.y))},n.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this},n.prototype.scale=function(t){return new n(this.x*t,this.y*t)},n.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y},n.prototype.equalsWithEpsilon=function(n,r){return void 0===r&&(r=t.Epsilon),n&&i.WithinEpsilon(this.x,n.x,r)&&i.WithinEpsilon(this.y,n.y,r)},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},n.prototype.normalize=function(){var t=this.length();if(0===t)return this;var i=1/t;return this.x*=i,this.y*=i,this},n.prototype.clone=function(){return new n(this.x,this.y)},n.Zero=function(){return new n(0,0)},n.FromArray=function(t,i){return void 0===i&&(i=0),new n(t[i],t[i+1])},n.FromArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1]},n.CatmullRom=function(t,i,r,o,e){var s=e*e,h=e*s,a=.5*(2*i.x+(-t.x+r.x)*e+(2*t.x-5*i.x+4*r.x-o.x)*s+(-t.x+3*i.x-3*r.x+o.x)*h),u=.5*(2*i.y+(-t.y+r.y)*e+(2*t.y-5*i.y+4*r.y-o.y)*s+(-t.y+3*i.y-3*r.y+o.y)*h);return new n(a,u)},n.Clamp=function(t,i,r){var o=t.x;o=o>r.x?r.x:o,o=o<i.x?i.x:o;var e=t.y;return e=e>r.y?r.y:e,e=e<i.y?i.y:e,new n(o,e)},n.Hermite=function(t,i,r,o,e){var s=e*e,h=e*s,a=2*h-3*s+1,u=-2*h+3*s,m=h-2*s+e,y=h-s,c=t.x*a+r.x*u+i.x*m+o.x*y,p=t.y*a+r.y*u+i.y*m+o.y*y;return new n(c,p)},n.Lerp=function(t,i,r){var o=t.x+(i.x-t.x)*r,e=t.y+(i.y-t.y)*r;return new n(o,e)},n.Dot=function(t,i){return t.x*i.x+t.y*i.y},n.Normalize=function(t){var i=t.clone();return i.normalize(),i},n.Minimize=function(t,i){var r=t.x<i.x?t.x:i.x,o=t.y<i.y?t.y:i.y;return new n(r,o)},n.Maximize=function(t,i){var r=t.x>i.x?t.x:i.x,o=t.y>i.y?t.y:i.y;return new n(r,o)},n.Transform=function(t,i){var r=n.Zero();return n.TransformToRef(t,i,r),r},n.TransformToRef=function(t,i,n){var r=t.x*i.m[0]+t.y*i.m[4]+i.m[12],o=t.x*i.m[1]+t.y*i.m[5]+i.m[13];n.x=r,n.y=o},n.PointInTriangle=function(t,i,n,r){var o=.5*(-n.y*r.x+i.y*(-n.x+r.x)+i.x*(n.y-r.y)+n.x*r.y),e=o<0?-1:1,s=(i.y*r.x-i.x*r.y+(r.y-i.y)*t.x+(i.x-r.x)*t.y)*e,h=(i.x*n.y-i.y*n.x+(i.y-n.y)*t.x+(n.x-i.x)*t.y)*e;return s>0&&h>0&&s+h<2*o*e},n.Distance=function(t,i){return Math.sqrt(n.DistanceSquared(t,i))},n.DistanceSquared=function(t,i){var n=t.x-i.x,r=t.y-i.y;return n*n+r*r},n.Center=function(t,i){var n=t.add(i);return n.scaleInPlace(.5),n},n.DistanceOfPointFromSegment=function(t,i,r){var o=n.DistanceSquared(i,r);if(0===o)return n.Distance(t,i);var e=r.subtract(i),s=Math.max(0,Math.min(1,n.Dot(t.subtract(i),e)/o)),h=i.add(e.multiplyByFloats(s,s));return n.Distance(t,h)},n}();t.Vector2=o;var e=function(){function n(t,i,n){this.x=t,this.y=i,this.z=n}return n.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},n.prototype.getClassName=function(){return"Vector3"},n.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0)},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,this},n.prototype.toQuaternion=function(){var t=new a(0,0,0,1),i=Math.cos(.5*(this.x+this.z)),n=Math.sin(.5*(this.x+this.z)),r=Math.cos(.5*(this.z-this.x)),o=Math.sin(.5*(this.z-this.x)),e=Math.cos(.5*this.y),s=Math.sin(.5*this.y);return t.x=r*s,t.y=-o*s,t.z=n*e,t.w=i*e,t},n.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.prototype.add=function(t){return new n(this.x+t.x,this.y+t.y,this.z+t.z)},n.prototype.addToRef=function(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,i.z=this.z+t.z,this},n.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.prototype.subtract=function(t){return new n(this.x-t.x,this.y-t.y,this.z-t.z)},n.prototype.subtractToRef=function(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,this},n.prototype.subtractFromFloats=function(t,i,r){return new n(this.x-t,this.y-i,this.z-r)},n.prototype.subtractFromFloatsToRef=function(t,i,n,r){return r.x=this.x-t,r.y=this.y-i,r.z=this.z-n,this},n.prototype.negate=function(){return new n((-this.x),(-this.y),(-this.z))},n.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this},n.prototype.scale=function(t){return new n(this.x*t,this.y*t,this.z*t)},n.prototype.scaleToRef=function(t,i){i.x=this.x*t,i.y=this.y*t,i.z=this.z*t},n.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z},n.prototype.equalsWithEpsilon=function(n,r){return void 0===r&&(r=t.Epsilon),n&&i.WithinEpsilon(this.x,n.x,r)&&i.WithinEpsilon(this.y,n.y,r)&&i.WithinEpsilon(this.z,n.z,r)},n.prototype.equalsToFloats=function(t,i,n){return this.x===t&&this.y===i&&this.z===n},n.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.prototype.multiply=function(t){return new n(this.x*t.x,this.y*t.y,this.z*t.z)},n.prototype.multiplyToRef=function(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,i.z=this.z*t.z,this},n.prototype.multiplyByFloats=function(t,i,r){return new n(this.x*t,this.y*i,this.z*r)},n.prototype.divide=function(t){return new n(this.x/t.x,this.y/t.y,this.z/t.z)},n.prototype.divideToRef=function(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,i.z=this.z/t.z,this},n.prototype.MinimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),this},n.prototype.MaximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),this},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.prototype.normalize=function(){var t=this.length();if(0===t||1===t)return this;var i=1/t;return this.x*=i,this.y*=i,this.z*=i,this},n.prototype.clone=function(){return new n(this.x,this.y,this.z)},n.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},n.prototype.copyFromFloats=function(t,i,n){return this.x=t,this.y=i,this.z=n,this},n.GetClipFactor=function(t,i,r,o){var e=n.Dot(t,r)-o,s=n.Dot(i,r)-o,h=e/(e-s);return h},n.FromArray=function(t,i){return i||(i=0),new n(t[i],t[i+1],t[i+2])},n.FromFloatArray=function(t,i){return i||(i=0),new n(t[i],t[i+1],t[i+2])},n.FromArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2]},n.FromFloatArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2]},n.FromFloatsToRef=function(t,i,n,r){r.x=t,r.y=i,r.z=n},n.Zero=function(){return new n(0,0,0)},n.Up=function(){return new n(0,1,0)},n.Forward=function(){return new n(0,0,1)},n.Right=function(){return new n(1,0,0)},n.Left=function(){return new n((-1),0,0)},n.TransformCoordinates=function(t,i){var r=n.Zero();return n.TransformCoordinatesToRef(t,i,r),r},n.TransformCoordinatesToRef=function(t,i,n){var r=t.x*i.m[0]+t.y*i.m[4]+t.z*i.m[8]+i.m[12],o=t.x*i.m[1]+t.y*i.m[5]+t.z*i.m[9]+i.m[13],e=t.x*i.m[2]+t.y*i.m[6]+t.z*i.m[10]+i.m[14],s=t.x*i.m[3]+t.y*i.m[7]+t.z*i.m[11]+i.m[15];n.x=r/s,n.y=o/s,n.z=e/s},n.TransformCoordinatesFromFloatsToRef=function(t,i,n,r,o){var e=t*r.m[0]+i*r.m[4]+n*r.m[8]+r.m[12],s=t*r.m[1]+i*r.m[5]+n*r.m[9]+r.m[13],h=t*r.m[2]+i*r.m[6]+n*r.m[10]+r.m[14],a=t*r.m[3]+i*r.m[7]+n*r.m[11]+r.m[15];o.x=e/a,o.y=s/a,o.z=h/a},n.TransformNormal=function(t,i){var r=n.Zero();return n.TransformNormalToRef(t,i,r),r},n.TransformNormalToRef=function(t,i,n){var r=t.x*i.m[0]+t.y*i.m[4]+t.z*i.m[8],o=t.x*i.m[1]+t.y*i.m[5]+t.z*i.m[9],e=t.x*i.m[2]+t.y*i.m[6]+t.z*i.m[10];n.x=r,n.y=o,n.z=e},n.TransformNormalFromFloatsToRef=function(t,i,n,r,o){o.x=t*r.m[0]+i*r.m[4]+n*r.m[8],o.y=t*r.m[1]+i*r.m[5]+n*r.m[9],o.z=t*r.m[2]+i*r.m[6]+n*r.m[10]},n.CatmullRom=function(t,i,r,o,e){var s=e*e,h=e*s,a=.5*(2*i.x+(-t.x+r.x)*e+(2*t.x-5*i.x+4*r.x-o.x)*s+(-t.x+3*i.x-3*r.x+o.x)*h),u=.5*(2*i.y+(-t.y+r.y)*e+(2*t.y-5*i.y+4*r.y-o.y)*s+(-t.y+3*i.y-3*r.y+o.y)*h),m=.5*(2*i.z+(-t.z+r.z)*e+(2*t.z-5*i.z+4*r.z-o.z)*s+(-t.z+3*i.z-3*r.z+o.z)*h);return new n(a,u,m)},n.Clamp=function(t,i,r){var o=t.x;o=o>r.x?r.x:o,o=o<i.x?i.x:o;var e=t.y;e=e>r.y?r.y:e,e=e<i.y?i.y:e;var s=t.z;return s=s>r.z?r.z:s,s=s<i.z?i.z:s,new n(o,e,s)},n.Hermite=function(t,i,r,o,e){var s=e*e,h=e*s,a=2*h-3*s+1,u=-2*h+3*s,m=h-2*s+e,y=h-s,c=t.x*a+r.x*u+i.x*m+o.x*y,p=t.y*a+r.y*u+i.y*m+o.y*y,f=t.z*a+r.z*u+i.z*m+o.z*y;return new n(c,p,f)},n.Lerp=function(t,i,r){var o=t.x+(i.x-t.x)*r,e=t.y+(i.y-t.y)*r,s=t.z+(i.z-t.z)*r;return new n(o,e,s)},n.Dot=function(t,i){return t.x*i.x+t.y*i.y+t.z*i.z},n.Cross=function(t,i){var r=n.Zero();return n.CrossToRef(t,i,r),r},n.CrossToRef=function(t,i,n){M.Vector3[0].x=t.y*i.z-t.z*i.y,M.Vector3[0].y=t.z*i.x-t.x*i.z,M.Vector3[0].z=t.x*i.y-t.y*i.x,n.copyFrom(M.Vector3[0])},n.Normalize=function(t){var i=n.Zero();return n.NormalizeToRef(t,i),i},n.NormalizeToRef=function(t,i){i.copyFrom(t),i.normalize()},n.Project=function(t,i,r,o){var e=o.width,s=o.height,h=o.x,a=o.y,m=n._viewportMatrixCache?n._viewportMatrixCache:n._viewportMatrixCache=new u;u.FromValuesToRef(e/2,0,0,0,0,-s/2,0,0,0,0,1,0,h+e/2,s/2+a,0,1,m);var y=n._matrixCache?n._matrixCache:n._matrixCache=new u;return i.multiplyToRef(r,y),y.multiplyToRef(m,y),n.TransformCoordinates(t,y)},n.UnprojectFromTransform=function(t,r,o,e,s){var h=n._matrixCache?n._matrixCache:n._matrixCache=new u;e.multiplyToRef(s,h),h.invert(),t.x=t.x/r*2-1,t.y=-(t.y/o*2-1);var a=n.TransformCoordinates(t,h),m=t.x*h.m[3]+t.y*h.m[7]+t.z*h.m[11]+h.m[15];return i.WithinEpsilon(m,1)&&(a=a.scale(1/m)),a},n.Unproject=function(t,r,o,e,s,h){var a=n._matrixCache?n._matrixCache:n._matrixCache=new u;e.multiplyToRef(s,a),a.multiplyToRef(h,a),a.invert();var m=new n(t.x/r*2-1,(-(t.y/o*2-1)),t.z),y=n.TransformCoordinates(m,a),c=m.x*a.m[3]+m.y*a.m[7]+m.z*a.m[11]+a.m[15];return i.WithinEpsilon(c,1)&&(y=y.scale(1/c)),y},n.Minimize=function(t,i){var n=t.clone();return n.MinimizeInPlace(i),n},n.Maximize=function(t,i){var n=t.clone();return n.MaximizeInPlace(i),n},n.Distance=function(t,i){return Math.sqrt(n.DistanceSquared(t,i))},n.DistanceSquared=function(t,i){var n=t.x-i.x,r=t.y-i.y,o=t.z-i.z;return n*n+r*r+o*o},n.Center=function(t,i){var n=t.add(i);return n.scaleInPlace(.5),n},n.RotationFromAxis=function(t,i,r){var o=n.Zero();return n.RotationFromAxisToRef(t,i,r,o),o},n.RotationFromAxisToRef=function(r,o,e,s){var h=r.normalize(),a=e.normalize(),u=p.X,m=p.Y,y=0,c=0,f=0,x=0,l=0,z=0,w=0,v=-1,d=0,g=M.Vector3[0],R=0,T=M.Vector3[1];i.WithinEpsilon(a.z,0,t.Epsilon)?z=1:i.WithinEpsilon(a.x,0,t.Epsilon)?x=1:(w=a.z/a.x,x=-w*Math.sqrt(1/(1+w*w)),z=Math.sqrt(1/(1+w*w))),T.x=x,T.y=l,T.z=z,T.normalize(),n.CrossToRef(h,T,g),g.normalize(),n.Dot(a,g)<0&&(v=1),R=n.Dot(h,T),R=Math.min(1,Math.max(-1,R)),f=Math.acos(R)*v,n.Dot(T,u)<0&&(f=Math.PI+f,T=T.scaleInPlace(-1),d++);var _=M.Vector3[2],A=M.Vector3[3];x=0,l=0,z=0,v=-1,i.WithinEpsilon(a.z,0,t.Epsilon)?x=1:(w=T.z/T.x,x=-w*Math.sqrt(1/(1+w*w)),z=Math.sqrt(1/(1+w*w))),_.x=x,_.y=l,_.z=z,_.normalize(),n.CrossToRef(_,T,A),A.normalize(),n.CrossToRef(a,_,g),g.normalize(),n.Dot(T,g)<0&&(v=1),R=n.Dot(a,_),R=Math.min(1,Math.max(-1,R)),c=Math.acos(R)*v,n.Dot(A,m)<0&&(c=Math.PI+c,d++),v=-1,n.CrossToRef(u,T,g),g.normalize(),n.Dot(g,m)<0&&(v=1),R=n.Dot(T,u),R=Math.min(1,Math.max(-1,R)),y=-Math.acos(R)*v,R<0&&d<2&&(y=Math.PI+y),s.x=c,s.y=y,s.z=f},n}();t.Vector3=e;var s=function(){function n(t,i,n,r){this.x=t,this.y=i,this.z=n,this.w=r}return n.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},n.prototype.getClassName=function(){return"Vector4"},n.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},n.prototype.asArray=function(){var t=[];return this.toArray(t,0),t},n.prototype.toArray=function(t,i){return void 0===i&&(i=0),t[i]=this.x,t[i+1]=this.y,t[i+2]=this.z,t[i+3]=this.w,this},n.prototype.addInPlace=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},n.prototype.add=function(t){return new n(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},n.prototype.addToRef=function(t,i){return i.x=this.x+t.x,i.y=this.y+t.y,i.z=this.z+t.z,i.w=this.w+t.w,this},n.prototype.subtractInPlace=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},n.prototype.subtract=function(t){return new n(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},n.prototype.subtractToRef=function(t,i){return i.x=this.x-t.x,i.y=this.y-t.y,i.z=this.z-t.z,i.w=this.w-t.w,this},n.prototype.subtractFromFloats=function(t,i,r,o){return new n(this.x-t,this.y-i,this.z-r,this.w-o)},n.prototype.subtractFromFloatsToRef=function(t,i,n,r,o){return o.x=this.x-t,o.y=this.y-i,o.z=this.z-n,o.w=this.w-r,this},n.prototype.negate=function(){return new n((-this.x),(-this.y),(-this.z),(-this.w))},n.prototype.scaleInPlace=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},n.prototype.scale=function(t){return new n(this.x*t,this.y*t,this.z*t,this.w*t)},n.prototype.scaleToRef=function(t,i){i.x=this.x*t,i.y=this.y*t,i.z=this.z*t,i.w=this.w*t},n.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.prototype.equalsWithEpsilon=function(n,r){return void 0===r&&(r=t.Epsilon),n&&i.WithinEpsilon(this.x,n.x,r)&&i.WithinEpsilon(this.y,n.y,r)&&i.WithinEpsilon(this.z,n.z,r)&&i.WithinEpsilon(this.w,n.w,r)},n.prototype.equalsToFloats=function(t,i,n,r){return this.x===t&&this.y===i&&this.z===n&&this.w===r},n.prototype.multiplyInPlace=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},n.prototype.multiply=function(t){return new n(this.x*t.x,this.y*t.y,this.z*t.z,this.w*t.w)},n.prototype.multiplyToRef=function(t,i){return i.x=this.x*t.x,i.y=this.y*t.y,i.z=this.z*t.z,i.w=this.w*t.w,this},n.prototype.multiplyByFloats=function(t,i,r,o){return new n(this.x*t,this.y*i,this.z*r,this.w*o)},n.prototype.divide=function(t){return new n(this.x/t.x,this.y/t.y,this.z/t.z,this.w/t.w)},n.prototype.divideToRef=function(t,i){return i.x=this.x/t.x,i.y=this.y/t.y,i.z=this.z/t.z,i.w=this.w/t.w,this},n.prototype.MinimizeInPlace=function(t){return t.x<this.x&&(this.x=t.x),t.y<this.y&&(this.y=t.y),t.z<this.z&&(this.z=t.z),t.w<this.w&&(this.w=t.w),this},n.prototype.MaximizeInPlace=function(t){return t.x>this.x&&(this.x=t.x),t.y>this.y&&(this.y=t.y),t.z>this.z&&(this.z=t.z),t.w>this.w&&(this.w=t.w),this},n.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},n.prototype.normalize=function(){var t=this.length();if(0===t)return this;var i=1/t;return this.x*=i,this.y*=i,this.z*=i,this.w*=i,this},n.prototype.toVector3=function(){return new e(this.x,this.y,this.z)},n.prototype.clone=function(){return new n(this.x,this.y,this.z,this.w)},n.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},n.prototype.copyFromFloats=function(t,i,n,r){return this.x=t,this.y=i,this.z=n,this.w=r,this},n.FromArray=function(t,i){return i||(i=0),new n(t[i],t[i+1],t[i+2],t[i+3])},n.FromArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2],n.w=t[i+3]},n.FromFloatArrayToRef=function(t,i,n){n.x=t[i],n.y=t[i+1],n.z=t[i+2],n.w=t[i+3]},n.FromFloatsToRef=function(t,i,n,r,o){o.x=t,o.y=i,o.z=n,o.w=r},n.Zero=function(){return new n(0,0,0,0)},n.Normalize=function(t){var i=n.Zero();return n.NormalizeToRef(t,i),i},n.NormalizeToRef=function(t,i){i.copyFrom(t),i.normalize()},n.Minimize=function(t,i){var n=t.clone();return n.MinimizeInPlace(i),n},n.Maximize=function(t,i){var n=t.clone();return n.MaximizeInPlace(i),n},n.Distance=function(t,i){return Math.sqrt(n.DistanceSquared(t,i))},n.DistanceSquared=function(t,i){var n=t.x-i.x,r=t.y-i.y,o=t.z-i.z,e=t.w-i.w;return n*n+r*r+o*o+e*e},n.Center=function(t,i){var n=t.add(i);return n.scaleInPlace(.5),n},n}();t.Vector4=s;var h=function(){function t(t,i){this.width=t,this.height=i}return t.prototype.toString=function(){return"{W: "+this.width+", H: "+this.height+"}"},t.prototype.getClassName=function(){return"Size"},t.prototype.getHashCode=function(){var t=this.width||0;return t=397*t^(this.height||0)},t.prototype.copyFrom=function(t){this.width=t.width,this.height=t.height},t.prototype.copyFromFloats=function(t,i){this.width=t,this.height=i},t.prototype.multiplyByFloats=function(i,n){return new t(this.width*i,this.height*n)},t.prototype.clone=function(){return new t(this.width,this.height)},t.prototype.equals=function(t){return!!t&&(this.width===t.width&&this.height===t.height)},Object.defineProperty(t.prototype,"surface",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),t.Zero=function(){return new t(0,0)},t.prototype.add=function(i){var n=new t(this.width+i.width,this.height+i.height);return n},t.prototype.substract=function(i){var n=new t(this.width-i.width,this.height-i.height);return n},t.Lerp=function(i,n,r){var o=i.width+(n.width-i.width)*r,e=i.height+(n.height-i.height)*r;return new t(o,e)},t}();t.Size=h;var a=function(){function t(t,i,n,r){void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=1),this.x=t,this.y=i,this.z=n,this.w=r}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},t.prototype.getClassName=function(){return"Quaternion"},t.prototype.getHashCode=function(){var t=this.x||0;return t=397*t^(this.y||0),t=397*t^(this.z||0),t=397*t^(this.w||0)},t.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},t.prototype.equals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t.prototype.copyFromFloats=function(t,i,n,r){return this.x=t,this.y=i,this.z=n,this.w=r,this},t.prototype.add=function(i){return new t(this.x+i.x,this.y+i.y,this.z+i.z,this.w+i.w)},t.prototype.subtract=function(i){return new t(this.x-i.x,this.y-i.y,this.z-i.z,this.w-i.w)},t.prototype.scale=function(i){return new t(this.x*i,this.y*i,this.z*i,this.w*i)},t.prototype.multiply=function(i){var n=new t(0,0,0,1);return this.multiplyToRef(i,n),n},t.prototype.multiplyToRef=function(t,i){var n=this.x*t.w+this.y*t.z-this.z*t.y+this.w*t.x,r=-this.x*t.z+this.y*t.w+this.z*t.x+this.w*t.y,o=this.x*t.y-this.y*t.x+this.z*t.w+this.w*t.z,e=-this.x*t.x-this.y*t.y-this.z*t.z+this.w*t.w;return i.copyFromFloats(n,r,o,e),this},t.prototype.multiplyInPlace=function(t){return this.multiplyToRef(t,this),this},t.prototype.conjugateToRef=function(t){return t.copyFromFloats(-this.x,-this.y,-this.z,this.w),this},t.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},t.prototype.conjugate=function(){var i=new t((-this.x),(-this.y),(-this.z),this.w);return i},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.prototype.normalize=function(){var t=1/this.length();return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},t.prototype.toEulerAngles=function(t){void 0===t&&(t="YZX");var i=e.Zero();return this.toEulerAnglesToRef(i,t),i},t.prototype.toEulerAnglesToRef=function(t,i){void 0===i&&(i="YZX");var n=this.z,r=this.x,o=this.y,e=this.w,s=e*e,h=n*n,a=r*r,u=o*o,m=o*n-r*e,y=.4999999;return m<-y?(t.y=2*Math.atan2(o,e),t.x=Math.PI/2,t.z=0):m>y?(t.y=2*Math.atan2(o,e),t.x=-Math.PI/2,t.z=0):(t.z=Math.atan2(2*(r*o+n*e),-h-a+u+s),t.x=Math.asin(-2*(n*o-r*e)),t.y=Math.atan2(2*(n*r+o*e),h-a-u+s)),this},t.prototype.toRotationMatrix=function(t){var i=this.x*this.x,n=this.y*this.y,r=this.z*this.z,o=this.x*this.y,e=this.z*this.w,s=this.z*this.x,h=this.y*this.w,a=this.y*this.z,u=this.x*this.w;return t.m[0]=1-2*(n+r),t.m[1]=2*(o+e),t.m[2]=2*(s-h),t.m[3]=0,t.m[4]=2*(o-e),t.m[5]=1-2*(r+i),t.m[6]=2*(a+u),t.m[7]=0,t.m[8]=2*(s+h),t.m[9]=2*(a-u),t.m[10]=1-2*(n+i),t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t.m[15]=1,this},t.prototype.fromRotationMatrix=function(i){return t.FromRotationMatrixToRef(i,this),this},t.FromRotationMatrix=function(i){var n=new t;return t.FromRotationMatrixToRef(i,n),n},t.FromRotationMatrixToRef=function(t,i){var n,r=t.m,o=r[0],e=r[4],s=r[8],h=r[1],a=r[5],u=r[9],m=r[2],y=r[6],c=r[10],p=o+a+c;p>0?(n=.5/Math.sqrt(p+1),i.w=.25/n,i.x=(y-u)*n,i.y=(s-m)*n,i.z=(h-e)*n):o>a&&o>c?(n=2*Math.sqrt(1+o-a-c),i.w=(y-u)/n,i.x=.25*n,i.y=(e+h)/n,i.z=(s+m)/n):a>c?(n=2*Math.sqrt(1+a-o-c),i.w=(s-m)/n,i.x=(e+h)/n,i.y=.25*n,i.z=(u+y)/n):(n=2*Math.sqrt(1+c-o-a),i.w=(h-e)/n,i.x=(s+m)/n,i.y=(u+y)/n,i.z=.25*n)},t.Inverse=function(i){return new t((-i.x),(-i.y),(-i.z),i.w)},t.Identity=function(){return new t(0,0,0,1)},t.RotationAxis=function(i,n){return t.RotationAxisToRef(i,n,new t)},t.RotationAxisToRef=function(t,i,n){var r=Math.sin(i/2);return t.normalize(),n.w=Math.cos(i/2),n.x=t.x*r,n.y=t.y*r,n.z=t.z*r,n},t.FromArray=function(i,n){return n||(n=0),new t(i[n],i[n+1],i[n+2],i[n+3])},t.RotationYawPitchRoll=function(i,n,r){var o=new t;return t.RotationYawPitchRollToRef(i,n,r,o),o},t.RotationYawPitchRollToRef=function(t,i,n,r){var o=.5*n,e=.5*i,s=.5*t,h=Math.sin(o),a=Math.cos(o),u=Math.sin(e),m=Math.cos(e),y=Math.sin(s),c=Math.cos(s);r.x=c*u*a+y*m*h,r.y=y*m*a-c*u*h,r.z=c*m*h-y*u*a,r.w=c*m*a+y*u*h},t.RotationAlphaBetaGamma=function(i,n,r){var o=new t;return t.RotationAlphaBetaGammaToRef(i,n,r,o),o},t.RotationAlphaBetaGammaToRef=function(t,i,n,r){var o=.5*(n+t),e=.5*(n-t),s=.5*i;r.x=Math.cos(e)*Math.sin(s),r.y=Math.sin(e)*Math.sin(s),r.z=Math.sin(o)*Math.cos(s),r.w=Math.cos(o)*Math.cos(s)},t.Slerp=function(i,n,r){var o=t.Identity();return t.SlerpToRef(i,n,r,o),o},t.SlerpToRef=function(t,i,n,r){var o,e,s=n,h=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w,a=!1;if(h<0&&(a=!0,h=-h),h>.999999)e=1-s,o=a?-s:s;else{var u=Math.acos(h),m=1/Math.sin(u);e=Math.sin((1-s)*u)*m,o=a?-Math.sin(s*u)*m:Math.sin(s*u)*m}r.x=e*t.x+o*i.x,r.y=e*t.y+o*i.y,r.z=e*t.z+o*i.z,r.w=e*t.w+o*i.w},t}();t.Quaternion=a;var u=function(){function t(){this.m=new Float32Array(16)}return t.prototype.isIdentity=function(){return 1===this.m[0]&&1===this.m[5]&&1===this.m[10]&&1===this.m[15]&&(0===this.m[1]&&0===this.m[2]&&0===this.m[3]&&0===this.m[4]&&0===this.m[6]&&0===this.m[7]&&0===this.m[8]&&0===this.m[9]&&0===this.m[11]&&0===this.m[12]&&0===this.m[13]&&0===this.m[14])},t.prototype.determinant=function(){var t=this.m[10]*this.m[15]-this.m[11]*this.m[14],i=this.m[9]*this.m[15]-this.m[11]*this.m[13],n=this.m[9]*this.m[14]-this.m[10]*this.m[13],r=this.m[8]*this.m[15]-this.m[11]*this.m[12],o=this.m[8]*this.m[14]-this.m[10]*this.m[12],e=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*t-this.m[6]*i+this.m[7]*n)-this.m[1]*(this.m[4]*t-this.m[6]*r+this.m[7]*o)+this.m[2]*(this.m[4]*i-this.m[5]*r+this.m[7]*e)-this.m[3]*(this.m[4]*n-this.m[5]*o+this.m[6]*e)},t.prototype.toArray=function(){return this.m},t.prototype.asArray=function(){return this.toArray()},t.prototype.invert=function(){return this.invertToRef(this),this},t.prototype.reset=function(){for(var t=0;t<16;t++)this.m[t]=0;return this},t.prototype.add=function(i){var n=new t;return this.addToRef(i,n),n},t.prototype.addToRef=function(t,i){for(var n=0;n<16;n++)i.m[n]=this.m[n]+t.m[n];return this},t.prototype.addToSelf=function(t){for(var i=0;i<16;i++)this.m[i]+=t.m[i];return this},t.prototype.invertToRef=function(t){var i=this.m[0],n=this.m[1],r=this.m[2],o=this.m[3],e=this.m[4],s=this.m[5],h=this.m[6],a=this.m[7],u=this.m[8],m=this.m[9],y=this.m[10],c=this.m[11],p=this.m[12],f=this.m[13],x=this.m[14],l=this.m[15],z=y*l-c*x,w=m*l-c*f,v=m*x-y*f,d=u*l-c*p,g=u*x-y*p,R=u*f-m*p,T=s*z-h*w+a*v,_=-(e*z-h*d+a*g),M=e*w-s*d+a*R,A=-(e*v-s*g+h*R),b=1/(i*T+n*_+r*M+o*A),F=h*l-a*x,L=s*l-a*f,C=s*x-h*f,P=e*l-a*p,Z=e*x-h*p,S=e*f-s*p,I=h*c-a*y,H=s*c-a*m,q=s*y-h*m,D=e*c-a*u,V=e*y-h*u,N=e*m-s*u;return t.m[0]=T*b,t.m[4]=_*b,t.m[8]=M*b,t.m[12]=A*b,t.m[1]=-(n*z-r*w+o*v)*b,t.m[5]=(i*z-r*d+o*g)*b,t.m[9]=-(i*w-n*d+o*R)*b,t.m[13]=(i*v-n*g+r*R)*b,t.m[2]=(n*F-r*L+o*C)*b,t.m[6]=-(i*F-r*P+o*Z)*b,t.m[10]=(i*L-n*P+o*S)*b,t.m[14]=-(i*C-n*Z+r*S)*b,t.m[3]=-(n*I-r*H+o*q)*b,t.m[7]=(i*I-r*D+o*V)*b,t.m[11]=-(i*H-n*D+o*N)*b,t.m[15]=(i*q-n*V+r*N)*b,this},t.prototype.setTranslation=function(t){return this.m[12]=t.x,this.m[13]=t.y,this.m[14]=t.z,this},t.prototype.getTranslation=function(){return new e(this.m[12],this.m[13],this.m[14])},t.prototype.multiply=function(i){var n=new t;return this.multiplyToRef(i,n),n},t.prototype.copyFrom=function(t){for(var i=0;i<16;i++)this.m[i]=t.m[i];return this;\n},t.prototype.copyToArray=function(t,i){void 0===i&&(i=0);for(var n=0;n<16;n++)t[i+n]=this.m[n];return this},t.prototype.multiplyToRef=function(t,i){return this.multiplyToArray(t,i.m,0),this},t.prototype.multiplyToArray=function(t,i,n){var r=this.m[0],o=this.m[1],e=this.m[2],s=this.m[3],h=this.m[4],a=this.m[5],u=this.m[6],m=this.m[7],y=this.m[8],c=this.m[9],p=this.m[10],f=this.m[11],x=this.m[12],l=this.m[13],z=this.m[14],w=this.m[15],v=t.m[0],d=t.m[1],g=t.m[2],R=t.m[3],T=t.m[4],_=t.m[5],M=t.m[6],A=t.m[7],b=t.m[8],F=t.m[9],L=t.m[10],C=t.m[11],P=t.m[12],Z=t.m[13],S=t.m[14],I=t.m[15];return i[n]=r*v+o*T+e*b+s*P,i[n+1]=r*d+o*_+e*F+s*Z,i[n+2]=r*g+o*M+e*L+s*S,i[n+3]=r*R+o*A+e*C+s*I,i[n+4]=h*v+a*T+u*b+m*P,i[n+5]=h*d+a*_+u*F+m*Z,i[n+6]=h*g+a*M+u*L+m*S,i[n+7]=h*R+a*A+u*C+m*I,i[n+8]=y*v+c*T+p*b+f*P,i[n+9]=y*d+c*_+p*F+f*Z,i[n+10]=y*g+c*M+p*L+f*S,i[n+11]=y*R+c*A+p*C+f*I,i[n+12]=x*v+l*T+z*b+w*P,i[n+13]=x*d+l*_+z*F+w*Z,i[n+14]=x*g+l*M+z*L+w*S,i[n+15]=x*R+l*A+z*C+w*I,this},t.prototype.equals=function(t){return t&&this.m[0]===t.m[0]&&this.m[1]===t.m[1]&&this.m[2]===t.m[2]&&this.m[3]===t.m[3]&&this.m[4]===t.m[4]&&this.m[5]===t.m[5]&&this.m[6]===t.m[6]&&this.m[7]===t.m[7]&&this.m[8]===t.m[8]&&this.m[9]===t.m[9]&&this.m[10]===t.m[10]&&this.m[11]===t.m[11]&&this.m[12]===t.m[12]&&this.m[13]===t.m[13]&&this.m[14]===t.m[14]&&this.m[15]===t.m[15]},t.prototype.clone=function(){return t.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},t.prototype.getClassName=function(){return"Matrix"},t.prototype.getHashCode=function(){for(var t=this.m[0]||0,i=1;i<16;i++)t=397*t^(this.m[i]||0);return t},t.prototype.decompose=function(n,r,o){o.x=this.m[12],o.y=this.m[13],o.z=this.m[14];var e=i.Sign(this.m[0]*this.m[1]*this.m[2]*this.m[3])<0?-1:1,s=i.Sign(this.m[4]*this.m[5]*this.m[6]*this.m[7])<0?-1:1,h=i.Sign(this.m[8]*this.m[9]*this.m[10]*this.m[11])<0?-1:1;return n.x=e*Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]),n.y=s*Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]),n.z=h*Math.sqrt(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]),0===n.x||0===n.y||0===n.z?(r.x=0,r.y=0,r.z=0,r.w=1,!1):(t.FromValuesToRef(this.m[0]/n.x,this.m[1]/n.x,this.m[2]/n.x,0,this.m[4]/n.y,this.m[5]/n.y,this.m[6]/n.y,0,this.m[8]/n.z,this.m[9]/n.z,this.m[10]/n.z,0,0,0,0,1,M.Matrix[0]),a.FromRotationMatrixToRef(M.Matrix[0],r),!0)},t.prototype.getRotationMatrix=function(){var i=t.Identity();return this.getRotationMatrixToRef(i),i},t.prototype.getRotationMatrixToRef=function(i){var n=this.m,r=n[0]*n[1]*n[2]*n[3]<0?-1:1,o=n[4]*n[5]*n[6]*n[7]<0?-1:1,e=n[8]*n[9]*n[10]*n[11]<0?-1:1,s=r*Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),h=o*Math.sqrt(n[4]*n[4]+n[5]*n[5]+n[6]*n[6]),a=e*Math.sqrt(n[8]*n[8]+n[9]*n[9]+n[10]*n[10]);t.FromValuesToRef(n[0]/s,n[1]/s,n[2]/s,0,n[4]/h,n[5]/h,n[6]/h,0,n[8]/a,n[9]/a,n[10]/a,0,0,0,0,1,i)},t.FromArray=function(i,n){var r=new t;return n||(n=0),t.FromArrayToRef(i,n,r),r},t.FromArrayToRef=function(t,i,n){for(var r=0;r<16;r++)n.m[r]=t[r+i]},t.FromFloat32ArrayToRefScaled=function(t,i,n,r){for(var o=0;o<16;o++)r.m[o]=t[o+i]*n},t.FromValuesToRef=function(t,i,n,r,o,e,s,h,a,u,m,y,c,p,f,x,l){l.m[0]=t,l.m[1]=i,l.m[2]=n,l.m[3]=r,l.m[4]=o,l.m[5]=e,l.m[6]=s,l.m[7]=h,l.m[8]=a,l.m[9]=u,l.m[10]=m,l.m[11]=y,l.m[12]=c,l.m[13]=p,l.m[14]=f,l.m[15]=x},t.prototype.getRow=function(t){if(t<0||t>3)return null;var i=4*t;return new s(this.m[i+0],this.m[i+1],this.m[i+2],this.m[i+3])},t.prototype.setRow=function(t,i){if(t<0||t>3)return this;var n=4*t;return this.m[n+0]=i.x,this.m[n+1]=i.y,this.m[n+2]=i.z,this.m[n+3]=i.w,this},t.FromValues=function(i,n,r,o,e,s,h,a,u,m,y,c,p,f,x,l){var z=new t;return z.m[0]=i,z.m[1]=n,z.m[2]=r,z.m[3]=o,z.m[4]=e,z.m[5]=s,z.m[6]=h,z.m[7]=a,z.m[8]=u,z.m[9]=m,z.m[10]=y,z.m[11]=c,z.m[12]=p,z.m[13]=f,z.m[14]=x,z.m[15]=l,z},t.Compose=function(i,n,r){var o=t.FromValues(i.x,0,0,0,0,i.y,0,0,0,0,i.z,0,0,0,0,1),e=t.Identity();return n.toRotationMatrix(e),o=o.multiply(e),o.setTranslation(r),o},t.Identity=function(){return t.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},t.IdentityToRef=function(i){t.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,i)},t.Zero=function(){return t.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},t.RotationX=function(i){var n=new t;return t.RotationXToRef(i,n),n},t.Invert=function(i){var n=new t;return i.invertToRef(n),n},t.RotationXToRef=function(t,i){var n=Math.sin(t),r=Math.cos(t);i.m[0]=1,i.m[15]=1,i.m[5]=r,i.m[10]=r,i.m[9]=-n,i.m[6]=n,i.m[1]=0,i.m[2]=0,i.m[3]=0,i.m[4]=0,i.m[7]=0,i.m[8]=0,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0},t.RotationY=function(i){var n=new t;return t.RotationYToRef(i,n),n},t.RotationYToRef=function(t,i){var n=Math.sin(t),r=Math.cos(t);i.m[5]=1,i.m[15]=1,i.m[0]=r,i.m[2]=-n,i.m[8]=n,i.m[10]=r,i.m[1]=0,i.m[3]=0,i.m[4]=0,i.m[6]=0,i.m[7]=0,i.m[9]=0,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0},t.RotationZ=function(i){var n=new t;return t.RotationZToRef(i,n),n},t.RotationZToRef=function(t,i){var n=Math.sin(t),r=Math.cos(t);i.m[10]=1,i.m[15]=1,i.m[0]=r,i.m[1]=n,i.m[4]=-n,i.m[5]=r,i.m[2]=0,i.m[3]=0,i.m[6]=0,i.m[7]=0,i.m[8]=0,i.m[9]=0,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0},t.RotationAxis=function(i,n){var r=t.Zero();return t.RotationAxisToRef(i,n,r),r},t.RotationAxisToRef=function(t,i,n){var r=Math.sin(-i),o=Math.cos(-i),e=1-o;t.normalize(),n.m[0]=t.x*t.x*e+o,n.m[1]=t.x*t.y*e-t.z*r,n.m[2]=t.x*t.z*e+t.y*r,n.m[3]=0,n.m[4]=t.y*t.x*e+t.z*r,n.m[5]=t.y*t.y*e+o,n.m[6]=t.y*t.z*e-t.x*r,n.m[7]=0,n.m[8]=t.z*t.x*e-t.y*r,n.m[9]=t.z*t.y*e+t.x*r,n.m[10]=t.z*t.z*e+o,n.m[11]=0,n.m[15]=1},t.RotationYawPitchRoll=function(i,n,r){var o=new t;return t.RotationYawPitchRollToRef(i,n,r,o),o},t.RotationYawPitchRollToRef=function(t,i,n,r){a.RotationYawPitchRollToRef(t,i,n,this._tempQuaternion),this._tempQuaternion.toRotationMatrix(r)},t.Scaling=function(i,n,r){var o=t.Zero();return t.ScalingToRef(i,n,r,o),o},t.ScalingToRef=function(t,i,n,r){r.m[0]=t,r.m[1]=0,r.m[2]=0,r.m[3]=0,r.m[4]=0,r.m[5]=i,r.m[6]=0,r.m[7]=0,r.m[8]=0,r.m[9]=0,r.m[10]=n,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},t.Translation=function(i,n,r){var o=t.Identity();return t.TranslationToRef(i,n,r,o),o},t.TranslationToRef=function(i,n,r,o){t.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,i,n,r,1,o)},t.Lerp=function(i,n,r){for(var o=t.Zero(),e=0;e<16;e++)o.m[e]=i.m[e]*(1-r)+n.m[e]*r;return o},t.DecomposeLerp=function(i,n,r){var o=new e(0,0,0),s=new a,h=new e(0,0,0);i.decompose(o,s,h);var u=new e(0,0,0),m=new a,y=new e(0,0,0);n.decompose(u,m,y);var c=e.Lerp(o,u,r),p=a.Slerp(s,m,r),f=e.Lerp(h,y,r);return t.Compose(c,p,f)},t.LookAtLH=function(i,n,r){var o=t.Zero();return t.LookAtLHToRef(i,n,r,o),o},t.LookAtLHToRef=function(i,n,r,o){n.subtractToRef(i,this._zAxis),this._zAxis.normalize(),e.CrossToRef(r,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),e.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var s=-e.Dot(this._xAxis,i),h=-e.Dot(this._yAxis,i),a=-e.Dot(this._zAxis,i);return t.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,s,h,a,1,o)},t.LookAtRH=function(i,n,r){var o=t.Zero();return t.LookAtRHToRef(i,n,r,o),o},t.LookAtRHToRef=function(i,n,r,o){i.subtractToRef(n,this._zAxis),this._zAxis.normalize(),e.CrossToRef(r,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),e.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var s=-e.Dot(this._xAxis,i),h=-e.Dot(this._yAxis,i),a=-e.Dot(this._zAxis,i);return t.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,s,h,a,1,o)},t.OrthoLH=function(i,n,r,o){var e=t.Zero();return t.OrthoLHToRef(i,n,r,o,e),e},t.OrthoLHToRef=function(i,n,r,o,e){var s=2/i,h=2/n,a=1/(o-r),u=r/(r-o);t.FromValuesToRef(s,0,0,0,0,h,0,0,0,0,a,0,0,0,u,1,e)},t.OrthoOffCenterLH=function(i,n,r,o,e,s){var h=t.Zero();return t.OrthoOffCenterLHToRef(i,n,r,o,e,s,h),h},t.OrthoOffCenterLHToRef=function(t,i,n,r,o,e,s){s.m[0]=2/(i-t),s.m[1]=s.m[2]=s.m[3]=0,s.m[5]=2/(r-n),s.m[4]=s.m[6]=s.m[7]=0,s.m[10]=1/(e-o),s.m[8]=s.m[9]=s.m[11]=0,s.m[12]=(t+i)/(t-i),s.m[13]=(r+n)/(n-r),s.m[14]=-o/(e-o),s.m[15]=1},t.OrthoOffCenterRH=function(i,n,r,o,e,s){var h=t.Zero();return t.OrthoOffCenterRHToRef(i,n,r,o,e,s,h),h},t.OrthoOffCenterRHToRef=function(i,n,r,o,e,s,h){t.OrthoOffCenterLHToRef(i,n,r,o,e,s,h),h.m[10]*=-1},t.PerspectiveLH=function(i,n,r,o){var e=t.Zero();return e.m[0]=2*r/i,e.m[1]=e.m[2]=e.m[3]=0,e.m[5]=2*r/n,e.m[4]=e.m[6]=e.m[7]=0,e.m[10]=-o/(r-o),e.m[8]=e.m[9]=0,e.m[11]=1,e.m[12]=e.m[13]=e.m[15]=0,e.m[14]=r*o/(r-o),e},t.PerspectiveFovLH=function(i,n,r,o){var e=t.Zero();return t.PerspectiveFovLHToRef(i,n,r,o,e),e},t.PerspectiveFovLHToRef=function(t,i,n,r,o,e){void 0===e&&(e=!0);var s=1/Math.tan(.5*t);e?o.m[0]=s/i:o.m[0]=s,o.m[1]=o.m[2]=o.m[3]=0,e?o.m[5]=s:o.m[5]=s*i,o.m[4]=o.m[6]=o.m[7]=0,o.m[8]=o.m[9]=0,o.m[10]=r/(r-n),o.m[11]=1,o.m[12]=o.m[13]=o.m[15]=0,o.m[14]=-(n*r)/(r-n)},t.PerspectiveFovRH=function(i,n,r,o){var e=t.Zero();return t.PerspectiveFovRHToRef(i,n,r,o,e),e},t.PerspectiveFovRHToRef=function(t,i,n,r,o,e){void 0===e&&(e=!0);var s=1/Math.tan(.5*t);e?o.m[0]=s/i:o.m[0]=s,o.m[1]=o.m[2]=o.m[3]=0,e?o.m[5]=s:o.m[5]=s*i,o.m[4]=o.m[6]=o.m[7]=0,o.m[8]=o.m[9]=0,o.m[10]=r/(n-r),o.m[11]=-1,o.m[12]=o.m[13]=o.m[15]=0,o.m[14]=n*r/(n-r)},t.PerspectiveFovWebVRToRef=function(t,i,n,r,o){void 0===o&&(o=!0);var e=Math.tan(t.upDegrees*Math.PI/180),s=Math.tan(t.downDegrees*Math.PI/180),h=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),u=2/(h+a),m=2/(e+s);r.m[0]=u,r.m[1]=r.m[2]=r.m[3]=r.m[4]=0,r.m[5]=m,r.m[6]=r.m[7]=0,r.m[8]=(h-a)*u*.5,r.m[9]=-((e-s)*m*.5),r.m[10]=-n/(i-n),r.m[11]=1,r.m[12]=r.m[13]=r.m[15]=0,r.m[14]=i*n/(i-n)},t.GetFinalMatrix=function(i,n,r,o,e,s){var h=i.width,a=i.height,u=i.x,m=i.y,y=t.FromValues(h/2,0,0,0,0,-a/2,0,0,0,0,s-e,0,u+h/2,a/2+m,e,1);return n.multiply(r).multiply(o).multiply(y)},t.GetAsMatrix2x2=function(t){return new Float32Array([t.m[0],t.m[1],t.m[4],t.m[5]])},t.GetAsMatrix3x3=function(t){return new Float32Array([t.m[0],t.m[1],t.m[2],t.m[4],t.m[5],t.m[6],t.m[8],t.m[9],t.m[10]])},t.Transpose=function(i){var n=new t;return n.m[0]=i.m[0],n.m[1]=i.m[4],n.m[2]=i.m[8],n.m[3]=i.m[12],n.m[4]=i.m[1],n.m[5]=i.m[5],n.m[6]=i.m[9],n.m[7]=i.m[13],n.m[8]=i.m[2],n.m[9]=i.m[6],n.m[10]=i.m[10],n.m[11]=i.m[14],n.m[12]=i.m[3],n.m[13]=i.m[7],n.m[14]=i.m[11],n.m[15]=i.m[15],n},t.Reflection=function(i){var n=new t;return t.ReflectionToRef(i,n),n},t.ReflectionToRef=function(t,i){t.normalize();var n=t.normal.x,r=t.normal.y,o=t.normal.z,e=-2*n,s=-2*r,h=-2*o;i.m[0]=e*n+1,i.m[1]=s*n,i.m[2]=h*n,i.m[3]=0,i.m[4]=e*r,i.m[5]=s*r+1,i.m[6]=h*r,i.m[7]=0,i.m[8]=e*o,i.m[9]=s*o,i.m[10]=h*o+1,i.m[11]=0,i.m[12]=e*t.d,i.m[13]=s*t.d,i.m[14]=h*t.d,i.m[15]=1},t.FromXYZAxesToRef=function(t,i,n,r){r.m[0]=t.x,r.m[1]=t.y,r.m[2]=t.z,r.m[3]=0,r.m[4]=i.x,r.m[5]=i.y,r.m[6]=i.z,r.m[7]=0,r.m[8]=n.x,r.m[9]=n.y,r.m[10]=n.z,r.m[11]=0,r.m[12]=0,r.m[13]=0,r.m[14]=0,r.m[15]=1},t.FromQuaternionToRef=function(t,i){var n=t.x*t.x,r=t.y*t.y,o=t.z*t.z,e=t.x*t.y,s=t.z*t.w,h=t.z*t.x,a=t.y*t.w,u=t.y*t.z,m=t.x*t.w;i.m[0]=1-2*(r+o),i.m[1]=2*(e+s),i.m[2]=2*(h-a),i.m[3]=0,i.m[4]=2*(e-s),i.m[5]=1-2*(o+n),i.m[6]=2*(u+m),i.m[7]=0,i.m[8]=2*(h+a),i.m[9]=2*(u-m),i.m[10]=1-2*(r+n),i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0,i.m[15]=1},t._tempQuaternion=new a,t._xAxis=e.Zero(),t._yAxis=e.Zero(),t._zAxis=e.Zero(),t}();t.Matrix=u;var m=function(){function t(t,i,n,r){this.normal=new e(t,i,n),this.d=r}return t.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},t.prototype.clone=function(){return new t(this.normal.x,this.normal.y,this.normal.z,this.d)},t.prototype.getClassName=function(){return"Plane"},t.prototype.getHashCode=function(){var t=this.normal.getHashCode();return t=397*t^(this.d||0)},t.prototype.normalize=function(){var t=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),i=0;return 0!==t&&(i=1/t),this.normal.x*=i,this.normal.y*=i,this.normal.z*=i,this.d*=i,this},t.prototype.transform=function(i){var n=u.Transpose(i),r=this.normal.x,o=this.normal.y,e=this.normal.z,s=this.d,h=r*n.m[0]+o*n.m[1]+e*n.m[2]+s*n.m[3],a=r*n.m[4]+o*n.m[5]+e*n.m[6]+s*n.m[7],m=r*n.m[8]+o*n.m[9]+e*n.m[10]+s*n.m[11],y=r*n.m[12]+o*n.m[13]+e*n.m[14]+s*n.m[15];return new t(h,a,m,y)},t.prototype.dotCoordinate=function(t){return this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z+this.d},t.prototype.copyFromPoints=function(t,i,n){var r,o=i.x-t.x,e=i.y-t.y,s=i.z-t.z,h=n.x-t.x,a=n.y-t.y,u=n.z-t.z,m=e*u-s*a,y=s*h-o*u,c=o*a-e*h,p=Math.sqrt(m*m+y*y+c*c);return r=0!==p?1/p:0,this.normal.x=m*r,this.normal.y=y*r,this.normal.z=c*r,this.d=-(this.normal.x*t.x+this.normal.y*t.y+this.normal.z*t.z),this},t.prototype.isFrontFacingTo=function(t,i){var n=e.Dot(this.normal,t);return n<=i},t.prototype.signedDistanceTo=function(t){return e.Dot(t,this.normal)+this.d},t.FromArray=function(i){return new t(i[0],i[1],i[2],i[3])},t.FromPoints=function(i,n,r){var o=new t(0,0,0,0);return o.copyFromPoints(i,n,r),o},t.FromPositionAndNormal=function(i,n){var r=new t(0,0,0,0);return n.normalize(),r.normal=n,r.d=-(n.x*i.x+n.y*i.y+n.z*i.z),r},t.SignedDistanceToPlaneFromPositionAndNormal=function(t,i,n){var r=-(i.x*t.x+i.y*t.y+i.z*t.z);return e.Dot(n,i)+r},t}();t.Plane=m;var y=function(){function t(t,i,n,r){this.x=t,this.y=i,this.width=n,this.height=r}return t.prototype.toGlobal=function(i,n){return new t(this.x*i,this.y*n,this.width*i,this.height*n)},t}();t.Viewport=y;var c=function(){function t(){}return t.GetPlanes=function(i){for(var n=[],r=0;r<6;r++)n.push(new m(0,0,0,0));return t.GetPlanesToRef(i,n),n},t.GetPlanesToRef=function(t,i){i[0].normal.x=t.m[3]+t.m[2],i[0].normal.y=t.m[7]+t.m[6],i[0].normal.z=t.m[11]+t.m[10],i[0].d=t.m[15]+t.m[14],i[0].normalize(),i[1].normal.x=t.m[3]-t.m[2],i[1].normal.y=t.m[7]-t.m[6],i[1].normal.z=t.m[11]-t.m[10],i[1].d=t.m[15]-t.m[14],i[1].normalize(),i[2].normal.x=t.m[3]+t.m[0],i[2].normal.y=t.m[7]+t.m[4],i[2].normal.z=t.m[11]+t.m[8],i[2].d=t.m[15]+t.m[12],i[2].normalize(),i[3].normal.x=t.m[3]-t.m[0],i[3].normal.y=t.m[7]-t.m[4],i[3].normal.z=t.m[11]-t.m[8],i[3].d=t.m[15]-t.m[12],i[3].normalize(),i[4].normal.x=t.m[3]-t.m[1],i[4].normal.y=t.m[7]-t.m[5],i[4].normal.z=t.m[11]-t.m[9],i[4].d=t.m[15]-t.m[13],i[4].normalize(),i[5].normal.x=t.m[3]+t.m[1],i[5].normal.y=t.m[7]+t.m[5],i[5].normal.z=t.m[11]+t.m[9],i[5].d=t.m[15]+t.m[13],i[5].normalize()},t}();t.Frustum=c,function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(t.Space||(t.Space={}));var p=(t.Space,function(){function t(){}return t.X=new e(1,0,0),t.Y=new e(0,1,0),t.Z=new e(0,0,1),t}());t.Axis=p;var f=function(){function t(){}return t.interpolate=function(t,i,n,r,o){for(var e=1-3*r+3*i,s=3*r-6*i,h=3*i,a=t,u=0;u<5;u++){var m=a*a,y=m*a,c=e*y+s*m+h*a,p=1/(3*e*m+2*s*a+h);a-=(c-t)*p,a=Math.min(1,Math.max(0,a))}return 3*Math.pow(1-a,2)*a*n+3*(1-a)*Math.pow(a,2)*o+Math.pow(a,3)},t}();t.BezierCurve=f,function(t){t[t.CW=0]="CW",t[t.CCW=1]="CCW"}(t.Orientation||(t.Orientation={}));var x=t.Orientation,l=function(){function t(t){var i=this;this.degrees=function(){return 180*i._radians/Math.PI},this.radians=function(){return i._radians},this._radians=t,this._radians<0&&(this._radians+=2*Math.PI)}return t.BetweenTwoPoints=function(i,n){var r=n.subtract(i),o=Math.atan2(r.y,r.x);return new t(o)},t.FromRadians=function(i){return new t(i)},t.FromDegrees=function(i){return new t(i*Math.PI/180)},t}();t.Angle=l;var z=function(){function t(t,i,n){this.startPoint=t,this.midPoint=i,this.endPoint=n;var r=Math.pow(i.x,2)+Math.pow(i.y,2),e=(Math.pow(t.x,2)+Math.pow(t.y,2)-r)/2,s=(r-Math.pow(n.x,2)-Math.pow(n.y,2))/2,h=(t.x-i.x)*(i.y-n.y)-(i.x-n.x)*(t.y-i.y);this.centerPoint=new o((e*(i.y-n.y)-s*(t.y-i.y))/h,((t.x-i.x)*s-(i.x-n.x)*e)/h),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=l.BetweenTwoPoints(this.centerPoint,this.startPoint);var a=this.startAngle.degrees(),u=l.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),m=l.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();u-a>180&&(u-=360),u-a<-180&&(u+=360),m-u>180&&(m-=360),m-u<-180&&(m+=360),this.orientation=u-a<0?x.CW:x.CCW,this.angle=l.FromDegrees(this.orientation===x.CW?a-m:m-a)}return t}();t.Arc2=z;var w=function(){function t(t,i){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new o(t,i))}return t.prototype.addLineTo=function(t,i){if(closed)return this;var n=new o(t,i),r=this._points[this._points.length-1];return this._points.push(n),this._length+=n.subtract(r).length(),this},t.prototype.addArcTo=function(t,i,n,r,e){if(void 0===e&&(e=36),closed)return this;var s=this._points[this._points.length-1],h=new o(t,i),a=new o(n,r),u=new z(s,h,a),m=u.angle.radians()/e;u.orientation===x.CW&&(m*=-1);for(var y=u.startAngle.radians()+m,c=0;c<e;c++){var p=Math.cos(y)*u.radius+u.centerPoint.x,f=Math.sin(y)*u.radius+u.centerPoint.y;this.addLineTo(p,f),y+=m}return this},t.prototype.close=function(){return this.closed=!0,this},t.prototype.length=function(){var t=this._length;if(!this.closed){var i=this._points[this._points.length-1],n=this._points[0];t+=n.subtract(i).length()}return t},t.prototype.getPoints=function(){return this._points},t.prototype.getPointAtLengthPosition=function(t){if(t<0||t>1)return o.Zero();for(var i=t*this.length(),n=0,r=0;r<this._points.length;r++){var e=(r+1)%this._points.length,s=this._points[r],h=this._points[e],a=h.subtract(s),u=a.length()+n;if(i>=n&&i<=u){var m=a.normalize(),y=i-n;return new o(s.x+m.x*y,s.y+m.y*y)}n=u}return o.Zero()},t.StartingAt=function(i,n){return new t(i,n)},t}();t.Path2=w;var v=function(){function n(t,i,n){this.path=t,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array;for(var r=0;r<t.length;r++)this._curve[r]=t[r].clone();this._raw=n||!1,this._compute(i)}return n.prototype.getCurve=function(){return this._curve},n.prototype.getTangents=function(){return this._tangents},n.prototype.getNormals=function(){return this._normals},n.prototype.getBinormals=function(){return this._binormals},n.prototype.getDistances=function(){return this._distances},n.prototype.update=function(t,i){for(var n=0;n<t.length;n++)this._curve[n].x=t[n].x,this._curve[n].y=t[n].y,this._curve[n].z=t[n].z;return this._compute(i),this},n.prototype._compute=function(t){var i=this._curve.length;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();var n=this._tangents[0],r=this._normalVector(this._curve[0],n,t);this._normals[0]=r,this._raw||this._normals[0].normalize(),this._binormals[0]=e.Cross(n,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(var o,s,h,a,u=1;u<i;u++)o=this._getLastNonNullVector(u),u<i-1&&(s=this._getFirstNonNullVector(u),this._tangents[u]=o.add(s),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+o.length(),h=this._tangents[u],a=this._binormals[u-1],this._normals[u]=e.Cross(a,h),this._raw||this._normals[u].normalize(),this._binormals[u]=e.Cross(h,this._normals[u]),this._raw||this._binormals[u].normalize()},n.prototype._getFirstNonNullVector=function(t){for(var i=1,n=this._curve[t+i].subtract(this._curve[t]);0===n.length()&&t+i+1<this._curve.length;)i++,n=this._curve[t+i].subtract(this._curve[t]);return n},n.prototype._getLastNonNullVector=function(t){for(var i=1,n=this._curve[t].subtract(this._curve[t-i]);0===n.length()&&t>i+1;)i++,n=this._curve[t].subtract(this._curve[t-i]);return n},n.prototype._normalVector=function(n,r,o){var s,h=r.length();if(0===h&&(h=1),void 0===o||null===o){var a;i.WithinEpsilon(Math.abs(r.y)/h,1,t.Epsilon)?i.WithinEpsilon(Math.abs(r.x)/h,1,t.Epsilon)?i.WithinEpsilon(Math.abs(r.z)/h,1,t.Epsilon)||(a=new e(0,0,1)):a=new e(1,0,0):a=new e(0,(-1),0),s=e.Cross(r,a)}else s=e.Cross(r,o),e.CrossToRef(s,r,s);return s.normalize(),s},n}();t.Path3D=v;var d=function(){function t(t){this._length=0,this._points=t,this._length=this._computeLength(t)}return t.CreateQuadraticBezier=function(i,n,r,o){o=o>2?o:3;for(var s=new Array,h=function(t,i,n,r){var o=(1-t)*(1-t)*i+2*t*(1-t)*n+t*t*r;return o},a=0;a<=o;a++)s.push(new e(h(a/o,i.x,n.x,r.x),h(a/o,i.y,n.y,r.y),h(a/o,i.z,n.z,r.z)));return new t(s)},t.CreateCubicBezier=function(i,n,r,o,s){s=s>3?s:4;for(var h=new Array,a=function(t,i,n,r,o){var e=(1-t)*(1-t)*(1-t)*i+3*t*(1-t)*(1-t)*n+3*t*t*(1-t)*r+t*t*t*o;return e},u=0;u<=s;u++)h.push(new e(a(u/s,i.x,n.x,r.x,o.x),a(u/s,i.y,n.y,r.y,o.y),a(u/s,i.z,n.z,r.z,o.z)));return new t(h)},t.CreateHermiteSpline=function(i,n,r,o,s){for(var h=new Array,a=1/s,u=0;u<=s;u++)h.push(e.Hermite(i,n,r,o,u*a));return new t(h)},t.prototype.getPoints=function(){return this._points},t.prototype.length=function(){return this._length},t.prototype["continue"]=function(i){for(var n=this._points[this._points.length-1],r=this._points.slice(),o=i.getPoints(),e=1;e<o.length;e++)r.push(o[e].subtract(o[0]).add(n));var s=new t(r);return s},t.prototype._computeLength=function(t){for(var i=0,n=1;n<t.length;n++)i+=t[n].subtract(t[n-1]).length();return i},t}();t.Curve3=d;var g=function(){function t(){this.L00=e.Zero(),this.L1_1=e.Zero(),this.L10=e.Zero(),this.L11=e.Zero(),this.L2_2=e.Zero(),this.L2_1=e.Zero(),this.L20=e.Zero(),this.L21=e.Zero(),this.L22=e.Zero()}return t.prototype.addLight=function(t,i,n){var r=new e(i.r,i.g,i.b),o=r.scale(n);this.L00=this.L00.add(o.scale(.282095)),this.L1_1=this.L1_1.add(o.scale(.488603*t.y)),this.L10=this.L10.add(o.scale(.488603*t.z)),this.L11=this.L11.add(o.scale(.488603*t.x)),this.L2_2=this.L2_2.add(o.scale(1.092548*t.x*t.y)),this.L2_1=this.L2_1.add(o.scale(1.092548*t.y*t.z)),this.L21=this.L21.add(o.scale(1.092548*t.x*t.z)),this.L20=this.L20.add(o.scale(.315392*(3*t.z*t.z-1))),this.L22=this.L22.add(o.scale(.546274*(t.x*t.x-t.y*t.y)))},t.prototype.scale=function(t){this.L00=this.L00.scale(t),this.L1_1=this.L1_1.scale(t),this.L10=this.L10.scale(t),this.L11=this.L11.scale(t),this.L2_2=this.L2_2.scale(t),this.L2_1=this.L2_1.scale(t),this.L20=this.L20.scale(t),this.L21=this.L21.scale(t),this.L22=this.L22.scale(t)},t}();t.SphericalHarmonics=g;var R=function(){function t(){this.x=e.Zero(),this.y=e.Zero(),this.z=e.Zero(),this.xx=e.Zero(),this.yy=e.Zero(),this.zz=e.Zero(),this.xy=e.Zero(),this.yz=e.Zero(),this.zx=e.Zero()}return t.prototype.addAmbient=function(t){var i=new e(t.r,t.g,t.b);this.xx=this.xx.add(i),this.yy=this.yy.add(i),this.zz=this.zz.add(i)},t.getSphericalPolynomialFromHarmonics=function(i){var n=new t;return n.x=i.L11.scale(1.02333),n.y=i.L1_1.scale(1.02333),n.z=i.L10.scale(1.02333),n.xx=i.L00.scale(.886277).subtract(i.L20.scale(.247708)).add(i.L22.scale(.429043)),n.yy=i.L00.scale(.886277).subtract(i.L20.scale(.247708)).subtract(i.L22.scale(.429043)),n.zz=i.L00.scale(.886277).add(i.L20.scale(.495417)),n.yz=i.L2_1.scale(.858086),n.zx=i.L21.scale(.858086),n.xy=i.L2_2.scale(.858086),n},t}();t.SphericalPolynomial=R;var T=function(){function t(t,i){void 0===t&&(t=e.Zero()),void 0===i&&(i=e.Up()),this.position=t,this.normal=i}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone())},t}();t.PositionNormalVertex=T;var _=function(){function t(t,i,n){void 0===t&&(t=e.Zero()),void 0===i&&(i=e.Up()),void 0===n&&(n=o.Zero()),this.position=t,this.normal=i,this.uv=n}return t.prototype.clone=function(){return new t(this.position.clone(),this.normal.clone(),this.uv.clone())},t}();t.PositionNormalTextureVertex=_;var M=function(){function t(){}return t.Color3=[n.Black(),n.Black(),n.Black()],t.Vector2=[o.Zero(),o.Zero(),o.Zero()],t.Vector3=[e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero(),e.Zero()],t.Vector4=[s.Zero(),s.Zero(),s.Zero()],t.Quaternion=[new a(0,0,0,0)],t.Matrix=[u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero(),u.Zero()],t}();t.Tmp=M}(BABYLON||(BABYLON={}));';("undefined"!=typeof window&&window.module||"undefined"!=typeof t)&&"undefined"!=typeof t.exports&&(t.exports=i)},{}],8:[function(t,i,r){(function(t){(function(){function h(n,t,i){switch(i.length){case 0:return n.call(t);case 1:return n.call(t,i[0]);case 2:return n.call(t,i[0],i[1]);case 3:return n.call(t,i[0],i[1],i[2])}return n.apply(t,i)}function dh(n,t,i,r){for(var f=-1,e=n==null?0:n.length,u;++f<e;)u=n[f],t(r,u,i(u),n);return r}function y(n,t){for(var i=-1,r=n==null?0:n.length;++i<r;)if(t(n[i],i,n)===!1)break;return n}function gh(n,t){for(var i=n==null?0:n.length;i--;)if(t(n[i],i,n)===!1)break;return n}function oe(n,t){for(var i=-1,r=n==null?0:n.length;++i<r;)if(!t(n[i],i,n))return!1;return!0}function ft(n,t){for(var i=-1,f=n==null?0:n.length,e=0,u=[],r;++i<f;)r=n[i],t(r,i,n)&&(u[e++]=r);return u}function di(n,t){var i=n==null?0:n.length;return!!i&&bt(n,t,0)>-1}function nu(n,t,i){for(var r=-1,u=n==null?0:n.length;++r<u;)if(i(t,n[r]))return!0;return!1}function o(n,t){for(var i=-1,r=n==null?0:n.length,u=Array(r);++i<r;)u[i]=t(n[i],i,n);return u}function et(n,t){for(var i=-1,r=t.length,u=n.length;++i<r;)n[u+i]=t[i];return n}function tu(n,t,i,r){var u=-1,f=n==null?0:n.length;for(r&&f&&(i=n[++u]);++u<f;)i=t(i,n[u],u,n);return i}function nc(n,t,i,r){var u=n==null?0:n.length;for(r&&u&&(i=n[--u]);u--;)i=t(i,n[u],u,n);return i}function iu(n,t){for(var i=-1,r=n==null?0:n.length;++i<r;)if(t(n[i],i,n))return!0;return!1}function tc(n){return n.split("")}function ic(n){return n.match(as)||[]}function he(n,t,i){var r;return i(n,function(n,i,u){if(t(n,i,u))return r=i,!1}),r}function gi(n,t,i,r){for(var f=n.length,u=i+(r?1:-1);r?u--:++u<f;)if(t(n[u],u,n))return u;return-1}function bt(n,t,i){return t===t?ac(n,t,i):gi(n,ce,i)}function rc(n,t,i,r){for(var u=i-1,f=n.length;++u<f;)if(r(n[u],t))return u;return-1}function ce(n){return n!==n}function le(n,t){var i=n==null?0:n.length;return i?fu(n,t)/i:ci}function ru(n){return function(t){return t==null?u:t[n]}}function uu(n){return function(t){return n==null?u:n[t]}}function ae(n,t,i,r,u){return u(n,function(n,u,f){i=r?(r=!1,n):t(i,n,u,f)}),i}function uc(n,t){var i=n.length;for(n.sort(t);i--;)n[i]=n[i].value;return n}function fu(n,t){for(var i,f=-1,e=n.length,r;++f<e;)r=t(n[f]),r!==u&&(i=i===u?r:i+r);return i}function eu(n,t){for(var i=-1,r=Array(n);++i<n;)r[i]=t(i);return r}function fc(n,t){return o(t,function(t){return[t,n[t]]})}function c(n){return function(t){return n(t)}}function ou(n,t){return o(t,function(t){return n[t]})}function oi(n,t){return n.has(t)}function ve(n,t){for(var i=-1,r=n.length;++i<r&&bt(t,n[i],0)>-1;);return i}function ye(n,t){for(var i=n.length;i--&&bt(t,n[i],0)>-1;);return i}function ec(n,t){for(var i=n.length,r=0;i--;)n[i]===t&&++r;return r}function oc(n){return"\\"+ph[n]}function sc(n,t){return n==null?u:n[t]}function kt(n){return lh.test(n)}function hc(n){return ah.test(n)}function cc(n){for(var t,i=[];!(t=n.next()).done;)i.push(t.value);return i}function su(n){var i=-1,t=Array(n.size);return n.forEach(function(n,r){t[++i]=[r,n]}),t}function be(n,t){return function(i){return n(t(i))}}function ot(n,t){for(var i=-1,f=n.length,e=0,u=[],r;++i<f;)r=n[i],(r===t||r===si)&&(n[i]=si,u[e++]=i);return u}function hu(n,t){return t=="__proto__"?u:n[t]}function nr(n){var i=-1,t=Array(n.size);return n.forEach(function(n){t[++i]=n}),t}function lc(n){var i=-1,t=Array(n.size);return n.forEach(function(n){t[++i]=[n,n]}),t}function ac(n,t,i){for(var r=i-1,u=n.length;++r<u;)if(n[r]===t)return r;return-1}function vc(n,t,i){for(var r=i+1;r--;)if(n[r]===t)return r;return r}function dt(n){return kt(n)?yc(n):se(n)}function b(n){return kt(n)?pc(n):tc(n)}function yc(n){for(var t=kr.lastIndex=0;kr.test(n);)++t;return t}function pc(n){return n.match(kr)||[]}function wc(n){return n.match(ch)||[]}var u,de="4.17.5",tr=200,ge="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",l="Expected a function",ir="__lodash_hash_undefined__",no=500,si="__lodash_placeholder__",rt=1,lu=2,ct=4,lt=1,hi=2,a=1,st=2,au=4,k=8,at=16,d=32,vt=64,nt=128,gt=256,rr=512,to=30,io="...",ro=800,uo=16,vu=1,fo=2,eo=3,ht=1/0,ut=9007199254740991,oo=17976931348623157e292,ci=NaN,g=4294967295,so=g-1,ho=g>>>1,co=[["ary",nt],["bind",a],["bindKey",st],["curry",k],["curryRight",at],["flip",rr],["partial",d],["partialRight",vt],["rearg",gt]],yt="[object Arguments]",li="[object Array]",lo="[object AsyncFunction]",ni="[object Boolean]",ti="[object Date]",ao="[object DOMException]",ai="[object Error]",vi="[object Function]",yu="[object GeneratorFunction]",p="[object Map]",ii="[object Number]",vo="[object Null]",tt="[object Object]",pu="[object Promise]",yo="[object Proxy]",ri="[object RegExp]",w="[object Set]",ui="[object String]",yi="[object Symbol]",po="[object Undefined]",fi="[object WeakMap]",wo="[object WeakSet]",ei="[object ArrayBuffer]",pt="[object DataView]",ur="[object Float32Array]",fr="[object Float64Array]",er="[object Int8Array]",or="[object Int16Array]",sr="[object Int32Array]",hr="[object Uint8Array]",cr="[object Uint8ClampedArray]",lr="[object Uint16Array]",ar="[object Uint32Array]",bo=/\b__p \+= '';/g,ko=/\b(__p \+=) '' \+/g,go=/(__e\(.*?\)|\b__t\)) \+\n'';/g,wu=/&(?:amp|lt|gt|quot|#39);/g,bu=/[&<>"']/g,ns=RegExp(wu.source),ts=RegExp(bu.source),is=/<%-([\s\S]+?)%>/g,rs=/<%([\s\S]+?)%>/g,ku=/<%=([\s\S]+?)%>/g,us=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,fs=/^\w*$/,es=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,vr=/[\\^$.*+?()[\]{}|]/g,os=RegExp(vr.source),du=/^\s+|\s+$/g,gu=/^\s+/,ss=/\s+$/,hs=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,cs=/\{\n\/\* \[wrapped with (.+)\] \*/,ls=/,? & /,as=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,vs=/\\(\\)?/g,ys=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,nf=/\w*$/,ps=/^[-+]0x[0-9a-f]+$/i,ws=/^0b[01]+$/i,bs=/^\[object .+?Constructor\]$/,ks=/^0o[0-7]+$/i,ds=/^(?:0|[1-9]\d*)$/,gs=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,pi=/($^)/,nh=/['\n\r\u2028\u2029\\]/g,wi="\\ud800-\\udfff",tf="\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff",rf="\\u2700-\\u27bf",uf="a-z\\xdf-\\xf6\\xf8-\\xff",ff="A-Z\\xc0-\\xd6\\xd8-\\xde",ef="\\ufe0e\\ufe0f",of="\\xac\\xb1\\xd7\\xf7\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf\\u2000-\\u206f \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",yr="['â]",th="["+wi+"]",sf="["+of+"]",bi="["+tf+"]",hf="\\d+",ih="["+rf+"]",cf="["+uf+"]",lf="[^"+wi+of+hf+rf+uf+ff+"]",pr="\\ud83c[\\udffb-\\udfff]",rh="(?:"+bi+"|"+pr+")",af="[^"+wi+"]",wr="(?:\\ud83c[\\udde6-\\uddff]){2}",br="[\\ud800-\\udbff][\\udc00-\\udfff]",wt="["+ff+"]",vf="\\u200d",yf="(?:"+cf+"|"+lf+")",uh="(?:"+wt+"|"+lf+")",pf="(?:"+yr+"(?:d|ll|m|re|s|t|ve))?",wf="(?:"+yr+"(?:D|LL|M|RE|S|T|VE))?",bf=rh+"?",kf="["+ef+"]?",fh="(?:"+vf+"(?:"+[af,wr,br].join("|")+")"+kf+bf+")*",df=kf+bf+fh,eh="(?:"+[ih,wr,br].join("|")+")"+df,oh="(?:"+[af+bi+"?",bi,wr,br,th].join("|")+")",sh=RegExp(yr,"g"),hh=RegExp(bi,"g"),kr=RegExp(pr+"(?="+pr+")|"+oh+df,"g"),ch=RegExp([wt+"?"+cf+"+"+pf+"(?="+[sf,wt,"$"].join("|")+")",uh+"+"+wf+"(?="+[sf,wt+yf,"$"].join("|")+")",wt+"?"+yf+"+"+pf,wt+"+"+wf,"\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])","\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",hf,eh].join("|"),"g"),lh=RegExp("["+vf+wi+tf+ef+"]"),ah=/[a-z][A-Z]|[A-Z]{2,}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,vh=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],yh=-1,e={},f,se,pe,we,ke,cu,it;e[ur]=e[fr]=e[er]=e[or]=e[sr]=e[hr]=e[cr]=e[lr]=e[ar]=!0;e[yt]=e[li]=e[ei]=e[ni]=e[pt]=e[ti]=e[ai]=e[vi]=e[p]=e[ii]=e[tt]=e[ri]=e[w]=e[ui]=e[fi]=!1;f={};f[yt]=f[li]=f[ei]=f[pt]=f[ni]=f[ti]=f[ur]=f[fr]=f[er]=f[or]=f[sr]=f[p]=f[ii]=f[tt]=f[ri]=f[w]=f[ui]=f[yi]=f[hr]=f[cr]=f[lr]=f[ar]=!0;f[ai]=f[vi]=f[fi]=!1;var ph={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},wh=parseFloat,bh=parseInt,gf=typeof t=="object"&&t&&t.Object===Object&&t,kh=typeof self=="object"&&self&&self.Object===Object&&self,s=gf||kh||Function("return this")(),dr=typeof r=="object"&&r&&!r.nodeType&&r,ki=dr&&typeof i=="object"&&i&&!i.nodeType&&i,ne=ki&&ki.exports===dr,gr=ne&&gf.process,v=function(){try{return gr&&gr.binding&&gr.binding("util")}catch(n){}}(),te=v&&v.isArrayBuffer,ie=v&&v.isDate,re=v&&v.isMap,ue=v&&v.isRegExp,fe=v&&v.isSet,ee=v&&v.isTypedArray;se=ru("length");pe=uu({"Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã":"A","Ã ":"a","Ã¡":"a","Ã¢":"a","Ã£":"a","Ã¤":"a","Ã¥":"a","Ã":"C","Ã§":"c","Ã":"D","Ã°":"d","Ã":"E","Ã":"E","Ã":"E","Ã":"E","Ã¨":"e","Ã©":"e","Ãª":"e","Ã«":"e","Ã":"I","Ã":"I","Ã":"I","Ã":"I","Ã¬":"i","Ã­":"i","Ã®":"i","Ã¯":"i","Ã":"N","Ã±":"n","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã":"O","Ã²":"o","Ã³":"o","Ã´":"o","Ãµ":"o","Ã¶":"o","Ã¸":"o","Ã":"U","Ã":"U","Ã":"U","Ã":"U","Ã¹":"u","Ãº":"u","Ã»":"u","Ã¼":"u","Ã":"Y","Ã½":"y","Ã¿":"y","Ã":"Ae","Ã¦":"ae","Ã":"Th","Ã¾":"th","Ã":"ss","Ä":"A","Ä":"A","Ä":"A","Ä":"a","Ä":"a","Ä":"a","Ä":"C","Ä":"C","Ä":"C","Ä":"C","Ä":"c","Ä":"c","Ä":"c","Ä":"c","Ä":"D","Ä":"D","Ä":"d","Ä":"d","Ä":"E","Ä":"E","Ä":"E","Ä":"E","Ä":"E","Ä":"e","Ä":"e","Ä":"e","Ä":"e","Ä":"e","Ä":"G","Ä":"G","Ä ":"G","Ä¢":"G","Ä":"g","Ä":"g","Ä¡":"g","Ä£":"g","Ä¤":"H","Ä¦":"H","Ä¥":"h","Ä§":"h","Ä¨":"I","Äª":"I","Ä¬":"I","Ä®":"I","Ä°":"I","Ä©":"i","Ä«":"i","Ä­":"i","Ä¯":"i","Ä±":"i","Ä´":"J","Äµ":"j","Ä¶":"K","Ä·":"k","Ä¸":"k","Ä¹":"L","Ä»":"L","Ä½":"L","Ä¿":"L","Å":"L","Äº":"l","Ä¼":"l","Ä¾":"l","Å":"l","Å":"l","Å":"N","Å":"N","Å":"N","Å":"N","Å":"n","Å":"n","Å":"n","Å":"n","Å":"O","Å":"O","Å":"O","Å":"o","Å":"o","Å":"o","Å":"R","Å":"R","Å":"R","Å":"r","Å":"r","Å":"r","Å":"S","Å":"S","Å":"S","Å ":"S","Å":"s","Å":"s","Å":"s","Å¡":"s","Å¢":"T","Å¤":"T","Å¦":"T","Å£":"t","Å¥":"t","Å§":"t","Å¨":"U","Åª":"U","Å¬":"U","Å®":"U","Å°":"U","Å²":"U","Å©":"u","Å«":"u","Å­":"u","Å¯":"u","Å±":"u","Å³":"u","Å´":"W","Åµ":"w","Å¶":"Y","Å·":"y","Å¸":"Y","Å¹":"Z","Å»":"Z","Å½":"Z","Åº":"z","Å¼":"z","Å¾":"z","Ä²":"IJ","Ä³":"ij","Å":"Oe","Å":"oe","Å":"'n","Å¿":"s"});we=uu({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"});ke=uu({"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"});cu=function cu(n){function t(n){if(wr(n)&&!r(n)&&!(n instanceof wi)){if(n instanceof vf)return n;if(ki.call(n,"__wrapped__"))return pd(n)}return new vf(n)}function ga(){}function vf(n,t){this.__wrapped__=n;this.__actions__=[];this.__chain__=!!t;this.__index__=0;this.__values__=u}function wi(n){this.__wrapped__=n;this.__actions__=[];this.__dir__=1;this.__filtered__=!1;this.__iteratees__=[];this.__takeCount__=g;this.__views__=[]}function ait(){var n=new wi(this.__wrapped__);return n.__actions__=ef(this.__actions__),n.__dir__=this.__dir__,n.__filtered__=this.__filtered__,n.__iteratees__=ef(this.__iteratees__),n.__takeCount__=this.__takeCount__,n.__views__=ef(this.__views__),n}function vit(){if(this.__filtered__){var n=new wi(this);n.__dir__=-1;n.__filtered__=!0}else n=this.clone(),n.__dir__*=-1;return n}function yit(){var n=this.__wrapped__.value(),e=this.__dir__,o=r(n),s=e<0,h=o?n.length:0,c=yft(0,h,this.__views__),l=c.start,a=c.end,t=a-l,v=s?a:l-1,y=this.__iteratees__,g=y.length,p=0,w=tf(t,this.__takeCount__),u,f,i;if(!o||!s&&h==t&&w==t)return rk(n,this.__actions__);u=[];n:while(t--&&p<w){for(v+=e,f=-1,i=n[v];++f<g;){var b=y[f],nt=b.iteratee,k=b.type,d=nt(i);if(k==fo)i=d;else if(!d)if(k==vu)continue n;else break n}u[p++]=i}return u}function bc(n){var i=-1,r=n==null?0:n.length,t;for(this.clear();++i<r;)t=n[i],this.set(t[0],t[1])}function pit(){this.__data__=yl?yl(null):{};this.size=0}function wit(n){var t=this.has(n)&&delete this.__data__[n];return this.size-=t?1:0,t}function bit(n){var t=this.__data__,i;return yl?(i=t[n],i===ir?u:i):ki.call(t,n)?t[n]:u}function kit(n){var t=this.__data__;return yl?t[n]!==u:ki.call(t,n)}function dit(n,t){var i=this.__data__;return this.size+=this.has(n)?0:1,i[n]=yl&&t===u?ir:t,this}function th(n){var i=-1,r=n==null?0:n.length,t;for(this.clear();++i<r;)t=n[i],this.set(t[0],t[1])}function git(){this.__data__=[];this.size=0}function nrt(n){var t=this.__data__,i=nv(t,n),r;return i<0?!1:(r=t.length-1,i==r?t.pop():ya.call(t,i,1),--this.size,!0)}function trt(n){var t=this.__data__,i=nv(t,n);return i<0?u:t[i][1]}function irt(n){return nv(this.__data__,n)>-1}function rrt(n,t){var i=this.__data__,r=nv(i,n);return r<0?(++this.size,i.push([n,t])):i[r][1]=t,this}function ih(n){var i=-1,r=n==null?0:n.length,t;for(this.clear();++i<r;)t=n[i],this.set(t[0],t[1])}function urt(){this.size=0;this.__data__={hash:new bc,map:new(al||th),string:new bc}}function frt(n){var t=yv(this,n)["delete"](n);return this.size-=t?1:0,t}function ert(n){return yv(this,n).get(n)}function ort(n){return yv(this,n).has(n)}function srt(n,t){var i=yv(this,n),r=i.size;return i.set(n,t),this.size+=i.size==r?0:1,this}function kc(n){var t=-1,i=n==null?0:n.length;for(this.__data__=new ih;++t<i;)this.add(n[t])}function hrt(n){return this.__data__.set(n,ir),this}function crt(n){return this.__data__.has(n)}function kf(n){var t=this.__data__=new th(n);this.size=t.size}function lrt(){this.__data__=new th;this.size=0}function art(n){var t=this.__data__,i=t["delete"](n);return this.size=t.size,i}function vrt(n){return this.__data__.get(n)}function yrt(n){return this.__data__.has(n)}function prt(n,t){var i=this.__data__,r;if(i instanceof th){if(r=i.__data__,!al||r.length<tr-1)return r.push([n,t]),this.size=++i.size,this;i=this.__data__=new ih(r)}return i.set(n,t),this.size=i.size,this}function rb(n,t){var u=r(n),f=!u&&tl(n),e=!u&&!f&&ch(n),s=!u&&!f&&!e&&il(n),h=u||f||e||s,o=h?eu(n.length,att):[],c=o.length;for(var i in n)!(t||ki.call(n,i))||h&&(i=="length"||e&&(i=="offset"||i=="parent")||s&&(i=="buffer"||i=="byteLength"||i=="byteOffset")||oh(i,c))||o.push(i);return o}function ub(n){var t=n.length;return t?n[gy(0,t-1)]:u}function wrt(n,t){return pv(ef(n),dc(t,0,n.length))}function brt(n){return pv(ef(n))}function hy(n,t,i){(i===u||df(n[t],i))&&(i!==u||t in n)||rh(n,t,i)}function bl(n,t,i){var r=n[t];ki.call(n,t)&&df(r,i)&&(i!==u||t in n)||rh(n,t,i)}function nv(n,t){for(var i=n.length;i--;)if(df(n[i][0],t))return i;return-1}function krt(n,t,i,r){return uh(n,function(n,u,f){t(r,n,i(n),f)}),r}function fb(n,t){return n&&se(t,gr(t),n)}function drt(n,t){return n&&se(t,sf(t),n)}function rh(n,t,i){t=="__proto__"&&pa?pa(n,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):n[t]=i}function cy(n,t){for(var i=-1,r=t.length,f=kr(r),e=n==null;++i<r;)f[i]=e?u:uw(n,t[i]);return f}function dc(n,t,i){return n===n&&(i!==u&&(n=n<=i?n:i),t!==u&&(n=n>=t?n:t)),n}function yf(n,t,i,e,o,s){var h,l=t&rt,a=t&lu,d=t&ct,v,c,p,w,k,b;if(i&&(h=o?i(n,e,o,s):i(n)),h!==u)return h;if(!pr(n))return n;if(v=r(n),v){if(h=wft(n),!l)return ef(n,h)}else{if(c=rf(n),p=c==vi||c==yu,ch(n))return ok(n,l);if(c==tt||c==yt||p&&!o){if(h=a||p?{}:ed(n),!l)return a?eft(n,drt(h,n)):fft(n,fb(h,n))}else{if(!f[c])return o?n:{};h=bft(n,c,l)}}return(s||(s=new kf),w=s.get(n),w)?w:(s.set(n,h),rw(n))?(n.forEach(function(r){h.add(yf(r,t,i,r,n,s))}),h):iw(n)?(n.forEach(function(r,u){h.set(u,yf(r,t,i,u,n,s))}),h):(k=d?a?lp:cp:a?sf:gr,b=v?u:k(n),y(b||n,function(r,u){b&&(u=r,r=n[u]);bl(h,u,yf(r,t,i,u,n,s))}),h)}function grt(n){var t=gr(n);return function(i){return eb(i,n,t)}}function eb(n,t,i){var r=i.length;if(n==null)return!r;for(n=yr(n);r--;){var f=i[r],o=t[f],e=n[f];if(e===u&&!(f in n)||!o(e))return!1}return!0}function ob(n,t,i){if(typeof n!="function")throw new af(l);return ra(function(){n.apply(u,i)},t)}function kl(n,t,i,r){var a=-1,s=di,h=!0,v=n.length,e=[],y=t.length,u,f,l;if(!v)return e;i&&(t=o(t,c(i)));r?(s=nu,h=!1):t.length>=tr&&(s=oi,h=!1,t=new kc(t));n:while(++a<v)if(u=n[a],f=i==null?u:i(u),u=r||u!==0?u:0,h&&f===f){for(l=y;l--;)if(t[l]===f)continue n;e.push(u)}else s(t,f,r)||e.push(u);return e}function nut(n,t){var i=!0;return uh(n,function(n,r,u){return i=!!t(n,r,u)}),i}function tv(n,t,i){for(var o=-1,h=n.length,f,r,e,s;++o<h;)f=n[o],r=t(f),r!=null&&(e===u?r===r&&!lf(r):i(r,e))&&(e=r,s=f);return s}function tut(n,t,i,r){var f=n.length;for(i=v(i),i<0&&(i=-i>f?0:f+i),r=r===u||r>f?f:v(r),r<0&&(r+=f),r=i>r?0:cn(r);i<r;)n[i++]=t;return n}function sb(n,t){var i=[];return uh(n,function(n,r,u){t(n,r,u)&&i.push(n)}),i}function uu(n,t,i,r,u){var e=-1,o=n.length,f;for(i||(i=dft),u||(u=[]);++e<o;)f=n[e],t>0&&i(f)?t>1?uu(f,t-1,i,r,u):et(u,f):r||(u[u.length]=f);return u}function gf(n,t){return n&&iv(n,t,gr)}function vy(n,t){return n&&ay(n,t,gr)}function rv(n,t){return ft(t,function(t){return lh(n[t])})}function el(n,t){t=tc(t,n);for(var i=0,r=t.length;n!=null&&i<r;)n=n[as(t[i++])];return i&&i==r?n:u}function hb(n,t,i){var u=t(n);return r(n)?u:et(u,i(n))}function uf(n){return n==null?n===u?po:vo:yc&&yc in yr(n)?vft(n):uet(n)}function yy(n,t){return n>t}function iut(n,t){return n!=null&&ki.call(n,t)}function rut(n,t){return n!=null&&t in yr(n)}function uut(n,t,i){return n>=tf(t,i)&&n<dr(t,i)}function py(n,t,i){for(var b=i?nu:di,k=n[0].length,a=n.length,r=a,v=kr(a),y=Infinity,l=[],f,p,h,e,s,w;r--;)f=n[r],r&&t&&(f=o(f,c(t))),y=tf(f.length,y),v[r]=!i&&(t||k>=120&&f.length>=120)?new kc(r&&f):u;f=n[0];p=-1;h=v[0];n:while(++p<k&&l.length<y)if(e=f[p],s=t?t(e):e,e=i||e!==0?e:0,!(h?oi(h,s):b(l,s,i))){for(r=a;--r;)if(w=v[r],!(w?oi(w,s):b(n[r],s,i)))continue n;h&&h.push(s);l.push(e)}return l}function fut(n,t,i,r){return gf(n,function(n,u,f){t(r,i(n),u,f)}),r}function dl(n,t,i){t=tc(t,n);n=ld(n,t);var r=n==null?n:n[as(wf(t))];return r==null?u:h(r,n,i)}function cb(n){return wr(n)&&uf(n)==yt}function eut(n){return wr(n)&&uf(n)==ei}function out(n){return wr(n)&&uf(n)==ti}function gl(n,t,i,r,u){return n===t?!0:n==null||t==null||!wr(n)&&!wr(t)?n!==n&&t!==t:sut(n,t,i,r,gl,u)}function sut(n,t,i,u,f,e){var h=r(n),w=r(t),o=h?li:rf(n),s=w?li:rf(t),a,v,y,p;o=o==yt?tt:o;s=s==yt?tt:s;var c=o==tt,b=s==tt,l=o==s;if(l&&ch(n)){if(!ch(t))return!1;h=!0;c=!1}return l&&!c?(e||(e=new kf),h||il(n)?rd(n,t,i,u,f,e):lft(n,t,o,i,u,f,e)):!(i&lt)&&(a=c&&ki.call(n,"__wrapped__"),v=b&&ki.call(t,"__wrapped__"),a||v)?(y=a?n.value():n,p=v?t.value():t,e||(e=new kf),f(y,p,i,u,e)):l?(e||(e=new kf),aft(n,t,i,u,f,e)):!1}function hut(n){return wr(n)&&rf(n)==p}function wy(n,t,i,r){var e=i.length,l=e,a=!r,f,h,c;if(n==null)return!l;for(n=yr(n);e--;)if(f=i[e],a&&f[2]?f[1]!==n[f[0]]:!(f[0]in n))return!1;while(++e<l){f=i[e];var o=f[0],s=n[o],v=f[1];if(a&&f[2]){if(s===u&&!(o in n))return!1}else if(h=new kf,r&&(c=r(s,v,o,n,t,h)),!(c===u?gl(v,s,lt|hi,r,h):c))return!1}return!0}function lb(n){if(!pr(n)||net(n))return!1;var t=lh(n)?btt:bs;return t.test(nl(n))}function cut(n){return wr(n)&&uf(n)==ri}function lut(n){return wr(n)&&rf(n)==w}function aut(n){return wr(n)&&ny(n.length)&&!!e[uf(n)]}function ab(n){return typeof n=="function"?n:n==null?hf:typeof n=="object"?r(n)?pb(n[0],n[1]):yb(n):htt(n)}function by(n){var i,t;if(!ia(n))return rit(n);i=[];for(t in yr(n))ki.call(n,t)&&t!="constructor"&&i.push(t);return i}function vut(n){var r,i,t;if(!pr(n))return ret(n);r=ia(n);i=[];for(t in n)t=="constructor"&&(r||!ki.call(n,t))||i.push(t);return i}function ky(n,t){return n<t}function vb(n,t){var r=-1,i=of(n)?kr(n.length):[];return uh(n,function(n,u,f){i[++r]=t(n,u,f)}),i}function yb(n){var t=ap(n);return t.length==1&&t[0][2]?hd(t[0][0],t[0][1]):function(i){return i===n||wy(i,n,t)}}function pb(n,t){return yp(n)&&sd(t)?hd(as(n),t):function(i){var r=uw(i,n);return r===u&&r===t?fw(i,n):gl(t,r,lt|hi)}}function uv(n,t,i,r,f){n!==t&&iv(t,function(e,o){if(pr(e))f||(f=new kf),yut(n,t,o,i,uv,r,f);else{var s=r?r(hu(n,o),e,o+"",n,t,f):u;s===u&&(s=e);hy(n,o,s)}},sf)}function yut(n,t,i,f,e,o,s){var l=hu(n,i),h=hu(t,i),p=s.get(h),c,a;if(p){hy(n,i,p);return}if(c=o?o(l,h,i+"",n,t,s):u,a=c===u,a){var v=r(h),y=!v&&ch(h),w=!v&&!y&&il(h);c=h;v||y||w?r(l)?c=l:br(l)?c=ef(l):y?(a=!1,c=ok(h,!0)):w?(a=!1,c=sk(h,!0)):c=[]:fa(h)||tl(h)?(c=l,tl(l)?c=ln(l):(!pr(l)||f&&lh(l))&&(c=ed(h))):a=!1}a&&(s.set(h,c),e(c,h,f,o,s),s["delete"](h));hy(n,i,c)}function wb(n,t){var i=n.length;if(i)return t+=t<0?i:0,oh(t,i)?n[t]:u}function bb(n,t,r){var f=-1,u;return t=o(t.length?t:[hf],c(i())),u=vb(n,function(n){var i=o(t,function(t){return t(n)});return{criteria:i,index:++f,value:n}}),uc(u,function(n,t){return uft(n,t,r)})}function put(n,t){return kb(n,t,function(t,i){return fw(n,i)})}function kb(n,t,i){for(var f=-1,o=t.length,e={},r,u;++f<o;)r=t[f],u=el(n,r),i(u,r)&&na(e,tc(r,n),u);return e}function wut(n){return function(t){return el(t,n)}}function dy(n,t,i,r){var h=r?rc:bt,e=-1,l=t.length,u=n;for(n===t&&(t=ef(t)),i&&(u=o(n,c(i)));++e<l;)for(var f=0,s=t[e],a=i?i(s):s;(f=h(u,a,f,r))>-1;)u!==n&&ya.call(u,f,1),ya.call(n,f,1);return n}function db(n,t){for(var r=n?t.length:0,f=r-1,i,u;r--;)i=t[r],(r==f||i!==u)&&(u=i,oh(i)?ya.call(n,i,1):rp(n,i));return n}function gy(n,t){return n+ba(tb()*(t-n+1))}function but(n,t,i,r){for(var e=-1,u=dr(wa((t-n)/(i||1)),0),f=kr(u);u--;)f[r?u:++e]=n,n+=i;return f}function np(n,t){var i="";if(!n||t<1||t>ut)return i;do t%2&&(i+=n),t=ba(t/2),t&&(n+=n);while(t);return i}function wt(n,t){return wp(cd(n,t,hf),n+"")}function kut(n){return ub(cl(n))}function dut(n,t){var i=cl(n);return pv(i,dc(t,0,i.length))}function na(n,t,i,r){var e,o,h;if(!pr(n))return n;t=tc(t,n);for(var s=-1,c=t.length,l=c-1,f=n;f!=null&&++s<c;)e=as(t[s]),o=i,s!=l&&(h=f[e],o=r?r(h,e,f):u,o===u&&(o=pr(h)?h:oh(t[s+1])?[]:{})),bl(f,e,o),f=f[e];return n}function gut(n){return pv(cl(n))}function pf(n,t,i){var u=-1,r=n.length,f;for(t<0&&(t=-t>r?0:r+t),i=i>r?r:i,i<0&&(i+=r),r=t>i?0:i-t>>>0,t>>>=0,f=kr(r);++u<r;)f[u]=n[u+t];return f}function nft(n,t){var i;return uh(n,function(n,r,u){return i=t(n,r,u),!i}),!!i}function fv(n,t,i){var f=0,r=n==null?f:n.length,e,u;if(typeof t=="number"&&t===t&&r<=ho){while(f<r)e=f+r>>>1,u=n[e],u!==null&&!lf(u)&&(i?u<=t:u<t)?f=e+1:r=e;return r}return ip(n,t,hf,i)}function ip(n,t,i,r){var v;t=i(t);for(var s=0,e=n==null?0:n.length,y=t!==t,p=t===null,w=lf(t),b=t===u;s<e;){var h=ba((s+e)/2),f=i(n[h]),c=f!==u,l=f===null,o=f===f,a=lf(f);v=y?r||o:b?o&&(r||c):p?o&&c&&(r||!l):w?o&&c&&!l&&(r||!a):l||a?!1:r?f<=t:f<t;v?s=h+1:e=h}return tf(e,so)}function nk(n,t){for(var r=-1,o=n.length,s=0,f=[],i,u,e;++r<o;)i=n[r],u=t?t(i):i,r&&df(u,e)||(e=u,f[s++]=i===0?0:i);return f}function tk(n){return typeof n=="number"?n:lf(n)?ci:+n}function cf(n){if(typeof n=="string")return n;if(r(n))return o(n,cf)+"";if(lf(n))return ib?ib.call(n):"";var t=n+"";return t=="0"&&1/n==-ht?"-0":t}function kh(n,t,i){var l=-1,o=di,a=n.length,s=!0,e=[],r=e,h,u,f,c;if(i)s=!1,o=nu;else if(a>=tr){if(h=t?null:gk(n),h)return nr(h);s=!1;o=oi;r=new kc}else r=t?[]:e;n:while(++l<a)if(u=n[l],f=t?t(u):u,u=i||u!==0?u:0,s&&f===f){for(c=r.length;c--;)if(r[c]===f)continue n;t&&r.push(f);e.push(u)}else o(r,f,i)||(r!==e&&r.push(f),e.push(u));return e}function rp(n,t){return t=tc(t,n),n=ld(n,t),n==null||delete n[as(wf(t))]}function ik(n,t,i,r){return na(n,t,i(el(n,t)),r)}function ev(n,t,i,r){for(var f=n.length,u=r?f:-1;(r?u--:++u<f)&&t(n[u],u,n););return i?pf(n,r?0:u,r?u+1:f):pf(n,r?u+1:0,r?f:u)}function rk(n,t){var i=n;return i instanceof wi&&(i=i.value()),tu(t,function(n,t){return t.func.apply(t.thisArg,et([n],t.args))},i)}function up(n,t,i){var u=n.length,r,f,o,e;if(u<2)return u?kh(n[0]):[];for(r=-1,f=kr(u);++r<u;)for(o=n[r],e=-1;++e<u;)e!=r&&(f[r]=kl(f[r]||o,n[e],t,i));return kh(uu(f,1),t,i)}function uk(n,t,i){for(var r=-1,o=n.length,s=t.length,f={},e;++r<o;)e=r<s?t[r]:u,i(f,n[r],e);return f}function fp(n){return br(n)?n:[]}function ep(n){return typeof n=="function"?n:hf}function tc(n,t){return r(n)?n:yp(n,t)?[n]:bp(bi(n))}function ac(n,t,i){var r=n.length;return i=i===u?r:i,!t&&i>=r?n:pf(n,t,i)}function ok(n,t){if(t)return n.slice();var i=n.length,r=kw?kw(i):new n.constructor(i);return n.copy(r),r}function op(n){var t=new n.constructor(n.byteLength);return new aa(t).set(new aa(n)),t}function tft(n,t){var i=t?op(n.buffer):n.buffer;return new n.constructor(i,n.byteOffset,n.byteLength)}function ift(n){var t=new n.constructor(n.source,nf.exec(n));return t.lastIndex=n.lastIndex,t}function rft(n){return wl?yr(wl.call(n)):{}}function sk(n,t){var i=t?op(n.buffer):n.buffer;return new n.constructor(i,n.byteOffset,n.length)}function hk(n,t){if(n!==t){var o=n!==u,s=n===null,i=n===n,r=lf(n),h=t!==u,c=t===null,f=t===t,e=lf(t);if(!c&&!e&&!r&&n>t||r&&h&&f&&!c&&!e||s&&h&&f||!o&&f||!i)return 1;if(!s&&!r&&!e&&n<t||e&&o&&i&&!s&&!r||c&&o&&i||!h&&i||!f)return-1}return 0}function uft(n,t,i){for(var r=-1,f=n.criteria,o=t.criteria,s=f.length,h=i.length,u,e;++r<s;)if(u=hk(f[r],o[r]),u)return r>=h?u:(e=i[r],u*(e=="desc"?-1:1));return n.index-t.index}function ck(n,t,i,r){for(var u=-1,o=n.length,s=i.length,f=-1,h=t.length,c=dr(o-s,0),e=kr(h+c),l=!r;++f<h;)e[f]=t[f];while(++u<s)(l||u<o)&&(e[i[u]]=n[u]);while(c--)e[f++]=n[u++];return e}function lk(n,t,i,r){for(var u=-1,s=n.length,h=-1,c=i.length,e=-1,l=t.length,a=dr(s-c,0),f=kr(a+l),v=!r,o;++u<a;)f[u]=n[u];for(o=u;++e<l;)f[o+e]=t[e];while(++h<c)(v||u<s)&&(f[o+i[h]]=n[u++]);return f}function ef(n,t){var i=-1,r=n.length;for(t||(t=kr(r));++i<r;)t[i]=n[i];return t}function se(n,t,i,r){var h=!i,o,s,f,e;for(i||(i={}),o=-1,s=t.length;++o<s;)f=t[o],e=r?r(i[f],n[f],f,i,n):u,e===u&&(e=n[f]),h?rh(i,f,e):bl(i,f,e);return i}function fft(n,t){return se(n,vp(n),t)}function eft(n,t){return se(n,ud(n),t)}function ov(n,t){return function(u,f){var e=r(u)?dh:krt,o=t?t():{};return e(u,n,i(f,2),o)}}function ol(n){return wt(function(t,i){var e=-1,r=i.length,f=r>1?i[r-1]:u,s=r>2?i[2]:u,o;for(f=n.length>3&&typeof f=="function"?(r--,f):u,s&&ff(i[0],i[1],s)&&(f=r<3?u:f,r=1),t=yr(t);++e<r;)o=i[e],o&&n(t,o,e,f);return t})}function ak(n,t){return function(i,r){if(i==null)return i;if(!of(i))return n(i,r);for(var f=i.length,u=t?f:-1,e=yr(i);t?u--:++u<f;)if(r(e[u],u,e)===!1)break;return i}}function vk(n){return function(t,i,r){for(var s=-1,f=yr(t),e=r(t),o=e.length,u;o--;)if(u=e[n?o:++s],i(f[u],u,f)===!1)break;return t}}function oft(n,t,i){function r(){var t=this&&this!==s&&this instanceof r?f:n;return t.apply(u?i:this,arguments)}var u=t&a,f=ta(n);return r}function yk(n){return function(t){t=bi(t);var i=kt(t)?b(t):u,r=i?i[0]:t.charAt(0),f=i?ac(i,1).join(""):t.slice(1);return r[n]()+f}}function sl(n){return function(t){return tu(rtt(gn(t).replace(sh,"")),n,"")}}function ta(n){return function(){var t=arguments,i,r;switch(t.length){case 0:return new n;case 1:return new n(t[0]);case 2:return new n(t[0],t[1]);case 3:return new n(t[0],t[1],t[2]);case 4:return new n(t[0],t[1],t[2],t[3]);case 5:return new n(t[0],t[1],t[2],t[3],t[4]);case 6:return new n(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}return i=pc(n.prototype),r=n.apply(i,t),pr(r)?r:i}}function sft(n,t,i){function r(){for(var e=arguments.length,o=kr(e),c=e,l=hl(r),a,v;c--;)o[c]=arguments[c];return(a=e<3&&o[0]!==l&&o[e-1]!==l?[]:ot(o,l),e-=a.length,e<i)?dk(n,t,sv,r.placeholder,u,o,a,u,u,i-e):(v=this&&this!==s&&this instanceof r?f:n,h(v,this,o))}var f=ta(n);return r}function pk(n){return function(t,r,f){var o=yr(t),s,e;return of(t)||(s=i(r,3),t=gr(t),r=function(n){return s(o[n],n,o)}),e=n(t,r,f),e>-1?o[s?t[e]:e]:u}}function wk(n){return eh(function(t){var s=t.length,o=s,c=vf.prototype.thru,f,i,h,e;for(n&&t.reverse();o--;){if(f=t[o],typeof f!="function")throw new af(l);c&&!i&&vv(f)=="wrapper"&&(i=new vf([],!0))}for(o=i?o:s;++o<s;)f=t[o],h=vv(f),e=h=="wrapper"?av(f):u,i=e&&pp(e[0])&&e[1]==(nt|k|d|gt)&&!e[4].length&&e[9]==1?i[vv(e[0])].apply(i,e[3]):f.length==1&&pp(f)?i[h]():i.thru(f);return function(){var f=arguments,e=f[0],n,u;if(i&&f.length==1&&r(e))return i.plant(e).value();for(n=0,u=s?t[n].apply(this,f):e;++n<s;)u=t[n].call(this,u);return u}})}function sv(n,t,i,r,f,e,o,h,c,l){function y(){for(var a=arguments.length,u=kr(a),nt=a,tt,rt,ut,it,k;nt--;)u[nt]=arguments[nt];return(v&&(tt=hl(y),rt=ec(u,tt)),r&&(u=ck(u,r,f,v)),e&&(u=lk(u,e,o,v)),a-=rt,v&&a<l)?(ut=ot(u,tt),dk(n,t,sv,y.placeholder,i,u,ut,h,c,l-a)):(it=b?i:this,k=p?it[n]:n,a=u.length,h?u=fet(u,h):d&&a>1&&u.reverse(),w&&c<a&&(u.length=c),this&&this!==s&&this instanceof y&&(k=g||ta(k)),k.apply(it,u))}var w=t&nt,b=t&a,p=t&st,v=t&(k|at),d=t&rr,g=p?u:ta(n);return y}function bk(n,t){return function(i,r){return fut(i,n,t(r),{})}}function hv(n,t){return function(i,r){var f;if(i===u&&r===u)return t;if(i!==u&&(f=i),r!==u){if(f===u)return r;typeof i=="string"||typeof r=="string"?(i=cf(i),r=cf(r)):(i=tk(i),r=tk(r));f=n(i,r)}return f}}function sp(n){return eh(function(t){return t=o(t,c(i())),wt(function(i){var r=this;return n(t,function(n){return h(n,r,i)})})})}function cv(n,t){var i,r;return(t=t===u?" ":cf(t),i=t.length,i<2)?i?np(t,n):t:(r=np(t,wa(n/dt(t))),kt(t)?ac(b(r),0,n).join(""):r.slice(0,n))}function hft(n,t,i,r){function u(){for(var a=-1,c=arguments.length,t=-1,l=r.length,o=kr(l+c),v=this&&this!==s&&this instanceof u?e:n;++t<l;)o[t]=r[t];while(c--)o[t++]=arguments[++a];return h(v,f?i:this,o)}var f=t&a,e=ta(n);return u}function kk(n){return function(t,i,r){return r&&typeof r!="number"&&ff(t,i,r)&&(i=r=u),t=ah(t),i===u?(i=t,t=0):i=ah(i),r=r===u?t<i?1:-1:ah(r),but(t,i,r,n)}}function lv(n){return function(t,i){return typeof t=="string"&&typeof i=="string"||(t=bf(t),i=bf(i)),n(t,i)}}function dk(n,t,i,r,f,e,o,s,h,c){var l=t&k,p=l?o:u,w=l?u:o,b=l?e:u,g=l?u:e,y,v;return t|=l?d:vt,t&=~(l?vt:d),t&au||(t&=~(a|st)),y=[n,t,f,b,p,g,w,s,h,c],v=i.apply(u,y),pp(n)&&ad(v,y),v.placeholder=r,vd(v,n,t)}function hp(n){var t=rl[n];return function(n,i){if(n=bf(n),i=i==null?0:tf(v(i),292),i){var r=(bi(n)+"e").split("e"),u=t(r[0]+"e"+(+r[1]+i));return r=(bi(u)+"e").split("e"),+(r[0]+"e"+(+r[1]-i))}return t(n)}}function nd(n){return function(t){var i=rf(t);return i==p?su(t):i==w?lc(t):fc(t,n(t))}}function fh(n,t,i,r,f,e,o,s){var p=t&st,c,w,b,y,h,g,nt;if(!p&&typeof n!="function")throw new af(l);return c=r?r.length:0,c||(t&=~(d|vt),r=f=u),o=o===u?o:dr(v(o),0),s=s===u?s:v(s),c-=f?f.length:0,t&vt&&(w=r,b=f,r=f=u),y=p?u:av(n),h=[n,t,i,r,f,w,b,e,o,s],y&&iet(h,y),n=h[0],t=h[1],i=h[2],r=h[3],f=h[4],s=h[9]=h[9]===u?p?0:n.length:dr(h[9]-c,0),!s&&t&(k|at)&&(t&=~(k|at)),g=t&&t!=a?t==k||t==at?sft(n,t,s):t!=d&&t!=(a|d)||f.length?sv.apply(u,h):hft(n,t,i,r):oft(n,t,i),nt=y?tp:ad,vd(nt(g,h),n,t)}function td(n,t,i,r){return n===u||df(n,ul[i])&&!ki.call(r,i)?t:n}function id(n,t,i,r,f,e){return pr(n)&&pr(t)&&(e.set(t,n),uv(n,t,u,id,e),e["delete"](t)),n}function cft(n){return fa(n)?u:n}function rd(n,t,i,r,f,e){var p=i&lt,l=n.length,w=t.length,a,o,h,y;if(l!=w&&!(p&&w>l))return!1;if(a=e.get(n),a&&e.get(t))return a==t;var s=-1,c=!0,v=i&hi?new kc:u;for(e.set(n,t),e.set(t,n);++s<l;){if(o=n[s],h=t[s],r&&(y=p?r(h,o,s,t,n,e):r(o,h,s,n,t,e)),y!==u){if(y)continue;c=!1;break}if(v){if(!iu(t,function(n,t){if(!oi(v,t)&&(o===n||f(o,n,i,r,e)))return v.push(t)})){c=!1;break}}else if(!(o===h||f(o,h,i,r,e))){c=!1;break}}return e["delete"](n),e["delete"](t),c}function lft(n,t,i,r,u,f,e){var o,h,s,c;switch(i){case pt:if(n.byteLength!=t.byteLength||n.byteOffset!=t.byteOffset)return!1;n=n.buffer;t=t.buffer;case ei:return n.byteLength!=t.byteLength||!f(new aa(n),new aa(t))?!1:!0;case ni:case ti:case ii:return df(+n,+t);case ai:return n.name==t.name&&n.message==t.message;case ri:case ui:return n==t+"";case p:o=su;case w:return(h=r&lt,o||(o=nr),n.size!=t.size&&!h)?!1:(s=e.get(n),s)?s==t:(r|=hi,e.set(n,t),c=rd(o(n),o(t),r,u,f,e),e["delete"](n),c);case yi:if(wl)return wl.call(n)==wl.call(t)}return!1}function aft(n,t,i,r,f,e){var y=i&lt,w=cp(n),b=w.length,g=cp(t),nt=g.length,s,o,k,h,p,c,l,d,a,v;if(b!=nt&&!y)return!1;for(s=b;s--;)if(o=w[s],!(y?o in t:ki.call(t,o)))return!1;if(k=e.get(n),k&&e.get(t))return k==t;for(h=!0,e.set(n,t),e.set(t,n),p=y;++s<b;){if(o=w[s],c=n[o],l=t[o],r&&(d=y?r(l,c,o,t,n,e):r(c,l,o,n,t,e)),!(d===u?c===l||f(c,l,i,r,e):d)){h=!1;break}p||(p=o=="constructor")}return h&&!p&&(a=n.constructor,v=t.constructor,a!=v&&"constructor"in n&&"constructor"in t&&!(typeof a=="function"&&a instanceof a&&typeof v=="function"&&v instanceof v)&&(h=!1)),e["delete"](n),e["delete"](t),h}function eh(n){return wp(cd(n,u,kd),n+"")}function cp(n){return hb(n,gr,vp)}function lp(n){return hb(n,sf,ud)}function vv(n){for(var t=n.name+"",u=pl[t],f=ki.call(pl,t)?u.length:0,i,r;f--;)if(i=u[f],r=i.func,r==null||r==n)return i.name;return t}function hl(n){var i=ki.call(t,"placeholder")?t:n;return i.placeholder}function i(){var n=t.iteratee||cw;return n=n===cw?ab:n,arguments.length?n(arguments[0],arguments[1]):n}function yv(n,t){var i=n.__data__;return gft(t)?i[typeof t=="string"?"string":"hash"]:i.map}function ap(n){for(var t=gr(n),i=t.length,r,u;i--;)r=t[i],u=n[r],t[i]=[r,u,sd(u)];return t}function gc(n,t){var i=sc(n,t);return lb(i)?i:u}function vft(n){var r=ki.call(n,yc),f=n[yc],t,i;try{n[yc]=u;t=!0}catch(e){}return i=ca.call(n),t&&(r?n[yc]=f:delete n[yc]),i}function yft(n,t,i){for(var f=-1,e=i.length,u,r;++f<e;){u=i[f];r=u.size;switch(u.type){case"drop":n+=r;break;case"dropRight":t-=r;break;case"take":t=tf(t,n+r);break;case"takeRight":n=dr(n,t-r)}}return{start:n,end:t}}function pft(n){var t=n.match(cs);return t?t[1].split(ls):[]}function fd(n,t,i){var f;t=tc(t,n);for(var e=-1,u=t.length,o=!1;++e<u;){if(f=as(t[e]),!(o=n!=null&&i(n,f)))break;n=n[f]}return o||++e!=u?o:(u=n==null?0:n.length,!!u&&ny(u)&&oh(f,u)&&(r(n)||tl(n)))}function wft(n){var i=n.length,t=new n.constructor(i);return i&&typeof n[0]=="string"&&ki.call(n,"index")&&(t.index=n.index,t.input=n.input),t}function ed(n){return typeof n.constructor=="function"&&!ia(n)?pc(va(n)):{}}function bft(n,t,i){var r=n.constructor;switch(t){case ei:return op(n);case ni:case ti:return new r(+n);case pt:return tft(n,i);case ur:case fr:case er:case or:case sr:case hr:case cr:case lr:case ar:return sk(n,i);case p:return new r;case ii:case ui:return new r(n);case ri:return ift(n);case w:return new r;case yi:return rft(n)}}function kft(n,t){var i=t.length,r;return i?(r=i-1,t[r]=(i>1?"& ":"")+t[r],t=t.join(i>2?", ":" "),n.replace(hs,"{\n/* [wrapped with "+t+"] */\n")):n}function dft(n){return r(n)||tl(n)||!!(nb&&n&&n[nb])}function oh(n,t){var i=typeof n;return t=t==null?ut:t,!!t&&(i=="number"||i!="symbol"&&ds.test(n))&&n>-1&&n%1==0&&n<t}function ff(n,t,i){if(!pr(i))return!1;var r=typeof t;return(r=="number"?of(i)&&oh(t,i.length):r=="string"&&t in i)?df(i[t],n):!1}function yp(n,t){if(r(n))return!1;var i=typeof n;return i=="number"||i=="symbol"||i=="boolean"||n==null||lf(n)?!0:fs.test(n)||!us.test(n)||t!=null&&n in yr(t)}function gft(n){var t=typeof n;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?n!=="__proto__":n===null}function pp(n){var u=vv(n),i=t[u],r;return typeof i!="function"||!(u in wi.prototype)?!1:n===i?!0:(r=av(i),!!r&&n===r[0])}function net(n){return!!bw&&bw in n}function ia(n){var t=n&&n.constructor,i=typeof t=="function"&&t.prototype||ul;return n===i}function sd(n){return n===n&&!pr(n)}function hd(n,t){return function(i){return i==null?!1:i[n]===t&&(t!==u||n in yr(i))}}function tet(n){var t=dv(n,function(n){return i.size===no&&i.clear(),n}),i=t.cache;return t}function iet(n,t){var f=n[1],u=t[1],e=f|u,o=e<(a|st|nt),s=u==nt&&f==k||u==nt&&f==gt&&n[7].length<=t[8]||u==(nt|gt)&&t[7].length<=t[8]&&f==k,i,r;return(o||s)?(u&a&&(n[2]=t[2],e|=f&a?0:au),i=t[3],i&&(r=n[3],n[3]=r?ck(r,i,t[4]):i,n[4]=r?ot(n[3],si):t[4]),i=t[5],i&&(r=n[5],n[5]=r?lk(r,i,t[6]):i,n[6]=r?ot(n[5],si):t[6]),i=t[7],i&&(n[7]=i),u&nt&&(n[8]=n[8]==null?t[8]:tf(n[8],t[8])),n[9]==null&&(n[9]=t[9]),n[0]=t[0],n[1]=e,n):n}function ret(n){var t=[],i;if(n!=null)for(i in yr(n))t.push(i);return t}function uet(n){return ca.call(n)}function cd(n,t,i){return t=dr(t===u?n.length-1:t,0),function(){for(var f=arguments,r=-1,e=dr(f.length-t,0),o=kr(e),u;++r<e;)o[r]=f[t+r];for(r=-1,u=kr(t+1);++r<t;)u[r]=f[r];return u[t]=i(o),h(n,this,u)}}function ld(n,t){return t.length<2?n:el(n,pf(t,0,-1))}function fet(n,t){for(var f=n.length,i=tf(t.length,f),e=ef(n),r;i--;)r=t[i],n[i]=oh(r,f)?e[r]:u;return n}function vd(n,t,i){var r=t+"";return wp(n,kft(r,eet(pft(r),i)))}function yd(n){var t=0,i=0;return function(){var r=uit(),f=uo-(r-i);if(i=r,f>0){if(++t>=ro)return arguments[0]}else t=0;return n.apply(u,arguments)}}function pv(n,t){var i=-1,f=n.length,o=f-1,r,e;for(t=t===u?f:t;++i<t;)r=gy(i,o),e=n[r],n[r]=n[i],n[i]=e;return n.length=t,n}function as(n){if(typeof n=="string"||lf(n))return n;var t=n+"";return t=="0"&&1/n==-ht?"-0":t}function nl(n){if(n!=null){try{return ha.call(n)}catch(t){}try{return n+""}catch(t){}}return""}function eet(n,t){return y(co,function(i){var r="_."+i[0];t&i[1]&&!di(n,r)&&n.push(r)}),n.sort()}function pd(n){if(n instanceof wi)return n.clone();var t=new vf(n.__wrapped__,n.__chain__);return t.__actions__=ef(n.__actions__),t.__index__=n.__index__,t.__values__=n.__values__,t}function oet(n,t,i){var r;if(t=(i?ff(n,t,i):t===u)?1:dr(v(t),0),r=n==null?0:n.length,!r||t<1)return[];for(var f=0,o=0,e=kr(wa(r/t));f<r;)e[o++]=pf(n,f,f+=t);return e}function set(n){for(var i=-1,u=n==null?0:n.length,f=0,r=[],t;++i<u;)t=n[i],t&&(r[f++]=t);return r}function het(){var n=arguments.length;if(!n)return[];for(var u=kr(n-1),t=arguments[0],i=n;i--;)u[i-1]=arguments[i];return et(r(t)?ef(t):[t],uu(u,1))}function yet(n,t,i){var r=n==null?0:n.length;return r?(t=i||t===u?1:v(t),pf(n,t<0?0:t,r)):[]}function pet(n,t,i){var r=n==null?0:n.length;return r?(t=i||t===u?1:v(t),t=r-t,pf(n,0,t<0?0:t)):[]}function wet(n,t){return n&&n.length?ev(n,i(t,3),!0,!0):[]}function bet(n,t){return n&&n.length?ev(n,i(t,3),!0):[]}function ket(n,t,i,r){var u=n==null?0:n.length;return u?(i&&typeof i!="number"&&ff(n,t,i)&&(i=0,r=u),tut(n,t,i,r)):[]}function wd(n,t,r){var f=n==null?0:n.length,u;return f?(u=r==null?0:v(r),u<0&&(u=dr(f+u,0)),gi(n,i(t,3),u)):-1}function bd(n,t,r){var e=n==null?0:n.length,f;return e?(f=e-1,r!==u&&(f=v(r),f=r<0?dr(e+f,0):tf(f,e-1)),gi(n,i(t,3),f,!0)):-1}function kd(n){var t=n==null?0:n.length;return t?uu(n,1):[]}function det(n){var t=n==null?0:n.length;return t?uu(n,ht):[]}function get(n,t){var i=n==null?0:n.length;return i?(t=t===u?1:v(t),uu(n,t)):[]}function not(n){for(var i=-1,u=n==null?0:n.length,r={},t;++i<u;)t=n[i],r[t[0]]=t[1];return r}function dd(n){return n&&n.length?n[0]:u}function tot(n,t,i){var u=n==null?0:n.length,r;return u?(r=i==null?0:v(i),r<0&&(r=dr(u+r,0)),bt(n,t,r)):-1}function iot(n){var t=n==null?0:n.length;return t?pf(n,0,-1):[]}function eot(n,t){return n==null?"":iit.call(n,t)}function wf(n){var t=n==null?0:n.length;return t?n[t-1]:u}function oot(n,t,i){var f=n==null?0:n.length,r;return f?(r=f,i!==u&&(r=v(i),r=r<0?dr(f+r,0):tf(r,f-1)),t===t?vc(n,t,r):gi(n,ce,r,!0)):-1}function sot(n,t){return n&&n.length?wb(n,v(t)):u}function ng(n,t){return n&&n.length&&t&&t.length?dy(n,t):n}function hot(n,t,r){return n&&n.length&&t&&t.length?dy(n,t,i(r,2)):n}function cot(n,t,i){return n&&n.length&&t&&t.length?dy(n,t,u,i):n}function lot(n,t){var u=[],f;if(!(n&&n.length))return u;var r=-1,e=[],o=n.length;for(t=i(t,3);++r<o;)f=n[r],t(f,r,n)&&(u.push(f),e.push(r));return db(n,e),u}function kp(n){return n==null?n:eit.call(n)}function aot(n,t,i){var r=n==null?0:n.length;return r?(i&&typeof i!="number"&&ff(n,t,i)?(t=0,i=r):(t=t==null?0:v(t),i=i===u?r:v(i)),pf(n,t,i)):[]}function vot(n,t){return fv(n,t)}function yot(n,t,r){return ip(n,t,i(r,2))}function pot(n,t){var r=n==null?0:n.length,i;return r&&(i=fv(n,t),i<r&&df(n[i],t))?i:-1}function wot(n,t){return fv(n,t,!0)}function bot(n,t,r){return ip(n,t,i(r,2),!0)}function kot(n,t){var r=n==null?0:n.length,i;return r&&(i=fv(n,t,!0)-1,df(n[i],t))?i:-1}function dot(n){return n&&n.length?nk(n):[]}function got(n,t){return n&&n.length?nk(n,i(t,2)):[]}function nst(n){var t=n==null?0:n.length;return t?pf(n,1,t):[]}function tst(n,t,i){return(n&&n.length)?(t=i||t===u?1:v(t),pf(n,0,t<0?0:t)):[]}function ist(n,t,i){var r=n==null?0:n.length;return r?(t=i||t===u?1:v(t),t=r-t,pf(n,t<0?0:t,r)):[]}function rst(n,t){return n&&n.length?ev(n,i(t,3),!1,!0):[]}function ust(n,t){return n&&n.length?ev(n,i(t,3)):[]}function sst(n){return n&&n.length?kh(n):[]}function hst(n,t){return n&&n.length?kh(n,i(t,2)):[]}function cst(n,t){return t=typeof t=="function"?t:u,n&&n.length?kh(n,u,t):[]}function dp(n){if(!(n&&n.length))return[];var t=0;return n=ft(n,function(n){if(br(n))return t=dr(n.length,t),!0}),eu(t,function(t){return o(n,ru(t))})}function ig(n,t){if(!(n&&n.length))return[];var i=dp(n);return t==null?i:o(i,function(n){return h(t,u,n)})}function wst(n,t){return uk(n||[],t||[],bl)}function bst(n,t){return uk(n||[],t||[],na)}function ug(n){var i=t(n);return i.__chain__=!0,i}function kst(n,t){return t(n),n}function wv(n,t){return t(n)}function dst(){return ug(this)}function gst(){return new vf(this.value(),this.__chain__)}function nht(){this.__values__===u&&(this.__values__=hn(this.value()));var n=this.__index__>=this.__values__.length,t=n?u:this.__values__[this.__index__++];return{done:n,value:t}}function tht(){return this}function iht(n){for(var r,i=this,t,f;i instanceof ga;)t=pd(i),t.__index__=0,t.__values__=u,r?f.__wrapped__=t:r=t,f=t,i=i.__wrapped__;return f.__wrapped__=n,r}function rht(){var t=this.__wrapped__,n;return t instanceof wi?(n=t,this.__actions__.length&&(n=new wi(this)),n=n.reverse(),n.__actions__.push({func:wv,args:[kp],thisArg:u}),new vf(n,this.__chain__)):this.thru(kp)}function uht(){return rk(this.__wrapped__,this.__actions__)}function fht(n,t,f){var e=r(n)?oe:nut;return f&&ff(n,t,f)&&(t=u),e(n,i(t,3))}function eht(n,t){var u=r(n)?ft:sb;return u(n,i(t,3))}function oht(n,t){return uu(bv(n,t),1)}function sht(n,t){return uu(bv(n,t),ht)}function hht(n,t,i){return i=i===u?1:v(i),uu(bv(n,t),i)}function hg(n,t){var u=r(n)?y:uh;return u(n,i(t,3))}function cg(n,t){var u=r(n)?gh:ly;return u(n,i(t,3))}function cht(n,t,i,r){n=of(n)?n:cl(n);i=i&&!r?v(i):0;var u=n.length;return i<0&&(i=dr(u+i,0)),iy(n)?i<=u&&n.indexOf(t,i)>-1:!!u&&bt(n,t,i)>-1}function bv(n,t){var u=r(n)?o:vb;return u(n,i(t,3))}function lht(n,t,i,f){return n==null?[]:(r(t)||(t=t==null?[]:[t]),i=f?u:i,r(i)||(i=i==null?[]:[i]),bb(n,t,i))}function aht(n,t,u){var f=r(n)?tu:ae,e=arguments.length<3;return f(n,i(t,4),u,e,uh)}function vht(n,t,u){var f=r(n)?nc:ae,e=arguments.length<3;return f(n,i(t,4),u,e,ly)}function yht(n,t){var u=r(n)?ft:sb;return u(n,gv(i(t,3)))}function pht(n){var t=r(n)?ub:kut;return t(n)}function wht(n,t,i){t=(i?ff(n,t,i):t===u)?1:v(t);var f=r(n)?wrt:dut;return f(n,t)}function bht(n){var t=r(n)?brt:gut;return t(n)}function kht(n){if(n==null)return 0;if(of(n))return iy(n)?dt(n):n.length;var t=rf(n);return t==p||t==w?n.size:by(n).length}function dht(n,t,f){var e=r(n)?iu:nft;return f&&ff(n,t,f)&&(t=u),e(n,i(t,3))}function ght(n,t){if(typeof t!="function")throw new af(l);return n=v(n),function(){if(--n<1)return t.apply(this,arguments)}}function wg(n,t,i){return t=i?u:t,t=n&&t==null?n.length:t,fh(n,nt,u,u,u,u,t)}function bg(n,t){var i;if(typeof t!="function")throw new af(l);return n=v(n),function(){return--n>0&&(i=t.apply(this,arguments)),n<=1&&(t=u),i}}function kg(n,t,i){t=i?u:t;var r=fh(n,k,u,u,u,u,u,t);return r.placeholder=kg.placeholder,r}function dg(n,t,i){t=i?u:t;var r=fh(n,at,u,u,u,u,u,t);return r.placeholder=dg.placeholder,r}function gg(n,t,i){function p(t){var i=e,r=s;return e=s=u,h=t,o=n.apply(r,i)}function g(n){return h=n,r=ra(v,t),b?p(n):o}function nt(n){var r=n-f,u=n-h,i=t-r;return c?tf(i,a-u):i}function k(n){var i=n-f,r=n-h;return f===u||i>=t||i<0||c&&r>=a}function v(){var n=ua();if(k(n))return d(n);r=ra(v,nt(n))}function d(n){return(r=u,y&&e)?p(n):(e=s=u,o)}function tt(){r!==u&&ek(r);h=0;e=f=s=r=u}function it(){return r===u?o:d(ua())}function w(){var n=ua(),i=k(n);if(e=arguments,s=this,f=n,i){if(r===u)return g(f);if(c)return r=ra(v,t),p(f)}return r===u&&(r=ra(v,t)),o}var e,s,a,o,r,f,h=0,b=!1,c=!1,y=!0;if(typeof n!="function")throw new af(l);return t=bf(t)||0,pr(i)&&(b=!!i.leading,c="maxWait"in i,a=c?dr(bf(i.maxWait)||0,t):a,y="trailing"in i?!!i.trailing:y),w.cancel=tt,w.flush=it,w}function nct(n){return fh(n,rr)}function dv(n,t){if(typeof n!="function"||t!=null&&typeof t!="function")throw new af(l);var i=function(){var u=arguments,f=t?t.apply(this,u):u[0],r=i.cache,e;return r.has(f)?r.get(f):(e=n.apply(this,u),i.cache=r.set(f,e)||r,e)};return i.cache=new(dv.Cache||ih),i}function gv(n){if(typeof n!="function")throw new af(l);return function(){var t=arguments;switch(t.length){case 0:return!n.call(this);case 1:return!n.call(this,t[0]);case 2:return!n.call(this,t[0],t[1]);case 3:return!n.call(this,t[0],t[1],t[2])}return!n.apply(this,t)}}function tct(n){return bg(2,n)}function uct(n,t){if(typeof n!="function")throw new af(l);return t=t===u?t:v(t),wt(n,t)}function fct(n,t){if(typeof n!="function")throw new af(l);return t=t==null?0:dr(v(t),0),wt(function(i){var r=i[t],u=ac(i,0,t);return r&&et(u,r),h(n,this,u)})}function ect(n,t,i){var r=!0,u=!0;if(typeof n!="function")throw new af(l);return pr(i)&&(r="leading"in i?!!i.leading:r,u="trailing"in i?!!i.trailing:u),gg(n,t,{leading:r,maxWait:t,trailing:u})}function oct(n){return wg(n,1)}function sct(n,t){return nw(ep(t),n)}function hct(){if(!arguments.length)return[];var n=arguments[0];return r(n)?n:[n]}function cct(n){return yf(n,ct)}function lct(n,t){return t=typeof t=="function"?t:u,yf(n,ct,t)}function act(n){return yf(n,rt|ct)}function vct(n,t){return t=typeof t=="function"?t:u,yf(n,rt|ct,t)}function yct(n,t){return t==null||eb(n,t,gr(t))}function df(n,t){return n===t||n!==n&&t!==t}function of(n){return n!=null&&ny(n.length)&&!lh(n)}function br(n){return wr(n)&&of(n)}function kct(n){return n===!0||n===!1||wr(n)&&uf(n)==ni}function dct(n){return wr(n)&&n.nodeType===1&&!fa(n)}function gct(n){var t,i;if(n==null)return!0;if(of(n)&&(r(n)||typeof n=="string"||typeof n.splice=="function"||ch(n)||il(n)||tl(n)))return!n.length;if(t=rf(n),t==p||t==w)return!n.size;if(ia(n))return!by(n).length;for(i in n)if(ki.call(n,i))return!1;return!0}function nlt(n,t){return gl(n,t)}function tlt(n,t,i){i=typeof i=="function"?i:u;var r=i?i(n,t):u;return r===u?gl(n,t,u,i):!!r}function tw(n){if(!wr(n))return!1;var t=uf(n);return t==ai||t==ao||typeof n.message=="string"&&typeof n.name=="string"&&!fa(n)}function ilt(n){return typeof n=="number"&&tit(n)}function lh(n){if(!pr(n))return!1;var t=uf(n);return t==vi||t==yu||t==lo||t==yo}function fn(n){return typeof n=="number"&&n==v(n)}function ny(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=ut}function pr(n){var t=typeof n;return n!=null&&(t=="object"||t=="function")}function wr(n){return n!=null&&typeof n=="object"}function rlt(n,t){return n===t||wy(n,t,ap(t))}function ult(n,t,i){return i=typeof i=="function"?i:u,wy(n,t,ap(t),i)}function flt(n){return en(n)&&n!=+n}function elt(n){if(od(n))throw new pw(ge);return lb(n)}function olt(n){return n===null}function slt(n){return n==null}function en(n){return typeof n=="number"||wr(n)&&uf(n)==ii}function fa(n){var i,t;return!wr(n)||uf(n)!=tt?!1:(i=va(n),i===null)?!0:(t=ki.call(i,"constructor")&&i.constructor,typeof t=="function"&&t instanceof t&&ha.call(t)==ptt)}function hlt(n){return fn(n)&&n>=-ut&&n<=ut}function iy(n){return typeof n=="string"||!r(n)&&wr(n)&&uf(n)==ui}function lf(n){return typeof n=="symbol"||wr(n)&&uf(n)==yi}function clt(n){return n===u}function llt(n){return wr(n)&&rf(n)==fi}function alt(n){return wr(n)&&uf(n)==wo}function hn(n){if(!n)return[];if(of(n))return iy(n)?b(n):ef(n);if(ll&&n[ll])return cc(n[ll]());var t=rf(n),i=t==p?su:t==w?nr:cl;return i(n)}function ah(n){if(!n)return n===0?n:0;if(n=bf(n),n===ht||n===-ht){var t=n<0?-1:1;return t*oo}return n===n?n:0}function v(n){var t=ah(n),i=t%1;return t===t?i?t-i:t:0}function cn(n){return n?dc(v(n),0,g):0}function bf(n){var t,i;return typeof n=="number"?n:lf(n)?ci:(pr(n)&&(t=typeof n.valueOf=="function"?n.valueOf():n,n=pr(t)?t+"":t),typeof n!="string")?n===0?n:+n:(n=n.replace(du,""),i=ws.test(n),i||ks.test(n)?bh(n.slice(2),i?2:8):ps.test(n)?ci:+n)}function ln(n){return se(n,sf(n))}function vlt(n){return n?dc(v(n),-ut,ut):n===0?n:0}function bi(n){return n==null?"":cf(n)}function blt(n,t){var i=pc(n);return t==null?i:fb(i,t)}function klt(n,t){return he(n,i(t,3),gf)}function dlt(n,t){return he(n,i(t,3),vy)}function glt(n,t){return n==null?n:iv(n,i(t,3),sf)}function nat(n,t){return n==null?n:ay(n,i(t,3),sf)}function tat(n,t){return n&&gf(n,i(t,3))}function iat(n,t){return n&&vy(n,i(t,3))}function rat(n){return n==null?[]:rv(n,gr(n))}function uat(n){return n==null?[]:rv(n,sf(n))}function uw(n,t,i){var r=n==null?u:el(n,t);return r===u?i:r}function fat(n,t){return n!=null&&fd(n,t,iut)}function fw(n,t){return n!=null&&fd(n,t,rut)}function gr(n){return of(n)?rb(n):by(n)}function sf(n){return of(n)?rb(n,!0):vut(n)}function hat(n,t){var r={};return t=i(t,3),gf(n,function(n,i,u){rh(r,t(n,i,u),n)}),r}function cat(n,t){var r={};return t=i(t,3),gf(n,function(n,i,u){rh(r,i,t(n,i,u))}),r}function vat(n,t){return bn(n,gv(i(t)))}function bn(n,t){if(n==null)return{};var r=o(lp(n),function(n){return[n]});return t=i(t),kb(n,r,function(n,i){return t(n,i[0])})}function yat(n,t,i){var e,f,r;for(t=tc(t,n),e=-1,f=t.length,f||(f=1,n=u);++e<f;)r=n==null?u:n[as(t[e])],r===u&&(e=f,r=i),n=lh(r)?r.call(n):r;return n}function pat(n,t,i){return n==null?n:na(n,t,i)}function wat(n,t,i,r){return r=typeof r=="function"?r:u,n==null?n:na(n,t,i,r)}function bat(n,t,u){var e=r(n),o=e||ch(n)||il(n),f;return t=i(t,4),u==null&&(f=n&&n.constructor,u=o?e?new f:[]:pr(n)?lh(f)?pc(va(n)):{}:{}),(o?y:gf)(n,function(n,i,r){return t(u,n,i,r)}),u}function kat(n,t){return n==null?!0:rp(n,t)}function dat(n,t,i){return n==null?n:ik(n,t,ep(i))}function gat(n,t,i,r){return r=typeof r=="function"?r:u,n==null?n:ik(n,t,ep(i),r)}function cl(n){return n==null?[]:ou(n,gr(n))}function nvt(n){return n==null?[]:ou(n,sf(n))}function tvt(n,t,i){return i===u&&(i=t,t=u),i!==u&&(i=bf(i),i=i===i?i:0),t!==u&&(t=bf(t),t=t===t?t:0),dc(bf(n),t,i)}function ivt(n,t,i){return t=ah(t),i===u?(i=t,t=0):i=ah(i),n=bf(n),uut(n,t,i)}function rvt(n,t,i){var f,r;return(i&&typeof i!="boolean"&&ff(n,t,i)&&(t=i=u),i===u&&(typeof t=="boolean"?(i=t,t=u):typeof n=="boolean"&&(i=n,n=u)),n===u&&t===u?(n=0,t=1):(n=ah(n),t===u?(t=n,n=0):t=ah(t)),n>t&&(f=n,n=t,t=f),i||n%1||t%1)?(r=tb(),tf(n+r*(t-n+wh("1e-"+((r+"").length-1))),t)):gy(n,t)}function dn(n){return uy(bi(n).toLowerCase())}function gn(n){return n=bi(n),n&&n.replace(gs,pe).replace(hh,"")}function uvt(n,t,i){var r,f;return n=bi(n),t=cf(t),r=n.length,i=i===u?r:dc(v(i),0,r),f=i,i-=t.length,i>=0&&n.slice(i,f)==t}function fvt(n){return n=bi(n),n&&ts.test(n)?n.replace(bu,we):n}function evt(n){return n=bi(n),n&&os.test(n)?n.replace(vr,"\\$&"):n}function cvt(n,t,i){var r,u;return(n=bi(n),t=v(t),r=t?dt(n):0,!t||r>=t)?n:(u=(t-r)/2,cv(ba(u),i)+n+cv(wa(u),i))}function lvt(n,t,i){n=bi(n);t=v(t);var r=t?dt(n):0;return t&&r<t?n+cv(t-r,i):n}function avt(n,t,i){n=bi(n);t=v(t);var r=t?dt(n):0;return t&&r<t?cv(t-r,i)+n:n}function vvt(n,t,i){return i||t==null?t=0:t&&(t=+t),fit(bi(n).replace(gu,""),t||0)}function yvt(n,t,i){return t=(i?ff(n,t,i):t===u)?1:v(t),np(bi(n),t)}function pvt(){var n=arguments,t=bi(n[0]);return n.length<3?t:t.replace(n[1],n[2])}function wvt(n,t,i){return(i&&typeof i!="number"&&ff(n,t,i)&&(t=i=u),i=i===u?g:i>>>0,!i)?[]:(n=bi(n),n&&(typeof t=="string"||t!=null&&!ty(t))&&(t=cf(t),!t&&kt(n)))?ac(b(n),0,i):n.split(t,i)}function bvt(n,t,i){return n=bi(n),i=i==null?0:dc(v(i),0,n.length),t=cf(t),n.slice(i,i+t.length)==t}function kvt(n,i,r){var h=t.templateSettings,o,e;r&&ff(n,i,r)&&(i=u);n=bi(n);i=ry({},i,h,td);var c=ry({},i.imports,h.imports,td),l=gr(c),p=ou(c,l),a,s,v=0,y=i.interpolate||pi,f="__p += '",w=fy((i.escape||pi).source+"|"+y.source+"|"+(y===ku?ys:pi).source+"|"+(i.evaluate||pi).source+"|$","g"),b="//# sourceURL="+("sourceURL"in i?i.sourceURL:"lodash.templateSources["+ ++yh+"]")+"\n";if(n.replace(w,function(t,i,r,u,e,o){return r||(r=u),f+=n.slice(v,o).replace(nh,oc),i&&(a=!0,f+="' +\n__e("+i+") +\n'"),e&&(s=!0,f+="';\n"+e+";\n__p += '"),r&&(f+="' +\n((__t = ("+r+")) == null ? '' : __t) +\n'"),v=o+t.length,t}),f+="';\n",o=i.variable,o||(f="with (obj) {\n"+f+"\n}\n"),f=(s?f.replace(bo,""):f).replace(ko,"$1").replace(go,"$1;"),f="function("+(o||"obj")+") {\n"+(o?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(a?", __e = _.escape":"")+(s?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+f+"return __p\n}",e=sw(function(){return ww(l,b+"return "+f).apply(u,p)}),e.source=f,tw(e))throw e;return e}function dvt(n){return bi(n).toLowerCase()}function gvt(n){return bi(n).toUpperCase()}function nyt(n,t,i){if(n=bi(n),n&&(i||t===u))return n.replace(du,"");if(!n||!(t=cf(t)))return n;var r=b(n),f=b(t),e=ve(r,f),o=ye(r,f)+1;return ac(r,e,o).join("")}function tyt(n,t,i){if(n=bi(n),n&&(i||t===u))return n.replace(ss,"");if(!n||!(t=cf(t)))return n;var r=b(n),f=ye(r,b(t))+1;return ac(r,0,f).join("")}function iyt(n,t,i){if(n=bi(n),n&&(i||t===u))return n.replace(gu,"");if(!n||!(t=cf(t)))return n;var r=b(n),f=ve(r,b(t));return ac(r,f).join("")}function ryt(n,t){var s=to,e=io,i,h,o,r,f,a,y,c,l;if(pr(t)&&(i="separator"in t?t.separator:i,s="length"in t?v(t.length):s,e="omission"in t?cf(t.omission):e),n=bi(n),h=n.length,kt(n)&&(o=b(n),h=o.length),s>=h)return n;if(r=s-dt(e),r<1)return e;if(f=o?ac(o,0,r).join(""):n.slice(0,r),i===u)return f+e;if(o&&(r+=f.length-r),ty(i)){if(n.slice(r).search(i)){for(y=f,i.global||(i=fy(i.source,bi(nf.exec(i))+"g")),i.lastIndex=0;a=i.exec(y);)c=a.index;f=f.slice(0,c===u?r:c)}}else n.indexOf(cf(i),r)!=r&&(l=f.lastIndexOf(i),l>-1&&(f=f.slice(0,l)));return f+e}function uyt(n){return n=bi(n),n&&ns.test(n)?n.replace(wu,ke):n}function rtt(n,t,i){return(n=bi(n),t=i?u:t,t===u)?hc(n)?wc(n):ic(n):n.match(t)||[]}function fyt(n){var t=n==null?0:n.length,r=i();return n=t?o(n,function(n){if(typeof n[1]!="function")throw new af(l);return[r(n[0]),n[1]]}):[],wt(function(i){for(var u=-1,r;++u<t;)if(r=n[u],h(r[0],this,i))return h(r[1],this,i)})}function eyt(n){return grt(yf(n,rt))}function hw(n){return function(){return n}}function oyt(n,t){return n==null||n!==n?t:n}function hf(n){return n}function cw(n){return ab(typeof n=="function"?n:yf(n,rt))}function syt(n){return yb(yf(n,rt))}function hyt(n,t){return pb(n,yf(t,rt))}function lw(n,t,i){var u=gr(t),r=rv(t,u),f,e;return i!=null||pr(t)&&(r.length||!u.length)||(i=t,t=n,n=this,r=rv(t,gr(t))),f=!(pr(i)&&"chain"in i)||!!i.chain,e=lh(n),y(r,function(i){var r=t[i];n[i]=r;e&&(n.prototype[i]=function(){var i=this.__chain__,t,u;return f||i?(t=n(this.__wrapped__),u=t.__actions__=ef(this.__actions__),u.push({func:r,args:arguments,thisArg:n}),t.__chain__=i,t):r.apply(n,et([this.value()],arguments))})}),n}function cyt(){return s._===this&&(s._=wtt),this}function aw(){}function lyt(n){return n=v(n),wt(function(t){return wb(t,n)})}function htt(n){return yp(n)?ru(as(n)):wut(n)}function pyt(n){return function(t){return n==null?u:el(n,t)}}function vw(){return[]}function yw(){return!1}function wyt(){return{}}function byt(){return""}function kyt(){return!0}function dyt(n,t){var r,u,f;if(n=v(n),n<1||n>ut)return[];for(r=g,u=tf(n,g),t=i(t),n-=g,f=eu(u,t);++r<n;)t(r);return f}function gyt(n){return r(n)?o(n,as):lf(n)?[n]:ef(bp(bi(n)))}function npt(n){var t=++ytt;return bi(n)+t}function fpt(n){return n&&n.length?tv(n,hf,yy):u}function ept(n,t){return n&&n.length?tv(n,i(t,2),yy):u}function opt(n){return le(n,hf)}function spt(n,t){return le(n,i(t,2))}function hpt(n){return n&&n.length?tv(n,hf,ky):u}function cpt(n,t){return n&&n.length?tv(n,i(t,2),ky):u}function ypt(n){return n&&n.length?fu(n,hf):0}function ppt(n,t){return n&&n.length?fu(n,i(t,2)):0}var pc,uh,ly,iv,ay,tp,gb,fk,ek,gk,av,od,bp,gd,tg,rg,fg,eg,og,sg,lg,ag,vg,yg,pg,ua,kv,gp,nn,tn,ch,un,iw,ty,rw,il,on,sn,vn,yn,wn,ew,ow,kn,ntt,ttt,itt,uy,sw,utt,ftt,ett,ott,stt,ctt,ltt;n=n==null?s:it.defaults(s.Object(),n,it.pick(s,vh));var kr=n.Array,ea=n.Date,pw=n.Error,ww=n.Function,rl=n.Math,yr=n.Object,fy=n.RegExp,att=n.String,af=n.TypeError,oa=kr.prototype,vtt=ww.prototype,ul=yr.prototype,sa=n["__core-js_shared__"],ha=vtt.toString,ki=ul.hasOwnProperty,ytt=0,bw=function(){var n=/[^.]+$/.exec(sa&&sa.keys&&sa.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""}(),ca=ul.toString,ptt=ha.call(yr),wtt=s._,btt=fy("^"+ha.call(ki).replace(vr,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),la=ne?n.Buffer:u,ph=n.Symbol,aa=n.Uint8Array,kw=la?la.allocUnsafe:u,va=be(yr.getPrototypeOf,yr),dw=yr.create,gw=ul.propertyIsEnumerable,ya=oa.splice,nb=ph?ph.isConcatSpreadable:u,ll=ph?ph.iterator:u,yc=ph?ph.toStringTag:u,pa=function(){try{var n=gc(yr,"defineProperty");return n({},"",{}),n}catch(t){}}(),ktt=n.clearTimeout!==s.clearTimeout&&n.clearTimeout,dtt=ea&&ea.now!==s.Date.now&&ea.now,gtt=n.setTimeout!==s.setTimeout&&n.setTimeout,wa=rl.ceil,ba=rl.floor,ey=yr.getOwnPropertySymbols,nit=la?la.isBuffer:u,tit=n.isFinite,iit=oa.join,rit=be(yr.keys,yr),dr=rl.max,tf=rl.min,uit=ea.now,fit=n.parseInt,tb=rl.random,eit=oa.reverse,oy=gc(n,"DataView"),al=gc(n,"Map"),sy=gc(n,"Promise"),fl=gc(n,"Set"),vl=gc(n,"WeakMap"),yl=gc(yr,"create"),ka=vl&&new vl,pl={},oit=nl(oy),sit=nl(al),hit=nl(sy),cit=nl(fl),lit=nl(vl),da=ph?ph.prototype:u,wl=da?da.valueOf:u,ib=da?da.toString:u;pc=function(){function n(){}return function(t){if(!pr(t))return{};if(dw)return dw(t);n.prototype=t;var i=new n;return n.prototype=u,i}}();t.templateSettings={escape:is,evaluate:rs,interpolate:ku,variable:"",imports:{_:t}};t.prototype=ga.prototype;t.prototype.constructor=t;vf.prototype=pc(ga.prototype);vf.prototype.constructor=vf;wi.prototype=pc(ga.prototype);wi.prototype.constructor=wi;bc.prototype.clear=pit;bc.prototype["delete"]=wit;bc.prototype.get=bit;bc.prototype.has=kit;bc.prototype.set=dit;th.prototype.clear=git;th.prototype["delete"]=nrt;th.prototype.get=trt;th.prototype.has=irt;th.prototype.set=rrt;ih.prototype.clear=urt;ih.prototype["delete"]=frt;ih.prototype.get=ert;ih.prototype.has=ort;ih.prototype.set=srt;kc.prototype.add=kc.prototype.push=hrt;kc.prototype.has=crt;kf.prototype.clear=lrt;kf.prototype["delete"]=art;kf.prototype.get=vrt;kf.prototype.has=yrt;kf.prototype.set=prt;uh=ak(gf);ly=ak(vy,!0);iv=vk();ay=vk(!0);tp=ka?function(n,t){return ka.set(n,t),n}:hf;gb=pa?function(n,t){return pa(n,"toString",{configurable:!0,enumerable:!1,value:hw(t),writable:!0})}:hf;fk=wt;ek=ktt||function(n){return s.clearTimeout(n)};gk=(fl&&1/nr(new fl([,-0]))[1]==ht)?function(n){return new fl(n)}:aw;av=ka?function(n){return ka.get(n)}:aw;var vp=ey?function(n){return n==null?[]:(n=yr(n),ft(ey(n),function(t){return gw.call(n,t)}))}:vw,ud=ey?function(n){for(var t=[];n;)et(t,vp(n)),n=va(n);return t}:vw,rf=uf;(oy&&rf(new oy(new ArrayBuffer(1)))!=pt||al&&rf(new al)!=p||sy&&rf(sy.resolve())!=pu||fl&&rf(new fl)!=w||vl&&rf(new vl)!=fi)&&(rf=function(n){var t=uf(n),i=t==tt?n.constructor:u,r=i?nl(i):"";if(r)switch(r){case oit:return pt;case sit:return p;case hit:return pu;case cit:return w;case lit:return fi}return t});od=sa?lh:yw;var ad=yd(tp),ra=gtt||function(n,t){return s.setTimeout(n,t)},wp=yd(gb);bp=tet(function(n){var t=[];return n.charCodeAt(0)===46&&t.push(""),n.replace(es,function(n,i,r,u){t.push(r?u.replace(vs,"$1"):i||n)}),t});var cet=wt(function(n,t){return br(n)?kl(n,uu(t,1,br,!0)):[]}),aet=wt(function(n,t){var r=wf(t);return br(r)&&(r=u),br(n)?kl(n,uu(t,1,br,!0),i(r,2)):[]}),vet=wt(function(n,t){var i=wf(t);return br(i)&&(i=u),br(n)?kl(n,uu(t,1,br,!0),u,i):[]});var rot=wt(function(n){var t=o(n,fp);return t.length&&t[0]===n[0]?py(t):[]}),uot=wt(function(n){var r=wf(n),t=o(n,fp);return r===wf(t)?r=u:t.pop(),t.length&&t[0]===n[0]?py(t,i(r,2)):[]}),fot=wt(function(n){var t=wf(n),i=o(n,fp);return t=typeof t=="function"?t:u,t&&i.pop(),i.length&&i[0]===n[0]?py(i,u,t):[]});gd=wt(ng);tg=eh(function(n,t){var i=n==null?0:n.length,r=cy(n,t);return db(n,o(t,function(n){return oh(n,i)?+n:n}).sort(hk)),r});var fst=wt(function(n){return kh(uu(n,1,br,!0))}),est=wt(function(n){var t=wf(n);return br(t)&&(t=u),kh(uu(n,1,br,!0),i(t,2))}),ost=wt(function(n){var t=wf(n);return t=typeof t=="function"?t:u,kh(uu(n,1,br,!0),u,t)});var lst=wt(function(n,t){return br(n)?kl(n,t):[]}),ast=wt(function(n){return up(ft(n,br))}),vst=wt(function(n){var t=wf(n);return br(t)&&(t=u),up(ft(n,br),i(t,2))}),yst=wt(function(n){var t=wf(n);return t=typeof t=="function"?t:u,up(ft(n,br),u,t)}),pst=wt(dp);rg=wt(function(n){var i=n.length,t=i>1?n[i-1]:u;return t=typeof t=="function"?(n.pop(),t):u,ig(n,t)});fg=eh(function(n){var i=n.length,r=i?n[0]:0,t=this.__wrapped__,f=function(t){return cy(t,n)};return i>1||this.__actions__.length||!(t instanceof wi)||!oh(r)?this.thru(f):(t=t.slice(r,+r+(i?1:0)),t.__actions__.push({func:wv,args:[f],thisArg:u}),new vf(t,this.__chain__).thru(function(n){return i&&!n.length&&n.push(u),n}))});eg=ov(function(n,t,i){ki.call(n,i)?++n[i]:rh(n,i,1)});og=pk(wd);sg=pk(bd);lg=ov(function(n,t,i){ki.call(n,i)?n[i].push(t):rh(n,i,[t])});ag=wt(function(n,t,i){var u=-1,f=typeof t=="function",r=of(n)?kr(n.length):[];return uh(n,function(n){r[++u]=f?h(t,n,i):dl(n,t,i)}),r});vg=ov(function(n,t,i){rh(n,i,t)});yg=ov(function(n,t,i){n[i?0:1].push(t)},function(){return[[],[]]});pg=wt(function(n,t){if(n==null)return[];var i=t.length;return i>1&&ff(n,t[0],t[1])?t=[]:i>2&&ff(t[0],t[1],t[2])&&(t=[t[0]]),bb(n,uu(t,1),[])});ua=dtt||function(){return s.Date.now()};kv=wt(function(n,t,i){var r=a,u;return i.length&&(u=ot(i,hl(kv)),r|=d),fh(n,r,t,i,u)});gp=wt(function(n,t,i){var r=a|st,u;return i.length&&(u=ot(i,hl(gp)),r|=d),fh(t,r,n,i,u)});nn=wt(function(n,t){return ob(n,1,t)});tn=wt(function(n,t,i){return ob(n,bf(t)||0,i)});dv.Cache=ih;var ict=fk(function(n,t){t=t.length==1&&r(t[0])?o(t[0],c(i())):o(uu(t,1),c(i()));var u=t.length;return wt(function(i){for(var r=-1,f=tf(i.length,u);++r<f;)i[r]=t[r].call(this,i[r]);return h(n,this,i)})}),nw=wt(function(n,t){var i=ot(t,hl(nw));return fh(n,d,u,t,i)}),rn=wt(function(n,t){var i=ot(t,hl(rn));return fh(n,vt,u,t,i)}),rct=eh(function(n,t){return fh(n,gt,u,u,u,t)});var pct=lv(yy),wct=lv(function(n,t){return n>=t}),tl=cb(function(){return arguments}())?cb:function(n){return wr(n)&&ki.call(n,"callee")&&!gw.call(n,"callee")},r=kr.isArray,bct=te?c(te):eut;ch=nit||yw;un=ie?c(ie):out;iw=re?c(re):hut;ty=ue?c(ue):cut;rw=fe?c(fe):lut;il=ee?c(ee):aut;on=lv(ky);sn=lv(function(n,t){return n<=t});var ylt=ol(function(n,t){if(ia(t)||of(t)){se(t,gr(t),n);return}for(var i in t)ki.call(t,i)&&bl(n,i,t[i])}),an=ol(function(n,t){se(t,sf(t),n)}),ry=ol(function(n,t,i,r){se(t,sf(t),n,r)}),plt=ol(function(n,t,i,r){se(t,gr(t),n,r)}),wlt=eh(cy);vn=wt(function(n,t){var i,f;n=yr(n);var e=-1,r=t.length,o=r>2?t[2]:u;for(o&&ff(t[0],t[1],o)&&(r=1);++e<r;)for(var s=t[e],h=sf(s),c=-1,l=h.length;++c<l;)i=h[c],f=n[i],(f===u||df(f,ul[i])&&!ki.call(n,i))&&(n[i]=s[i]);return n});yn=wt(function(n){return n.push(u,id),h(pn,u,n)});var eat=bk(function(n,t,i){t!=null&&typeof t.toString!="function"&&(t=ca.call(t));n[t]=i},hw(hf)),oat=bk(function(n,t,i){t!=null&&typeof t.toString!="function"&&(t=ca.call(t));ki.call(n,t)?n[t].push(i):n[t]=[i]},i),sat=wt(dl);var lat=ol(function(n,t,i){uv(n,t,i)}),pn=ol(function(n,t,i,r){uv(n,t,i,r)}),aat=eh(function(n,t){var i={},r,u;if(n==null)return i;for(r=!1,t=o(t,function(t){return t=tc(t,n),r||(r=t.length>1),t}),se(n,lp(n),i),r&&(i=yf(i,rt|lu|ct,cft)),u=t.length;u--;)rp(i,t[u]);return i});wn=eh(function(n,t){return n==null?{}:put(n,t)});ew=nd(gr);ow=nd(sf);kn=sl(function(n,t,i){return t=t.toLowerCase(),n+(i?dn(t):t)});var ovt=sl(function(n,t,i){return n+(i?"-":"")+t.toLowerCase()}),svt=sl(function(n,t,i){return n+(i?" ":"")+t.toLowerCase()}),hvt=yk("toLowerCase");ntt=sl(function(n,t,i){return n+(i?"_":"")+t.toLowerCase()});ttt=sl(function(n,t,i){return n+(i?" ":"")+uy(t)});itt=sl(function(n,t,i){return n+(i?" ":"")+t.toUpperCase()});uy=yk("toUpperCase");sw=wt(function(n,t){try{return h(n,u,t)}catch(i){return tw(i)?i:new pw(i)}});utt=eh(function(n,t){return y(t,function(t){t=as(t);rh(n,t,kv(n[t],n))}),n});ftt=wk();ett=wk(!0);ott=wt(function(n,t){return function(i){return dl(i,n,t)}});stt=wt(function(n,t){return function(i){return dl(n,i,t)}});var ayt=sp(o),vyt=sp(oe),yyt=sp(iu);ctt=kk();ltt=kk(!0);var tpt=hv(function(n,t){return n+t},0),ipt=hp("ceil"),rpt=hv(function(n,t){return n/t},1),upt=hp("floor");var lpt=hv(function(n,t){return n*t},1),apt=hp("round"),vpt=hv(function(n,t){return n-t},0);return t.after=ght,t.ary=wg,t.assign=ylt,t.assignIn=an,t.assignInWith=ry,t.assignWith=plt,t.at=wlt,t.before=bg,t.bind=kv,t.bindAll=utt,t.bindKey=gp,t.castArray=hct,t.chain=ug,t.chunk=oet,t.compact=set,t.concat=het,t.cond=fyt,t.conforms=eyt,t.constant=hw,t.countBy=eg,t.create=blt,t.curry=kg,t.curryRight=dg,t.debounce=gg,t.defaults=vn,t.defaultsDeep=yn,t.defer=nn,t.delay=tn,t.difference=cet,t.differenceBy=aet,t.differenceWith=vet,t.drop=yet,t.dropRight=pet,t.dropRightWhile=wet,t.dropWhile=bet,t.fill=ket,t.filter=eht,t.flatMap=oht,t.flatMapDeep=sht,t.flatMapDepth=hht,t.flatten=kd,t.flattenDeep=det,t.flattenDepth=get,t.flip=nct,t.flow=ftt,t.flowRight=ett,t.fromPairs=not,t.functions=rat,t.functionsIn=uat,t.groupBy=lg,t.initial=iot,t.intersection=rot,t.intersectionBy=uot,t.intersectionWith=fot,t.invert=eat,t.invertBy=oat,t.invokeMap=ag,t.iteratee=cw,t.keyBy=vg,t.keys=gr,t.keysIn=sf,t.map=bv,t.mapKeys=hat,t.mapValues=cat,t.matches=syt,t.matchesProperty=hyt,t.memoize=dv,t.merge=lat,t.mergeWith=pn,t.method=ott,t.methodOf=stt,t.mixin=lw,t.negate=gv,t.nthArg=lyt,t.omit=aat,t.omitBy=vat,t.once=tct,t.orderBy=lht,t.over=ayt,t.overArgs=ict,t.overEvery=vyt,t.overSome=yyt,t.partial=nw,t.partialRight=rn,t.partition=yg,t.pick=wn,t.pickBy=bn,t.property=htt,t.propertyOf=pyt,t.pull=gd,t.pullAll=ng,t.pullAllBy=hot,t.pullAllWith=cot,t.pullAt=tg,t.range=ctt,t.rangeRight=ltt,t.rearg=rct,t.reject=yht,t.remove=lot,t.rest=uct,t.reverse=kp,t.sampleSize=wht,t.set=pat,t.setWith=wat,t.shuffle=bht,t.slice=aot,t.sortBy=pg,t.sortedUniq=dot,t.sortedUniqBy=got,t.split=wvt,t.spread=fct,t.tail=nst,t.take=tst,t.takeRight=ist,t.takeRightWhile=rst,t.takeWhile=ust,t.tap=kst,t.throttle=ect,t.thru=wv,t.toArray=hn,t.toPairs=ew,t.toPairsIn=ow,t.toPath=gyt,t.toPlainObject=ln,t.transform=bat,t.unary=oct,t.union=fst,t.unionBy=est,t.unionWith=ost,t.uniq=sst,t.uniqBy=hst,t.uniqWith=cst,t.unset=kat,t.unzip=dp,t.unzipWith=ig,t.update=dat,t.updateWith=gat,t.values=cl,t.valuesIn=nvt,t.without=lst,t.words=rtt,t.wrap=sct,t.xor=ast,t.xorBy=vst,t.xorWith=yst,t.zip=pst,t.zipObject=wst,t.zipObjectDeep=bst,t.zipWith=rg,t.entries=ew,t.entriesIn=ow,t.extend=an,t.extendWith=ry,lw(t,t),t.add=tpt,t.attempt=sw,t.camelCase=kn,t.capitalize=dn,t.ceil=ipt,t.clamp=tvt,t.clone=cct,t.cloneDeep=act,t.cloneDeepWith=vct,t.cloneWith=lct,t.conformsTo=yct,t.deburr=gn,t.defaultTo=oyt,t.divide=rpt,t.endsWith=uvt,t.eq=df,t.escape=fvt,t.escapeRegExp=evt,t.every=fht,t.find=og,t.findIndex=wd,t.findKey=klt,t.findLast=sg,t.findLastIndex=bd,t.findLastKey=dlt,t.floor=upt,t.forEach=hg,t.forEachRight=cg,t.forIn=glt,t.forInRight=nat,t.forOwn=tat,t.forOwnRight=iat,t.get=uw,t.gt=pct,t.gte=wct,t.has=fat,t.hasIn=fw,t.head=dd,t.identity=hf,t.includes=cht,t.indexOf=tot,t.inRange=ivt,t.invoke=sat,t.isArguments=tl,t.isArray=r,t.isArrayBuffer=bct,t.isArrayLike=of,t.isArrayLikeObject=br,t.isBoolean=kct,t.isBuffer=ch,t.isDate=un,t.isElement=dct,t.isEmpty=gct,t.isEqual=nlt,t.isEqualWith=tlt,t.isError=tw,t.isFinite=ilt,t.isFunction=lh,t.isInteger=fn,t.isLength=ny,t.isMap=iw,t.isMatch=rlt,t.isMatchWith=ult,t.isNaN=flt,t.isNative=elt,t.isNil=slt,t.isNull=olt,t.isNumber=en,t.isObject=pr,t.isObjectLike=wr,t.isPlainObject=fa,t.isRegExp=ty,t.isSafeInteger=hlt,t.isSet=rw,t.isString=iy,t.isSymbol=lf,t.isTypedArray=il,t.isUndefined=clt,t.isWeakMap=llt,t.isWeakSet=alt,t.join=eot,t.kebabCase=ovt,t.last=wf,t.lastIndexOf=oot,t.lowerCase=svt,t.lowerFirst=hvt,t.lt=on,t.lte=sn,t.max=fpt,t.maxBy=ept,t.mean=opt,t.meanBy=spt,t.min=hpt,t.minBy=cpt,t.stubArray=vw,t.stubFalse=yw,t.stubObject=wyt,t.stubString=byt,t.stubTrue=kyt,t.multiply=lpt,t.nth=sot,t.noConflict=cyt,t.noop=aw,t.now=ua,t.pad=cvt,t.padEnd=lvt,t.padStart=avt,t.parseInt=vvt,t.random=rvt,t.reduce=aht,t.reduceRight=vht,t.repeat=yvt,t.replace=pvt,t.result=yat,t.round=apt,t.runInContext=cu,t.sample=pht,t.size=kht,t.snakeCase=ntt,t.some=dht,t.sortedIndex=vot,t.sortedIndexBy=yot,t.sortedIndexOf=pot,t.sortedLastIndex=wot,t.sortedLastIndexBy=bot,t.sortedLastIndexOf=kot,t.startCase=ttt,t.startsWith=bvt,t.subtract=vpt,t.sum=ypt,t.sumBy=ppt,t.template=kvt,t.times=dyt,t.toFinite=ah,t.toInteger=v,t.toLength=cn,t.toLower=dvt,t.toNumber=bf,t.toSafeInteger=vlt,t.toString=bi,t.toUpper=gvt,t.trim=nyt,t.trimEnd=tyt,t.trimStart=iyt,t.truncate=ryt,t.unescape=uyt,t.uniqueId=npt,t.upperCase=itt,t.upperFirst=uy,t.each=hg,t.eachRight=cg,t.first=dd,lw(t,function(){var n={};return gf(t,function(i,r){ki.call(t.prototype,r)||(n[r]=i)}),n}(),{chain:!1}),t.VERSION=de,y(["bind","bindKey","curry","curryRight","partial","partialRight"],function(n){t[n].placeholder=t}),y(["drop","take"],function(n,t){wi.prototype[n]=function(i){i=i===u?1:dr(v(i),0);var r=this.__filtered__&&!t?new wi(this):this.clone();return r.__filtered__?r.__takeCount__=tf(i,r.__takeCount__):r.__views__.push({size:tf(i,g),type:n+(r.__dir__<0?"Right":"")}),r};wi.prototype[n+"Right"]=function(t){return this.reverse()[n](t).reverse()}}),y(["filter","map","takeWhile"],function(n,t){var r=t+1,u=r==vu||r==eo;wi.prototype[n]=function(n){var t=this.clone();return t.__iteratees__.push({iteratee:i(n,3),type:r}),t.__filtered__=t.__filtered__||u,t}}),y(["head","last"],function(n,t){var i="take"+(t?"Right":"");wi.prototype[n]=function(){return this[i](1).value()[0]}}),y(["initial","tail"],function(n,t){var i="drop"+(t?"":"Right");wi.prototype[n]=function(){return this.__filtered__?new wi(this):this[i](1)}}),wi.prototype.compact=function(){return this.filter(hf)},wi.prototype.find=function(n){return this.filter(n).head()},wi.prototype.findLast=function(n){return this.reverse().find(n)},wi.prototype.invokeMap=wt(function(n,t){return typeof n=="function"?new wi(this):this.map(function(i){return dl(i,n,t)})}),wi.prototype.reject=function(n){return this.filter(gv(i(n)))},wi.prototype.slice=function(n,t){n=v(n);var i=this;return i.__filtered__&&(n>0||t<0)?new wi(i):(n<0?i=i.takeRight(-n):n&&(i=i.drop(n)),t!==u&&(t=v(t),i=t<0?i.dropRight(-t):i.take(t-n)),i)},wi.prototype.takeRightWhile=function(n){return this.reverse().takeWhile(n).reverse()},wi.prototype.toArray=function(){return this.take(g)},gf(wi.prototype,function(n,i){var s=/^(?:filter|find|map|reject)|While$/.test(i),f=/^(?:head|last)$/.test(i),e=t[f?"take"+(i=="last"?"Right":""):i],o=f||/^find/.test(i);e&&(t.prototype[i]=function(){var h=this.__wrapped__,c=f?[1]:arguments,l=h instanceof wi,y=c[0],a=l||r(h),p=function(n){var i=e.apply(t,et([n],c));return f&&v?i[0]:i},i;a&&s&&typeof y=="function"&&y.length!=1&&(l=a=!1);var v=this.__chain__,k=!!this.__actions__.length,w=o&&!v,b=l&&!k;return!o&&a?(h=b?h:new wi(this),i=n.apply(h,c),i.__actions__.push({func:wv,args:[p],thisArg:u}),new vf(i,v)):w&&b?n.apply(this,c):(i=this.thru(p),w?f?i.value()[0]:i.value():i)})}),y(["pop","push","shift","sort","splice","unshift"],function(n){var i=oa[n],u=/^(?:push|sort|unshift)$/.test(n)?"tap":"thru",f=/^(?:pop|shift)$/.test(n);t.prototype[n]=function(){var t=arguments,n;return f&&!this.__chain__?(n=this.value(),i.apply(r(n)?n:[],t)):this[u](function(n){return i.apply(r(n)?n:[],t)})}}),gf(wi.prototype,function(n,i){var r=t[i],u,f;r&&(u=r.name+"",f=pl[u]||(pl[u]=[]),f.push({name:i,func:r}))}),pl[sv(u,st).name]=[{name:"wrapper",func:u}],wi.prototype.clone=ait,wi.prototype.reverse=vit,wi.prototype.value=yit,t.prototype.at=fg,t.prototype.chain=dst,t.prototype.commit=gst,t.prototype.next=nht,t.prototype.plant=iht,t.prototype.reverse=rht,t.prototype.toJSON=t.prototype.valueOf=t.prototype.value=uht,t.prototype.first=t.prototype.head,ll&&(t.prototype[ll]=tht),t};it=cu();typeof n=="function"&&typeof n.amd=="object"&&n.amd?(s._=it,n(function(){return it})):ki?((ki.exports=it)._=it,dr._=it):s._=it}).call(this)}).call(this,typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{})},{}]},{},[4])(4)})